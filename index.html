<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cổng Tác Vụ DQA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script id="tailwind-config">
    // Đảm bảo Tailwind đã load trước khi config
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#4A90E2",
              "accent": "#9013FE",
              "background-light": "#f7f8fc",
              "surface-light": "#ffffff",
              "card-light": "#ffffff",
              "text-light-primary": "#111827",
              "text-light-secondary": "#6b7280",
              "border-light": "#e5e7eb",
              "danger": "#ef4444",
              'primary-blue': '#5aa9ff',
              'sidebar': '#f0f7ff',
              'sidebar-hover': '#e0f0ff',
              'muted': '#f7f8fc'
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {
              "DEFAULT": "0.75rem",
              "lg": "1rem",
              "xl": "1.5rem",
              "full": "9999px"
            },
            boxShadow: {
              'soft': '0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05)',
            }
          },
        },
      };
    } else {
      // Nếu Tailwind chưa load, thử lại sau khi DOM ready
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof tailwind !== 'undefined') {
          tailwind.config = {
            darkMode: "class",
            theme: {
              extend: {
                colors: {
                  "primary": "#4A90E2",
                  "accent": "#9013FE",
                  "background-light": "#f7f8fc",
                  "surface-light": "#ffffff",
                  "card-light": "#ffffff",
                  "text-light-primary": "#111827",
                  "text-light-secondary": "#6b7280",
                  "border-light": "#e5e7eb",
                  "danger": "#ef4444",
                  'primary-blue': '#5aa9ff',
                  'sidebar': '#ffffff',
                  'sidebar-hover': '#f3f4f6',
                  'muted': '#f7f8fc'
                },
                fontFamily: {
                  "display": ["Inter", "sans-serif"]
                },
                borderRadius: {
                  "DEFAULT": "0.75rem",
                  "lg": "1rem",
                  "xl": "1.5rem",
                  "full": "9999px"
                },
                boxShadow: {
                  'soft': '0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05)',
                }
              },
            },
          };
        }
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style type="text/tailwindcss">
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24;
      font-size: inherit;
    }
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #3b82f6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#2563eb 0%,#60a5fa 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .modal.open{display:flex}
    .section-title{display:flex;align-items:center;gap:8px}
    .section-title .badge{background:rgba(90,169,255,.15);color:#1e40af;border:1px solid rgba(90,169,255,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .submit-btn{background:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);box-shadow:0 4px 6px rgba(37,99,235,.1),0 1px 3px rgba(37,99,235,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(37,99,235,.12),0 3px 6px rgba(37,99,235,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Sidebar effects for groups */
    .group-btn{ 
      position:relative; 
      transition: all 0.2s ease;
    }
    .group-btn.active{ 
      background:rgba(74,144,226,.1); 
      color:#4A90E2; 
    }
    .group-btn.active .material-symbols-outlined{ 
      font-variation-settings: 'FILL' 1; 
    }
    .group-items{ 
      transition: all .2s ease; 
    }
    .group-items .nav-btn{ 
      background: transparent; 
      transition: all 0.2s ease;
      border-radius: 0.5rem;
    }
    .group-items .nav-btn:hover{ 
      background: rgba(90,169,255,0.08); 
      transform: translateX(2px);
    }
    .group-items .nav-btn.active{ 
      background:rgba(74,144,226,.1); 
      color:#4A90E2; 
      font-weight: 600;
    }
    /* Ẩn label Phòng DQA trong header */
    .header-container .flex.items-center.space-x-2,
    .header-container .inline-block[style*="rgba(255,255,255,0.15)"],
    .header-container .inline-block.px-3.py-1.rounded-full {
      display: none !important;
    }
    /* Sidebar styles */
    #sidebar-nav {
      position: sticky;
      top: 0;
      align-self: flex-start;
      max-height: 100vh;
      overflow-y: auto;
      background: linear-gradient(180deg, #f0f7ff 0%, #e8f4ff 100%);
      box-shadow: 2px 0 8px rgba(90,169,255,0.08), 4px 0 16px rgba(90,169,255,0.04);
      border-right: 1px solid rgba(90,169,255,0.2);
    }
    /* Cải thiện các mục trong sidebar */
    #sidebar-nav .group-btn {
      margin-bottom: 0.25rem;
      border-radius: 0.5rem;
    }
    #sidebar-nav .group-btn:hover {
      background: rgba(90,169,255,0.15);
      transform: translateX(1px);
    }
    #sidebar-nav .nav-btn {
      margin-bottom: 0.125rem;
      padding: 0.625rem 0.75rem;
      transition: all 0.2s ease;
      background: transparent;
    }
    #sidebar-nav .nav-btn:hover {
      background: rgba(90,169,255,0.12);
      color: #2563eb;
    }
    #sidebar-nav nav {
      gap: 0.375rem;
    }
    /* ============================================ */
    /* MODAL SYSTEM - CSS RULES */
    /* ============================================ */
    
    /* Base styles cho tất cả modal containers */
    .modal-container {
      position: fixed;
      inset: 0;
      z-index: 9999;
    }
    
    .modal-container:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      pointer-events: auto;
      z-index: 9998;
    }
    
    /* Modal content container */
    .modal-content {
      position: relative;
      z-index: 9999;
    }
    
    /* Specific modal styles */
    #modal-f2-declaration:not(.hidden),
    #modal-f5-add-subtask:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      z-index: 9999 !important;
    }
    
    /* Overlay styles */
    #modal-f2-declaration-overlay,
    #modal-f5-add-subtask-overlay {
      pointer-events: auto;
      display: block !important;
      z-index: 9998 !important;
    }
    
    /* Override Tailwind hidden class */
    #modal-f2-declaration[style*="display: block"],
    #modal-f2-declaration[style*="display: flex"],
    #modal-f5-add-subtask[style*="display: block"],
    #modal-f5-add-subtask[style*="display: flex"] {
      display: block !important;
    }
    
    /* Content container trong modal */
    #modal-f5-add-subtask .modal-content.fixed.inset-0.z-50.flex {
      display: flex !important;
      pointer-events: none !important;
      z-index: 9999 !important;
    }
    
    #modal-f5-add-subtask .pointer-events-auto {
      pointer-events: auto !important;
    }
    
    /* ============================================ */
    /* END MODAL SYSTEM - CSS RULES */
    /* ============================================ */
  </style>
</head>
<body class="bg-background-light font-display text-text-light-primary antialiased">
  <div class="flex h-screen w-full overflow-hidden">
  <!-- Sidebar -->
  <aside id="sidebar-nav" class="flex h-full w-64 flex-shrink-0 flex-col justify-between p-4 border-r border-border-light">
    <div class="flex flex-col gap-6">
      <div class="flex items-center gap-3 px-2">
        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white font-bold text-lg">DQA</div>
        <div class="flex flex-col">
          <h1 class="text-text-light-primary text-base font-bold leading-normal">Cổng Tác Vụ DQA</h1>
          <p class="text-text-light-secondary text-sm font-normal leading-normal">Project Management</p>
        </div>
      </div>
      <nav class="flex flex-col gap-2">
        <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm bg-sidebar-hover" data-target="form1">
          <span class="material-symbols-outlined text-xl">search</span>
          <p class="text-sm font-semibold">Form 1 - So sánh CE</p>
        </button>
        <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form2">
          <span class="material-symbols-outlined text-xl">bar_chart</span>
          <p class="text-sm font-semibold">Form 2 - Rà soát CE</p>
        </button>
        <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form3">
          <span class="material-symbols-outlined text-xl">upload_file</span>
          <p class="text-sm font-semibold">Form 3 - Upload Excel</p>
        </button>
        <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form4">
          <span class="material-symbols-outlined text-xl">assignment</span>
          <p class="text-sm font-semibold">Form 4 - Phiếu nhập tác vụ</p>
        </button>
        <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form5">
          <span class="material-symbols-outlined text-xl">folder_managed</span>
          <p class="text-sm font-semibold">Form 5 - Quản lý Tác vụ Sản phẩm Mới</p>
        </button>
        <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-text-light-secondary text-left text-sm" data-target="form6">
          <span class="material-symbols-outlined text-xl">space_dashboard</span>
          <p class="text-sm font-semibold">Form 6 - Dashboard Thống kê</p>
        </button>
      </nav>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col overflow-y-auto">
    <header class="flex-shrink-0 flex items-center justify-between gap-4 p-4 border-b border-border-light bg-surface-light/80 backdrop-blur-sm sticky top-0 z-10">
      <div class="flex-1 flex items-center gap-6 min-w-0">
        <div class="flex flex-wrap items-center gap-2">
          <a class="text-text-light-secondary text-sm font-medium hover:text-primary" href="#">Projects</a>
          <span class="text-text-light-secondary text-sm font-medium">/</span>
          <span class="text-text-light-primary text-sm font-medium truncate">Cổng Tác Vụ DQA</span>
        </div>
      </div>
    </header>
    <div class="flex-1 p-6 lg:p-8 overflow-x-auto">

    <!-- Form 1 - So sánh CE -->
    <section id="form1" class="w-full max-w-7xl bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-blue-800">Form 1 - So sánh CE</h2>
      </div>

      <!-- A. Upload file -->
      <div id="section-upload" class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-4">A. Upload file</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- CE gốc -->
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <label class="block text-sm font-medium text-gray-700 mb-2">1. CE gốc</label>
            <div class="flex flex-col gap-2">
              <input type="file" id="f1-ce-original" accept=".xlsx,.xls,.csv" class="hidden">
              <button id="f1-ce-original-btn" class="w-full px-4 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Chọn file CE gốc</button>
              <div class="flex items-center gap-2">
                <span id="f1-ce-original-name" class="text-sm text-gray-500 flex-1">Chưa chọn file</span>
                <button id="f1-ce-original-remove" class="text-red-500 hover:text-red-700 text-sm hidden">✕</button>
              </div>
            </div>
          </div>

          <!-- CE sau rà soát -->
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <label class="block text-sm font-medium text-gray-700 mb-2">2. CE sau rà soát</label>
            <div class="flex flex-col gap-2">
              <input type="file" id="f1-ce-review" accept=".xlsx,.xls,.csv" class="hidden">
              <button id="f1-ce-review-btn" class="w-full px-4 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Chọn file CE sau rà soát</button>
              <div class="flex items-center gap-2">
                <span id="f1-ce-review-name" class="text-sm text-gray-500 flex-1">Chưa chọn file</span>
                <button id="f1-ce-review-remove" class="text-red-500 hover:text-red-700 text-sm hidden">✕</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Nút gửi -->
      <div class="flex justify-center mb-6">
        <button id="f1-submit-btn" class="px-8 py-3 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105 submit-btn">
          Gửi lên server
        </button>
      </div>

      <!-- B. Kết quả trả về -->
      <div id="f1-result" class="hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 flex-1">B. Kết quả trả về</h3>
          <button id="f1-export-excel" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 ml-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Xuất Excel
          </button>
        </div>
        
        <div class="border border-gray-200 rounded-lg bg-gray-50 p-4">
          <div id="f1-json-vn" class="mb-4 hidden"></div>
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm font-medium text-gray-700">JSON Response:</label>
            <button id="f1-copy-json" class="px-3 py-1 text-xs rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Copy JSON</button>
          </div>
          <pre id="f1-json-result" class="bg-white border border-gray-300 rounded p-4 overflow-auto max-h-[60vh] text-sm font-mono text-gray-800 whitespace-pre-wrap">Chưa có kết quả</pre>
        </div>
      </div>
    </section>

    <!-- Form 2 - Rà soát CE -->
    <section id="form2" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 2 - Rà soát CE</h2>
      </div>

      <!-- Nút tải dữ liệu và Khai báo -->
      <div class="flex items-center justify-between mb-4 gap-3">
        <div class="flex items-center gap-3">
          <button id="f2-load-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Tải dữ liệu
          </button>
          <button id="f2-declaration-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Khai báo
          </button>
        </div>
        <div id="f2-loading" class="hidden flex items-center gap-2 text-blue-600">
          <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Đang tải...</span>
        </div>
      </div>

      <!-- Bộ lọc -->
      <div class="mt-4 mb-4 flex flex-col md:flex-row gap-4 items-end">
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Lọc theo PIC cụm</label>
            <select id="f2-filter-pic" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Tất cả</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Lọc theo Dự án</label>
            <select id="f2-filter-project" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Tất cả</option>
            </select>
          </div>
        </div>
        <button id="f2-reset-filter" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition whitespace-nowrap">
          Xóa bộ lọc
        </button>
        <button id="f2-export-excel" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 whitespace-nowrap">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Xuất Excel
        </button>
      </div>

      <!-- Bảng rà soát CE -->
      <div class="mt-4 border border-gray-200 rounded-lg shadow-md overflow-x-auto">
        <table class="min-w-[2000px] w-full text-sm border-collapse">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-3 min-w-[140px] border border-gray-300">PIC cụm</th>
              <th class="px-3 py-3 min-w-[180px] border border-gray-300">Dự án</th>
              <th class="px-3 py-3 min-w-[140px] border border-gray-300">Ngày giao</th>
              <th class="px-3 py-3 min-w-[140px] border border-gray-300">Mã SAP</th>
              <th class="px-3 py-3 min-w-[200px] border border-gray-300">Cụm linh kiện</th>
              <th class="px-3 py-3 min-w-[280px] border border-gray-300">Tên linh kiện</th>
              <th class="px-3 py-3 min-w-[160px] border border-gray-300">Rà soát TCKT&CE</th>
              <th class="px-3 py-3 min-w-[180px] border border-gray-300">Ngày cập nhật gần nhất</th>
              <th class="px-3 py-3 min-w-[180px] bg-blue-100 text-blue-800 border border-gray-300">Tỷ lệ hoàn thiện bổ sung</th>
            </tr>
          </thead>
          <tbody id="f2-table-body" class="divide-y divide-gray-200">
            <tr><td class="px-3 py-4 text-center text-gray-500" colspan="9">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Form 3 - Upload Excel -->
    <section id="form3" class="w-full bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-blue-800">Form 3 - Upload Excel</h2>
      </div>

      <!-- Upload file -->
      <div id="section-upload" class="mb-6 hidden">
        <h3 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-4">Upload file Excel</h3>
        
        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 max-w-md">
          <label class="block text-sm font-medium text-gray-700 mb-2">File Excel (.xlsx)</label>
          <div class="flex flex-col gap-2">
            <input type="file" id="f3-excel-file" accept=".xlsx,.xls" class="hidden">
            <button id="f3-excel-file-btn" class="w-full px-4 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Chọn file Excel</button>
            <div class="flex items-center gap-2">
              <span id="f3-excel-file-name" class="text-sm text-gray-500 flex-1">Chưa chọn file</span>
              <button id="f3-excel-file-remove" class="text-red-500 hover:text-red-700 text-sm hidden">✕</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Nút gửi -->
      <div class="flex justify-center mb-6 hidden">
        <button id="f3-submit-btn" class="px-8 py-3 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105 submit-btn">
          Tải lên server
        </button>
      </div>

      <!-- Bảng thống kê -->
      <div id="f3-statistics-section" class="mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2">Bảng thống kê</h3>
          <div class="flex items-center gap-3">
            <button id="f3-load-statistics-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Tải dữ liệu thống kê
            </button>
            <div id="f3-statistics-loading" class="hidden flex items-center gap-2 text-blue-600">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span>Đang tải...</span>
            </div>
          </div>
        </div>

        <div class="border border-gray-200 rounded-lg shadow-md overflow-x-auto" style="max-height: calc(100vh - 200px); overflow-y: auto;">
          <table class="w-full text-sm border-collapse">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0 z-10">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-3 min-w-[80px] border border-gray-300 whitespace-nowrap">Id</th>
                <th class="px-3 py-3 min-w-[220px] border border-gray-300 whitespace-nowrap">Epic</th>
                <th class="px-3 py-3 min-w-[220px] border border-gray-300 whitespace-nowrap">Story</th>
                <th class="px-3 py-3 min-w-[280px] border border-gray-300 whitespace-nowrap">Sub-task</th>
                <th class="px-3 py-3 min-w-[140px] border border-gray-300 whitespace-nowrap">Groupcode</th>
                <th class="px-3 py-3 min-w-[160px] border border-gray-300 whitespace-nowrap">Tên nhân viên</th>
                <th class="px-3 py-3 min-w-[130px] border border-gray-300 whitespace-nowrap">Ngày bắt đầu</th>
                <th class="px-3 py-3 min-w-[130px] border border-gray-300 whitespace-nowrap">Hạn hoàn thành</th>
                <th class="px-3 py-3 min-w-[130px] border border-gray-300 whitespace-nowrap">Ngày hoàn thành</th>
                <th class="px-3 py-3 min-w-[140px] border border-gray-300 whitespace-nowrap">Trạng thái</th>
                <th class="px-3 py-3 min-w-[130px] border border-gray-300 whitespace-nowrap">Category</th>
                <th class="px-3 py-3 min-w-[130px] border border-gray-300 whitespace-nowrap">Jira Key</th>
                <th class="px-3 py-3 min-w-[220px] border border-gray-300 whitespace-nowrap">Ghi chú (jira_note)</th>
                <th class="px-3 py-3 min-w-[130px] border border-gray-300 whitespace-nowrap">Tháng (month_key)</th>
                <th class="px-3 py-3 min-w-[200px] border border-gray-300 whitespace-nowrap">Text</th>
                <th class="px-3 py-3 min-w-[180px] border border-gray-300 whitespace-nowrap">Ngày tạo</th>
                <th class="px-3 py-3 min-w-[180px] border border-gray-300 whitespace-nowrap">Ngày cập nhật</th>
              </tr>
            </thead>
            <tbody id="f3-statistics-body" class="divide-y divide-gray-200 bg-white">
              <tr><td class="px-3 py-4 text-center text-gray-500" colspan="17">Chưa có dữ liệu. Vui lòng nhấn "Tải dữ liệu thống kê" để tải dữ liệu.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Kết quả trả về -->
      <div id="f3-result" class="hidden">
        <h3 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-4">Kết quả trả về</h3>
        
        <div class="border border-gray-200 rounded-lg bg-gray-50 p-4">
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm font-medium text-gray-700">Response:</label>
            <button id="f3-copy-result" class="px-3 py-1 text-xs rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Copy</button>
          </div>
          <pre id="f3-result-content" class="bg-white border border-gray-300 rounded p-4 overflow-auto max-h-[60vh] text-sm font-mono text-gray-800 whitespace-pre-wrap">Chưa có kết quả</pre>
        </div>
      </div>
    </section>

    <!-- Form 4 - Phiếu nhập tác vụ -->
    <section id="form4" class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="mb-6">
        <h2 class="text-xl font-semibold text-blue-800">Form 4 - Phiếu nhập tác vụ</h2>
        <p class="text-sm text-gray-600 mt-2">Vui lòng điền đầy đủ các mục bắt buộc cho sản phẩm/linh kiện cần thử nghiệm.</p>
      </div>
      <form id="f4-testRequestForm" class="space-y-6" autocomplete="off">
        <!-- A. General Information -->
        <div class="border border-gray-200 rounded-lg p-4 bg-blue-50">
          <h3 class="text-lg font-semibold text-blue-800 mb-3">A. Thông tin chung</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <input required id="f4-senderName" name="senderName" type="text" list="f4-senderNameOptions" placeholder="Họ tên người gửi *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              <datalist id="f4-senderNameOptions"></datalist>
            </div>
            <input required name="senderEmail" type="email" placeholder="Email *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input name="requestDate" type="datetime-local" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly id="f4-testRequestDate"/>
            <input type="hidden" name="requestCode" id="f4-requestCode"/>
            <select required name="department" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Phòng ban yêu cầu *</option>
              <option>Mua hàng</option><option>SC</option><option>SC2</option><option>KTSX</option><option>KTSP</option>
              <option>TKCK</option><option>KTCN</option><option>NCTN</option><option>TKĐT</option>
              <option>QA/QC nhà máy</option><option>DQA</option>
            </select>
          </div>
        </div>
        <!-- B. Product/Component Information -->
        <div class="border border-gray-200 rounded-lg p-4 bg-green-50">
          <h3 class="text-lg font-semibold text-blue-800 mb-3">B. Thông tin sản phẩm/linh kiện</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input required id="f4-productName" name="productName" type="text" placeholder="Tên sản phẩm/linh kiện *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input required name="productCode" type="text" placeholder="Mã sản phẩm/linh kiện *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <div class="md:col-span-2">
              <div class="mt-2">
                <button type="button" id="f4-componentModalBtn" class="px-3 py-2 rounded-lg border border-blue-300 bg-white text-blue-700 hover:bg-blue-50 transition">Công chuẩn tham khảo</button>
              </div>
              <input type="hidden" name="componentType" id="f4-componentType" value="" />
              <input type="hidden" name="componentStandard" id="f4-componentStandard" />
              <div id="f4-componentStandardNote" class="text-sm text-gray-600 mt-1 hidden"></div>
            </div>
            <select required name="requestPurpose" id="f4-requestPurpose" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 md:col-span-2">
              <option value="">Mục đích yêu cầu *</option>
              <option value="Đánh giá SP mới">Đánh giá sản phẩm mới</option>
              <option value="Đánh giá Sản phẩm SOP">Đánh giá sản phẩm SOP</option>
            </select>
            <div id="f4-purposeDescription" class="text-gray-600 text-sm md:col-span-2"></div>
            <div id="f4-projectCodeContainer" class="hidden md:col-span-2">
              <input type="text" id="f4-projectCode" name="projectCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Mã dự án" disabled />
            </div>
            <div id="f4-nccChangeFields" class="hidden md:col-span-2">
              <input type="text" id="f4-appliedModel" name="appliedModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Model áp dụng *" disabled />
            </div>
            <input name="supplier" required type="text" placeholder="Nhà cung cấp *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input name="numSamples" type="number" min="0" placeholder="Số lượng mẫu giao *" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input id="f4-desiredCompletionDate" name="desiredCompletionDate" type="text" placeholder="Hạn mong muốn" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input type="hidden" name="desiredCompletionDateTime" id="f4-desiredCompletionDateTime" />
            <select name="personReceived" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Đầu mối nhận mẫu *</option>
              <option>Vũ Duy Minh</option>
              <option>Nguyễn Văn Linh</option>
              <option>Nguyễn Văn Hiếu</option>
              <option>Đào Hoàng Dương</option>
            </select>
            <input name="pic" id="f4-pic" type="text" placeholder="PIC (Người phụ trách)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <textarea name="notes" rows="2" placeholder="Ghi chú (Điểm thay đổi, lý do yêu cầu gấp...)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 md:col-span-2"></textarea>
          </div>
        </div>
        <!-- C. Attachments -->
        <div class="border border-gray-200 rounded-lg p-4 bg-purple-50">
          <h3 class="text-lg font-semibold text-blue-800 mb-3">C. Tài liệu đính kèm</h3>
          <div id="f4-fileUploadArea" class="relative border-2 border-dashed border-blue-300 rounded-lg p-8 text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50 cursor-pointer">
            <div id="f4-uploadContent" class="space-y-4">
              <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
              </div>
              <div>
                <p class="text-lg font-medium text-gray-700">Kéo thả file vào đây hoặc <span class="text-blue-600 underline">nhấn để chọn</span></p>
                <p class="text-sm text-gray-500 mt-1">Hỗ trợ: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (tối đa 20MB mỗi file)</p>
              </div>
            </div>
            <input type="file" id="f4-testRequestFiles" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
          </div>
          <div id="f4-uploadProgress" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-blue-700">Đang tải lên...</span>
              <span id="f4-uploadPercent" class="text-sm text-blue-600">0%</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2">
              <div id="f4-progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
          <div id="f4-testRequestUploadList" class="mt-4 space-y-3"></div>
        </div>
        <button type="submit" class="submit-btn w-full mt-4 py-3 text-white font-semibold text-lg transition flex items-center justify-center gap-2">
          <span>Gửi yêu cầu</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </button>
      </form>
    </section>

    <!-- Form 5 - Quản lý Tác vụ Sản phẩm Mới -->
    <section id="form5" class="w-full bg-white p-6 lg:p-10 rounded-lg shadow-md hidden">
      <div class="mx-auto flex w-full flex-col gap-6">
        <!-- Page Heading -->
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex flex-col gap-1">
            <p class="text-4xl font-black leading-tight tracking-tighter text-gray-900">Bảng Tác Vụ - Sản phẩm Mới</p>
            <p class="text-base font-normal text-gray-600">Quản lý tất cả công việc của bạn ở một nơi.</p>
          </div>
        </div>

        <!-- ToolBar -->
        <div class="flex flex-wrap items-center justify-between gap-4 rounded-lg bg-white p-2 shadow-sm border border-gray-200">
          <div class="flex items-center gap-2 flex-wrap">
            <div class="relative w-64">
              <span class="material-symbols-outlined pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">search</span>
              <input id="f5-searchInput" class="h-10 w-full rounded-full border-gray-300 bg-gray-50 pl-10 pr-4 text-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Tìm kiếm tác vụ..." type="text"/>
            </div>
            <select id="f5-filter-pic" class="h-10 px-4 py-2 rounded-lg border border-gray-300 bg-white text-sm focus:border-blue-500 focus:ring-blue-500 min-w-[200px]">
              <option value="">Tất cả người nhận</option>
              <!-- Options sẽ được populate bằng JavaScript -->
            </select>
            <button id="f5-searchBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
              <span class="material-symbols-outlined text-lg">search</span>
              Tra cứu
            </button>
            <button id="f5-importExcelBtn" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium text-sm">
              <span class="material-symbols-outlined text-lg">upload_file</span>
              Import Excel
            </button>
          </div>
        </div>

        <!-- Hierarchical Task Table -->
        <div class="overflow-hidden rounded-lg bg-white shadow-sm border border-gray-200">
          <div class="overflow-x-auto">
            <table id="f5-tasksTable" class="w-full">
              <thead class="border-b border-gray-200 bg-gray-50/50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Tên tác vụ</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Người yêu cầu</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Người nhận tác vụ</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Phòng ban</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Ngày gửi</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Ngày hết hạn</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Trạng thái</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Mã tác vụ</th>
                  <th class="w-auto p-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600"></th>
                </tr>
              </thead>
              <tbody id="f5-tasksTableBody" class="divide-y divide-gray-200">
                <!-- Dữ liệu sẽ được render bằng JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Form 6 - Dashboard Thống kê -->
    <section id="form6" class="w-full max-w-7xl bg-white p-6 lg:p-10 rounded-lg shadow-md hidden">
      <div class="mx-auto flex w-full flex-col gap-8">
        <!-- Header -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="text-primary-blue">
              <span class="material-symbols-outlined text-3xl" style="font-variation-settings: 'FILL' 1;">space_dashboard</span>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-900">Tổng quan Dự án</h2>
              <p class="text-sm text-gray-500">Thống kê và theo dõi tiến độ các dự án</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="relative w-64">
              <span class="material-symbols-outlined pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">search</span>
              <input id="f6-searchInput" class="h-10 w-full rounded-lg border-gray-300 bg-gray-50 pl-10 pr-4 text-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Tìm kiếm dự án..." type="text"/>
            </div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="flex flex-col gap-2 rounded-xl p-6 bg-white shadow-sm border border-gray-200">
            <p class="text-gray-600 text-base font-medium">Dự án đang chạy</p>
            <p class="text-gray-900 tracking-tight text-3xl font-bold" id="f6-stats-running">0</p>
          </div>
          <div class="flex flex-col gap-2 rounded-xl p-6 bg-white shadow-sm border border-gray-200">
            <p class="text-gray-600 text-base font-medium">Tác vụ sắp hết hạn</p>
            <p class="text-gray-900 tracking-tight text-3xl font-bold" id="f6-stats-due">0</p>
          </div>
          <div class="flex flex-col gap-2 rounded-xl p-6 bg-white shadow-sm border border-gray-200">
            <p class="text-gray-600 text-base font-medium">Thành viên hoạt động</p>
            <p class="text-gray-900 tracking-tight text-3xl font-bold" id="f6-stats-members">0</p>
          </div>
          <div class="flex flex-col gap-3.5 rounded-xl p-6 bg-white shadow-sm border border-gray-200">
            <p class="text-gray-600 text-base font-medium">Trạng thái Dự án</p>
            <div class="flex items-center gap-4">
              <div class="relative size-10">
                <svg class="size-full" height="36" viewBox="0 0 36 36" width="36" xmlns="http://www.w3.org/2000/svg">
                  <circle class="stroke-current text-gray-200" cx="18" cy="18" fill="transparent" r="15.9155" stroke-width="3"></circle>
                  <circle class="stroke-current text-primary-blue" cx="18" cy="18" fill="transparent" r="15.9155" stroke-dasharray="65 35" stroke-dashoffset="25" stroke-width="3"></circle>
                </svg>
              </div>
              <div class="flex flex-col">
                <p class="text-gray-900 tracking-tight text-xl font-bold" id="f6-stats-progress">0%</p>
                <p class="text-gray-500 text-xs">Đang tiến hành</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter Tabs -->
        <div class="flex flex-col sm:flex-row justify-between gap-4 items-center py-3">
          <div class="flex gap-2 overflow-x-auto">
            <button class="f6-filter-btn flex h-10 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-lg bg-primary-blue/10 pl-4 pr-4" data-filter="all">
              <p class="text-primary-blue text-sm font-semibold">Tất cả</p>
            </button>
            <button class="f6-filter-btn flex h-10 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-lg bg-gray-100 pl-4 pr-4" data-filter="in_progress">
              <p class="text-gray-700 text-sm font-medium">Đang tiến hành</p>
            </button>
            <button class="f6-filter-btn flex h-10 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-lg bg-gray-100 pl-4 pr-4" data-filter="done">
              <p class="text-gray-700 text-sm font-medium">Hoàn thành</p>
            </button>
            <button class="f6-filter-btn flex h-10 shrink-0 cursor-pointer items-center justify-center gap-x-2 rounded-lg bg-gray-100 pl-4 pr-4" data-filter="pending">
              <p class="text-gray-700 text-sm font-medium">Tạm dừng</p>
            </button>
          </div>
          <div class="flex gap-2">
            <button class="flex items-center justify-center rounded-lg h-10 w-10 text-gray-600 bg-white shadow-sm border border-gray-200">
              <span class="material-symbols-outlined" style="font-size: 20px;">filter_list</span>
            </button>
            <button class="flex items-center justify-center rounded-lg h-10 w-10 text-gray-600 bg-white shadow-sm border border-gray-200">
              <span class="material-symbols-outlined" style="font-size: 20px;">swap_vert</span>
            </button>
          </div>
        </div>

        <!-- Projects Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  <th class="px-6 py-4 font-semibold" scope="col">Tên dự án</th>
                  <th class="px-6 py-4 font-semibold" scope="col">Tiến độ</th>
                  <th class="px-6 py-4 font-semibold" scope="col">Người phụ trách</th>
                  <th class="px-6 py-4 font-semibold" scope="col">Hạn chót</th>
                  <th class="px-6 py-4 font-semibold" scope="col">Trạng thái</th>
                  <th class="px-6 py-4 font-semibold" scope="col"></th>
                </tr>
              </thead>
              <tbody id="f6-projectsTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Dữ liệu sẽ được render bằng JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
    </div>
  </main>
  </div>

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 2: DECLARATION (Khai báo) -->
  <!-- ============================================ -->
  <div id="modal-f2-declaration" class="modal-container modal-f2-declaration fixed inset-0 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div id="modal-f2-declaration-overlay" class="modal-overlay modal-f2-declaration-overlay fixed inset-0 bg-black/50"></div>
    <div id="modal-f2-declaration-content" class="modal-content modal-f2-declaration-content relative z-50 flex items-center justify-center w-full h-full">
      <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-green-50 to-green-100">
        <h3 class="text-xl font-semibold text-gray-800">Khai báo - So sánh CE</h3>
        <button id="modal-f2-declaration-close" class="modal-close modal-f2-declaration-close text-gray-500 hover:text-gray-700 transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div id="modal-f2-declaration-body" class="modal-body modal-f2-declaration-body p-6 overflow-y-auto flex-1">
        <!-- Upload file -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-4">Upload file</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- CE gốc -->
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
              <label class="block text-sm font-medium text-gray-700 mb-2">1. CE gốc</label>
              <div class="flex flex-col gap-2">
                <input type="file" id="f2-ce-original" accept=".xlsx,.xls,.csv" class="hidden">
                <button id="f2-ce-original-btn" class="w-full px-4 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Chọn file CE gốc</button>
                <div class="flex items-center gap-2">
                  <span id="f2-ce-original-name" class="text-sm text-gray-500 flex-1">Chưa chọn file</span>
                  <button id="f2-ce-original-remove" class="text-red-500 hover:text-red-700 text-sm hidden">✕</button>
                </div>
              </div>
            </div>

            <!-- CE sau rà soát -->
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
              <label class="block text-sm font-medium text-gray-700 mb-2">2. CE sau rà soát</label>
              <div class="flex flex-col gap-2">
                <input type="file" id="f2-ce-review" accept=".xlsx,.xls,.csv" class="hidden">
                <button id="f2-ce-review-btn" class="w-full px-4 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Chọn file CE sau rà soát</button>
                <div class="flex items-center gap-2">
                  <span id="f2-ce-review-name" class="text-sm text-gray-500 flex-1">Chưa chọn file</span>
                  <button id="f2-ce-review-remove" class="text-red-500 hover:text-red-700 text-sm hidden">✕</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Kết quả (nếu có) -->
        <div id="f2-declaration-result" class="hidden">
          <h4 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-4">Kết quả</h4>
          <div class="border border-gray-200 rounded-lg bg-gray-50 p-4">
            <div id="f2-declaration-result-content" class="text-sm"></div>
          </div>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
        <button id="modal-f2-declaration-close-btn" class="modal-close-btn modal-f2-declaration-close-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
          Đóng
        </button>
        <button id="modal-f2-declaration-submit" class="modal-submit modal-f2-declaration-submit px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
          Gửi lên server
        </button>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 2: DECLARATION -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: ADD SUBTASK (Thêm tác vụ con) -->
  <!-- ============================================ -->
  <div id="modal-f5-add-subtask" class="modal-container modal-f5-add-subtask fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-add-subtask-overlay" class="modal-overlay modal-f5-add-subtask-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-add-subtask-content" class="modal-content modal-f5-add-subtask-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-2xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50">
        <div class="flex items-start justify-between">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Thêm tác vụ con</h2>
            <p class="text-sm text-gray-600">Tác vụ con cho: <span id="modal-f5-add-subtask-parent-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-add-subtask-close" class="modal-close modal-f5-add-subtask-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <form id="modal-f5-add-subtask-form" class="modal-form modal-f5-add-subtask-form mt-8">
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-name">Tên tác vụ con *</label>
              <input required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-name" placeholder="Ví dụ: Kiểm tra độ kín" type="text"/>
            </div>
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-item-code">Mã linh kiện/sản phẩm</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-item-code" placeholder="Nhập mã linh kiện/sản phẩm" type="text"/>
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-pic">Người thực hiện</label>
              <select class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-pic">
                <option value="">Chọn thành viên</option>
                <option>Nguyễn Hữu Thịnh</option>
                <option>Đỗ Quang Long</option>
                <option>Nguyễn Thị Hiền</option>
                <option>Vũ Thị Hằng</option>
                <option>Phạm Thành Trung Kiên</option>
                <option>Lê Ngọc Ánh</option>
                <option>Hà Mỹ Linh</option>
                <option>Bùi Đặng Quốc Huy</option>
                <option>Phạm Thị Minh</option>
                <option>Đào Tuấn Kỳ</option>
                <option>Lê Văn Sơn</option>
                <option>Lại Quốc Lộc</option>
                <option>Thái Thị Giang</option>
                <option>Lê Thị Thảo</option>
                <option>Vũ Thị Thanh Hiền</option>
                <option>Trần Hiếu Nghĩa</option>
              </select>
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-manhour">Số giờ công</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-manhour" type="number" step="0.1" min="0" placeholder="Ví dụ: 8.5"/>
            </div>
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-checklist">Checklist (File đính kèm)</label>
              <input type="file" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-checklist" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt"/>
              <p class="mt-1 text-xs text-gray-500">Chọn file checklist để đính kèm (PDF, Word, Excel, hoặc Text)</p>
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-timesend">Thời gian gửi</label>
              <input class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-timesend" type="datetime-local" readonly/>
              <p class="mt-1 text-xs text-gray-500">Tự động điền theo giờ hệ thống</p>
            </div>
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-note">Ghi chú</label>
              <textarea class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-note" rows="3" placeholder="Nhập ghi chú cho tác vụ con"></textarea>
            </div>
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-declaration-mode">Chế độ khai báo *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-declaration-mode">
                <option value="">Chọn chế độ khai báo</option>
                <option value="review-file-nctn">Rà soát file với NCTN</option>
                <option value="review-ce-qc">Gửi rà soát CE với QC</option>
                <option value="train-qc">Đào tạo QC</option>
                <option value="send-test-task">Gửi tác vụ thử nghiệm</option>
                <option value="review-4m">Rà soát 4M</option>
                <option value="review-fmea">Rà soát FMEA</option>
              </select>
              <p class="mt-1 text-xs text-gray-500">Chọn chế độ khai báo sẽ được sử dụng cho tác vụ con này</p>
            </div>
          </div>
          <input type="hidden" id="modal-f5-add-subtask-task-id" value=""/>
          <div class="mt-8 flex justify-end gap-3">
            <button type="button" id="modal-f5-add-subtask-cancel" class="modal-cancel-btn modal-f5-add-subtask-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
            <button type="submit" class="modal-submit-btn modal-f5-add-subtask-submit-btn flex h-11 items-center justify-center gap-2 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm transition-shadow hover:shadow-md">
              <span class="material-symbols-outlined">add</span>
              <span>Thêm tác vụ</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: ADD SUBTASK -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: SELECT DECLARATION MODE (Chọn chế độ khai báo) -->
  <!-- ============================================ -->
  <div id="modal-f5-select-declaration" class="modal-container modal-f5-select-declaration fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-select-declaration-overlay" class="modal-overlay modal-f5-select-declaration-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-select-declaration-content" class="modal-content modal-f5-select-declaration-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-2xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Chọn chế độ khai báo</h2>
            <p class="text-sm text-gray-600">Tác vụ: <span id="modal-f5-select-declaration-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-select-declaration-close" class="modal-close modal-f5-select-declaration-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="review-file-nctn">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                <span class="material-symbols-outlined text-blue-600">folder_open</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">Rà soát file với NCTN</h3>
                <p class="text-xs text-gray-500 mt-0.5">Kiểm tra và rà soát file với NCTN</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="review-ce-qc">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center group-hover:bg-green-200 transition-colors">
                <span class="material-symbols-outlined text-green-600">verified</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">Gửi rà soát CE với QC</h3>
                <p class="text-xs text-gray-500 mt-0.5">Gửi file CE để QC rà soát</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="train-qc">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center group-hover:bg-purple-200 transition-colors">
                <span class="material-symbols-outlined text-purple-600">school</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">Đào tạo QC</h3>
                <p class="text-xs text-gray-500 mt-0.5">Tổ chức đào tạo cho đội QC</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="send-test-task">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                <span class="material-symbols-outlined text-orange-600">science</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">Gửi tác vụ thử nghiệm</h3>
                <p class="text-xs text-gray-500 mt-0.5">Gửi yêu cầu thử nghiệm</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="review-4m">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-yellow-100 flex items-center justify-center group-hover:bg-yellow-200 transition-colors">
                <span class="material-symbols-outlined text-yellow-600">checklist</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">Rà soát 4M</h3>
                <p class="text-xs text-gray-500 mt-0.5">Rà soát Man, Machine, Material, Method</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="review-fmea">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center group-hover:bg-red-200 transition-colors">
                <span class="material-symbols-outlined text-red-600">warning</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">Rà soát FMEA</h3>
                <p class="text-xs text-gray-500 mt-0.5">Rà soát Failure Mode and Effects Analysis</p>
              </div>
            </div>
          </button>
        </div>
        
        <div class="mt-6 flex justify-end">
          <button type="button" id="modal-f5-select-declaration-cancel" class="modal-cancel-btn modal-f5-select-declaration-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: SELECT DECLARATION MODE -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: IMPORT EXCEL -->
  <!-- ============================================ -->
  <div id="modal-f5-import-excel" class="modal-container modal-f5-import-excel fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-import-excel-overlay" class="modal-overlay modal-f5-import-excel-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-import-excel-content" class="modal-content modal-f5-import-excel-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Import Tasks từ Excel</h2>
            <p class="text-sm text-gray-600">Upload file Excel để import tasks và subtasks vào hệ thống</p>
          </div>
          <button id="modal-f5-import-excel-close" class="modal-close modal-f5-import-excel-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <!-- Hướng dẫn format Excel -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <h3 class="text-sm font-semibold text-blue-900 mb-2">📋 Hướng dẫn format file Excel:</h3>
              <ul class="text-xs text-blue-800 space-y-1 list-disc list-inside">
                <li>Sheet đầu tiên sẽ được đọc</li>
                <li>Cột bắt buộc: <strong>Project Code</strong>, <strong>Task Request Code</strong>, <strong>Task Name</strong></li>
                <li>Cột tùy chọn: Project Name, Requester Name, Requester Email, PIC, Department, Created At, Due Date, Status</li>
                <li>Để thêm Subtask: thêm dòng với cùng <strong>Task Request Code</strong> và điền <strong>Subtask No</strong> (số > 0)</li>
                <li>Cột Subtask: Subtask Name, Subtask PIC, Subtask Manhour, Subtask Status, Subtask Timesend, Subtask Note, Declaration Mode</li>
              </ul>
            </div>
            <button id="f5-download-template-btn" class="ml-4 flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium whitespace-nowrap">
              <span class="material-symbols-outlined text-lg">download</span>
              Tải file mẫu
            </button>
          </div>
        </div>

        <!-- Upload file -->
        <div class="mb-6">
          <label class="mb-2 block text-sm font-medium text-gray-700">Chọn file Excel (.xlsx, .xls)</label>
          <div class="flex flex-col gap-2">
            <input type="file" id="f5-import-excel-file" accept=".xlsx,.xls" class="hidden">
            <button id="f5-import-excel-file-btn" class="w-full px-4 py-3 rounded-lg border-2 border-dashed border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100 transition-colors font-medium">
              <span class="material-symbols-outlined align-middle mr-2">upload_file</span>
              Chọn file Excel
            </button>
            <div class="flex items-center gap-2">
              <span id="f5-import-excel-file-name" class="text-sm text-gray-500 flex-1">Chưa chọn file</span>
              <button id="f5-import-excel-file-remove" class="text-red-500 hover:text-red-700 text-sm hidden">✕</button>
            </div>
          </div>
        </div>

        <!-- Preview kết quả -->
        <div id="f5-import-excel-preview" class="hidden mb-6">
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Xem trước dữ liệu:</h3>
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 max-h-64 overflow-y-auto">
            <div id="f5-import-excel-preview-content" class="text-sm text-gray-600"></div>
          </div>
        </div>

        <!-- Thông báo lỗi -->
        <div id="f5-import-excel-error" class="hidden mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
          <div class="flex items-start gap-2">
            <span class="material-symbols-outlined text-red-600">error</span>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-red-900 mb-1">Lỗi import</h4>
              <div id="f5-import-excel-error-content" class="text-xs text-red-800"></div>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex justify-end gap-3">
          <button type="button" id="modal-f5-import-excel-cancel" class="modal-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="button" id="modal-f5-import-excel-submit" class="modal-submit-btn flex h-11 items-center justify-center gap-2 rounded-full bg-green-600 px-6 text-sm font-bold text-white shadow-sm transition-shadow hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <span class="material-symbols-outlined">upload</span>
            <span>Import dữ liệu</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: IMPORT EXCEL -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: DECLARATION MODALS -->
  <!-- ============================================ -->
  
  <!-- Modal: Rà soát file với NCTN -->
  <div id="modal-f5-declaration-review-file-nctn" class="modal-container modal-f5-declaration-review-file-nctn fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-review-file-nctn-overlay" class="modal-overlay modal-f5-declaration-review-file-nctn-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-review-file-nctn-content" class="modal-content modal-f5-declaration-review-file-nctn-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Rà soát file với NCTN</h2>
            <p class="text-sm text-gray-600">Tác vụ: <span id="modal-f5-declaration-review-file-nctn-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-review-file-nctn-close" class="modal-close modal-f5-declaration-review-file-nctn-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-review-file-nctn-body" class="modal-body modal-f5-declaration-review-file-nctn-body">
          <form id="modal-f5-declaration-review-file-nctn-form" class="space-y-6">
            <!-- Trạng thái -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-file-nctn-status">Trạng thái *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-file-nctn-status">
                <option value="">Chọn trạng thái</option>
                <option value="Cancel">Cancel</option>
                <option value="Hoàn thành">Hoàn thành</option>
              </select>
            </div>

            <!-- Link kết quả -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-file-nctn-result-link">Link kết quả</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-file-nctn-result-link" placeholder="Nhập link kết quả" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-review-file-nctn-cancel" class="modal-cancel-btn modal-f5-declaration-review-file-nctn-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="button" id="modal-f5-declaration-review-file-nctn-submit" class="modal-submit-btn modal-f5-declaration-review-file-nctn-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Gửi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Gửi rà soát CE với QC -->
  <div id="modal-f5-declaration-review-ce-qc" class="modal-container modal-f5-declaration-review-ce-qc fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-review-ce-qc-overlay" class="modal-overlay modal-f5-declaration-review-ce-qc-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-review-ce-qc-content" class="modal-content modal-f5-declaration-review-ce-qc-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Gửi rà soát CE với QC</h2>
            <p class="text-sm text-gray-600">Tác vụ: <span id="modal-f5-declaration-review-ce-qc-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-review-ce-qc-close" class="modal-close modal-f5-declaration-review-ce-qc-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-review-ce-qc-body" class="modal-body modal-f5-declaration-review-ce-qc-body">
          <form id="modal-f5-declaration-review-ce-qc-form" class="space-y-6">
            <!-- Trạng thái -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-ce-qc-status">Trạng thái *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-ce-qc-status">
                <option value="">Chọn trạng thái</option>
                <option value="Cancel">Cancel</option>
                <option value="Hoàn thành">Hoàn thành</option>
              </select>
            </div>

            <!-- Link kết quả -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-ce-qc-result-link">Link kết quả</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-ce-qc-result-link" placeholder="Nhập link kết quả" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-review-ce-qc-cancel" class="modal-cancel-btn modal-f5-declaration-review-ce-qc-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="button" id="modal-f5-declaration-review-ce-qc-submit" class="modal-submit-btn modal-f5-declaration-review-ce-qc-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Gửi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Đào tạo QC -->
  <div id="modal-f5-declaration-train-qc" class="modal-container modal-f5-declaration-train-qc fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-train-qc-overlay" class="modal-overlay modal-f5-declaration-train-qc-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-train-qc-content" class="modal-content modal-f5-declaration-train-qc-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Đào tạo QC</h2>
            <p class="text-sm text-gray-600">Tác vụ: <span id="modal-f5-declaration-train-qc-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-train-qc-close" class="modal-close modal-f5-declaration-train-qc-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-train-qc-body" class="modal-body modal-f5-declaration-train-qc-body">
          <form id="modal-f5-declaration-train-qc-form" class="space-y-6">
            <!-- Trạng thái -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-train-qc-status">Trạng thái *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-train-qc-status">
                <option value="">Chọn trạng thái</option>
                <option value="Cancel">Cancel</option>
                <option value="Hoàn thành">Hoàn thành</option>
              </select>
            </div>

            <!-- Link kết quả -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-train-qc-result-link">Link kết quả</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-train-qc-result-link" placeholder="Nhập link kết quả" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-train-qc-cancel" class="modal-cancel-btn modal-f5-declaration-train-qc-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="button" id="modal-f5-declaration-train-qc-submit" class="modal-submit-btn modal-f5-declaration-train-qc-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Gửi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Gửi tác vụ thử nghiệm -->
  <div id="modal-f5-declaration-send-test-task" class="modal-container modal-f5-declaration-send-test-task fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-send-test-task-overlay" class="modal-overlay modal-f5-declaration-send-test-task-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-send-test-task-content" class="modal-content modal-f5-declaration-send-test-task-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Gửi tác vụ thử nghiệm</h2>
            <p class="text-sm text-gray-600">Tác vụ: <span id="modal-f5-declaration-send-test-task-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-send-test-task-close" class="modal-close modal-f5-declaration-send-test-task-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-send-test-task-body" class="modal-body modal-f5-declaration-send-test-task-body">
          <form id="modal-f5-declaration-send-test-task-form" class="space-y-6">
            <!-- Trạng thái -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-send-test-task-status">Trạng thái *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-send-test-task-status">
                <option value="">Chọn trạng thái</option>
                <option value="Cancel">Cancel</option>
                <option value="Hoàn thành">Hoàn thành</option>
              </select>
            </div>

            <!-- Link kết quả -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-send-test-task-result-link">Link kết quả</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-send-test-task-result-link" placeholder="Nhập link kết quả" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-send-test-task-cancel" class="modal-cancel-btn modal-f5-declaration-send-test-task-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="button" id="modal-f5-declaration-send-test-task-submit" class="modal-submit-btn modal-f5-declaration-send-test-task-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Gửi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Rà soát 4M -->
  <div id="modal-f5-declaration-review-4m" class="modal-container modal-f5-declaration-review-4m fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-review-4m-overlay" class="modal-overlay modal-f5-declaration-review-4m-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-review-4m-content" class="modal-content modal-f5-declaration-review-4m-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Rà soát 4M</h2>
            <p class="text-sm text-gray-600">Tác vụ: <span id="modal-f5-declaration-review-4m-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-review-4m-close" class="modal-close modal-f5-declaration-review-4m-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-review-4m-body" class="modal-body modal-f5-declaration-review-4m-body">
          <form id="modal-f5-declaration-review-4m-form" class="space-y-6">
            <!-- Trạng thái -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-4m-status">Trạng thái *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-4m-status">
                <option value="">Chọn trạng thái</option>
                <option value="Cancel">Cancel</option>
                <option value="Hoàn thành">Hoàn thành</option>
              </select>
            </div>

            <!-- Link kết quả -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-4m-result-link">Link kết quả</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-4m-result-link" placeholder="Nhập link kết quả" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-review-4m-cancel" class="modal-cancel-btn modal-f5-declaration-review-4m-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="button" id="modal-f5-declaration-review-4m-submit" class="modal-submit-btn modal-f5-declaration-review-4m-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Gửi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Rà soát FMEA -->
  <div id="modal-f5-declaration-review-fmea" class="modal-container modal-f5-declaration-review-fmea fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-review-fmea-overlay" class="modal-overlay modal-f5-declaration-review-fmea-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-review-fmea-content" class="modal-content modal-f5-declaration-review-fmea-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Rà soát FMEA</h2>
            <p class="text-sm text-gray-600">Tác vụ: <span id="modal-f5-declaration-review-fmea-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-review-fmea-close" class="modal-close modal-f5-declaration-review-fmea-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-review-fmea-body" class="modal-body modal-f5-declaration-review-fmea-body">
          <form id="modal-f5-declaration-review-fmea-form" class="space-y-6">
            <!-- Trạng thái -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-fmea-status">Trạng thái *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-fmea-status">
                <option value="">Chọn trạng thái</option>
                <option value="Cancel">Cancel</option>
                <option value="Hoàn thành">Hoàn thành</option>
              </select>
            </div>

            <!-- Link kết quả -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-fmea-result-link">Link kết quả</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-fmea-result-link" placeholder="Nhập link kết quả" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-review-fmea-cancel" class="modal-cancel-btn modal-f5-declaration-review-fmea-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="button" id="modal-f5-declaration-review-fmea-submit" class="modal-submit-btn modal-f5-declaration-review-fmea-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Gửi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: DECLARATION MODALS -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 4: SELECT COMPONENT STANDARD (Chọn công chuẩn tham khảo) -->
  <!-- ============================================ -->
  <div id="modal-f4-select-component-standard" class="modal-container modal-f4-select-component-standard fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f4-select-component-standard-overlay" class="modal-overlay modal-f4-select-component-standard-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f4-select-component-standard-content" class="modal-content modal-f4-select-component-standard-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-4xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Chọn công chuẩn tham khảo</h2>
            <p class="text-sm text-gray-600">Chọn công chuẩn từ danh sách để tự động điền thông tin</p>
          </div>
          <button id="modal-f4-select-component-standard-close" class="modal-close modal-f4-select-component-standard-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <!-- Search box -->
        <div class="mb-4">
          <div class="relative">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
            <input type="text" id="modal-f4-select-component-standard-search" placeholder="Tìm kiếm công chuẩn..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:border-primary-blue focus:ring-primary-blue">
          </div>
        </div>
        
        <!-- Component list -->
        <div id="modal-f4-select-component-standard-body" class="modal-body modal-f4-select-component-standard-body overflow-y-auto flex-1 border border-gray-200 rounded-lg p-4">
          <div id="modal-f4-select-component-standard-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- Danh sách sẽ được render bằng JavaScript -->
          </div>
        </div>
        
        <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4">
          <button type="button" id="modal-f4-select-component-standard-cancel" class="modal-cancel-btn modal-f4-select-component-standard-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 4: SELECT COMPONENT STANDARD -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: VIEW DETAILS (Chi tiết dự án/task/subtask) -->
  <!-- ============================================ -->
  <div id="modal-f5-view-detail" class="modal-container modal-f5-view-detail fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-view-detail-overlay" class="modal-overlay modal-f5-view-detail-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-view-detail-content" class="modal-content modal-f5-view-detail-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-4xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 id="modal-f5-view-detail-title" class="text-2xl font-bold text-gray-900">Chi tiết</h2>
            <p id="modal-f5-view-detail-subtitle" class="text-sm text-gray-600"></p>
          </div>
          <button id="modal-f5-view-detail-close" class="modal-close modal-f5-view-detail-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-view-detail-body" class="modal-body modal-f5-view-detail-body overflow-y-auto flex-1">
          <!-- Nội dung sẽ được render bằng JavaScript -->
        </div>
        
        <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4">
          <button type="button" id="modal-f5-view-detail-close-btn" class="modal-close-btn modal-f5-view-detail-close-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Đóng</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: VIEW DETAILS -->
  <!-- ============================================ -->

  <script>
    // ===== FORM 1 - SO SÁNH CE =====
    
    // Danh sách tên người kiểm tra (từ Form 1 gốc)
    const FORM1_NAMES = [
      "Bùi Đặng Quốc Huy","Đào Tuấn Kỳ","Đỗ Quang Long","Hà Mỹ Linh","Lại Quốc Lộc",
      "Lê Ngọc Ánh","Lê Thị Thanh Nhàn","Lê Thị Thảo","Lê Văn Sơn","Nguyễn Hữu Thịnh","Nguyễn Thị Hiền",
      "Phạm Thành Trung Kiên","Phạm Thị Minh","Thái Thị Giang","Trần Hiếu Nghĩa","Vũ Thị Hằng","Vũ Thị Thanh Hiền"
    ];

    // Hàm điền danh sách vào select
    function fillSelect(selectElement, names) {
      if (!selectElement || !Array.isArray(names)) return;
      names.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        selectElement.appendChild(option);
      });
    }

    // Biến lưu trữ file
    let F1_CE_ORIGINAL_FILE = null;
    let F1_CE_REVIEW_FILE = null;
    
    // Biến lưu trữ dữ liệu rates để xuất Excel
    let F1_RATES_DATA = null;

    // Thiết lập ngày kiểm tra mặc định (GMT +7) - chỉ chạy nếu có trường ngày
    function setDefaultCheckDate() {
      const el = document.getElementById('f1-check-date');
      if (!el) return;
      const now = new Date();
      const utcTime = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
      const gmt7Time = new Date(utcTime + (7 * 60 * 60 * 1000));
      const year = gmt7Time.getFullYear();
      const month = String(gmt7Time.getMonth() + 1).padStart(2, '0');
      const day = String(gmt7Time.getDate()).padStart(2, '0');
      const hours = String(gmt7Time.getHours()).padStart(2, '0');
      const minutes = String(gmt7Time.getMinutes()).padStart(2, '0');
      el.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Khởi tạo ngày mặc định và sidebar navigation khi trang load
    document.addEventListener('DOMContentLoaded', function() {
      setDefaultCheckDate();
      
      // Khởi tạo sidebar navigation
      initSidebarNavigation();
    });

    // Khởi tạo sidebar navigation
    function initSidebarNavigation() {
      // Bật tính năng collapse sidebar
      const sidebarNav = document.getElementById('sidebar-nav');
      if (sidebarNav) {
        sidebarNav.classList.add('collapsible');
      }
      
      // Xử lý click vào các nút navigation để chuyển đổi giữa các form
      const navButtons = document.querySelectorAll('.nav-btn[data-target]');
      navButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const targetForm = this.getAttribute('data-target');
          
          // Remove active class từ tất cả nav buttons
          navButtons.forEach(btn => btn.classList.remove('active', 'bg-sidebar-hover'));
          
          // Add active class cho button được click
          this.classList.add('active', 'bg-sidebar-hover');
          
          // Ẩn tất cả các form
          document.querySelectorAll('section[id^="form"]').forEach(form => {
            form.classList.add('hidden');
          });
          
          // Hiển thị form được chọn
          const targetElement = document.getElementById(targetForm);
          if (targetElement) {
            targetElement.classList.remove('hidden');
            
            // Khởi tạo Form 4 nếu chưa được khởi tạo
            if (targetForm === 'form4' && typeof initForm4 === 'function' && !f4Initialized) {
              initForm4();
            }
            if (targetForm === 'form5' && typeof initForm5 === 'function') {
              initForm5();
            }
            if (targetForm === 'form6' && typeof initForm6 === 'function') {
              initForm6();
            }
          }
          
          console.log('[Navigation] Switched to:', targetForm);
        });
      });
      
      console.log('[Navigation] Sidebar initialized with', navButtons.length, 'forms');
      
      // Hiển thị Form 1 mặc định
      const form1 = document.getElementById('form1');
      if (form1) {
        form1.classList.remove('hidden');
      }
    }

    // Xử lý upload file CE gốc
    document.getElementById('f1-ce-original-btn').addEventListener('click', function() {
      document.getElementById('f1-ce-original').click();
    });

    document.getElementById('f1-ce-original').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        F1_CE_ORIGINAL_FILE = file;
        document.getElementById('f1-ce-original-name').textContent = file.name;
        document.getElementById('f1-ce-original-name').className = 'text-sm text-green-600 flex-1 font-medium';
        document.getElementById('f1-ce-original-remove').classList.remove('hidden');
        showToast('Đã chọn file CE gốc: ' + file.name);
      }
    });

    // Xóa file CE gốc
    document.getElementById('f1-ce-original-remove').addEventListener('click', function() {
      document.getElementById('f1-ce-original').value = '';
      F1_CE_ORIGINAL_FILE = null;
      document.getElementById('f1-ce-original-name').textContent = 'Chưa chọn file';
      document.getElementById('f1-ce-original-name').className = 'text-sm text-gray-500 flex-1';
      this.classList.add('hidden');
    });

    // Xử lý upload file CE sau rà soát
    document.getElementById('f1-ce-review-btn').addEventListener('click', function() {
      document.getElementById('f1-ce-review').click();
    });

    document.getElementById('f1-ce-review').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        F1_CE_REVIEW_FILE = file;
        document.getElementById('f1-ce-review-name').textContent = file.name;
        document.getElementById('f1-ce-review-name').className = 'text-sm text-green-600 flex-1 font-medium';
        document.getElementById('f1-ce-review-remove').classList.remove('hidden');
        showToast('Đã chọn file CE sau rà soát: ' + file.name);
      }
    });

    // Xóa file CE sau rà soát
    document.getElementById('f1-ce-review-remove').addEventListener('click', function() {
      document.getElementById('f1-ce-review').value = '';
      F1_CE_REVIEW_FILE = null;
      document.getElementById('f1-ce-review-name').textContent = 'Chưa chọn file';
      document.getElementById('f1-ce-review-name').className = 'text-sm text-gray-500 flex-1';
      this.classList.add('hidden');
    });

    // Gửi dữ liệu lên server
    document.getElementById('f1-submit-btn').addEventListener('click', async function() {
      // Kiểm tra dữ liệu bắt buộc
      if (!F1_CE_ORIGINAL_FILE) {
        showToast('Vui lòng chọn file CE gốc', 'error');
        return;
      }

      if (!F1_CE_REVIEW_FILE) {
        showToast('Vui lòng chọn file CE sau rà soát', 'error');
        return;
      }

      // Chuẩn bị FormData để gửi
      const formData = new FormData();
      formData.append('ce_original', F1_CE_ORIGINAL_FILE);
      formData.append('ce_review', F1_CE_REVIEW_FILE);

      // Log dữ liệu gửi đi (không log file)
      console.log('[Form 1] Sending data:', {
        ce_original_file: F1_CE_ORIGINAL_FILE?.name || 'N/A',
        ce_review_file: F1_CE_REVIEW_FILE?.name || 'N/A',
        ce_original_size: F1_CE_ORIGINAL_FILE?.size || 0,
        ce_review_size: F1_CE_REVIEW_FILE?.size || 0
      });

      // Disable button và hiển thị loading
      const submitBtn = this;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span> Đang gửi...';

      try {
        // Gửi dữ liệu lên webhook
        const serverUrl = 'https://iatzhxxuk.tino.page/webhook/a3903199-3907-4ac6-b217-6c5f49607de6';
        
        console.log('[Form 1] Sending to:', serverUrl);
        
        const response = await fetch(serverUrl, {
          method: 'POST',
          body: formData,
          // Không set Content-Type header, browser sẽ tự set với boundary cho FormData
        });

        console.log('[Form 1] Response status:', response.status, response.statusText);
        console.log('[Form 1] Response headers:', Object.fromEntries(response.headers.entries()));

        // Đọc response text trước (có thể là JSON hoặc text)
        let responseText = '';
        try {
          responseText = await response.text();
          console.log('[Form 1] Response text:', responseText);
        } catch (textError) {
          console.error('[Form 1] Error reading response text:', textError);
          responseText = '';
        }

        // Parse JSON nếu có thể
        let result = null;
        if (responseText) {
          try {
            result = JSON.parse(responseText);
            console.log('[Form 1] Parsed JSON:', result);
          } catch (parseError) {
            // Nếu không parse được JSON, giữ nguyên text
            console.log('[Form 1] Response is not JSON, keeping as text');
            result = {
              success: response.ok,
              status: response.status,
              statusText: response.statusText,
              body: responseText,
              message: responseText || 'Không có nội dung response'
            };
          }
        } else {
          result = {
            success: response.ok,
            status: response.status,
            statusText: response.statusText,
            message: response.ok ? 'Gửi thành công (không có response body)' : `HTTP ${response.status}: ${response.statusText}`
          };
        }

        // Hiển thị kết quả
        displayJsonResult(result);
        
        if (response.ok) {
          showToast('Đã gửi dữ liệu thành công');
        } else {
          showToast(`Gửi không thành công: HTTP ${response.status}`, 'error');
        }
      } catch (error) {
        console.error('[Form 1] Error submitting:', error);
        console.error('[Form 1] Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        showToast('Lỗi khi gửi dữ liệu: ' + error.message, 'error');
        
        // Hiển thị lỗi dưới dạng JSON
        displayJsonResult({
          error: true,
          name: error.name || 'Unknown Error',
          message: error.message || 'Có lỗi xảy ra',
          timestamp: new Date().toISOString(),
          details: error.stack || 'Không có chi tiết'
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Gửi lên server';
      }
    });

    // Hiển thị kết quả JSON
    function displayJsonResult(data) {
      const jsonResult = document.getElementById('f1-json-result');
      const vnContainer = document.getElementById('f1-json-vn');
      const jsonLabelDiv = jsonResult?.previousElementSibling; // div chứa label "JSON Response:"
      const formattedJson = JSON.stringify(data, null, 2);
      jsonResult.textContent = formattedJson;

      // Thử render bản Việt hóa nếu đúng cấu trúc
      try {
        const arr = Array.isArray(data) ? data : (typeof data === 'string' ? JSON.parse(data) : [data]);
        const first = Array.isArray(arr) ? arr[0] : null;
        const results = first && Array.isArray(first.results) ? first.results : null;
        const summary = first && first.summary ? first.summary : null;
        // Hỗ trợ 3 dạng: { rates:[...] } | [{...ratesItem}, ...] | { results:[...], summary:{} }
        let rates = first && Array.isArray(first.rates) ? first.rates : null;
        if (!rates && Array.isArray(arr) && arr.length && typeof arr[0] === 'object') {
          const looksLikeRate = (o)=> o && ('code' in o) && ('rate' in o || 'rate_percent' in o || 'added_count' in o || 'unchanged_count' in o);
          if (looksLikeRate(arr[0])) { rates = arr; }
        }

        if (rates) {
          // Lưu dữ liệu rates để xuất Excel
          F1_RATES_DATA = rates;
          
          // Dạng mới: rates
          let html = '';

          // Tính toán tổng
          const totalCodes = rates.length;
          const totalAdded = rates.reduce((s, r) => s + Number(r.added_count || 0), 0);
          const totalRemoved = rates.reduce((s, r) => s + Number(r.removed_count || 0), 0);
          const totalChanged = rates.reduce((s, r) => s + Number(r.changed_count || 0), 0);
          const totalUnchanged = rates.reduce((s, r) => s + Number(r.unchanged_count || 0), 0);
          const totalNumerator = rates.reduce((s, r) => s + Number(r.numerator_changes || 0), 0);
          const totalBase = rates.reduce((s, r) => s + Number(r.base_old_items || 0), 0);
          const totalRate = totalBase > 0 ? (totalNumerator / totalBase) : 0;

          // Bảng tóm tắt
          html += `
            <div class="overflow-auto mb-4">
              <table class="min-w-[720px] w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                <thead class="bg-gray-50 text-gray-700">
                  <tr>
                    <th class="px-3 py-2 border">Tổng số mã</th>
                    <th class="px-3 py-2 border">Tổng thay đổi (tử số)</th>
                    <th class="px-3 py-2 border">Tổng mục cũ (mẫu số)</th>
                    <th class="px-3 py-2 border">Tỷ lệ tổng thể</th>
                    <th class="px-3 py-2 border">Thêm mới</th>
                    <th class="px-3 py-2 border">Bị xóa</th>
                    <th class="px-3 py-2 border">Thay đổi</th>
                    <th class="px-3 py-2 border">Không đổi</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="text-center">
                    <td class="px-3 py-2 border font-semibold text-blue-700">${totalCodes}</td>
                    <td class="px-3 py-2 border font-semibold text-indigo-700">${totalNumerator}</td>
                    <td class="px-3 py-2 border font-semibold text-sky-700">${totalBase}</td>
                    <td class="px-3 py-2 border font-semibold text-purple-700">${(totalRate * 100).toFixed(1)}%</td>
                    <td class="px-3 py-2 border font-semibold text-green-700">${totalAdded}</td>
                    <td class="px-3 py-2 border font-semibold text-red-700">${totalRemoved}</td>
                    <td class="px-3 py-2 border font-semibold text-yellow-700">${totalChanged}</td>
                    <td class="px-3 py-2 border font-semibold text-gray-700">${totalUnchanged}</td>
                  </tr>
                </tbody>
              </table>
            </div>`;

          // Dạng ô (cards) cho từng mã
          html += `
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-4">
              ${rates.map((r)=>`
                <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                  <div class="px-4 py-3 bg-gradient-to-r from-blue-50 to-white flex items-center justify-between">
                    <div>
                      <div class="text-sm text-gray-500">Mã: <span class="font-medium text-gray-700">${escapeHtml(r.code||'')}</span></div>
                      <div class="text-base font-semibold text-blue-800">${escapeHtml(r.name||'')}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-[11px] text-gray-500">Tỷ lệ thay đổi</div>
                      <div class="text-2xl font-extrabold text-blue-700">${escapeHtml(r.rate_percent || ((Number(r.rate||0)*100).toFixed(1)+'%'))}</div>
                    </div>
                  </div>
                  <div class="p-4 space-y-3">
                    <div class="grid grid-cols-4 gap-2 text-center">
                      <div class="bg-green-50 border border-green-200 rounded-md px-2 py-2">
                        <div class="text-[11px] text-green-700">+ Thêm</div>
                        <div class="text-lg font-bold text-green-700">${Number(r.added_count||0)}</div>
                      </div>
                      <div class="bg-red-50 border border-red-200 rounded-md px-2 py-2">
                        <div class="text-[11px] text-red-700">- Xóa</div>
                        <div class="text-lg font-bold text-red-700">${Number(r.removed_count||0)}</div>
                      </div>
                      <div class="bg-yellow-50 border border-yellow-200 rounded-md px-2 py-2">
                        <div class="text-[11px] text-yellow-700">Δ Đổi</div>
                        <div class="text-lg font-bold text-yellow-700">${Number(r.changed_count||0)}</div>
                      </div>
                      <div class="bg-gray-50 border border-gray-200 rounded-md px-2 py-2">
                        <div class="text-[11px] text-gray-700">= Không đổi</div>
                        <div class="text-lg font-bold text-gray-700">${Number(r.unchanged_count||0)}</div>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>`;

          // Bảng chi tiết theo mã
          html += `
            <div class="overflow-auto mb-6">
              <table class="min-w-[860px] w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                <thead class="bg-gray-50 text-gray-700">
                  <tr>
                    <th class="px-3 py-2 border text-center">#</th>
                    <th class="px-3 py-2 border">Mã</th>
                    <th class="px-3 py-2 border">Tên</th>
                    <th class="px-3 py-2 border text-center">Tỷ lệ</th>
                    <th class="px-3 py-2 border text-center">Tử số</th>
                    <th class="px-3 py-2 border text-center">Mẫu số</th>
                    <th class="px-3 py-2 border text-center">+ Thêm</th>
                    <th class="px-3 py-2 border text-center">- Xóa</th>
                    <th class="px-3 py-2 border text-center">Δ Đổi</th>
                    <th class="px-3 py-2 border text-center">= Không đổi</th>
                  </tr>
                </thead>
                <tbody>
                  ${rates.map((r, i) => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-3 py-2 border text-center">${i+1}</td>
                      <td class="px-3 py-2 border font-medium">${escapeHtml(r.code||'')}</td>
                      <td class="px-3 py-2 border">${escapeHtml(r.name||'')}</td>
                      <td class="px-3 py-2 border text-center">${escapeHtml(r.rate_percent || ((Number(r.rate||0)*100).toFixed(1)+'%'))}</td>
                      <td class="px-3 py-2 border text-center">${Number(r.numerator_changes||0)}</td>
                      <td class="px-3 py-2 border text-center">${Number(r.base_old_items||0)}</td>
                      <td class="px-3 py-2 border text-center text-green-700 font-medium">${Number(r.added_count||0)}</td>
                      <td class="px-3 py-2 border text-center text-red-700 font-medium">${Number(r.removed_count||0)}</td>
                      <td class="px-3 py-2 border text-center text-yellow-700 font-medium">${Number(r.changed_count||0)}</td>
                      <td class="px-3 py-2 border text-center text-gray-700 font-medium">${Number(r.unchanged_count||0)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>`;

          // Chi tiết items cho từng mã
          html += `
            <div class="mb-4">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">Chi tiết thay đổi theo từng mã</h4>
              <div class="space-y-4">
                ${rates.map((r, idx) => {
                  const addedItems = Array.isArray(r.added_items) ? r.added_items : [];
                  const removedItems = Array.isArray(r.removed_items) ? r.removed_items : [];
                  const changedItems = Array.isArray(r.changed_items) ? r.changed_items : [];
                  const hasDetails = addedItems.length > 0 || removedItems.length > 0 || changedItems.length > 0;
                  const detailsId = `rate-details-${idx}`;
                  
                  if (!hasDetails) return '';
                  
                  return `
                    <div class="border border-gray-300 rounded-lg overflow-hidden bg-white shadow-sm">
                      <button onclick="toggleRateDetails('${detailsId}')" class="w-full px-5 py-4 bg-gradient-to-r from-blue-50 to-white hover:from-blue-100 hover:to-blue-50 transition flex items-center justify-between text-left">
                        <div>
                          <div class="font-semibold text-blue-800 text-lg">${idx + 1}. ${escapeHtml(r.code || '')} - ${escapeHtml(r.name || '')}</div>
                          <div class="text-sm text-gray-600 mt-1">
                            ${addedItems.length > 0 ? `<span class="text-green-700 font-medium">+${addedItems.length} thêm</span>` : ''}
                            ${removedItems.length > 0 ? `<span class="text-red-700 font-medium ml-2">-${removedItems.length} xóa</span>` : ''}
                            ${changedItems.length > 0 ? `<span class="text-yellow-700 font-medium ml-2">Δ${changedItems.length} đổi</span>` : ''}
                          </div>
                        </div>
                        <svg id="icon-${detailsId}" class="w-5 h-5 text-gray-500 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      <div id="${detailsId}" class="border-t border-gray-200 bg-gray-50">
                        <div class="p-5 space-y-5">
                          ${addedItems.length > 0 ? renderAddedItems(addedItems, idx) : ''}
                          ${removedItems.length > 0 ? renderRemovedItems(removedItems, idx) : ''}
                          ${changedItems.length > 0 ? renderChangedItems(changedItems, idx) : ''}
                        </div>
                      </div>
                    </div>
                  `;
                }).filter(h => h).join('')}
              </div>
            </div>`;

          vnContainer.innerHTML = html;
          vnContainer.classList.remove('hidden');
          // Hiển thị nút xuất Excel
          const exportBtn = document.getElementById('f1-export-excel');
          if (exportBtn) exportBtn.classList.remove('hidden');
          // Ẩn phần JSON thô
          if (jsonLabelDiv) jsonLabelDiv.style.display = 'none';
          if (jsonResult) jsonResult.style.display = 'none';
        } else if (results) {
          let html = '';

          // Tóm tắt
          if (summary) {
            html += `
              <div class="overflow-auto mb-4">
                <table class="min-w-[560px] w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                  <thead class="bg-gray-50 text-gray-700">
                    <tr>
                      <th class="px-3 py-2 border">Tổng số mã</th>
                      <th class="px-3 py-2 border">Thêm mới</th>
                      <th class="px-3 py-2 border">Bị xóa</th>
                      <th class="px-3 py-2 border">Thay đổi</th>
                      <th class="px-3 py-2 border">Không đổi</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="text-center">
                      <td class="px-3 py-2 border font-semibold text-blue-700">${summary.total_codes ?? 0}</td>
                      <td class="px-3 py-2 border font-semibold text-green-700">${summary.total_added ?? 0}</td>
                      <td class="px-3 py-2 border font-semibold text-red-700">${summary.total_removed ?? 0}</td>
                      <td class="px-3 py-2 border font-semibold text-yellow-700">${summary.total_changed ?? 0}</td>
                      <td class="px-3 py-2 border font-semibold text-gray-700">${summary.total_unchanged ?? 0}</td>
                    </tr>
                  </tbody>
                </table>
              </div>`;
          }

          // Chi tiết theo mã
          html += '<div class="space-y-4">';
          results.forEach((r, idx) => {
            const added = Array.isArray(r.added) ? r.added : [];
            const removed = Array.isArray(r.removed) ? r.removed : [];
            const changed = Array.isArray(r.changed) ? r.changed : [];
            html += `
              <div class="border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between px-4 py-3 bg-gradient-to-r from-blue-50 to-white rounded-t-lg">
                  <div class="font-semibold text-blue-800">${idx+1}. ${r.code || ''} — ${r.name || ''}</div>
                  <div class="flex gap-2 text-xs">
                    <span class="px-2 py-1 rounded bg-green-100 text-green-700">+${r.added_count ?? added.length}</span>
                    <span class="px-2 py-1 rounded bg-red-100 text-red-700">-${r.removed_count ?? removed.length}</span>
                    <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-700">Δ${r.changed_count ?? changed.length}</span>
                    <span class="px-2 py-1 rounded bg-gray-100 text-gray-700">=${r.unchanged_count ?? 0}</span>
                  </div>
                </div>
                <div class="p-4 space-y-4">
                  ${added.length ? renderGroup('Thêm mới', added, 'green') : ''}
                  ${removed.length ? renderGroup('Bị xóa', removed, 'red') : ''}
                  ${changed.length ? renderGroup('Thay đổi', changed, 'yellow') : ''}
                  ${!added.length && !removed.length && !changed.length ? '<div class="text-sm text-gray-500">Không có thay đổi.</div>' : ''}
                </div>
              </div>`;
          });
          html += '</div>';

          vnContainer.innerHTML = html;
          vnContainer.classList.remove('hidden');
          // Ẩn phần JSON thô
          if (jsonLabelDiv) jsonLabelDiv.style.display = 'none';
          if (jsonResult) jsonResult.style.display = 'none';
        } else {
          vnContainer.classList.add('hidden');
          // Ẩn nút xuất Excel và reset dữ liệu
          F1_RATES_DATA = null;
          const exportBtn = document.getElementById('f1-export-excel');
          if (exportBtn) exportBtn.classList.add('hidden');
          // Hiện lại phần JSON thô nếu không parse được
          if (jsonLabelDiv) jsonLabelDiv.style.display = '';
          if (jsonResult) jsonResult.style.display = '';
        }
      } catch (e) {
        console.warn('VN render failed:', e);
        vnContainer?.classList.add('hidden');
        // Ẩn nút xuất Excel và reset dữ liệu
        F1_RATES_DATA = null;
        const exportBtn = document.getElementById('f1-export-excel');
        if (exportBtn) exportBtn.classList.add('hidden');
        // Hiện lại phần JSON thô khi có lỗi
        if (jsonLabelDiv) jsonLabelDiv.style.display = '';
        if (jsonResult) jsonResult.style.display = '';
      }

      // Hiển thị phần kết quả
      document.getElementById('f1-result').classList.remove('hidden');
      document.getElementById('f1-result').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Không sử dụng đồ thị

    // Hàm toggle chi tiết cho rate cards
    window.toggleRateDetails = function(detailsId) {
      const details = document.getElementById(detailsId);
      const icon = document.getElementById('icon-' + detailsId);
      if (details) {
        details.classList.toggle('hidden');
        if (icon) {
          icon.classList.toggle('rotate-180');
        }
      }
    };

    // Hàm render added items
    function renderAddedItems(items, cardIdx) {
      if (!items || items.length === 0) return '';
      return `
        <div class="bg-white border border-green-300 rounded-lg overflow-hidden shadow-sm">
          <div class="bg-gradient-to-r from-green-500 to-green-600 px-4 py-3">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              <h5 class="text-white font-semibold text-base">Thêm mới (${items.length} mục)</h5>
            </div>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-green-50">
                <tr>
                  <th class="px-4 py-2 border border-green-200 text-center font-semibold text-green-800">#</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">Chỉ tiêu</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">Tiêu chuẩn</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">Dụng cụ</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">Loại</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">Tài liệu</th>
                </tr>
              </thead>
              <tbody>
                ${items.map((item, i) => `
                  <tr class="hover:bg-green-50 transition">
                    <td class="px-4 py-3 border border-green-200 text-center font-medium text-gray-700">${i + 1}</td>
                    <td class="px-4 py-3 border border-green-200 font-medium text-gray-800">${escapeHtml(item.index || '')}</td>
                    <td class="px-4 py-3 border border-green-200 text-gray-700">${escapeHtml(item.standard || '')}</td>
                    <td class="px-4 py-3 border border-green-200 text-gray-700">${escapeHtml(item.tool || '')}</td>
                    <td class="px-4 py-3 border border-green-200 text-center">
                      <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">${escapeHtml(item.type || '')}</span>
                    </td>
                    <td class="px-4 py-3 border border-green-200 text-gray-700 text-xs">${escapeHtml(item.document || '')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Hàm render removed items
    function renderRemovedItems(items, cardIdx) {
      if (!items || items.length === 0) return '';
      return `
        <div class="bg-white border border-red-300 rounded-lg overflow-hidden shadow-sm">
          <div class="bg-gradient-to-r from-red-500 to-red-600 px-4 py-3">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              <h5 class="text-white font-semibold text-base">Bị xóa (${items.length} mục)</h5>
            </div>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-red-50">
                <tr>
                  <th class="px-4 py-2 border border-red-200 text-center font-semibold text-red-800">#</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">Chỉ tiêu</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">Tiêu chuẩn</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">Dụng cụ</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">Loại</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">Tài liệu</th>
                </tr>
              </thead>
              <tbody>
                ${items.map((item, i) => `
                  <tr class="hover:bg-red-50 transition">
                    <td class="px-4 py-3 border border-red-200 text-center font-medium text-gray-700">${i + 1}</td>
                    <td class="px-4 py-3 border border-red-200 font-medium text-gray-800">${escapeHtml(item.index || '')}</td>
                    <td class="px-4 py-3 border border-red-200 text-gray-700">${escapeHtml(item.standard || '')}</td>
                    <td class="px-4 py-3 border border-red-200 text-gray-700">${escapeHtml(item.tool || '')}</td>
                    <td class="px-4 py-3 border border-red-200 text-center">
                      <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">${escapeHtml(item.type || '')}</span>
                    </td>
                    <td class="px-4 py-3 border border-red-200 text-gray-700 text-xs">${escapeHtml(item.document || '')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Hàm render changed items với so sánh before/after
    function renderChangedItems(items, cardIdx) {
      if (!items || items.length === 0) return '';
      return `
        <div class="bg-white border border-yellow-300 rounded-lg overflow-hidden shadow-sm">
          <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 px-4 py-3">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
              </svg>
              <h5 class="text-white font-semibold text-base">Thay đổi (${items.length} mục)</h5>
            </div>
          </div>
          <div class="p-4 space-y-4">
            ${items.map((item, i) => {
              const before = item.before || {};
              const after = item.after || {};
              const index = item.index || '';
              
              // So sánh các trường để highlight thay đổi
              const standardChanged = before.standard !== after.standard;
              const toolChanged = before.tool !== after.tool;
              const typeChanged = before.type !== after.type;
              const documentChanged = before.document !== after.document;
              
              return `
                <div class="border border-yellow-200 rounded-lg overflow-hidden bg-gradient-to-br from-yellow-50 to-white">
                  <div class="bg-yellow-100 px-4 py-2 border-b border-yellow-200">
                    <div class="flex items-center gap-2">
                      <span class="px-2 py-1 bg-yellow-500 text-white text-xs font-semibold rounded">#${i + 1}</span>
                      <span class="font-semibold text-yellow-900 text-sm">${escapeHtml(index)}</span>
                    </div>
                  </div>
                  <div class="overflow-auto">
                    <table class="min-w-full text-sm">
                      <thead class="bg-yellow-50">
                        <tr>
                          <th class="px-4 py-2 border border-yellow-200 font-semibold text-yellow-900 w-1/6">Trường</th>
                          <th class="px-4 py-2 border border-yellow-200 font-semibold text-red-700 w-5/12">Trước (Before)</th>
                          <th class="px-4 py-2 border border-yellow-200 font-semibold text-green-700 w-5/12">Sau (After)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr class="hover:bg-yellow-50">
                          <td class="px-4 py-3 border border-yellow-200 font-medium text-gray-800 bg-gray-50">Tiêu chuẩn</td>
                          <td class="px-4 py-3 border border-yellow-200 ${standardChanged ? 'bg-red-50 font-medium text-red-800' : 'text-gray-700'}">${escapeHtml(before.standard || '')}</td>
                          <td class="px-4 py-3 border border-yellow-200 ${standardChanged ? 'bg-green-50 font-medium text-green-800' : 'text-gray-700'}">${escapeHtml(after.standard || '')}</td>
                        </tr>
                        <tr class="hover:bg-yellow-50">
                          <td class="px-4 py-3 border border-yellow-200 font-medium text-gray-800 bg-gray-50">Dụng cụ</td>
                          <td class="px-4 py-3 border border-yellow-200 ${toolChanged ? 'bg-red-50 font-medium text-red-800' : 'text-gray-700'}">${escapeHtml(before.tool || '')}</td>
                          <td class="px-4 py-3 border border-yellow-200 ${toolChanged ? 'bg-green-50 font-medium text-green-800' : 'text-gray-700'}">${escapeHtml(after.tool || '')}</td>
                        </tr>
                        <tr class="hover:bg-yellow-50">
                          <td class="px-4 py-3 border border-yellow-200 font-medium text-gray-800 bg-gray-50">Loại</td>
                          <td class="px-4 py-3 border border-yellow-200 text-center ${typeChanged ? 'bg-red-50' : ''}">
                            ${before.type ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">${escapeHtml(before.type)}</span>` : ''}
                          </td>
                          <td class="px-4 py-3 border border-yellow-200 text-center ${typeChanged ? 'bg-green-50' : ''}">
                            ${after.type ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">${escapeHtml(after.type)}</span>` : ''}
                          </td>
                        </tr>
                        <tr class="hover:bg-yellow-50">
                          <td class="px-4 py-3 border border-yellow-200 font-medium text-gray-800 bg-gray-50">Tài liệu</td>
                          <td class="px-4 py-3 border border-yellow-200 text-xs ${documentChanged ? 'bg-red-50 font-medium text-red-800' : 'text-gray-700'}">${escapeHtml(before.document || '')}</td>
                          <td class="px-4 py-3 border border-yellow-200 text-xs ${documentChanged ? 'bg-green-50 font-medium text-green-800' : 'text-gray-700'}">${escapeHtml(after.document || '')}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderGroup(title, items, tone) {
      const toneMap = {
        green: { head:'bg-green-50 text-green-800 border-green-200', dot:'bg-green-400' },
        red: { head:'bg-red-50 text-red-800 border-red-200', dot:'bg-red-400' },
        yellow: { head:'bg-yellow-50 text-yellow-800 border-yellow-200', dot:'bg-yellow-400' }
      }[tone] || { head:'bg-gray-50 text-gray-800 border-gray-200', dot:'bg-gray-400' };
      let rows = '';
      items.forEach((it, i) => {
        rows += `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-2 border text-center">${i+1}</td>
            <td class="px-3 py-2 border">${escapeHtml(it.index ?? '')}</td>
            <td class="px-3 py-2 border">${escapeHtml(it.standard ?? '')}</td>
            <td class="px-3 py-2 border">${escapeHtml(it.tool ?? '')}</td>
            <td class="px-3 py-2 border">${escapeHtml(it.type ?? '')}</td>
            <td class="px-3 py-2 border text-center">${escapeHtml(it.document ?? '')}</td>
          </tr>`;
      });
      return `
        <div class="border ${toneMap.head.split(' ').includes('border') ? toneMap.head.split(' ').find(c=>c.startsWith('border-')) : 'border-gray-200'} rounded-lg overflow-hidden">
          <div class="px-3 py-2 ${toneMap.head} font-medium">${title}</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-white">
                <tr class="text-left">
                  <th class="px-3 py-2 border text-center">#</th>
                  <th class="px-3 py-2 border">Chỉ tiêu</th>
                  <th class="px-3 py-2 border">Tiêu chuẩn</th>
                  <th class="px-3 py-2 border">Dụng cụ</th>
                  <th class="px-3 py-2 border">Loại</th>
                  <th class="px-3 py-2 border text-center">Tài liệu</th>
                </tr>
              </thead>
              <tbody>
                ${rows || '<tr><td colspan="6" class="px-3 py-3 text-center text-gray-500">Không có mục</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>`;
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Copy JSON
    document.getElementById('f1-copy-json').addEventListener('click', function() {
      const jsonText = document.getElementById('f1-json-result').textContent;
      if (jsonText && jsonText !== 'Chưa có kết quả') {
        navigator.clipboard.writeText(jsonText).then(() => {
          showToast('Đã copy JSON vào clipboard');
        }).catch(err => {
          console.error('Error copying to clipboard:', err);
          showToast('Lỗi khi copy JSON', 'error');
        });
      } else {
        showToast('Không có dữ liệu để copy', 'error');
      }
    });

    // Hàm xuất dữ liệu Form 1 ra Excel
    function exportF1ToExcel() {
      if (!F1_RATES_DATA || !Array.isArray(F1_RATES_DATA) || F1_RATES_DATA.length === 0) {
        showToast('Không có dữ liệu để xuất', 'error');
        return;
      }

      try {
        // Tạo workbook
        const wb = XLSX.utils.book_new();

        // Sheet 1: Tóm tắt
        const summaryData = [];
        const totalCodes = F1_RATES_DATA.length;
        const totalAdded = F1_RATES_DATA.reduce((s, r) => s + Number(r.added_count || 0), 0);
        const totalRemoved = F1_RATES_DATA.reduce((s, r) => s + Number(r.removed_count || 0), 0);
        const totalChanged = F1_RATES_DATA.reduce((s, r) => s + Number(r.changed_count || 0), 0);
        const totalUnchanged = F1_RATES_DATA.reduce((s, r) => s + Number(r.unchanged_count || 0), 0);
        const totalNumerator = F1_RATES_DATA.reduce((s, r) => s + Number(r.numerator_changes || 0), 0);
        const totalBase = F1_RATES_DATA.reduce((s, r) => s + Number(r.base_old_items || 0), 0);
        const totalRate = totalBase > 0 ? (totalNumerator / totalBase) : 0;

        summaryData.push(['Tóm tắt tổng thể']);
        summaryData.push([]);
        summaryData.push(['Tổng số mã', totalCodes]);
        summaryData.push(['Tổng thay đổi (tử số)', totalNumerator]);
        summaryData.push(['Tổng mục cũ (mẫu số)', totalBase]);
        summaryData.push(['Tỷ lệ tổng thể', `${(totalRate * 100).toFixed(1)}%`]);
        summaryData.push(['Thêm mới', totalAdded]);
        summaryData.push(['Bị xóa', totalRemoved]);
        summaryData.push(['Thay đổi', totalChanged]);
        summaryData.push(['Không đổi', totalUnchanged]);

        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Tóm tắt');

        // Sheet 2: Chi tiết theo mã
        const detailData = [
          ['#', 'Mã', 'Tên', 'Tỷ lệ', 'Tử số', 'Mẫu số', 'Thêm', 'Xóa', 'Đổi', 'Không đổi']
        ];

        F1_RATES_DATA.forEach((r, i) => {
          detailData.push([
            i + 1,
            r.code || '',
            r.name || '',
            r.rate_percent || ((Number(r.rate || 0) * 100).toFixed(1) + '%'),
            Number(r.numerator_changes || 0),
            Number(r.base_old_items || 0),
            Number(r.added_count || 0),
            Number(r.removed_count || 0),
            Number(r.changed_count || 0),
            Number(r.unchanged_count || 0)
          ]);
        });

        const wsDetail = XLSX.utils.aoa_to_sheet(detailData);
        XLSX.utils.book_append_sheet(wb, wsDetail, 'Chi tiết');

        // Sheet 3: Chi tiết items (Added, Removed, Changed)
        const itemsData = [
          ['Mã', 'Tên', 'Loại', 'Chỉ tiêu', 'Tiêu chuẩn', 'Dụng cụ', 'Loại item', 'Tài liệu', 'Trước (Before)', 'Sau (After)']
        ];

        F1_RATES_DATA.forEach((r) => {
          const code = r.code || '';
          const name = r.name || '';
          
          // Added items
          const addedItems = Array.isArray(r.added_items) ? r.added_items : [];
          addedItems.forEach((item) => {
            itemsData.push([
              code,
              name,
              'Thêm mới',
              item.index || '',
              item.standard || '',
              item.tool || '',
              item.type || '',
              item.document || '',
              '',
              ''
            ]);
          });

          // Removed items
          const removedItems = Array.isArray(r.removed_items) ? r.removed_items : [];
          removedItems.forEach((item) => {
            itemsData.push([
              code,
              name,
              'Bị xóa',
              item.index || '',
              item.standard || '',
              item.tool || '',
              item.type || '',
              item.document || '',
              '',
              ''
            ]);
          });

          // Changed items
          const changedItems = Array.isArray(r.changed_items) ? r.changed_items : [];
          changedItems.forEach((item) => {
            const before = item.before || {};
            const after = item.after || {};
            itemsData.push([
              code,
              name,
              'Thay đổi',
              item.index || '',
              before.standard || '',
              before.tool || '',
              before.type || '',
              before.document || '',
              JSON.stringify(before),
              JSON.stringify(after)
            ]);
          });
        });

        const wsItems = XLSX.utils.aoa_to_sheet(itemsData);
        XLSX.utils.book_append_sheet(wb, wsItems, 'Chi tiết Items');

        // Tạo tên file với timestamp
        const now = new Date();
        const dateStr = now.getFullYear() + '-' +
          String(now.getMonth() + 1).padStart(2, '0') + '-' +
          String(now.getDate()).padStart(2, '0') + '_' +
          String(now.getHours()).padStart(2, '0') + '-' +
          String(now.getMinutes()).padStart(2, '0') + '-' +
          String(now.getSeconds()).padStart(2, '0');
        const filename = `So_sanh_CE_${dateStr}.xlsx`;

        // Xuất file
        XLSX.writeFile(wb, filename);

        showToast(`Đã xuất ${F1_RATES_DATA.length} mã ra file Excel`, 'success');

      } catch (error) {
        console.error('[Form 1] Error exporting to Excel:', error);
        showToast('Lỗi khi xuất file Excel: ' + error.message, 'error');
      }
    }

    // Event listener cho nút xuất Excel
    document.getElementById('f1-export-excel').addEventListener('click', function() {
      exportF1ToExcel();
    });

    // Hàm hiển thị toast
    function showToast(message, type = 'success') {
      // Tạo toast element nếu chưa có
      let toast = document.getElementById('toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'toast';
        document.body.appendChild(toast);
      }

      toast.textContent = message;
      toast.className = `toast ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== FORM 2 - RÀ SOÁT CE =====
    
    // Hàm tính màu từ tỷ lệ (0% = đỏ, 100% = xanh lá)
    function getCompletionColor(percentage) {
      // Chuyển đổi phần trăm thành số (loại bỏ % nếu có)
      let percent = parseFloat(String(percentage).replace('%', ''));
      if (isNaN(percent)) percent = 0;
      percent = Math.max(0, Math.min(100, percent)); // Giới hạn từ 0-100
      
      // Tính màu RGB gradient từ đỏ -> vàng -> xanh lá
      let r, g, b;
      
      if (percent < 50) {
        // 0-50%: Đỏ (239, 68, 68) -> Vàng (234, 179, 8)
        const ratio = percent / 50;
        r = Math.round(239 - (239 - 234) * ratio);
        g = Math.round(68 + (179 - 68) * ratio);
        b = Math.round(68 - (68 - 8) * ratio);
      } else {
        // 50-100%: Vàng (234, 179, 8) -> Xanh lá (34, 197, 94)
        const ratio = (percent - 50) / 50;
        r = Math.round(234 - (234 - 34) * ratio);
        g = Math.round(179 + (197 - 179) * ratio);
        b = Math.round(8 + (94 - 8) * ratio);
      }
      
      return `rgb(${r}, ${g}, ${b})`;
    }

    // Biến lưu dữ liệu gốc để filter
    let F2_ORIGINAL_DATA = [];

    // Hàm populate filter dropdowns
    function populateF2Filters(data) {
      if (!data || !Array.isArray(data)) return;
      
      const picFilter = document.getElementById('f2-filter-pic');
      const projectFilter = document.getElementById('f2-filter-project');
      
      if (!picFilter || !projectFilter) return;
      
      // Lưu giá trị đã chọn
      const selectedPic = picFilter.value;
      const selectedProject = projectFilter.value;
      
      // Clear existing options (giữ lại option "Tất cả")
      picFilter.innerHTML = '<option value="">Tất cả</option>';
      projectFilter.innerHTML = '<option value="">Tất cả</option>';
      
      // Lấy danh sách unique PIC cụm và Dự án
      const picSet = new Set();
      const projectSet = new Set();
      
      data.forEach(row => {
        const pic = row.pic_cluster || row['PIC cụm'] || row.pic_cum || row.pic || '';
        const project = row.project || row['Dự án'] || row.du_an || '';
        
        if (pic) picSet.add(pic);
        if (project) projectSet.add(project);
      });
      
      // Populate PIC filter
      const sortedPics = Array.from(picSet).sort();
      sortedPics.forEach(pic => {
        const option = document.createElement('option');
        option.value = pic;
        option.textContent = pic;
        if (pic === selectedPic) option.selected = true;
        picFilter.appendChild(option);
      });
      
      // Populate Project filter
      const sortedProjects = Array.from(projectSet).sort();
      sortedProjects.forEach(project => {
        const option = document.createElement('option');
        option.value = project;
        option.textContent = project;
        if (project === selectedProject) option.selected = true;
        projectFilter.appendChild(option);
      });
    }

    // Hàm filter dữ liệu
    function filterF2Data(data) {
      if (!data || !Array.isArray(data)) return [];
      
      const picFilter = document.getElementById('f2-filter-pic');
      const projectFilter = document.getElementById('f2-filter-project');
      
      const selectedPic = picFilter ? picFilter.value : '';
      const selectedProject = projectFilter ? projectFilter.value : '';
      
      return data.filter(row => {
        const pic = row.pic_cluster || row['PIC cụm'] || row.pic_cum || row.pic || '';
        const project = row.project || row['Dự án'] || row.du_an || '';
        
        const picMatch = !selectedPic || pic === selectedPic;
        const projectMatch = !selectedProject || project === selectedProject;
        
        return picMatch && projectMatch;
      });
    }

    // Hàm xuất dữ liệu ra Excel
    function exportF2ToExcel() {
      // Lấy dữ liệu đã filter
      const filteredData = filterF2Data(F2_ORIGINAL_DATA);
      
      if (!filteredData || filteredData.length === 0) {
        showToast('Không có dữ liệu để xuất', 'error');
        return;
      }

      try {
        // Chuẩn bị dữ liệu cho Excel
        const excelData = filteredData.map((row, index) => {
          // Lấy giá trị tỷ lệ hoàn thiện bổ sung
          const completionRate = row.completion_rate || row.completion || 
                                 row['Tỷ lệ hoàn thiện bổ sung'] || row['Tỷ lệ hoàn thiện'] ||
                                 row.completion_rate_supplement || row.completion_supplement ||
                                 row.rate || row.percent || row.percentage || 
                                 row.ty_le_hoan_thien_bo_sung || row.ty_le_hoan_thien || '0%';

          return {
            'STT': index + 1,
            'PIC cụm': row.pic_cluster || row['PIC cụm'] || row.pic_cum || row.pic || '',
            'Dự án': row.project || row['Dự án'] || row.du_an || '',
            'Ngày giao': row.delivery_date || row['Ngày giao'] || row.ngay_giao || row.date || '',
            'Mã SAP': row.sap_code || row['Mã SAP'] || row.ma_sap || row.sap || '',
            'Cụm linh kiện': row.component_cluster || row['Cụm linh kiện'] || row.cum_linh_kien || row.cluster || '',
            'Tên linh kiện': row.component_name || row['Tên linh kiện'] || row.ten_linh_kien || row.name || '',
            'Rà soát TCKT&CE': row.review || row['Rà soát TCKT&CE'] || row.ra_soat || row.ra_soat_tckt_ce || '',
            'Ngày cập nhật gần nhất': row.last_update || row['Ngày cập nhật gần nhất'] || row.ngay_cap_nhat || row.updated_at || '',
            'Tỷ lệ hoàn thiện bổ sung': String(completionRate)
          };
        });

        // Tạo worksheet từ dữ liệu
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Điều chỉnh độ rộng cột (tùy chọn)
        const colWidths = [
          { wch: 8 },   // STT
          { wch: 15 },  // PIC cụm
          { wch: 20 },  // Dự án
          { wch: 12 },  // Ngày giao
          { wch: 12 },  // Mã SAP
          { wch: 25 },  // Cụm linh kiện
          { wch: 35 },  // Tên linh kiện
          { wch: 18 },  // Rà soát TCKT&CE
          { wch: 22 },  // Ngày cập nhật gần nhất
          { wch: 25 }   // Tỷ lệ hoàn thiện bổ sung
        ];
        ws['!cols'] = colWidths;

        // Tạo workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Rà soát CE');

        // Tạo tên file với timestamp
        const now = new Date();
        const dateStr = now.getFullYear() + '-' + 
                       String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(now.getDate()).padStart(2, '0') + '_' +
                       String(now.getHours()).padStart(2, '0') + '-' +
                       String(now.getMinutes()).padStart(2, '0') + '-' +
                       String(now.getSeconds()).padStart(2, '0');
        const filename = `Ra_soat_CE_${dateStr}.xlsx`;

        // Xuất file
        XLSX.writeFile(wb, filename);
        
        showToast(`Đã xuất ${filteredData.length} bản ghi ra file Excel`, 'success');
        
      } catch (error) {
        console.error('[Form 2] Error exporting to Excel:', error);
        showToast('Lỗi khi xuất file Excel: ' + error.message, 'error');
      }
    }

    // Hàm render dữ liệu vào bảng Form 2
    function renderForm2Table(data) {
      // Lưu dữ liệu gốc
      F2_ORIGINAL_DATA = data || [];
      
      // Populate filters
      populateF2Filters(F2_ORIGINAL_DATA);
      
      // Filter dữ liệu
      const filteredData = filterF2Data(F2_ORIGINAL_DATA);
      
      const tbody = document.getElementById('f2-table-body');
      if (!tbody) return;
      
      if (!filteredData || !Array.isArray(filteredData) || filteredData.length === 0) {
        tbody.innerHTML = '<tr><td class="px-3 py-4 text-center text-gray-500 border border-gray-300" colspan="9">Không có dữ liệu phù hợp với bộ lọc</td></tr>';
        return;
      }
      
      let html = '';
      filteredData.forEach((row, index) => {
        // Lấy giá trị tỷ lệ hoàn thiện bổ sung - hỗ trợ nhiều tên field khác nhau
        const completionRate = row.completion_rate || row.completion || 
                               row['Tỷ lệ hoàn thiện bổ sung'] || row['Tỷ lệ hoàn thiện'] ||
                               row.completion_rate_supplement || row.completion_supplement ||
                               row.rate || row.percent || row.percentage || 
                               row.ty_le_hoan_thien_bo_sung || row.ty_le_hoan_thien || '0%';
        const completionPercent = parseFloat(String(completionRate).replace('%', '')) || 0;
        const completionColor = getCompletionColor(completionPercent);
        
        // Hỗ trợ nhiều tên field khác nhau cho từng cột
        html += `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.pic_cluster || row['PIC cụm'] || row.pic_cum || row.pic || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.project || row['Dự án'] || row.du_an || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.delivery_date || row['Ngày giao'] || row.ngay_giao || row.date || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.sap_code || row['Mã SAP'] || row.ma_sap || row.sap || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.component_cluster || row['Cụm linh kiện'] || row.cum_linh_kien || row.cluster || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.component_name || row['Tên linh kiện'] || row.ten_linh_kien || row.name || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.review || row['Rà soát TCKT&CE'] || row.ra_soat || row.ra_soat_tckt_ce || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.last_update || row['Ngày cập nhật gần nhất'] || row.ngay_cap_nhat || row.updated_at || '')}</td>
            <td class="px-3 py-4 border border-gray-300 text-center">${escapeHtml(String(completionRate))}</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }

    // Hàm fetch dữ liệu từ webhook cho Form 2
    async function fetchForm2Data() {
      const loadBtn = document.getElementById('f2-load-btn');
      const loadingDiv = document.getElementById('f2-loading');
      const tbody = document.getElementById('f2-table-body');
      
      const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/0a37d9a8-8be4-4311-93cf-923e7e874128';
      
      try {
        // Hiển thị loading
        if (loadBtn) loadBtn.disabled = true;
        if (loadingDiv) loadingDiv.classList.remove('hidden');
        if (tbody) {
          tbody.innerHTML = '<tr><td class="px-3 py-4 text-center text-gray-500 border border-gray-300" colspan="9">Đang tải dữ liệu...</td></tr>';
        }
        
        console.log('[Form 2] Fetching data from:', webhookUrl);
        
        // Gọi API với query parameters (có thể thêm filter, page, limit, etc.)
        const params = new URLSearchParams({
          // Có thể thêm các query params ở đây nếu cần
          // format: 'json',
          // limit: '100',
          // offset: '0'
        });
        
        const url = `${webhookUrl}?${params.toString()}`;
        console.log('[Form 2] Full URL:', url);
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        
        console.log('[Form 2] Response status:', response.status, response.statusText);
        console.log('[Form 2] Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseText = await response.text();
        console.log('[Form 2] Response text:', responseText);
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          console.error('[Form 2] JSON parse error:', e);
          // Nếu không phải JSON, thử xử lý như text
          throw new Error('Response is not valid JSON');
        }
        
        console.log('[Form 2] Parsed data:', data);
        
        // Xử lý dữ liệu trả về - có thể là array trực tiếp hoặc object chứa array
        let tableData = [];
        if (Array.isArray(data)) {
          tableData = data;
        } else if (data && Array.isArray(data.data)) {
          tableData = data.data;
        } else if (data && Array.isArray(data.results)) {
          tableData = data.results;
        } else if (data && Array.isArray(data.items)) {
          tableData = data.items;
        } else if (data && typeof data === 'object') {
          // Nếu là object đơn, thử chuyển thành array 1 phần tử
          tableData = [data];
        }
        
        console.log('[Form 2] Table data:', tableData);
        
        // Render dữ liệu vào bảng
        renderForm2Table(tableData);
        
        // Thông báo thành công
        showToast(`Đã tải ${tableData.length} bản ghi`, 'success');
        
      } catch (error) {
        console.error('[Form 2] Error fetching data:', error);
        if (tbody) {
          tbody.innerHTML = `<tr><td class="px-3 py-4 text-center text-red-500 border border-gray-300" colspan="9">Lỗi: ${escapeHtml(error.message)}</td></tr>`;
        }
        showToast('Lỗi khi tải dữ liệu: ' + error.message, 'error');
      } finally {
        // Ẩn loading
        if (loadBtn) loadBtn.disabled = false;
        if (loadingDiv) loadingDiv.classList.add('hidden');
      }
    }

    // Event listener cho nút tải dữ liệu Form 2
    document.addEventListener('DOMContentLoaded', function() {
      const f2LoadBtn = document.getElementById('f2-load-btn');
      if (f2LoadBtn) {
        f2LoadBtn.addEventListener('click', function() {
          fetchForm2Data();
        });
      }
      
      // Tự động load dữ liệu khi chuyển sang Form 2 (tùy chọn)
      const navButtons = document.querySelectorAll('.nav-btn[data-target="form2"]');
      navButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          // Có thể tự động load hoặc không
          // fetchForm2Data();
        });
      });

      // Xử lý filter cho Form 2
      const picFilter = document.getElementById('f2-filter-pic');
      const projectFilter = document.getElementById('f2-filter-project');
      const resetFilterBtn = document.getElementById('f2-reset-filter');
      
      if (picFilter) {
        picFilter.addEventListener('change', function() {
          if (F2_ORIGINAL_DATA && F2_ORIGINAL_DATA.length > 0) {
            renderForm2Table(F2_ORIGINAL_DATA);
          }
        });
      }
      
      if (projectFilter) {
        projectFilter.addEventListener('change', function() {
          if (F2_ORIGINAL_DATA && F2_ORIGINAL_DATA.length > 0) {
            renderForm2Table(F2_ORIGINAL_DATA);
          }
        });
      }
      
      if (resetFilterBtn) {
        resetFilterBtn.addEventListener('click', function() {
          if (picFilter) picFilter.value = '';
          if (projectFilter) projectFilter.value = '';
          if (F2_ORIGINAL_DATA && F2_ORIGINAL_DATA.length > 0) {
            renderForm2Table(F2_ORIGINAL_DATA);
          }
        });
      }

      // Nút xuất Excel
      const exportExcelBtn = document.getElementById('f2-export-excel');
      if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function() {
          exportF2ToExcel();
        });
      }

      // ===== FORM 2 - XỬ LÝ MODAL KHAI BÁO (SO SÁNH CE) =====
      
      // Biến lưu trữ file
      let F2_CE_ORIGINAL_FILE = null;
      let F2_CE_REVIEW_FILE = null;
      
      // Khởi tạo tất cả modal listeners
      initAllModalListeners();
      
      // Nút mở modal Khai báo
      const f2DeclarationBtn = document.getElementById('f2-declaration-btn');
      if (f2DeclarationBtn) {
        f2DeclarationBtn.addEventListener('click', function() {
          openF2DeclarationModal();
        });
      }
      
      // Xử lý upload file CE gốc
      const f2CeOriginalBtn = document.getElementById('f2-ce-original-btn');
      const f2CeOriginal = document.getElementById('f2-ce-original');
      const f2CeOriginalRemove = document.getElementById('f2-ce-original-remove');
      
      if (f2CeOriginalBtn && f2CeOriginal) {
        f2CeOriginalBtn.addEventListener('click', function() {
          f2CeOriginal.click();
        });
      }
      
      if (f2CeOriginal) {
        f2CeOriginal.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            F2_CE_ORIGINAL_FILE = file;
            document.getElementById('f2-ce-original-name').textContent = file.name;
            document.getElementById('f2-ce-original-name').className = 'text-sm text-green-600 flex-1 font-medium';
            if (f2CeOriginalRemove) f2CeOriginalRemove.classList.remove('hidden');
            showToast('Đã chọn file CE gốc: ' + file.name);
          }
        });
      }
      
      if (f2CeOriginalRemove) {
        f2CeOriginalRemove.addEventListener('click', function() {
          if (f2CeOriginal) f2CeOriginal.value = '';
          F2_CE_ORIGINAL_FILE = null;
          document.getElementById('f2-ce-original-name').textContent = 'Chưa chọn file';
          document.getElementById('f2-ce-original-name').className = 'text-sm text-gray-500 flex-1';
          this.classList.add('hidden');
        });
      }
      
      // Xử lý upload file CE sau rà soát
      const f2CeReviewBtn = document.getElementById('f2-ce-review-btn');
      const f2CeReview = document.getElementById('f2-ce-review');
      const f2CeReviewRemove = document.getElementById('f2-ce-review-remove');
      
      if (f2CeReviewBtn && f2CeReview) {
        f2CeReviewBtn.addEventListener('click', function() {
          f2CeReview.click();
        });
      }
      
      if (f2CeReview) {
        f2CeReview.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            F2_CE_REVIEW_FILE = file;
            document.getElementById('f2-ce-review-name').textContent = file.name;
            document.getElementById('f2-ce-review-name').className = 'text-sm text-green-600 flex-1 font-medium';
            if (f2CeReviewRemove) f2CeReviewRemove.classList.remove('hidden');
            showToast('Đã chọn file CE sau rà soát: ' + file.name);
          }
        });
      }
      
      if (f2CeReviewRemove) {
        f2CeReviewRemove.addEventListener('click', function() {
          if (f2CeReview) f2CeReview.value = '';
          F2_CE_REVIEW_FILE = null;
          document.getElementById('f2-ce-review-name').textContent = 'Chưa chọn file';
          document.getElementById('f2-ce-review-name').className = 'text-sm text-gray-500 flex-1';
          this.classList.add('hidden');
        });
      }
      
      // Gửi dữ liệu so sánh CE
      const f2DeclarationSubmitBtn = document.getElementById('modal-f2-declaration-submit');
      if (f2DeclarationSubmitBtn) {
        f2DeclarationSubmitBtn.addEventListener('click', async function() {
          await submitF2Declaration();
        });
      }
    });

    // ============================================
    // MODAL SYSTEM - CENTRALIZED MANAGEMENT
    // ============================================
    // 
    // HỆ THỐNG QUẢN LÝ MODAL TẬP TRUNG
    // 
    // Để thêm modal mới:
    // 
    // 1. ĐĂNG KÝ MODAL TRONG MODAL_REGISTRY:
    //    - Thêm entry với key duy nhất: 'form-purpose' (ví dụ: 'f3-upload', 'f4-edit')
    //    - Đặt ID theo format: modal-{form}-{purpose}
    //    - Cấu trúc HTML modal:
    //      <div id="modal-{form}-{purpose}" class="modal-container modal-{form}-{purpose} fixed inset-0 z-50 hidden">
    //        <div id="modal-{form}-{purpose}-overlay" class="modal-overlay modal-{form}-{purpose}-overlay fixed inset-0 bg-black/50"></div>
    //        <div id="modal-{form}-{purpose}-content" class="modal-content modal-{form}-{purpose}-content ...">
    //          <!-- Nội dung modal -->
    //          <button id="modal-{form}-{purpose}-close" class="modal-close">Đóng</button>
    //          <!-- Các button khác -->
    //        </div>
    //      </div>
    // 
    // 2. THÊM VÀO MODAL_REGISTRY:
    //    'f3-upload': {
    //      id: 'modal-f3-upload',
    //      overlayId: 'modal-f3-upload-overlay',
    //      contentId: 'modal-f3-upload-content',
    //      closeBtnIds: ['modal-f3-upload-close', 'modal-f3-upload-close-btn'],
    //      cancelBtnId: 'modal-f3-upload-cancel', // hoặc null
    //      submitBtnId: 'modal-f3-upload-submit', // hoặc null
    //      formId: 'modal-f3-upload-form', // hoặc null
    //      bodyId: 'modal-f3-upload-body' // hoặc null
    //    }
    // 
    // 3. TẠO HÀM MỞ MODAL:
    //    function openF3UploadModal() {
    //      openModal('f3-upload', (modal, config) => {
    //        // Callback để setup form/data trước khi mở
    //        // Ví dụ: reset form, load data, etc.
    //      });
    //    }
    // 
    // 4. TẠO HÀM ĐÓNG MODAL (tùy chọn):
    //    function closeF3UploadModal() {
    //      closeModal('f3-upload');
    //    }
    // 
    // 5. KHỞI TẠO LISTENERS (tự động qua initAllModalListeners()):
    //    - Close buttons sẽ tự động được gắn listener
    //    - Overlay click sẽ tự động đóng modal
    //    - ESC key sẽ tự động đóng modal đang mở
    // 
    // 6. SỬ DỤNG:
    //    - Mở modal: openModal('f3-upload') hoặc openF3UploadModal()
    //    - Đóng modal: closeModal('f3-upload') hoặc closeF3UploadModal()
    //    - Đóng tất cả: closeAllModals()
    // 
    // LƯU Ý:
    // - Tất cả modal sẽ tự động được đóng khi mở modal mới
    // - Modal sẽ tự động được di chuyển về body level nếu cần
    // - CSS classes: modal-container, modal-overlay, modal-content, modal-close, modal-close-btn, modal-cancel-btn, modal-submit-btn
    // - Namespace: mỗi modal có prefix riêng để tránh conflict (modal-{form}-{purpose})
    // 
    /**
     * Modal Registry - Đăng ký tất cả modal tại đây
     * Format: 'modal-{form}-{purpose}'
     */
    const MODAL_REGISTRY = {
      'f2-declaration': {
        id: 'modal-f2-declaration',
        overlayId: 'modal-f2-declaration-overlay',
        contentId: 'modal-f2-declaration-content',
        closeBtnIds: ['modal-f2-declaration-close', 'modal-f2-declaration-close-btn'],
        cancelBtnId: null,
        submitBtnId: 'modal-f2-declaration-submit',
        formId: null,
        bodyId: 'modal-f2-declaration-body'
      },
      'f5-add-subtask': {
        id: 'modal-f5-add-subtask',
        overlayId: 'modal-f5-add-subtask-overlay',
        contentId: 'modal-f5-add-subtask-content',
        closeBtnIds: ['modal-f5-add-subtask-close'],
        cancelBtnId: 'modal-f5-add-subtask-cancel',
        submitBtnId: 'modal-f5-add-subtask-submit-btn',
        formId: 'modal-f5-add-subtask-form',
        bodyId: null
      },
      'f5-select-declaration': {
        id: 'modal-f5-select-declaration',
        overlayId: 'modal-f5-select-declaration-overlay',
        contentId: 'modal-f5-select-declaration-content',
        closeBtnIds: ['modal-f5-select-declaration-close'],
        cancelBtnId: 'modal-f5-select-declaration-cancel',
        submitBtnId: null,
        formId: null,
        bodyId: null
      },
      'f5-import-excel': {
        id: 'modal-f5-import-excel',
        overlayId: 'modal-f5-import-excel-overlay',
        contentId: 'modal-f5-import-excel-content',
        closeBtnIds: ['modal-f5-import-excel-close'],
        cancelBtnId: 'modal-f5-import-excel-cancel',
        submitBtnId: 'modal-f5-import-excel-submit',
        formId: null,
        bodyId: null
      },
      'f5-declaration-review-file-nctn': {
        id: 'modal-f5-declaration-review-file-nctn',
        overlayId: 'modal-f5-declaration-review-file-nctn-overlay',
        contentId: 'modal-f5-declaration-review-file-nctn-content',
        closeBtnIds: ['modal-f5-declaration-review-file-nctn-close'],
        cancelBtnId: 'modal-f5-declaration-review-file-nctn-cancel',
        submitBtnId: 'modal-f5-declaration-review-file-nctn-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-review-file-nctn-body'
      },
      'f5-declaration-review-ce-qc': {
        id: 'modal-f5-declaration-review-ce-qc',
        overlayId: 'modal-f5-declaration-review-ce-qc-overlay',
        contentId: 'modal-f5-declaration-review-ce-qc-content',
        closeBtnIds: ['modal-f5-declaration-review-ce-qc-close'],
        cancelBtnId: 'modal-f5-declaration-review-ce-qc-cancel',
        submitBtnId: 'modal-f5-declaration-review-ce-qc-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-review-ce-qc-body'
      },
      'f5-declaration-train-qc': {
        id: 'modal-f5-declaration-train-qc',
        overlayId: 'modal-f5-declaration-train-qc-overlay',
        contentId: 'modal-f5-declaration-train-qc-content',
        closeBtnIds: ['modal-f5-declaration-train-qc-close'],
        cancelBtnId: 'modal-f5-declaration-train-qc-cancel',
        submitBtnId: 'modal-f5-declaration-train-qc-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-train-qc-body'
      },
      'f5-declaration-send-test-task': {
        id: 'modal-f5-declaration-send-test-task',
        overlayId: 'modal-f5-declaration-send-test-task-overlay',
        contentId: 'modal-f5-declaration-send-test-task-content',
        closeBtnIds: ['modal-f5-declaration-send-test-task-close'],
        cancelBtnId: 'modal-f5-declaration-send-test-task-cancel',
        submitBtnId: 'modal-f5-declaration-send-test-task-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-send-test-task-body'
      },
      'f5-declaration-review-4m': {
        id: 'modal-f5-declaration-review-4m',
        overlayId: 'modal-f5-declaration-review-4m-overlay',
        contentId: 'modal-f5-declaration-review-4m-content',
        closeBtnIds: ['modal-f5-declaration-review-4m-close'],
        cancelBtnId: 'modal-f5-declaration-review-4m-cancel',
        submitBtnId: 'modal-f5-declaration-review-4m-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-review-4m-body'
      },
      'f5-declaration-review-fmea': {
        id: 'modal-f5-declaration-review-fmea',
        overlayId: 'modal-f5-declaration-review-fmea-overlay',
        contentId: 'modal-f5-declaration-review-fmea-content',
        closeBtnIds: ['modal-f5-declaration-review-fmea-close'],
        cancelBtnId: 'modal-f5-declaration-review-fmea-cancel',
        submitBtnId: 'modal-f5-declaration-review-fmea-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-review-fmea-body'
      },
      'f4-select-component-standard': {
        id: 'modal-f4-select-component-standard',
        overlayId: 'modal-f4-select-component-standard-overlay',
        contentId: 'modal-f4-select-component-standard-content',
        closeBtnIds: ['modal-f4-select-component-standard-close'],
        cancelBtnId: 'modal-f4-select-component-standard-cancel',
        submitBtnId: null,
        formId: null,
        bodyId: 'modal-f4-select-component-standard-body'
      },
      'f5-view-detail': {
        id: 'modal-f5-view-detail',
        overlayId: 'modal-f5-view-detail-overlay',
        contentId: 'modal-f5-view-detail-content',
        closeBtnIds: ['modal-f5-view-detail-close', 'modal-f5-view-detail-close-btn'],
        cancelBtnId: null,
        submitBtnId: null,
        formId: null,
        bodyId: 'modal-f5-view-detail-body'
      }
    };
    
    /**
     * Hàm đóng tất cả modal
     */
    function closeAllModals() {
      Object.values(MODAL_REGISTRY).forEach(config => {
        const modal = document.getElementById(config.id);
        if (modal) {
          modal.classList.add('hidden');
          modal.style.display = 'none';
          modal.style.visibility = 'hidden';
          modal.style.opacity = '0';
          // Reset overflow của parent containers
          let parent = modal.parentElement;
          while (parent && parent !== document.body) {
            const computedStyle = window.getComputedStyle(parent);
            if (computedStyle.overflow === 'visible') {
              parent.style.removeProperty('overflow');
            }
            parent = parent.parentElement;
          }
        }
      });
      document.body.style.overflow = '';
    }
    
    /**
     * Hàm mở modal theo key
     * @param {string} modalKey - Key trong MODAL_REGISTRY (ví dụ: 'f2-declaration', 'f5-add-subtask')
     * @param {Function} beforeOpenCallback - Callback được gọi trước khi mở modal
     * @returns {boolean} - true nếu mở thành công
     */
    function openModal(modalKey, beforeOpenCallback = null) {
      const config = MODAL_REGISTRY[modalKey];
      if (!config) {
        console.error(`[Modal System] Modal key "${modalKey}" not found in registry`);
        return false;
      }
      
      // Đóng tất cả modal khác trước
      closeAllModals();
      
      const modal = document.getElementById(config.id);
      if (!modal) {
        console.error(`[Modal System] Modal element "${config.id}" not found`);
        return false;
      }
      
      // Đảm bảo modal nằm ở body level
      if (modal.parentElement && modal.parentElement !== document.body) {
        document.body.appendChild(modal);
        console.log(`[Modal System] Modal "${modalKey}" moved to body level`);
      }
      
      // Gọi callback trước khi mở
      if (beforeOpenCallback && typeof beforeOpenCallback === 'function') {
        beforeOpenCallback(modal, config);
      }
      
      // Hiển thị modal
      modal.classList.remove('hidden');
      modal.removeAttribute('class');
      modal.className = 'modal-container fixed inset-0 z-50';
      
      modal.style.cssText = `
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 99999 !important;
        margin: 0 !important;
        padding: 0 !important;
      `;
      
      document.body.style.overflow = 'hidden';
      
      // Đảm bảo overlay hiển thị
      const overlay = document.getElementById(config.overlayId);
      if (overlay) {
        overlay.style.cssText = `
          display: block !important;
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          bottom: 0 !important;
          z-index: 99998 !important;
          background-color: rgba(0, 0, 0, 0.3) !important;
          backdrop-filter: blur(4px) !important;
          margin: 0 !important;
          padding: 0 !important;
        `;
      }
      
      // Đảm bảo content container hiển thị đúng
      const contentContainer = document.getElementById(config.contentId);
      if (contentContainer) {
        contentContainer.style.cssText = `
          display: flex !important;
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          bottom: 0 !important;
          z-index: 99999 !important;
          pointer-events: none !important;
          align-items: center !important;
          justify-content: center !important;
          padding: 1rem !important;
          margin: 0 !important;
        `;
      }
      
      // Kiểm tra parent container có overflow-hidden không
      let parent = modal.parentElement;
      while (parent && parent !== document.body) {
        const computedStyle = window.getComputedStyle(parent);
        if (computedStyle.overflow === 'hidden' || computedStyle.overflowX === 'hidden' || computedStyle.overflowY === 'hidden') {
          console.warn(`[Modal System] Parent container has overflow-hidden for "${modalKey}":`, parent);
          parent.style.overflow = 'visible';
        }
        parent = parent.parentElement;
      }
      
      console.log(`[Modal System] Modal "${modalKey}" opened`);
      return true;
    }
    
    /**
     * Hàm đóng modal theo key
     * @param {string} modalKey - Key trong MODAL_REGISTRY
     * @returns {boolean} - true nếu đóng thành công
     */
    function closeModal(modalKey) {
      const config = MODAL_REGISTRY[modalKey];
      if (!config) {
        console.error(`[Modal System] Modal key "${modalKey}" not found in registry`);
        return false;
      }
      
      const modal = document.getElementById(config.id);
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        
        // Reset overflow của parent containers
        let parent = modal.parentElement;
        while (parent && parent !== document.body) {
          const computedStyle = window.getComputedStyle(parent);
          if (computedStyle.overflow === 'visible') {
            parent.style.removeProperty('overflow');
          }
          parent = parent.parentElement;
        }
        
        console.log(`[Modal System] Modal "${modalKey}" closed`);
        return true;
      }
      return false;
    }
    
    /**
     * Khởi tạo event listeners cho một modal
     * @param {string} modalKey - Key trong MODAL_REGISTRY
     */
    function initModalListeners(modalKey) {
      const config = MODAL_REGISTRY[modalKey];
      if (!config) {
        console.error(`[Modal System] Modal key "${modalKey}" not found in registry`);
        return;
      }
      
      const modal = document.getElementById(config.id);
      if (!modal) return;
      
      // Close buttons
      config.closeBtnIds.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn && !btn._modalListenerAttached) {
          btn._modalListenerAttached = true;
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal(modalKey);
          });
        }
      });
      
      // Cancel button
      if (config.cancelBtnId) {
        const cancelBtn = document.getElementById(config.cancelBtnId);
        if (cancelBtn && !cancelBtn._modalListenerAttached) {
          cancelBtn._modalListenerAttached = true;
          cancelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal(modalKey);
          });
        }
      }
      
      // Overlay click
      const overlay = document.getElementById(config.overlayId);
      if (overlay && !overlay._modalListenerAttached) {
        overlay._modalListenerAttached = true;
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeModal(modalKey);
          }
        });
      }
      
      // ESC key - sử dụng event delegation trên document
      if (!document._modalEscHandler) {
        document._modalEscHandler = function(e) {
          if (e.key === 'Escape') {
            // Đóng modal đang mở (modal không có class hidden)
            Object.keys(MODAL_REGISTRY).forEach(key => {
              const m = document.getElementById(MODAL_REGISTRY[key].id);
              if (m && !m.classList.contains('hidden')) {
                closeModal(key);
              }
            });
          }
        };
        document.addEventListener('keydown', document._modalEscHandler);
      }
      
      console.log(`[Modal System] Listeners initialized for "${modalKey}"`);
    }
    
    /**
     * Khởi tạo tất cả modal listeners
     */
    function initAllModalListeners() {
      Object.keys(MODAL_REGISTRY).forEach(key => {
        initModalListeners(key);
      });
      console.log(`[Modal System] All modal listeners initialized (${Object.keys(MODAL_REGISTRY).length} modals)`);
    }
    
    // ============================================
    // END MODAL SYSTEM - CENTRALIZED MANAGEMENT
    // ============================================

    // Hàm mở modal Khai báo Form 2 - Sử dụng hệ thống modal tập trung
    function openF2DeclarationModal() {
      // Sử dụng hệ thống modal tập trung
      const success = openModal('f2-declaration', (modal, config) => {
        // Callback trước khi mở modal - Reset form
      F2_CE_ORIGINAL_FILE = null;
      F2_CE_REVIEW_FILE = null;
      if (document.getElementById('f2-ce-original')) document.getElementById('f2-ce-original').value = '';
      if (document.getElementById('f2-ce-review')) document.getElementById('f2-ce-review').value = '';
      if (document.getElementById('f2-ce-original-name')) {
        document.getElementById('f2-ce-original-name').textContent = 'Chưa chọn file';
        document.getElementById('f2-ce-original-name').className = 'text-sm text-gray-500 flex-1';
      }
      if (document.getElementById('f2-ce-review-name')) {
        document.getElementById('f2-ce-review-name').textContent = 'Chưa chọn file';
        document.getElementById('f2-ce-review-name').className = 'text-sm text-gray-500 flex-1';
      }
      const removeBtns = document.querySelectorAll('#f2-ce-original-remove, #f2-ce-review-remove');
      removeBtns.forEach(btn => btn.classList.add('hidden'));
      
      // Ẩn kết quả
      const resultDiv = document.getElementById('f2-declaration-result');
      if (resultDiv) resultDiv.classList.add('hidden');
      });
      
      if (!success) {
        console.error('[Form 2] Failed to open modal');
      }
    }

    // Hàm đóng modal Khai báo Form 2 - Sử dụng hệ thống modal tập trung
    function closeF2DeclarationModal() {
      closeModal('f2-declaration');
    }

    // Hàm submit form so sánh CE Form 2
    async function submitF2Declaration() {
      // Lấy file trực tiếp từ input element thay vì dùng biến
      const f2CeOriginalInput = document.getElementById('f2-ce-original');
      const f2CeReviewInput = document.getElementById('f2-ce-review');
      
      // Kiểm tra dữ liệu bắt buộc
      if (!f2CeOriginalInput || !f2CeOriginalInput.files || !f2CeOriginalInput.files[0]) {
        showToast('Vui lòng chọn file CE gốc', 'error');
        return;
      }

      if (!f2CeReviewInput || !f2CeReviewInput.files || !f2CeReviewInput.files[0]) {
        showToast('Vui lòng chọn file CE sau rà soát', 'error');
        return;
      }

      const ceOriginalFile = f2CeOriginalInput.files[0];
      const ceReviewFile = f2CeReviewInput.files[0];

      // Chuẩn bị FormData để gửi
      const formData = new FormData();
      formData.append('ce_original', ceOriginalFile);
      formData.append('ce_review', ceReviewFile);

      // Log dữ liệu gửi đi
      console.log('[Form 2 Declaration] Sending data:', {
        ce_original_file: ceOriginalFile?.name || 'N/A',
        ce_review_file: ceReviewFile?.name || 'N/A',
        ce_original_size: ceOriginalFile?.size || 0,
        ce_review_size: ceReviewFile?.size || 0
      });

      // Disable button và hiển thị loading
      const submitBtn = document.getElementById('modal-f2-declaration-submit');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang gửi...';
      }

      const resultDiv = document.getElementById('f2-declaration-result');
      const resultContent = document.getElementById('f2-declaration-result-content');

      try {
        // Gửi dữ liệu lên webhook cho Form 2
        const serverUrl = 'https://iatzhxxuk.tino.page/webhook/2b3f8c7b-8485-4c42-a46f-fb4a6019bf6d';
        
        console.log('[Form 2 Declaration] Sending to:', serverUrl);
        
        const response = await fetch(serverUrl, {
          method: 'POST',
          body: formData,
        });

        console.log('[Form 2 Declaration] Response status:', response.status, response.statusText);

        // Đọc response text
        let responseText = '';
        try {
          responseText = await response.text();
          console.log('[Form 2 Declaration] Response text:', responseText);
        } catch (textError) {
          console.error('[Form 2 Declaration] Error reading response text:', textError);
          responseText = '';
        }

        // Parse JSON nếu có thể
        let result = null;
        if (responseText) {
          try {
            result = JSON.parse(responseText);
            console.log('[Form 2 Declaration] Parsed JSON:', result);
          } catch (parseError) {
            result = {
              success: response.ok,
              status: response.status,
              statusText: response.statusText,
              body: responseText,
              message: responseText || 'Không có nội dung response'
            };
          }
        } else {
          result = {
            success: response.ok,
            status: response.status,
            statusText: response.statusText,
            message: response.ok ? 'Gửi thành công (không có response body)' : `HTTP ${response.status}: ${response.statusText}`
          };
        }

        // Hiển thị kết quả
        if (resultDiv && resultContent) {
          resultDiv.classList.remove('hidden');
          resultContent.innerHTML = `
            <pre class="bg-white p-4 rounded border border-gray-300 text-xs overflow-auto max-h-60 whitespace-pre-wrap">${escapeHtml(JSON.stringify(result, null, 2))}</pre>
          `;
        }
        
        if (response.ok) {
          showToast('Đã gửi dữ liệu thành công');
        } else {
          showToast(`Gửi không thành công: HTTP ${response.status}`, 'error');
        }
      } catch (error) {
        console.error('[Form 2 Declaration] Error submitting:', error);
        if (resultDiv && resultContent) {
          resultDiv.classList.remove('hidden');
          resultContent.innerHTML = `
            <div class="text-red-600 p-4 rounded border border-red-300 bg-red-50">
              <p class="font-semibold">Lỗi:</p>
              <p>${escapeHtml(error.message)}</p>
            </div>
          `;
        }
        showToast('Lỗi khi gửi dữ liệu: ' + error.message, 'error');
      } finally {
        // Enable button lại
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Gửi lên server';
        }
      }
    }

    // ===== FORM 3 - UPLOAD EXCEL =====
    
    // Biến lưu trữ file
    let F3_EXCEL_FILE = null;

    // Hàm format ngày tháng
    function formatDateTime(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
      } catch (e) {
        return dateString;
      }
    }

    // Hàm format ngày (không có giờ)
    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${day}/${month}/${year}`;
      } catch (e) {
        return dateString;
      }
    }

    // Hàm render bảng thống kê Form 3
    function renderForm3StatisticsTable(data) {
      const tbody = document.getElementById('f3-statistics-body');
      if (!tbody) return;
      
      if (!data || !Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = '<tr><td class="px-3 py-4 text-center text-gray-500 border border-gray-300" colspan="17">Không có dữ liệu</td></tr>';
        return;
      }
      
      let html = '';
      data.forEach((row, index) => {
        // Lấy dữ liệu theo đúng tên field từ JSON mẫu
        const id = row.Id !== undefined && row.Id !== null ? row.Id : (row.id !== undefined ? row.id : '');
        const epic = row.Epic !== undefined && row.Epic !== null ? row.Epic : (row.epic !== undefined ? row.epic : '');
        const story = row.Story !== undefined && row.Story !== null ? row.Story : (row.story !== undefined ? row.story : '');
        const subTask = row['sub-task'] !== undefined && row['sub-task'] !== null ? row['sub-task'] : (row.sub_task !== undefined ? row.sub_task : (row.subtask !== undefined ? row.subtask : ''));
        const groupcode = row.groupcode !== undefined && row.groupcode !== null ? row.groupcode : (row.group_code !== undefined ? row.group_code : '');
        const tenNhanVien = row['Tên nhân viên'] !== undefined && row['Tên nhân viên'] !== null ? row['Tên nhân viên'] : (row.ten_nhan_vien !== undefined ? row.ten_nhan_vien : (row.name !== undefined ? row.name : ''));
        const jiraStartDate = row.jira_start_date !== undefined && row.jira_start_date !== null ? row.jira_start_date : (row.start_date !== undefined ? row.start_date : '');
        const jiraDueDate = row.jira_due_date !== undefined && row.jira_due_date !== null ? row.jira_due_date : (row.due_date !== undefined ? row.due_date : '');
        const jiraDoneDate = row.jira_done_date !== undefined && row.jira_done_date !== null ? row.jira_done_date : (row.done_date !== undefined ? row.done_date : '');
        const jiraStatus = row.jira_status !== undefined && row.jira_status !== null ? row.jira_status : (row.status !== undefined ? row.status : '');
        const category = row.category !== undefined && row.category !== null ? row.category : '';
        const jiraKey = row.jira_key !== undefined && row.jira_key !== null ? row.jira_key : (row.key !== undefined ? row.key : '');
        const jiraNote = row.jira_note !== undefined && row.jira_note !== null ? row.jira_note : (row.note !== undefined ? row.note : '');
        const monthKey = row.month_key !== undefined && row.month_key !== null ? row.month_key : (row.month !== undefined ? row.month : '');
        const text = row.Text !== undefined && row.Text !== null ? row.Text : (row.text !== undefined ? row.text : '');
        const createdAt = row.CreatedAt !== undefined && row.CreatedAt !== null ? row.CreatedAt : (row.created_at !== undefined ? row.created_at : '');
        const updatedAt = row.UpdatedAt !== undefined && row.UpdatedAt !== null ? row.UpdatedAt : (row.updated_at !== undefined ? row.updated_at : '');
        
        // Xác định màu badge cho trạng thái
        let statusBadgeClass = 'bg-gray-100 text-gray-700';
        const statusLower = String(jiraStatus).toLowerCase();
        if (statusLower.includes('hoàn thành') || statusLower.includes('done') || statusLower.includes('completed')) {
          statusBadgeClass = 'bg-green-100 text-green-700';
        } else if (statusLower.includes('đang làm') || statusLower.includes('in progress') || statusLower.includes('đang thực hiện')) {
          statusBadgeClass = 'bg-blue-100 text-blue-700';
        } else if (statusLower.includes('chưa bắt đầu') || statusLower.includes('not started') || statusLower.includes('to do')) {
          statusBadgeClass = 'bg-yellow-100 text-yellow-700';
        } else if (statusLower.includes('hủy') || statusLower.includes('cancel') || statusLower.includes('cancelled')) {
          statusBadgeClass = 'bg-red-100 text-red-700';
        }
        
        html += `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-4 border border-gray-300 text-center font-medium">${escapeHtml(String(id))}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(String(epic))}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(String(story))}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(String(subTask))}</td>
            <td class="px-3 py-4 border border-gray-300 font-mono text-xs">${escapeHtml(String(groupcode))}</td>
            <td class="px-3 py-4 border border-gray-300 font-medium">${escapeHtml(String(tenNhanVien))}</td>
            <td class="px-3 py-4 border border-gray-300 whitespace-nowrap">${formatDate(jiraStartDate)}</td>
            <td class="px-3 py-4 border border-gray-300 whitespace-nowrap">${formatDate(jiraDueDate)}</td>
            <td class="px-3 py-4 border border-gray-300 whitespace-nowrap">${formatDate(jiraDoneDate)}</td>
            <td class="px-3 py-4 border border-gray-300">
              <span class="px-2 py-1 rounded text-xs font-medium ${statusBadgeClass}">${escapeHtml(String(jiraStatus))}</span>
            </td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(String(category))}</td>
            <td class="px-3 py-4 border border-gray-300 font-mono text-xs">${escapeHtml(String(jiraKey))}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(String(jiraNote))}</td>
            <td class="px-3 py-4 border border-gray-300 whitespace-nowrap">${formatDate(monthKey)}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(String(text))}</td>
            <td class="px-3 py-4 border border-gray-300 text-xs whitespace-nowrap">${formatDateTime(createdAt)}</td>
            <td class="px-3 py-4 border border-gray-300 text-xs whitespace-nowrap">${formatDateTime(updatedAt)}</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }

    // Hàm fetch dữ liệu thống kê từ webhook cho Form 3
    async function fetchForm3Statistics() {
      const loadBtn = document.getElementById('f3-load-statistics-btn');
      const loadingDiv = document.getElementById('f3-statistics-loading');
      const tbody = document.getElementById('f3-statistics-body');
      
      const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/8e092ef5-f201-490b-a17c-c360d7cc74f4';
      
      try {
        // Hiển thị loading
        if (loadBtn) loadBtn.disabled = true;
        if (loadingDiv) loadingDiv.classList.remove('hidden');
        if (tbody) {
          tbody.innerHTML = '<tr><td class="px-3 py-4 text-center text-gray-500 border border-gray-300" colspan="17">Đang tải dữ liệu...</td></tr>';
        }
        
        console.log('[Form 3 Statistics] Fetching data from:', webhookUrl);
        
        const response = await fetch(webhookUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        
        console.log('[Form 3 Statistics] Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseText = await response.text();
        console.log('[Form 3 Statistics] Response text:', responseText);
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          console.error('[Form 3 Statistics] JSON parse error:', e);
          throw new Error('Response is not valid JSON');
        }
        
        console.log('[Form 3 Statistics] Parsed data:', data);
        
        // Xử lý dữ liệu trả về - có thể là array trực tiếp hoặc object chứa array
        let tableData = [];
        if (Array.isArray(data)) {
          tableData = data;
        } else if (data && Array.isArray(data.data)) {
          tableData = data.data;
        } else if (data && Array.isArray(data.results)) {
          tableData = data.results;
        } else if (data && Array.isArray(data.items)) {
          tableData = data.items;
        } else if (data && typeof data === 'object') {
          // Nếu là object đơn, thử chuyển thành array 1 phần tử
          tableData = [data];
        }
        
        console.log('[Form 3 Statistics] Table data:', tableData);
        
        // Render dữ liệu vào bảng
        renderForm3StatisticsTable(tableData);
        
        // Thông báo thành công
        showToast(`Đã tải ${tableData.length} bản ghi thống kê`, 'success');
        
      } catch (error) {
        console.error('[Form 3 Statistics] Error fetching data:', error);
        if (tbody) {
          tbody.innerHTML = `<tr><td class="px-3 py-4 text-center text-red-500 border border-gray-300" colspan="17">Lỗi: ${escapeHtml(error.message)}</td></tr>`;
        }
        showToast('Lỗi khi tải dữ liệu thống kê: ' + error.message, 'error');
      } finally {
        // Ẩn loading
        if (loadBtn) loadBtn.disabled = false;
        if (loadingDiv) loadingDiv.classList.add('hidden');
      }
    }

    // Xử lý upload file Excel
    document.addEventListener('DOMContentLoaded', function() {
      const f3ExcelFileBtn = document.getElementById('f3-excel-file-btn');
      const f3ExcelFile = document.getElementById('f3-excel-file');
      const f3ExcelFileRemove = document.getElementById('f3-excel-file-remove');
      const f3SubmitBtn = document.getElementById('f3-submit-btn');
      const f3CopyResultBtn = document.getElementById('f3-copy-result');
      const f3LoadStatisticsBtn = document.getElementById('f3-load-statistics-btn');

      // Nút chọn file
      if (f3ExcelFileBtn && f3ExcelFile) {
        f3ExcelFileBtn.addEventListener('click', function() {
          f3ExcelFile.click();
        });
      }

      // Xử lý khi chọn file
      if (f3ExcelFile) {
        f3ExcelFile.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            // Kiểm tra định dạng file
            const validExtensions = ['.xlsx', '.xls'];
            const fileName = file.name.toLowerCase();
            const isValidFile = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!isValidFile) {
              showToast('Vui lòng chọn file Excel (.xlsx hoặc .xls)', 'error');
              this.value = '';
              return;
            }

            F3_EXCEL_FILE = file;
            document.getElementById('f3-excel-file-name').textContent = file.name;
            document.getElementById('f3-excel-file-name').className = 'text-sm text-green-600 flex-1 font-medium';
            if (f3ExcelFileRemove) f3ExcelFileRemove.classList.remove('hidden');
            showToast('Đã chọn file: ' + file.name);
          }
        });
      }

      // Xóa file
      if (f3ExcelFileRemove) {
        f3ExcelFileRemove.addEventListener('click', function() {
          if (f3ExcelFile) f3ExcelFile.value = '';
          F3_EXCEL_FILE = null;
          document.getElementById('f3-excel-file-name').textContent = 'Chưa chọn file';
          document.getElementById('f3-excel-file-name').className = 'text-sm text-gray-500 flex-1';
          this.classList.add('hidden');
        });
      }

      // Nút submit
      if (f3SubmitBtn) {
        f3SubmitBtn.addEventListener('click', async function() {
          await submitForm3();
        });
      }

      // Nút copy kết quả
      if (f3CopyResultBtn) {
        f3CopyResultBtn.addEventListener('click', function() {
          const resultContent = document.getElementById('f3-result-content');
          if (resultContent && resultContent.textContent && resultContent.textContent !== 'Chưa có kết quả') {
            navigator.clipboard.writeText(resultContent.textContent).then(() => {
              showToast('Đã copy kết quả vào clipboard');
            }).catch(err => {
              console.error('Error copying to clipboard:', err);
              showToast('Lỗi khi copy kết quả', 'error');
            });
          } else {
            showToast('Không có dữ liệu để copy', 'error');
          }
        });
      }

      // Nút tải dữ liệu thống kê
      if (f3LoadStatisticsBtn) {
        f3LoadStatisticsBtn.addEventListener('click', function() {
          fetchForm3Statistics();
        });
      }
    });

    // Hàm submit Form 3
    async function submitForm3() {
      // Kiểm tra file
      if (!F3_EXCEL_FILE) {
        showToast('Vui lòng chọn file Excel', 'error');
        return;
      }

      // Chuẩn bị FormData để gửi
      const formData = new FormData();
      formData.append('file', F3_EXCEL_FILE);

      // Log dữ liệu gửi đi
      console.log('[Form 3] Sending data:', {
        file_name: F3_EXCEL_FILE?.name || 'N/A',
        file_size: F3_EXCEL_FILE?.size || 0,
        file_type: F3_EXCEL_FILE?.type || 'N/A'
      });

      // Disable button và hiển thị loading
      const submitBtn = document.getElementById('f3-submit-btn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Đang tải lên...';
      }

      const resultDiv = document.getElementById('f3-result');
      const resultContent = document.getElementById('f3-result-content');

      try {
        // Gửi dữ liệu lên webhook
        const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/70bdcfa3-d7bf-4dc5-942c-5c9adcb37b7b';
        
        console.log('[Form 3] Sending to:', webhookUrl);
        
        const response = await fetch(webhookUrl, {
          method: 'POST',
          body: formData,
          // Không set Content-Type header, browser sẽ tự set với boundary cho FormData
        });

        console.log('[Form 3] Response status:', response.status, response.statusText);
        console.log('[Form 3] Response headers:', Object.fromEntries(response.headers.entries()));

        // Đọc response text trước (có thể là JSON hoặc text)
        let responseText = '';
        try {
          responseText = await response.text();
          console.log('[Form 3] Response text:', responseText);
        } catch (textError) {
          console.error('[Form 3] Error reading response text:', textError);
          responseText = '';
        }

        // Parse JSON nếu có thể
        let result = null;
        if (responseText) {
          try {
            result = JSON.parse(responseText);
            console.log('[Form 3] Parsed JSON:', result);
          } catch (parseError) {
            // Nếu không parse được JSON, giữ nguyên text
            console.log('[Form 3] Response is not JSON, keeping as text');
            result = {
              success: response.ok,
              status: response.status,
              statusText: response.statusText,
              body: responseText,
              message: responseText || 'Không có nội dung response'
            };
          }
        } else {
          result = {
            success: response.ok,
            status: response.status,
            statusText: response.statusText,
            message: response.ok ? 'Tải lên thành công (không có response body)' : `HTTP ${response.status}: ${response.statusText}`
          };
        }

        // Hiển thị kết quả
        if (resultDiv && resultContent) {
          resultDiv.classList.remove('hidden');
          const formattedResult = typeof result === 'object' ? JSON.stringify(result, null, 2) : result;
          resultContent.textContent = formattedResult;
          resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        if (response.ok) {
          showToast('Đã tải file lên thành công');
        } else {
          showToast(`Tải lên không thành công: HTTP ${response.status}`, 'error');
        }
      } catch (error) {
        console.error('[Form 3] Error uploading:', error);
        console.error('[Form 3] Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        showToast('Lỗi khi tải file lên: ' + error.message, 'error');
        
        // Hiển thị lỗi
        if (resultDiv && resultContent) {
          resultDiv.classList.remove('hidden');
          const errorResult = {
            error: true,
            name: error.name || 'Unknown Error',
            message: error.message || 'Có lỗi xảy ra',
            timestamp: new Date().toISOString(),
            details: error.stack || 'Không có chi tiết'
          };
          resultContent.textContent = JSON.stringify(errorResult, null, 2);
          resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      } finally {
        // Enable button lại
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Tải lên server';
        }
      }
    }

    // ===== FORM 4 - PHIẾU NHẬP TÁC VỤ =====
    
    // Endpoints
    const F4_FORM_SUBMIT_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/form4-submit";
    const F4_FILE_UPLOAD_ENDPOINT = F4_FORM_SUBMIT_ENDPOINT;
    
    // NocoDB endpoints (cần cập nhật theo URL thực tế)
    const NOCODB_API_BASE = "https://your-nocodb-instance.com/api/v1/db/data/noco"; // TODO: Cập nhật URL thực tế
    const NOCODB_PROJECTS_TABLE = "dqa_projects";
    const NOCODB_TASKS_TABLE = "dqa_tasks";
    
    // ============================================
    // HELPER FUNCTIONS - FORMAT DATA THEO SCHEMA NOCODB
    // ============================================
    
    /**
     * Format dữ liệu Form 4 thành format NocoDB dqa_tasks (type="form5_task")
     * @param {Object} formData - Dữ liệu từ Form 4
     * @param {string} projectCode - Mã dự án (có thể null)
     * @returns {Object} - Object theo schema NocoDB
     */
    function formatForm4ToNocoDBTask(formData, projectCode = null) {
      const normalizedRequestDate = (formData.requestDate || '').toString().slice(0,16).replace('T', ' ');
      const normalizedDesiredDate = (formData.desiredCompletionDate || '').toString().slice(0,10);
      const componentStd = Number(formData.componentStandard || 0) || 0;
      const componentStdStr = String(componentStd).replace('.', ',');
      
      // Tạo TaskCode từ requestCode hoặc generate mới
      const taskCode = formData.requestCode || `QA.SPM.${new Date().toISOString().slice(5,7)}${new Date().toISOString().slice(8,10)}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
      
      // Backup đầy đủ Form 4 data dưới dạng JSON
      const form4DataBackup = {
        requesterName: formData.senderName || '',
        email: formData.senderEmail || '',
        requestDate: normalizedRequestDate,
        requestCode: formData.requestCode || '',
        deptRequest: formData.department || '',
        itemName: formData.productName || '',
        itemCode: formData.productCode || '',
        componentType: formData.componentType || '',
        componentStandard: componentStdStr,
        purpose: formData.requestPurpose || '',
        projectCode: projectCode || '',
        vendor: formData.supplier || '',
        qtySamples: formData.numSamples || '',
        desiredDate: normalizedDesiredDate,
        changeReq: formData.notes || '',
        appliedModel: formData.appliedModel || '',
        attachments: formData.attachments || ''
      };
      
      return {
        type: "form5_task",
        project_code: projectCode || null,
        parent_id: null, // Task luôn có parent_id = null
        
        // Nhóm TaskRequest* (Form 4)
        TaskRequestCode: formData.requestCode || taskCode,
        TaskRequesterName: String(formData.senderName || '').trim(),
        TaskRequesterEmail: String(formData.senderEmail || '').trim(),
        TaskRequestDate: normalizedRequestDate,
        TaskDeptRequest: String(formData.department || '').trim(),
        TaskItemName: String(formData.productName || '').trim(),
        TaskItemCode: String(formData.productCode || '').trim(),
        TaskComponentType: String(formData.componentType || '').trim(),
        TaskComponentStandard: componentStd,
        TaskPurpose: String(formData.requestPurpose || '').trim(),
        TaskVendor: String(formData.supplier || '').trim(),
        TaskQtySamples: Number(formData.numSamples || 0) || 0,
        TaskDesiredDate: normalizedDesiredDate,
        TaskPersonReceived: String(formData.personReceived || '').trim(),
        TaskNotes: String(formData.notes || '').trim(),
        TaskChangeFromLastNote: '', // Đã xóa khỏi UI, để rỗng
        TaskSampleSubmissionNo: 1, // Mặc định 1
        TaskAltCode: '', // Đã xóa khỏi UI, để rỗng
        TaskAppliedModel: String(formData.appliedModel || '').trim(),
        TaskAttachments: String(formData.attachments || '').trim(),
        
        // Nhóm Task* (Form 5)
        TaskCode: taskCode,
        TaskName: String(formData.productName || 'Tác vụ mới').trim(),
        TaskDescription: `Yêu cầu đánh giá ${formData.productName || ''}${formData.productCode ? ` (Mã: ${formData.productCode})` : ''}${formData.supplier ? ` từ nhà cung cấp ${formData.supplier}` : ''}. ${formData.notes || ''}`,
        TaskPIC: String(formData.pic || formData.personReceived || '').trim(),
        TaskDepartment: String(formData.department || '').trim(),
        TaskCreatedAt: normalizedRequestDate.split(' ')[0],
        TaskDueDate: normalizedDesiredDate,
        TaskStatus: "pending",
        TaskPriority: "Trung bình",
        TaskForm4Data: JSON.stringify(form4DataBackup),
        Subtaskno: 0 // Task chính có Subtaskno = 0
      };
    }
    
    /**
     * Gửi Task lên NocoDB
     * @param {Object} taskData - Dữ liệu task đã format theo schema NocoDB
     * @returns {Promise<Object>} - Response từ NocoDB API
     */
    async function submitTaskToNocoDB(taskData) {
      // TODO: Cập nhật endpoint NocoDB thực tế
      const endpoint = `${NOCODB_API_BASE}/${NOCODB_TASKS_TABLE}`;
      
      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // TODO: Thêm authentication headers nếu cần
            // 'xc-token': 'your-nocodb-token'
          },
          body: JSON.stringify(taskData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[NocoDB] Task created:', result);
        return result;
      } catch (error) {
        console.error('[NocoDB] Error creating task:', error);
        throw error;
      }
    }
    
    /**
     * Format dữ liệu Subtask thành format NocoDB dqa_tasks (type="form5_subtask" hoặc "form5_subtask_<declarationMode>")
     * @param {Object} subtaskData - Dữ liệu subtask (cần có declarationMode để ghép vào Type)
     * @param {number} parentTaskId - ID của Task cha trong dqa_tasks
     * @param {string} projectCode - Mã dự án (copy từ Task cha)
     * @returns {Object} - Object theo schema NocoDB
     */
    /**
     * Format datetime từ datetime-local input (YYYY-MM-DDTHH:mm) sang YYYY-MM-DD HH:mm
     * @param {string} datetimeLocal - Giá trị từ input datetime-local (YYYY-MM-DDTHH:mm)
     * @returns {string|null} - Định dạng YYYY-MM-DD HH:mm hoặc null
     */
    function formatDateTimeForWebhook(datetimeLocal) {
      if (!datetimeLocal) return null;
      // Chuyển từ YYYY-MM-DDTHH:mm sang YYYY-MM-DD HH:mm
      return datetimeLocal.replace('T', ' ');
    }
    
    function formatSubtaskToNocoDB(subtaskData, parentTaskId, projectCode = null) {
      // Lấy chế độ khai báo và ghép vào Type
      const declarationMode = String(subtaskData.declarationMode || '').trim();
      const typeValue = declarationMode 
        ? `form5_subtask_${declarationMode}` 
        : "form5_subtask";
      
      // Format thời gian gửi về dạng YYYY-MM-DD HH:mm
      const formattedTimesend = formatDateTimeForWebhook(subtaskData.timesend);
      
      return {
        type: typeValue,
        project_code: projectCode || null,
        parent_id: parentTaskId, // ID của Task cha
        
        // Nhóm Subtask*
        SubtaskName: String(subtaskData.name || '').trim(),
        SubtaskPIC: String(subtaskData.pic || '').trim(),
        Subtaskmanhour: subtaskData.manhour ? Number(subtaskData.manhour) : null,
        SubtaskStatus: String(subtaskData.status || 'Leader review').trim(), // Mặc định Leader review
        Subtaskchecklist: String(subtaskData.checklist || '').trim(), // Tên file checklist
        Subtaskformlink: String(subtaskData.formLink || subtaskData.resultLink || '').trim() || null, // Link file checklist từ server hoặc link kết quả
        Subtasktimesend: formattedTimesend,
        Subtaskfinishtime: subtaskData.finishTime || null,
        Subtasknote: String(subtaskData.note || '').trim(),
        SubtaskPriority: String(subtaskData.priority || 'Trung bình').trim(),
        SubtaskDeclarationMode: String(subtaskData.declarationMode || '').trim(),
        Subtaskno: subtaskData.subtaskNo ? Number(subtaskData.subtaskNo) : null,
        Subtaskitemcode: String(subtaskData.itemCode || '').trim(), // Mã linh kiện/sản phẩm
        TaskCode: String(subtaskData.taskCode || '').trim() || null // Mã tác vụ QA.NB.DDMM-xxxxxx
      };
    }
    
    /**
     * Format dữ liệu Declaration thành format NocoDB dqa_tasks (type="form5_declaration")
     * @param {Object} declarationData - Dữ liệu declaration
     * @param {number} parentSubtaskId - ID của Subtask cha trong dqa_tasks
     * @param {string} declarationMode - Chế độ khai báo (phải trùng với SubtaskDeclarationMode)
     * @param {string} projectCode - Mã dự án (copy từ Task cha)
     * @returns {Object} - Object theo schema NocoDB
     */
    function formatDeclarationToNocoDB(declarationData, parentSubtaskId, declarationMode, projectCode = null) {
      return {
        type: "form5_declaration",
        project_code: projectCode || null,
        parent_id: parentSubtaskId, // ID của Subtask cha
        
        // Nhóm Declaration*
        DeclarationMode: String(declarationMode || '').trim(),
        DeclarationData: typeof declarationData === 'string' ? declarationData : JSON.stringify(declarationData)
      };
    }
    
    /**
     * Gửi Declaration lên NocoDB
     * @param {Object} declarationData - Dữ liệu declaration đã format theo schema NocoDB
     * @returns {Promise<Object>} - Response từ NocoDB API
     */
    async function submitDeclarationToNocoDB(declarationData) {
      // TODO: Cập nhật endpoint NocoDB thực tế
      const endpoint = `${NOCODB_API_BASE}/${NOCODB_TASKS_TABLE}`;
      
      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // TODO: Thêm authentication headers nếu cần
            // 'xc-token': 'your-nocodb-token'
          },
          body: JSON.stringify(declarationData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[NocoDB] Declaration created:', result);
        return result;
      } catch (error) {
        console.error('[NocoDB] Error creating declaration:', error);
        throw error;
      }
    }

    let f4Initialized = false;

    // Component items data (từ file gốc - Phiếu nhập tác vụ.html)
    const F4_COMPONENT_ITEMS = [
      { name: 'Băng dính xốp', std: 7.7 },
      { name: 'Bình áp', std: 12.5 },
      { name: 'Bình nóng', std: 16.7 },
      { name: 'Block', std: 19.7 },
      { name: 'Bộ cốc Hydrogen', std: 14.5 },
      { name: 'Bộ dây điện', std: 15.9 },
      { name: 'Bộ điện phân Alkaline', std: 12.1 },
      { name: 'Bộ kính viền nhôm', std: 12.5 },
      { name: 'Bơm áp', std: 15.7 },
      { name: 'Bông', std: 3.7 },
      { name: 'Công tắc', std: 8.9 },
      { name: 'Cút', std: 9.1 },
      { name: 'Dàn lạnh', std: 13.7 },
      { name: 'Dàn tản nhiệt', std: 18.0 },
      { name: 'Dây điện', std: 12.4 },
      { name: 'Dây RO 1/4', std: 16.2 },
      { name: 'Dây RO 3/8', std: 15.2 },
      { name: 'Dây silicone', std: 8.1 },
      { name: 'Dây TDS', std: 14.6 },
      { name: 'Đồng sunfat', std: 0.8 },
      { name: 'Flow', std: 11.0 },
      { name: 'Gioăng chỉ', std: 3.9 },
      { name: 'Hạt CaCO3', std: 12.4 },
      { name: 'Hạt Cation', std: 4.2 },
      { name: 'Hạt Corosex', std: 10.4 },
      { name: 'Hạt hồng ngoại', std: 9.1 },
      { name: 'Hạt ORP', std: 6.6 },
      { name: 'Khóa vòi nhựa', std: 8.5 },
      { name: 'Lõi 6HP', std: 15.7 },
      { name: 'Lõi Alkaline', std: 11.7 },
      { name: 'Lõi hồng ngoại', std: 13.0 },
      { name: 'Lõi hydrogen EZ270', std: 12.3 },
      { name: 'Lõi khoáng', std: 11.8 },
      { name: 'Lõi khoáng EZ', std: 13.0 },
      { name: 'Lõi lọc số 1', std: 7.3 },
      { name: 'Lõi lọc số 2', std: 7.9 },
      { name: 'Lõi lọc số 3', std: 8.2 },
      { name: 'Lõi OCB', std: 13.5 },
      { name: 'Lõi Post Carbon', std: 22.3 },
      { name: 'Lõi PP', std: 7.1 },
      { name: 'Lõi T33', std: 12.1 },
      { name: 'Lõi than nano', std: 12.1 },
      { name: 'Màng cao su', std: 10.0 },
      { name: 'Màng RO', std: 12.0 },
      { name: 'Màng RO EZ', std: 14.7 },
      { name: 'Mỡ', std: 6.5 },
      { name: 'Mực In', std: 10.5 },
      { name: 'Nắp cốc', std: 4.8 },
      { name: 'Nguồn xung', std: 12.3 },
      { name: 'Phao điện từ', std: 10.5 },
      { name: 'Phin lọc', std: 10.2 },
      { name: 'Phôi lõi PP', std: 7.3 },
      { name: 'Rơ le nhiệt lạnh', std: 19.55 },
      { name: 'Tem', std: 6.2 },
      { name: 'Thân cốc', std: 6.5 },
      { name: 'Than hoạt tính', std: 17.9 },
      { name: 'Thân vỏ màng', std: 6.5 },
      { name: 'Thùng sóng AB', std: 10.1 },
      { name: 'Thùng sóng BC', std: 10.1 },
      { name: 'Thùng sóng C', std: 10.1 },
      { name: 'Tôi kính', std: 9.6 },
      { name: 'Túi PE', std: 3.2 },
      { name: 'Van 1 chiều', std: 13.6 },
      { name: 'Van 4 cửa', std: 15.1 },
      { name: 'Van áp cao', std: 16 },
      { name: 'Van áp thấp', std: 15.7 },
      { name: 'Van điện từ', std: 16.9 },
      { name: 'Van khóa', std: 12.4 },
      { name: 'Van xả bình áp', std: 17.4 },
      { name: 'Viền nhôm kính', std: 9 },
      { name: 'Vòi gạt', std: 12.5 },
      { name: 'Vòi HCV', std: 8.7 },
      { name: 'Xốp', std: 2.5 },
      { name: 'Xốp bảo ôn', std: 2.0 },
      { name: 'Mạch', std: 24.0 },
      { name: 'Máy lọc nước', std: 32.0 },
      { name: 'Máy lọc nước (Chỉ rung lắc)', std: 6.0 },
      { name: 'Máy lọc nước (Base/rà soát tài liệu)', std: 2.0 },
      { name: 'Máy lọc nước (Base/xúc tiến hoàn thiện)', std: 10.0 },
      { name: 'Công chuẩn 1 ngày', std: 8.0 },
      { name: 'Công chuẩn 2 ngày', std: 16.0 },
      { name: 'Công chuẩn 3 ngày', std: 24.0 },
      { name: 'Công chuẩn 4 ngày', std: 32.0 },
      { name: 'Công chuẩn 5 ngày', std: 40.0 }
    ];

    function initForm4() {
      if (f4Initialized) return;
      f4Initialized = true;
      // Set default date
      const now = new Date();
      const tzOffsetMs = now.getTimezoneOffset() * 60000;
      const localISO = new Date(now.getTime() - tzOffsetMs).toISOString().slice(0, 16);
      const dateInput = document.getElementById('f4-testRequestDate');
      if (dateInput) dateInput.value = localISO;

      // Generate request code
      setF4RequestCode();

      // Setup component type
      setupF4ComponentType();

      // Setup purpose change handler
      setupF4PurposeHandler();

      // Setup sample submission number
      // Setup desired date field
      setupF4DesiredDateField();

      // Setup sender autocomplete
      setupF4SenderAutocomplete();

      // Setup file upload
      setupF4FileUpload();

      // Setup form submit
      setupF4FormSubmit();
      
      // Setup component standard modal
      setupF4ComponentStandardModal();
    }

    function setF4RequestCode() {
      const el = document.getElementById('f4-requestCode');
      if (!el) return;
      const now = new Date();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const mmdd = `${mm}${dd}`; // MMDD: tháng và ngày
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let rnd = '';
      for (let i=0;i<6;i++) rnd += alphabet[Math.floor(Math.random()*alphabet.length)];
      el.value = `QA.SPM.${mmdd}-${rnd}`;
    }

    // Hàm mở modal chọn công chuẩn tham khảo
    function openF4SelectComponentStandardModal() {
      const success = openModal('f4-select-component-standard', (modal, config) => {
        // Render danh sách công chuẩn từ F4_COMPONENT_ITEMS
        renderF4ComponentStandardList();
      });
      
      if (!success) {
        console.error('[Form 4] Failed to open select component standard modal');
      }
    }
    
    // Hàm render danh sách công chuẩn
    function renderF4ComponentStandardList(filterText = '') {
      const listContainer = document.getElementById('modal-f4-select-component-standard-list');
      if (!listContainer) return;
      
      // Lọc danh sách theo filterText
      const filteredItems = F4_COMPONENT_ITEMS.filter(item => {
        if (!filterText) return true;
        const searchText = filterText.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
        const itemName = item.name.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
        return itemName.includes(searchText);
      });
      
      // Render danh sách
      listContainer.innerHTML = filteredItems.map(item => `
        <button type="button" class="f4-component-standard-item flex flex-col items-start gap-2 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group text-left" data-name="${item.name}" data-std="${item.std}">
          <div class="flex items-center justify-between w-full">
            <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">${item.name}</h3>
            <span class="text-sm font-medium text-primary-blue bg-blue-100 px-2 py-1 rounded">${item.std} giờ</span>
          </div>
          <p class="text-xs text-gray-500">Công chuẩn: ${item.std} giờ</p>
        </button>
      `).join('');
      
      // Gắn event listener cho các item
      listContainer.querySelectorAll('.f4-component-standard-item').forEach(btn => {
        btn.addEventListener('click', function() {
          const name = this.getAttribute('data-name');
          const std = this.getAttribute('data-std');
          handleF4ComponentStandardSelect(name, std);
        });
      });
    }
    
    // Hàm xử lý khi chọn công chuẩn
    function handleF4ComponentStandardSelect(name, std) {
      const hiddenStd = document.getElementById('f4-componentStandard');
      const note = document.getElementById('f4-componentStandardNote');
      
      // Cập nhật giá trị công chuẩn
      if (hiddenStd) {
        hiddenStd.value = std || '0';
      }
      
      // Hiển thị thông báo đã chọn
      if (note) {
        note.classList.remove('hidden');
        note.textContent = `Đã chọn công chuẩn tham khảo: ${name} (${std} giờ)`;
      }
      
      console.log('[Form 4] Selected component standard:', name, 'std:', std);
      
      // Đóng modal
      closeModal('f4-select-component-standard');
      
      showToast(`Đã chọn công chuẩn: ${name}`, 'success');
    }
    
    // Hàm setup modal chọn công chuẩn
    function setupF4ComponentStandardModal() {
      // Khởi tạo modal listeners
      initModalListeners('f4-select-component-standard');
      
      // Event listener cho nút mở modal
      const componentModalBtn = document.getElementById('f4-componentModalBtn');
      if (componentModalBtn && !componentModalBtn._f4ListenerAttached) {
        componentModalBtn._f4ListenerAttached = true;
        componentModalBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openF4SelectComponentStandardModal();
        });
      }
      
      // Event listener cho search box
      const searchInput = document.getElementById('modal-f4-select-component-standard-search');
      if (searchInput && !searchInput._f4ListenerAttached) {
        searchInput._f4ListenerAttached = true;
        searchInput.addEventListener('input', function(e) {
          const filterText = e.target.value.trim();
          renderF4ComponentStandardList(filterText);
        });
      }
    }

    function setupF4ComponentType() {
      const hiddenStd = document.getElementById('f4-componentStandard');
      const note = document.getElementById('f4-componentStandardNote');
      if (!hiddenStd) return;

      const f4ComponentTableBody = document.getElementById('f4-componentTableBody');
      const f4ComponentSearch = document.getElementById('f4-componentSearch');

      function normalize(s) {
        return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
      }

      if (f4ComponentSearch && !f4ComponentSearch._f4ListenerAttached) {
        f4ComponentSearch._f4ListenerAttached = true;
        f4ComponentSearch.addEventListener('input', (e) => {
          renderF4ComponentTable(e.target.value);
        });
      }

      function renderF4ComponentTable(filter) {
        if (!f4ComponentTableBody) {
          console.error('[Form4] Table body element not found!');
          return;
        }
        const n = normalize(filter);
        const rows = F4_COMPONENT_ITEMS
          .filter(i => i.name !== 'Linh kiện khác' && (!n || normalize(i.name).includes(n)))
          .sort((a,b)=> a.name.localeCompare(b.name));
        
        console.log('[Form4] Rendering', rows.length, 'component items');
        
        if (!rows.length) {
          f4ComponentTableBody.innerHTML = '<tr><td colspan="2" class="px-4 py-3 text-gray-500">Không có dữ liệu</td></tr>';
          return;
        }
        f4ComponentTableBody.innerHTML = rows.map(i=>`<tr class="hover:bg-blue-50 cursor-pointer">
          <td class="px-4 py-2">${i.name}</td>
          <td class="px-4 py-2">${i.std}</td>
        </tr>`).join('');
        
        // Handle row click - sử dụng event delegation để tránh gắn listener nhiều lần
        f4ComponentTableBody.onclick = (e) => {
          const tr = e.target.closest('tr');
          if (!tr || tr.children.length < 2) return;
          const name = tr.children[0]?.textContent?.trim() || '';
          const std = tr.children[1]?.textContent?.trim() || '';
          if (name && std) {
            // Chỉ cập nhật công chuẩn tham khảo
            if (hiddenStd) {
              hiddenStd.value = std || '0';
            }
            // Cập nhật note để hiển thị thông tin đã chọn
            if (note) {
              note.classList.remove('hidden');
              note.textContent = `Đã chọn công chuẩn tham khảo: ${name} (${std} giờ)`;
            }
            console.log('[Form4] Selected standard reference:', name, 'std:', std);
          }
        };
      }
    }

    function setupF4PurposeHandler() {
      const purposeSelect = document.getElementById('f4-requestPurpose');
      if (!purposeSelect) return;

      const purposeDescriptions = {
        "Đánh giá SP mới": "Sản phẩm/linh kiện mới thuộc các dự án phát triển KRD, cần kiểm tra trước khi sản xuất đại trà.",
        "Đánh giá Sản phẩm SOP": "Liên quan đến sản phẩm/linh kiện đã SOP, cần kiểm tra chất lượng và đảm bảo phù hợp với tiêu chuẩn kỹ thuật.",
      };

      purposeSelect.addEventListener('change', (e) => {
        const val = e.target.value || "";
        const desc = purposeDescriptions[val] || "";
        const descEl = document.getElementById('f4-purposeDescription');
        if (descEl) descEl.textContent = desc;

        // Kiểm tra dựa trên value thay vì text
        const isSanPhamMoi = val === "Đánh giá SP mới";
        const isSanPhamSOP = val === "Đánh giá Sản phẩm SOP";

        // Project code container - hiển thị cho "Đánh giá sản phẩm mới"
        const projContainer = document.getElementById('f4-projectCodeContainer');
        const projInput = document.getElementById('f4-projectCode');
        if (projContainer && projInput) {
          projContainer.classList.toggle('hidden', !isSanPhamMoi);
          projInput.disabled = !isSanPhamMoi;
          projInput.required = isSanPhamMoi;
          if (!isSanPhamMoi) projInput.value = '';
        }

        // NCC change fields - không còn logic này nữa
        const nccContainer = document.getElementById('f4-nccChangeFields');
        const appliedModel = document.getElementById('f4-appliedModel');
        if (nccContainer && appliedModel) {
          nccContainer.classList.add('hidden');
          appliedModel.disabled = true;
          appliedModel.required = false;
        }

        // Auto select person received
        const personSel = document.querySelector('#f4-testRequestForm select[name="personReceived"]');
        if (personSel) {
          if (isSanPhamMoi) {
            // Đánh giá sản phẩm mới -> auto chọn Nguyễn Văn Hiếu
            Array.from(personSel.options).forEach(opt => {
              if ((opt.text || opt.textContent || '').trim() === 'Nguyễn Văn Hiếu') {
                personSel.value = opt.value || opt.text;
              }
            });
          } else if (isSanPhamSOP) {
            // Đánh giá sản phẩm SOP -> auto chọn Nguyễn Văn Linh
            Array.from(personSel.options).forEach(opt => {
              if ((opt.text || opt.textContent || '').trim() === 'Nguyễn Văn Linh') {
                personSel.value = opt.value || opt.text;
              }
            });
          }
        }
      });
    }



    function setupF4DesiredDateField() {
      const input = document.getElementById('f4-desiredCompletionDate');
      const hiddenDateTime = document.getElementById('f4-desiredCompletionDateTime');
      if (!input || !hiddenDateTime) return;

      function toYMD(d) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }

      function setRange(el) {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const end = new Date(start);
        end.setDate(end.getDate() + 32);
        el.min = toYMD(start);
        el.max = toYMD(end);
      }

      function ensureDateMode() {
        if (input.type !== 'date') {
          input.type = 'date';
          setRange(input);
          if (!input.value) {
            const now = new Date();
            const def = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            def.setDate(def.getDate() + 7);
            input.value = toYMD(def);
            updateHidden();
          }
          try { if (input.showPicker) input.showPicker(); } catch(_){}
        }
      }

      input.addEventListener('focus', ensureDateMode);
      input.addEventListener('click', ensureDateMode);
      input.addEventListener('blur', () => {
        if (!input.value) {
          input.type = 'text';
          input.removeAttribute('min');
          input.removeAttribute('max');
        }
      });

      function updateHidden() {
        if (!input.value) { hiddenDateTime.value = ''; return; }
        const [y,m,d] = input.value.split('-').map(Number);
        if (!y || !m || !d) { hiddenDateTime.value = ''; return; }
        const now = new Date();
        const dt = new Date(y, m-1, d, now.getHours(), now.getMinutes(), now.getSeconds());
        hiddenDateTime.value = dt.toISOString();
      }

      input.addEventListener('change', updateHidden);
      input.addEventListener('input', updateHidden);
    }

    function setupF4SenderAutocomplete() {
      const nameInput = document.getElementById('f4-senderName');
      const emailInput = document.querySelector('#f4-testRequestForm input[name="senderEmail"]');
      const deptSelect = document.querySelector('#f4-testRequestForm select[name="department"]');
      const list = document.getElementById('f4-senderNameOptions');
      if (!nameInput || !emailInput || !deptSelect || !list) return;

      const F4_SENDER_DB = [
        { name: 'Đoàn Thị Minh Thư', dept: 'KTSP', email: 'thu.doan@karofi.vn' },
        { name: 'Đặng Văn Hải', dept: 'TKCK', email: 'haidv1@karofi.vn' },
        { name: 'Nguyễn Quang Trọng', dept: 'KTCN', email: 'trongnq@karofi.vn' },
        { name: 'Phạm Quang Doanh', dept: 'TKĐT', email: 'doanh.pham@karofi.vn' },
        { name: 'Nguyễn Thị Mừng', dept: 'SC', email: 'mung.nguyen1@karofi.vn' },
        { name: 'Vũ Đăng Lương', dept: 'KTSP', email: 'luong.vu@karofi.vn' },
        { name: 'Hoàng Lê Anh', dept: 'TKCK', email: 'anh.hoang2@karofi.com' },
        { name: 'Phan Văn Cử', dept: 'KTSP', email: 'cupv@karofi.vn' },
        { name: 'Phạm Văn Thuận', dept: 'KTSX', email: 'thuan.pham2@karofi.vn' },
        { name: 'Chu Văn Quang', dept: 'KTSP', email: 'quangcv@karofi.vn' },
        { name: 'Trần Khắc Lâm', dept: 'KTSP', email: 'lamtk@karofi.vn' },
        { name: 'Đặng Thế Huy', dept: 'TKĐT', email: 'huydt@karofi.com' },
        { name: 'Trần Hồng Nhung', dept: 'SC', email: 'nhung.tran2@karofi.vn' },
        { name: 'Đỗ Thành Công', dept: 'KTSP', email: 'congdt@karofi.vn' },
        { name: 'Nguyễn Kim Cương', dept: 'NCTN', email: 'cuong.nguyen6@karofi.com' },
        { name: 'Nguyễn Chung Nam', dept: 'Mua hàng', email: 'nam.nguyen5@karofi.vn' },
        { name: 'Nguyễn Ngọc Quang', dept: 'TKCK', email: 'quang.nguyen1@karofi.vn' },
        { name: 'Hoàng Thùy Linh', dept: 'NCTN', email: 'linh.hoang1@karofi.vn' },
        { name: 'Đoàn Văn Minh', dept: 'TKCK', email: 'minh.doan@karofi.vn' },
        { name: 'Trần Văn Cường', dept: 'QA/QC nhà máy', email: 'cuong.tran1@karofi.vn' },
        { name: 'Đỗ Công Nhậm', dept: 'TKCK', email: 'nham.do@karofi.vn' },
        { name: 'Lê Minh Hải', dept: 'KTSP', email: 'hai.le3@karofi.vn' },
        { name: 'Đỗ Xuân Thái', dept: 'KTSP', email: 'thai.do1@karofi.vn' },
        { name: 'Đặng Thế Huy', dept: 'KTSP', email: 'huydt@karofi.com' },
        { name: 'Trịnh Kế Lực', dept: 'KTSX', email: 'luc.trinh@karofi.vn' },
        { name: 'Đặng Văn Thuấn', dept: 'KTCN', email: 'thuan.dang@karofi.vn' },
        { name: 'Lê Thế Anh', dept: 'KTSP', email: 'anh.le@karofi.vn' },
        { name: 'Dương Quốc Hiếu', dept: 'TKCK', email: 'hieudq1@karofi.vn' },
        { name: 'Phùng Chí Tiến', dept: 'KTSP', email: 'tien.phung@karofi.vn' },
        { name: 'Nguyễn Thị Hương Thúy', dept: 'Mua hàng', email: 'thuy.nguyen@karofi.vn' },
        { name: 'Đào Hoàng Dương', dept: 'DQA', email: 'duong.dao@karofi.vn' },
        { name: 'Nguyễn Mạnh Hùng', dept: 'KTSX', email: 'hung.nguyen2@karofi.vn' },
        { name: 'Nguyễn Hồng Hiếu', dept: 'KTSX', email: 'hieu.nguyen@karofi.vn' },
        { name: 'Đàm Huy Hùng', dept: 'SC', email: 'hung.dam@karofi.vn' },
        { name: 'Khương Đức Tình', dept: 'NCTN', email: 'tinh.khuong@karofi.vn' },
        { name: 'Đặng Thị Chín', dept: 'NCTN', email: 'chindt@karofi.vn' },
        { name: 'Hoàng Văn Thành', dept: 'NCTN', email: 'thanhhv@karofi.vn' },
        { name: 'Nguyễn Thị Thủy', dept: 'NCTN', email: 'thuynt3@karofi.vn' },
      ];

      function normalize(s) {
        return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
      }

      function renderOptions(q) {
        const n = normalize(q);
        if (!n) { list.innerHTML = ''; return; }
        const candidates = F4_SENDER_DB
          .filter(x => normalize(x.name).includes(n))
          .sort((a,b)=> a.name.localeCompare(b.name))
          .slice(0, 30);
        list.innerHTML = candidates.map(c=>`<option value="${c.name}"></option>`).join('');
      }

      function tryAutofill() {
        const val = nameInput.value || '';
        const exact = F4_SENDER_DB.find(x=>x.name === val);
        if (exact) {
          emailInput.value = exact.email;
          const opts = Array.from(deptSelect.options);
          const match = opts.find(o=> (o.value||o.text||'').trim() === exact.dept);
          if (match) deptSelect.value = match.value || match.text;
        }
      }

      nameInput.addEventListener('input', ()=>{ renderOptions(nameInput.value); });
      nameInput.addEventListener('change', tryAutofill);
      nameInput.addEventListener('blur', tryAutofill);
      renderOptions('');
    }

    let f4PendingFiles = [];
    function setupF4FileUpload() {
      const fileInput = document.getElementById('f4-testRequestFiles');
      const uploadArea = document.getElementById('f4-fileUploadArea');
      const uploadList = document.getElementById('f4-testRequestUploadList');
      if (!fileInput || !uploadArea || !uploadList) return;

      const allowedTypes = {
        'application/pdf': 'PDF',
        'application/msword': 'DOC',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'DOCX',
        'application/vnd.ms-excel': 'XLS',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'XLSX',
        'image/jpeg': 'JPG',
        'image/jpg': 'JPG',
        'image/png': 'PNG'
      };
      const maxFileSize = 20 * 1024 * 1024;

      function validateFile(file) {
        const errors = [];
        const type = file.type || '';
        if (type ? !allowedTypes[type] : !(['pdf','doc','docx','xls','xlsx','jpg','jpeg','png'].includes((file.name.split('.').pop()||'').toLowerCase()))) {
          errors.push('Loại file không được hỗ trợ');
        }
        if (file.size > maxFileSize) errors.push('File quá lớn (tối đa 20MB)');
        return errors;
      }

      function createItem(file, idx) {
        const isImage = file.type.startsWith('image/');
        const typeLabel = allowedTypes[file.type] || 'FILE';
        const row = document.createElement('div');
        row.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
        row.id = `f4-file-row-${idx}`;
        row.innerHTML = `
          <div class="flex items-start space-x-4">
            ${isImage ?
              `<div class="flex-shrink-0">
                <img id="f4-preview-${idx}" class="w-16 h-16 object-cover rounded-lg border" src="#" alt="Preview">
              </div>` :
              `<div class="flex-shrink-0 w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">📎</span>
              </div>`}
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <input id="f4-rename-${idx}" class="text-sm font-medium text-gray-900 truncate border border-blue-200 rounded px-2 py-1 w-full max-w-xs"
                       value="${file.name}" />
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${typeLabel}</span>
              </div>
              <p class="text-sm text-gray-500 mt-1">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
            </div>
            <button type="button" id="f4-remove-${idx}" class="flex-shrink-0 p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-50">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>`;
        uploadList.appendChild(row);

        if (isImage) {
          const r = new FileReader();
          r.onload = e => { const img = document.getElementById(`f4-preview-${idx}`); if (img) img.src = e.target.result; };
          r.readAsDataURL(file);
        }
        row.querySelector(`#f4-rename-${idx}`).addEventListener('input', e=>{
          const pf = f4PendingFiles[idx]; if (pf) pf.name = e.target.value;
        });
        row.querySelector(`#f4-remove-${idx}`).onclick = ()=>{
          const pf = f4PendingFiles[idx];
          if (pf) f4PendingFiles[idx] = null;
          row.remove();
        };
      }

      function addFiles(files) {
        const errs = [];
        Array.from(files).forEach(file=>{
          const e = validateFile(file);
          if (e.length) { errs.push(`${file.name}: ${e.join(', ')}`); return; }
          const idx = f4PendingFiles.length;
          f4PendingFiles.push({ file, name: file.name });
          createItem(file, idx);
        });
        if (errs.length) alert('Một số file không hợp lệ:\n\n' + errs.join('\n'));
      }

      ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
        uploadArea.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); }, false);
      });
      ['dragenter','dragover'].forEach(ev=>{
        uploadArea.addEventListener(ev, ()=>uploadArea.classList.add('border-blue-500','bg-blue-50'), false);
      });
      ['dragleave','drop'].forEach(ev=>{
        uploadArea.addEventListener(ev, ()=>uploadArea.classList.remove('border-blue-500','bg-blue-50'), false);
      });
      uploadArea.addEventListener('drop', e=>addFiles(e.dataTransfer.files), false);
      fileInput.addEventListener('change', function(){ if (this.files?.length) addFiles(this.files); this.value=''; });
      uploadArea.addEventListener('click', e=>{ if (e.target!==fileInput) fileInput.click(); });
    }

    async function uploadF4PendingFiles() {
      const list = f4PendingFiles.filter(Boolean);
      const total = Math.max(list.length, 1);
      const results = [];
      let done = 0;

      for (const item of list) {
        const base64 = await new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = e=>resolve(e.target.result.split(',')[1]);
          r.onerror = ()=>reject(new Error('Không thể đọc file'));
          r.readAsDataURL(item.file);
        });
        const payload = { data: [{ filename: (item.name || item.file.name), mimetype: item.file.type, filedata: base64 }] };
        const resp = await fetch(F4_FILE_UPLOAD_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error(await resp.text());
        let result = {};
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) result = await resp.json();
        else { try { result = JSON.parse(await resp.text()); } catch { result = {}; } }
        const url = result.url || result.fileUrl || result.public_url || (result.data && result.data[0] && (result.data[0].url || result.data[0].link)) || '#';
        results.push({ name: (item.name || item.file.name), url, type: item.file.type, size: item.file.size });
        done++;
      }
      return results;
    }

    function setupF4FormSubmit() {
      const form = document.getElementById('f4-testRequestForm');
      if (!form) return;

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const confirmed = window.confirm('Bạn có chắc muốn gửi lên hệ thống không?.');
        if (!confirmed) return;

        const btn = this.querySelector("button[type=submit]");
        const originalLabel = btn ? btn.innerHTML : "";
        if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner'></span><span style='margin-left:8px'>Đang gửi...</span>"; }

        const data = (function toJSON(form){
          const d = {}; new FormData(form).forEach((val,key)=>{ d[key] = d[key] ? [].concat(d[key],val) : val; }); return d;
        })(this);

        // Phần C đã bị xóa, luôn sử dụng kiểm tra mặc định
        const isSpecial = false;
        const normalizedRequestDate = (data.requestDate || '').toString().slice(0,16).replace('T', ' ');
        const normalizedDesiredDate = (data.desiredCompletionDate || '').toString().slice(0,10);
        
        const componentStd = Number(data.componentStandard || 0) || 0;
        const componentStdStr = String(componentStd).replace('.', ',');

        const mapped = {
          requesterName: String(data.senderName || '').trim(),
          email: String(data.senderEmail || '').trim(),
          requestDate: String(normalizedRequestDate || '').trim(),
          requestCode: String(document.getElementById('f4-requestCode')?.value || '').trim(),
          deptRequest: String(data.department || '').trim(),
          itemName: String(data.productName || '').trim(),
          itemCode: String(data.productCode || '').trim(),
          componentType: String(data.componentType || '').trim(),
          componentStandard: String(componentStdStr),
          purpose: String(data.requestPurpose || '').trim(),
          projectCode: String(data.projectCode || '').trim(),
          vendor: String(data.supplier || '').trim(),
          qtySamples: String(data.numSamples || '').trim(),
          desiredDate: String(normalizedDesiredDate || '').trim(),
          changeReq: String(data.notes || '').trim(),
          kiemtraDefault: '1',
          kiemtraDacBiet: '0',
          SpecialReq: '',
          Receiver: String(data.personReceived || '').trim(),
          pic: String(data.pic || '').trim(),
          appliedModel: String(data.appliedModel || '').trim(),
          Score: String(componentStdStr), Odoojira: '', Assignee: String(data.pic || '').trim()
        };

        const pending = f4PendingFiles.filter(Boolean);
        const attachmentNames = pending.map(p=>p?.name || p?.file?.name).filter(Boolean);

        const fd = new FormData();
        Object.entries(mapped).forEach(([k,v])=>fd.append(k, v));
        fd.append('attachments', attachmentNames.join(';'));
        fd.append('componentStandard', String(componentStdStr));
        for (const item of pending) {
          if (!item) continue;
          const name = item.name || item.file.name;
          fd.append('files[]', item.file, name);
        }

        // Format dữ liệu theo schema NocoDB
        const projectCode = String(data.projectCode || '').trim() || null;
        const attachmentNamesForNocoDB = pending.map(p=>p?.name || p?.file?.name).filter(Boolean);
        const attachmentsStr = attachmentNamesForNocoDB.join(';');
        
        // Cập nhật formData với attachments
        const formDataWithAttachments = {
          ...data,
          attachments: attachmentsStr
        };
        
        const nocodbTaskData = formatForm4ToNocoDBTask(formDataWithAttachments, projectCode);
        
        // Gửi lên NocoDB (async, không block)
        submitTaskToNocoDB(nocodbTaskData)
          .then((dbResult) => {
            console.log('[Form 4] Task saved to NocoDB:', dbResult);
            // Có thể lưu Id từ database vào task object để dùng sau
            // task.nocodbId = dbResult.Id;
          })
          .catch((error) => {
            console.error('[Form 4] Failed to save task to NocoDB:', error);
            // Vẫn tiếp tục với endpoint cũ nếu database fail
          });

        try {
          let resp = await fetch(F4_FORM_SUBMIT_ENDPOINT, { method: 'POST', body: fd });
          if (!resp.ok) {
            const uploaded = await uploadF4PendingFiles();
            const mappedFallback = {
              ...mapped,
              attachments: uploaded.map(u=>u.name || '').join(';'),
              attachmentUrls: uploaded.map(u=>u.url || '').join(';')
            };
            resp = await fetch(F4_FORM_SUBMIT_ENDPOINT, {
              method: "POST",
              headers: { "Content-Type": "application/json", "Accept": "application/json" },
              body: JSON.stringify({ data: [mappedFallback] })
            });
            if (!resp.ok) throw new Error(await resp.text());
          }

          if (btn) {
            btn.innerHTML="Đã gửi!";
            setTimeout(()=>{btn.innerHTML=originalLabel;btn.disabled=false;},20000);
          }

          this.reset();
          const dateInput = document.getElementById('f4-testRequestDate');
          if (dateInput) {
            const now = new Date();
            const tzOffsetMs = now.getTimezoneOffset() * 60000;
            const localISO = new Date(now.getTime() - tzOffsetMs).toISOString().slice(0, 16);
            dateInput.value = localISO;
          }
          setF4RequestCode();
          const list = document.getElementById('f4-testRequestUploadList');
          if (list) list.innerHTML = '';
          f4PendingFiles = [];

          // Tạo task trong Form 5 từ dữ liệu Form 4
          const taskData = {
            ...mapped,
            attachments: attachmentNames.join('; ')
          };
          createF5TaskFromForm4(taskData);

          showToast('Đã gửi yêu cầu thành công!', 'success');
        } catch(err) {
          alert("Gửi thất bại: "+err);
          if (btn) { btn.innerHTML=originalLabel; btn.disabled=false; }
        }
      });
    }

    // ============================================
    // DATABASE STRUCTURE MOCK - Form 4 & Form 5
    // ============================================
    /*
    DATABASE TABLES STRUCTURE:
    
    1. TABLE: form4_requests (Phiếu nhập tác vụ)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - request_code (VARCHAR, UNIQUE) - Mã yêu cầu (QA.SPM.MMDD-XXXXXX)
       - requester_name (VARCHAR) - Họ tên người gửi
       - requester_email (VARCHAR) - Email người gửi
       - request_date (DATETIME) - Ngày giờ yêu cầu
       - dept_request (VARCHAR) - Phòng ban yêu cầu
       - item_name (VARCHAR) - Tên sản phẩm/linh kiện
       - item_code (VARCHAR) - Mã sản phẩm/linh kiện
       - component_type (VARCHAR) - Loại linh kiện
       - component_standard (DECIMAL) - Công chuẩn (giờ)
       - purpose (VARCHAR) - Mục đích yêu cầu
       - project_code (VARCHAR) - Mã dự án
       - vendor (VARCHAR) - Nhà cung cấp
       - qty_samples (INT) - Số lượng mẫu
       - desired_date (DATE) - Hạn mong muốn
       - person_received (VARCHAR) - Đầu mối nhận mẫu
       - pic (VARCHAR) - PIC (Người phụ trách)
       - notes (TEXT) - Ghi chú
       - applied_model (VARCHAR) - Model áp dụng
       - attachments (TEXT) - Danh sách file đính kèm (JSON hoặc TEXT)
       - created_at (DATETIME) - Thời gian tạo
       - updated_at (DATETIME) - Thời gian cập nhật
       - status (VARCHAR) - Trạng thái (pending, submitted, processing, completed)
    
    2. TABLE: form5_projects (Dự án Form 5)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - project_code (VARCHAR, UNIQUE) - Mã dự án
       - project_name (VARCHAR) - Tên dự án
       - description (TEXT) - Mô tả dự án
       - pic (VARCHAR) - Người phụ trách
       - created_at (DATE) - Ngày tạo
       - due_date (DATE) - Ngày hết hạn
       - status (VARCHAR) - Trạng thái (pending, in_progress, done)
       - created_at (DATETIME) - Thời gian tạo
       - updated_at (DATETIME) - Thời gian cập nhật
    
    3. TABLE: form5_tasks (Tác vụ Form 5)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - project_id (FOREIGN KEY -> form5_projects.id)
       - task_code (VARCHAR, UNIQUE) - Mã tác vụ (QA.SPM.MMDD-XXXXXX)
       - task_name (VARCHAR) - Tên tác vụ
       - description (TEXT) - Mô tả tác vụ
       - pic (VARCHAR) - Người phụ trách
       - requester_name (VARCHAR) - Người yêu cầu
       - requester_email (VARCHAR) - Email người yêu cầu
       - department (VARCHAR) - Phòng ban
       - created_at (DATE) - Ngày tạo
       - due_date (DATE) - Ngày hết hạn
       - status (VARCHAR) - Trạng thái (pending, in_progress, done)
       - priority (VARCHAR) - Ưu tiên (Cao, Trung bình, Thấp)
       - form4_request_id (FOREIGN KEY -> form4_requests.id) - Liên kết với Form 4
       - form4_data (JSON) - Dữ liệu từ Form 4 (JSON)
       - created_at (DATETIME) - Thời gian tạo
       - updated_at (DATETIME) - Thời gian cập nhật
    
    4. TABLE: form5_subtasks (Tác vụ con Form 5)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - task_id (FOREIGN KEY -> form5_tasks.id)
       - name (VARCHAR) - Tên tác vụ con
       - pic (VARCHAR) - Người thực hiện
       - due_date (DATE) - Ngày hết hạn
       - status (VARCHAR) - Trạng thái (pending, in_progress, done)
       - priority (VARCHAR) - Ưu tiên (Cao, Trung bình, Thấp)
       - declaration_mode (VARCHAR) - Chế độ khai báo (review-file-nctn, review-ce-qc, train-qc, send-test-task, review-4m, review-fmea)
       - created_at (DATETIME) - Thời gian tạo
       - updated_at (DATETIME) - Thời gian cập nhật
    
    5. TABLE: form5_declarations (Khai báo Form 5)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - subtask_id (FOREIGN KEY -> form5_subtasks.id)
       - declaration_mode (VARCHAR) - Chế độ khai báo
       - declaration_data (JSON) - Dữ liệu khai báo (JSON)
       - created_at (DATETIME) - Thời gian tạo
       - updated_at (DATETIME) - Thời gian cập nhật
    
    RELATIONSHIPS:
    - form4_requests (1) -> (1) form5_tasks (via form4_request_id)
    - form5_projects (1) -> (N) form5_tasks (via project_id)
    - form5_tasks (1) -> (N) form5_subtasks (via task_id)
    - form5_subtasks (1) -> (N) form5_declarations (via subtask_id)
    */
    // ============================================
    // END DATABASE STRUCTURE MOCK
    // ============================================

    // Hàm tạo task trong Form 5 từ dữ liệu Form 4
    function createF5TaskFromForm4(form4Data) {
      const now = new Date();
      const taskId = `TASK-${Date.now()}`;
      
      // Xác định project dựa trên purpose hoặc tạo project mới
      let targetProject = null;
      const purpose = form4Data.purpose || '';
      const projectCode = form4Data.projectCode || '';
      
      // Tìm project theo projectCode nếu có
      if (projectCode) {
        targetProject = F5_PROJECTS.find(p => p.projectCode === projectCode);
      }
      
      // Nếu không tìm thấy, tìm project theo purpose
      if (!targetProject) {
        if (purpose.includes('SP mới') || purpose.includes('Đánh giá SP mới')) {
          targetProject = F5_PROJECTS.find(p => p.projectName.includes('Sản phẩm Mới'));
        } else if (purpose.includes('SOP') || purpose.includes('Sản phẩm SOP')) {
          targetProject = F5_PROJECTS.find(p => p.projectName.includes('Sản phẩm SOP'));
        }
      }
      
      // Nếu vẫn không tìm thấy, tạo project mới
      if (!targetProject) {
        const quarter = Math.floor((now.getMonth() + 3) / 3);
        const year = now.getFullYear();
        const projectId = `PROJ-${Date.now()}`;
        const newProjectCode = projectCode || `PRJ-${String(Date.now()).slice(-6)}`;
        
        targetProject = {
          id: projectId,
          projectCode: newProjectCode,
          projectName: purpose.includes('SP mới') 
            ? `Dự án Đánh giá Sản phẩm Mới - Q${quarter}/${year}`
            : `Dự án Đánh giá Sản phẩm SOP - Q${quarter}/${year}`,
          description: `Đánh giá các sản phẩm trong quý ${quarter} năm ${year}`,
          pic: form4Data.pic || form4Data.Receiver || '',
          createdAt: now.toISOString().split('T')[0],
          dueDate: form4Data.desiredDate || '',
          status: 'in_progress',
          expanded: false,
          tasks: []
        };
        
        F5_PROJECTS.push(targetProject);
        console.log('[Form 5] Created new project:', targetProject.projectName);
      }
      
      // Tạo task mới
      const newTask = {
        id: taskId,
        taskCode: form4Data.requestCode || `QA.SPM.${String(Date.now()).slice(-6)}`,
        taskName: form4Data.itemName || 'Tác vụ mới',
        description: `Yêu cầu đánh giá ${form4Data.itemName || ''}${form4Data.itemCode ? ` (Mã: ${form4Data.itemCode})` : ''}${form4Data.vendor ? ` từ nhà cung cấp ${form4Data.vendor}` : ''}. ${form4Data.changeReq || ''}`,
        pic: form4Data.pic || form4Data.Receiver || '',
        requesterName: form4Data.requesterName || '',
        requesterEmail: form4Data.email || '',
        department: form4Data.deptRequest || '',
        createdAt: form4Data.requestDate ? form4Data.requestDate.split(' ')[0] : now.toISOString().split('T')[0],
        dueDate: form4Data.desiredDate || '',
        status: 'pending',
        priority: 'Trung bình',
        expanded: false,
        checked: false,
        // Thông tin chi tiết từ Form 4
        form4Data: {
          itemCode: form4Data.itemCode || '',
          componentType: form4Data.componentType || '',
          componentStandard: form4Data.componentStandard || '',
          purpose: form4Data.purpose || '',
          projectCode: form4Data.projectCode || '',
          vendor: form4Data.vendor || '',
          qtySamples: form4Data.qtySamples || '',
          changeReq: form4Data.changeReq || '',
          attachments: form4Data.attachments || ''
        },
        subtasks: [] // Khởi tạo mảng subtasks rỗng
      };
      
      // Thêm task vào project
      if (!targetProject.tasks) {
        targetProject.tasks = [];
      }
      targetProject.tasks.push(newTask);
      
      console.log('[Form 5] Created new task from Form 4:', newTask.taskName, 'in project:', targetProject.projectName);
      
      // Render lại Form 5 nếu đang mở
      const form5Section = document.getElementById('form5');
      if (form5Section && !form5Section.classList.contains('hidden')) {
        renderF5TasksTable();
        showToast(`Đã tạo tác vụ "${newTask.taskName}" trong Form 5`, 'success');
        
        // Chuyển sang Form 5 và expand project/task
        targetProject.expanded = true;
        newTask.expanded = true;
        switchToForm('form5');
        setTimeout(() => {
          renderF5TasksTable();
          // Scroll đến task mới
          const taskRow = document.querySelector(`[data-task-id="${taskId}"]`);
          if (taskRow) {
            taskRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            taskRow.classList.add('bg-blue-100');
            setTimeout(() => taskRow.classList.remove('bg-blue-100'), 3000);
          }
        }, 100);
      }
      
      return newTask;
    }

    // ===== FORM 5 - QUẢN LÝ TÁC VỤ SẢN PHẨM MỚI =====
    
    // Biến lưu trữ dữ liệu projects - sẽ được load từ API
    let F5_PROJECTS = [];
    let F5_FILTER_PIC = ''; // Filter theo người nhận tác vụ
    
    // Danh sách tên "Người nhận tác vụ" cố định
    const F5_PIC_LIST = [
      "Nguyễn Hữu Thịnh",
      "Nguyễn Văn Hiếu",
      "Vũ Thị Hằng",
      "Nguyễn Văn Linh",
      "Đào Hoàng Dương",
      "Bùi Đặng Quốc Huy",
      "Đào Tuấn Kỳ",
      "Thái Thị Giang",
      "Trần Hiếu Nghĩa"
    ];
    
    /**
     * Load dữ liệu projects và tasks từ API
     * Transform từ format NocoDB (mảng các task records) sang format UI (projects với tasks)
     * @param {string} picFilter - Tên người nhận tác vụ để lọc (optional)
     * @returns {Promise<Array>} - Mảng projects với cấu trúc: [{ id, projectCode, projectName, tasks: [...] }]
     */
    async function loadF5Projects(picFilter = '') {
      try {
        // Thử gọi API với tham số để lấy tất cả records
        // Nếu API không hỗ trợ tham số, sẽ fallback về URL gốc
        let url = 'https://iatzhxxuk.tino.page/webhook/form5-task-summary?limit=1000&all=true';
        // Thêm tham số PIC vào URL nếu có
        if (picFilter && picFilter.trim()) {
          url += `&pic=${encodeURIComponent(picFilter.trim())}`;
        }
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseText = await response.text();
        console.log('[Form 5] Raw response text length:', responseText.length);
        console.log('[Form 5] Raw response text (first 500 chars):', responseText.substring(0, 500));
        console.log('[Form 5] Raw response text (last 500 chars):', responseText.substring(Math.max(0, responseText.length - 500)));
        console.log('[Form 5] Response starts with [?:', responseText.trim().startsWith('['));
        console.log('[Form 5] Response starts with {?:', responseText.trim().startsWith('{'));
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          console.error('[Form 5] Failed to parse JSON:', e);
          console.error('[Form 5] Response text:', responseText);
          throw e;
        }
        
        console.log('[Form 5] Parsed data:', data);
        console.log('[Form 5] Data type:', typeof data, 'Is array:', Array.isArray(data));
        if (Array.isArray(data)) {
          console.log('[Form 5] Array length:', data.length);
        } else if (data && typeof data === 'object') {
          console.log('[Form 5] Object keys:', Object.keys(data));
          console.log('[Form 5] Full object:', JSON.stringify(data, null, 2).substring(0, 1000));
        }
        
        // Xử lý nhiều format response có thể có
        let records = null;
        
        // MOCK DATA FALLBACK (để debug khi API trả về thiếu)
        // Nếu API chỉ trả về 1 record (object đơn) trong khi cần array nhiều item
        // có thể do webhook config sai.
        // Tạm thời check nếu array length <= 1 và data có vẻ thiếu, thử dùng mock data từ Untitled-1.txt nếu cần thiết.
        // Tuy nhiên, code dưới đây sẽ ưu tiên data từ API nếu nó là Array hợp lệ.
        
        if (Array.isArray(data)) {
          // Trường hợp 1: API trả về array trực tiếp
          records = data;
          console.log('[Form 5] Data is array, using directly. Length:', records.length);
        } else if (data && typeof data === 'object') {
          // ... (các check khác giữ nguyên)
          if (Array.isArray(data.data)) {
            records = data.data;
          } else if (Array.isArray(data.records)) {
            records = data.records;
          } else if (Array.isArray(data.tasks)) {
            records = data.tasks;
          } else if (Array.isArray(data.items)) {
            records = data.items;
          } else if (Array.isArray(data.results)) {
            records = data.results;
          } else {
            // Thử tìm property nào đó là array
            const arrayKeys = Object.keys(data).filter(key => Array.isArray(data[key]));
            if (arrayKeys.length > 0) {
              records = data[arrayKeys[0]];
            }
          }
        }
        
        if (!Array.isArray(records)) {
          // Thử wrap object đơn lẻ thành array
          if (data && typeof data === 'object' && !Array.isArray(data)) {
             if (data.Id || data.id || data.project_code || data.TaskRequestCode) {
              records = [data];
              console.log('[Form 5] Wrapped single object into array. WARNING: API might be returning only the latest record!');
              // Show warning toast
              showToast('Cảnh báo: API chỉ trả về 1 bản ghi. Vui lòng kiểm tra lại Webhook.', 'warning');
            }
          }
        }

        // --- DEBUG MOCK DATA START ---
        // Bỏ comment dòng dưới để dùng dữ liệu mẫu nếu API lỗi
        /*
        if (!records || records.length <= 1) {
           console.warn('[Form 5] API returned few records, trying mock data for debug...');
           records = getMockF5Data();
        }
        */
        // --- DEBUG MOCK DATA END ---

        if (!records || records.length === 0) {
           console.warn('[Form 5] No records found or empty array.');
           return [];
        }

        
        if (records.length === 0) {
          console.warn('[Form 5] Empty array from API');
          return [];
        }
        
        console.log('[Form 5] Processing', records.length, 'records');
        console.log('[Form 5] Records details:', records.map(r => ({ 
          Id: r.Id, 
          TaskRequestCode: r.TaskRequestCode, 
          Subtaskno: r.Subtaskno || r.SubtaskNo,
          SubtaskName: r.SubtaskName 
        })));
        
        // Phân loại records cải tiến
        // - TaskRequestCode: group các records cùng một dự án
        // - Ưu tiên check field 'type' nếu có
        // - Sau đó check Subtaskno
        const tasks = [];      // Task chính
        const subtasks = [];   // Subtask
        const declarations = []; // Giữ lại cho tương lai nếu cần
        
        records.forEach(record => {
          const taskRequestCode = String(record.TaskRequestCode || '').trim();
          
          if (!taskRequestCode) {
            return;
          }

          // 1. Xác định dựa trên Subtaskno
          let subtaskNo = record.Subtaskno !== undefined ? record.Subtaskno : record.SubtaskNo;
          if (subtaskNo !== null && subtaskNo !== undefined) {
            subtaskNo = Number(subtaskNo);
          }

          // 2. Xác định dựa trên type (nếu có)
          const type = record.type || '';
          const isSubtaskByType = type && typeof type === 'string' && type.includes('subtask');

          // Logic phân loại:
          // - Nếu type chứa 'subtask' -> SUBTASK
          // - Hoặc nếu Subtaskno là số > 0 -> SUBTASK
          // - Ngược lại -> TASK
          
          const isSubtask = isSubtaskByType || (typeof subtaskNo === 'number' && !isNaN(subtaskNo) && subtaskNo > 0);

          if (isSubtask) {
            subtasks.push(record);
            console.log(`[Form 5] Classified as SUBTASK: Id=${record.Id}, Subtaskno=${subtaskNo}, Type=${type}`);
          } else {
            tasks.push(record);
            console.log(`[Form 5] Classified as TASK: Id=${record.Id}, Subtaskno=${subtaskNo}, Type=${type}`);
          }
        });
        
        console.log('[Form 5] Classified:', { tasks: tasks.length, subtasks: subtasks.length, declarations: declarations.length });
        console.log('[Form 5] Tasks:', tasks.map(t => ({ Id: t.Id, TaskRequestCode: t.TaskRequestCode, Subtaskno: t.Subtaskno })));
        console.log('[Form 5] Subtasks:', subtasks.map(s => ({ Id: s.Id, TaskRequestCode: s.TaskRequestCode, Subtaskno: s.Subtaskno, SubtaskName: s.SubtaskName })));
        
        // Group subtasks theo TaskRequestCode
        // Tất cả subtasks đã được filter ở trên (Subtaskno != 0)
        const subtasksByTaskRequestCode = {};
        subtasks.forEach(subtask => {
          // Chuẩn hóa key để map chính xác hơn
          const taskRequestCode = String(subtask.TaskRequestCode || '').trim().toLowerCase();
          if (taskRequestCode) {
            if (!subtasksByTaskRequestCode[taskRequestCode]) {
              subtasksByTaskRequestCode[taskRequestCode] = [];
            }
            subtasksByTaskRequestCode[taskRequestCode].push(subtask);
          }
        });
        console.log('[Form 5] Subtasks grouped by TaskRequestCode keys:', Object.keys(subtasksByTaskRequestCode));
        
        // Group declarations theo parent_id (subtask Id)
        const declarationsBySubtaskId = {};
        declarations.forEach(declaration => {
          const subtaskId = declaration.parent_id;
          if (!declarationsBySubtaskId[subtaskId]) {
            declarationsBySubtaskId[subtaskId] = [];
          }
          declarationsBySubtaskId[subtaskId].push(declaration);
        });
        
        // Group tasks theo project_code
        const projectsMap = {};
        
        tasks.forEach(taskRecord => {
          const projectCode = taskRecord.project_code || 'UNKNOWN';
          
          // Tạo project nếu chưa tồn tại
          if (!projectsMap[projectCode]) {
            // Tạo tên project dựa trên TaskPurpose hoặc project_code
            const purpose = taskRecord.TaskPurpose || '';
            let projectName = `Dự án ${projectCode}`;
            if (purpose.includes('SP mới') || purpose.includes('Đánh giá SP mới')) {
              projectName = `Dự án Đánh giá Sản phẩm Mới - ${projectCode}`;
            } else if (purpose.includes('SOP') || purpose.includes('Sản phẩm SOP')) {
              projectName = `Dự án Đánh giá Sản phẩm SOP - ${projectCode}`;
            }
            
            projectsMap[projectCode] = {
              id: `PROJ-${projectCode}`,
              projectCode: projectCode,
              projectName: projectName,
              description: '',
              pic: taskRecord.TaskPIC || taskRecord.TaskPersonReceived || '',
              createdAt: taskRecord.CreatedAt ? taskRecord.CreatedAt.split(' ')[0] : new Date().toISOString().split('T')[0],
              dueDate: taskRecord.TaskDesiredDate || '',
              status: 'in_progress', // Mặc định
              expanded: true, // Mở rộng mặc định để hiển thị tasks
              tasks: []
            };
          }
          
          // Transform task record thành format UI
          const taskId = taskRecord.Id;
          const taskRequestCode = String(taskRecord.TaskRequestCode || '').trim();
          // Chuẩn hóa key để map với subtasks
          const taskRequestCodeKey = taskRequestCode.toLowerCase();

          // Lấy subtasks theo TaskRequestCode (cùng một dự án)
          const taskSubtasksRaw = subtasksByTaskRequestCode[taskRequestCodeKey] || [];
          console.log(`[Form 5] Task ${taskId} (${taskRequestCode}) has ${taskSubtasksRaw.length} subtasks:`, taskSubtasksRaw.map(s => ({ Id: s.Id, SubtaskName: s.SubtaskName, Subtaskno: s.Subtaskno })));
          
          // Sắp xếp subtasks theo Subtaskno (Subtaskno != 0)
          const sortedSubtasks = [...taskSubtasksRaw].sort((a, b) => {
            const noA = a.Subtaskno || a.SubtaskNo || 0;
            const noB = b.Subtaskno || b.SubtaskNo || 0;
            return noA - noB;
          });
          
          const taskSubtasks = sortedSubtasks.map((subtaskRecord) => {
            const subtaskId = subtaskRecord.Id;
            const subtaskNo = subtaskRecord.Subtaskno || subtaskRecord.SubtaskNo || null;
            // Map các trường từ API (có thể có cả SubtaskStatus và Subtaskstatus)
            const subtaskStatus = subtaskRecord.SubtaskStatus || subtaskRecord.Subtaskstatus || 'pending';
            
            // Lấy type từ webhook và extract declaration mode nếu có
            const type = subtaskRecord.type || '';
            let declarationMode = subtaskRecord.SubtaskDeclarationMode || '';
            
            // Nếu có type dạng "form5_subtask_<mode>", extract mode từ type
            if (type && type.startsWith('form5_subtask_')) {
              const extractedMode = type.replace('form5_subtask_', '');
              if (extractedMode) {
                declarationMode = extractedMode;
              }
            }
            
            return {
              id: `SUB-${subtaskId}`,
              name: subtaskRecord.SubtaskName || '',
              pic: subtaskRecord.SubtaskPIC || '',
              dueDate: subtaskRecord.SubtaskDueDate || '',
              status: subtaskStatus,
              priority: subtaskRecord.SubtaskPriority || 'Trung bình',
              checked: subtaskStatus === 'done',
              type: type, // Lưu type từ webhook
              declarationMode: declarationMode, // Declaration mode (từ SubtaskDeclarationMode hoặc extract từ type)
              manhour: subtaskRecord.Subtaskmanhour || null,
              checklist: subtaskRecord.Subtaskchecklist || '',
              checklistLink: subtaskRecord.Subtaskformlink || null, // Link file checklist từ webhook
              timesend: subtaskRecord.Subtasktimesend || null,
              finishTime: subtaskRecord.Subtaskfinishtime || null,
              note: subtaskRecord.Subtasknote || '',
              subtaskNo: subtaskNo, // Số thứ tự subtask từ database (1, 2, 3...)
              itemCode: subtaskRecord.Subtaskitemcode || '', // Mã linh kiện/sản phẩm từ webhook
              subtaskCode: subtaskRecord.Subtaskcode || subtaskRecord.TaskCode || '' // Mã tác vụ của subtask
            };
          });
          
          // Parse form4Data nếu có
          let form4Data = {};
          if (taskRecord.TaskForm4Data) {
            try {
              form4Data = typeof taskRecord.TaskForm4Data === 'string' 
                ? JSON.parse(taskRecord.TaskForm4Data) 
                : taskRecord.TaskForm4Data;
            } catch (e) {
              console.warn('[Form 5] Failed to parse TaskForm4Data:', e);
            }
          }
          
          // Tạo form4Data từ các trường Task* nếu TaskForm4Data null
          if (!form4Data || Object.keys(form4Data).length === 0) {
            form4Data = {
              requesterName: taskRecord.TaskRequesterName || '',
              email: taskRecord.TaskRequesterEmail || '',
              requestDate: taskRecord.TaskRequestDate || '',
              requestCode: taskRecord.TaskRequestCode || '',
              deptRequest: taskRecord.TaskDeptRequest || '',
              itemName: taskRecord.TaskItemName || '',
              itemCode: taskRecord.TaskItemCode || '',
              componentType: taskRecord.TaskComponentType || '',
              componentStandard: taskRecord.TaskComponentStandard || '',
              purpose: taskRecord.TaskPurpose || '',
              projectCode: taskRecord.project_code || '',
              vendor: taskRecord.TaskVendor || '',
              qtySamples: taskRecord.TaskQtySamples || '',
              desiredDate: taskRecord.TaskDesiredDate || '',
              Receiver: taskRecord.TaskPersonReceived || '',
              pic: taskRecord.TaskPIC || '',
              changeReq: taskRecord.TaskNotes || '',
              appliedModel: taskRecord.TaskAppliedModel || '',
              attachments: taskRecord.TaskAttachments || ''
            };
          }
          
          // Tính toán status dựa trên subtasks
          let taskStatus = taskRecord.TaskStatus || 'pending';
          if (taskSubtasks.length > 0) {
            // Nếu có ít nhất 1 subtask → mặc định là "in_progress"
            const allSubtasksDone = taskSubtasks.every(st => st.status === 'done');
            if (allSubtasksDone) {
              taskStatus = 'done';
            } else {
              taskStatus = 'in_progress';
            }
          }
          
          const task = {
            id: `TASK-${taskId}`,
            taskCode: taskRecord.TaskRequestCode || taskRecord.TaskCode || '',
            taskName: taskRecord.TaskItemName || taskRecord.TaskName || 'Tác vụ không tên',
            description: taskRecord.TaskDescription || `Yêu cầu đánh giá ${taskRecord.TaskItemName || ''}`,
            pic: taskRecord.TaskPIC || taskRecord.TaskPersonReceived || '',
            requesterName: taskRecord.TaskRequesterName || '',
            requesterEmail: taskRecord.TaskRequesterEmail || '',
            department: taskRecord.TaskDeptRequest || taskRecord.TaskDepartment || '',
            createdAt: taskRecord.TaskRequestDate ? taskRecord.TaskRequestDate.split(' ')[0] : (taskRecord.TaskCreatedAt || ''),
            dueDate: taskRecord.TaskDesiredDate || taskRecord.TaskDueDate || '',
            status: taskStatus,
            priority: taskRecord.TaskPriority || 'Trung bình',
            expanded: taskSubtasks.length > 0, // Mở rộng nếu có subtasks
            checked: taskStatus === 'done',
            vendor: taskRecord.TaskVendor || '', // Thêm TaskVendor từ webhook
            form4Data: form4Data,
            subtasks: taskSubtasks
          };
          
          projectsMap[projectCode].tasks.push(task);
        });
        
        // Convert projectsMap thành mảng
        const projects = Object.values(projectsMap);
        
        // Tính toán status cho projects dựa trên tasks
        projects.forEach(project => {
          if (project.tasks.length === 0) {
            project.status = 'pending';
          } else {
            const allDone = project.tasks.every(t => t.status === 'done');
            const hasInProgress = project.tasks.some(t => t.status === 'in_progress' || t.status === 'done');
            
            if (allDone) {
              project.status = 'done';
            } else if (hasInProgress) {
              project.status = 'in_progress';
            } else {
              project.status = 'pending';
            }
          }
        });
        
        console.log('[Form 5] Transformed projects:', projects);
        console.log('[Form 5] Total projects:', projects.length);
        console.log('[Form 5] Total tasks:', projects.reduce((sum, p) => sum + (p.tasks?.length || 0), 0));
        
        if (projects.length === 0) {
          console.warn('[Form 5] No projects created after transformation');
        }
        
        return projects;
        
      } catch (error) {
        console.error('[Form 5] Error loading projects:', error);
        showToast('Không thể tải dữ liệu từ server. Vui lòng thử lại sau.', 'error');
        return [];
      }
    }
    
    // Hàm mock data để test
    function getMockF5Data() {
      return [
  {
    "Id": 3,
    "CreatedAt": "2025-11-22 04:54:06+00:00",
    "UpdatedAt": "2025-11-22 07:35:19+00:00",
    "type": null,
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "Đào Hoàng Dương",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22 11:33",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "Tác vụ thử nghiệm hệ thống",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "Đánh giá SP mới",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "Đào Hoàng Dương",
    "TaskNotes": null,
    "TaskChangeFromLastNote": "Không",
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1NPzJaZzwhP3xmXQGKI_Wief1wK0S44o1&export=download",
    "TaskDescription": null,
    "TaskPIC": "Vũ Thị Hằng",
    "TaskDepartment": null,
    "TaskCreatedAt": null,
    "TaskDueDate": null,
    "TaskStatus": null,
    "TaskPriority": null,
    "TaskForm4Data": null,
    "SubtaskName": null,
    "SubtaskPIC": null,
    "Subtaskmanhour": null,
    "Subtaskstatus": null,
    "Subtaskchecklist": null,
    "Subtasktimesend": null,
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": null,
    "Subtaskno": 0,
    "Subtaskformlink": null
  },
  {
    "Id": 7,
    "CreatedAt": "2025-11-22 07:53:04+00:00",
    "UpdatedAt": "2025-11-22 10:13:28+00:00",
    "type": "form5_subtask_send-test-task",
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "Đào Hoàng Dương",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "Tác vụ thử nghiệm hệ thống",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "Đánh giá SP mới",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "Vũ Thị Hằng",
    "TaskNotes": null,
    "TaskChangeFromLastNote": null,
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1KI59IqcDd5xCWKbUCuY9A-zSzbjUgSkO&export=download",
    "TaskDescription": "Yêu cầu đánh giá Tác vụ thử nghiệm hệ thống",
    "TaskPIC": "Vũ Thị Hằng",
    "TaskDepartment": "DQA",
    "TaskCreatedAt": "2025-11-22",
    "TaskDueDate": "2025-11-30",
    "TaskStatus": "pending",
    "TaskPriority": "Trung bình",
    "TaskForm4Data": null,
    "SubtaskName": "ádasdas",
    "SubtaskPIC": "Đào Hoàng Dương",
    "Subtaskmanhour": "7",
    "Subtaskstatus": "pending",
    "Subtaskchecklist": "QA.R.25-021521 mẫu.xlsx",
    "Subtasktimesend": "2025-11-22 14:52:00+00:00",
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": "dsadasd",
    "Subtaskno": 1,
    "Subtaskformlink": null
  },
  {
    "Id": 8,
    "CreatedAt": "2025-11-22 07:56:17+00:00",
    "UpdatedAt": "2025-11-22 10:14:23+00:00",
    "type": "form5_subtask_send-test-task",
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "Đào Hoàng Dương",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "Tác vụ thử nghiệm hệ thống",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "Đánh giá SP mới",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "Vũ Thị Hằng",
    "TaskNotes": null,
    "TaskChangeFromLastNote": null,
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1NPzJaZzwhP3xmXQGKI_Wief1wK0S44o1&export=download",
    "TaskDescription": "Yêu cầu đánh giá Tác vụ thử nghiệm hệ thống",
    "TaskPIC": "Vũ Thị Hằng",
    "TaskDepartment": "DQA",
    "TaskCreatedAt": "2025-11-22",
    "TaskDueDate": "2025-11-30",
    "TaskStatus": "pending",
    "TaskPriority": "Trung bình",
    "TaskForm4Data": null,
    "SubtaskName": "ádasdas",
    "SubtaskPIC": "Đào Hoàng Dương",
    "Subtaskmanhour": "7",
    "Subtaskstatus": "pending",
    "Subtaskchecklist": "QA.R.25-021521 mẫu.xlsx",
    "Subtasktimesend": "2025-11-22 14:52:00+00:00",
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": "dsadasd",
    "Subtaskno": 2,
    "Subtaskformlink": "https://drive.google.com/uc?id=1rrDFEdxzGLO_Vr0R5KMhnp1RECuCwJWb&export=download"
  },
  {
    "Id": 9,
    "CreatedAt": "2025-11-22 10:12:08+00:00",
    "UpdatedAt": "2025-11-22 10:14:24+00:00",
    "type": "form5_subtask_send-test-task",
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "Đào Hoàng Dương",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "Tác vụ thử nghiệm hệ thống",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "Đánh giá SP mới",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "Vũ Thị Hằng",
    "TaskNotes": null,
    "TaskChangeFromLastNote": null,
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1NPzJaZzwhP3xmXQGKI_Wief1wK0S44o1&export=download",
    "TaskDescription": "Yêu cầu đánh giá Tác vụ thử nghiệm hệ thống",
    "TaskPIC": "Vũ Thị Hằng",
    "TaskDepartment": "DQA",
    "TaskCreatedAt": "2025-11-22",
    "TaskDueDate": "2025-11-30",
    "TaskStatus": "pending",
    "TaskPriority": "Trung bình",
    "TaskForm4Data": null,
    "SubtaskName": "ádasdas",
    "SubtaskPIC": "Đào Hoàng Dương",
    "Subtaskmanhour": "7",
    "Subtaskstatus": "pending",
    "Subtaskchecklist": "QA.R.25-021521 mẫu.xlsx",
    "Subtasktimesend": "2025-11-22 14:52:00+00:00",
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": "dsadasd",
    "Subtaskno": 3,
    "Subtaskformlink": "https://drive.google.com/uc?id=19SvQ_bTJ0GVux4qQ8MLdaQPG2xqyVJY_&export=download"
  },
  {
    "Id": 10,
    "CreatedAt": "2025-11-22 10:12:29+00:00",
    "UpdatedAt": "2025-11-22 10:14:24+00:00",
    "type": "form5_subtask_send-test-task",
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "Đào Hoàng Dương",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "Tác vụ thử nghiệm hệ thống",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "Đánh giá SP mới",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "Vũ Thị Hằng",
    "TaskNotes": null,
    "TaskChangeFromLastNote": null,
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1NPzJaZzwhP3xmXQGKI_Wief1wK0S44o1&export=download",
    "TaskDescription": "Yêu cầu đánh giá Tác vụ thử nghiệm hệ thống",
    "TaskPIC": "Vũ Thị Hằng",
    "TaskDepartment": "DQA",
    "TaskCreatedAt": "2025-11-22",
    "TaskDueDate": "2025-11-30",
    "TaskStatus": "pending",
    "TaskPriority": "Trung bình",
    "TaskForm4Data": null,
    "SubtaskName": "tttttttt",
    "SubtaskPIC": "Đào Hoàng Dương",
    "Subtaskmanhour": "11",
    "Subtaskstatus": "pending",
    "Subtaskchecklist": "QA.R.25-021941.xlsx",
    "Subtasktimesend": "2025-11-22 17:11:00+00:00",
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": "adsada",
    "Subtaskno": 4,
    "Subtaskformlink": "https://drive.google.com/uc?id=1-olIvU5U9Bw99dmE1loGSyfxv0c9OIaz&export=download"
  }
];
    }

    // Helper để convert từ tasks sang projects (backward compatibility)
    function getF5AllTasks() {
      const allTasks = [];
      F5_PROJECTS.forEach(project => {
        if (project.tasks) {
          project.tasks.forEach(task => {
            allTasks.push({ ...task, projectCode: project.projectCode, projectId: project.id });
          });
        }
      });
      return allTasks;
    }

    // Helper để tìm task trong F5_PROJECTS
    function findF5Task(taskId) {
      for (const project of F5_PROJECTS) {
        if (project.tasks) {
          const task = project.tasks.find(t => t.id === taskId);
          if (task) return { task, project };
        }
      }
      return null;
    }

    // Helper để tìm project
    function findF5Project(projectId) {
      return F5_PROJECTS.find(p => p.id === projectId);
    }

    // Khởi tạo Form 5
    function initForm5() {
      const tasksTableBody = document.getElementById('f5-tasksTableBody');
      if (!tasksTableBody) return;

      // Không tự động load dữ liệu - chỉ render bảng rỗng
      renderF5TasksTable();

      // Thêm event listener cho nút Tra cứu
      const searchBtn = document.getElementById('f5-searchBtn');
      if (searchBtn) {
        searchBtn.addEventListener('click', async function() {
          const tasksTableBody = document.getElementById('f5-tasksTableBody');
          if (!tasksTableBody) return;

          // Lấy giá trị PIC từ dropdown
          const picFilter = document.getElementById('f5-filter-pic');
          const selectedPIC = picFilter ? picFilter.value.trim() : '';
          F5_FILTER_PIC = selectedPIC;

          // Disable nút và hiển thị loading
          this.disabled = true;
          const originalHTML = this.innerHTML;
          this.innerHTML = '<span class="spinner"></span><span style="margin-left:8px">Đang tải...</span>';
          
          // Hiển thị loading trong bảng
          tasksTableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500 text-base"><span class="spinner"></span><span style="margin-left:8px">Đang tải dữ liệu...</span></td></tr>';

          try {
            // Load dữ liệu từ API với filter PIC
            F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);

            // Render bảng tác vụ
            renderF5TasksTable();
          } catch (error) {
            console.error('[Form 5] Error loading data:', error);
            tasksTableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-red-500 text-base">Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại.</td></tr>';
          } finally {
            // Restore nút
            this.disabled = false;
            this.innerHTML = originalHTML;
          }
        });
      }

      // Setup Import Excel functionality
      setupF5ImportExcel();

      // Setup PIC filter
      setupF5PICFilter();
    }

    function setupF5PICFilter() {
      const picFilter = document.getElementById('f5-filter-pic');
      if (picFilter) {
        // Populate dropdown với danh sách tên cố định ngay từ đầu
        picFilter.innerHTML = '<option value="">Tất cả người nhận</option>';
        F5_PIC_LIST.forEach(pic => {
          const option = document.createElement('option');
          option.value = pic;
          option.textContent = pic;
          picFilter.appendChild(option);
        });
        
        // Event listener: khi thay đổi dropdown, tự động load lại dữ liệu với filter PIC
        picFilter.addEventListener('change', async (e) => {
          F5_FILTER_PIC = e.target.value.trim();
          
          // Hiển thị loading
          const tasksTableBody = document.getElementById('f5-tasksTableBody');
          if (tasksTableBody) {
            tasksTableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500 text-base"><span class="spinner"></span><span style="margin-left:8px">Đang tải dữ liệu...</span></td></tr>';
          }
          
          try {
            // Load dữ liệu với filter PIC
            F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);
            // Render bảng tác vụ
            renderF5TasksTable();
          } catch (error) {
            console.error('[Form 5] Error loading data with PIC filter:', error);
            if (tasksTableBody) {
              tasksTableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-red-500 text-base">Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại.</td></tr>';
            }
          }
        });
      }
    }

    function updateF5PICFilter() {
      // Hàm này không còn cần thiết vì dropdown đã được populate cố định từ đầu
      // Giữ lại để tương thích nếu có code khác gọi hàm này
      const picFilter = document.getElementById('f5-filter-pic');
      if (!picFilter) return;

      // Giữ nguyên giá trị đã chọn, không thay đổi danh sách dropdown
      // Vì danh sách đã được populate cố định từ setupF5PICFilter()
    }

    // ===== FORM 6 - DASHBOARD THỐNG KÊ =====
    
    // Khởi tạo Form 6
    function initForm6() {
      renderF6Dashboard();
      setupF6Filters();
      setupF6Search();
    }

    function renderF6Dashboard() {
      // Tính toán stats
      const runningProjects = F5_PROJECTS.filter(p => p.status === 'in_progress').length;
      const allTasks = getF5AllTasks();
      const dueSoonTasks = allTasks.filter(t => {
        if (!t.dueDate) return false;
        const dueDate = new Date(t.dueDate);
        const today = new Date();
        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        return diffDays >= 0 && diffDays <= 7 && t.status !== 'done';
      }).length;
      
      const allMembers = new Set();
      F5_PROJECTS.forEach(project => {
        if (project.pic) allMembers.add(project.pic);
        if (project.tasks) {
          project.tasks.forEach(task => {
            if (task.pic) allMembers.add(task.pic);
            if (task.subtasks) {
              task.subtasks.forEach(st => {
                if (st.pic) allMembers.add(st.pic);
              });
            }
          });
        }
      });
      
      const totalProgress = F5_PROJECTS.length > 0 
        ? Math.round(F5_PROJECTS.reduce((sum, p) => sum + calculateProjectProgress(p), 0) / F5_PROJECTS.length)
        : 0;

      // Cập nhật stats
      document.getElementById('f6-stats-running').textContent = runningProjects;
      document.getElementById('f6-stats-due').textContent = dueSoonTasks;
      document.getElementById('f6-stats-members').textContent = allMembers.size;
      document.getElementById('f6-stats-progress').textContent = `${totalProgress}%`;

      // Render bảng projects
      renderF6ProjectsTable();
    }

    function renderF6ProjectsTable(filterStatus = 'all') {
      const tbody = document.getElementById('f6-projectsTableBody');
      if (!tbody) return;

      let filteredProjects = [...F5_PROJECTS];
      if (filterStatus !== 'all') {
        filteredProjects = filteredProjects.filter(p => p.status === filterStatus);
      }

      if (filteredProjects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500 text-base">Chưa có dự án nào.</td></tr>';
        return;
      }

      tbody.innerHTML = filteredProjects.map(project => {
        const progress = calculateProjectProgress(project);
        const progressColor = progress === 100 ? 'bg-green-600' : progress >= 50 ? 'bg-primary-blue' : 'bg-yellow-500';
        const statusBadge = getF6ProjectStatusBadge(project.status);
        
        return `
          <tr class="bg-white border-b hover:bg-gray-50 transition-colors f6-project-row cursor-pointer" data-project-id="${project.id}">
            <td class="px-6 py-4">
              <div class="font-bold text-gray-900 f6-project-name">${project.projectName}</div>
              <div class="text-xs text-gray-500">${project.description || ''}</div>
            </td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <div class="w-24 bg-gray-200 rounded-full h-2">
                  <div class="${progressColor} h-2 rounded-full" style="width: ${progress}%"></div>
                </div>
                <span class="font-medium text-gray-700">${progress}%</span>
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <span class="font-medium text-gray-800">${project.pic || '-'}</span>
              </div>
            </td>
            <td class="px-6 py-4 font-medium text-gray-800">${formatF5Date(project.dueDate)}</td>
            <td class="px-6 py-4">${statusBadge}</td>
            <td class="px-6 py-4 text-right">
              <button type="button" class="f6-view-project-detail-btn text-gray-500 hover:text-gray-800" data-project-id="${project.id}">
                <span class="material-symbols-outlined">more_horiz</span>
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      // Gắn event listeners cho project rows
      setupF6ProjectEventListeners();
    }

    function getF6ProjectStatusBadge(status) {
      const statusMap = {
        'pending': { text: 'Tạm dừng', class: 'bg-yellow-100 text-yellow-700' },
        'in_progress': { text: 'Đang tiến hành', class: 'bg-purple-100 text-purple-700' },
        'done': { text: 'Hoàn thành', class: 'bg-green-100 text-green-700' }
      };
      const statusInfo = statusMap[status] || statusMap['pending'];
      return `<span class="text-xs font-medium ${statusInfo.class} py-1 px-2.5 rounded-full">${statusInfo.text}</span>`;
    }

    function setupF6Filters() {
      const filterBtns = document.querySelectorAll('.f6-filter-btn');
      filterBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const filter = e.target.closest('.f6-filter-btn').getAttribute('data-filter');
          
          // Update active state
          filterBtns.forEach(b => {
            b.classList.remove('bg-primary-blue/10');
            b.classList.add('bg-gray-100');
            const p = b.querySelector('p');
            if (p) {
              p.classList.remove('text-primary-blue', 'font-semibold');
              p.classList.add('text-gray-700', 'font-medium');
            }
          });
          
          e.target.closest('.f6-filter-btn').classList.remove('bg-gray-100');
          e.target.closest('.f6-filter-btn').classList.add('bg-primary-blue/10');
          const p = e.target.closest('.f6-filter-btn').querySelector('p');
          if (p) {
            p.classList.remove('text-gray-700', 'font-medium');
            p.classList.add('text-primary-blue', 'font-semibold');
          }
          
          renderF6ProjectsTable(filter);
        });
      });
    }

    function setupF6Search() {
      const searchInput = document.getElementById('f6-searchInput');
      if (!searchInput) return;
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        const tbody = document.getElementById('f6-projectsTableBody');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });
      });
    }


    /**
     * Cập nhật trạng thái task dựa trên subtasks
     * - Nếu có ít nhất 1 subtask → status = "in_progress" (trừ khi tất cả đều done)
     * - Nếu tất cả subtask done → status = "done"
     * - Nếu không có subtask → giữ nguyên status
     */
    function updateF5TaskStatus(taskId) {
      const result = findF5Task(taskId);
      if (!result || !result.task) return;
      
      const task = result.task;
      
      // Nếu không có subtask, giữ nguyên status
      if (!task.subtasks || task.subtasks.length === 0) {
        return;
      }

      // Kiểm tra tất cả subtask đã done chưa
      const allDone = task.subtasks.every(st => st.status === 'done');

      if (allDone) {
        task.status = 'done';
      } else {
        // Có ít nhất 1 subtask → mặc định là "in_progress"
        task.status = 'in_progress';
      }
      
      // Cập nhật project status
      updateF5ProjectStatus(result.project);
      
      // Re-render để cập nhật UI
      renderF5TasksTable();
    }

    function getF5StatusBadge(status) {
      const statusMap = {
        'pending': { text: 'Chờ xử lý', class: 'bg-gray-100 text-gray-800' },
        'in_progress': { text: 'Đang xử lý', class: 'bg-yellow-100 text-yellow-800' },
        'done': { text: 'Hoàn thành', class: 'bg-green-100 text-green-800' }
      };
      const statusInfo = statusMap[status] || statusMap['pending'];
      return `<span class="px-3 py-1 rounded-full text-xs font-semibold ${statusInfo.class}">${statusInfo.text}</span>`;
    }
    
    /**
     * Hiển thị badge trạng thái cho subtask với mapping riêng
     * @param {string} status - Trạng thái subtask (Pending, Doing, Done, Cancel)
     * @returns {string} - HTML badge
     */
    function getF5SubtaskStatusBadge(status) {
      // Chuẩn hóa status về lowercase để so sánh
      const normalizedStatus = String(status || '').toLowerCase().trim();
      
      const statusMap = {
        'pending': { text: 'Đang xử lý', class: 'bg-yellow-100 text-yellow-800' },
        'doing': { text: 'Đang triển khai', class: 'bg-blue-100 text-blue-800' },
        'in_progress': { text: 'Đang triển khai', class: 'bg-blue-100 text-blue-800' },
        'done': { text: 'Hoàn thành', class: 'bg-green-100 text-green-800' },
        'hoàn thành': { text: 'Hoàn thành', class: 'bg-green-100 text-green-800' },
        'cancel': { text: 'Hủy bỏ', class: 'bg-red-100 text-red-800' },
        'cancelled': { text: 'Hủy bỏ', class: 'bg-red-100 text-red-800' },
        'leader review': { text: 'Leader review', class: 'bg-purple-100 text-purple-800' }
      };
      
      // Kiểm tra cả giá trị gốc (không lowercase) để xử lý các trường hợp đặc biệt
      const originalStatus = String(status || '').trim();
      if (originalStatus === 'Leader review' || originalStatus === 'leader review') {
        return `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800">Leader review</span>`;
      }
      if (originalStatus === 'Hoàn thành' || originalStatus === 'hoàn thành') {
        return `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Hoàn thành</span>`;
      }
      if (originalStatus === 'Cancel' || originalStatus === 'cancel') {
        return `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">Hủy bỏ</span>`;
      }
      
      const statusInfo = statusMap[normalizedStatus] || { text: originalStatus || 'Đang xử lý', class: 'bg-gray-100 text-gray-800' };
      return `<span class="px-3 py-1 rounded-full text-xs font-semibold ${statusInfo.class}">${statusInfo.text}</span>`;
    }

    function formatF5Date(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString('vi-VN', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit' 
        });
      } catch {
        return dateStr;
      }
    }

    function calculateProjectProgress(project) {
      if (!project.tasks || project.tasks.length === 0) return 0;
      let totalSubtasks = 0;
      let doneSubtasks = 0;
      
      project.tasks.forEach(task => {
        if (task.subtasks && task.subtasks.length > 0) {
          totalSubtasks += task.subtasks.length;
          doneSubtasks += task.subtasks.filter(st => st.status === 'done').length;
        } else {
          // Nếu task không có subtask, tính task như một subtask
          totalSubtasks += 1;
          if (task.status === 'done') doneSubtasks += 1;
        }
      });
      
      return totalSubtasks > 0 ? Math.round((doneSubtasks / totalSubtasks) * 100) : 0;
    }

    function renderF5TasksTable() {
      const tbody = document.getElementById('f5-tasksTableBody');
      if (!tbody) return;

      const allTasks = getF5AllTasks();
      if (F5_PROJECTS.length === 0 || allTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500 text-base">Chưa có dữ liệu. Vui lòng nhấn nút "Tra cứu" để tải dữ liệu.</td></tr>';
        // Populate PIC filter dropdown
        updateF5PICFilter();
        return;
      }

      // Populate PIC filter dropdown
      updateF5PICFilter();

      let html = '';
      F5_PROJECTS.forEach(project => {
        // Filter theo PIC: chỉ kiểm tra task PIC (người nhận tác vụ của task chính)
        if (F5_FILTER_PIC) {
          const projectTasks = project.tasks || [];
          const hasMatchingTask = projectTasks.some(task => {
            return task.pic && task.pic.trim() === F5_FILTER_PIC;
          });
          
          if (!hasMatchingTask) {
            return; // Skip project nếu không có task nào có PIC khớp
          }
        }
        // Project row (cấp 1)
        const projectStatusClass = project.status === 'done' ? 'line-through text-gray-500' : 'text-gray-900';
        const projectTasks = project.tasks || [];
        const projectProgress = calculateProjectProgress(project);
        
        html += `
          <tr class="group hover:bg-purple-50/50 transition bg-purple-50/30" data-project-id="${project.id}">
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined cursor-pointer f5-project-expand-btn text-purple-600 ${project.expanded ? '' : 'rotate-[-90deg]'}" data-project-id="${project.id}">expand_more</span>
                <div class="flex-1">
                  <span class="font-bold text-lg ${projectStatusClass} f5-project-name cursor-pointer hover:text-blue-500" data-project-id="${project.id}">${project.projectName}</span>
                  <div class="text-xs text-gray-500 mt-0.5">Mã dự án: ${project.projectCode}</div>
                </div>
              </div>
            </td>
            <td class="px-4 py-4 text-sm text-gray-900">-</td>
            <td class="px-4 py-4 text-sm text-gray-900">
              <div>${project.pic || '-'}</div>
            </td>
            <td class="px-4 py-4 text-sm text-gray-900">-</td>
            <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(project.createdAt)}</td>
            <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(project.dueDate)}</td>
            <td class="px-4 py-4">${getF5StatusBadge(project.status)}</td>
            <td class="px-4 py-4 text-sm font-mono text-gray-600">${project.projectCode}</td>
            <td class="px-4 py-4">
              <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="text-xs text-gray-500">${projectTasks.length} tác vụ • ${projectProgress}%</span>
              </div>
            </td>
          </tr>
        `;

        // Task rows (cấp 2) - chỉ hiển thị nếu project expanded
        if (project.expanded && projectTasks.length > 0) {
          projectTasks.forEach(task => {
            // Filter theo PIC: chỉ kiểm tra task PIC (người nhận tác vụ của task chính)
            if (F5_FILTER_PIC) {
              const taskHasMatchingPIC = task.pic && task.pic.trim() === F5_FILTER_PIC;
              
              if (!taskHasMatchingPIC) {
                return; // Skip task nếu không có PIC khớp
              }
            }
            
            // Task row (cấp 2)
            const statusClass = task.status === 'done' ? 'line-through text-gray-500' : 'text-gray-900';
            html += `
              <tr class="group hover:bg-blue-50/50 transition bg-blue-50/20" data-task-id="${task.id}" data-project-id="${project.id}">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3 ml-6">
                    <span class="material-symbols-outlined cursor-pointer f5-expand-btn text-gray-500 ${task.expanded ? '' : 'rotate-[-90deg]'}" data-task-id="${task.id}">expand_more</span>
                    <div class="flex-1">
                      <span class="font-medium ${statusClass} f5-task-name cursor-pointer hover:text-blue-500" data-task-id="${task.id}">${task.taskName}</span>
                      ${task.form4Data?.itemCode ? `<div class="text-xs text-gray-500 mt-0.5">Mã SP: ${task.form4Data.itemCode}</div>` : ''}
                    </div>
                  </div>
                </td>
                <td class="px-4 py-4 text-sm text-gray-900">
                  <div class="font-medium">${task.requesterName || '-'}</div>
                  ${task.requesterEmail ? `<div class="text-xs text-gray-500 mt-0.5">${task.requesterEmail}</div>` : ''}
                </td>
                <td class="px-4 py-4 text-sm text-gray-900">${task.pic || '-'}</td>
                <td class="px-4 py-4 text-sm text-gray-900">${task.department || '-'}</td>
                <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(task.createdAt)}</td>
                <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(task.dueDate)}</td>
                <td class="px-4 py-4">${getF5StatusBadge(task.status)}</td>
                <td class="px-4 py-4 text-sm font-mono text-gray-600">${task.taskCode}</td>
                <td class="px-4 py-4">
                  <div class="flex items-center gap-2">
                    <button type="button" class="f5-add-subtask-btn flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white hover:bg-blue-700 shadow-md hover:shadow-lg transition-all transform hover:scale-110" data-task-id="${task.id}" title="Thêm tác vụ con">
                      <span class="material-symbols-outlined text-xl">add</span>
                    </button>
                    <button type="button" class="f5-view-detail-btn text-gray-500 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity" data-task-id="${task.id}">
                      <span class="material-symbols-outlined text-xl">more_horiz</span>
                    </button>
                  </div>
                </td>
              </tr>
            `;

            // Subtask rows (cấp 3) - chỉ hiển thị nếu task expanded
            if (task.expanded && task.subtasks && task.subtasks.length > 0) {
              task.subtasks.forEach((st) => {
                // Không filter subtask theo PIC - chỉ filter theo task PIC
                // Subtask sẽ hiển thị nếu task cha có PIC khớp
                
                // Chuẩn hóa status để kiểm tra done hoặc cancelled
                const normalizedSubtaskStatus = String(st.status || '').toLowerCase().trim();
                const subtaskStatusClass = (normalizedSubtaskStatus === 'done' || normalizedSubtaskStatus === 'cancel' || normalizedSubtaskStatus === 'cancelled') ? 'line-through text-gray-500' : 'text-gray-900';
                const subtaskNoDisplay = st.subtaskNo ? `<span class="text-gray-500 font-semibold">#${st.subtaskNo}</span> ` : '';
                
                // Chỉ hiển thị nút khai báo nếu subtask có type hoặc declarationMode
                const hasDeclarationMode = (st.type && st.type.startsWith('form5_subtask_')) || st.declarationMode;
                const declarationBtnHtml = hasDeclarationMode 
                  ? `<button type="button" class="f5-declaration-btn flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors shadow-sm" data-task-id="${task.id}" data-subtask-id="${st.id}" data-type="subtask" data-subtask-type="${st.type || ''}" data-declaration-mode="${st.declarationMode || ''}" title="Khai báo">
                      <span class="material-symbols-outlined text-sm">description</span>
                      <span>Khai báo</span>
                    </button>`
                  : '';
                
                html += `
                  <tr class="group hover:bg-green-50/50 transition" data-task-id="${task.id}" data-subtask-id="${st.id}">
                    <td class="px-6 py-4">
                      <div class="ml-14 flex items-center gap-3">
                        <span class="w-6"></span>
                        ${declarationBtnHtml}
                        <span class="font-normal ${subtaskStatusClass} f5-subtask-name cursor-pointer hover:text-blue-500" data-task-id="${task.id}" data-subtask-id="${st.id}">${subtaskNoDisplay}${st.name}</span>
                      </div>
                    </td>
                    <td class="px-4 py-4 text-sm text-gray-900">-</td>
                    <td class="px-4 py-4 text-sm text-gray-900">${st.pic || '-'}</td>
                    <td class="px-4 py-4 text-sm text-gray-900">-</td>
                    <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(st.timesend)}</td>
                    <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(st.dueDate)}</td>
                    <td class="px-4 py-4">${getF5SubtaskStatusBadge(st.status)}</td>
                    <td class="px-4 py-4 text-sm font-mono text-gray-600">${st.subtaskCode || '-'}</td>
                    <td class="px-4 py-4">
                      <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button type="button" class="f5-view-subtask-detail-btn text-gray-500 hover:text-blue-500" data-task-id="${task.id}" data-subtask-id="${st.id}">
                          <span class="material-symbols-outlined text-xl">more_horiz</span>
                        </button>
                      </div>
                    </td>
                  </tr>
                `;
              });

              // Row để thêm subtask mới
              html += `
                <tr class="group hover:bg-blue-50/50 transition" data-task-id="${task.id}">
                  <td class="py-3 pl-20 pr-6" colspan="9">
                    <button type="button" class="f5-add-subtask-btn flex w-full items-center justify-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg transition-all transform hover:scale-105" data-task-id="${task.id}">
                      <span class="material-symbols-outlined text-xl">add_circle</span>
                      <span>Thêm tác vụ con</span>
                    </button>
                  </td>
                </tr>
              `;
            }
          });
        }
      });

      tbody.innerHTML = html;

      // Gắn event listeners
      setupF5EventListeners();
    }

    // Event listener cho tbody - chỉ gắn một lần
    let f5TbodyListenerAttached = false;
    
    function setupF5EventListeners() {
      const tbody = document.getElementById('f5-tasksTableBody');
      if (!tbody) return;
      
      // Expand/collapse project buttons
      document.querySelectorAll('.f5-project-expand-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const projectId = e.target.getAttribute('data-project-id');
          const project = F5_PROJECTS.find(p => p.id === projectId);
          if (project) {
            project.expanded = !project.expanded;
            renderF5TasksTable();
          }
        });
      });
      
      // Expand/collapse task buttons
      document.querySelectorAll('.f5-expand-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const taskId = e.target.getAttribute('data-task-id');
          const result = findF5Task(taskId);
        const task = result ? result.task : null;
          if (task) {
            task.expanded = !task.expanded;
            renderF5TasksTable();
          }
        });
      });

      // Nút Khai báo cho tasks và subtasks - sử dụng event delegation
      if (!tbody._f5DeclarationListenerAttached) {
        tbody._f5DeclarationListenerAttached = true;
        tbody.addEventListener('click', (e) => {
          const declarationBtn = e.target.closest('.f5-declaration-btn');
          if (declarationBtn) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = declarationBtn.getAttribute('data-task-id');
            const subtaskId = declarationBtn.getAttribute('data-subtask-id');
            const type = declarationBtn.getAttribute('data-type');
            const subtaskType = declarationBtn.getAttribute('data-subtask-type');
            const declarationMode = declarationBtn.getAttribute('data-declaration-mode');
            
            if (taskId) {
              openF5SelectDeclarationModal(taskId, subtaskId || null, type, subtaskType || null, declarationMode || null);
            } else {
              console.error('[Form 5] No task-id found on declaration button');
            }
          }
        });
        console.log('[Form 5] Event listener attached to tbody for declaration buttons');
      }
      
      // Click vào tên project/task/subtask để xem chi tiết - sử dụng event delegation
      if (!tbody._f5ViewDetailListenerAttached) {
        tbody._f5ViewDetailListenerAttached = true;
        tbody.addEventListener('click', (e) => {
          // Click vào project name - toggle expand
          const projectName = e.target.closest('.f5-project-name');
          if (projectName) {
            e.preventDefault();
            e.stopPropagation();
            const projectId = projectName.getAttribute('data-project-id');
            if (projectId) {
              // Toggle expand project
              const project = F5_PROJECTS.find(p => p.id === projectId);
              if (project) {
                project.expanded = !project.expanded;
                renderF5TasksTable();
              }
            }
            return;
          }
          
          // Click vào task name
          const taskName = e.target.closest('.f5-task-name');
          if (taskName) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = taskName.getAttribute('data-task-id');
            if (taskId) {
              openF5ViewTaskDetail(taskId);
            }
            return;
          }
          
          // Click vào subtask name
          const subtaskName = e.target.closest('.f5-subtask-name');
          if (subtaskName) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = subtaskName.getAttribute('data-task-id');
            const subtaskId = subtaskName.getAttribute('data-subtask-id');
            if (taskId && subtaskId) {
              openF5ViewSubtaskDetail(taskId, subtaskId);
            }
            return;
          }
        });
        console.log('[Form 5] Event listener attached to tbody for view detail');
      }

      // Nút thêm subtask - sử dụng event delegation để tránh gắn listener nhiều lần
      if (!tbody._f5SubtaskListenerAttached) {
        tbody._f5SubtaskListenerAttached = true;
        tbody.addEventListener('click', (e) => {
          // Tìm button hoặc icon bên trong button
          const addBtn = e.target.closest('.f5-add-subtask-btn');
          const icon = e.target.closest('.material-symbols-outlined');
          
          if (addBtn) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = addBtn.getAttribute('data-task-id');
            console.log('[Form 5] Add subtask button clicked, taskId:', taskId, 'button:', addBtn);
            if (taskId) {
              openF5AddSubtaskModal(taskId);
            } else {
              console.error('[Form 5] No task-id found on button');
            }
          } else if (icon && icon.parentElement && icon.parentElement.classList.contains('f5-add-subtask-btn')) {
            // Nếu click vào icon bên trong button
            e.preventDefault();
            e.stopPropagation();
            const parentBtn = icon.parentElement;
            const taskId = parentBtn.getAttribute('data-task-id');
            console.log('[Form 5] Add subtask icon clicked, taskId:', taskId);
            if (taskId) {
              openF5AddSubtaskModal(taskId);
            } else {
              console.error('[Form 5] No task-id found on parent button');
            }
          }
        });
        console.log('[Form 5] Event listener attached to tbody for add subtask buttons');
      }

    }

    // ===== FORM 5: IMPORT EXCEL FUNCTIONALITY =====
    let F5_IMPORT_EXCEL_FILE = null;

    function setupF5ImportExcel() {
      // Nút mở modal import
      const importBtn = document.getElementById('f5-importExcelBtn');
      if (importBtn) {
        importBtn.addEventListener('click', () => {
          openF5ImportExcelModal();
        });
      }

      // Modal close buttons
      const closeBtn = document.getElementById('modal-f5-import-excel-close');
      const cancelBtn = document.getElementById('modal-f5-import-excel-cancel');
      if (closeBtn) closeBtn.addEventListener('click', closeF5ImportExcelModal);
      if (cancelBtn) cancelBtn.addEventListener('click', closeF5ImportExcelModal);

      // File input button
      const fileBtn = document.getElementById('f5-import-excel-file-btn');
      const fileInput = document.getElementById('f5-import-excel-file');
      const fileRemove = document.getElementById('f5-import-excel-file-remove');
      
      if (fileBtn && fileInput) {
        fileBtn.addEventListener('click', () => fileInput.click());
      }

      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const validExtensions = ['.xlsx', '.xls'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExt)) {
              showToast('Vui lòng chọn file Excel (.xlsx hoặc .xls)', 'error');
              fileInput.value = '';
              return;
            }

            F5_IMPORT_EXCEL_FILE = file;
            document.getElementById('f5-import-excel-file-name').textContent = file.name;
            document.getElementById('f5-import-excel-file-name').className = 'text-sm text-green-600 flex-1 font-medium';
            if (fileRemove) fileRemove.classList.remove('hidden');
            
            // Preview file
            previewF5ImportExcel(file);
          }
        });
      }

      if (fileRemove) {
        fileRemove.addEventListener('click', () => {
          if (fileInput) fileInput.value = '';
          F5_IMPORT_EXCEL_FILE = null;
          document.getElementById('f5-import-excel-file-name').textContent = 'Chưa chọn file';
          document.getElementById('f5-import-excel-file-name').className = 'text-sm text-gray-500 flex-1';
          fileRemove.classList.add('hidden');
          document.getElementById('f5-import-excel-preview').classList.add('hidden');
          document.getElementById('modal-f5-import-excel-submit').disabled = true;
        });
      }

      // Submit button
      const submitBtn = document.getElementById('modal-f5-import-excel-submit');
      if (submitBtn) {
        submitBtn.addEventListener('click', () => {
          if (F5_IMPORT_EXCEL_FILE) {
            importF5ExcelData(F5_IMPORT_EXCEL_FILE);
          }
        });
      }

      // Download template button
      const downloadTemplateBtn = document.getElementById('f5-download-template-btn');
      if (downloadTemplateBtn) {
        downloadTemplateBtn.addEventListener('click', () => {
          downloadF5ExcelTemplate();
        });
      }
    }

    function openF5ImportExcelModal() {
      const success = openModal('f5-import-excel', (modal, config) => {
        // Reset form
        F5_IMPORT_EXCEL_FILE = null;
        const fileInput = document.getElementById('f5-import-excel-file');
        if (fileInput) fileInput.value = '';
        document.getElementById('f5-import-excel-file-name').textContent = 'Chưa chọn file';
        document.getElementById('f5-import-excel-file-name').className = 'text-sm text-gray-500 flex-1';
        document.getElementById('f5-import-excel-file-remove').classList.add('hidden');
        document.getElementById('f5-import-excel-preview').classList.add('hidden');
        document.getElementById('f5-import-excel-error').classList.add('hidden');
        document.getElementById('modal-f5-import-excel-submit').disabled = true;
      });
    }

    function closeF5ImportExcelModal() {
      closeModal('f5-import-excel');
    }

    async function previewF5ImportExcel(file) {
      try {
        const data = await readExcelFile(file);
        const preview = parseF5ExcelPreview(data);
        
        const previewEl = document.getElementById('f5-import-excel-preview');
        const previewContent = document.getElementById('f5-import-excel-preview-content');
        
        previewContent.innerHTML = preview.html;
        previewEl.classList.remove('hidden');
        
        // Enable submit button if valid
        const submitBtn = document.getElementById('modal-f5-import-excel-submit');
        if (preview.valid) {
          submitBtn.disabled = false;
        } else {
          submitBtn.disabled = true;
          showF5ImportError(preview.errors);
        }
      } catch (error) {
        console.error('[Form 5] Error previewing Excel:', error);
        showF5ImportError(['Lỗi đọc file Excel: ' + error.message]);
        document.getElementById('modal-f5-import-excel-submit').disabled = true;
      }
    }

    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Lấy sheet đầu tiên
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Convert sang JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });
            resolve(jsonData);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(new Error('Lỗi đọc file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function parseF5ExcelPreview(data) {
      const errors = [];
      let projectsCount = 0;
      let tasksCount = 0;
      let subtasksCount = 0;

      if (!Array.isArray(data) || data.length === 0) {
        errors.push('File Excel không có dữ liệu hoặc format không đúng');
        return { html: '', valid: false, errors };
      }

      // Kiểm tra các cột bắt buộc
      const firstRow = data[0];
      const requiredColumns = ['Project Code', 'Task Request Code', 'Task Name'];
      const missingColumns = requiredColumns.filter(col => !(col in firstRow));
      
      if (missingColumns.length > 0) {
        errors.push(`Thiếu các cột bắt buộc: ${missingColumns.join(', ')}`);
        return { html: '<p class="text-red-600">File Excel không đúng format. Vui lòng kiểm tra lại.</p>', valid: false, errors };
      }

      // Group theo Project Code và Task Request Code
      const projectsMap = {};
      
      data.forEach((row, index) => {
        const projectCode = String(row['Project Code'] || '').trim();
        const taskRequestCode = String(row['Task Request Code'] || '').trim();
        const taskName = String(row['Task Name'] || '').trim();
        const subtaskNo = row['Subtask No'] !== undefined && row['Subtask No'] !== null 
          ? Number(row['Subtask No']) 
          : null;

        if (!projectCode || !taskRequestCode || !taskName) {
          return; // Skip invalid rows
        }

        if (!projectsMap[projectCode]) {
          projectsMap[projectCode] = {};
          projectsCount++;
        }

        if (!projectsMap[projectCode][taskRequestCode]) {
          projectsMap[projectCode][taskRequestCode] = {
            task: { name: taskName },
            subtasks: []
          };
          tasksCount++;
        }

        if (subtaskNo !== null && !isNaN(subtaskNo) && subtaskNo > 0) {
          const subtaskName = String(row['Subtask Name'] || '').trim();
          if (subtaskName) {
            projectsMap[projectCode][taskRequestCode].subtasks.push({
              no: subtaskNo,
              name: subtaskName
            });
            subtasksCount++;
          }
        }
      });

      let html = '<div class="space-y-2">';
      html += `<p class="font-semibold text-gray-700">Tổng hợp:</p>`;
      html += `<ul class="list-disc list-inside text-sm text-gray-600 space-y-1">`;
      html += `<li>Dự án: <strong>${projectsCount}</strong></li>`;
      html += `<li>Tasks: <strong>${tasksCount}</strong></li>`;
      html += `<li>Subtasks: <strong>${subtasksCount}</strong></li>`;
      html += `<li>Tổng số dòng: <strong>${data.length}</strong></li>`;
      html += `</ul>`;
      
      if (projectsCount > 0) {
        html += `<p class="font-semibold text-gray-700 mt-4">Danh sách dự án:</p>`;
        html += `<ul class="list-disc list-inside text-sm text-gray-600 space-y-1 max-h-32 overflow-y-auto">`;
        Object.keys(projectsMap).slice(0, 10).forEach(projectCode => {
          const tasks = Object.keys(projectsMap[projectCode]);
          html += `<li>${projectCode}: ${tasks.length} task(s)</li>`;
        });
        if (projectsCount > 10) {
          html += `<li>... và ${projectsCount - 10} dự án khác</li>`;
        }
        html += `</ul>`;
      }
      html += '</div>';

      return { html, valid: errors.length === 0, errors };
    }

    function showF5ImportError(errors) {
      const errorEl = document.getElementById('f5-import-excel-error');
      const errorContent = document.getElementById('f5-import-excel-error-content');
      
      if (errors && errors.length > 0) {
        errorContent.innerHTML = '<ul class="list-disc list-inside space-y-1">' + 
          errors.map(e => `<li>${e}</li>`).join('') + 
          '</ul>';
        errorEl.classList.remove('hidden');
      } else {
        errorEl.classList.add('hidden');
      }
    }

    async function importF5ExcelData(file) {
      const submitBtn = document.getElementById('modal-f5-import-excel-submit');
      const originalHTML = submitBtn.innerHTML;
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span><span style="margin-left:8px">Đang import...</span>';
        
        // Đọc file Excel
        const data = await readExcelFile(file);
        
        // Parse và import dữ liệu
        const importedProjects = parseF5ExcelData(data);
        
        if (importedProjects.length === 0) {
          showToast('Không có dữ liệu hợp lệ để import', 'warning');
          return;
        }

        // Merge với dữ liệu hiện tại (tránh trùng lặp)
        importedProjects.forEach(newProject => {
          const existingProjectIndex = F5_PROJECTS.findIndex(p => p.projectCode === newProject.projectCode);
          
          if (existingProjectIndex >= 0) {
            // Merge tasks vào project đã tồn tại
            const existingProject = F5_PROJECTS[existingProjectIndex];
            newProject.tasks.forEach(newTask => {
              const existingTaskIndex = existingProject.tasks.findIndex(t => t.taskCode === newTask.taskCode);
              
              if (existingTaskIndex >= 0) {
                // Merge subtasks vào task đã tồn tại
                const existingTask = existingProject.tasks[existingTaskIndex];
                newTask.subtasks.forEach(newSubtask => {
                  const existingSubtaskIndex = existingTask.subtasks.findIndex(
                    st => st.subtaskNo === newSubtask.subtaskNo
                  );
                  
                  if (existingSubtaskIndex >= 0) {
                    // Update subtask đã tồn tại
                    existingTask.subtasks[existingSubtaskIndex] = newSubtask;
                  } else {
                    // Thêm subtask mới
                    existingTask.subtasks.push(newSubtask);
                  }
                });
              } else {
                // Thêm task mới
                existingProject.tasks.push(newTask);
              }
            });
          } else {
            // Thêm project mới
            F5_PROJECTS.push(newProject);
          }
        });

        // Render lại bảng
        renderF5TasksTable();
        
        // Đóng modal
        closeF5ImportExcelModal();
        
        showToast(`Đã import thành công ${importedProjects.length} dự án`, 'success');
      } catch (error) {
        console.error('[Form 5] Error importing Excel:', error);
        showF5ImportError(['Lỗi import: ' + error.message]);
        showToast('Lỗi khi import dữ liệu: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
      }
    }

    function parseF5ExcelData(data) {
      const projectsMap = {};
      
      data.forEach((row, index) => {
        // Lấy các giá trị từ Excel
        const projectCode = String(row['Project Code'] || '').trim();
        const projectName = String(row['Project Name'] || '').trim() || `Dự án ${projectCode}`;
        const taskRequestCode = String(row['Task Request Code'] || '').trim();
        const taskName = String(row['Task Name'] || '').trim();
        const requesterName = String(row['Requester Name'] || '').trim();
        const requesterEmail = String(row['Requester Email'] || '').trim();
        const pic = String(row['PIC'] || row['Task PIC'] || '').trim();
        const department = String(row['Department'] || row['Task Department'] || '').trim();
        const createdAt = row['Created At'] || row['Task Created At'] || new Date().toISOString().split('T')[0];
        const dueDate = row['Due Date'] || row['Task Due Date'] || '';
        const status = String(row['Status'] || row['Task Status'] || 'pending').trim().toLowerCase();
        
        // Subtask fields
        const subtaskNo = row['Subtask No'] !== undefined && row['Subtask No'] !== null 
          ? Number(row['Subtask No']) 
          : null;
        const subtaskName = String(row['Subtask Name'] || '').trim();
        const subtaskPIC = String(row['Subtask PIC'] || '').trim();
        const subtaskManhour = row['Subtask Manhour'] !== undefined && row['Subtask Manhour'] !== null
          ? Number(row['Subtask Manhour'])
          : null;
        const subtaskStatus = String(row['Subtask Status'] || 'pending').trim().toLowerCase();
        const subtaskTimesend = row['Subtask Timesend'] || null;
        const subtaskNote = String(row['Subtask Note'] || '').trim();
        const declarationMode = String(row['Declaration Mode'] || '').trim();

        // Validate required fields
        if (!projectCode || !taskRequestCode || !taskName) {
          return; // Skip invalid rows
        }

        // Tạo hoặc lấy project
        if (!projectsMap[projectCode]) {
          projectsMap[projectCode] = {
            id: `PROJ-${projectCode}`,
            projectCode: projectCode,
            projectName: projectName,
            description: '',
            pic: pic || '',
            createdAt: formatDateForF5(createdAt),
            dueDate: formatDateForF5(dueDate),
            status: 'in_progress',
            expanded: true,
            tasks: []
          };
        }

        // Tìm hoặc tạo task
        let task = projectsMap[projectCode].tasks.find(t => t.taskCode === taskRequestCode);
        
        if (!task) {
          // Generate task ID
          const taskId = `TASK-${taskRequestCode}-${Date.now()}-${index}`;
          
          task = {
            id: taskId,
            taskCode: taskRequestCode,
            taskName: taskName,
            requesterName: requesterName || '',
            requesterEmail: requesterEmail || '',
            pic: pic || '',
            department: department || '',
            createdAt: formatDateForF5(createdAt),
            dueDate: formatDateForF5(dueDate),
            status: status || 'pending',
            expanded: true,
            subtasks: []
          };
          
          projectsMap[projectCode].tasks.push(task);
        }

        // Nếu có subtask
        if (subtaskNo !== null && !isNaN(subtaskNo) && subtaskNo > 0 && subtaskName) {
          const subtaskId = `SUBTASK-${taskRequestCode}-${subtaskNo}-${Date.now()}-${index}`;
          
          const subtask = {
            id: subtaskId,
            subtaskNo: subtaskNo,
            name: subtaskName,
            pic: subtaskPIC || '',
            manhour: subtaskManhour,
            status: subtaskStatus || 'pending',
            timesend: formatDateForF5(subtaskTimesend),
            dueDate: formatDateForF5(dueDate),
            note: subtaskNote || '',
            declarationMode: declarationMode || '',
            type: declarationMode ? `form5_subtask_${declarationMode}` : null,
            subtaskCode: `${taskRequestCode}-ST${subtaskNo}`
          };
          
          task.subtasks.push(subtask);
        }
      });

      return Object.values(projectsMap);
    }

    function formatDateForF5(dateValue) {
      if (!dateValue) return '';
      
      // Nếu là string, thử parse
      if (typeof dateValue === 'string') {
        // Nếu có format YYYY-MM-DD hoặc YYYY-MM-DD HH:mm:ss
        if (dateValue.match(/^\d{4}-\d{2}-\d{2}/)) {
          return dateValue.split(' ')[0]; // Lấy phần date
        }
        // Nếu là Excel date serial number
        if (!isNaN(dateValue)) {
          const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
          return excelDate.toISOString().split('T')[0];
        }
      }
      
      // Nếu là Date object
      if (dateValue instanceof Date) {
        return dateValue.toISOString().split('T')[0];
      }
      
      // Nếu là number (Excel serial date)
      if (typeof dateValue === 'number') {
        const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
        return excelDate.toISOString().split('T')[0];
      }
      
      return '';
    }

    function downloadF5ExcelTemplate() {
      try {
        // Tạo workbook mới
        const wb = XLSX.utils.book_new();

        // Sheet 1: Hướng dẫn
        const guideData = [
          ['HƯỚNG DẪN IMPORT TASKS TỪ EXCEL'],
          [],
          ['CÁC CỘT BẮT BUỘC (phải điền):'],
          ['1. Project Code', 'Mã dự án (ví dụ: DQA001)'],
          ['2. Task Request Code', 'Mã yêu cầu tác vụ (ví dụ: QA.SPM.1122-J8MVRM)'],
          ['3. Task Name', 'Tên tác vụ'],
          [],
          ['CÁC CỘT TÙY CHỌN:'],
          ['- Project Name', 'Tên dự án (nếu không điền sẽ tự động tạo)'],
          ['- Requester Name', 'Tên người yêu cầu'],
          ['- Requester Email', 'Email người yêu cầu'],
          ['- PIC', 'Người phụ trách'],
          ['- Department', 'Phòng ban'],
          ['- Created At', 'Ngày tạo (format: YYYY-MM-DD)'],
          ['- Due Date', 'Ngày hết hạn (format: YYYY-MM-DD)'],
          ['- Status', 'Trạng thái (pending/in_progress/done)'],
          [],
          ['ĐỂ THÊM SUBTASK:'],
          ['- Thêm dòng mới với cùng Task Request Code'],
          ['- Điền Subtask No (số > 0, ví dụ: 1, 2, 3...)'],
          ['- Điền Subtask Name và các thông tin khác'],
          [],
          ['CÁC CỘT SUBTASK TÙY CHỌN:'],
          ['- Subtask Name', 'Tên tác vụ con'],
          ['- Subtask PIC', 'Người thực hiện subtask'],
          ['- Subtask Manhour', 'Số giờ công (số)'],
          ['- Subtask Status', 'Trạng thái (pending/in_progress/done)'],
          ['- Subtask Timesend', 'Thời gian gửi (YYYY-MM-DD HH:mm:ss)'],
          ['- Subtask Note', 'Ghi chú'],
          ['- Declaration Mode', 'Chế độ khai báo (review-file-nctn/review-ce-qc/train-qc/send-test-task/review-4m/review-fmea)'],
          [],
          ['LƯU Ý:'],
          ['- Các cột bắt buộc được đánh dấu (*) trong sheet Import Tasks'],
          ['- Mỗi task có thể có nhiều subtask'],
          ['- Subtask phải có cùng Task Request Code với task cha'],
          ['- Nếu Project Code đã tồn tại, sẽ merge tasks vào project đó'],
          ['- Nếu Task Request Code đã tồn tại, sẽ merge subtasks vào task đó']
        ];
        const wsGuide = XLSX.utils.aoa_to_sheet(guideData);
        wsGuide['!cols'] = [{ wch: 25 }, { wch: 60 }];
        XLSX.utils.book_append_sheet(wb, wsGuide, 'Hướng dẫn');

        // Sheet 2: Template với dữ liệu mẫu
        const headers = [
          'Project Code *',           // Bắt buộc
          'Project Name',             // Tùy chọn
          'Task Request Code *',      // Bắt buộc
          'Task Name *',              // Bắt buộc
          'Requester Name',           // Tùy chọn
          'Requester Email',          // Tùy chọn
          'PIC',                      // Tùy chọn
          'Department',               // Tùy chọn
          'Created At',               // Tùy chọn (YYYY-MM-DD)
          'Due Date',                 // Tùy chọn (YYYY-MM-DD)
          'Status',                   // Tùy chọn (pending/in_progress/done)
          'Subtask No',               // Tùy chọn (số > 0 để tạo subtask)
          'Subtask Name',             // Tùy chọn
          'Subtask PIC',              // Tùy chọn
          'Subtask Manhour',          // Tùy chọn (số)
          'Subtask Status',           // Tùy chọn (pending/in_progress/done)
          'Subtask Timesend',         // Tùy chọn (YYYY-MM-DD HH:mm:ss)
          'Subtask Note',             // Tùy chọn
          'Declaration Mode'          // Tùy chọn
        ];

        // Dữ liệu mẫu
        const sampleData = [
          // Dòng 1: Task không có subtask
          [
            'DQA001',
            'Dự án Đánh giá Sản phẩm Mới - DQA001',
            'QA.SPM.1122-J8MVRM',
            'Tác vụ thử nghiệm hệ thống',
            'Đào Hoàng Dương',
            'duong.dao@karofi.vn',
            'Vũ Thị Hằng',
            'DQA',
            '2025-11-22',
            '2025-11-30',
            'in_progress',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            ''
          ],
          // Dòng 2: Subtask 1 của task trên
          [
            'DQA001',
            '',
            'QA.SPM.1122-J8MVRM',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            1,
            'Kiểm tra độ kín',
            'Đào Hoàng Dương',
            8.5,
            'pending',
            '2025-11-22 14:52:00',
            'Ghi chú cho subtask',
            'send-test-task'
          ],
          // Dòng 3: Subtask 2 của task trên
          [
            'DQA001',
            '',
            'QA.SPM.1122-J8MVRM',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            2,
            'Kiểm tra độ bền',
            'Vũ Thị Hằng',
            6.0,
            'in_progress',
            '2025-11-23 09:00:00',
            '',
            'review-ce-qc'
          ],
          // Dòng 4: Task mới khác
          [
            'DQA002',
            'Dự án Đánh giá Sản phẩm SOP - DQA002',
            'QA.SOP.1122-ABC123',
            'Tác vụ đánh giá SOP',
            'Nguyễn Văn A',
            'a.nguyen@karofi.vn',
            'Nguyễn Thị B',
            'DQA',
            '2025-11-23',
            '2025-12-01',
            'pending',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            ''
          ]
        ];

        // Tạo worksheet từ dữ liệu
        const wsData = [headers, ...sampleData];
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Set column widths
        ws['!cols'] = [
          { wch: 15 },  // Project Code *
          { wch: 40 },  // Project Name
          { wch: 25 },  // Task Request Code *
          { wch: 30 },  // Task Name *
          { wch: 20 },  // Requester Name
          { wch: 25 },  // Requester Email
          { wch: 18 },  // PIC
          { wch: 15 },  // Department
          { wch: 12 },  // Created At
          { wch: 12 },  // Due Date
          { wch: 12 },  // Status
          { wch: 12 },  // Subtask No
          { wch: 25 },  // Subtask Name
          { wch: 18 },  // Subtask PIC
          { wch: 15 },  // Subtask Manhour
          { wch: 15 },  // Subtask Status
          { wch: 20 },  // Subtask Timesend
          { wch: 30 },  // Subtask Note
          { wch: 20 }   // Declaration Mode
        ];

        // Thêm sheet vào workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Import Tasks');

        // Tạo tên file
        const filename = 'Form5_Import_Template.xlsx';

        // Xuất file
        XLSX.writeFile(wb, filename);

        showToast('Đã tải file mẫu thành công. Vui lòng xem sheet "Hướng dẫn" để biết thêm chi tiết.', 'success');
      } catch (error) {
        console.error('[Form 5] Error generating template:', error);
        showToast('Lỗi khi tạo file mẫu: ' + error.message, 'error');
      }
    }
    // ===== END FORM 5: IMPORT EXCEL FUNCTIONALITY =====

    // Cập nhật các hàm khác để dùng findF5Task
    function updateF5TaskStatus(taskId) {
      const result = findF5Task(taskId);
      if (!result || !result.task) return;
      
      const task = result.task;
      
      // Nếu không có subtask, giữ nguyên status
      if (!task.subtasks || task.subtasks.length === 0) {
        return;
      }

      // Kiểm tra tất cả subtask đã done chưa
      const allDone = task.subtasks.every(st => st.status === 'done');

      if (allDone) {
        task.status = 'done';
      } else {
        // Có ít nhất 1 subtask → mặc định là "in_progress"
        task.status = 'in_progress';
      }

      // Cập nhật project status nếu cần
      updateF5ProjectStatus(result.project);
      
      // Re-render để cập nhật UI
      renderF5TasksTable();
    }

    function updateF5ProjectStatus(project) {
      if (!project || !project.tasks || project.tasks.length === 0) return;
      
      const allDone = project.tasks.every(t => t.status === 'done');
      const hasInProgress = project.tasks.some(t => t.status === 'in_progress' || t.status === 'done');
      
      if (allDone) {
        project.status = 'done';
      } else if (hasInProgress) {
        project.status = 'in_progress';
      } else {
        project.status = 'pending';
      }
    }

    function getF5PriorityBadge(priority) {
      const priorityMap = {
        'Cao': { class: 'bg-red-100 text-red-800', text: 'Cao' },
        'Trung bình': { class: 'bg-yellow-100 text-yellow-800', text: 'Trung bình' },
        'Thấp': { class: 'bg-gray-100 text-gray-800', text: 'Thấp' }
      };
      const priorityInfo = priorityMap[priority] || priorityMap['Trung bình'];
      return `<span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${priorityInfo.class}">${priorityInfo.text}</span>`;
    }

    // Hàm mở modal thêm subtask - Sử dụng hệ thống modal tập trung
    function openF5AddSubtaskModal(taskId) {
      console.log('[Form 5] openF5AddSubtaskModal called with taskId:', taskId);
      
      // Sử dụng hệ thống modal tập trung với callback để setup form
      const success = openModal('f5-add-subtask', (modal, config) => {
        const result = findF5Task(taskId);
        console.log('[Form 5] Task lookup result:', result);
        
        let taskName = 'Tác vụ';
        if (result && result.task) {
          taskName = result.task.taskName || 'Tác vụ';
        } else {
          console.warn('[Form 5] Task not found, using default name');
        }
        
        // Hiển thị tên task cha
        const parentTaskNameEl = document.getElementById('modal-f5-add-subtask-parent-task-name');
        if (parentTaskNameEl) {
          parentTaskNameEl.textContent = taskName;
        }
        
        // Lưu task ID vào hidden input
        const taskIdInput = document.getElementById('modal-f5-add-subtask-task-id');
        if (taskIdInput) {
          taskIdInput.value = taskId;
        }
        
        // Set thời gian gửi mặc định = giờ hiện tại
        const timesendInput = document.getElementById('modal-f5-add-subtask-timesend');
        if (timesendInput) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          // Format: YYYY-MM-DDTHH:mm
          timesendInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Reset form về trạng thái ban đầu
        const form = document.getElementById('modal-f5-add-subtask-form');
        if (form) {
          form.reset();
          // Set lại thời gian gửi sau khi reset
          const timesendInputAfterReset = document.getElementById('modal-f5-add-subtask-timesend');
          if (timesendInputAfterReset) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            timesendInputAfterReset.value = `${year}-${month}-${day}T${hours}:${minutes}`;
          }
        }
      });
      
      if (!success) {
        console.error('[Form 5] Failed to open modal');
        alert('Không thể mở modal. Vui lòng kiểm tra lại.');
      }
    }

    // Hàm đóng modal thêm subtask - Sử dụng hệ thống modal tập trung
    function closeF5AddSubtaskModal() {
      closeModal('f5-add-subtask');
    }
    
    // Hàm mở modal chọn chế độ khai báo (chỉ dùng cho task parent)
    function openF5SelectDeclarationModal(taskId, subtaskId = null, type = 'parent', subtaskType = null, declarationMode = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      
      // Nếu là subtask, luôn mở trực tiếp modal khai báo với chế độ đã chọn khi tạo
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) {
          // Ưu tiên dùng declarationMode từ parameter, sau đó từ subtask object
          let mode = declarationMode || subtask.declarationMode;
          
          // Nếu không có declarationMode, thử extract từ type
          if (!mode && (subtaskType || subtask.type)) {
            const typeToCheck = subtaskType || subtask.type;
            if (typeToCheck && typeToCheck.startsWith('form5_subtask_')) {
              mode = typeToCheck.replace('form5_subtask_', '');
            }
          }
          
          if (mode) {
            // Mở trực tiếp modal khai báo với chế độ đã chọn khi tạo subtask
            handleF5DeclarationModeSelect(mode, taskId, subtaskId);
            return;
          } else {
            // Nếu subtask không có declarationMode (trường hợp cũ), hiển thị thông báo
            showToast('Tác vụ con này chưa có chế độ khai báo. Vui lòng tạo lại tác vụ con với chế độ khai báo.', 'error');
            return;
          }
        }
      }
      
      // Chỉ task parent mới mở modal chọn chế độ
      const taskName = task.taskName || 'Tác vụ';
      
      // Sử dụng hệ thống modal tập trung
      const success = openModal('f5-select-declaration', (modal, config) => {
        // Hiển thị tên task
        const taskNameEl = document.getElementById('modal-f5-select-declaration-task-name');
        if (taskNameEl) {
          taskNameEl.textContent = taskName;
        }
        
        // Lưu thông tin vào data attributes của modal để dùng sau
        modal.setAttribute('data-task-id', taskId);
        modal.setAttribute('data-type', 'parent');
      });
      
      if (!success) {
        console.error('[Form 5] Failed to open select declaration modal');
      }
    }
    
    // Hàm đóng modal chọn chế độ khai báo
    function closeF5SelectDeclarationModal() {
      closeModal('f5-select-declaration');
    }
    
    // Hàm xử lý khi chọn chế độ khai báo
    function handleF5DeclarationModeSelect(mode, taskId, subtaskId = null) {
      console.log('[Form 5] Declaration mode selected:', mode, 'taskId:', taskId, 'subtaskId:', subtaskId);
      
      // Đóng modal chọn chế độ
      closeF5SelectDeclarationModal();
      
      // Mở modal khai báo tương ứng
      switch(mode) {
        case 'review-file-nctn':
          openF5DeclarationReviewFileNCTNModal(taskId, subtaskId);
          break;
        case 'review-ce-qc':
          openF5DeclarationReviewCEQCModal(taskId, subtaskId);
          break;
        case 'train-qc':
          openF5DeclarationTrainQCModal(taskId, subtaskId);
          break;
        case 'send-test-task':
          openF5DeclarationSendTestTaskModal(taskId, subtaskId);
          break;
        case 'review-4m':
          openF5DeclarationReview4MModal(taskId, subtaskId);
          break;
        case 'review-fmea':
          openF5DeclarationReviewFMEAModal(taskId, subtaskId);
          break;
        default:
          showToast('Chế độ khai báo không hợp lệ', 'error');
      }
    }
    
    // Hàm mở modal: Rà soát file với NCTN
    function openF5DeclarationReviewFileNCTNModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'Tác vụ';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-review-file-nctn', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-review-file-nctn-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open review-file-nctn modal');
    }
    
    // Hàm mở modal: Gửi rà soát CE với QC
    function openF5DeclarationReviewCEQCModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'Tác vụ';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-review-ce-qc', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-review-ce-qc-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open review-ce-qc modal');
    }
    
    // Hàm mở modal: Đào tạo QC
    function openF5DeclarationTrainQCModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'Tác vụ';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-train-qc', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-train-qc-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open train-qc modal');
    }
    
    // Hàm mở modal: Gửi tác vụ thử nghiệm
    function openF5DeclarationSendTestTaskModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'Tác vụ';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-send-test-task', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-send-test-task-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
        
        // Điền dữ liệu subtask vào form
        if (subtaskId && task.subtasks) {
          const subtask = task.subtasks.find(st => st.id === subtaskId);
          if (subtask) {
            // Hiển thị thông tin project và task cha (read-only)
            const projectNameEl = document.getElementById('modal-f5-declaration-send-test-task-project-name');
            const projectCodeEl = document.getElementById('modal-f5-declaration-send-test-task-project-code');
            const parentTaskNameEl = document.getElementById('modal-f5-declaration-send-test-task-parent-task-name');
            const parentTaskCodeEl = document.getElementById('modal-f5-declaration-send-test-task-parent-task-code');
            
            if (result.project) {
              if (projectNameEl) projectNameEl.textContent = result.project.projectName || '-';
              if (projectCodeEl) projectCodeEl.textContent = result.project.projectCode || '-';
            }
            if (parentTaskNameEl) parentTaskNameEl.textContent = task.taskName || '-';
            if (parentTaskCodeEl) parentTaskCodeEl.textContent = task.taskCode || '-';
            
            // Điền dữ liệu subtask vào các input có thể chỉnh sửa
            const subtaskNameInput = document.getElementById('modal-f5-declaration-send-test-task-subtask-name');
            const subtaskItemCodeInput = document.getElementById('modal-f5-declaration-send-test-task-subtask-item-code');
            const subtaskNoInput = document.getElementById('modal-f5-declaration-send-test-task-subtask-no');
            const subtaskPicInput = document.getElementById('modal-f5-declaration-send-test-task-subtask-pic');
            const subtaskManhourInput = document.getElementById('modal-f5-declaration-send-test-task-subtask-manhour');
            const subtaskTimesendInput = document.getElementById('modal-f5-declaration-send-test-task-subtask-timesend');
            const subtaskChecklistInput = document.getElementById('modal-f5-declaration-send-test-task-subtask-checklist');
            const subtaskNoteTextarea = document.getElementById('modal-f5-declaration-send-test-task-subtask-note');
            const checklistCurrentEl = document.getElementById('modal-f5-declaration-send-test-task-checklist-current');
            
            if (subtaskNameInput) subtaskNameInput.value = subtask.name || '';
            if (subtaskItemCodeInput) subtaskItemCodeInput.value = subtask.itemCode || '';
            if (subtaskNoInput) subtaskNoInput.value = subtask.subtaskNo ? `#${subtask.subtaskNo}` : '';
            if (subtaskPicInput) subtaskPicInput.value = subtask.pic || '';
            if (subtaskManhourInput) subtaskManhourInput.value = subtask.manhour || '';
            
            // Thời gian gửi mặc định là thời điểm mở modal
            if (subtaskTimesendInput) {
              const now = new Date();
              const year = now.getFullYear();
              const month = String(now.getMonth() + 1).padStart(2, '0');
              const day = String(now.getDate()).padStart(2, '0');
              const hours = String(now.getHours()).padStart(2, '0');
              const minutes = String(now.getMinutes()).padStart(2, '0');
              subtaskTimesendInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
            
            if (subtaskNoteTextarea) subtaskNoteTextarea.value = subtask.note || '';
            
            // Hiển thị file checklist hiện tại và link
            const checklistNameEl = document.getElementById('modal-f5-declaration-send-test-task-checklist-name');
            const checklistLinkEl = document.getElementById('modal-f5-declaration-send-test-task-checklist-link');
            
            if (subtask.checklist || subtask.checklistLink) {
              // Hiển thị tên file
              if (checklistNameEl) {
                checklistNameEl.textContent = subtask.checklist || 'File đã tải lên';
              }
              
              // Hiển thị link download nếu có
              if (checklistLinkEl && subtask.checklistLink) {
                checklistLinkEl.href = subtask.checklistLink;
                checklistLinkEl.classList.remove('hidden');
                checklistLinkEl.textContent = `Tải xuống: ${subtask.checklist || 'File'}`;
              } else if (checklistLinkEl) {
                checklistLinkEl.classList.add('hidden');
              }
            } else {
              if (checklistNameEl) checklistNameEl.textContent = '-';
              if (checklistLinkEl) checklistLinkEl.classList.add('hidden');
            }
          }
        }
      });
      
      if (!success) console.error('[Form 5] Failed to open send-test-task modal');
    }
    
    // Hàm tạo mã QA.NB.DDMM-xxxxxx
    function generateQANBCode() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const ddmm = day + month;
      
      // Tạo 6 ký tự ngẫu nhiên (số và chữ)
      const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let randomPart = '';
      for (let i = 0; i < 6; i++) {
        randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      return `QA.NB.${ddmm}-${randomPart}`;
    }

    // Hàm helper tạo timestamp dạng YYYY-MM-DD HH:mm
    function getCurrentTimestamp() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    
    // Hàm xử lý submit cho modal send-test-task
    async function handleF5SendTestTaskSubmit(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const modal = document.getElementById('modal-f5-declaration-send-test-task');
      if (!modal) {
        console.error('[Form 5] Modal not found');
        return;
      }
      
      const taskId = modal.getAttribute('data-task-id');
      const subtaskId = modal.getAttribute('data-subtask-id');
      
      if (!taskId || !subtaskId) {
        showToast('Thiếu thông tin tác vụ hoặc tác vụ con', 'error');
        return;
      }
      
      // Lấy dữ liệu từ form
      const subtaskStatus = document.getElementById('modal-f5-declaration-send-test-task-status')?.value?.trim();
      const subtaskResultLink = document.getElementById('modal-f5-declaration-send-test-task-result-link')?.value?.trim();
      
      // Validate
      if (!subtaskStatus) {
        showToast('Vui lòng chọn trạng thái', 'error');
        return;
      }
      
      // Tìm subtask và project để lấy thông tin
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const projectCode = result.project?.projectCode || null;
      const taskRequestCode = result.task.taskCode || '';
      
      // Lấy ID thực của subtask từ database (subtaskId có dạng "SUB-xxx", cần lấy phần sau)
      const subtaskDbId = subtaskId.replace('SUB-', '');
      
      // Tìm task ID thực từ database để làm parent_id
      const taskDbId = taskId.replace('TASK-', '');
      
      // Lấy mã tác vụ từ subtask đã có (đã được tạo khi thêm tác vụ con)
      // Nếu subtask chưa có mã, thì tạo mới (trường hợp cũ)
      let qaNbCode = null;
      if (result.task.subtasks) {
        const subtask = result.task.subtasks.find(st => st.id === subtaskId);
        if (subtask && subtask.taskCode) {
          qaNbCode = subtask.taskCode; // Sử dụng mã đã có từ khi thêm tác vụ con
        }
      }
      // Nếu không có mã, tạo mới (trường hợp cũ - backward compatibility)
      if (!qaNbCode) {
        qaNbCode = generateQANBCode();
      }
      
      // Lấy thông tin subtask hiện tại để giữ lại các trường khác
      let currentSubtask = null;
      if (result.task.subtasks) {
        currentSubtask = result.task.subtasks.find(st => st.id === subtaskId);
      }
      
      // Chuẩn bị dữ liệu subtask đã chỉnh sửa
      const subtaskData = {
        name: currentSubtask?.name || '',
        pic: currentSubtask?.pic || '',
        manhour: currentSubtask?.manhour || null,
        dueDate: null,
        status: subtaskStatus, // Trạng thái từ form
        timesend: currentSubtask?.timesend || null,
        finishTime: null,
        note: currentSubtask?.note || '',
        checklist: currentSubtask?.checklist || '',
        subtaskNo: currentSubtask?.subtaskNo || null,
        declarationMode: 'send-test-task',
        taskCode: qaNbCode,
        itemCode: currentSubtask?.itemCode || '',
        resultLink: subtaskResultLink || '' // Link kết quả
      };
      
      // Format theo NocoDB để gửi yêu cầu cập nhật subtask
      // parentTaskId ở đây là ID của task cha trong database
      const formattedData = formatSubtaskToNocoDB(subtaskData, taskDbId, projectCode);
      
      // Thêm ID của subtask để cập nhật (không phải tạo mới)
      formattedData.Id = subtaskDbId;
      
      // Thêm TaskRequestCode để webhook biết task cha
      formattedData.TaskRequestCode = taskRequestCode;
      
      // Thêm mã QA.NB vào dữ liệu gửi lên (có thể lưu vào TaskCode hoặc một trường riêng)
      formattedData.TaskCode = qaNbCode;
      
      // Thêm dữ liệu task chính (parent task) vào payload
      const taskData = {
        Id: taskDbId,
        TaskRequestCode: taskRequestCode,
        TaskCode: result.task.taskCode || '',
        TaskName: result.task.taskName || '',
        TaskItemName: result.task.taskName || '',
        TaskItemCode: result.task.form4Data?.itemCode || '',
        TaskRequesterName: result.task.requesterName || '',
        TaskRequesterEmail: result.task.requesterEmail || '',
        TaskRequestDate: result.task.createdAt || '',
        TaskDeptRequest: result.task.department || '',
        TaskPurpose: result.task.form4Data?.purpose || '',
        TaskPIC: result.task.pic || '',
        TaskStatus: result.task.status || 'pending',
        TaskPriority: result.task.priority || 'Trung bình',
        TaskDueDate: result.task.dueDate || null,
        TaskDescription: result.task.description || '',
        TaskAttachments: result.task.form4Data?.attachments || '', // File đính kèm từ task
        project_code: projectCode || null,
        TaskForm4Data: result.task.form4Data ? JSON.stringify(result.task.form4Data) : null
      };
      
      // Thêm taskData vào payload
      formattedData.taskData = taskData;
      
      // Thêm timestamp dạng YYYY-MM-DD HH:mm
      formattedData.timestamp = getCurrentTimestamp();
      
      // Hiển thị loading
      const submitBtn = document.getElementById('modal-f5-declaration-send-test-task-submit');
      const originalText = submitBtn?.textContent;
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang gửi yêu cầu...';
      }
      
      try {
        // Gửi lên webhook để submit declaration
        const endpoint = 'https://iatzhxxuk.tino.page/webhook/form5-declaration-submit';
        
        // Gửi JSON như bình thường
        console.log('[Form 5] Sending declaration (JSON)');
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formattedData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseData = await response.json();
        console.log('[Form 5] Subtask updated:', responseData);
        
        // Hiển thị mã đã tạo trong toast
        showToast(`Đã gửi yêu cầu thành công. Mã tác vụ: ${qaNbCode}`, 'success', 5000);
        
        // Đóng modal
        closeModal('f5-declaration-send-test-task');
        
        // Reload dữ liệu từ server để hiển thị cập nhật
        try {
          const taskIdToExpand = taskId;
          F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);
          
          const resultAfterReload = findF5Task(taskIdToExpand);
          if (resultAfterReload && resultAfterReload.task) {
            resultAfterReload.task.expanded = true;
            if (resultAfterReload.project) {
              resultAfterReload.project.expanded = true;
            }
          }
          
          renderF5TasksTable();
        } catch (reloadError) {
          console.error('[Form 5] Failed to reload data:', reloadError);
          showToast('Đã gửi yêu cầu nhưng không thể tải lại dữ liệu. Vui lòng làm mới trang.', 'warning');
          renderF5TasksTable();
        }
        
      } catch (error) {
        console.error('[Form 5] Failed to submit subtask update:', error);
        showToast('Gửi yêu cầu thất bại. Vui lòng thử lại.', 'error');
      } finally {
        // Restore button
        if (submitBtn) {
          submitBtn.disabled = false;
          if (originalText) submitBtn.textContent = originalText;
        }
      }
    }
    
    // Hàm mở modal: Rà soát 4M
    function openF5DeclarationReview4MModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'Tác vụ';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-review-4m', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-review-4m-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open review-4m modal');
    }
    
    // Hàm mở modal: Rà soát FMEA
    function openF5DeclarationReviewFMEAModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'Tác vụ';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-review-fmea', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-review-fmea-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open review-fmea modal');
    }
    
    // ============================================
    // HÀM HIỂN THỊ CHI TIẾT PROJECT/TASK/SUBTASK
    // ============================================
    
    // Hàm mở modal chi tiết project
    function openF5ViewProjectDetail(projectId) {
      const project = F5_PROJECTS.find(p => p.id === projectId);
      if (!project) {
        showToast('Không tìm thấy dự án', 'error');
        return;
      }
      
      const success = openModal('f5-view-detail', (modal, config) => {
        const titleEl = document.getElementById('modal-f5-view-detail-title');
        const subtitleEl = document.getElementById('modal-f5-view-detail-subtitle');
        const bodyEl = document.getElementById('modal-f5-view-detail-body');
        
        if (titleEl) titleEl.textContent = 'Chi tiết Dự án';
        if (subtitleEl) subtitleEl.textContent = project.projectCode;
        
        if (bodyEl) {
          const tasks = project.tasks || [];
          const progress = calculateProjectProgress(project);
          
          bodyEl.innerHTML = `
            <div class="space-y-6">
              <!-- Thông tin cơ bản -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Tên dự án</label>
                  <p class="text-base font-semibold text-gray-900 mt-1">${project.projectName || '-'}</p>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Mã dự án</label>
                  <p class="text-base font-mono text-gray-900 mt-1">${project.projectCode || '-'}</p>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Người phụ trách</label>
                  <p class="text-base text-gray-900 mt-1">${project.pic || '-'}</p>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Trạng thái</label>
                  <div class="mt-1">${getF5StatusBadge(project.status)}</div>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Ngày tạo</label>
                  <p class="text-base text-gray-900 mt-1">${formatF5Date(project.createdAt) || '-'}</p>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Ngày hết hạn</label>
                  <p class="text-base text-gray-900 mt-1">${formatF5Date(project.dueDate) || '-'}</p>
                </div>
                <div class="md:col-span-2">
                  <label class="text-xs font-semibold text-gray-500 uppercase">Mô tả</label>
                  <p class="text-base text-gray-900 mt-1">${project.description || '-'}</p>
                </div>
              </div>
              
              <!-- Thống kê -->
              <div class="border-t border-gray-200 pt-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Thống kê</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-xs text-gray-600">Tổng số task</p>
                    <p class="text-2xl font-bold text-blue-600 mt-1">${tasks.length}</p>
                  </div>
                  <div class="bg-green-50 rounded-lg p-4">
                    <p class="text-xs text-gray-600">Tiến độ</p>
                    <p class="text-2xl font-bold text-green-600 mt-1">${progress}%</p>
                  </div>
                  <div class="bg-yellow-50 rounded-lg p-4">
                    <p class="text-xs text-gray-600">Đang xử lý</p>
                    <p class="text-2xl font-bold text-yellow-600 mt-1">${tasks.filter(t => t.status === 'in_progress').length}</p>
                  </div>
                  <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-xs text-gray-600">Hoàn thành</p>
                    <p class="text-2xl font-bold text-gray-600 mt-1">${tasks.filter(t => t.status === 'done').length}</p>
                  </div>
                </div>
              </div>
              
              <!-- Danh sách tasks -->
              ${tasks.length > 0 ? `
                <div class="border-t border-gray-200 pt-4">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">Danh sách Task (${tasks.length})</h3>
                  <div class="space-y-2">
                    ${tasks.map(task => `
                      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex-1">
                          <p class="font-medium text-gray-900">${task.taskName || '-'}</p>
                          <p class="text-xs text-gray-500 mt-0.5">${task.taskCode || '-'}</p>
                        </div>
                        <div class="flex items-center gap-3">
                          ${getF5StatusBadge(task.status)}
                          <button type="button" class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="openF5ViewTaskDetail('${task.id}'); closeModal('f5-view-detail');">Xem chi tiết</button>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }
      });
      
      if (!success) console.error('[Form 5] Failed to open project detail modal');
    }
    
    // Hàm mở modal chi tiết task
    function openF5ViewTaskDetail(taskId) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      const project = result.project;
      const form4Data = task.form4Data || {};
      
      const success = openModal('f5-view-detail', (modal, config) => {
        const titleEl = document.getElementById('modal-f5-view-detail-title');
        const subtitleEl = document.getElementById('modal-f5-view-detail-subtitle');
        const bodyEl = document.getElementById('modal-f5-view-detail-body');
        
        if (titleEl) titleEl.textContent = 'Chi tiết Task';
        if (subtitleEl) subtitleEl.textContent = task.taskCode || '';
        
        if (bodyEl) {
          const subtasks = task.subtasks || [];
          
          bodyEl.innerHTML = `
            <div class="space-y-6">
              <!-- Thông tin cơ bản Task -->
              <div class="border-b border-gray-200 pb-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Thông tin Task</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Tên task</label>
                    <p class="text-base font-semibold text-gray-900 mt-1">${task.taskName || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Mã task</label>
                    <p class="text-base font-mono text-gray-900 mt-1">${task.taskCode || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Người phụ trách</label>
                    <p class="text-base text-gray-900 mt-1">${task.pic || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Trạng thái</label>
                    <div class="mt-1">${getF5StatusBadge(task.status)}</div>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Ưu tiên</label>
                    <div class="mt-1">${getF5PriorityBadge(task.priority)}</div>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Ngày hết hạn</label>
                    <p class="text-base text-gray-900 mt-1">${formatF5Date(task.dueDate) || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Người yêu cầu</label>
                    <p class="text-base text-gray-900 mt-1">${task.requesterName || '-'}</p>
                    ${task.requesterEmail ? `<p class="text-xs text-gray-500 mt-0.5">${task.requesterEmail}</p>` : ''}
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Phòng ban</label>
                    <p class="text-base text-gray-900 mt-1">${task.department || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Nhà cung cấp</label>
                    <p class="text-base text-gray-900 mt-1">${task.vendor || task.form4Data?.vendor || '-'}</p>
                  </div>
                  <div class="md:col-span-2">
                    <label class="text-xs font-semibold text-gray-500 uppercase">Mô tả</label>
                    <p class="text-base text-gray-900 mt-1">${task.description || '-'}</p>
                  </div>
                </div>
              </div>
              
              <!-- Thông tin từ Form 4 -->
              ${Object.keys(form4Data).length > 0 ? `
                <div class="border-b border-gray-200 pb-4">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">Thông tin từ Form 4</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${form4Data.itemName ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Tên sản phẩm/linh kiện</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.itemName}</p>
                      </div>
                    ` : ''}
                    ${form4Data.itemCode ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Mã sản phẩm/linh kiện</label>
                        <p class="text-base font-mono text-gray-900 mt-1">${form4Data.itemCode}</p>
                      </div>
                    ` : ''}
                    ${form4Data.componentType ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Loại linh kiện</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.componentType}</p>
                      </div>
                    ` : ''}
                    ${form4Data.componentStandard ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Công chuẩn</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.componentStandard} giờ</p>
                      </div>
                    ` : ''}
                    ${form4Data.purpose ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Mục đích</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.purpose}</p>
                      </div>
                    ` : ''}
                    ${form4Data.vendor ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Nhà cung cấp</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.vendor}</p>
                      </div>
                    ` : ''}
                    ${form4Data.qtySamples ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Số lượng mẫu</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.qtySamples}</p>
                      </div>
                    ` : ''}
                    ${form4Data.requestDate ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Ngày yêu cầu</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.requestDate}</p>
                      </div>
                    ` : ''}
                    ${form4Data.attachments ? `
                      <div class="md:col-span-2">
                        <label class="text-xs font-semibold text-gray-500 uppercase">File đính kèm</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.attachments}</p>
                      </div>
                    ` : ''}
                    ${form4Data.changeReq ? `
                      <div class="md:col-span-2">
                        <label class="text-xs font-semibold text-gray-500 uppercase">Ghi chú</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.changeReq}</p>
                      </div>
                    ` : ''}
                  </div>
                </div>
              ` : ''}
              
              <!-- Danh sách Subtasks -->
              ${subtasks.length > 0 ? `
                <div class="border-t border-gray-200 pt-4">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">Danh sách Subtask (${subtasks.length})</h3>
                  <div class="space-y-2">
                    ${subtasks.map(subtask => {
                      const modeNames = {
                        'review-file-nctn': 'Rà soát file với NCTN',
                        'review-ce-qc': 'Gửi rà soát CE với QC',
                        'train-qc': 'Đào tạo QC',
                        'send-test-task': 'Gửi tác vụ thử nghiệm',
                        'review-4m': 'Rà soát 4M',
                        'review-fmea': 'Rà soát FMEA'
                      };
                      return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                          <div class="flex-1">
                            <p class="font-medium text-gray-900">${subtask.name || '-'}</p>
                            <div class="flex items-center gap-3 mt-1">
                              <span class="text-xs text-gray-500">PIC: ${subtask.pic || '-'}</span>
                              ${subtask.declarationMode ? `<span class="text-xs text-blue-600">${modeNames[subtask.declarationMode] || subtask.declarationMode}</span>` : ''}
                            </div>
                          </div>
                          <div class="flex items-center gap-3">
                            ${getF5SubtaskStatusBadge(subtask.status)}
                            <button type="button" class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="openF5ViewSubtaskDetail('${taskId}', '${subtask.id}'); closeModal('f5-view-detail');">Xem chi tiết</button>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              ` : '<div class="border-t border-gray-200 pt-4"><p class="text-gray-500">Chưa có subtask nào</p></div>'}
            </div>
          `;
        }
      });
      
      if (!success) console.error('[Form 5] Failed to open task detail modal');
    }
    
    // Hàm mở modal chi tiết subtask
    function openF5ViewSubtaskDetail(taskId, subtaskId) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      const subtask = task.subtasks ? task.subtasks.find(st => st.id === subtaskId) : null;
      
      if (!subtask) {
        showToast('Không tìm thấy subtask', 'error');
        return;
      }
      
      const modeNames = {
        'review-file-nctn': 'Rà soát file với NCTN',
        'review-ce-qc': 'Gửi rà soát CE với QC',
        'train-qc': 'Đào tạo QC',
        'send-test-task': 'Gửi tác vụ thử nghiệm',
        'review-4m': 'Rà soát 4M',
        'review-fmea': 'Rà soát FMEA'
      };
      
      const success = openModal('f5-view-detail', (modal, config) => {
        const titleEl = document.getElementById('modal-f5-view-detail-title');
        const subtitleEl = document.getElementById('modal-f5-view-detail-subtitle');
        const bodyEl = document.getElementById('modal-f5-view-detail-body');
        
        if (titleEl) titleEl.textContent = 'Chi tiết Subtask';
        if (subtitleEl) subtitleEl.textContent = `Task: ${task.taskName || task.taskCode || ''}`;
        
        if (bodyEl) {
          bodyEl.innerHTML = `
            <div class="space-y-6">
              <!-- Thông tin cơ bản Subtask -->
              <div class="border-b border-gray-200 pb-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Thông tin Subtask</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Tên subtask</label>
                    <p class="text-base font-semibold text-gray-900 mt-1">${subtask.name || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Chế độ khai báo</label>
                    <p class="text-base text-blue-600 font-medium mt-1">${subtask.declarationMode ? (modeNames[subtask.declarationMode] || subtask.declarationMode) : '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Người thực hiện</label>
                    <p class="text-base text-gray-900 mt-1">${subtask.pic || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Trạng thái</label>
                    <div class="mt-1">${getF5SubtaskStatusBadge(subtask.status)}</div>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Ưu tiên</label>
                    <div class="mt-1">${getF5PriorityBadge(subtask.priority)}</div>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Ngày hết hạn</label>
                    <p class="text-base text-gray-900 mt-1">${formatF5Date(subtask.dueDate) || '-'}</p>
                  </div>
                </div>
              </div>
              
              <!-- Thông tin Task cha -->
              <div class="border-t border-gray-200 pt-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Thông tin Task cha</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Tên task</label>
                    <p class="text-base font-semibold text-gray-900 mt-1">${task.taskName || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Mã task</label>
                    <p class="text-base font-mono text-gray-900 mt-1">${task.taskCode || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Người phụ trách</label>
                    <p class="text-base text-gray-900 mt-1">${task.pic || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Trạng thái</label>
                    <div class="mt-1">${getF5StatusBadge(task.status)}</div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
      });
      
      if (!success) console.error('[Form 5] Failed to open subtask detail modal');
    }

    // Xử lý submit form thêm subtask
    /**
     * Gửi subtask lên NocoDB
     * @param {Object} subtaskData - Dữ liệu subtask đã format theo schema NocoDB
     * @returns {Promise<Object>} - Response từ NocoDB API
     */
    /**
     * Gửi Subtask lên server
     * @param {Object} subtaskData - Dữ liệu subtask đã format
     * @returns {Promise<Object>} - Response từ server
     */
    /**
     * Gửi Subtask lên server (không có file)
     * @param {Object} subtaskData - Dữ liệu subtask đã format
     * @param {Object} taskData - Dữ liệu task cha
     * @returns {Promise<Object>} - Response từ server
     */
    async function submitSubtaskToNocoDB(subtaskData, taskData) {
      const endpoint = 'https://iatzhxxuk.tino.page/webhook/form5-subtask-create';
      
      try {
        // Kết hợp dữ liệu subtask và task cha
        const payload = {
          ...subtaskData,
          taskData: taskData // Thêm dữ liệu task cha
        };
        
        console.log('[Form 5] Sending subtask data with task data to server:', payload);
        console.log('[Form 5] Endpoint:', endpoint);
        console.log('[Form 5] Payload size:', JSON.stringify(payload).length, 'bytes');
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        console.log('[Form 5] Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        
        const result = await response.json();
        console.log('[Form 5] Subtask created successfully:', result);
        return result;
      } catch (error) {
        console.error('[Form 5] Error creating subtask:', error);
        throw error;
      }
    }
    
    /**
     * Gửi Subtask với file đính kèm lên server
     * @param {FormData} formData - FormData chứa dữ liệu subtask, task và file
     * @returns {Promise<Object>} - Response từ server
     */
    async function submitSubtaskToNocoDBWithFile(formData) {
      const endpoint = 'https://iatzhxxuk.tino.page/webhook/form5-subtask-create';
      
      try {
        // Log thông tin file trong FormData
        const fileEntry = formData.get('checklistFile');
        console.log('[Form 5] Sending subtask data with file and task data to server');
        console.log('[Form 5] File info:', {
          fileName: fileEntry?.name || 'N/A',
          fileSize: fileEntry?.size || 'N/A',
          fileType: fileEntry?.type || 'N/A',
          isFile: fileEntry instanceof File
        });
        
        // Log tất cả keys trong FormData để debug
        const formDataEntries = [];
        for (const [key, value] of formData.entries()) {
          if (value instanceof File) {
            formDataEntries.push({ key, type: 'File', name: value.name, size: value.size });
          } else {
            formDataEntries.push({ key, type: typeof value, value: String(value).substring(0, 100) });
          }
        }
        console.log('[Form 5] FormData entries:', formDataEntries);
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Accept': 'application/json'
            // Không set Content-Type, browser sẽ tự động set với boundary cho FormData
          },
          body: formData
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        
        const result = await response.json();
        console.log('[Form 5] Subtask with file created successfully:', result);
        return result;
      } catch (error) {
        console.error('[Form 5] Error creating subtask with file:', error);
        throw error;
      }
    }
    
    function handleF5AddSubtaskSubmit(e) {
      e.preventDefault();
      
      const taskId = document.getElementById('modal-f5-add-subtask-task-id').value;
      const result = findF5Task(taskId);
      
      if (!result || !result.task) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }
      
      const task = result.task;
      
      // Lấy giá trị từ các input với kiểm tra null
      const getNameEl = () => document.getElementById('modal-f5-add-subtask-name');
      const getItemCodeEl = () => document.getElementById('modal-f5-add-subtask-item-code');
      const getPicEl = () => document.getElementById('modal-f5-add-subtask-pic');
      const getManhourEl = () => document.getElementById('modal-f5-add-subtask-manhour');
      const getTimesendEl = () => document.getElementById('modal-f5-add-subtask-timesend');
      const getChecklistEl = () => document.getElementById('modal-f5-add-subtask-checklist');
      const getNoteEl = () => document.getElementById('modal-f5-add-subtask-note');
      const getDeclarationModeEl = () => document.getElementById('modal-f5-add-subtask-declaration-mode');
      
      const subtaskName = (getNameEl()?.value || '').trim();
      const subtaskItemCode = (getItemCodeEl()?.value || '').trim();
      const subtaskPic = getPicEl()?.value || '';
      const subtaskManhour = getManhourEl()?.value || '';
      const subtaskNote = (getNoteEl()?.value || '').trim();
      const subtaskDeclarationMode = getDeclarationModeEl()?.value || '';
      
      // Lấy thời gian gửi (mặc định là giờ hiện tại nếu không có giá trị)
      let subtaskTimesend = getTimesendEl()?.value || '';
      if (!subtaskTimesend) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        subtaskTimesend = `${year}-${month}-${day}T${hours}:${minutes}`;
      }
      
      // Lấy file checklist
      const checklistFileInput = getChecklistEl();
      const checklistFile = checklistFileInput?.files?.[0] || null;
      const checklistFileName = checklistFile ? checklistFile.name : '';
      
      if (!subtaskName) {
        showToast('Vui lòng nhập tên tác vụ con', 'error');
        return;
      }
      
      if (!subtaskDeclarationMode) {
        showToast('Vui lòng chọn chế độ khai báo', 'error');
        return;
      }
      
      // Lấy project_code từ task (có thể từ form4Data hoặc project)
      const projectCode = task.form4Data?.projectCode || result.project?.projectCode || null;
      
      // Lấy parent_id thực tế từ database (Id của task trong dqa_tasks)
      // taskId có dạng "TASK-xxx", cần lấy phần sau để có ID thực trong database
      const parentTaskId = taskId.replace('TASK-', '');
      
      if (!parentTaskId) {
        console.error('[Form 5] Cannot get parentTaskId from taskId:', taskId);
        showToast('Không thể xác định ID tác vụ cha. Vui lòng thử lại.', 'error');
        return;
      }
      
      console.log('[Form 5] Creating subtask with parentTaskId:', parentTaskId, 'taskId:', taskId);
      
      // Tính số thứ tự subtask (Subtaskno) - số thứ tự của subtask trong task
      // Subtaskno = 0 là task chính, 1, 2, 3... là các subtask
      const existingSubtasks = task.subtasks || [];
      // Tìm số Subtaskno lớn nhất hiện có (chỉ tính subtask có Subtaskno > 0)
      const maxSubtaskNo = existingSubtasks.reduce((max, st) => {
        const no = st.subtaskNo || 0;
        return no > max ? no : max;
      }, 0);
      const subtaskNo = maxSubtaskNo + 1; // Subtask số tiếp theo (bắt đầu từ 1)
      
      // Tạo mã QA.NB.DDMM-xxxxxx khi thêm tác vụ con
      const qaNbCode = generateQANBCode();
      
      // Format dữ liệu theo schema NocoDB
      const subtaskDataForDB = formatSubtaskToNocoDB({
        name: subtaskName,
        pic: subtaskPic,
        manhour: subtaskManhour || null,
        status: 'Leader review', // Mặc định Leader review khi tạo mới
        checklist: checklistFileName || '', // Tên file checklist
        timesend: subtaskTimesend || null,
        finishTime: null, // Không cần khi tạo mới
        note: subtaskNote || '',
        priority: 'Trung bình', // Mặc định
        declarationMode: subtaskDeclarationMode,
        subtaskNo: subtaskNo, // Số thứ tự subtask
        itemCode: subtaskItemCode || '', // Mã linh kiện/sản phẩm
        taskCode: qaNbCode // Thêm mã QA.NB.DDMM-xxxxxx
      }, parentTaskId, projectCode);
      
      // Format dữ liệu task cha để gửi kèm
      const taskDataForDB = {
        TaskRequestCode: task.taskCode || '',
        TaskRequesterName: task.requesterName || '',
        TaskRequesterEmail: task.requesterEmail || '',
        TaskRequestDate: task.createdAt || '',
        TaskDeptRequest: task.department || '',
        TaskItemName: task.taskName || '',
        TaskItemCode: task.form4Data?.itemCode || '',
        TaskComponentType: task.form4Data?.componentType || '',
        TaskComponentStandard: task.form4Data?.componentStandard || '',
        TaskPurpose: task.form4Data?.purpose || '',
        TaskVendor: task.form4Data?.vendor || '',
        TaskQtySamples: task.form4Data?.qtySamples || '',
        TaskDesiredDate: task.dueDate || '',
        TaskPersonReceived: task.pic || '',
        TaskNotes: task.form4Data?.changeReq || '',
        TaskAppliedModel: task.form4Data?.appliedModel || '',
        TaskAttachments: task.form4Data?.attachments || '',
        TaskCode: task.taskCode || '',
        TaskName: task.taskName || '',
        TaskDescription: task.description || '',
        TaskPIC: task.pic || '',
        TaskDepartment: task.department || '',
        TaskCreatedAt: task.createdAt || '',
        TaskDueDate: task.dueDate || '',
        TaskStatus: task.status || 'pending',
        TaskPriority: task.priority || 'Trung bình',
        project_code: projectCode || null
      };
      
      // Log dữ liệu trước khi gửi để debug
      console.log('[Form 5] Submitting subtask data:', {
        subtaskDataForDB,
        taskDataForDB,
        parentTaskId,
        projectCode,
        hasFile: !!checklistFile
      });
      
      // Gửi lên server - nếu có file thì dùng FormData, không thì dùng JSON
      let submitPromise;
      if (checklistFile) {
        // Tạo FormData để gửi file
        const formData = new FormData();
        // Thêm dữ liệu subtask
        Object.keys(subtaskDataForDB).forEach(key => {
          const value = subtaskDataForDB[key];
          if (value !== null && value !== undefined) {
            // Chuyển đổi object/array thành JSON string nếu cần
            const valueToAppend = typeof value === 'object' ? JSON.stringify(value) : value;
            formData.append(key, valueToAppend);
          }
        });
        // Thêm dữ liệu task cha
        Object.keys(taskDataForDB).forEach(key => {
          const value = taskDataForDB[key];
          if (value !== null && value !== undefined) {
            const valueToAppend = typeof value === 'object' ? JSON.stringify(value) : value;
            formData.append(`taskData.${key}`, valueToAppend);
          }
        });
        // Thêm file checklist với tên field đúng
        formData.append('checklistFile', checklistFile, checklistFile.name);
        console.log('[Form 5] Sending with FormData (has file):', {
          fileName: checklistFile.name,
          fileSize: checklistFile.size,
          fileType: checklistFile.type,
          formDataKeys: Array.from(formData.keys())
        });
        submitPromise = submitSubtaskToNocoDBWithFile(formData);
      } else {
        // Gửi JSON với dữ liệu subtask và task cha
        console.log('[Form 5] Sending with JSON (no file)');
        submitPromise = submitSubtaskToNocoDB(subtaskDataForDB, taskDataForDB);
      }
      
      // Đóng modal trước khi gửi
      closeF5AddSubtaskModal();
      
      // Hiển thị loading indicator
      const tbody = document.getElementById('f5-tasksTableBody');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500 text-base"><span class="spinner"></span><span style="margin-left:8px">Đang lưu tác vụ con...</span></td></tr>';
      }
      
      // Gửi lên server và reload dữ liệu từ server (KHÔNG render local)
      submitPromise
        .then(async (dbResult) => {
          console.log('[Form 5] Subtask saved to server:', dbResult);
          
          // Nếu server trả về Subtaskformlink từ việc upload file, cập nhật lại subtask với link đó
          if (dbResult && dbResult.Subtaskformlink && checklistFile) {
            try {
              const subtaskId = dbResult.Id || dbResult.id;
              if (subtaskId) {
                // Cập nhật subtask với link file
                const updateData = {
                  Id: subtaskId,
                  Subtaskformlink: dbResult.Subtaskformlink
                };
                const updateEndpoint = 'https://iatzhxxuk.tino.page/webhook/form5-subtask-update';
                const updateResponse = await fetch(updateEndpoint, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(updateData)
                });
                if (updateResponse.ok) {
                  console.log('[Form 5] Subtaskformlink updated successfully:', dbResult.Subtaskformlink);
                } else {
                  console.warn('[Form 5] Failed to update Subtaskformlink:', await updateResponse.text());
                }
              }
            } catch (updateError) {
              console.error('[Form 5] Error updating Subtaskformlink:', updateError);
              // Không throw error, chỉ log để không làm gián đoạn flow chính
            }
          }
          
          // Reload dữ liệu từ server để hiển thị subtask mới
          try {
            // Lưu taskId để expand sau khi reload
            const taskIdToExpand = taskId;
            
            // Reload dữ liệu từ server
            F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);
            
            // Tìm lại task sau khi reload và expand nó để hiển thị subtask mới
            const resultAfterReload = findF5Task(taskIdToExpand);
            if (resultAfterReload && resultAfterReload.task) {
              resultAfterReload.task.expanded = true;
              // Đảm bảo project cũng được expand
              if (resultAfterReload.project) {
                resultAfterReload.project.expanded = true;
              }
            }
            
            // Render lại bảng với dữ liệu từ server
            renderF5TasksTable();
      showToast(`Đã thêm tác vụ con thành công. Mã tác vụ: ${qaNbCode}`, 'success');
          } catch (reloadError) {
            console.error('[Form 5] Failed to reload data:', reloadError);
            showToast('Đã lưu tác vụ con nhưng không thể tải lại dữ liệu. Vui lòng làm mới trang.', 'warning');
            // Render lại với dữ liệu cũ
            renderF5TasksTable();
          }
        })
        .catch((error) => {
          console.error('[Form 5] Failed to save subtask to server:', error);
          console.error('[Form 5] Error details:', {
            message: error.message,
            stack: error.stack,
            subtaskData: subtaskDataForDB,
            taskData: taskDataForDB
          });
          showToast(`Lưu tác vụ con thất bại: ${error.message || 'Vui lòng thử lại.'}`, 'error');
          // Render lại với dữ liệu cũ (từ server, không phải local)
          renderF5TasksTable();
        });
    }

    // Khởi tạo event listeners cho modal Form 5 - Sử dụng hệ thống modal tập trung
    document.addEventListener('DOMContentLoaded', function() {
      // Khởi tạo modal listeners cho Form 5 Add Subtask
      initModalListeners('f5-add-subtask');
      
      // Khởi tạo modal listeners cho Form 5 Select Declaration
      initModalListeners('f5-select-declaration');
      
      // Khởi tạo modal listeners cho các modal khai báo Form 5
      initModalListeners('f5-declaration-review-file-nctn');
      initModalListeners('f5-declaration-review-ce-qc');
      initModalListeners('f5-declaration-train-qc');
      initModalListeners('f5-declaration-send-test-task');
      initModalListeners('f5-declaration-review-4m');
      initModalListeners('f5-declaration-review-fmea');
      
      // Khởi tạo modal listeners cho modal xem chi tiết
      initModalListeners('f5-view-detail');
      
      // Xử lý submit form
      const addSubtaskForm = document.getElementById('modal-f5-add-subtask-form');
      if (addSubtaskForm && !addSubtaskForm._submitListenerAttached) {
        addSubtaskForm._submitListenerAttached = true;
        addSubtaskForm.addEventListener('submit', handleF5AddSubtaskSubmit);
        console.log('[Form 5] Form submit listener attached');
      }
      
      // Xử lý chọn chế độ khai báo
      document.addEventListener('click', function(e) {
        const modeBtn = e.target.closest('.f5-declaration-mode-btn');
        if (modeBtn) {
          e.preventDefault();
          e.stopPropagation();
          
          const mode = modeBtn.getAttribute('data-mode');
          const modal = document.getElementById('modal-f5-select-declaration');
          if (modal) {
            const taskId = modal.getAttribute('data-task-id');
            const subtaskId = modal.getAttribute('data-subtask-id');
            
            if (taskId && mode) {
              handleF5DeclarationModeSelect(mode, taskId, subtaskId || null);
            } else {
              console.error('[Form 5] Missing taskId or mode');
            }
          }
        }
      });
      
      // Xử lý submit cho modal send-test-task
      const sendTestTaskSubmitBtn = document.getElementById('modal-f5-declaration-send-test-task-submit');
      if (sendTestTaskSubmitBtn && !sendTestTaskSubmitBtn._submitListenerAttached) {
        sendTestTaskSubmitBtn._submitListenerAttached = true;
        sendTestTaskSubmitBtn.addEventListener('click', handleF5SendTestTaskSubmit);
        console.log('[Form 5] Send test task submit listener attached');
      }
      
      // Test: Thêm hàm global để test modal
      window.testF5Modal = function() {
        console.log('[Form 5] Test function called');
        const firstTask = F5_PROJECTS[0]?.tasks?.[0];
        if (firstTask) {
          openF5AddSubtaskModal(firstTask.id);
        } else {
          openF5AddSubtaskModal('TASK-001');
        }
      };
      console.log('[Form 5] Test function available: window.testF5Modal()');
    });

    function renderF6Dashboard() {
      // Tính toán stats
      const runningProjects = F5_PROJECTS.filter(p => p.status === 'in_progress').length;
      const allTasks = getF5AllTasks();
      const dueSoonTasks = allTasks.filter(t => {
        if (!t.dueDate) return false;
        const dueDate = new Date(t.dueDate);
        const today = new Date();
        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        return diffDays >= 0 && diffDays <= 7 && t.status !== 'done';
      }).length;
      
      const allMembers = new Set();
      F5_PROJECTS.forEach(project => {
        if (project.pic) allMembers.add(project.pic);
        if (project.tasks) {
          project.tasks.forEach(task => {
            if (task.pic) allMembers.add(task.pic);
            if (task.subtasks) {
              task.subtasks.forEach(st => {
                if (st.pic) allMembers.add(st.pic);
              });
            }
          });
        }
      });
      
      const totalProgress = F5_PROJECTS.length > 0 
        ? Math.round(F5_PROJECTS.reduce((sum, p) => sum + calculateProjectProgress(p), 0) / F5_PROJECTS.length)
        : 0;

      // Cập nhật stats
      const statsRunning = document.getElementById('f6-stats-running');
      const statsDue = document.getElementById('f6-stats-due');
      const statsMembers = document.getElementById('f6-stats-members');
      const statsProgress = document.getElementById('f6-stats-progress');
      
      if (statsRunning) statsRunning.textContent = runningProjects;
      if (statsDue) statsDue.textContent = dueSoonTasks;
      if (statsMembers) statsMembers.textContent = allMembers.size;
      if (statsProgress) statsProgress.textContent = `${totalProgress}%`;

      // Render bảng projects
      renderF6ProjectsTable();
    }

    function renderF6ProjectsTable(filterStatus = 'all') {
      const tbody = document.getElementById('f6-projectsTableBody');
      if (!tbody) return;

      let filteredProjects = [...F5_PROJECTS];
      if (filterStatus !== 'all') {
        filteredProjects = filteredProjects.filter(p => p.status === filterStatus);
      }

      if (filteredProjects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500 text-base">Chưa có dự án nào.</td></tr>';
        return;
      }

      tbody.innerHTML = filteredProjects.map(project => {
        const progress = calculateProjectProgress(project);
        const progressColor = progress === 100 ? 'bg-green-600' : progress >= 50 ? 'bg-primary-blue' : 'bg-yellow-500';
        const statusBadge = getF6ProjectStatusBadge(project.status);
        
        return `
          <tr class="bg-white border-b hover:bg-gray-50 transition-colors f6-project-row cursor-pointer" data-project-id="${project.id}">
            <td class="px-6 py-4">
              <div class="font-bold text-gray-900 f6-project-name">${project.projectName}</div>
              <div class="text-xs text-gray-500">${project.description || ''}</div>
            </td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <div class="w-24 bg-gray-200 rounded-full h-2">
                  <div class="${progressColor} h-2 rounded-full" style="width: ${progress}%"></div>
                </div>
                <span class="font-medium text-gray-700">${progress}%</span>
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <span class="font-medium text-gray-800">${project.pic || '-'}</span>
              </div>
            </td>
            <td class="px-6 py-4 font-medium text-gray-800">${formatF5Date(project.dueDate)}</td>
            <td class="px-6 py-4">${statusBadge}</td>
            <td class="px-6 py-4 text-right">
              <button type="button" class="f6-view-project-detail-btn text-gray-500 hover:text-gray-800" data-project-id="${project.id}">
                <span class="material-symbols-outlined">more_horiz</span>
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      // Gắn event listeners cho project rows
      setupF6ProjectEventListeners();
    }

    function getF6ProjectStatusBadge(status) {
      const statusMap = {
        'pending': { text: 'Tạm dừng', class: 'bg-yellow-100 text-yellow-700' },
        'in_progress': { text: 'Đang tiến hành', class: 'bg-purple-100 text-purple-700' },
        'done': { text: 'Hoàn thành', class: 'bg-green-100 text-green-700' }
      };
      const statusInfo = statusMap[status] || statusMap['pending'];
      return `<span class="text-xs font-medium ${statusInfo.class} py-1 px-2.5 rounded-full">${statusInfo.text}</span>`;
    }

    function setupF6Filters() {
      const filterBtns = document.querySelectorAll('.f6-filter-btn');
      filterBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const filterBtn = e.target.closest('.f6-filter-btn');
          if (!filterBtn) return;
          const filter = filterBtn.getAttribute('data-filter');
          
          // Update active state
          filterBtns.forEach(b => {
            b.classList.remove('bg-primary-blue/10');
            b.classList.add('bg-gray-100');
            const p = b.querySelector('p');
            if (p) {
              p.classList.remove('text-primary-blue', 'font-semibold');
              p.classList.add('text-gray-700', 'font-medium');
            }
          });
          
          filterBtn.classList.remove('bg-gray-100');
          filterBtn.classList.add('bg-primary-blue/10');
          const p = filterBtn.querySelector('p');
          if (p) {
            p.classList.remove('text-gray-700', 'font-medium');
            p.classList.add('text-primary-blue', 'font-semibold');
          }
          
          renderF6ProjectsTable(filter);
        });
      });
    }

    function setupF6Search() {
      const searchInput = document.getElementById('f6-searchInput');
      if (!searchInput) return;
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        const tbody = document.getElementById('f6-projectsTableBody');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });
      });
    }

    // Event listener cho tbody Form 6 - chỉ gắn một lần
    let f6TbodyListenerAttached = false;
    
    function setupF6ProjectEventListeners() {
      const tbody = document.getElementById('f6-projectsTableBody');
      if (!tbody) return;
      
      // Chỉ gắn listener một lần
      if (f6TbodyListenerAttached) return;
      f6TbodyListenerAttached = true;
      
    }


  </script>

</body>
</html>


