<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>C·ªïng T√°c V·ª• DQA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script id="tailwind-config">
    // ƒê·∫£m b·∫£o Tailwind ƒë√£ load tr∆∞·ªõc khi config
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#4A90E2",
              "accent": "#9013FE",
              "background-light": "#f7f8fc",
              "surface-light": "#ffffff",
              "card-light": "#ffffff",
              "text-light-primary": "#111827",
              "text-light-secondary": "#6b7280",
              "border-light": "#e5e7eb",
              "danger": "#ef4444",
              'primary-blue': '#5aa9ff',
              'sidebar': '#f0f7ff',
              'sidebar-hover': '#e0f0ff',
              'muted': '#f7f8fc'
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {
              "DEFAULT": "0.75rem",
              "lg": "1rem",
              "xl": "1.5rem",
              "full": "9999px"
            },
            boxShadow: {
              'soft': '0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05)',
            }
          },
        },
      };
    } else {
      // N·∫øu Tailwind ch∆∞a load, th·ª≠ l·∫°i sau khi DOM ready
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof tailwind !== 'undefined') {
          tailwind.config = {
            darkMode: "class",
            theme: {
              extend: {
                colors: {
                  "primary": "#4A90E2",
                  "accent": "#9013FE",
                  "background-light": "#f7f8fc",
                  "surface-light": "#ffffff",
                  "card-light": "#ffffff",
                  "text-light-primary": "#111827",
                  "text-light-secondary": "#6b7280",
                  "border-light": "#e5e7eb",
                  "danger": "#ef4444",
                  'primary-blue': '#5aa9ff',
                  'sidebar': '#ffffff',
                  'sidebar-hover': '#f3f4f6',
                  'muted': '#f7f8fc'
                },
                fontFamily: {
                  "display": ["Inter", "sans-serif"]
                },
                borderRadius: {
                  "DEFAULT": "0.75rem",
                  "lg": "1rem",
                  "xl": "1.5rem",
                  "full": "9999px"
                },
                boxShadow: {
                  'soft': '0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05)',
                }
              },
            },
          };
        }
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style type="text/tailwindcss">
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24;
      font-size: inherit;
    }
      .spinner{border:2px solid #e5e7eb;border-top:2px solid #3b82f6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
      @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
      /* Christmas decorations */
      .christmas-tree{display:inline-block;animation:sway 2s ease-in-out infinite;transform-origin:center bottom}
      .christmas-star{display:inline-block;animation:twinkle 1.5s ease-in-out infinite}
      .snowflake{display:inline-block;animation:float 3s ease-in-out infinite;opacity:0.8}
      @keyframes sway{0%,100%{transform:rotate(-3deg)}50%{transform:rotate(3deg)}}
      @keyframes twinkle{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.6;transform:scale(1.2)}}
      @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
    .header-container{background:linear-gradient(135deg,#2563eb 0%,#60a5fa 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .modal.open{display:flex}
    .section-title{display:flex;align-items:center;gap:8px}
    .section-title .badge{background:rgba(90,169,255,.15);color:#1e40af;border:1px solid rgba(90,169,255,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .submit-btn{background:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);box-shadow:0 4px 6px rgba(37,99,235,.1),0 1px 3px rgba(37,99,235,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(37,99,235,.12),0 3px 6px rgba(37,99,235,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s;z-index:999999 !important}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Sidebar effects for groups */
    .group-btn{ 
      position:relative; 
      transition: all 0.2s ease;
    }
    .group-btn.active{ 
      background:rgba(74,144,226,.1); 
      color:#4A90E2; 
    }
    .group-btn.active .material-symbols-outlined{ 
      font-variation-settings: 'FILL' 1; 
    }
    .group-items{ 
      transition: all .2s ease;
      overflow: hidden;
      max-height: 1000px;
      opacity: 1;
    }
    .group-items.collapsed {
      max-height: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
    }
    .group-btn .group-expand-icon {
      transition: transform 0.2s ease;
    }
    .group-btn.collapsed .group-expand-icon {
      transform: rotate(-90deg);
    }
    .group-items .nav-btn{ 
      background: transparent; 
      transition: all 0.2s ease;
      border-radius: 0.5rem;
    }
    .group-items .nav-btn:hover{ 
      background: rgba(90,169,255,0.08); 
      transform: translateX(2px);
    }
    .group-items .nav-btn.active{ 
      background:rgba(74,144,226,.1); 
      color:#4A90E2; 
      font-weight: 600;
    }
    /* ·∫®n label Ph√≤ng DQA trong header */
    .header-container .flex.items-center.space-x-2,
    .header-container .inline-block[style*="rgba(255,255,255,0.15)"],
    .header-container .inline-block.px-3.py-1.rounded-full {
      display: none !important;
    }
    /* Sidebar styles */
    #sidebar-nav {
      position: sticky;
      top: 0;
      align-self: flex-start;
      max-height: 100vh;
      overflow-y: auto;
      background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
      box-shadow: 2px 0 8px rgba(0,0,0,0.08), 4px 0 16px rgba(0,0,0,0.04);
      border-right: 1px solid #e2e8f0;
    }
    /* C·∫£i thi·ªán c√°c m·ª•c trong sidebar */
    #sidebar-nav .group-btn {
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      background: rgba(59, 130, 246, 0.1);
      color: #1e40af;
      font-weight: 600;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    #sidebar-nav .group-btn:hover {
      background: rgba(59, 130, 246, 0.2);
      transform: translateX(1px);
      border-color: rgba(59, 130, 246, 0.3);
    }
    /* Group ri√™ng bi·ªát cho Qu·∫£n l√Ω c√¥ng vi·ªác SPM */
    #sidebar-nav .group-btn[data-group="spm-group"] {
      background: rgba(147, 51, 234, 0.1);
      color: #6b21a8;
      border-color: rgba(147, 51, 234, 0.2);
    }
    #sidebar-nav .group-btn[data-group="spm-group"]:hover {
      background: rgba(147, 51, 234, 0.2);
      border-color: rgba(147, 51, 234, 0.3);
    }
    /* Group ri√™ng bi·ªát cho T√°c v·ª• chuy·ªÉn ti·∫øp SOP */
    #sidebar-nav .group-btn[data-group="sop-group"] {
      background: rgba(234, 179, 8, 0.1);
      color: #a16207;
      border-color: rgba(234, 179, 8, 0.2);
    }
    #sidebar-nav .group-btn[data-group="sop-group"]:hover {
      background: rgba(234, 179, 8, 0.2);
      border-color: rgba(234, 179, 8, 0.3);
    }
    /* Group ri√™ng bi·ªát cho C√¥ng c·ª• h·ªó tr·ª£ */
    #sidebar-nav .group-btn[data-group="tools-group"] {
      background: rgba(34, 197, 94, 0.1);
      color: #15803d;
      border-color: rgba(34, 197, 94, 0.2);
    }
    #sidebar-nav .group-btn[data-group="tools-group"]:hover {
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.3);
    }
    #sidebar-nav .nav-btn {
      margin-bottom: 0.125rem;
      padding: 0.625rem 0.75rem;
      transition: all 0.2s ease;
      background: transparent;
      color: #334155;
      font-weight: 500;
    }
    #sidebar-nav .nav-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #1e40af;
    }
    #sidebar-nav .nav-btn.active {
      background: rgba(59, 130, 246, 0.15);
      color: #1e40af;
      font-weight: 600;
    }
    /* C·∫£i thi·ªán m√†u ch·ªØ cho c√°c item trong group */
    #sidebar-nav .group-items .nav-btn {
      color: #475569;
      font-weight: 500;
    }
    #sidebar-nav .group-items .nav-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #1e40af;
    }
    #sidebar-nav nav {
      gap: 0.375rem;
    }
    /* ============================================ */
    /* MODAL SYSTEM - CSS RULES */
    /* ============================================ */
    
    /* Base styles cho t·∫•t c·∫£ modal containers */
    .modal-container {
      position: fixed;
      inset: 0;
      z-index: 9999;
    }
    
    .modal-container:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      pointer-events: auto;
      z-index: 9998;
    }
    
    /* Modal content container */
    .modal-content {
      position: relative;
      z-index: 9999;
    }
    
    /* Specific modal styles */
    #modal-f2-declaration:not(.hidden),
    #modal-f5-add-subtask:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      z-index: 9999 !important;
    }
    
    /* Overlay styles */
    #modal-f2-declaration-overlay,
    #modal-f5-add-subtask-overlay {
      pointer-events: auto;
      display: block !important;
      z-index: 9998 !important;
    }
    
    /* Override Tailwind hidden class */
    #modal-f2-declaration[style*="display: block"],
    #modal-f2-declaration[style*="display: flex"],
    #modal-f5-add-subtask[style*="display: block"],
    #modal-f5-add-subtask[style*="display: flex"] {
      display: block !important;
    }
    
    /* Content container trong modal */
    #modal-f5-add-subtask .modal-content.fixed.inset-0.z-50.flex {
      display: flex !important;
      pointer-events: none !important;
      z-index: 9999 !important;
    }
    
    #modal-f5-add-subtask .pointer-events-auto {
      pointer-events: auto !important;
    }
    
    /* ============================================ */
    /* END MODAL SYSTEM - CSS RULES */
    /* ============================================ */
    
    /* Form 5 - Sticky Table Header */
    #f5-tasksTable thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f9fafb;
    }
    
    #f5-tasksTable thead th {
      background-color: #f9fafb;
      box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 1px 2px -1px rgba(0, 0, 0, 0.03);
    }
  </style>
</head>
<body class="bg-background-light font-display text-text-light-primary antialiased">
  <div class="flex h-screen w-full overflow-hidden">
  <!-- Sidebar -->
  <aside id="sidebar-nav" class="flex h-full w-64 flex-shrink-0 flex-col justify-between p-4 border-r border-border-light">
    <div class="flex flex-col gap-6">
      <div class="flex items-center gap-3 px-2">
        <img src="https://cdn-icons-png.flaticon.com/512/9029/9029692.png" alt="üéÑ" class="christmas-tree w-16 h-16 object-contain" />
        <div class="flex flex-col relative">
          <h1 class="text-text-light-primary text-base font-bold leading-normal flex items-center gap-2">
            C·ªïng T√°c V·ª• DQA
            <img src="https://cdn-icons-png.flaticon.com/512/9029/9029692.png" alt="‚≠ê" class="christmas-star w-4 h-4 object-contain animate-pulse" />
          </h1>
        </div>
      </div>
      <nav class="flex flex-col gap-2">
        <!-- Nh√≥m: C√¥ng c·ª• h·ªó tr·ª£ -->
        <div class="flex flex-col gap-1 mt-2">
          <button class="group-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-group="tools-group">
            <span class="text-lg group-expand-icon">üõ†Ô∏è</span>
            <p class="text-sm font-semibold">C√¥ng c·ª• h·ªó tr·ª£</p>
          </button>
          <div class="group-items flex flex-col gap-1 ml-4 mt-1" data-group="tools-group">
            <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-target="form1">
              <span class="text-base">üîç</span>
              <p class="text-sm font-semibold">Form 1 - So s√°nh CE</p>
            </button>
            <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-target="form2">
              <span class="text-base">üìä</span>
              <p class="text-sm font-semibold">Form 2 - R√† so√°t CE</p>
            </button>
            <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-target="form9">
              <span class="text-base">üîç</span>
              <p class="text-sm font-semibold">Form 9 - Ng√¢n h√†ng l·ªói</p>
            </button>
          </div>
        </div>
        
        <!-- Nh√≥m: Qu·∫£n l√Ω c√¥ng vi·ªác SPM -->
        <div class="flex flex-col gap-1 mt-2">
          <button class="group-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-group="spm-group">
            <span class="text-lg group-expand-icon">üéÖ</span>
            <p class="text-sm font-semibold">Qu·∫£n l√Ω c√¥ng vi·ªác SPM</p>
          </button>
          <div class="group-items flex flex-col gap-1 ml-4 mt-1" data-group="spm-group">
            <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-target="form3">
              <span class="text-base">üìã</span>
              <p class="text-sm font-semibold">Form 3 - Qu·∫£n l√Ω d·ª± √°n</p>
            </button>
            <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-target="form7">
              <span class="text-base">üìà</span>
              <p class="text-sm font-semibold">Form 7 - Dashboard D·ªØ li·ªáu Excel</p>
            </button>
            <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-target="form8">
              <span class="text-base">üìÖ</span>
              <p class="text-sm font-semibold">Form 8 - Calendar View</p>
            </button>
          </div>
        </div>
        
        <!-- Nh√≥m: T√°c v·ª• chuy·ªÉn ti·∫øp SOP -->
        <div class="flex flex-col gap-1 mt-2">
          <button class="group-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-group="sop-group">
            <span class="text-lg group-expand-icon">üîî</span>
            <p class="text-sm font-semibold">T√°c v·ª• chuy·ªÉn ti·∫øp SOP</p>
          </button>
          <div class="group-items flex flex-col gap-1 ml-4 mt-1" data-group="sop-group">
            <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-target="form4">
              <span class="text-base">üìù</span>
              <p class="text-sm font-semibold">Form 4 - Phi·∫øu nh·∫≠p t√°c v·ª•</p>
            </button>
            <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-target="form5">
              <span class="text-base">üìÅ</span>
              <p class="text-sm font-semibold">Form 5 - Qu·∫£n l√Ω T√°c v·ª• S·∫£n ph·∫©m M·ªõi</p>
            </button>
            <button class="nav-btn flex items-center gap-3 px-3 py-2 rounded-lg text-left text-sm" data-target="form6">
              <span class="text-base">üìä</span>
              <p class="text-sm font-semibold">Form 6 - Dashboard Th·ªëng k√™</p>
            </button>
          </div>
        </div>
      </nav>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col overflow-y-auto">
    <header class="flex-shrink-0 flex items-center justify-between gap-4 p-4 border-b border-border-light bg-surface-light/80 backdrop-blur-sm sticky top-0 z-10">
      <div class="flex-1 flex items-center gap-6 min-w-0">
        <div class="flex flex-wrap items-center gap-2">
          <a class="text-text-light-secondary text-sm font-medium hover:text-primary" href="#">Projects</a>
          <span class="text-text-light-secondary text-sm font-medium">/</span>
          <span class="text-text-light-primary text-sm font-medium truncate">C·ªïng T√°c V·ª• DQA</span>
        </div>
      </div>
    </header>
    <div class="flex-1 p-6 lg:p-8 overflow-x-auto">

    <!-- Form 1 - So s√°nh CE -->
    <section id="form1" class="w-full max-w-7xl bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-blue-800">Form 1 - So s√°nh CE</h2>
      </div>

      <!-- A. Upload file -->
      <div id="section-upload" class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-4">A. Upload file</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- CE g·ªëc -->
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <label class="block text-sm font-medium text-gray-700 mb-2">1. CE g·ªëc</label>
            <div class="flex flex-col gap-2">
              <input type="file" id="f1-ce-original" accept=".xlsx,.xls,.csv" class="hidden">
              <button id="f1-ce-original-btn" class="w-full px-4 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Ch·ªçn file CE g·ªëc</button>
              <div class="flex items-center gap-2">
                <span id="f1-ce-original-name" class="text-sm text-gray-500 flex-1">Ch∆∞a ch·ªçn file</span>
                <button id="f1-ce-original-remove" class="text-red-500 hover:text-red-700 text-sm hidden">‚úï</button>
              </div>
            </div>
          </div>

          <!-- CE sau r√† so√°t -->
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <label class="block text-sm font-medium text-gray-700 mb-2">2. CE sau r√† so√°t</label>
            <div class="flex flex-col gap-2">
              <input type="file" id="f1-ce-review" accept=".xlsx,.xls,.csv" class="hidden">
              <button id="f1-ce-review-btn" class="w-full px-4 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Ch·ªçn file CE sau r√† so√°t</button>
              <div class="flex items-center gap-2">
                <span id="f1-ce-review-name" class="text-sm text-gray-500 flex-1">Ch∆∞a ch·ªçn file</span>
                <button id="f1-ce-review-remove" class="text-red-500 hover:text-red-700 text-sm hidden">‚úï</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- N√∫t g·ª≠i -->
      <div class="flex justify-center mb-6">
        <button id="f1-submit-btn" class="px-8 py-3 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105 submit-btn">
          G·ª≠i l√™n server
        </button>
      </div>

      <!-- B. K·∫øt qu·∫£ tr·∫£ v·ªÅ -->
      <div id="f1-result" class="hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 flex-1">B. K·∫øt qu·∫£ tr·∫£ v·ªÅ</h3>
          <button id="f1-export-excel" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 ml-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Xu·∫•t Excel
          </button>
        </div>
        
        <div class="border border-gray-200 rounded-lg bg-gray-50 p-4">
          <div id="f1-json-vn" class="mb-4 hidden"></div>
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm font-medium text-gray-700">JSON Response:</label>
            <button id="f1-copy-json" class="px-3 py-1 text-xs rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Copy JSON</button>
          </div>
          <pre id="f1-json-result" class="bg-white border border-gray-300 rounded p-4 overflow-auto max-h-[60vh] text-sm font-mono text-gray-800 whitespace-pre-wrap">Ch∆∞a c√≥ k·∫øt qu·∫£</pre>
        </div>
      </div>
    </section>

    <!-- Form 2 - R√† so√°t CE -->
    <section id="form2" class="w-full max-w-none bg-white p-6 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Form 2 - R√† so√°t CE</h2>
      </div>

      <!-- N√∫t t·∫£i d·ªØ li·ªáu v√† Khai b√°o -->
      <div class="flex items-center justify-between mb-4 gap-3">
        <div class="flex items-center gap-3">
          <button id="f2-load-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            T·∫£i d·ªØ li·ªáu
          </button>
          <button id="f2-declaration-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Khai b√°o
          </button>
        </div>
        <div id="f2-loading" class="hidden flex items-center gap-2 text-blue-600">
          <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>ƒêang t·∫£i...</span>
        </div>
      </div>

      <!-- B·ªô l·ªçc -->
      <div class="mt-4 mb-4 flex flex-col md:flex-row gap-4 items-end">
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">L·ªçc theo PIC c·ª•m</label>
            <select id="f2-filter-pic" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">L·ªçc theo D·ª± √°n</label>
            <select id="f2-filter-project" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">T·∫•t c·∫£</option>
            </select>
          </div>
        </div>
        <button id="f2-reset-filter" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition whitespace-nowrap">
          X√≥a b·ªô l·ªçc
        </button>
        <button id="f2-export-excel" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 whitespace-nowrap">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Xu·∫•t Excel
        </button>
      </div>

      <!-- B·∫£ng r√† so√°t CE -->
      <div class="mt-4 border border-gray-200 rounded-lg shadow-md overflow-x-auto">
        <table class="min-w-[2000px] w-full text-sm border-collapse">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-3 min-w-[140px] border border-gray-300">PIC c·ª•m</th>
              <th class="px-3 py-3 min-w-[180px] border border-gray-300">D·ª± √°n</th>
              <th class="px-3 py-3 min-w-[140px] border border-gray-300">Ng√†y giao</th>
              <th class="px-3 py-3 min-w-[140px] border border-gray-300">M√£ SAP</th>
              <th class="px-3 py-3 min-w-[200px] border border-gray-300">C·ª•m linh ki·ªán</th>
              <th class="px-3 py-3 min-w-[280px] border border-gray-300">T√™n linh ki·ªán</th>
              <th class="px-3 py-3 min-w-[160px] border border-gray-300">R√† so√°t TCKT&CE</th>
              <th class="px-3 py-3 min-w-[180px] border border-gray-300">Ng√†y c·∫≠p nh·∫≠t g·∫ßn nh·∫•t</th>
              <th class="px-3 py-3 min-w-[180px] bg-blue-100 text-blue-800 border border-gray-300">T·ª∑ l·ªá ho√†n thi·ªán b·ªï sung</th>
            </tr>
          </thead>
          <tbody id="f2-table-body" class="divide-y divide-gray-200">
            <tr><td class="px-3 py-4 text-center text-gray-500" colspan="9">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Form 3 - Qu·∫£n l√Ω d·ª± √°n -->
    <section id="form3" class="w-full bg-white/50 p-6 lg:p-10 rounded-lg shadow-md hidden flex flex-col" style="min-height: calc(100vh - 120px);">
      <div class="mx-auto flex w-full flex-col gap-6 flex-1">
        <!-- Page Heading -->
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-[#131118]">Qu·∫£n l√Ω d·ª± √°n</h2>
            <p class="text-[#6b6189] text-sm mt-1">Theo d√µi ti·∫øn ƒë·ªô v√† ph√¢n c·∫•p c√¥ng vi·ªác Epic ‚Üí Story ‚Üí Subtask</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="f3-load-data-btn" class="flex items-center gap-2 px-4 py-2.5 bg-white border border-[#e5e7eb] rounded-full text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm">
              <span class="material-symbols-outlined text-[18px]">refresh</span>
              <span>T·∫£i d·ªØ li·ªáu</span>
            </button>
            <button id="f3-export-btn" class="flex items-center gap-2 px-4 py-2.5 bg-white border border-[#e5e7eb] rounded-full text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm">
              <span class="material-symbols-outlined text-[18px]">table_view</span>
              <span>Xu·∫•t Excel</span>
            </button>
          </div>
      </div>

        <!-- Upload Section -->
        <div class="rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 p-6 shadow-sm hidden">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Upload File Excel</h3>
            <span class="text-xs text-gray-500">H·ªó tr·ª£ .xlsx, .xls</span>
          </div>
          
          <div id="f3-drop-zone" class="relative border-2 border-dashed border-blue-300 rounded-lg p-8 text-center bg-white hover:border-blue-500 transition-colors cursor-pointer">
            <input type="file" id="f3-excel-file" accept=".xlsx,.xls" class="hidden">
            <div id="f3-drop-content" class="flex flex-col items-center gap-3">
              <span class="material-symbols-outlined text-5xl text-blue-500">cloud_upload</span>
              <div>
                <p class="text-sm font-medium text-gray-700">K√©o th·∫£ file Excel v√†o ƒë√¢y</p>
                <p class="text-xs text-gray-500 mt-1">ho·∫∑c click ƒë·ªÉ ch·ªçn file</p>
            </div>
          </div>
            <div id="f3-file-info" class="hidden flex items-center justify-between gap-3 mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
              <div class="flex items-center gap-3 flex-1">
                <span class="material-symbols-outlined text-green-600">description</span>
                <div class="flex-1 text-left">
                  <p id="f3-file-name" class="text-sm font-medium text-gray-900"></p>
                  <p id="f3-file-size" class="text-xs text-gray-500"></p>
        </div>
      </div>
              <button id="f3-file-remove" class="text-red-500 hover:text-red-700 transition">
                <span class="material-symbols-outlined">close</span>
        </button>
            </div>
      </div>

          <div class="flex items-center justify-center gap-3 mt-4">
            <button id="f3-submit-btn" class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <span class="material-symbols-outlined">upload</span>
              <span>T·∫£i l√™n server</span>
            </button>
            </div>
          </div>

        <!-- Search and Filter -->
        <div class="flex flex-col lg:flex-row gap-3 pt-2">
          <!-- Search Input -->
          <div class="relative w-full lg:max-w-md">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <span class="material-symbols-outlined text-[#6b6189]">search</span>
            </div>
            <input id="f3-search-input" type="text" placeholder="T√¨m theo t√™n, Jira Key, Assignee..." class="block w-full pl-10 pr-3 py-2.5 border-none rounded-full leading-5 bg-white text-[#131118] placeholder-[#9ca3af] focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary/20 shadow-sm ring-1 ring-[#e5e7eb]">
          </div>
          <!-- Filters -->
          <div class="flex gap-2 overflow-x-auto pb-2 lg:pb-0 no-scrollbar">
            <select id="f3-filter-status" class="pl-3 pr-8 py-2.5 bg-white border-none ring-1 ring-[#e5e7eb] rounded-full text-sm font-medium text-[#131118] focus:ring-2 focus:ring-primary/20 shadow-sm cursor-pointer appearance-none">
              <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
              <option value="ho√†n th√†nh">Ho√†n th√†nh</option>
              <option value="ƒëang tri·ªÉn khai">ƒêang tri·ªÉn khai</option>
              <option value="ch∆∞a tri·ªÉn khai">Ch∆∞a tri·ªÉn khai</option>
              <option value="h·ªßy t√°c v·ª•">H·ªßy t√°c v·ª•</option>
              <option value="cancelled">ƒê√£ h·ªßy</option>
            </select>
            <select id="f3-filter-assignee" class="pl-3 pr-8 py-2.5 bg-white border-none ring-1 ring-[#e5e7eb] rounded-full text-sm font-medium text-[#131118] focus:ring-2 focus:ring-primary/20 shadow-sm cursor-pointer appearance-none">
              <option value="">T·∫•t c·∫£ th√†nh vi√™n</option>
              <!-- Options s·∫Ω ƒë∆∞·ª£c populate b·∫±ng JavaScript -->
            </select>
            <select id="f3-filter-level" class="pl-3 pr-8 py-2.5 bg-white border-none ring-1 ring-[#e5e7eb] rounded-full text-sm font-medium text-[#131118] focus:ring-2 focus:ring-primary/20 shadow-sm cursor-pointer appearance-none">
              <option value="all">T·∫•t c·∫£ c·∫•p</option>
              <option value="story">Story v√† Subtask</option>
              <option value="subtask">Ch·ªâ Subtask</option>
            </select>
            <input type="month" id="f3-filter-month" class="pl-3 pr-8 py-2.5 bg-white border-none ring-1 ring-[#e5e7eb] rounded-full text-sm font-medium text-[#131118] focus:ring-2 focus:ring-primary/20 shadow-sm cursor-pointer" placeholder="L·ªçc theo th√°ng">
          </div>
        </div>

        <!-- Hierarchical Data Table -->
        <div class="overflow-hidden rounded-lg bg-white shadow-sm border border-[#f1f0f4] flex-1 flex flex-col">
          <div class="overflow-x-auto overflow-y-auto flex-1" style="min-height: 0;">
            <!-- Table Header -->
            <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-[#fafafa] border-b border-[#f1f0f4] text-xs font-semibold text-[#6b6189] uppercase tracking-wider sticky top-0 z-10">
              <div class="col-span-3 flex items-center">T√™n c√¥ng vi·ªác</div>
              <div class="col-span-1 flex items-center">Thay ƒë·ªïi</div>
              <div class="col-span-2 flex items-center">Ng∆∞·ªùi th·ª±c hi·ªán</div>
              <div class="col-span-1 flex items-center">Tr·∫°ng th√°i</div>
              <div class="col-span-1 flex items-center">Ng√†y b·∫Øt ƒë·∫ßu</div>
              <div class="col-span-1 flex items-center">H·∫°n HT</div>
              <div class="col-span-1 flex items-center">Ng√†y ho√†n th√†nh</div>
              <div class="col-span-1 flex items-center">M√£ Jira/KOI</div>
              <div class="col-span-1 flex items-center">Ghi ch√∫</div>
            </div>
            <!-- Table Body (Scrollable) -->
            <div class="custom-scrollbar-f3">
              <div id="f3-table-body" class="divide-y divide-[#f1f0f4]">
                <div class="px-6 py-8 text-center text-[#6b6189]">
                  <div class="flex flex-col items-center gap-2">
                    <span class="material-symbols-outlined text-4xl text-gray-300">table_chart</span>
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i d·ªØ li·ªáu ho·∫∑c upload file Excel.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div id="f3-loading" class="hidden flex items-center justify-center gap-2 text-primary py-4">
          <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>ƒêang t·∫£i...</span>
        </div>
      </div>
    </section>
    
    <!-- Custom scrollbar styles for Form 3 only - scoped to prevent affecting other forms -->
    <style>
        /* Form 3 specific scrollbar - scoped to #form3 only */
        #form3 .custom-scrollbar-f3::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #form3 .custom-scrollbar-f3::-webkit-scrollbar-track {
            background: transparent;
        }
        #form3 .custom-scrollbar-f3::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 9999px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        #form3 .custom-scrollbar-f3::-webkit-scrollbar-thumb:hover {
            background-color: #d1d5db;
        }
        /* Form 3 specific no-scrollbar - only applies within form3 */
        #form3 .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        #form3 .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>

    <!-- Form 4 - Phi·∫øu nh·∫≠p t√°c v·ª• -->
    <section id="form4" class="w-full max-w-4xl bg-white p-6 rounded-lg shadow-md hidden">
      <div class="mb-6">
        <h2 class="text-xl font-semibold text-blue-800">Form 4 - Phi·∫øu nh·∫≠p t√°c v·ª•</h2>
        <p class="text-sm text-gray-600 mt-2">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c m·ª•c b·∫Øt bu·ªôc cho s·∫£n ph·∫©m/linh ki·ªán c·∫ßn th·ª≠ nghi·ªám.</p>
      </div>
      <form id="f4-testRequestForm" class="space-y-6" autocomplete="off">
        <!-- A. General Information -->
        <div class="border border-gray-200 rounded-lg p-4 bg-blue-50">
          <h3 class="text-lg font-semibold text-blue-800 mb-3">A. Th√¥ng tin chung</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <input required id="f4-senderName" name="senderName" type="text" list="f4-senderNameOptions" placeholder="H·ªç t√™n ng∆∞·ªùi g·ª≠i *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              <datalist id="f4-senderNameOptions"></datalist>
            </div>
            <input required name="senderEmail" type="email" placeholder="Email *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input name="requestDate" type="datetime-local" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly id="f4-testRequestDate"/>
            <input type="hidden" name="requestCode" id="f4-requestCode"/>
            <select required name="department" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Ph√≤ng ban y√™u c·∫ßu *</option>
              <option>Mua h√†ng</option><option>SC</option><option>SC2</option><option>KTSX</option><option>KTSP</option>
              <option>TKCK</option><option>KTCN</option><option>NCTN</option><option>TKƒêT</option>
              <option>QA/QC nh√† m√°y</option><option>DQA</option>
            </select>
          </div>
        </div>
        <!-- B. Product/Component Information -->
        <div class="border border-gray-200 rounded-lg p-4 bg-green-50">
          <h3 class="text-lg font-semibold text-blue-800 mb-3">B. Th√¥ng tin s·∫£n ph·∫©m/linh ki·ªán</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input required id="f4-productName" name="productName" type="text" placeholder="T√™n s·∫£n ph·∫©m/linh ki·ªán *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input required name="productCode" type="text" placeholder="M√£ s·∫£n ph·∫©m/linh ki·ªán *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input type="hidden" name="componentType" id="f4-componentType" value="" />
            <input type="hidden" name="componentStandard" id="f4-componentStandard" value="0" />
            <select required name="requestPurpose" id="f4-requestPurpose" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 md:col-span-2">
              <option value="">M·ª•c ƒë√≠ch y√™u c·∫ßu *</option>
              <option value="ƒê√°nh gi√° SP m·ªõi">ƒê√°nh gi√° s·∫£n ph·∫©m m·ªõi</option>
              <option value="ƒê√°nh gi√° S·∫£n ph·∫©m SOP">ƒê√°nh gi√° s·∫£n ph·∫©m SOP(Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn l·∫°i, kh√¥ng ch·ªçn)</option>
            </select>
            <div id="f4-purposeDescription" class="text-gray-600 text-sm md:col-span-2"></div>
            <div id="f4-projectCodeContainer" class="hidden md:col-span-2">
              <input type="text" id="f4-projectCode" name="projectCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="M√£ d·ª± √°n" disabled />
            </div>
            <div id="f4-nccChangeFields" class="hidden md:col-span-2">
              <input type="text" id="f4-appliedModel" name="appliedModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Model √°p d·ª•ng *" disabled />
            </div>
            <input name="supplier" required type="text" placeholder="Nh√† cung c·∫•p *" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input name="numSamples" type="number" min="0" placeholder="S·ªë l∆∞·ª£ng m·∫´u giao *" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input id="f4-desiredCompletionDate" name="desiredCompletionDate" type="text" placeholder="H·∫°n mong mu·ªën" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            <input type="hidden" name="desiredCompletionDateTime" id="f4-desiredCompletionDateTime" />
            <select name="personReceived" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">ƒê·∫ßu m·ªëi nh·∫≠n m·∫´u *</option>
              <option>V≈© Duy Minh</option>
              <option>Nguy·ªÖn VƒÉn Linh</option>
              <option>Nguy·ªÖn VƒÉn Hi·∫øu</option>
              <option>ƒê√†o Ho√†ng D∆∞∆°ng</option>
            </select>
            <select name="pic" id="f4-pic" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">PIC (Ng∆∞·ªùi ph·ª• tr√°ch)</option>
              <option>Nguy·ªÖn H·ªØu Th·ªãnh</option>
              <option>Nguy·ªÖn VƒÉn Hi·∫øu</option>
              <option>V≈© Th·ªã H·∫±ng</option>
              <option>Nguy·ªÖn VƒÉn Linh</option>
              <option>ƒê√†o Ho√†ng D∆∞∆°ng</option>
              <option>B√πi ƒê·∫∑ng Qu·ªëc Huy</option>
              <option>ƒê√†o Tu·∫•n K·ª≥</option>
              <option>Th√°i Th·ªã Giang</option>
              <option>Tr·∫ßn Hi·∫øu Nghƒ©a</option>
            </select>
            <select name="evaluator" id="f4-evaluator" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Ng∆∞·ªùi nh·∫≠n ƒë√°nh gi√°</option>
              <option>ƒê·ªó Quang Long</option>
              <option>Nguy·ªÖn Th·ªã Hi·ªÅn</option>
              <option>Ph·∫°m Th√†nh Trung Ki√™n</option>
              <option>L√™ Ng·ªçc √Ånh</option>
              <option>H√† M·ªπ Linh</option>
              <option>Ph·∫°m Th·ªã Minh</option>
              <option>L√™ VƒÉn S∆°n</option>
              <option>L·∫°i Qu·ªëc L·ªôc</option>
              <option>L√™ Th·ªã Th·∫£o</option>
              <option>V≈© Th·ªã Thanh Hi·ªÅn</option>
              <option>Nguy·ªÖn H·ªØu Th·ªãnh</option>
              <option>V≈© Th·ªã H·∫±ng</option>
              <option>B√πi ƒê·∫∑ng Qu·ªëc Huy</option>
              <option>ƒê√†o Tu·∫•n K·ª≥</option>
              <option>Th√°i Th·ªã Giang</option>
              <option>Tr·∫ßn Hi·∫øu Nghƒ©a</option>
            </select>
            <select name="tester" id="f4-tester" class="hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Ng∆∞·ªùi th·ª≠ nghi·ªám</option>
              <option>ƒê·ªó Quang Long</option>
              <option>Nguy·ªÖn Th·ªã Hi·ªÅn</option>
              <option>Ph·∫°m Th√†nh Trung Ki√™n</option>
              <option>L√™ Ng·ªçc √Ånh</option>
              <option>H√† M·ªπ Linh</option>
              <option>Ph·∫°m Th·ªã Minh</option>
              <option>L√™ VƒÉn S∆°n</option>
              <option>L·∫°i Qu·ªëc L·ªôc</option>
              <option>L√™ Th·ªã Th·∫£o</option>
              <option>V≈© Th·ªã Thanh Hi·ªÅn</option>
            </select>
            <textarea name="notes" rows="2" placeholder="Ghi ch√∫ (ƒêi·ªÉm thay ƒë·ªïi, l√Ω do y√™u c·∫ßu g·∫•p...)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 md:col-span-2"></textarea>
          </div>
        </div>
        <!-- C. Attachments -->
        <div class="border border-gray-200 rounded-lg p-4 bg-purple-50">
          <h3 class="text-lg font-semibold text-blue-800 mb-3">C. T√†i li·ªáu ƒë√≠nh k√®m</h3>
          <div id="f4-fileUploadArea" class="relative border-2 border-dashed border-blue-300 rounded-lg p-8 text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50 cursor-pointer">
            <div id="f4-uploadContent" class="space-y-4">
              <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
              </div>
              <div>
                <p class="text-lg font-medium text-gray-700">K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c <span class="text-blue-600 underline">nh·∫•n ƒë·ªÉ ch·ªçn</span></p>
                <p class="text-sm text-gray-500 mt-1">H·ªó tr·ª£: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (t·ªëi ƒëa 20MB m·ªói file)</p>
              </div>
            </div>
            <input type="file" id="f4-testRequestFiles" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
          </div>
          <div id="f4-uploadProgress" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-blue-700">ƒêang t·∫£i l√™n...</span>
              <span id="f4-uploadPercent" class="text-sm text-blue-600">0%</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2">
              <div id="f4-progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
          <div id="f4-testRequestUploadList" class="mt-4 space-y-3"></div>
        </div>
        <button type="submit" class="submit-btn w-full mt-4 py-3 text-white font-semibold text-lg transition flex items-center justify-center gap-2">
          <span>G·ª≠i y√™u c·∫ßu</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </button>
      </form>
    </section>

    <!-- Form 5 - Qu·∫£n l√Ω T√°c v·ª• S·∫£n ph·∫©m M·ªõi -->
    <section id="form5" class="w-full bg-white p-6 lg:p-10 rounded-lg shadow-md hidden">
      <div class="mx-auto flex w-full flex-col gap-6">
        <!-- Page Heading -->
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex flex-col gap-1">
            <p class="text-4xl font-black leading-tight tracking-tighter text-gray-900">B·∫£ng T√°c V·ª• - S·∫£n ph·∫©m M·ªõi</p>
            <p class="text-base font-normal text-gray-600">Qu·∫£n l√Ω t·∫•t c·∫£ c√¥ng vi·ªác c·ªßa b·∫°n ·ªü m·ªôt n∆°i.</p>
          </div>
        </div>

        <!-- ToolBar -->
        <div class="flex flex-wrap items-center justify-between gap-4 rounded-lg bg-white p-2 shadow-sm border border-gray-200">
          <div class="flex items-center gap-2 flex-wrap">
            <div class="relative w-64">
              <span class="material-symbols-outlined pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">search</span>
              <input id="f5-searchInput" class="h-10 w-full rounded-full border-gray-300 bg-gray-50 pl-10 pr-4 text-sm focus:border-blue-500 focus:ring-blue-500" placeholder="T√¨m ki·∫øm t√°c v·ª•..." type="text"/>
            </div>
            <select id="f5-filter-pic" class="h-10 px-4 py-2 rounded-lg border border-gray-300 bg-white text-sm focus:border-blue-500 focus:ring-blue-500 min-w-[200px]">
              <option value="">T·∫•t c·∫£ ng∆∞·ªùi nh·∫≠n</option>
              <!-- Options s·∫Ω ƒë∆∞·ª£c populate b·∫±ng JavaScript -->
            </select>
            <input type="month" id="f5-filter-month" class="h-10 px-4 py-2 rounded-lg border border-gray-300 bg-white text-sm focus:border-blue-500 focus:ring-blue-500" placeholder="L·ªçc theo th√°ng">
            <button id="f5-searchBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
              <span class="material-symbols-outlined text-lg">search</span>
              Tra c·ª©u
            </button>
            <button id="f5-importExcelBtn" class="hidden flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium text-sm">
              <span class="material-symbols-outlined text-lg">upload_file</span>
              Import Excel
            </button>
            <button id="f5-export-btn" class="flex items-center gap-2 px-4 py-2 bg-white border border-[#e5e7eb] rounded-full text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm">
              <span class="material-symbols-outlined text-[18px]">table_view</span>
              <span>Xu·∫•t Excel</span>
            </button>
          </div>
        </div>

        <!-- Hierarchical Task Table -->
        <div class="overflow-hidden rounded-lg bg-white shadow-sm border border-gray-200">
          <div class="overflow-x-auto overflow-y-auto" style="max-height: calc(100vh - 400px);">
            <table id="f5-tasksTable" class="w-full">
              <thead class="border-b border-gray-200">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">T√™n t√°c v·ª•</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Ng∆∞·ªùi y√™u c·∫ßu</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Ng∆∞·ªùi nh·∫≠n t√°c v·ª•</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Ph√≤ng ban</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Ng√†y g·ª≠i</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Ng√†y h·∫øt h·∫°n</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Ng√†y ho√†n th√†nh</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Tr·∫°ng th√°i</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">S·ªë gi·ªù th·ª±c hi·ªán</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">M√£ t√°c v·ª•</th>
                  <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600">Link k·∫øt qu·∫£</th>
                  <th class="w-auto p-3 text-left text-xs font-bold uppercase tracking-wider text-gray-600"></th>
                </tr>
              </thead>
              <tbody id="f5-tasksTableBody" class="divide-y divide-gray-200">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Form 6 - Dashboard Th·ªëng k√™ -->
    <section id="form6" class="w-full bg-white p-6 lg:p-10 rounded-lg shadow-md hidden">
      <div class="mx-auto flex w-full flex-col gap-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-3">
            <div class="text-primary-blue">
              <span class="material-symbols-outlined text-3xl" style="font-variation-settings: 'FILL' 1;">space_dashboard</span>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-900">Dashboard T·ªïng quan</h2>
              <p class="text-sm text-gray-500">Th·ªëng k√™ v√† theo d√µi ti·∫øn ƒë·ªô d·ª± √°n, t√°c v·ª•</p>
            </div>
          </div>
          <button id="f6-refresh-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium">
            <span class="material-symbols-outlined text-lg">refresh</span>
            <span>T·∫£i l·∫°i</span>
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-600 text-sm font-medium mb-1">T·ªïng D·ª± √°n</p>
                <p class="text-gray-900 text-3xl font-bold" id="f6-stat-projects">0</p>
              </div>
              <div class="p-3 bg-blue-200 rounded-lg">
                <span class="material-symbols-outlined text-blue-700 text-2xl">folder</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-purple-600 text-sm font-medium mb-1">T·ªïng T√°c v·ª•</p>
                <p class="text-gray-900 text-3xl font-bold" id="f6-stat-tasks">0</p>
              </div>
              <div class="p-3 bg-purple-200 rounded-lg">
                <span class="material-symbols-outlined text-purple-700 text-2xl">task</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-green-50 to-green-100 border border-green-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-green-600 text-sm font-medium mb-1">T·ªïng Subtask</p>
                <p class="text-gray-900 text-3xl font-bold" id="f6-stat-subtasks">0</p>
              </div>
              <div class="p-3 bg-green-200 rounded-lg">
                <span class="material-symbols-outlined text-green-700 text-2xl">checklist</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-orange-600 text-sm font-medium mb-1">T·ª∑ l·ªá Ho√†n th√†nh</p>
                <p class="text-gray-900 text-3xl font-bold" id="f6-stat-completion">0%</p>
              </div>
              <div class="p-3 bg-orange-200 rounded-lg">
                <span class="material-symbols-outlined text-orange-700 text-2xl">trending_up</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Tr·∫°ng th√°i Subtask -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-900 mb-3">Tr·∫°ng th√°i Subtask</h3>
            <div id="f6-chart-subtask-status" class="flex items-center justify-center">
              <!-- Chart s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
            </div>
          </div>
          <!-- Ph√¢n b·ªï theo PIC -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:col-span-2">
            <h3 class="text-sm font-semibold text-gray-900 mb-3">Ph√¢n b·ªï theo Ng∆∞·ªùi th·ª±c hi·ªán</h3>
            <div id="f6-chart-pic-distribution" class="min-h-[200px]">
              <!-- Chart s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
            </div>
          </div>
        </div>

        <!-- Tasks s·∫Øp h·∫øt h·∫°n -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">T√°c v·ª• s·∫Øp h·∫øt h·∫°n (7 ng√†y t·ªõi)</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">T√™n t√°c v·ª•</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">D·ª± √°n</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Ng∆∞·ªùi th·ª±c hi·ªán</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">H·∫°n ch√≥t</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">C√≤n l·∫°i</th>
                </tr>
              </thead>
              <tbody id="f6-due-tasks-body" class="divide-y divide-gray-200">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- B·∫£ng chi ti·∫øt D·ª± √°n -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-6 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Chi ti·∫øt D·ª± √°n</h3>
            <div class="flex items-center gap-2">
              <div class="relative">
                <span class="material-symbols-outlined pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">search</span>
                <input id="f6-search-input" class="h-9 w-64 rounded-lg border-gray-300 bg-gray-50 pl-9 pr-4 text-sm focus:border-blue-500 focus:ring-blue-500" placeholder="T√¨m ki·∫øm..." type="text"/>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">M√£ d·ª± √°n</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">T√™n d·ª± √°n</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">S·ªë t√°c v·ª•</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">S·ªë subtask</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Ti·∫øn ƒë·ªô</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Ng∆∞·ªùi ph·ª• tr√°ch</th>
                </tr>
              </thead>
              <tbody id="f6-projects-table-body" class="divide-y divide-gray-200">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Form 7 - Dashboard D·ªØ li·ªáu Excel -->
    <section id="form7" class="w-full bg-white p-6 lg:p-10 rounded-lg shadow-md hidden">
      <div class="mx-auto flex w-full flex-col gap-6">
        <!-- Page Heading -->
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex flex-col gap-1">
            <p class="text-4xl font-black leading-tight tracking-tighter text-gray-900">Dashboard D·ªØ li·ªáu Excel</p>
            <p class="text-base font-normal text-gray-600">Th·ªëng k√™ v√† ph√¢n t√≠ch d·ªØ li·ªáu t·ª´ Excel.</p>
          </div>
          <button id="f7-refresh-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium">
            <span class="material-symbols-outlined text-lg">refresh</span>
            <span>T·∫£i l·∫°i</span>
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-600 text-sm font-medium mb-1">T·ªïng Epic</p>
                <p class="text-gray-900 text-3xl font-bold" id="f7-stat-epics">0</p>
              </div>
              <div class="p-3 bg-blue-200 rounded-lg">
                <span class="material-symbols-outlined text-blue-700 text-2xl">folder</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-purple-600 text-sm font-medium mb-1">T·ªïng Story</p>
                <p class="text-gray-900 text-3xl font-bold" id="f7-stat-stories">0</p>
              </div>
              <div class="p-3 bg-purple-200 rounded-lg">
                <span class="material-symbols-outlined text-purple-700 text-2xl">description</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-green-50 to-green-100 border border-green-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-green-600 text-sm font-medium mb-1">T·ªïng Subtask</p>
                <p class="text-gray-900 text-3xl font-bold" id="f7-stat-subtasks">0</p>
              </div>
              <div class="p-3 bg-green-200 rounded-lg">
                <span class="material-symbols-outlined text-green-700 text-2xl">task</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-orange-600 text-sm font-medium mb-1">T·ª∑ l·ªá Ho√†n th√†nh</p>
                <p class="text-gray-900 text-3xl font-bold" id="f7-stat-completion">0%</p>
              </div>
              <div class="p-3 bg-orange-200 rounded-lg">
                <span class="material-symbols-outlined text-orange-700 text-2xl">trending_up</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ASSIGNEE FOCUS SECTION -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-200">
          <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-3xl text-blue-600">people</span>
            <h2 class="text-2xl font-bold text-gray-900">Dashboard Ph√¢n t√≠ch theo Ng∆∞·ªùi th·ª±c hi·ªán</h2>
          </div>
        </div>

        <!-- Main Content Row: Assignee Progress + Status Table -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start">
          <!-- Assignee Progress Overview - Bi·ªÉu ƒë·ªì c·ªôt (2/3 width) -->
          <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
              <span class="material-symbols-outlined text-blue-600">trending_up</span>
              <h3 class="text-lg font-semibold text-gray-900">Ti·∫øn ƒë·ªô ho√†n th√†nh theo Ng∆∞·ªùi th·ª±c hi·ªán</h3>
            </div>
            <div id="f7-assignee-progress" class="w-full">
              <p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
            </div>
          </div>

          <!-- Status Breakdown Table - G·ªçn l·∫°i (1/3 width) -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-full">
            <div class="p-3 border-b border-gray-200 flex-shrink-0">
              <h3 class="text-sm font-semibold text-gray-900">Chi ti·∫øt theo Tr·∫°ng th√°i</h3>
            </div>
            <div class="overflow-x-auto overflow-y-auto flex-1" style="max-height: calc(200px + 3rem);">
              <table class="w-full text-xs">
                <thead class="bg-gray-50 sticky top-0">
                  <tr>
                    <th class="px-2 py-1.5 text-left text-xs font-semibold text-gray-700 uppercase">Tr·∫°ng th√°i</th>
                    <th class="px-2 py-1.5 text-left text-xs font-semibold text-gray-700 uppercase">SL</th>
                    <th class="px-2 py-1.5 text-left text-xs font-semibold text-gray-700 uppercase">%</th>
                  </tr>
                </thead>
                <tbody id="f7-status-table-body" class="divide-y divide-gray-200">
                  <tr>
                    <td colspan="3" class="px-2 py-3 text-center text-gray-500 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Ph√¢n b·ªï Task v√† Task ƒë·∫øn h·∫°n - Grid 2 c·ªôt -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- Ph√¢n b·ªï Task - Bi·ªÉu ƒë·ªì tr√≤n (1/2 width) -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
              <span class="material-symbols-outlined text-indigo-600">pie_chart</span>
              <h3 class="text-lg font-semibold text-gray-900">Ph√¢n b·ªï Task theo Ng∆∞·ªùi th·ª±c hi·ªán</h3>
            </div>
            <div id="f7-chart-assignee" class="min-h-[300px] flex items-center justify-center">
              <p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
            </div>
          </div>

          <!-- Task ƒë·∫øn h·∫°n (1/2 width) -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
              <span class="material-symbols-outlined text-red-600">schedule</span>
              <h3 class="text-lg font-semibold text-gray-900">C√°c Task ƒë·∫øn h·∫°n</h3>
            </div>
            <div id="f7-due-tasks" class="min-h-[300px]">
              <p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
            </div>
          </div>
        </div>

        <!-- Assignee Details -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="material-symbols-outlined text-green-600">person</span>
            <h3 class="text-lg font-semibold text-gray-900">Chi ti·∫øt theo t·ª´ng Ng∆∞·ªùi th·ª±c hi·ªán</h3>
          </div>
          <div id="f7-assignee-tags" class="flex flex-wrap gap-2 mb-4">
            <!-- Tags s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
          </div>
          <div id="f7-assignee-details" class="min-h-[200px]">
            <p class="text-gray-500 text-center py-8">Vui l√≤ng ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán ƒë·ªÉ xem chi ti·∫øt</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Form 8 - Calendar View -->
    <section id="form8" class="w-full bg-white p-6 lg:p-10 rounded-lg shadow-md hidden">
      <div class="mx-auto flex w-full flex-col gap-6">
        <!-- Page Heading -->
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Form 8 - Calendar View</h2>
            <p class="text-sm text-gray-600">Xem c√¥ng vi·ªác theo l·ªãch th√°ng/tu·∫ßn</p>
          </div>
          <button id="f8-refresh-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium">
            <span class="material-symbols-outlined text-lg">refresh</span>
            <span>T·∫£i l·∫°i</span>
          </button>
        </div>

        <!-- Search and Filters -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 py-6">
          <div class="relative w-full md:max-w-md">
            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">search</span>
            <input id="f8-search" class="w-full form-input rounded-full border border-gray-300 bg-white h-12 pl-12 pr-4 text-gray-900 placeholder:text-gray-500 focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="T√¨m c√¥ng vi·ªác..." type="text"/>
          </div>
          <div class="flex items-center gap-2">
            <button id="f8-filter-assignee" class="flex items-center gap-2 rounded-full border border-gray-300 bg-white px-4 h-10 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-100">
              <span class="material-symbols-outlined text-lg">filter_list</span>
              <span>Ng∆∞·ªùi ph·ª• tr√°ch</span>
              <span class="material-symbols-outlined text-lg">expand_more</span>
            </button>
            <button id="f8-filter-status" class="flex items-center gap-2 rounded-full border border-gray-300 bg-white px-4 h-10 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-100">
              <span>Tr·∫°ng th√°i</span>
              <span class="material-symbols-outlined text-lg">expand_more</span>
            </button>
          </div>
        </div>

        <!-- Calendar Controls -->
        <div class="flex flex-wrap items-center justify-between gap-4 pb-6">
          <div class="flex items-center gap-4">
            <h1 id="f8-month-title" class="text-gray-900 text-3xl font-bold">Th√°ng 9 2024</h1>
            <div class="flex items-center gap-1">
              <button id="f8-prev-month" class="p-2 text-gray-500 rounded-full hover:bg-gray-200">
                <span class="material-symbols-outlined">chevron_left</span>
              </button>
              <button id="f8-next-month" class="p-2 text-gray-500 rounded-full hover:bg-gray-200">
                <span class="material-symbols-outlined">chevron_right</span>
              </button>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-1 rounded-full bg-gray-200 p-1 text-sm font-semibold">
              <button id="f8-view-month" class="px-3 py-1 rounded-full bg-white text-primary shadow-sm">Th√°ng</button>
              <button id="f8-view-week" class="px-3 py-1 rounded-full text-gray-600">Tu·∫ßn</button>
            </div>
            <button id="f8-today" class="flex cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-white text-gray-900 gap-2 text-sm font-bold px-4 border border-gray-300 shadow-sm">
              H√¥m nay
            </button>
            <button id="f8-new-task" class="flex cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-primary text-white gap-2 text-sm font-bold px-4 shadow-sm">
              <span class="material-symbols-outlined text-lg">add</span>
              C√¥ng vi·ªác m·ªõi
            </button>
          </div>
        </div>

        <!-- Calendar Container -->
        <div class="flex flex-1 flex-col overflow-auto bg-white rounded-lg border border-gray-200 shadow-sm">
          <div id="f8-calendar-header" class="grid grid-cols-7 text-center">
            <p class="text-gray-500 text-xs font-bold py-4 border-b border-gray-200">CN</p>
            <p class="text-gray-500 text-xs font-bold py-4 border-b border-gray-200">T2</p>
            <p class="text-gray-500 text-xs font-bold py-4 border-b border-gray-200">T3</p>
            <p class="text-gray-500 text-xs font-bold py-4 border-b border-gray-200">T4</p>
            <p class="text-gray-500 text-xs font-bold py-4 border-b border-gray-200">T5</p>
            <p class="text-gray-500 text-xs font-bold py-4 border-b border-gray-200">T6</p>
            <p class="text-gray-500 text-xs font-bold py-4 border-b border-gray-200">T7</p>
          </div>
          <div id="f8-calendar-body" class="grid grid-cols-7 grid-rows-5 flex-1">
            <!-- Calendar cells will be rendered here -->
            <div class="text-center py-8 text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Form 9 - Ng√¢n h√†ng l·ªói -->
    <section id="form9" class="w-full bg-white p-6 lg:p-10 rounded-lg shadow-md hidden">
      <div class="mx-auto flex w-full flex-col gap-6">
        <!-- Page Heading -->
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-blue-800">Form 9 - Ng√¢n h√†ng l·ªói</h2>
            <p class="text-sm text-gray-600">Xem v√† tra c·ª©u c√°c ƒëi·ªÉm l·ªói ƒë∆∞·ª£c ghi nh·∫≠n l·∫°i</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="f9-load-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
              <span class="material-symbols-outlined text-lg">refresh</span>
              <span>T·∫£i d·ªØ li·ªáu</span>
            </button>
            <button id="f9-export-btn" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
              <span class="material-symbols-outlined text-lg">table_view</span>
              <span>Xu·∫•t Excel</span>
            </button>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div id="f9-loading" class="hidden flex items-center justify-center gap-2 text-blue-600 py-4">
          <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>ƒêang t·∫£i...</span>
        </div>

        <!-- Search -->
        <div class="flex items-center gap-4">
          <div class="relative flex-1 max-w-md">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">search</span>
            <input id="f9-search" type="text" placeholder="T√¨m ki·∫øm..." class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
          </div>
        </div>

        <!-- Data Table -->
        <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-md">
          <table class="min-w-full text-sm border-collapse">
            <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
              <tr>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[100px]">STT</th>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[200px]">Linh ki·ªán</th>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[120px]">M√£ linh ki·ªán</th>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[100px]">Ph·∫°m vi</th>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[180px]">H·∫°ng m·ª•c NG</th>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[150px]">M√£ b√°o c√°o</th>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[150px]">Nh√† cung c·∫•p</th>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[120px]">Ng∆∞·ªùi l·∫≠p</th>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[120px]">Ng∆∞·ªùi ki·ªÉm tra</th>
                <th class="px-3 py-3 text-left border border-gray-300 font-semibold text-gray-700 min-w-[150px]">Ng√†y ghi nh·∫≠n</th>
                <th class="px-3 py-3 text-center border border-gray-300 font-semibold text-gray-700 min-w-[100px]">Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="f9-table-body" class="divide-y divide-gray-200">
              <tr>
                <td colspan="11" class="px-3 py-8 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i d·ªØ li·ªáu.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-600">
            Hi·ªÉn th·ªã <span id="f9-page-info">0-0</span> trong t·ªïng s·ªë <span id="f9-total-items">0</span> b·∫£n ghi
          </div>
          <div class="flex items-center gap-2">
            <button id="f9-prev-page" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Tr∆∞·ªõc</button>
            <span class="px-3 py-2 text-sm font-medium">Trang <span id="f9-current-page">1</span> / <span id="f9-total-pages">1</span></span>
            <button id="f9-next-page" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Sau</button>
          </div>
        </div>
      </div>
    </section>
    </div>
  </main>
  </div>

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 2: DECLARATION (Khai b√°o) -->
  <!-- ============================================ -->
  <div id="modal-f2-declaration" class="modal-container modal-f2-declaration fixed inset-0 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div id="modal-f2-declaration-overlay" class="modal-overlay modal-f2-declaration-overlay fixed inset-0 bg-black/50"></div>
    <div id="modal-f2-declaration-content" class="modal-content modal-f2-declaration-content relative z-50 flex items-center justify-center w-full h-full">
      <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-green-50 to-green-100">
        <h3 class="text-xl font-semibold text-gray-800">Khai b√°o - So s√°nh CE</h3>
        <button id="modal-f2-declaration-close" class="modal-close modal-f2-declaration-close text-gray-500 hover:text-gray-700 transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div id="modal-f2-declaration-body" class="modal-body modal-f2-declaration-body p-6 overflow-y-auto flex-1">
        <!-- Upload file -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-4">Upload file</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- CE g·ªëc -->
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
              <label class="block text-sm font-medium text-gray-700 mb-2">1. CE g·ªëc</label>
              <div class="flex flex-col gap-2">
                <input type="file" id="f2-ce-original" accept=".xlsx,.xls,.csv" class="hidden">
                <button id="f2-ce-original-btn" class="w-full px-4 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Ch·ªçn file CE g·ªëc</button>
                <div class="flex items-center gap-2">
                  <span id="f2-ce-original-name" class="text-sm text-gray-500 flex-1">Ch∆∞a ch·ªçn file</span>
                  <button id="f2-ce-original-remove" class="text-red-500 hover:text-red-700 text-sm hidden">‚úï</button>
                </div>
              </div>
            </div>

            <!-- CE sau r√† so√°t -->
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
              <label class="block text-sm font-medium text-gray-700 mb-2">2. CE sau r√† so√°t</label>
              <div class="flex flex-col gap-2">
                <input type="file" id="f2-ce-review" accept=".xlsx,.xls,.csv" class="hidden">
                <button id="f2-ce-review-btn" class="w-full px-4 py-2 rounded-lg border border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100">Ch·ªçn file CE sau r√† so√°t</button>
                <div class="flex items-center gap-2">
                  <span id="f2-ce-review-name" class="text-sm text-gray-500 flex-1">Ch∆∞a ch·ªçn file</span>
                  <button id="f2-ce-review-remove" class="text-red-500 hover:text-red-700 text-sm hidden">‚úï</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- K·∫øt qu·∫£ (n·∫øu c√≥) -->
        <div id="f2-declaration-result" class="hidden">
          <h4 class="text-lg font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-4">K·∫øt qu·∫£</h4>
          <div class="border border-gray-200 rounded-lg bg-gray-50 p-4">
            <div id="f2-declaration-result-content" class="text-sm"></div>
          </div>
        </div>
      </div>
      
      <!-- Modal Footer -->
      <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
        <button id="modal-f2-declaration-close-btn" class="modal-close-btn modal-f2-declaration-close-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
          ƒê√≥ng
        </button>
        <button id="modal-f2-declaration-submit" class="modal-submit modal-f2-declaration-submit px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
          G·ª≠i l√™n server
        </button>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 2: DECLARATION -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: ADD SUBTASK (Th√™m t√°c v·ª• con) -->
  <!-- ============================================ -->
  <div id="modal-f5-add-subtask" class="modal-container modal-f5-add-subtask fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-add-subtask-overlay" class="modal-overlay modal-f5-add-subtask-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-add-subtask-content" class="modal-content modal-f5-add-subtask-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-2xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50">
        <div class="flex items-start justify-between">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Th√™m t√°c v·ª• con</h2>
            <p class="text-sm text-gray-600">T√°c v·ª• con cho: <span id="modal-f5-add-subtask-parent-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-add-subtask-close" class="modal-close modal-f5-add-subtask-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <form id="modal-f5-add-subtask-form" class="modal-form modal-f5-add-subtask-form mt-8">
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-name">T√™n t√°c v·ª• con *</label>
              <input required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-name" placeholder="V√≠ d·ª•: Ki·ªÉm tra ƒë·ªô k√≠n" type="text"/>
            </div>
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-item-code">M√£ linh ki·ªán/s·∫£n ph·∫©m</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-item-code" placeholder="Nh·∫≠p m√£ linh ki·ªán/s·∫£n ph·∫©m" type="text"/>
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-pic">Ng∆∞·ªùi th·ª±c hi·ªán</label>
              <select class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-pic">
                <option value="">Ch·ªçn th√†nh vi√™n</option>
                <option>Nguy·ªÖn H·ªØu Th·ªãnh</option>
                <option>ƒê·ªó Quang Long</option>
                <option>Nguy·ªÖn Th·ªã Hi·ªÅn</option>
                <option>V≈© Th·ªã H·∫±ng</option>
                <option>Ph·∫°m Th√†nh Trung Ki√™n</option>
                <option>L√™ Ng·ªçc √Ånh</option>
                <option>H√† M·ªπ Linh</option>
                <option>B√πi ƒê·∫∑ng Qu·ªëc Huy</option>
                <option>Ph·∫°m Th·ªã Minh</option>
                <option>ƒê√†o Tu·∫•n K·ª≥</option>
                <option>L√™ VƒÉn S∆°n</option>
                <option>L·∫°i Qu·ªëc L·ªôc</option>
                <option>Th√°i Th·ªã Giang</option>
                <option>L√™ Th·ªã Th·∫£o</option>
                <option>V≈© Th·ªã Thanh Hi·ªÅn</option>
                <option>Tr·∫ßn Hi·∫øu Nghƒ©a</option>
              </select>
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-manhour">S·ªë gi·ªù c√¥ng</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-manhour" type="number" step="0.1" min="0" placeholder="V√≠ d·ª•: 8.5"/>
            </div>
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-checklist">Checklist (File ƒë√≠nh k√®m)</label>
              <input type="file" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-checklist" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt"/>
              <p class="mt-1 text-xs text-gray-500">Ch·ªçn file checklist ƒë·ªÉ ƒë√≠nh k√®m (PDF, Word, Excel, ho·∫∑c Text)</p>
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-timesend">Th·ªùi gian g·ª≠i</label>
              <input class="w-full rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-timesend" type="datetime-local" readonly/>
              <p class="mt-1 text-xs text-gray-500">T·ª± ƒë·ªông ƒëi·ªÅn theo gi·ªù h·ªá th·ªëng</p>
            </div>
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-note">Ghi ch√∫</label>
              <textarea class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-note" rows="3" placeholder="Nh·∫≠p ghi ch√∫ cho t√°c v·ª• con"></textarea>
            </div>
            <div class="col-span-1 md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-add-subtask-declaration-mode">Ch·∫ø ƒë·ªô khai b√°o *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-add-subtask-declaration-mode">
                <option value="">Ch·ªçn ch·∫ø ƒë·ªô khai b√°o</option>
                <option value="review-file-nctn">R√† so√°t file v·ªõi NCTN</option>
                <option value="review-ce-qc">G·ª≠i r√† so√°t CE v·ªõi QC</option>
                <option value="train-qc">ƒê√†o t·∫°o QC</option>
                <option value="send-test-task">G·ª≠i t√°c v·ª• th·ª≠ nghi·ªám</option>
                <option value="review-4m">R√† so√°t 4M</option>
                <option value="review-fmea">R√† so√°t FMEA</option>
              </select>
              <p class="mt-1 text-xs text-gray-500">Ch·ªçn ch·∫ø ƒë·ªô khai b√°o s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng cho t√°c v·ª• con n√†y</p>
            </div>
          </div>
          <input type="hidden" id="modal-f5-add-subtask-task-id" value=""/>
          <div class="mt-8 flex justify-end gap-3">
            <button type="button" id="modal-f5-add-subtask-cancel" class="modal-cancel-btn modal-f5-add-subtask-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
            <button type="submit" class="modal-submit-btn modal-f5-add-subtask-submit-btn flex h-11 items-center justify-center gap-2 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm transition-shadow hover:shadow-md">
              <span class="material-symbols-outlined">add</span>
              <span>Th√™m t√°c v·ª•</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: ADD SUBTASK -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: SELECT DECLARATION MODE (Ch·ªçn ch·∫ø ƒë·ªô khai b√°o) -->
  <!-- ============================================ -->
  <div id="modal-f5-select-declaration" class="modal-container modal-f5-select-declaration fixed inset-0 z-50 hidden" style="display: none !important;">
    <div id="modal-f5-select-declaration-overlay" class="modal-overlay modal-f5-select-declaration-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-select-declaration-content" class="modal-content modal-f5-select-declaration-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-2xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Ch·ªçn ch·∫ø ƒë·ªô khai b√°o</h2>
            <p class="text-sm text-gray-600">T√°c v·ª•: <span id="modal-f5-select-declaration-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-select-declaration-close" class="modal-close modal-f5-select-declaration-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="review-file-nctn">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                <span class="material-symbols-outlined text-blue-600">folder_open</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">R√† so√°t file v·ªõi NCTN</h3>
                <p class="text-xs text-gray-500 mt-0.5">Ki·ªÉm tra v√† r√† so√°t file v·ªõi NCTN</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="review-ce-qc">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center group-hover:bg-green-200 transition-colors">
                <span class="material-symbols-outlined text-green-600">verified</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">G·ª≠i r√† so√°t CE v·ªõi QC</h3>
                <p class="text-xs text-gray-500 mt-0.5">G·ª≠i file CE ƒë·ªÉ QC r√† so√°t</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="train-qc">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center group-hover:bg-purple-200 transition-colors">
                <span class="material-symbols-outlined text-purple-600">school</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">ƒê√†o t·∫°o QC</h3>
                <p class="text-xs text-gray-500 mt-0.5">T·ªï ch·ª©c ƒë√†o t·∫°o cho ƒë·ªôi QC</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="send-test-task">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                <span class="material-symbols-outlined text-orange-600">science</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">G·ª≠i t√°c v·ª• th·ª≠ nghi·ªám</h3>
                <p class="text-xs text-gray-500 mt-0.5">G·ª≠i y√™u c·∫ßu th·ª≠ nghi·ªám</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="review-4m">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-yellow-100 flex items-center justify-center group-hover:bg-yellow-200 transition-colors">
                <span class="material-symbols-outlined text-yellow-600">checklist</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">R√† so√°t 4M</h3>
                <p class="text-xs text-gray-500 mt-0.5">R√† so√°t Man, Machine, Material, Method</p>
              </div>
            </div>
          </button>
          
          <button type="button" class="f5-declaration-mode-btn flex flex-col items-start gap-3 p-4 rounded-lg border-2 border-gray-200 hover:border-primary-blue hover:bg-blue-50 transition-all group" data-mode="review-fmea">
            <div class="flex items-center gap-3 w-full">
              <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center group-hover:bg-red-200 transition-colors">
                <span class="material-symbols-outlined text-red-600">warning</span>
              </div>
              <div class="flex-1 text-left">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-blue">R√† so√°t FMEA</h3>
                <p class="text-xs text-gray-500 mt-0.5">R√† so√°t Failure Mode and Effects Analysis</p>
              </div>
            </div>
          </button>
        </div>
        
        <div class="mt-6 flex justify-end">
          <button type="button" id="modal-f5-select-declaration-cancel" class="modal-cancel-btn modal-f5-select-declaration-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: SELECT DECLARATION MODE -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: IMPORT EXCEL -->
  <!-- ============================================ -->
  <div id="modal-f5-import-excel" class="modal-container modal-f5-import-excel fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-import-excel-overlay" class="modal-overlay modal-f5-import-excel-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-import-excel-content" class="modal-content modal-f5-import-excel-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Import Tasks t·ª´ Excel</h2>
            <p class="text-sm text-gray-600">Upload file Excel ƒë·ªÉ import tasks v√† subtasks v√†o h·ªá th·ªëng</p>
          </div>
          <button id="modal-f5-import-excel-close" class="modal-close modal-f5-import-excel-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <!-- H∆∞·ªõng d·∫´n format Excel -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <h3 class="text-sm font-semibold text-blue-900 mb-2">üìã H∆∞·ªõng d·∫´n format file Excel:</h3>
              <ul class="text-xs text-blue-800 space-y-1 list-disc list-inside">
                <li>Sheet ƒë·∫ßu ti√™n s·∫Ω ƒë∆∞·ª£c ƒë·ªçc</li>
                <li>C·ªôt b·∫Øt bu·ªôc: <strong>Project Code</strong>, <strong>Task Request Code</strong>, <strong>Task Name</strong></li>
                <li>C·ªôt t√πy ch·ªçn: Project Name, Requester Name, Requester Email, PIC, Department, Created At, Due Date, Status</li>
                <li>ƒê·ªÉ th√™m Subtask: th√™m d√≤ng v·ªõi c√πng <strong>Task Request Code</strong> v√† ƒëi·ªÅn <strong>Subtask No</strong> (s·ªë > 0)</li>
                <li>C·ªôt Subtask: Subtask Name, Subtask PIC, Subtask Manhour, Subtask Status, Subtask Timesend, Subtask Note, Declaration Mode</li>
              </ul>
            </div>
            <button id="f5-download-template-btn" class="ml-4 flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium whitespace-nowrap">
              <span class="material-symbols-outlined text-lg">download</span>
              T·∫£i file m·∫´u
            </button>
          </div>
        </div>

        <!-- Upload file -->
        <div class="mb-6">
          <label class="mb-2 block text-sm font-medium text-gray-700">Ch·ªçn file Excel (.xlsx, .xls)</label>
          <div class="flex flex-col gap-2">
            <input type="file" id="f5-import-excel-file" accept=".xlsx,.xls" class="hidden">
            <button id="f5-import-excel-file-btn" class="w-full px-4 py-3 rounded-lg border-2 border-dashed border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100 transition-colors font-medium">
              <span class="material-symbols-outlined align-middle mr-2">upload_file</span>
              Ch·ªçn file Excel
            </button>
            <div class="flex items-center gap-2">
              <span id="f5-import-excel-file-name" class="text-sm text-gray-500 flex-1">Ch∆∞a ch·ªçn file</span>
              <button id="f5-import-excel-file-remove" class="text-red-500 hover:text-red-700 text-sm hidden">‚úï</button>
            </div>
          </div>
        </div>

        <!-- Preview k·∫øt qu·∫£ -->
        <div id="f5-import-excel-preview" class="hidden mb-6">
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Xem tr∆∞·ªõc d·ªØ li·ªáu:</h3>
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 max-h-64 overflow-y-auto">
            <div id="f5-import-excel-preview-content" class="text-sm text-gray-600"></div>
          </div>
        </div>

        <!-- Th√¥ng b√°o l·ªói -->
        <div id="f5-import-excel-error" class="hidden mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
          <div class="flex items-start gap-2">
            <span class="material-symbols-outlined text-red-600">error</span>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-red-900 mb-1">L·ªói import</h4>
              <div id="f5-import-excel-error-content" class="text-xs text-red-800"></div>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex justify-end gap-3">
          <button type="button" id="modal-f5-import-excel-cancel" class="modal-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="button" id="modal-f5-import-excel-submit" class="modal-submit-btn flex h-11 items-center justify-center gap-2 rounded-full bg-green-600 px-6 text-sm font-bold text-white shadow-sm transition-shadow hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <span class="material-symbols-outlined">upload</span>
            <span>Import d·ªØ li·ªáu</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: IMPORT EXCEL -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: DECLARATION MODALS -->
  <!-- ============================================ -->
  
  <!-- Modal: R√† so√°t file v·ªõi NCTN -->
  <div id="modal-f5-declaration-review-file-nctn" class="modal-container modal-f5-declaration-review-file-nctn fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-review-file-nctn-overlay" class="modal-overlay modal-f5-declaration-review-file-nctn-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-review-file-nctn-content" class="modal-content modal-f5-declaration-review-file-nctn-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">R√† so√°t file v·ªõi NCTN</h2>
            <p class="text-sm text-gray-600">T√°c v·ª•: <span id="modal-f5-declaration-review-file-nctn-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-review-file-nctn-close" class="modal-close modal-f5-declaration-review-file-nctn-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-review-file-nctn-body" class="modal-body modal-f5-declaration-review-file-nctn-body">
          <form id="modal-f5-declaration-review-file-nctn-form" class="space-y-6">
            <!-- Tr·∫°ng th√°i -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-file-nctn-status">Tr·∫°ng th√°i *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-file-nctn-status">
                <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                <option value="Cancel">Cancel</option>
                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
              </select>
            </div>

            <!-- Link k·∫øt qu·∫£ -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-file-nctn-result-link">Link k·∫øt qu·∫£</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-file-nctn-result-link" placeholder="Nh·∫≠p link k·∫øt qu·∫£" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-review-file-nctn-cancel" class="modal-cancel-btn modal-f5-declaration-review-file-nctn-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="button" id="modal-f5-declaration-review-file-nctn-submit" class="modal-submit-btn modal-f5-declaration-review-file-nctn-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">G·ª≠i</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: G·ª≠i r√† so√°t CE v·ªõi QC -->
  <div id="modal-f5-declaration-review-ce-qc" class="modal-container modal-f5-declaration-review-ce-qc fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-review-ce-qc-overlay" class="modal-overlay modal-f5-declaration-review-ce-qc-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-review-ce-qc-content" class="modal-content modal-f5-declaration-review-ce-qc-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">G·ª≠i r√† so√°t CE v·ªõi QC</h2>
            <p class="text-sm text-gray-600">T√°c v·ª•: <span id="modal-f5-declaration-review-ce-qc-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-review-ce-qc-close" class="modal-close modal-f5-declaration-review-ce-qc-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-review-ce-qc-body" class="modal-body modal-f5-declaration-review-ce-qc-body">
          <form id="modal-f5-declaration-review-ce-qc-form" class="space-y-6">
            <!-- Tr·∫°ng th√°i -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-ce-qc-status">Tr·∫°ng th√°i *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-ce-qc-status">
                <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                <option value="Cancel">Cancel</option>
                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
              </select>
            </div>

            <!-- Link k·∫øt qu·∫£ -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-ce-qc-result-link">Link k·∫øt qu·∫£</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-ce-qc-result-link" placeholder="Nh·∫≠p link k·∫øt qu·∫£" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-review-ce-qc-cancel" class="modal-cancel-btn modal-f5-declaration-review-ce-qc-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="button" id="modal-f5-declaration-review-ce-qc-submit" class="modal-submit-btn modal-f5-declaration-review-ce-qc-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">G·ª≠i</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: ƒê√†o t·∫°o QC -->
  <div id="modal-f5-declaration-train-qc" class="modal-container modal-f5-declaration-train-qc fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-train-qc-overlay" class="modal-overlay modal-f5-declaration-train-qc-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-train-qc-content" class="modal-content modal-f5-declaration-train-qc-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">ƒê√†o t·∫°o QC</h2>
            <p class="text-sm text-gray-600">T√°c v·ª•: <span id="modal-f5-declaration-train-qc-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-train-qc-close" class="modal-close modal-f5-declaration-train-qc-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-train-qc-body" class="modal-body modal-f5-declaration-train-qc-body">
          <form id="modal-f5-declaration-train-qc-form" class="space-y-6">
            <!-- Tr·∫°ng th√°i -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-train-qc-status">Tr·∫°ng th√°i *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-train-qc-status">
                <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                <option value="Cancel">Cancel</option>
                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
              </select>
            </div>

            <!-- Link k·∫øt qu·∫£ -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-train-qc-result-link">Link k·∫øt qu·∫£</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-train-qc-result-link" placeholder="Nh·∫≠p link k·∫øt qu·∫£" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-train-qc-cancel" class="modal-cancel-btn modal-f5-declaration-train-qc-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="button" id="modal-f5-declaration-train-qc-submit" class="modal-submit-btn modal-f5-declaration-train-qc-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">G·ª≠i</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: G·ª≠i t√°c v·ª• th·ª≠ nghi·ªám -->
  <div id="modal-f5-declaration-send-test-task" class="modal-container modal-f5-declaration-send-test-task fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-send-test-task-overlay" class="modal-overlay modal-f5-declaration-send-test-task-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-send-test-task-content" class="modal-content modal-f5-declaration-send-test-task-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">G·ª≠i form b√°o c√°o</h2>
            <p class="text-sm text-gray-600">T√°c v·ª•: <span id="modal-f5-declaration-send-test-task-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-send-test-task-close" class="modal-close modal-f5-declaration-send-test-task-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-send-test-task-body" class="modal-body modal-f5-declaration-send-test-task-body">
          <form id="modal-f5-declaration-send-test-task-form" class="space-y-6">
            <!-- File ƒë√≠nh k√®m -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-send-test-task-attachment">File ƒë√≠nh k√®m</label>
              <div class="flex flex-col gap-2">
                <input type="file" id="modal-f5-declaration-send-test-task-attachment" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                <button type="button" id="modal-f5-declaration-send-test-task-attachment-btn" class="w-full px-4 py-2 rounded-lg border-2 border-dashed border-blue-300 text-primary-blue bg-blue-50 hover:bg-blue-100 transition-colors font-medium flex items-center justify-center gap-2">
                  <span class="material-symbols-outlined">attach_file</span>
                  <span>Ch·ªçn file ƒë√≠nh k√®m</span>
                </button>
                <div class="flex items-center gap-2">
                  <span id="modal-f5-declaration-send-test-task-attachment-name" class="text-sm text-gray-500 flex-1">Ch∆∞a ch·ªçn file</span>
                  <button type="button" id="modal-f5-declaration-send-test-task-attachment-remove" class="text-red-500 hover:text-red-700 text-sm hidden">‚úï</button>
                </div>
              </div>
              <p class="mt-1 text-xs text-gray-500">Ch·ªçn file form b√°o c√°o ƒë·ªÉ ƒë√≠nh k√®m (PDF, Word, Excel, ho·∫∑c h√¨nh ·∫£nh)</p>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-send-test-task-cancel" class="modal-cancel-btn modal-f5-declaration-send-test-task-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="button" id="modal-f5-declaration-send-test-task-submit" class="modal-submit-btn modal-f5-declaration-send-test-task-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">G·ª≠i form b√°o c√°o</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: R√† so√°t 4M -->
  <div id="modal-f5-declaration-review-4m" class="modal-container modal-f5-declaration-review-4m fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-review-4m-overlay" class="modal-overlay modal-f5-declaration-review-4m-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-review-4m-content" class="modal-content modal-f5-declaration-review-4m-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">R√† so√°t 4M</h2>
            <p class="text-sm text-gray-600">T√°c v·ª•: <span id="modal-f5-declaration-review-4m-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-review-4m-close" class="modal-close modal-f5-declaration-review-4m-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-review-4m-body" class="modal-body modal-f5-declaration-review-4m-body">
          <form id="modal-f5-declaration-review-4m-form" class="space-y-6">
            <!-- Tr·∫°ng th√°i -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-4m-status">Tr·∫°ng th√°i *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-4m-status">
                <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                <option value="Cancel">Cancel</option>
                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
              </select>
            </div>

            <!-- Link k·∫øt qu·∫£ -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-4m-result-link">Link k·∫øt qu·∫£</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-4m-result-link" placeholder="Nh·∫≠p link k·∫øt qu·∫£" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-review-4m-cancel" class="modal-cancel-btn modal-f5-declaration-review-4m-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="button" id="modal-f5-declaration-review-4m-submit" class="modal-submit-btn modal-f5-declaration-review-4m-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">G·ª≠i</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: R√† so√°t FMEA -->
  <div id="modal-f5-declaration-review-fmea" class="modal-container modal-f5-declaration-review-fmea fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-review-fmea-overlay" class="modal-overlay modal-f5-declaration-review-fmea-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-review-fmea-content" class="modal-content modal-f5-declaration-review-fmea-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">R√† so√°t FMEA</h2>
            <p class="text-sm text-gray-600">T√°c v·ª•: <span id="modal-f5-declaration-review-fmea-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-review-fmea-close" class="modal-close modal-f5-declaration-review-fmea-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-review-fmea-body" class="modal-body modal-f5-declaration-review-fmea-body">
          <form id="modal-f5-declaration-review-fmea-form" class="space-y-6">
            <!-- Tr·∫°ng th√°i -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-fmea-status">Tr·∫°ng th√°i *</label>
              <select required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-fmea-status">
                <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                <option value="Cancel">Cancel</option>
                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
              </select>
            </div>

            <!-- Link k·∫øt qu·∫£ -->
            <div>
              <label class="mb-1 block text-sm font-medium text-gray-700" for="modal-f5-declaration-review-fmea-result-link">Link k·∫øt qu·∫£</label>
              <input class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-primary-blue focus:ring-primary-blue" id="modal-f5-declaration-review-fmea-result-link" placeholder="Nh·∫≠p link k·∫øt qu·∫£" type="text"/>
            </div>
          </form>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-review-fmea-cancel" class="modal-cancel-btn modal-f5-declaration-review-fmea-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="button" id="modal-f5-declaration-review-fmea-submit" class="modal-submit-btn modal-f5-declaration-review-fmea-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">G·ª≠i</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Khai b√°o ho√†n th√†nh -->
  <div id="modal-f5-declaration-complete" class="modal-container modal-f5-declaration-complete fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-declaration-complete-overlay" class="modal-overlay modal-f5-declaration-complete-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-declaration-complete-content" class="modal-content modal-f5-declaration-complete-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Khai b√°o ho√†n th√†nh</h2>
            <p class="text-sm text-gray-600">T√°c v·ª•: <span id="modal-f5-declaration-complete-task-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-declaration-complete-close" class="modal-close modal-f5-declaration-complete-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-declaration-complete-body" class="modal-body modal-f5-declaration-complete-body p-4 space-y-3 min-h-[460px]">
          <!-- Tabs for Gate 1 / Gate 2 / Gate 3 -->
          <div id="modal-f5-declaration-complete-tabs-wrap" class="flex items-end gap-2 text-sm mb-4">
            <button id="modal-f5-declaration-complete-tab-gate1" class="px-5 py-2.5 rounded-t-lg border border-cyan-400 bg-cyan-200 text-cyan-900 -mb-[1px] text-base md:text-lg font-semibold shadow-sm">Gate 1: B√°o c√°o LK/M√°y</button>
            <button id="modal-f5-declaration-complete-tab-gate2" class="px-5 py-2.5 rounded-t-lg border border-cyan-400 bg-cyan-200 text-cyan-900 -mb-[1px] text-base md:text-lg font-semibold shadow-sm">Gate 2: B√°o c√°o m√°y Base, r√† so√°t tem nh√£n</button>
            <button id="modal-f5-declaration-complete-tab-gate3" class="px-5 py-2.5 rounded-t-lg border border-cyan-400 bg-cyan-200 text-cyan-900 -mb-[1px] text-base md:text-lg font-semibold shadow-sm" style="display:none">Gate 3: C·∫≠p nh·∫≠t b√°o c√°o</button>
          </div>
          
          <!-- Th√¥ng tin ng∆∞·ªùi n·ªôp, m√£, t√°c v·ª• -->
          <div class="flex flex-wrap gap-2 text-sm">
            <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">Ng∆∞·ªùi n·ªôp: <b class="ml-1" id="modal-f5-declaration-complete-uploader-name"></b></span>
            <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">M√£: <b class="ml-1" id="modal-f5-declaration-complete-uploader-code"></b></span>
            <span class="px-3 py-1 rounded-full bg-blue-50 border border-blue-200">T√°c v·ª•: <b class="ml-1" id="modal-f5-declaration-complete-uploader-task"></b></span>
          </div>
          
          <!-- Gate 1 heading -->
          <div id="modal-f5-declaration-complete-gate1-title" class="mt-2 mb-1 text-3xl md:text-4xl font-bold text-cyan-700">Gate 1: B√°o c√°o LK/M√°y</div>
          
          <!-- Gate 1: Upload files -->
          <div id="modal-f5-declaration-complete-upload-form1-split">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o PDF (.pdf)</label>
              <input id="modal-f5-declaration-complete-file-pdfzip" type="file" accept=".pdf" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-indigo-600 file:text-white"/>
              <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp .pdf.</p>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o Excel (.xlsx)</label>
              <input id="modal-f5-declaration-complete-file-xlsxzip" type="file" accept=".xlsx" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white"/>
              <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp .xlsx.</p>
            </div>
          </div>
          
          <!-- Gate 1: Ph√¢n lo·∫°i -->
          <div id="modal-f5-declaration-complete-classification-group" class="mt-3 highlight-section">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ph√¢n lo·∫°i</label>
            <div class="flex flex-col gap-2">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="modal-f5-declaration-complete-classification" value="S·∫£n ph·∫©m" class="h-4 w-4"/>
                <span class="text-sm">S·∫£n ph·∫©m</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="modal-f5-declaration-complete-classification" value="Linh ki·ªán" class="h-4 w-4"/>
                <span class="text-sm">Linh ki·ªán</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="modal-f5-declaration-complete-classification" value="T√°c v·ª• kh√°c" class="h-4 w-4"/>
                <span class="text-sm">T√°c v·ª• kh√°c</span>
              </label>
            </div>
            <div id="modal-f5-declaration-complete-classification-note" class="mt-2 text-xs text-gray-500">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c g·ª≠i l√™n h·ªá th·ªëng ph√¢n t√≠ch</div>
          </div>
          
          <!-- Gate 1: K·∫øt lu·∫≠n -->
          <div id="modal-f5-declaration-complete-conclusion-group" class="mt-3 highlight-section">
            <label class="block text-sm font-medium text-gray-700 mb-1">K·∫øt lu·∫≠n</label>
            <div class="flex flex-col gap-2">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="modal-f5-declaration-complete-conclusion" value="S·∫£n ph·∫©m ƒë·∫°t ch·∫•t l∆∞·ª£ng" class="h-4 w-4"/>
                <span class="text-sm">S·∫£n ph·∫©m ƒë·∫°t ch·∫•t l∆∞·ª£ng</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="modal-f5-declaration-complete-conclusion" value="S·∫£n ph·∫©m kh√¥ng ƒë·∫°t ch·∫•t l∆∞·ª£ng" class="h-4 w-4"/>
                <span class="text-sm">S·∫£n ph·∫©m kh√¥ng ƒë·∫°t ch·∫•t l∆∞·ª£ng</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="modal-f5-declaration-complete-conclusion" value="B√°o c√°o tham kh·∫£o" class="h-4 w-4"/>
                <span class="text-sm">B√°o c√°o tham kh·∫£o</span>
              </label>
            </div>
          </div>
          
          <!-- Gate 1: Khai b√°o test b·ªÅn -->
          <div id="modal-f5-declaration-complete-durability-group" class="mt-3 highlight-section">
            <label class="block text-sm font-medium text-gray-700 mb-1">Khai b√°o test b·ªÅn</label>
            <div class="flex flex-col gap-2">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="modal-f5-declaration-complete-durability-choice" value="co" class="h-4 w-4"/>
                <span class="text-sm">C√≥ test b·ªÅn</span>
              </label>
              <div id="modal-f5-declaration-complete-durability-date-wrap" class="ml-6 mt-1" style="display:none">
                <label class="block text-xs text-gray-600 mb-1">Ng√†y d·ª± ki·∫øn tr·∫£ test b·ªÅn</label>
                <input id="modal-f5-declaration-complete-durability-date" type="date" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white"/>
              </div>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="modal-f5-declaration-complete-durability-choice" value="khong" class="h-4 w-4"/>
                <span class="text-sm">Kh√¥ng test b·ªÅn</span>
              </label>
            </div>
          </div>
          
          <!-- Gate 2: ch·ªâ nh·∫≠n file n√©n -->
          <div id="modal-f5-declaration-complete-gate2" class="mt-3" style="display:none">
            <div id="modal-f5-declaration-complete-gate2-title" class="mb-2 text-3xl md:text-4xl font-bold text-cyan-700">Gate 2: B√°o c√°o m√°y Base, r√† so√°t tem nh√£n</div>
            <label class="block text-sm font-medium text-gray-700 mb-1">T·ªáp n√©n b√°o c√°o (Gate 2)</label>
            <input id="modal-f5-declaration-complete-file-archive-g2" type="file" accept=".zip,.rar,.7z" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
            <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp n√©n: .zip, .rar, .7z</p>
            <!-- Gate 2: Ph√¢n lo·∫°i -->
            <div id="modal-f5-declaration-complete-classification-group-g2" class="mt-3 highlight-section">
              <label class="block text-sm font-medium text-gray-700 mb-1">Ph√¢n lo·∫°i</label>
              <div class="flex flex-col gap-2">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="modal-f5-declaration-complete-classification-g2" value="S·∫£n ph·∫©m" class="h-4 w-4"/>
                  <span class="text-sm">S·∫£n ph·∫©m</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="modal-f5-declaration-complete-classification-g2" value="Linh ki·ªán" class="h-4 w-4"/>
                  <span class="text-sm">Linh ki·ªán</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="modal-f5-declaration-complete-classification-g2" value="T√°c v·ª• kh√°c" class="h-4 w-4"/>
                  <span class="text-sm">T√°c v·ª• kh√°c</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Gate 3: C·∫≠p nh·∫≠t b√°o c√°o (ch·ªâ hi·ªÉn th·ªã khi t√°c v·ª• ƒë√£ done) -->
          <div id="modal-f5-declaration-complete-gate3" class="mt-3" style="display:none">
            <div id="modal-f5-declaration-complete-gate3-title" class="mb-2 text-3xl md:text-4xl font-bold text-cyan-700">Gate 3: C·∫≠p nh·∫≠t b√°o c√°o</div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o PDF (.pdf)</label>
              <input id="modal-f5-declaration-complete-file-pdfzip-g3" type="file" accept=".pdf" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-indigo-600 file:text-white"/>
              <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp .pdf (t√πy ch·ªçn).</p>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">B√°o c√°o Excel (.xlsx)</label>
              <input id="modal-f5-declaration-complete-file-xlsxzip-g3" type="file" accept=".xlsx" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-emerald-600 file:text-white"/>
              <p class="text-xs text-gray-500 mt-1">Ch·ªâ nh·∫≠n t·ªáp .xlsx (t√πy ch·ªçn).</p>
            </div>
            <!-- Gate 3: K·∫øt lu·∫≠n -->
            <div class="mt-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">K·∫øt lu·∫≠n</label>
              <div class="flex flex-col gap-2">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="modal-f5-declaration-complete-conclusion-g3" value="S·∫£n ph·∫©m ƒë·∫°t ch·∫•t l∆∞·ª£ng" class="h-4 w-4"/>
                  <span class="text-sm">S·∫£n ph·∫©m ƒë·∫°t ch·∫•t l∆∞·ª£ng</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="modal-f5-declaration-complete-conclusion-g3" value="S·∫£n ph·∫©m kh√¥ng ƒë·∫°t ch·∫•t l∆∞·ª£ng" class="h-4 w-4"/>
                  <span class="text-sm">S·∫£n ph·∫©m kh√¥ng ƒë·∫°t ch·∫•t l∆∞·ª£ng</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" name="modal-f5-declaration-complete-conclusion-g3" value="B√°o c√°o tham kh·∫£o" class="h-4 w-4"/>
                  <span class="text-sm">B√°o c√°o tham kh·∫£o</span>
                </label>
              </div>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">N·ªôi dung c·∫≠p nh·∫≠t *</label>
              <textarea id="modal-f5-declaration-complete-gate3-content" rows="5" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white resize-y" placeholder="Nh·∫≠p n·ªôi dung c·∫≠p nh·∫≠t b√°o c√°o..."></textarea>
              <p class="text-xs text-gray-500 mt-1">Gate 3 ch·ªâ s·ª≠ d·ª•ng khi t√°c v·ª• ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh (Done).</p>
            </div>
          </div>
          
          <!-- Checkbox Tr·∫£ b√°o c√°o BPS -->
          <div id="modal-f5-declaration-complete-bps-option" class="flex items-center gap-2">
            <input id="modal-f5-declaration-complete-upload-bps" type="checkbox" class="h-4 w-4" checked>
            <label for="modal-f5-declaration-complete-upload-bps" class="text-sm text-gray-700 select-none">Tr·∫£ b√°o c√°o BPS</label>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="modal-f5-declaration-complete-cancel" class="modal-cancel-btn modal-f5-declaration-complete-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="button" id="modal-f5-declaration-complete-submit" class="modal-submit-btn modal-f5-declaration-complete-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">G·ª≠i</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: DECLARATION MODALS -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: SUBTASK DOWNLOAD REPORTS (T·∫£i b√°o c√°o) -->
  <!-- ============================================ -->
  <div id="modal-f5-subtask-download" class="modal-container modal-f5-subtask-download fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-subtask-download-overlay" class="modal-overlay modal-f5-subtask-download-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-subtask-download-content" class="modal-content modal-f5-subtask-download-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-md rounded-xl bg-white p-6 shadow-xl pointer-events-auto relative z-50">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">T·∫£i b√°o c√°o</h2>
            <p class="text-sm text-gray-600">Subtask: <span id="modal-f5-subtask-download-subtask-name" class="font-medium text-gray-900"></span></p>
          </div>
          <button id="modal-f5-subtask-download-close" class="modal-close modal-f5-subtask-download-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div class="space-y-4">
          <!-- N√∫t t·∫£i b√°o c√°o PDF -->
          <button type="button" id="modal-f5-subtask-download-pdf-btn" class="w-full flex items-center justify-center gap-3 px-6 py-4 rounded-lg border-2 border-red-300 bg-red-50 hover:bg-red-100 text-red-700 font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <span class="material-symbols-outlined text-2xl">picture_as_pdf</span>
            <span>T·∫£i b√°o c√°o PDF</span>
          </button>
          
          <!-- N√∫t t·∫£i b√°o c√°o Excel -->
          <button type="button" id="modal-f5-subtask-download-excel-btn" class="w-full flex items-center justify-center gap-3 px-6 py-4 rounded-lg border-2 border-green-300 bg-green-50 hover:bg-green-100 text-green-700 font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <span class="material-symbols-outlined text-2xl">table_chart</span>
            <span>T·∫£i b√°o c√°o Excel</span>
          </button>
        </div>
        
        <div class="mt-6 flex justify-end">
          <button type="button" id="modal-f5-subtask-download-cancel" class="modal-cancel-btn modal-f5-subtask-download-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: SUBTASK DOWNLOAD REPORTS -->
  <!-- ============================================ -->

  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 3: DECLARATION (Khai b√°o thay ƒë·ªïi) -->
  <!-- ============================================ -->
  <div id="modal-f3-declaration" class="modal-container modal-f3-declaration fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f3-declaration-overlay" class="modal-overlay modal-f3-declaration-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f3-declaration-content" class="modal-content modal-f3-declaration-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">C·∫≠p nh·∫≠t th√¥ng tin</h2>
            <p class="text-sm text-gray-600">C·∫≠p nh·∫≠t tr·∫°ng th√°i, Jira Key v√† Note cho t√°c v·ª•</p>
          </div>
          <button id="modal-f3-declaration-close" class="modal-close modal-f3-declaration-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <!-- Modal Body -->
        <div id="modal-f3-declaration-body" class="modal-body modal-f3-declaration-body overflow-y-auto flex-1 p-4 space-y-6">
          <!-- Th√¥ng tin t√°c v·ª• -->
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <h4 class="text-lg font-semibold text-gray-700 mb-3">Th√¥ng tin t√°c v·ª•</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Epic</label>
                <input type="text" id="modal-f3-declaration-epic" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" readonly/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Story</label>
                <input type="text" id="modal-f3-declaration-story" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" readonly/>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Subtask</label>
                <input type="text" id="modal-f3-declaration-subtask" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" readonly/>
              </div>
            </div>
          </div>

          <!-- C·∫≠p nh·∫≠t th√¥ng tin -->
          <div class="border border-gray-200 rounded-lg p-4 bg-blue-50">
            <h4 class="text-lg font-semibold text-gray-700 mb-3">C·∫≠p nh·∫≠t th√¥ng tin</h4>
            
            <!-- Tr·∫°ng th√°i -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Tr·∫°ng th√°i *</label>
              <select id="modal-f3-declaration-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                <option value="ƒêang tri·ªÉn khai">ƒêang tri·ªÉn khai</option>
                <option value="Ch∆∞a tri·ªÉn khai">Ch∆∞a tri·ªÉn khai</option>
                <option value="H·ªßy t√°c v·ª•">H·ªßy t√°c v·ª•</option>
              </select>
            </div>

            <!-- M√£ Jira -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">M√£ Jira *</label>
              <input type="text" id="modal-f3-declaration-jira-key" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p M√£ Jira..."/>
            </div>

            <!-- Link jira -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Link jira</label>
              <input type="text" id="modal-f3-declaration-jira-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p link jira..."/>
            </div>

            <!-- Link - ƒê√£ ·∫©n theo y√™u c·∫ßu -->
            <div class="mb-4 hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">Link</label>
              <input type="text" id="modal-f3-declaration-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p link..."/>
            </div>

            <!-- Note -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Note</label>
              <textarea id="modal-f3-declaration-note" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
            </div>
          </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4">
          <button type="button" id="modal-f3-declaration-cancel" class="modal-cancel-btn modal-f3-declaration-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="button" id="modal-f3-declaration-submit" class="modal-submit-btn modal-f3-declaration-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">L∆∞u thay ƒë·ªïi</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 3: DECLARATION -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 3: ADD STORY (Th√™m Story) -->
  <!-- ============================================ -->
  <div id="modal-f3-add-story" class="modal-container modal-f3-add-story fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f3-add-story-overlay" class="modal-overlay modal-f3-add-story-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f3-add-story-content" class="modal-content modal-f3-add-story-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Th√™m Story m·ªõi</h2>
            <p class="text-sm text-gray-600">Th√™m Story v√†o Epic: <span id="modal-f3-add-story-epic-name" class="font-medium text-blue-600"></span></p>
          </div>
          <button id="modal-f3-add-story-close" class="modal-close modal-f3-add-story-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <form id="modal-f3-add-story-form" class="modal-body overflow-y-auto flex-1 space-y-6">
          <input type="hidden" id="modal-f3-add-story-epic-id" />
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">T√™n Story *</label>
              <input type="text" id="modal-f3-add-story-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p t√™n Story..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Story Code *</label>
              <input type="text" id="modal-f3-add-story-code" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="T·ª± ƒë·ªông sinh..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ng∆∞·ªùi th·ª±c hi·ªán *</label>
              <select id="modal-f3-add-story-assignee" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán</option>
                <option>ƒê·ªó Quang Long</option>
                <option>Nguy·ªÖn Th·ªã Hi·ªÅn</option>
                <option>Ph·∫°m Th√†nh Trung Ki√™n</option>
                <option>L√™ Ng·ªçc √Ånh</option>
                <option>H√† M·ªπ Linh</option>
                <option>Ph·∫°m Th·ªã Minh</option>
                <option>L√™ VƒÉn S∆°n</option>
                <option>L·∫°i Qu·ªëc L·ªôc</option>
                <option>L√™ Th·ªã Th·∫£o</option>
                <option>V≈© Th·ªã Thanh Hi·ªÅn</option>
                <option>Nguy·ªÖn H·ªØu Th·ªãnh</option>
                <option>V≈© Th·ªã H·∫±ng</option>
                <option>B√πi ƒê·∫∑ng Qu·ªëc Huy</option>
                <option>ƒê√†o Tu·∫•n K·ª≥</option>
                <option>Th√°i Th·ªã Giang</option>
                <option>Tr·∫ßn Hi·∫øu Nghƒ©a</option>
                <option>Nguy·ªÖn VƒÉn Hi·∫øu</option>
                <option>Nguy·ªÖn VƒÉn Linh</option>
                <option>ƒê√†o Ho√†ng D∆∞∆°ng</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y b·∫Øt ƒë·∫ßu *</label>
              <input type="date" id="modal-f3-add-story-start-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">H·∫°n ho√†n th√†nh *</label>
              <input type="date" id="modal-f3-add-story-due-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">M√£ Jira *</label>
              <input type="text" id="modal-f3-add-story-jira-key" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p M√£ Jira..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Link jira</label>
              <input type="text" id="modal-f3-add-story-jira-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p link jira..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tr·∫°ng th√°i *</label>
              <select id="modal-f3-add-story-status" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-not-allowed">
                <option value="ƒêang tri·ªÉn khai" selected>ƒêang tri·ªÉn khai</option>
              </select>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Note</label>
              <textarea id="modal-f3-add-story-note" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
            </div>
          </div>
        </form>
        
        <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4">
          <button type="button" id="modal-f3-add-story-cancel" class="modal-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="submit" id="modal-f3-add-story-submit" class="modal-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Th√™m Story</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 3: ADD STORY -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 3: ADD SUBTASK (Th√™m Sub-task) -->
  <!-- ============================================ -->
  <div id="modal-f3-add-subtask" class="modal-container modal-f3-add-subtask fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f3-add-subtask-overlay" class="modal-overlay modal-f3-add-subtask-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f3-add-subtask-content" class="modal-content modal-f3-add-subtask-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Th√™m Sub-task m·ªõi</h2>
            <p class="text-sm text-gray-600">Th√™m Sub-task v√†o Story: <span id="modal-f3-add-subtask-story-name" class="font-medium text-blue-600"></span></p>
            <p class="text-xs text-gray-500">Epic: <span id="modal-f3-add-subtask-epic-name" class="font-medium"></span></p>
          </div>
          <button id="modal-f3-add-subtask-close" class="modal-close modal-f3-add-subtask-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <form id="modal-f3-add-subtask-form" class="modal-body overflow-y-auto flex-1 space-y-6">
          <input type="hidden" id="modal-f3-add-subtask-epic-id" />
          <input type="hidden" id="modal-f3-add-subtask-story-id" />
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">T√™n Sub-task *</label>
              <input type="text" id="modal-f3-add-subtask-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p t√™n Sub-task..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Task Code *</label>
              <input type="text" id="modal-f3-add-subtask-task-code" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="T·ª± ƒë·ªông sinh..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ng∆∞·ªùi th·ª±c hi·ªán *</label>
              <select id="modal-f3-add-subtask-assignee" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán</option>
                <option>ƒê·ªó Quang Long</option>
                <option>Nguy·ªÖn Th·ªã Hi·ªÅn</option>
                <option>Ph·∫°m Th√†nh Trung Ki√™n</option>
                <option>L√™ Ng·ªçc √Ånh</option>
                <option>H√† M·ªπ Linh</option>
                <option>Ph·∫°m Th·ªã Minh</option>
                <option>L√™ VƒÉn S∆°n</option>
                <option>L·∫°i Qu·ªëc L·ªôc</option>
                <option>L√™ Th·ªã Th·∫£o</option>
                <option>V≈© Th·ªã Thanh Hi·ªÅn</option>
                <option>Nguy·ªÖn H·ªØu Th·ªãnh</option>
                <option>V≈© Th·ªã H·∫±ng</option>
                <option>B√πi ƒê·∫∑ng Qu·ªëc Huy</option>
                <option>ƒê√†o Tu·∫•n K·ª≥</option>
                <option>Th√°i Th·ªã Giang</option>
                <option>Tr·∫ßn Hi·∫øu Nghƒ©a</option>
                <option>Nguy·ªÖn VƒÉn Hi·∫øu</option>
                <option>Nguy·ªÖn VƒÉn Linh</option>
                <option>ƒê√†o Ho√†ng D∆∞∆°ng</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tr·∫°ng th√°i *</label>
              <select id="modal-f3-add-subtask-status" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-not-allowed">
                <option value="Ch∆∞a tri·ªÉn khai" selected>Ch∆∞a tri·ªÉn khai</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y b·∫Øt ƒë·∫ßu *</label>
              <input type="date" id="modal-f3-add-subtask-start-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">H·∫°n ho√†n th√†nh *</label>
              <input type="date" id="modal-f3-add-subtask-due-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">M√£ Jira *</label>
              <input type="text" id="modal-f3-add-subtask-jira-key" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p M√£ Jira..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Link jira</label>
              <input type="text" id="modal-f3-add-subtask-jira-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p link jira..."/>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Note</label>
              <textarea id="modal-f3-add-subtask-note" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
            </div>
          </div>
        </form>
        
        <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4">
          <button type="button" id="modal-f3-add-subtask-cancel" class="modal-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">H·ªßy</button>
          <button type="submit" id="modal-f3-add-subtask-submit" class="modal-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Th√™m Sub-task</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 3: ADD SUBTASK -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 5: VIEW DETAILS (Chi ti·∫øt d·ª± √°n/task/subtask) -->
  <!-- ============================================ -->
  <div id="modal-f5-view-detail" class="modal-container modal-f5-view-detail fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f5-view-detail-overlay" class="modal-overlay modal-f5-view-detail-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f5-view-detail-content" class="modal-content modal-f5-view-detail-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-4xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 id="modal-f5-view-detail-title" class="text-2xl font-bold text-gray-900">Chi ti·∫øt</h2>
            <p id="modal-f5-view-detail-subtitle" class="text-sm text-gray-600"></p>
          </div>
          <button id="modal-f5-view-detail-close" class="modal-close modal-f5-view-detail-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f5-view-detail-body" class="modal-body modal-f5-view-detail-body overflow-y-auto flex-1">
          <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
        </div>
        
        <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4">
          <button type="button" id="modal-f5-view-detail-close-btn" class="modal-close-btn modal-f5-view-detail-close-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 5: VIEW DETAILS -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 9: VIEW ERROR DETAIL (Chi ti·∫øt l·ªói) -->
  <!-- ============================================ -->
  <div id="modal-f9-view-detail" class="modal-container modal-f9-view-detail fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f9-view-detail-overlay" class="modal-overlay modal-f9-view-detail-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f9-view-detail-content" class="modal-content modal-f9-view-detail-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-7xl rounded-lg bg-white p-6 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200">
          <h2 class="text-xl font-bold text-gray-900">Chi ti·∫øt l·ªói</h2>
          <button id="modal-f9-view-detail-close" class="modal-close modal-f9-view-detail-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f9-view-detail-body" class="modal-body modal-f9-view-detail-body overflow-y-auto flex-1">
          <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
        </div>
        
        <div class="mt-4 flex justify-end gap-2 pt-3 border-t border-gray-200">
          <button type="button" id="modal-f9-view-detail-close-btn" class="modal-close-btn modal-f9-view-detail-close-btn px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 rounded hover:bg-gray-50">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 9: VIEW ERROR DETAIL -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 9: CHI TI·∫æT H·∫†NG M·ª§C NG -->
  <!-- ============================================ -->
  <div id="modal-f9-hang-muc-ng" class="modal-container modal-f9-hang-muc-ng fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f9-hang-muc-ng-overlay" class="modal-overlay modal-f9-hang-muc-ng-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f9-hang-muc-ng-content" class="modal-content modal-f9-hang-muc-ng-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-6xl rounded-lg bg-white p-6 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-red-200">
          <div>
            <h2 class="text-xl font-bold text-red-800">Chi ti·∫øt h·∫°ng m·ª•c NG</h2>
            <p id="modal-f9-hang-muc-ng-subtitle" class="text-sm text-gray-600 mt-1"></p>
          </div>
          <button id="modal-f9-hang-muc-ng-close" class="modal-close modal-f9-hang-muc-ng-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f9-hang-muc-ng-body" class="modal-body modal-f9-hang-muc-ng-body overflow-y-auto flex-1">
          <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
        </div>
        
        <div class="mt-4 flex justify-end gap-2 pt-3 border-t border-gray-200">
          <button type="button" id="modal-f9-hang-muc-ng-close-btn" class="modal-close-btn modal-f9-hang-muc-ng-close-btn px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 rounded hover:bg-gray-50">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 9: CHI TI·∫æT H·∫†NG M·ª§C NG -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 6: CHI TI·∫æT C√Å NH√ÇN -->
  <!-- ============================================ -->
  <div id="modal-f6-person-detail" class="modal-container modal-f6-person-detail fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f6-person-detail-overlay" class="modal-overlay modal-f6-person-detail-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f6-person-detail-content" class="modal-content modal-f6-person-detail-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-6xl rounded-lg bg-white p-6 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200">
          <div>
            <h2 class="text-xl font-bold text-gray-900" id="modal-f6-person-detail-title">Chi ti·∫øt c√¥ng vi·ªác</h2>
            <p class="text-sm text-gray-600 mt-1" id="modal-f6-person-detail-subtitle"></p>
          </div>
          <button id="modal-f6-person-detail-close" class="modal-close modal-f6-person-detail-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div id="modal-f6-person-detail-body" class="modal-body modal-f6-person-detail-body overflow-y-auto flex-1">
          <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
        </div>
        
        <div class="mt-4 flex justify-end gap-2 pt-3 border-t border-gray-200">
          <button type="button" id="modal-f6-person-detail-close-btn" class="modal-close-btn modal-f6-person-detail-close-btn px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 rounded hover:bg-gray-50">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 6: CHI TI·∫æT C√Å NH√ÇN -->
  <!-- ============================================ -->

  <script>
    // ===== FORM 1 - SO S√ÅNH CE =====
    
    // Danh s√°ch t√™n ng∆∞·ªùi ki·ªÉm tra (t·ª´ Form 1 g·ªëc)
    const FORM1_NAMES = [
      "B√πi ƒê·∫∑ng Qu·ªëc Huy","ƒê√†o Tu·∫•n K·ª≥","ƒê·ªó Quang Long","H√† M·ªπ Linh","L·∫°i Qu·ªëc L·ªôc",
      "L√™ Ng·ªçc √Ånh","L√™ Th·ªã Thanh Nh√†n","L√™ Th·ªã Th·∫£o","L√™ VƒÉn S∆°n","Nguy·ªÖn H·ªØu Th·ªãnh","Nguy·ªÖn Th·ªã Hi·ªÅn",
      "Ph·∫°m Th√†nh Trung Ki√™n","Ph·∫°m Th·ªã Minh","Th√°i Th·ªã Giang","Tr·∫ßn Hi·∫øu Nghƒ©a","V≈© Th·ªã H·∫±ng","V≈© Th·ªã Thanh Hi·ªÅn"
    ];

    // H√†m ƒëi·ªÅn danh s√°ch v√†o select
    function fillSelect(selectElement, names) {
      if (!selectElement || !Array.isArray(names)) return;
      names.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        selectElement.appendChild(option);
      });
    }

    // Bi·∫øn l∆∞u tr·ªØ file
    let F1_CE_ORIGINAL_FILE = null;
    let F1_CE_REVIEW_FILE = null;
    
    // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu rates ƒë·ªÉ xu·∫•t Excel
    let F1_RATES_DATA = null;

    // Thi·∫øt l·∫≠p ng√†y ki·ªÉm tra m·∫∑c ƒë·ªãnh (GMT +7) - ch·ªâ ch·∫°y n·∫øu c√≥ tr∆∞·ªùng ng√†y
    function setDefaultCheckDate() {
      const el = document.getElementById('f1-check-date');
      if (!el) return;
      const now = new Date();
      const utcTime = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
      const gmt7Time = new Date(utcTime + (7 * 60 * 60 * 1000));
      const year = gmt7Time.getFullYear();
      const month = String(gmt7Time.getMonth() + 1).padStart(2, '0');
      const day = String(gmt7Time.getDate()).padStart(2, '0');
      const hours = String(gmt7Time.getHours()).padStart(2, '0');
      const minutes = String(gmt7Time.getMinutes()).padStart(2, '0');
      el.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // Kh·ªüi t·∫°o ng√†y m·∫∑c ƒë·ªãnh v√† sidebar navigation khi trang load
    document.addEventListener('DOMContentLoaded', function() {
      setDefaultCheckDate();
      
      // Kh·ªüi t·∫°o sidebar navigation
      initSidebarNavigation();
    });

    // Kh·ªüi t·∫°o sidebar navigation
    function initSidebarNavigation() {
      // B·∫≠t t√≠nh nƒÉng collapse sidebar
      const sidebarNav = document.getElementById('sidebar-nav');
      if (sidebarNav) {
        sidebarNav.classList.add('collapsible');
      }
      
      // X·ª≠ l√Ω click v√†o c√°c n√∫t group ƒë·ªÉ expand/collapse
      const groupButtons = document.querySelectorAll('.group-btn[data-group]');
      groupButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const groupName = this.getAttribute('data-group');
          const groupItems = document.querySelector(`.group-items[data-group="${groupName}"]`);
          
          if (groupItems) {
            const isCollapsed = groupItems.classList.contains('collapsed');
            if (isCollapsed) {
              groupItems.classList.remove('collapsed');
              this.classList.remove('collapsed');
            } else {
              groupItems.classList.add('collapsed');
              this.classList.add('collapsed');
            }
          }
        });
      });
      
      // X·ª≠ l√Ω click v√†o c√°c n√∫t navigation ƒë·ªÉ chuy·ªÉn ƒë·ªïi gi·ªØa c√°c form
      const navButtons = document.querySelectorAll('.nav-btn[data-target]');
      navButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const targetForm = this.getAttribute('data-target');
          
          // Remove active class t·ª´ t·∫•t c·∫£ nav buttons
          navButtons.forEach(btn => btn.classList.remove('active'));
          
          // Add active class cho button ƒë∆∞·ª£c click
          this.classList.add('active');
          
          // ·∫®n t·∫•t c·∫£ c√°c form
          document.querySelectorAll('section[id^="form"]').forEach(form => {
            form.classList.add('hidden');
          });
          
          // Hi·ªÉn th·ªã form ƒë∆∞·ª£c ch·ªçn
          const targetElement = document.getElementById(targetForm);
          if (targetElement) {
            targetElement.classList.remove('hidden');
            
            // Kh·ªüi t·∫°o Form 4 n·∫øu ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o
            if (targetForm === 'form4' && typeof initForm4 === 'function' && !f4Initialized) {
              initForm4();
            }
            if (targetForm === 'form5' && typeof initForm5 === 'function') {
              initForm5();
            }
            if (targetForm === 'form6' && typeof initForm6 === 'function') {
              initForm6();
            }
          }
          
          console.log('[Navigation] Switched to:', targetForm);
        });
      });
      
      console.log('[Navigation] Sidebar initialized with', navButtons.length, 'forms');
      
      // Hi·ªÉn th·ªã Form 1 m·∫∑c ƒë·ªãnh
      const form1 = document.getElementById('form1');
      if (form1) {
        form1.classList.remove('hidden');
      }
    }

    // X·ª≠ l√Ω upload file CE g·ªëc
    document.getElementById('f1-ce-original-btn').addEventListener('click', function() {
      document.getElementById('f1-ce-original').click();
    });

    document.getElementById('f1-ce-original').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        F1_CE_ORIGINAL_FILE = file;
        document.getElementById('f1-ce-original-name').textContent = file.name;
        document.getElementById('f1-ce-original-name').className = 'text-sm text-green-600 flex-1 font-medium';
        document.getElementById('f1-ce-original-remove').classList.remove('hidden');
        showToast('ƒê√£ ch·ªçn file CE g·ªëc: ' + file.name);
      }
    });

    // X√≥a file CE g·ªëc
    document.getElementById('f1-ce-original-remove').addEventListener('click', function() {
      document.getElementById('f1-ce-original').value = '';
      F1_CE_ORIGINAL_FILE = null;
      document.getElementById('f1-ce-original-name').textContent = 'Ch∆∞a ch·ªçn file';
      document.getElementById('f1-ce-original-name').className = 'text-sm text-gray-500 flex-1';
      this.classList.add('hidden');
    });

    // X·ª≠ l√Ω upload file CE sau r√† so√°t
    document.getElementById('f1-ce-review-btn').addEventListener('click', function() {
      document.getElementById('f1-ce-review').click();
    });

    document.getElementById('f1-ce-review').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        F1_CE_REVIEW_FILE = file;
        document.getElementById('f1-ce-review-name').textContent = file.name;
        document.getElementById('f1-ce-review-name').className = 'text-sm text-green-600 flex-1 font-medium';
        document.getElementById('f1-ce-review-remove').classList.remove('hidden');
        showToast('ƒê√£ ch·ªçn file CE sau r√† so√°t: ' + file.name);
      }
    });

    // X√≥a file CE sau r√† so√°t
    document.getElementById('f1-ce-review-remove').addEventListener('click', function() {
      document.getElementById('f1-ce-review').value = '';
      F1_CE_REVIEW_FILE = null;
      document.getElementById('f1-ce-review-name').textContent = 'Ch∆∞a ch·ªçn file';
      document.getElementById('f1-ce-review-name').className = 'text-sm text-gray-500 flex-1';
      this.classList.add('hidden');
    });

    // G·ª≠i d·ªØ li·ªáu l√™n server
    document.getElementById('f1-submit-btn').addEventListener('click', async function() {
      // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
      if (!F1_CE_ORIGINAL_FILE) {
        showToast('Vui l√≤ng ch·ªçn file CE g·ªëc', 'error');
        return;
      }

      if (!F1_CE_REVIEW_FILE) {
        showToast('Vui l√≤ng ch·ªçn file CE sau r√† so√°t', 'error');
        return;
      }

      // Chu·∫©n b·ªã FormData ƒë·ªÉ g·ª≠i
      const formData = new FormData();
      formData.append('ce_original', F1_CE_ORIGINAL_FILE);
      formData.append('ce_review', F1_CE_REVIEW_FILE);

      // Log d·ªØ li·ªáu g·ª≠i ƒëi (kh√¥ng log file)
      console.log('[Form 1] Sending data:', {
        ce_original_file: F1_CE_ORIGINAL_FILE?.name || 'N/A',
        ce_review_file: F1_CE_REVIEW_FILE?.name || 'N/A',
        ce_original_size: F1_CE_ORIGINAL_FILE?.size || 0,
        ce_review_size: F1_CE_REVIEW_FILE?.size || 0
      });

      // Disable button v√† hi·ªÉn th·ªã loading
      const submitBtn = this;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span> ƒêang g·ª≠i...';

      try {
        // G·ª≠i d·ªØ li·ªáu l√™n webhook
        const serverUrl = 'https://iatzhxxuk.tino.page/webhook/a3903199-3907-4ac6-b217-6c5f49607de6';
        
        console.log('[Form 1] Sending to:', serverUrl);
        
        const response = await fetch(serverUrl, {
          method: 'POST',
          body: formData,
          // Kh√¥ng set Content-Type header, browser s·∫Ω t·ª± set v·ªõi boundary cho FormData
        });

        console.log('[Form 1] Response status:', response.status, response.statusText);
        console.log('[Form 1] Response headers:', Object.fromEntries(response.headers.entries()));

        // ƒê·ªçc response text tr∆∞·ªõc (c√≥ th·ªÉ l√† JSON ho·∫∑c text)
        let responseText = '';
        try {
          responseText = await response.text();
          console.log('[Form 1] Response text:', responseText);
        } catch (textError) {
          console.error('[Form 1] Error reading response text:', textError);
          responseText = '';
        }

        // Parse JSON n·∫øu c√≥ th·ªÉ
        let result = null;
        if (responseText) {
          try {
            result = JSON.parse(responseText);
            console.log('[Form 1] Parsed JSON:', result);
          } catch (parseError) {
            // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, gi·ªØ nguy√™n text
            console.log('[Form 1] Response is not JSON, keeping as text');
            result = {
              success: response.ok,
              status: response.status,
              statusText: response.statusText,
              body: responseText,
              message: responseText || 'Kh√¥ng c√≥ n·ªôi dung response'
            };
          }
        } else {
          result = {
            success: response.ok,
            status: response.status,
            statusText: response.statusText,
            message: response.ok ? 'G·ª≠i th√†nh c√¥ng (kh√¥ng c√≥ response body)' : `HTTP ${response.status}: ${response.statusText}`
          };
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        displayJsonResult(result);
        
        if (response.ok) {
          showToast('ƒê√£ g·ª≠i d·ªØ li·ªáu th√†nh c√¥ng');
        } else {
          showToast(`G·ª≠i kh√¥ng th√†nh c√¥ng: HTTP ${response.status}`, 'error');
        }
      } catch (error) {
        console.error('[Form 1] Error submitting:', error);
        console.error('[Form 1] Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        
        showToast('L·ªói khi g·ª≠i d·ªØ li·ªáu: ' + error.message, 'error');
        
        // Hi·ªÉn th·ªã l·ªói d∆∞·ªõi d·∫°ng JSON
        displayJsonResult({
          error: true,
          name: error.name || 'Unknown Error',
          message: error.message || 'C√≥ l·ªói x·∫£y ra',
          timestamp: new Date().toISOString(),
          details: error.stack || 'Kh√¥ng c√≥ chi ti·∫øt'
        });
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'G·ª≠i l√™n server';
      }
    });

    // Hi·ªÉn th·ªã k·∫øt qu·∫£ JSON
    function displayJsonResult(data) {
      const jsonResult = document.getElementById('f1-json-result');
      const vnContainer = document.getElementById('f1-json-vn');
      const jsonLabelDiv = jsonResult?.previousElementSibling; // div ch·ª©a label "JSON Response:"
      const formattedJson = JSON.stringify(data, null, 2);
      jsonResult.textContent = formattedJson;

      // Th·ª≠ render b·∫£n Vi·ªát h√≥a n·∫øu ƒë√∫ng c·∫•u tr√∫c
      try {
        const arr = Array.isArray(data) ? data : (typeof data === 'string' ? JSON.parse(data) : [data]);
        const first = Array.isArray(arr) ? arr[0] : null;
        const results = first && Array.isArray(first.results) ? first.results : null;
        const summary = first && first.summary ? first.summary : null;
        // H·ªó tr·ª£ 3 d·∫°ng: { rates:[...] } | [{...ratesItem}, ...] | { results:[...], summary:{} }
        let rates = first && Array.isArray(first.rates) ? first.rates : null;
        if (!rates && Array.isArray(arr) && arr.length && typeof arr[0] === 'object') {
          const looksLikeRate = (o)=> o && ('code' in o) && ('rate' in o || 'rate_percent' in o || 'added_count' in o || 'unchanged_count' in o);
          if (looksLikeRate(arr[0])) { rates = arr; }
        }

        if (rates) {
          // L∆∞u d·ªØ li·ªáu rates ƒë·ªÉ xu·∫•t Excel
          F1_RATES_DATA = rates;
          
          // D·∫°ng m·ªõi: rates
          let html = '';

          // T√≠nh to√°n t·ªïng
          const totalCodes = rates.length;
          const totalAdded = rates.reduce((s, r) => s + Number(r.added_count || 0), 0);
          const totalRemoved = rates.reduce((s, r) => s + Number(r.removed_count || 0), 0);
          const totalChanged = rates.reduce((s, r) => s + Number(r.changed_count || 0), 0);
          const totalUnchanged = rates.reduce((s, r) => s + Number(r.unchanged_count || 0), 0);
          const totalNumerator = rates.reduce((s, r) => s + Number(r.numerator_changes || 0), 0);
          const totalBase = rates.reduce((s, r) => s + Number(r.base_old_items || 0), 0);
          const totalRate = totalBase > 0 ? (totalNumerator / totalBase) : 0;

          // B·∫£ng t√≥m t·∫Øt
          html += `
            <div class="overflow-auto mb-4">
              <table class="min-w-[720px] w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                <thead class="bg-gray-50 text-gray-700">
                  <tr>
                    <th class="px-3 py-2 border">T·ªïng s·ªë m√£</th>
                    <th class="px-3 py-2 border">T·ªïng thay ƒë·ªïi (t·ª≠ s·ªë)</th>
                    <th class="px-3 py-2 border">T·ªïng m·ª•c c≈© (m·∫´u s·ªë)</th>
                    <th class="px-3 py-2 border">T·ª∑ l·ªá t·ªïng th·ªÉ</th>
                    <th class="px-3 py-2 border">Th√™m m·ªõi</th>
                    <th class="px-3 py-2 border">B·ªã x√≥a</th>
                    <th class="px-3 py-2 border">Thay ƒë·ªïi</th>
                    <th class="px-3 py-2 border">Kh√¥ng ƒë·ªïi</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="text-center">
                    <td class="px-3 py-2 border font-semibold text-blue-700">${totalCodes}</td>
                    <td class="px-3 py-2 border font-semibold text-indigo-700">${totalNumerator}</td>
                    <td class="px-3 py-2 border font-semibold text-sky-700">${totalBase}</td>
                    <td class="px-3 py-2 border font-semibold text-purple-700">${(totalRate * 100).toFixed(1)}%</td>
                    <td class="px-3 py-2 border font-semibold text-green-700">${totalAdded}</td>
                    <td class="px-3 py-2 border font-semibold text-red-700">${totalRemoved}</td>
                    <td class="px-3 py-2 border font-semibold text-yellow-700">${totalChanged}</td>
                    <td class="px-3 py-2 border font-semibold text-gray-700">${totalUnchanged}</td>
                  </tr>
                </tbody>
              </table>
            </div>`;

          // D·∫°ng √¥ (cards) cho t·ª´ng m√£
          html += `
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-4">
              ${rates.map((r)=>`
                <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                  <div class="px-4 py-3 bg-gradient-to-r from-blue-50 to-white flex items-center justify-between">
                    <div>
                      <div class="text-sm text-gray-500">M√£: <span class="font-medium text-gray-700">${escapeHtml(r.code||'')}</span></div>
                      <div class="text-base font-semibold text-blue-800">${escapeHtml(r.name||'')}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-[11px] text-gray-500">T·ª∑ l·ªá thay ƒë·ªïi</div>
                      <div class="text-2xl font-extrabold text-blue-700">${escapeHtml(r.rate_percent || ((Number(r.rate||0)*100).toFixed(1)+'%'))}</div>
                    </div>
                  </div>
                  <div class="p-4 space-y-3">
                    <div class="grid grid-cols-4 gap-2 text-center">
                      <div class="bg-green-50 border border-green-200 rounded-md px-2 py-2">
                        <div class="text-[11px] text-green-700">+ Th√™m</div>
                        <div class="text-lg font-bold text-green-700">${Number(r.added_count||0)}</div>
                      </div>
                      <div class="bg-red-50 border border-red-200 rounded-md px-2 py-2">
                        <div class="text-[11px] text-red-700">- X√≥a</div>
                        <div class="text-lg font-bold text-red-700">${Number(r.removed_count||0)}</div>
                      </div>
                      <div class="bg-yellow-50 border border-yellow-200 rounded-md px-2 py-2">
                        <div class="text-[11px] text-yellow-700">Œî ƒê·ªïi</div>
                        <div class="text-lg font-bold text-yellow-700">${Number(r.changed_count||0)}</div>
                      </div>
                      <div class="bg-gray-50 border border-gray-200 rounded-md px-2 py-2">
                        <div class="text-[11px] text-gray-700">= Kh√¥ng ƒë·ªïi</div>
                        <div class="text-lg font-bold text-gray-700">${Number(r.unchanged_count||0)}</div>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>`;

          // B·∫£ng chi ti·∫øt theo m√£
          html += `
            <div class="overflow-auto mb-6">
              <table class="min-w-[860px] w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                <thead class="bg-gray-50 text-gray-700">
                  <tr>
                    <th class="px-3 py-2 border text-center">#</th>
                    <th class="px-3 py-2 border">M√£</th>
                    <th class="px-3 py-2 border">T√™n</th>
                    <th class="px-3 py-2 border text-center">T·ª∑ l·ªá</th>
                    <th class="px-3 py-2 border text-center">T·ª≠ s·ªë</th>
                    <th class="px-3 py-2 border text-center">M·∫´u s·ªë</th>
                    <th class="px-3 py-2 border text-center">+ Th√™m</th>
                    <th class="px-3 py-2 border text-center">- X√≥a</th>
                    <th class="px-3 py-2 border text-center">Œî ƒê·ªïi</th>
                    <th class="px-3 py-2 border text-center">= Kh√¥ng ƒë·ªïi</th>
                  </tr>
                </thead>
                <tbody>
                  ${rates.map((r, i) => `
                    <tr class="hover:bg-gray-50">
                      <td class="px-3 py-2 border text-center">${i+1}</td>
                      <td class="px-3 py-2 border font-medium">${escapeHtml(r.code||'')}</td>
                      <td class="px-3 py-2 border">${escapeHtml(r.name||'')}</td>
                      <td class="px-3 py-2 border text-center">${escapeHtml(r.rate_percent || ((Number(r.rate||0)*100).toFixed(1)+'%'))}</td>
                      <td class="px-3 py-2 border text-center">${Number(r.numerator_changes||0)}</td>
                      <td class="px-3 py-2 border text-center">${Number(r.base_old_items||0)}</td>
                      <td class="px-3 py-2 border text-center text-green-700 font-medium">${Number(r.added_count||0)}</td>
                      <td class="px-3 py-2 border text-center text-red-700 font-medium">${Number(r.removed_count||0)}</td>
                      <td class="px-3 py-2 border text-center text-yellow-700 font-medium">${Number(r.changed_count||0)}</td>
                      <td class="px-3 py-2 border text-center text-gray-700 font-medium">${Number(r.unchanged_count||0)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>`;

          // Chi ti·∫øt items cho t·ª´ng m√£
          html += `
            <div class="mb-4">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">Chi ti·∫øt thay ƒë·ªïi theo t·ª´ng m√£</h4>
              <div class="space-y-4">
                ${rates.map((r, idx) => {
                  const addedItems = Array.isArray(r.added_items) ? r.added_items : [];
                  const removedItems = Array.isArray(r.removed_items) ? r.removed_items : [];
                  const changedItems = Array.isArray(r.changed_items) ? r.changed_items : [];
                  const hasDetails = addedItems.length > 0 || removedItems.length > 0 || changedItems.length > 0;
                  const detailsId = `rate-details-${idx}`;
                  
                  if (!hasDetails) return '';
                  
                  return `
                    <div class="border border-gray-300 rounded-lg overflow-hidden bg-white shadow-sm">
                      <button onclick="toggleRateDetails('${detailsId}')" class="w-full px-5 py-4 bg-gradient-to-r from-blue-50 to-white hover:from-blue-100 hover:to-blue-50 transition flex items-center justify-between text-left">
                        <div>
                          <div class="font-semibold text-blue-800 text-lg">${idx + 1}. ${escapeHtml(r.code || '')} - ${escapeHtml(r.name || '')}</div>
                          <div class="text-sm text-gray-600 mt-1">
                            ${addedItems.length > 0 ? `<span class="text-green-700 font-medium">+${addedItems.length} th√™m</span>` : ''}
                            ${removedItems.length > 0 ? `<span class="text-red-700 font-medium ml-2">-${removedItems.length} x√≥a</span>` : ''}
                            ${changedItems.length > 0 ? `<span class="text-yellow-700 font-medium ml-2">Œî${changedItems.length} ƒë·ªïi</span>` : ''}
                          </div>
                        </div>
                        <svg id="icon-${detailsId}" class="w-5 h-5 text-gray-500 transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      <div id="${detailsId}" class="border-t border-gray-200 bg-gray-50">
                        <div class="p-5 space-y-5">
                          ${addedItems.length > 0 ? renderAddedItems(addedItems, idx) : ''}
                          ${removedItems.length > 0 ? renderRemovedItems(removedItems, idx) : ''}
                          ${changedItems.length > 0 ? renderChangedItems(changedItems, idx) : ''}
                        </div>
                      </div>
                    </div>
                  `;
                }).filter(h => h).join('')}
              </div>
            </div>`;

          vnContainer.innerHTML = html;
          vnContainer.classList.remove('hidden');
          // Hi·ªÉn th·ªã n√∫t xu·∫•t Excel
          const exportBtn = document.getElementById('f1-export-excel');
          if (exportBtn) exportBtn.classList.remove('hidden');
          // ·∫®n ph·∫ßn JSON th√¥
          if (jsonLabelDiv) jsonLabelDiv.style.display = 'none';
          if (jsonResult) jsonResult.style.display = 'none';
        } else if (results) {
          let html = '';

          // T√≥m t·∫Øt
          if (summary) {
            html += `
              <div class="overflow-auto mb-4">
                <table class="min-w-[560px] w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                  <thead class="bg-gray-50 text-gray-700">
                    <tr>
                      <th class="px-3 py-2 border">T·ªïng s·ªë m√£</th>
                      <th class="px-3 py-2 border">Th√™m m·ªõi</th>
                      <th class="px-3 py-2 border">B·ªã x√≥a</th>
                      <th class="px-3 py-2 border">Thay ƒë·ªïi</th>
                      <th class="px-3 py-2 border">Kh√¥ng ƒë·ªïi</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="text-center">
                      <td class="px-3 py-2 border font-semibold text-blue-700">${summary.total_codes ?? 0}</td>
                      <td class="px-3 py-2 border font-semibold text-green-700">${summary.total_added ?? 0}</td>
                      <td class="px-3 py-2 border font-semibold text-red-700">${summary.total_removed ?? 0}</td>
                      <td class="px-3 py-2 border font-semibold text-yellow-700">${summary.total_changed ?? 0}</td>
                      <td class="px-3 py-2 border font-semibold text-gray-700">${summary.total_unchanged ?? 0}</td>
                    </tr>
                  </tbody>
                </table>
              </div>`;
          }

          // Chi ti·∫øt theo m√£
          html += '<div class="space-y-4">';
          results.forEach((r, idx) => {
            const added = Array.isArray(r.added) ? r.added : [];
            const removed = Array.isArray(r.removed) ? r.removed : [];
            const changed = Array.isArray(r.changed) ? r.changed : [];
            html += `
              <div class="border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between px-4 py-3 bg-gradient-to-r from-blue-50 to-white rounded-t-lg">
                  <div class="font-semibold text-blue-800">${idx+1}. ${r.code || ''} ‚Äî ${r.name || ''}</div>
                  <div class="flex gap-2 text-xs">
                    <span class="px-2 py-1 rounded bg-green-100 text-green-700">+${r.added_count ?? added.length}</span>
                    <span class="px-2 py-1 rounded bg-red-100 text-red-700">-${r.removed_count ?? removed.length}</span>
                    <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-700">Œî${r.changed_count ?? changed.length}</span>
                    <span class="px-2 py-1 rounded bg-gray-100 text-gray-700">=${r.unchanged_count ?? 0}</span>
                  </div>
                </div>
                <div class="p-4 space-y-4">
                  ${added.length ? renderGroup('Th√™m m·ªõi', added, 'green') : ''}
                  ${removed.length ? renderGroup('B·ªã x√≥a', removed, 'red') : ''}
                  ${changed.length ? renderGroup('Thay ƒë·ªïi', changed, 'yellow') : ''}
                  ${!added.length && !removed.length && !changed.length ? '<div class="text-sm text-gray-500">Kh√¥ng c√≥ thay ƒë·ªïi.</div>' : ''}
                </div>
              </div>`;
          });
          html += '</div>';

          vnContainer.innerHTML = html;
          vnContainer.classList.remove('hidden');
          // ·∫®n ph·∫ßn JSON th√¥
          if (jsonLabelDiv) jsonLabelDiv.style.display = 'none';
          if (jsonResult) jsonResult.style.display = 'none';
        } else {
          vnContainer.classList.add('hidden');
          // ·∫®n n√∫t xu·∫•t Excel v√† reset d·ªØ li·ªáu
          F1_RATES_DATA = null;
          const exportBtn = document.getElementById('f1-export-excel');
          if (exportBtn) exportBtn.classList.add('hidden');
          // Hi·ªán l·∫°i ph·∫ßn JSON th√¥ n·∫øu kh√¥ng parse ƒë∆∞·ª£c
          if (jsonLabelDiv) jsonLabelDiv.style.display = '';
          if (jsonResult) jsonResult.style.display = '';
        }
      } catch (e) {
        console.warn('VN render failed:', e);
        vnContainer?.classList.add('hidden');
        // ·∫®n n√∫t xu·∫•t Excel v√† reset d·ªØ li·ªáu
        F1_RATES_DATA = null;
        const exportBtn = document.getElementById('f1-export-excel');
        if (exportBtn) exportBtn.classList.add('hidden');
        // Hi·ªán l·∫°i ph·∫ßn JSON th√¥ khi c√≥ l·ªói
        if (jsonLabelDiv) jsonLabelDiv.style.display = '';
        if (jsonResult) jsonResult.style.display = '';
      }

      // Hi·ªÉn th·ªã ph·∫ßn k·∫øt qu·∫£
      document.getElementById('f1-result').classList.remove('hidden');
      document.getElementById('f1-result').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Kh√¥ng s·ª≠ d·ª•ng ƒë·ªì th·ªã

    // H√†m toggle chi ti·∫øt cho rate cards
    window.toggleRateDetails = function(detailsId) {
      const details = document.getElementById(detailsId);
      const icon = document.getElementById('icon-' + detailsId);
      if (details) {
        details.classList.toggle('hidden');
        if (icon) {
          icon.classList.toggle('rotate-180');
        }
      }
    };

    // H√†m render added items
    function renderAddedItems(items, cardIdx) {
      if (!items || items.length === 0) return '';
      return `
        <div class="bg-white border border-green-300 rounded-lg overflow-hidden shadow-sm">
          <div class="bg-gradient-to-r from-green-500 to-green-600 px-4 py-3">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              <h5 class="text-white font-semibold text-base">Th√™m m·ªõi (${items.length} m·ª•c)</h5>
            </div>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-green-50">
                <tr>
                  <th class="px-4 py-2 border border-green-200 text-center font-semibold text-green-800">#</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">Ch·ªâ ti√™u</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">Ti√™u chu·∫©n</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">D·ª•ng c·ª•</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">Lo·∫°i</th>
                  <th class="px-4 py-2 border border-green-200 font-semibold text-green-800">T√†i li·ªáu</th>
                </tr>
              </thead>
              <tbody>
                ${items.map((item, i) => `
                  <tr class="hover:bg-green-50 transition">
                    <td class="px-4 py-3 border border-green-200 text-center font-medium text-gray-700">${i + 1}</td>
                    <td class="px-4 py-3 border border-green-200 font-medium text-gray-800">${escapeHtml(item.index || '')}</td>
                    <td class="px-4 py-3 border border-green-200 text-gray-700">${escapeHtml(item.standard || '')}</td>
                    <td class="px-4 py-3 border border-green-200 text-gray-700">${escapeHtml(item.tool || '')}</td>
                    <td class="px-4 py-3 border border-green-200 text-center">
                      <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">${escapeHtml(item.type || '')}</span>
                    </td>
                    <td class="px-4 py-3 border border-green-200 text-gray-700 text-xs">${escapeHtml(item.document || '')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // H√†m render removed items
    function renderRemovedItems(items, cardIdx) {
      if (!items || items.length === 0) return '';
      return `
        <div class="bg-white border border-red-300 rounded-lg overflow-hidden shadow-sm">
          <div class="bg-gradient-to-r from-red-500 to-red-600 px-4 py-3">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              <h5 class="text-white font-semibold text-base">B·ªã x√≥a (${items.length} m·ª•c)</h5>
            </div>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-red-50">
                <tr>
                  <th class="px-4 py-2 border border-red-200 text-center font-semibold text-red-800">#</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">Ch·ªâ ti√™u</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">Ti√™u chu·∫©n</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">D·ª•ng c·ª•</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">Lo·∫°i</th>
                  <th class="px-4 py-2 border border-red-200 font-semibold text-red-800">T√†i li·ªáu</th>
                </tr>
              </thead>
              <tbody>
                ${items.map((item, i) => `
                  <tr class="hover:bg-red-50 transition">
                    <td class="px-4 py-3 border border-red-200 text-center font-medium text-gray-700">${i + 1}</td>
                    <td class="px-4 py-3 border border-red-200 font-medium text-gray-800">${escapeHtml(item.index || '')}</td>
                    <td class="px-4 py-3 border border-red-200 text-gray-700">${escapeHtml(item.standard || '')}</td>
                    <td class="px-4 py-3 border border-red-200 text-gray-700">${escapeHtml(item.tool || '')}</td>
                    <td class="px-4 py-3 border border-red-200 text-center">
                      <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">${escapeHtml(item.type || '')}</span>
                    </td>
                    <td class="px-4 py-3 border border-red-200 text-gray-700 text-xs">${escapeHtml(item.document || '')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // H√†m render changed items v·ªõi so s√°nh before/after
    function renderChangedItems(items, cardIdx) {
      if (!items || items.length === 0) return '';
      return `
        <div class="bg-white border border-yellow-300 rounded-lg overflow-hidden shadow-sm">
          <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 px-4 py-3">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
              </svg>
              <h5 class="text-white font-semibold text-base">Thay ƒë·ªïi (${items.length} m·ª•c)</h5>
            </div>
          </div>
          <div class="p-4 space-y-4">
            ${items.map((item, i) => {
              const before = item.before || {};
              const after = item.after || {};
              const index = item.index || '';
              
              // So s√°nh c√°c tr∆∞·ªùng ƒë·ªÉ highlight thay ƒë·ªïi
              const standardChanged = before.standard !== after.standard;
              const toolChanged = before.tool !== after.tool;
              const typeChanged = before.type !== after.type;
              const documentChanged = before.document !== after.document;
              
              return `
                <div class="border border-yellow-200 rounded-lg overflow-hidden bg-gradient-to-br from-yellow-50 to-white">
                  <div class="bg-yellow-100 px-4 py-2 border-b border-yellow-200">
                    <div class="flex items-center gap-2">
                      <span class="px-2 py-1 bg-yellow-500 text-white text-xs font-semibold rounded">#${i + 1}</span>
                      <span class="font-semibold text-yellow-900 text-sm">${escapeHtml(index)}</span>
                    </div>
                  </div>
                  <div class="overflow-auto">
                    <table class="min-w-full text-sm">
                      <thead class="bg-yellow-50">
                        <tr>
                          <th class="px-4 py-2 border border-yellow-200 font-semibold text-yellow-900 w-1/6">Tr∆∞·ªùng</th>
                          <th class="px-4 py-2 border border-yellow-200 font-semibold text-red-700 w-5/12">Tr∆∞·ªõc (Before)</th>
                          <th class="px-4 py-2 border border-yellow-200 font-semibold text-green-700 w-5/12">Sau (After)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr class="hover:bg-yellow-50">
                          <td class="px-4 py-3 border border-yellow-200 font-medium text-gray-800 bg-gray-50">Ti√™u chu·∫©n</td>
                          <td class="px-4 py-3 border border-yellow-200 ${standardChanged ? 'bg-red-50 font-medium text-red-800' : 'text-gray-700'}">${escapeHtml(before.standard || '')}</td>
                          <td class="px-4 py-3 border border-yellow-200 ${standardChanged ? 'bg-green-50 font-medium text-green-800' : 'text-gray-700'}">${escapeHtml(after.standard || '')}</td>
                        </tr>
                        <tr class="hover:bg-yellow-50">
                          <td class="px-4 py-3 border border-yellow-200 font-medium text-gray-800 bg-gray-50">D·ª•ng c·ª•</td>
                          <td class="px-4 py-3 border border-yellow-200 ${toolChanged ? 'bg-red-50 font-medium text-red-800' : 'text-gray-700'}">${escapeHtml(before.tool || '')}</td>
                          <td class="px-4 py-3 border border-yellow-200 ${toolChanged ? 'bg-green-50 font-medium text-green-800' : 'text-gray-700'}">${escapeHtml(after.tool || '')}</td>
                        </tr>
                        <tr class="hover:bg-yellow-50">
                          <td class="px-4 py-3 border border-yellow-200 font-medium text-gray-800 bg-gray-50">Lo·∫°i</td>
                          <td class="px-4 py-3 border border-yellow-200 text-center ${typeChanged ? 'bg-red-50' : ''}">
                            ${before.type ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">${escapeHtml(before.type)}</span>` : ''}
                          </td>
                          <td class="px-4 py-3 border border-yellow-200 text-center ${typeChanged ? 'bg-green-50' : ''}">
                            ${after.type ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">${escapeHtml(after.type)}</span>` : ''}
                          </td>
                        </tr>
                        <tr class="hover:bg-yellow-50">
                          <td class="px-4 py-3 border border-yellow-200 font-medium text-gray-800 bg-gray-50">T√†i li·ªáu</td>
                          <td class="px-4 py-3 border border-yellow-200 text-xs ${documentChanged ? 'bg-red-50 font-medium text-red-800' : 'text-gray-700'}">${escapeHtml(before.document || '')}</td>
                          <td class="px-4 py-3 border border-yellow-200 text-xs ${documentChanged ? 'bg-green-50 font-medium text-green-800' : 'text-gray-700'}">${escapeHtml(after.document || '')}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderGroup(title, items, tone) {
      const toneMap = {
        green: { head:'bg-green-50 text-green-800 border-green-200', dot:'bg-green-400' },
        red: { head:'bg-red-50 text-red-800 border-red-200', dot:'bg-red-400' },
        yellow: { head:'bg-yellow-50 text-yellow-800 border-yellow-200', dot:'bg-yellow-400' }
      }[tone] || { head:'bg-gray-50 text-gray-800 border-gray-200', dot:'bg-gray-400' };
      let rows = '';
      items.forEach((it, i) => {
        rows += `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-2 border text-center">${i+1}</td>
            <td class="px-3 py-2 border">${escapeHtml(it.index ?? '')}</td>
            <td class="px-3 py-2 border">${escapeHtml(it.standard ?? '')}</td>
            <td class="px-3 py-2 border">${escapeHtml(it.tool ?? '')}</td>
            <td class="px-3 py-2 border">${escapeHtml(it.type ?? '')}</td>
            <td class="px-3 py-2 border text-center">${escapeHtml(it.document ?? '')}</td>
          </tr>`;
      });
      return `
        <div class="border ${toneMap.head.split(' ').includes('border') ? toneMap.head.split(' ').find(c=>c.startsWith('border-')) : 'border-gray-200'} rounded-lg overflow-hidden">
          <div class="px-3 py-2 ${toneMap.head} font-medium">${title}</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-white">
                <tr class="text-left">
                  <th class="px-3 py-2 border text-center">#</th>
                  <th class="px-3 py-2 border">Ch·ªâ ti√™u</th>
                  <th class="px-3 py-2 border">Ti√™u chu·∫©n</th>
                  <th class="px-3 py-2 border">D·ª•ng c·ª•</th>
                  <th class="px-3 py-2 border">Lo·∫°i</th>
                  <th class="px-3 py-2 border text-center">T√†i li·ªáu</th>
                </tr>
              </thead>
              <tbody>
                ${rows || '<tr><td colspan="6" class="px-3 py-3 text-center text-gray-500">Kh√¥ng c√≥ m·ª•c</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>`;
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Copy JSON
    document.getElementById('f1-copy-json').addEventListener('click', function() {
      const jsonText = document.getElementById('f1-json-result').textContent;
      if (jsonText && jsonText !== 'Ch∆∞a c√≥ k·∫øt qu·∫£') {
        navigator.clipboard.writeText(jsonText).then(() => {
          showToast('ƒê√£ copy JSON v√†o clipboard');
        }).catch(err => {
          console.error('Error copying to clipboard:', err);
          showToast('L·ªói khi copy JSON', 'error');
        });
      } else {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ copy', 'error');
      }
    });

    // H√†m xu·∫•t d·ªØ li·ªáu Form 1 ra Excel
    function exportF1ToExcel() {
      if (!F1_RATES_DATA || !Array.isArray(F1_RATES_DATA) || F1_RATES_DATA.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      try {
        // T·∫°o workbook
        const wb = XLSX.utils.book_new();

        // Sheet 1: T√≥m t·∫Øt
        const summaryData = [];
        const totalCodes = F1_RATES_DATA.length;
        const totalAdded = F1_RATES_DATA.reduce((s, r) => s + Number(r.added_count || 0), 0);
        const totalRemoved = F1_RATES_DATA.reduce((s, r) => s + Number(r.removed_count || 0), 0);
        const totalChanged = F1_RATES_DATA.reduce((s, r) => s + Number(r.changed_count || 0), 0);
        const totalUnchanged = F1_RATES_DATA.reduce((s, r) => s + Number(r.unchanged_count || 0), 0);
        const totalNumerator = F1_RATES_DATA.reduce((s, r) => s + Number(r.numerator_changes || 0), 0);
        const totalBase = F1_RATES_DATA.reduce((s, r) => s + Number(r.base_old_items || 0), 0);
        const totalRate = totalBase > 0 ? (totalNumerator / totalBase) : 0;

        summaryData.push(['T√≥m t·∫Øt t·ªïng th·ªÉ']);
        summaryData.push([]);
        summaryData.push(['T·ªïng s·ªë m√£', totalCodes]);
        summaryData.push(['T·ªïng thay ƒë·ªïi (t·ª≠ s·ªë)', totalNumerator]);
        summaryData.push(['T·ªïng m·ª•c c≈© (m·∫´u s·ªë)', totalBase]);
        summaryData.push(['T·ª∑ l·ªá t·ªïng th·ªÉ', `${(totalRate * 100).toFixed(1)}%`]);
        summaryData.push(['Th√™m m·ªõi', totalAdded]);
        summaryData.push(['B·ªã x√≥a', totalRemoved]);
        summaryData.push(['Thay ƒë·ªïi', totalChanged]);
        summaryData.push(['Kh√¥ng ƒë·ªïi', totalUnchanged]);

        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, wsSummary, 'T√≥m t·∫Øt');

        // Sheet 2: Chi ti·∫øt theo m√£
        const detailData = [
          ['#', 'M√£', 'T√™n', 'T·ª∑ l·ªá', 'T·ª≠ s·ªë', 'M·∫´u s·ªë', 'Th√™m', 'X√≥a', 'ƒê·ªïi', 'Kh√¥ng ƒë·ªïi']
        ];

        F1_RATES_DATA.forEach((r, i) => {
          detailData.push([
            i + 1,
            r.code || '',
            r.name || '',
            r.rate_percent || ((Number(r.rate || 0) * 100).toFixed(1) + '%'),
            Number(r.numerator_changes || 0),
            Number(r.base_old_items || 0),
            Number(r.added_count || 0),
            Number(r.removed_count || 0),
            Number(r.changed_count || 0),
            Number(r.unchanged_count || 0)
          ]);
        });

        const wsDetail = XLSX.utils.aoa_to_sheet(detailData);
        XLSX.utils.book_append_sheet(wb, wsDetail, 'Chi ti·∫øt');

        // Sheet 3: Chi ti·∫øt items (Added, Removed, Changed)
        const itemsData = [
          ['M√£', 'T√™n', 'Lo·∫°i', 'Ch·ªâ ti√™u', 'Ti√™u chu·∫©n', 'D·ª•ng c·ª•', 'Lo·∫°i item', 'T√†i li·ªáu', 'Tr∆∞·ªõc (Before)', 'Sau (After)']
        ];

        F1_RATES_DATA.forEach((r) => {
          const code = r.code || '';
          const name = r.name || '';
          
          // Added items
          const addedItems = Array.isArray(r.added_items) ? r.added_items : [];
          addedItems.forEach((item) => {
            itemsData.push([
              code,
              name,
              'Th√™m m·ªõi',
              item.index || '',
              item.standard || '',
              item.tool || '',
              item.type || '',
              item.document || '',
              '',
              ''
            ]);
          });

          // Removed items
          const removedItems = Array.isArray(r.removed_items) ? r.removed_items : [];
          removedItems.forEach((item) => {
            itemsData.push([
              code,
              name,
              'B·ªã x√≥a',
              item.index || '',
              item.standard || '',
              item.tool || '',
              item.type || '',
              item.document || '',
              '',
              ''
            ]);
          });

          // Changed items
          const changedItems = Array.isArray(r.changed_items) ? r.changed_items : [];
          changedItems.forEach((item) => {
            const before = item.before || {};
            const after = item.after || {};
            itemsData.push([
              code,
              name,
              'Thay ƒë·ªïi',
              item.index || '',
              before.standard || '',
              before.tool || '',
              before.type || '',
              before.document || '',
              JSON.stringify(before),
              JSON.stringify(after)
            ]);
          });
        });

        const wsItems = XLSX.utils.aoa_to_sheet(itemsData);
        XLSX.utils.book_append_sheet(wb, wsItems, 'Chi ti·∫øt Items');

        // T·∫°o t√™n file v·ªõi timestamp
        const now = new Date();
        const dateStr = now.getFullYear() + '-' +
          String(now.getMonth() + 1).padStart(2, '0') + '-' +
          String(now.getDate()).padStart(2, '0') + '_' +
          String(now.getHours()).padStart(2, '0') + '-' +
          String(now.getMinutes()).padStart(2, '0') + '-' +
          String(now.getSeconds()).padStart(2, '0');
        const filename = `So_sanh_CE_${dateStr}.xlsx`;

        // Xu·∫•t file
        XLSX.writeFile(wb, filename);

        showToast(`ƒê√£ xu·∫•t ${F1_RATES_DATA.length} m√£ ra file Excel`, 'success');

      } catch (error) {
        console.error('[Form 1] Error exporting to Excel:', error);
        showToast('L·ªói khi xu·∫•t file Excel: ' + error.message, 'error');
      }
    }

    // Event listener cho n√∫t xu·∫•t Excel
    document.getElementById('f1-export-excel').addEventListener('click', function() {
      exportF1ToExcel();
    });

    // H√†m hi·ªÉn th·ªã toast
    function showToast(message, type = 'success') {
      // T·∫°o toast element n·∫øu ch∆∞a c√≥
      let toast = document.getElementById('toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'toast';
        document.body.appendChild(toast);
      }

      toast.textContent = message;
      toast.className = `toast ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== FORM 2 - R√Ä SO√ÅT CE =====
    
    // H√†m t√≠nh m√†u t·ª´ t·ª∑ l·ªá (0% = ƒë·ªè, 100% = xanh l√°)
    function getCompletionColor(percentage) {
      // Chuy·ªÉn ƒë·ªïi ph·∫ßn trƒÉm th√†nh s·ªë (lo·∫°i b·ªè % n·∫øu c√≥)
      let percent = parseFloat(String(percentage).replace('%', ''));
      if (isNaN(percent)) percent = 0;
      percent = Math.max(0, Math.min(100, percent)); // Gi·ªõi h·∫°n t·ª´ 0-100
      
      // T√≠nh m√†u RGB gradient t·ª´ ƒë·ªè -> v√†ng -> xanh l√°
      let r, g, b;
      
      if (percent < 50) {
        // 0-50%: ƒê·ªè (239, 68, 68) -> V√†ng (234, 179, 8)
        const ratio = percent / 50;
        r = Math.round(239 - (239 - 234) * ratio);
        g = Math.round(68 + (179 - 68) * ratio);
        b = Math.round(68 - (68 - 8) * ratio);
      } else {
        // 50-100%: V√†ng (234, 179, 8) -> Xanh l√° (34, 197, 94)
        const ratio = (percent - 50) / 50;
        r = Math.round(234 - (234 - 34) * ratio);
        g = Math.round(179 + (197 - 179) * ratio);
        b = Math.round(8 + (94 - 8) * ratio);
      }
      
      return `rgb(${r}, ${g}, ${b})`;
    }

    // Bi·∫øn l∆∞u d·ªØ li·ªáu g·ªëc ƒë·ªÉ filter
    let F2_ORIGINAL_DATA = [];

    // H√†m populate filter dropdowns
    function populateF2Filters(data) {
      if (!data || !Array.isArray(data)) return;
      
      const picFilter = document.getElementById('f2-filter-pic');
      const projectFilter = document.getElementById('f2-filter-project');
      
      if (!picFilter || !projectFilter) return;
      
      // L∆∞u gi√° tr·ªã ƒë√£ ch·ªçn
      const selectedPic = picFilter.value;
      const selectedProject = projectFilter.value;
      
      // Clear existing options (gi·ªØ l·∫°i option "T·∫•t c·∫£")
      picFilter.innerHTML = '<option value="">T·∫•t c·∫£</option>';
      projectFilter.innerHTML = '<option value="">T·∫•t c·∫£</option>';
      
      // L·∫•y danh s√°ch unique PIC c·ª•m v√† D·ª± √°n
      const picSet = new Set();
      const projectSet = new Set();
      
      data.forEach(row => {
        const pic = row.pic_cluster || row['PIC c·ª•m'] || row.pic_cum || row.pic || '';
        const project = row.project || row['D·ª± √°n'] || row.du_an || '';
        
        if (pic) picSet.add(pic);
        if (project) projectSet.add(project);
      });
      
      // Populate PIC filter
      const sortedPics = Array.from(picSet).sort();
      sortedPics.forEach(pic => {
        const option = document.createElement('option');
        option.value = pic;
        option.textContent = pic;
        if (pic === selectedPic) option.selected = true;
        picFilter.appendChild(option);
      });
      
      // Populate Project filter
      const sortedProjects = Array.from(projectSet).sort();
      sortedProjects.forEach(project => {
        const option = document.createElement('option');
        option.value = project;
        option.textContent = project;
        if (project === selectedProject) option.selected = true;
        projectFilter.appendChild(option);
      });
    }

    // H√†m filter d·ªØ li·ªáu
    function filterF2Data(data) {
      if (!data || !Array.isArray(data)) return [];
      
      const picFilter = document.getElementById('f2-filter-pic');
      const projectFilter = document.getElementById('f2-filter-project');
      
      const selectedPic = picFilter ? picFilter.value : '';
      const selectedProject = projectFilter ? projectFilter.value : '';
      
      return data.filter(row => {
        const pic = row.pic_cluster || row['PIC c·ª•m'] || row.pic_cum || row.pic || '';
        const project = row.project || row['D·ª± √°n'] || row.du_an || '';
        
        const picMatch = !selectedPic || pic === selectedPic;
        const projectMatch = !selectedProject || project === selectedProject;
        
        return picMatch && projectMatch;
      });
    }

    // H√†m xu·∫•t d·ªØ li·ªáu ra Excel
    function exportF2ToExcel() {
      // L·∫•y d·ªØ li·ªáu ƒë√£ filter
      const filteredData = filterF2Data(F2_ORIGINAL_DATA);
      
      if (!filteredData || filteredData.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      try {
        // Chu·∫©n b·ªã d·ªØ li·ªáu cho Excel
        const excelData = filteredData.map((row, index) => {
          // L·∫•y gi√° tr·ªã t·ª∑ l·ªá ho√†n thi·ªán b·ªï sung
          const completionRate = row.completion_rate || row.completion || 
                                 row['T·ª∑ l·ªá ho√†n thi·ªán b·ªï sung'] || row['T·ª∑ l·ªá ho√†n thi·ªán'] ||
                                 row.completion_rate_supplement || row.completion_supplement ||
                                 row.rate || row.percent || row.percentage || 
                                 row.ty_le_hoan_thien_bo_sung || row.ty_le_hoan_thien || '0%';

          return {
            'STT': index + 1,
            'PIC c·ª•m': row.pic_cluster || row['PIC c·ª•m'] || row.pic_cum || row.pic || '',
            'D·ª± √°n': row.project || row['D·ª± √°n'] || row.du_an || '',
            'Ng√†y giao': row.delivery_date || row['Ng√†y giao'] || row.ngay_giao || row.date || '',
            'M√£ SAP': row.sap_code || row['M√£ SAP'] || row.ma_sap || row.sap || '',
            'C·ª•m linh ki·ªán': row.component_cluster || row['C·ª•m linh ki·ªán'] || row.cum_linh_kien || row.cluster || '',
            'T√™n linh ki·ªán': row.component_name || row['T√™n linh ki·ªán'] || row.ten_linh_kien || row.name || '',
            'R√† so√°t TCKT&CE': row.review || row['R√† so√°t TCKT&CE'] || row.ra_soat || row.ra_soat_tckt_ce || '',
            'Ng√†y c·∫≠p nh·∫≠t g·∫ßn nh·∫•t': row.last_update || row['Ng√†y c·∫≠p nh·∫≠t g·∫ßn nh·∫•t'] || row.ngay_cap_nhat || row.updated_at || '',
            'T·ª∑ l·ªá ho√†n thi·ªán b·ªï sung': String(completionRate)
          };
        });

        // T·∫°o worksheet t·ª´ d·ªØ li·ªáu
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // ƒêi·ªÅu ch·ªânh ƒë·ªô r·ªông c·ªôt (t√πy ch·ªçn)
        const colWidths = [
          { wch: 8 },   // STT
          { wch: 15 },  // PIC c·ª•m
          { wch: 20 },  // D·ª± √°n
          { wch: 12 },  // Ng√†y giao
          { wch: 12 },  // M√£ SAP
          { wch: 25 },  // C·ª•m linh ki·ªán
          { wch: 35 },  // T√™n linh ki·ªán
          { wch: 18 },  // R√† so√°t TCKT&CE
          { wch: 22 },  // Ng√†y c·∫≠p nh·∫≠t g·∫ßn nh·∫•t
          { wch: 25 }   // T·ª∑ l·ªá ho√†n thi·ªán b·ªï sung
        ];
        ws['!cols'] = colWidths;

        // T·∫°o workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'R√† so√°t CE');

        // T·∫°o t√™n file v·ªõi timestamp
        const now = new Date();
        const dateStr = now.getFullYear() + '-' + 
                       String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(now.getDate()).padStart(2, '0') + '_' +
                       String(now.getHours()).padStart(2, '0') + '-' +
                       String(now.getMinutes()).padStart(2, '0') + '-' +
                       String(now.getSeconds()).padStart(2, '0');
        const filename = `Ra_soat_CE_${dateStr}.xlsx`;

        // Xu·∫•t file
        XLSX.writeFile(wb, filename);
        
        showToast(`ƒê√£ xu·∫•t ${filteredData.length} b·∫£n ghi ra file Excel`, 'success');
        
      } catch (error) {
        console.error('[Form 2] Error exporting to Excel:', error);
        showToast('L·ªói khi xu·∫•t file Excel: ' + error.message, 'error');
      }
    }

    // H√†m render d·ªØ li·ªáu v√†o b·∫£ng Form 2
    function renderForm2Table(data) {
      // L∆∞u d·ªØ li·ªáu g·ªëc
      F2_ORIGINAL_DATA = data || [];
      
      // Populate filters
      populateF2Filters(F2_ORIGINAL_DATA);
      
      // Filter d·ªØ li·ªáu
      const filteredData = filterF2Data(F2_ORIGINAL_DATA);
      
      const tbody = document.getElementById('f2-table-body');
      if (!tbody) return;
      
      if (!filteredData || !Array.isArray(filteredData) || filteredData.length === 0) {
        tbody.innerHTML = '<tr><td class="px-3 py-4 text-center text-gray-500 border border-gray-300" colspan="9">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p v·ªõi b·ªô l·ªçc</td></tr>';
        return;
      }
      
      let html = '';
      filteredData.forEach((row, index) => {
        // L·∫•y gi√° tr·ªã t·ª∑ l·ªá ho√†n thi·ªán b·ªï sung - h·ªó tr·ª£ nhi·ªÅu t√™n field kh√°c nhau
        const completionRate = row.completion_rate || row.completion || 
                               row['T·ª∑ l·ªá ho√†n thi·ªán b·ªï sung'] || row['T·ª∑ l·ªá ho√†n thi·ªán'] ||
                               row.completion_rate_supplement || row.completion_supplement ||
                               row.rate || row.percent || row.percentage || 
                               row.ty_le_hoan_thien_bo_sung || row.ty_le_hoan_thien || '0%';
        const completionPercent = parseFloat(String(completionRate).replace('%', '')) || 0;
        const completionColor = getCompletionColor(completionPercent);
        
        // H·ªó tr·ª£ nhi·ªÅu t√™n field kh√°c nhau cho t·ª´ng c·ªôt
        html += `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.pic_cluster || row['PIC c·ª•m'] || row.pic_cum || row.pic || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.project || row['D·ª± √°n'] || row.du_an || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.delivery_date || row['Ng√†y giao'] || row.ngay_giao || row.date || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.sap_code || row['M√£ SAP'] || row.ma_sap || row.sap || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.component_cluster || row['C·ª•m linh ki·ªán'] || row.cum_linh_kien || row.cluster || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.component_name || row['T√™n linh ki·ªán'] || row.ten_linh_kien || row.name || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.review || row['R√† so√°t TCKT&CE'] || row.ra_soat || row.ra_soat_tckt_ce || '')}</td>
            <td class="px-3 py-4 border border-gray-300">${escapeHtml(row.last_update || row['Ng√†y c·∫≠p nh·∫≠t g·∫ßn nh·∫•t'] || row.ngay_cap_nhat || row.updated_at || '')}</td>
            <td class="px-3 py-4 border border-gray-300 text-center">${escapeHtml(String(completionRate))}</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }

    // H√†m fetch d·ªØ li·ªáu t·ª´ webhook cho Form 2
    async function fetchForm2Data() {
      const loadBtn = document.getElementById('f2-load-btn');
      const loadingDiv = document.getElementById('f2-loading');
      const tbody = document.getElementById('f2-table-body');
      
      const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/0a37d9a8-8be4-4311-93cf-923e7e874128';
      
      try {
        // Hi·ªÉn th·ªã loading
        if (loadBtn) loadBtn.disabled = true;
        if (loadingDiv) loadingDiv.classList.remove('hidden');
        if (tbody) {
          tbody.innerHTML = '<tr><td class="px-3 py-4 text-center text-gray-500 border border-gray-300" colspan="9">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
        }
        
        console.log('[Form 2] Fetching data from:', webhookUrl);
        
        // G·ªçi API v·ªõi query parameters (c√≥ th·ªÉ th√™m filter, page, limit, etc.)
        const params = new URLSearchParams({
          // C√≥ th·ªÉ th√™m c√°c query params ·ªü ƒë√¢y n·∫øu c·∫ßn
          // format: 'json',
          // limit: '100',
          // offset: '0'
        });
        
        const url = `${webhookUrl}?${params.toString()}`;
        console.log('[Form 2] Full URL:', url);
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        
        console.log('[Form 2] Response status:', response.status, response.statusText);
        console.log('[Form 2] Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseText = await response.text();
        console.log('[Form 2] Response text:', responseText);
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          console.error('[Form 2] JSON parse error:', e);
          // N·∫øu kh√¥ng ph·∫£i JSON, th·ª≠ x·ª≠ l√Ω nh∆∞ text
          throw new Error('Response is not valid JSON');
        }
        
        console.log('[Form 2] Parsed data:', data);
        
        // X·ª≠ l√Ω d·ªØ li·ªáu tr·∫£ v·ªÅ - c√≥ th·ªÉ l√† array tr·ª±c ti·∫øp ho·∫∑c object ch·ª©a array
        let tableData = [];
        if (Array.isArray(data)) {
          tableData = data;
        } else if (data && Array.isArray(data.data)) {
          tableData = data.data;
        } else if (data && Array.isArray(data.results)) {
          tableData = data.results;
        } else if (data && Array.isArray(data.items)) {
          tableData = data.items;
        } else if (data && typeof data === 'object') {
          // N·∫øu l√† object ƒë∆°n, th·ª≠ chuy·ªÉn th√†nh array 1 ph·∫ßn t·ª≠
          tableData = [data];
        }
        
        console.log('[Form 2] Table data:', tableData);
        
        // Render d·ªØ li·ªáu v√†o b·∫£ng
        renderForm2Table(tableData);
        
        // Th√¥ng b√°o th√†nh c√¥ng
        showToast(`ƒê√£ t·∫£i ${tableData.length} b·∫£n ghi`, 'success');
        
      } catch (error) {
        console.error('[Form 2] Error fetching data:', error);
        if (tbody) {
          tbody.innerHTML = `<tr><td class="px-3 py-4 text-center text-red-500 border border-gray-300" colspan="9">L·ªói: ${escapeHtml(error.message)}</td></tr>`;
        }
        showToast('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
      } finally {
        // ·∫®n loading
        if (loadBtn) loadBtn.disabled = false;
        if (loadingDiv) loadingDiv.classList.add('hidden');
      }
    }

    // Event listener cho n√∫t t·∫£i d·ªØ li·ªáu Form 2
    document.addEventListener('DOMContentLoaded', function() {
      const f2LoadBtn = document.getElementById('f2-load-btn');
      if (f2LoadBtn) {
        f2LoadBtn.addEventListener('click', function() {
          fetchForm2Data();
        });
      }
      
      // T·ª± ƒë·ªông load d·ªØ li·ªáu khi chuy·ªÉn sang Form 2 (t√πy ch·ªçn)
      const navButtons = document.querySelectorAll('.nav-btn[data-target="form2"]');
      navButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          // C√≥ th·ªÉ t·ª± ƒë·ªông load ho·∫∑c kh√¥ng
          // fetchForm2Data();
        });
      });

      // X·ª≠ l√Ω filter cho Form 2
      const picFilter = document.getElementById('f2-filter-pic');
      const projectFilter = document.getElementById('f2-filter-project');
      const resetFilterBtn = document.getElementById('f2-reset-filter');
      
      if (picFilter) {
        picFilter.addEventListener('change', function() {
          if (F2_ORIGINAL_DATA && F2_ORIGINAL_DATA.length > 0) {
            renderForm2Table(F2_ORIGINAL_DATA);
          }
        });
      }
      
      if (projectFilter) {
        projectFilter.addEventListener('change', function() {
          if (F2_ORIGINAL_DATA && F2_ORIGINAL_DATA.length > 0) {
            renderForm2Table(F2_ORIGINAL_DATA);
          }
        });
      }
      
      if (resetFilterBtn) {
        resetFilterBtn.addEventListener('click', function() {
          if (picFilter) picFilter.value = '';
          if (projectFilter) projectFilter.value = '';
          if (F2_ORIGINAL_DATA && F2_ORIGINAL_DATA.length > 0) {
            renderForm2Table(F2_ORIGINAL_DATA);
          }
        });
      }

      // N√∫t xu·∫•t Excel
      const exportExcelBtn = document.getElementById('f2-export-excel');
      if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', function() {
          exportF2ToExcel();
        });
      }

      // ===== FORM 2 - X·ª¨ L√ù MODAL KHAI B√ÅO (SO S√ÅNH CE) =====
      
      // Bi·∫øn l∆∞u tr·ªØ file
      let F2_CE_ORIGINAL_FILE = null;
      let F2_CE_REVIEW_FILE = null;
      
      // Kh·ªüi t·∫°o t·∫•t c·∫£ modal listeners
      initAllModalListeners();
      
      // N√∫t m·ªü modal Khai b√°o
      const f2DeclarationBtn = document.getElementById('f2-declaration-btn');
      if (f2DeclarationBtn) {
        f2DeclarationBtn.addEventListener('click', function() {
          openF2DeclarationModal();
        });
      }
      
      // X·ª≠ l√Ω upload file CE g·ªëc
      const f2CeOriginalBtn = document.getElementById('f2-ce-original-btn');
      const f2CeOriginal = document.getElementById('f2-ce-original');
      const f2CeOriginalRemove = document.getElementById('f2-ce-original-remove');
      
      if (f2CeOriginalBtn && f2CeOriginal) {
        f2CeOriginalBtn.addEventListener('click', function() {
          f2CeOriginal.click();
        });
      }
      
      if (f2CeOriginal) {
        f2CeOriginal.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            F2_CE_ORIGINAL_FILE = file;
            document.getElementById('f2-ce-original-name').textContent = file.name;
            document.getElementById('f2-ce-original-name').className = 'text-sm text-green-600 flex-1 font-medium';
            if (f2CeOriginalRemove) f2CeOriginalRemove.classList.remove('hidden');
            showToast('ƒê√£ ch·ªçn file CE g·ªëc: ' + file.name);
          }
        });
      }
      
      if (f2CeOriginalRemove) {
        f2CeOriginalRemove.addEventListener('click', function() {
          if (f2CeOriginal) f2CeOriginal.value = '';
          F2_CE_ORIGINAL_FILE = null;
          document.getElementById('f2-ce-original-name').textContent = 'Ch∆∞a ch·ªçn file';
          document.getElementById('f2-ce-original-name').className = 'text-sm text-gray-500 flex-1';
          this.classList.add('hidden');
        });
      }
      
      // X·ª≠ l√Ω upload file CE sau r√† so√°t
      const f2CeReviewBtn = document.getElementById('f2-ce-review-btn');
      const f2CeReview = document.getElementById('f2-ce-review');
      const f2CeReviewRemove = document.getElementById('f2-ce-review-remove');
      
      if (f2CeReviewBtn && f2CeReview) {
        f2CeReviewBtn.addEventListener('click', function() {
          f2CeReview.click();
        });
      }
      
      if (f2CeReview) {
        f2CeReview.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            F2_CE_REVIEW_FILE = file;
            document.getElementById('f2-ce-review-name').textContent = file.name;
            document.getElementById('f2-ce-review-name').className = 'text-sm text-green-600 flex-1 font-medium';
            if (f2CeReviewRemove) f2CeReviewRemove.classList.remove('hidden');
            showToast('ƒê√£ ch·ªçn file CE sau r√† so√°t: ' + file.name);
          }
        });
      }
      
      if (f2CeReviewRemove) {
        f2CeReviewRemove.addEventListener('click', function() {
          if (f2CeReview) f2CeReview.value = '';
          F2_CE_REVIEW_FILE = null;
          document.getElementById('f2-ce-review-name').textContent = 'Ch∆∞a ch·ªçn file';
          document.getElementById('f2-ce-review-name').className = 'text-sm text-gray-500 flex-1';
          this.classList.add('hidden');
        });
      }
      
      // G·ª≠i d·ªØ li·ªáu so s√°nh CE
      const f2DeclarationSubmitBtn = document.getElementById('modal-f2-declaration-submit');
      if (f2DeclarationSubmitBtn) {
        f2DeclarationSubmitBtn.addEventListener('click', async function() {
          await submitF2Declaration();
        });
      }
    });

    // ============================================
    // MODAL SYSTEM - CENTRALIZED MANAGEMENT
    // ============================================
    // 
    // H·ªÜ TH·ªêNG QU·∫¢N L√ù MODAL T·∫¨P TRUNG
    // 
    // ƒê·ªÉ th√™m modal m·ªõi:
    // 
    // 1. ƒêƒÇNG K√ù MODAL TRONG MODAL_REGISTRY:
    //    - Th√™m entry v·ªõi key duy nh·∫•t: 'form-purpose' (v√≠ d·ª•: 'f3-upload', 'f4-edit')
    //    - ƒê·∫∑t ID theo format: modal-{form}-{purpose}
    //    - C·∫•u tr√∫c HTML modal:
    //      <div id="modal-{form}-{purpose}" class="modal-container modal-{form}-{purpose} fixed inset-0 z-50 hidden">
    //        <div id="modal-{form}-{purpose}-overlay" class="modal-overlay modal-{form}-{purpose}-overlay fixed inset-0 bg-black/50"></div>
    //        <div id="modal-{form}-{purpose}-content" class="modal-content modal-{form}-{purpose}-content ...">
    //          <!-- N·ªôi dung modal -->
    //          <button id="modal-{form}-{purpose}-close" class="modal-close">ƒê√≥ng</button>
    //          <!-- C√°c button kh√°c -->
    //        </div>
    //      </div>
    // 
    // 2. TH√äM V√ÄO MODAL_REGISTRY:
    //    'f3-upload': {
    //      id: 'modal-f3-upload',
    //      overlayId: 'modal-f3-upload-overlay',
    //      contentId: 'modal-f3-upload-content',
    //      closeBtnIds: ['modal-f3-upload-close', 'modal-f3-upload-close-btn'],
    //      cancelBtnId: 'modal-f3-upload-cancel', // ho·∫∑c null
    //      submitBtnId: 'modal-f3-upload-submit', // ho·∫∑c null
    //      formId: 'modal-f3-upload-form', // ho·∫∑c null
    //      bodyId: 'modal-f3-upload-body' // ho·∫∑c null
    //    }
    // 
    // 3. T·∫†O H√ÄM M·ªû MODAL:
    //    function openF3UploadModal() {
    //      openModal('f3-upload', (modal, config) => {
    //        // Callback ƒë·ªÉ setup form/data tr∆∞·ªõc khi m·ªü
    //        // V√≠ d·ª•: reset form, load data, etc.
    //      });
    //    }
    // 
    // 4. T·∫†O H√ÄM ƒê√ìNG MODAL (t√πy ch·ªçn):
    //    function closeF3UploadModal() {
    //      closeModal('f3-upload');
    //    }
    // 
    // 5. KH·ªûI T·∫†O LISTENERS (t·ª± ƒë·ªông qua initAllModalListeners()):
    //    - Close buttons s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c g·∫Øn listener
    //    - Overlay click s·∫Ω t·ª± ƒë·ªông ƒë√≥ng modal
    //    - ESC key s·∫Ω t·ª± ƒë·ªông ƒë√≥ng modal ƒëang m·ªü
    // 
    // 6. S·ª¨ D·ª§NG:
    //    - M·ªü modal: openModal('f3-upload') ho·∫∑c openF3UploadModal()
    //    - ƒê√≥ng modal: closeModal('f3-upload') ho·∫∑c closeF3UploadModal()
    //    - ƒê√≥ng t·∫•t c·∫£: closeAllModals()
    // 
    // L∆ØU √ù:
    // - T·∫•t c·∫£ modal s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c ƒë√≥ng khi m·ªü modal m·ªõi
    // - Modal s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c di chuy·ªÉn v·ªÅ body level n·∫øu c·∫ßn
    // - CSS classes: modal-container, modal-overlay, modal-content, modal-close, modal-close-btn, modal-cancel-btn, modal-submit-btn
    // - Namespace: m·ªói modal c√≥ prefix ri√™ng ƒë·ªÉ tr√°nh conflict (modal-{form}-{purpose})
    // 
    /**
     * Modal Registry - ƒêƒÉng k√Ω t·∫•t c·∫£ modal t·∫°i ƒë√¢y
     * Format: 'modal-{form}-{purpose}'
     */
    const MODAL_REGISTRY = {
      'f2-declaration': {
        id: 'modal-f2-declaration',
        overlayId: 'modal-f2-declaration-overlay',
        contentId: 'modal-f2-declaration-content',
        closeBtnIds: ['modal-f2-declaration-close', 'modal-f2-declaration-close-btn'],
        cancelBtnId: null,
        submitBtnId: 'modal-f2-declaration-submit',
        formId: null,
        bodyId: 'modal-f2-declaration-body'
      },
      'f5-add-subtask': {
        id: 'modal-f5-add-subtask',
        overlayId: 'modal-f5-add-subtask-overlay',
        contentId: 'modal-f5-add-subtask-content',
        closeBtnIds: ['modal-f5-add-subtask-close'],
        cancelBtnId: 'modal-f5-add-subtask-cancel',
        submitBtnId: 'modal-f5-add-subtask-submit-btn',
        formId: 'modal-f5-add-subtask-form',
        bodyId: null
      },
      'f5-select-declaration': {
        id: 'modal-f5-select-declaration',
        overlayId: 'modal-f5-select-declaration-overlay',
        contentId: 'modal-f5-select-declaration-content',
        closeBtnIds: ['modal-f5-select-declaration-close'],
        cancelBtnId: 'modal-f5-select-declaration-cancel',
        submitBtnId: null,
        formId: null,
        bodyId: null
      },
      'f5-import-excel': {
        id: 'modal-f5-import-excel',
        overlayId: 'modal-f5-import-excel-overlay',
        contentId: 'modal-f5-import-excel-content',
        closeBtnIds: ['modal-f5-import-excel-close'],
        cancelBtnId: 'modal-f5-import-excel-cancel',
        submitBtnId: 'modal-f5-import-excel-submit',
        formId: null,
        bodyId: null
      },
      'f5-declaration-review-file-nctn': {
        id: 'modal-f5-declaration-review-file-nctn',
        overlayId: 'modal-f5-declaration-review-file-nctn-overlay',
        contentId: 'modal-f5-declaration-review-file-nctn-content',
        closeBtnIds: ['modal-f5-declaration-review-file-nctn-close'],
        cancelBtnId: 'modal-f5-declaration-review-file-nctn-cancel',
        submitBtnId: 'modal-f5-declaration-review-file-nctn-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-review-file-nctn-body'
      },
      'f5-declaration-review-ce-qc': {
        id: 'modal-f5-declaration-review-ce-qc',
        overlayId: 'modal-f5-declaration-review-ce-qc-overlay',
        contentId: 'modal-f5-declaration-review-ce-qc-content',
        closeBtnIds: ['modal-f5-declaration-review-ce-qc-close'],
        cancelBtnId: 'modal-f5-declaration-review-ce-qc-cancel',
        submitBtnId: 'modal-f5-declaration-review-ce-qc-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-review-ce-qc-body'
      },
      'f5-declaration-train-qc': {
        id: 'modal-f5-declaration-train-qc',
        overlayId: 'modal-f5-declaration-train-qc-overlay',
        contentId: 'modal-f5-declaration-train-qc-content',
        closeBtnIds: ['modal-f5-declaration-train-qc-close'],
        cancelBtnId: 'modal-f5-declaration-train-qc-cancel',
        submitBtnId: 'modal-f5-declaration-train-qc-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-train-qc-body'
      },
      'f5-declaration-send-test-task': {
        id: 'modal-f5-declaration-send-test-task',
        overlayId: 'modal-f5-declaration-send-test-task-overlay',
        contentId: 'modal-f5-declaration-send-test-task-content',
        closeBtnIds: ['modal-f5-declaration-send-test-task-close'],
        cancelBtnId: 'modal-f5-declaration-send-test-task-cancel',
        submitBtnId: 'modal-f5-declaration-send-test-task-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-send-test-task-body'
      },
      'f5-declaration-review-4m': {
        id: 'modal-f5-declaration-review-4m',
        overlayId: 'modal-f5-declaration-review-4m-overlay',
        contentId: 'modal-f5-declaration-review-4m-content',
        closeBtnIds: ['modal-f5-declaration-review-4m-close'],
        cancelBtnId: 'modal-f5-declaration-review-4m-cancel',
        submitBtnId: 'modal-f5-declaration-review-4m-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-review-4m-body'
      },
      'f5-declaration-review-fmea': {
        id: 'modal-f5-declaration-review-fmea',
        overlayId: 'modal-f5-declaration-review-fmea-overlay',
        contentId: 'modal-f5-declaration-review-fmea-content',
        closeBtnIds: ['modal-f5-declaration-review-fmea-close'],
        cancelBtnId: 'modal-f5-declaration-review-fmea-cancel',
        submitBtnId: 'modal-f5-declaration-review-fmea-submit',
        formId: null,
        bodyId: 'modal-f5-declaration-review-fmea-body'
      },
      'f5-declaration-complete': {
        id: 'modal-f5-declaration-complete',
        overlayId: 'modal-f5-declaration-complete-overlay',
        contentId: 'modal-f5-declaration-complete-content',
        closeBtnIds: ['modal-f5-declaration-complete-close'],
        cancelBtnId: 'modal-f5-declaration-complete-cancel',
        submitBtnId: 'modal-f5-declaration-complete-submit',
        formId: 'modal-f5-declaration-complete-form',
        bodyId: 'modal-f5-declaration-complete-body'
      },
      'f3-declaration': {
        id: 'modal-f3-declaration',
        overlayId: 'modal-f3-declaration-overlay',
        contentId: 'modal-f3-declaration-content',
        closeBtnIds: ['modal-f3-declaration-close'],
        cancelBtnId: 'modal-f3-declaration-cancel',
        submitBtnId: 'modal-f3-declaration-submit',
        formId: null,
        bodyId: 'modal-f3-declaration-body'
      },
      'f3-add-story': {
        id: 'modal-f3-add-story',
        overlayId: 'modal-f3-add-story-overlay',
        contentId: 'modal-f3-add-story-content',
        closeBtnIds: ['modal-f3-add-story-close'],
        cancelBtnId: 'modal-f3-add-story-cancel',
        submitBtnId: 'modal-f3-add-story-submit',
        formId: 'modal-f3-add-story-form',
        bodyId: null
      },
      'f3-add-subtask': {
        id: 'modal-f3-add-subtask',
        overlayId: 'modal-f3-add-subtask-overlay',
        contentId: 'modal-f3-add-subtask-content',
        closeBtnIds: ['modal-f3-add-subtask-close'],
        cancelBtnId: 'modal-f3-add-subtask-cancel',
        submitBtnId: 'modal-f3-add-subtask-submit',
        formId: 'modal-f3-add-subtask-form',
        bodyId: null
      },
      'f5-view-detail': {
        id: 'modal-f5-view-detail',
        overlayId: 'modal-f5-view-detail-overlay',
        contentId: 'modal-f5-view-detail-content',
        closeBtnIds: ['modal-f5-view-detail-close', 'modal-f5-view-detail-close-btn'],
        cancelBtnId: null,
        submitBtnId: null,
        formId: null,
        bodyId: 'modal-f5-view-detail-body'
      },
      'f5-subtask-download': {
        id: 'modal-f5-subtask-download',
        overlayId: 'modal-f5-subtask-download-overlay',
        contentId: 'modal-f5-subtask-download-content',
        closeBtnIds: ['modal-f5-subtask-download-close', 'modal-f5-subtask-download-cancel'],
        cancelBtnId: 'modal-f5-subtask-download-cancel',
        submitBtnId: null,
        formId: null,
        bodyId: null
      },
      'f9-view-detail': {
        id: 'modal-f9-view-detail',
        overlayId: 'modal-f9-view-detail-overlay',
        contentId: 'modal-f9-view-detail-content',
        closeBtnIds: ['modal-f9-view-detail-close', 'modal-f9-view-detail-close-btn'],
        cancelBtnId: null,
        submitBtnId: null,
        formId: null,
        bodyId: 'modal-f9-view-detail-body'
      },
      'f9-hang-muc-ng': {
        id: 'modal-f9-hang-muc-ng',
        overlayId: 'modal-f9-hang-muc-ng-overlay',
        contentId: 'modal-f9-hang-muc-ng-content',
        closeBtnIds: ['modal-f9-hang-muc-ng-close', 'modal-f9-hang-muc-ng-close-btn'],
        cancelBtnId: null,
        submitBtnId: null,
        formId: null,
        bodyId: 'modal-f9-hang-muc-ng-body'
      },
      'f6-person-detail': {
        id: 'modal-f6-person-detail',
        overlayId: 'modal-f6-person-detail-overlay',
        contentId: 'modal-f6-person-detail-content',
        closeBtnIds: ['modal-f6-person-detail-close', 'modal-f6-person-detail-close-btn'],
        cancelBtnId: null,
        submitBtnId: null,
        formId: null,
        bodyId: 'modal-f6-person-detail-body'
      }
    };
    
    /**
     * H√†m ƒë√≥ng t·∫•t c·∫£ modal
     */
    function closeAllModals() {
      Object.values(MODAL_REGISTRY).forEach(config => {
        const modal = document.getElementById(config.id);
        if (modal) {
          modal.classList.add('hidden');
          modal.style.display = 'none';
          modal.style.visibility = 'hidden';
          modal.style.opacity = '0';
          // Reset overflow c·ªßa parent containers
          let parent = modal.parentElement;
          while (parent && parent !== document.body) {
            const computedStyle = window.getComputedStyle(parent);
            if (computedStyle.overflow === 'visible') {
              parent.style.removeProperty('overflow');
            }
            parent = parent.parentElement;
          }
        }
      });
      document.body.style.overflow = '';
    }
    
    /**
     * H√†m m·ªü modal theo key
     * @param {string} modalKey - Key trong MODAL_REGISTRY (v√≠ d·ª•: 'f2-declaration', 'f5-add-subtask')
     * @param {Function} beforeOpenCallback - Callback ƒë∆∞·ª£c g·ªçi tr∆∞·ªõc khi m·ªü modal
     * @returns {boolean} - true n·∫øu m·ªü th√†nh c√¥ng
     */
    function openModal(modalKey, beforeOpenCallback = null) {
      const config = MODAL_REGISTRY[modalKey];
      if (!config) {
        console.error(`[Modal System] Modal key "${modalKey}" not found in registry`);
        return false;
      }
      
      // ƒê√≥ng t·∫•t c·∫£ modal kh√°c tr∆∞·ªõc
      closeAllModals();
      
      const modal = document.getElementById(config.id);
      if (!modal) {
        console.error(`[Modal System] Modal element "${config.id}" not found`);
        return false;
      }
      
      // ƒê·∫£m b·∫£o modal n·∫±m ·ªü body level
      if (modal.parentElement && modal.parentElement !== document.body) {
        document.body.appendChild(modal);
        console.log(`[Modal System] Modal "${modalKey}" moved to body level`);
      }
      
      // G·ªçi callback tr∆∞·ªõc khi m·ªü
      if (beforeOpenCallback && typeof beforeOpenCallback === 'function') {
        beforeOpenCallback(modal, config);
      }
      
      // Hi·ªÉn th·ªã modal
      modal.classList.remove('hidden');
      modal.removeAttribute('class');
      modal.className = 'modal-container fixed inset-0 z-50';
      
      modal.style.cssText = `
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 99999 !important;
        margin: 0 !important;
        padding: 0 !important;
      `;
      
      document.body.style.overflow = 'hidden';
      
      // ƒê·∫£m b·∫£o overlay hi·ªÉn th·ªã
      const overlay = document.getElementById(config.overlayId);
      if (overlay) {
        overlay.style.cssText = `
          display: block !important;
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          bottom: 0 !important;
          z-index: 99998 !important;
          background-color: rgba(0, 0, 0, 0.3) !important;
          backdrop-filter: blur(4px) !important;
          margin: 0 !important;
          padding: 0 !important;
        `;
      }
      
      // ƒê·∫£m b·∫£o content container hi·ªÉn th·ªã ƒë√∫ng
      const contentContainer = document.getElementById(config.contentId);
      if (contentContainer) {
        contentContainer.style.cssText = `
          display: flex !important;
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          bottom: 0 !important;
          z-index: 99999 !important;
          pointer-events: none !important;
          align-items: center !important;
          justify-content: center !important;
          padding: 1rem !important;
          margin: 0 !important;
        `;
      }
      
      // Ki·ªÉm tra parent container c√≥ overflow-hidden kh√¥ng
      let parent = modal.parentElement;
      while (parent && parent !== document.body) {
        const computedStyle = window.getComputedStyle(parent);
        if (computedStyle.overflow === 'hidden' || computedStyle.overflowX === 'hidden' || computedStyle.overflowY === 'hidden') {
          console.warn(`[Modal System] Parent container has overflow-hidden for "${modalKey}":`, parent);
          parent.style.overflow = 'visible';
        }
        parent = parent.parentElement;
      }
      
      console.log(`[Modal System] Modal "${modalKey}" opened`);
      return true;
    }
    
    /**
     * H√†m ƒë√≥ng modal theo key
     * @param {string} modalKey - Key trong MODAL_REGISTRY
     * @returns {boolean} - true n·∫øu ƒë√≥ng th√†nh c√¥ng
     */
    function closeModal(modalKey) {
      const config = MODAL_REGISTRY[modalKey];
      if (!config) {
        console.error(`[Modal System] Modal key "${modalKey}" not found in registry`);
        return false;
      }
      
      const modal = document.getElementById(config.id);
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        
        // Reset overflow c·ªßa parent containers
        let parent = modal.parentElement;
        while (parent && parent !== document.body) {
          const computedStyle = window.getComputedStyle(parent);
          if (computedStyle.overflow === 'visible') {
            parent.style.removeProperty('overflow');
          }
          parent = parent.parentElement;
        }
        
        console.log(`[Modal System] Modal "${modalKey}" closed`);
        return true;
      }
      return false;
    }
    
    /**
     * Kh·ªüi t·∫°o event listeners cho m·ªôt modal
     * @param {string} modalKey - Key trong MODAL_REGISTRY
     */
    function initModalListeners(modalKey) {
      const config = MODAL_REGISTRY[modalKey];
      if (!config) {
        console.error(`[Modal System] Modal key "${modalKey}" not found in registry`);
        return;
      }
      
      const modal = document.getElementById(config.id);
      if (!modal) return;
      
      // Close buttons
      config.closeBtnIds.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn && !btn._modalListenerAttached) {
          btn._modalListenerAttached = true;
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal(modalKey);
          });
        }
      });
      
      // Cancel button
      if (config.cancelBtnId) {
        const cancelBtn = document.getElementById(config.cancelBtnId);
        if (cancelBtn && !cancelBtn._modalListenerAttached) {
          cancelBtn._modalListenerAttached = true;
          cancelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal(modalKey);
          });
        }
      }
      
      // Overlay click
      const overlay = document.getElementById(config.overlayId);
      if (overlay && !overlay._modalListenerAttached) {
        overlay._modalListenerAttached = true;
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeModal(modalKey);
          }
        });
      }
      
      // ESC key - s·ª≠ d·ª•ng event delegation tr√™n document
      if (!document._modalEscHandler) {
        document._modalEscHandler = function(e) {
          if (e.key === 'Escape') {
            // ƒê√≥ng modal ƒëang m·ªü (modal kh√¥ng c√≥ class hidden)
            Object.keys(MODAL_REGISTRY).forEach(key => {
              const m = document.getElementById(MODAL_REGISTRY[key].id);
              if (m && !m.classList.contains('hidden')) {
                closeModal(key);
              }
            });
          }
        };
        document.addEventListener('keydown', document._modalEscHandler);
      }
      
      console.log(`[Modal System] Listeners initialized for "${modalKey}"`);
    }
    
    /**
     * Kh·ªüi t·∫°o t·∫•t c·∫£ modal listeners
     */
    function initAllModalListeners() {
      Object.keys(MODAL_REGISTRY).forEach(key => {
        initModalListeners(key);
      });
      console.log(`[Modal System] All modal listeners initialized (${Object.keys(MODAL_REGISTRY).length} modals)`);
    }
    
    // ============================================
    // END MODAL SYSTEM - CENTRALIZED MANAGEMENT
    // ============================================

    // H√†m m·ªü modal Khai b√°o Form 2 - S·ª≠ d·ª•ng h·ªá th·ªëng modal t·∫≠p trung
    function openF2DeclarationModal() {
      // S·ª≠ d·ª•ng h·ªá th·ªëng modal t·∫≠p trung
      const success = openModal('f2-declaration', (modal, config) => {
        // Callback tr∆∞·ªõc khi m·ªü modal - Reset form
      F2_CE_ORIGINAL_FILE = null;
      F2_CE_REVIEW_FILE = null;
      if (document.getElementById('f2-ce-original')) document.getElementById('f2-ce-original').value = '';
      if (document.getElementById('f2-ce-review')) document.getElementById('f2-ce-review').value = '';
      if (document.getElementById('f2-ce-original-name')) {
        document.getElementById('f2-ce-original-name').textContent = 'Ch∆∞a ch·ªçn file';
        document.getElementById('f2-ce-original-name').className = 'text-sm text-gray-500 flex-1';
      }
      if (document.getElementById('f2-ce-review-name')) {
        document.getElementById('f2-ce-review-name').textContent = 'Ch∆∞a ch·ªçn file';
        document.getElementById('f2-ce-review-name').className = 'text-sm text-gray-500 flex-1';
      }
      const removeBtns = document.querySelectorAll('#f2-ce-original-remove, #f2-ce-review-remove');
      removeBtns.forEach(btn => btn.classList.add('hidden'));
      
      // ·∫®n k·∫øt qu·∫£
      const resultDiv = document.getElementById('f2-declaration-result');
      if (resultDiv) resultDiv.classList.add('hidden');
      });
      
      if (!success) {
        console.error('[Form 2] Failed to open modal');
      }
    }

    // H√†m ƒë√≥ng modal Khai b√°o Form 2 - S·ª≠ d·ª•ng h·ªá th·ªëng modal t·∫≠p trung
    function closeF2DeclarationModal() {
      closeModal('f2-declaration');
    }

    // H√†m submit form so s√°nh CE Form 2
    async function submitF2Declaration() {
      // L·∫•y file tr·ª±c ti·∫øp t·ª´ input element thay v√¨ d√πng bi·∫øn
      const f2CeOriginalInput = document.getElementById('f2-ce-original');
      const f2CeReviewInput = document.getElementById('f2-ce-review');
      
      // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
      if (!f2CeOriginalInput || !f2CeOriginalInput.files || !f2CeOriginalInput.files[0]) {
        showToast('Vui l√≤ng ch·ªçn file CE g·ªëc', 'error');
        return;
      }

      if (!f2CeReviewInput || !f2CeReviewInput.files || !f2CeReviewInput.files[0]) {
        showToast('Vui l√≤ng ch·ªçn file CE sau r√† so√°t', 'error');
        return;
      }

      const ceOriginalFile = f2CeOriginalInput.files[0];
      const ceReviewFile = f2CeReviewInput.files[0];

      // Chu·∫©n b·ªã FormData ƒë·ªÉ g·ª≠i
      const formData = new FormData();
      formData.append('ce_original', ceOriginalFile);
      formData.append('ce_review', ceReviewFile);

      // Log d·ªØ li·ªáu g·ª≠i ƒëi
      console.log('[Form 2 Declaration] Sending data:', {
        ce_original_file: ceOriginalFile?.name || 'N/A',
        ce_review_file: ceReviewFile?.name || 'N/A',
        ce_original_size: ceOriginalFile?.size || 0,
        ce_review_size: ceReviewFile?.size || 0
      });

      // Disable button v√† hi·ªÉn th·ªã loading
      const submitBtn = document.getElementById('modal-f2-declaration-submit');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang g·ª≠i...';
      }

      const resultDiv = document.getElementById('f2-declaration-result');
      const resultContent = document.getElementById('f2-declaration-result-content');

      try {
        // G·ª≠i d·ªØ li·ªáu l√™n webhook cho Form 2
        const serverUrl = 'https://iatzhxxuk.tino.page/webhook/2b3f8c7b-8485-4c42-a46f-fb4a6019bf6d';
        
        console.log('[Form 2 Declaration] Sending to:', serverUrl);
        
        const response = await fetch(serverUrl, {
          method: 'POST',
          body: formData,
        });

        console.log('[Form 2 Declaration] Response status:', response.status, response.statusText);

        // ƒê·ªçc response text
        let responseText = '';
        try {
          responseText = await response.text();
          console.log('[Form 2 Declaration] Response text:', responseText);
        } catch (textError) {
          console.error('[Form 2 Declaration] Error reading response text:', textError);
          responseText = '';
        }

        // Parse JSON n·∫øu c√≥ th·ªÉ
        let result = null;
        if (responseText) {
          try {
            result = JSON.parse(responseText);
            console.log('[Form 2 Declaration] Parsed JSON:', result);
          } catch (parseError) {
            result = {
              success: response.ok,
              status: response.status,
              statusText: response.statusText,
              body: responseText,
              message: responseText || 'Kh√¥ng c√≥ n·ªôi dung response'
            };
          }
        } else {
          result = {
            success: response.ok,
            status: response.status,
            statusText: response.statusText,
            message: response.ok ? 'G·ª≠i th√†nh c√¥ng (kh√¥ng c√≥ response body)' : `HTTP ${response.status}: ${response.statusText}`
          };
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        if (resultDiv && resultContent) {
          resultDiv.classList.remove('hidden');
          resultContent.innerHTML = `
            <pre class="bg-white p-4 rounded border border-gray-300 text-xs overflow-auto max-h-60 whitespace-pre-wrap">${escapeHtml(JSON.stringify(result, null, 2))}</pre>
          `;
        }
        
        if (response.ok) {
          showToast('ƒê√£ g·ª≠i d·ªØ li·ªáu th√†nh c√¥ng');
        } else {
          showToast(`G·ª≠i kh√¥ng th√†nh c√¥ng: HTTP ${response.status}`, 'error');
        }
      } catch (error) {
        console.error('[Form 2 Declaration] Error submitting:', error);
        if (resultDiv && resultContent) {
          resultDiv.classList.remove('hidden');
          resultContent.innerHTML = `
            <div class="text-red-600 p-4 rounded border border-red-300 bg-red-50">
              <p class="font-semibold">L·ªói:</p>
              <p>${escapeHtml(error.message)}</p>
            </div>
          `;
        }
        showToast('L·ªói khi g·ª≠i d·ªØ li·ªáu: ' + error.message, 'error');
      } finally {
        // Enable button l·∫°i
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'G·ª≠i l√™n server';
        }
      }
    }

    // ===== FORM 3 - QU·∫¢N L√ù D·ª∞ √ÅN =====
    
    // Bi·∫øn l∆∞u tr·ªØ
    let F3_EXCEL_FILE = null;
    let F3_ALL_DATA = []; // L∆∞u d·ªØ li·ªáu hierarchical ƒë√£ transform (Epic -> Story -> Subtask)
    let F3_FILTERED_DATA = []; // L∆∞u d·ªØ li·ªáu sau khi filter/search
    
    /**
     * LOGIC NH·∫¨N V√Ä HI·ªÇN TH·ªä D·ªÆ LI·ªÜU FORM 3 - QU·∫¢N L√ù D·ª∞ √ÅN
     * 
     * 1. NGU·ªíN D·ªÆ LI·ªÜU:
     *    - Webhook URL: https://iatzhxxuk.tino.page/webhook/form3quanlyduannhomSPM
     *    - Method: GET request
     *    - Format response: JSON array ho·∫∑c object ch·ª©a array (data/results/items)
     * 
     * 2. C·∫§U TR√öC D·ªÆ LI·ªÜU ƒê·∫¶U V√ÄO (Flat Array):
     *    M·ªói record c√≥ c√°c tr∆∞·ªùng:
     *    - level: 'epic' | 'story' | 'subtask' (x√°c ƒë·ªãnh c·∫•p ƒë·ªô)
     *    - epic: T√™n Epic (text)
     *    - story: T√™n Story (text)
     *    - subtask: T√™n Subtask (text)
     *    - assignee: Ng∆∞·ªùi th·ª±c hi·ªán
     *    - status: Tr·∫°ng th√°i (ho√†n th√†nh, ƒëang tri·ªÉn khai, ch∆∞a tri·ªÉn khai, h·ªßy t√°c v·ª•, cancelled)
     *    - start_date, due_date, finish_date: C√°c ng√†y
     *    - jira_key, jira_link: Th√¥ng tin Jira
     *    - note: Ghi ch√∫
     *    - work_group, work_type, task_code: Th√¥ng tin b·ªï sung
     *    - is_canceled: Tr·∫°ng th√°i h·ªßy
     * 
     * 3. TRANSFORM D·ªÆ LI·ªÜU (transformF3FlatToHierarchical):
     *    B∆∞·ªõc 1: T·∫°o Epic v√† Story t·ª´ records c√≥ level='epic' v√† level='story'
     *            - S·ª≠ d·ª•ng h√†m normalizeKey() ƒë·ªÉ chu·∫©n h√≥a text (b·ªè d·∫•u, k√Ω t·ª± ƒë·∫∑c bi·ªát)
     *            - Match Epic/Story b·∫±ng text ƒë√£ normalize, KH√îNG d√πng epic_key/story_key
     *    
     *    B∆∞·ªõc 2: G·∫Øn Story v√†o Epic
     *            - Match Story v·ªõi Epic b·∫±ng epic text ƒë√£ normalize
     *            - M·ªói Epic c√≥ m·∫£ng stories[]
     *    
     *    B∆∞·ªõc 3: X·ª≠ l√Ω Subtask
     *            - L·ªçc t·∫•t c·∫£ records c√≥ level='subtask'
     *            - Match Subtask v·ªõi Story b·∫±ng story text ƒë√£ normalize
     *            - N·∫øu kh√¥ng t√¨m th·∫•y Story, t·∫°o Story ·∫£o "Kh√¥ng c√≥ Story"
     *            - N·∫øu kh√¥ng t√¨m th·∫•y Epic, t·∫°o Epic m·ªõi t·ª´ Subtask
     *            - M·ªói Story c√≥ m·∫£ng subtasks[]
     *    
     *    B∆∞·ªõc 4: X·ª≠ l√Ω Subtask pending (kh√¥ng match ƒë∆∞·ª£c Epic/Story)
     *            - T·∫°o Epic m·ªõi n·∫øu c·∫ßn
     *    
     *    B∆∞·ªõc 5: S·∫Øp x·∫øp
     *            - Stories s·∫Øp x·∫øp theo storyKey
     *            - Subtasks s·∫Øp x·∫øp theo taskCode
     *            - Epics s·∫Øp x·∫øp theo epicKey
     * 
     * 4. C·∫§U TR√öC D·ªÆ LI·ªÜU SAU TRANSFORM (Hierarchical):
     *    [
     *      {
     *        epics: [
     *          {
     *            epic: "T√™n Epic",
     *            epicKey: "normalized-key",
     *            assignee: "...",
     *            status: "...",
     *            startDate: "...",
     *            dueDate: "...",
     *            finishDate: "...",
     *            jiraKey: "...",
     *            jiraLink: "...",
     *            note: "...",
     *            expanded: true, // M·∫∑c ƒë·ªãnh expanded
     *            stories: [
     *              {
     *                story: "T√™n Story",
     *                storyKey: "normalized-key",
     *                expanded: true, // M·∫∑c ƒë·ªãnh expanded
     *                subtasks: [
     *                  {
     *                    subtask: "T√™n Subtask",
     *                    assignee: "...",
     *                    status: "...",
     *                    ...
     *                  }
     *                ]
     *              }
     *            ]
     *          }
     *        ]
     *      }
     *    ]
     * 
     * 5. FILTER V√Ä SEARCH (filterF3Data):
     *    - Search: T√¨m ki·∫øm trong epic, story, subtask, assignee, jiraKey, note
     *    - Status Filter: L·ªçc theo tr·∫°ng th√°i (ho√†n th√†nh, ƒëang tri·ªÉn khai, ch∆∞a tri·ªÉn khai, h·ªßy)
     *    - Assignee Filter: L·ªçc theo ng∆∞·ªùi th·ª±c hi·ªán
     *    - Level Filter: 
     *        + "all": Hi·ªÉn th·ªã t·∫•t c·∫£ theo tr·∫°ng th√°i expand/collapse
     *        + "story": Ch·ªâ hi·ªÉn th·ªã Story v√† Subtask (·∫©n Epic)
     *        + "subtask": Ch·ªâ hi·ªÉn th·ªã Subtask (·∫©n Epic v√† Story)
     *    
     *    Logic filter: Deep filter trong hierarchical structure
     *    - N·∫øu Epic match filter ‚Üí hi·ªÉn th·ªã Epic v√† t·∫•t c·∫£ Story/Subtask b√™n trong
     *    - N·∫øu Story match filter ‚Üí hi·ªÉn th·ªã Story v√† Subtask, gi·ªØ Epic cha
     *    - N·∫øu Subtask match filter ‚Üí hi·ªÉn th·ªã Subtask, gi·ªØ Epic v√† Story cha
     * 
     * 6. RENDER (renderF3Table):
     *    - Render Epic row v·ªõi icon expand/collapse
     *    - N·∫øu Epic expanded ‚Üí render Story rows
     *    - N·∫øu Story expanded ‚Üí render Subtask rows
     *    - M·∫∑c ƒë·ªãnh: Epic v√† Story ƒë·ªÅu expanded (expanded: true)
     *    - S·ª≠ d·ª•ng grid system (grid-cols-12) ƒë·ªÉ hi·ªÉn th·ªã
     *    - Tree connector visual ƒë·ªÉ th·ªÉ hi·ªán hierarchy
     * 
     * 7. EXPAND/COLLAPSE:
     *    - Click v√†o icon expand/collapse c·ªßa Epic ‚Üí toggle Story rows
     *    - Click v√†o icon expand/collapse c·ªßa Story ‚Üí toggle Subtask rows
     *    - State ƒë∆∞·ª£c l∆∞u trong DOM (class rotate-[-90deg] cho icon)
     * 
     * 8. C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU:
     *    - Khi khai b√°o thay ƒë·ªïi (handleF3DeclarationSubmit): C·∫≠p nh·∫≠t Subtask trong F3_ALL_DATA
     *    - Khi th√™m Story (handleF3AddStorySubmit): Th√™m Story m·ªõi v√†o Epic
     *    - Khi th√™m Subtask (handleF3AddSubtaskSubmit): Th√™m Subtask m·ªõi v√†o Story
     *    - Sau m·ªói c·∫≠p nh·∫≠t ‚Üí g·ªçi l·∫°i renderF3Table() ƒë·ªÉ refresh UI
     */

    // H√†m format ng√†y
    function formatF3Date(dateString) {
      if (!dateString || dateString === '' || dateString === 'Invalid Date' || dateString.trim() === '') return '-';
      
      // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a
      const cleaned = String(dateString).trim();
      
      try {
        // H·ªó tr·ª£ nhi·ªÅu ƒë·ªãnh d·∫°ng ng√†y
        let date;
        
        // ƒê·ªãnh d·∫°ng yyyy-mm-dd HH:mm ho·∫∑c yyyy-mm-dd HH:mm:ss
        if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}(:\d{2})?/.test(cleaned)) {
          // Parse ƒë·ªãnh d·∫°ng c√≥ gi·ªù
          date = new Date(cleaned.replace(' ', 'T'));
        } 
        // ƒê·ªãnh d·∫°ng yyyy-mm-dd
        else if (/^\d{4}-\d{2}-\d{2}$/.test(cleaned)) {
          date = new Date(cleaned + 'T00:00:00');
        }
        // C√°c ƒë·ªãnh d·∫°ng kh√°c
        else {
          date = new Date(cleaned);
        }
        
        // Ki·ªÉm tra xem date c√≥ h·ª£p l·ªá kh√¥ng
        if (isNaN(date.getTime())) {
          return '-';
        }
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return '-';
      }
    }

    // H√†m format file size
    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // H√†m l·∫•y badge tr·∫°ng th√°i - kh·ªõp v·ªõi d·ªØ li·ªáu JSON
    function getF3StatusBadge(status) {
      if (!status) return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">-</span>';
      const statusStr = String(status).trim();
      const statusLower = statusStr.toLowerCase();
      
      // Kh·ªõp ch√≠nh x√°c v·ªõi c√°c gi√° tr·ªã trong JSON
      if (statusLower === 'ho√†n th√†nh' || statusLower.includes('ho√†n th√†nh')) {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-100">Ho√†n th√†nh</span>';
      } else if (statusLower === 'ƒëang tri·ªÉn khai' || statusLower.includes('ƒëang tri·ªÉn khai')) {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">ƒêang l√†m</span>';
      } else if (statusLower === 'ch∆∞a tri·ªÉn khai' || statusLower.includes('ch∆∞a tri·ªÉn khai')) {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">Ch∆∞a tri·ªÉn khai</span>';
      } else if (statusLower.includes('h·ªßy') || statusLower.includes('cancel') || statusLower.includes('cancelled')) {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-100">ƒê√£ h·ªßy</span>';
      }
      // Fallback: hi·ªÉn th·ªã gi√° tr·ªã g·ªëc n·∫øu kh√¥ng kh·ªõp
      return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">${escapeHtml(statusStr)}</span>`;
    }

    // H√†m render b·∫£ng d·ªØ li·ªáu hierarchical (Epic -> Story -> Subtask)
    function renderF3Table(data) {
      const tbody = document.getElementById('f3-table-body');
      if (!tbody) return;
      
      if (!data || !Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = `
          <div class="px-6 py-8 text-center text-[#6b6189]">
            <div class="flex flex-col items-center gap-2">
              <span class="material-symbols-outlined text-4xl text-gray-300">table_chart</span>
              <p>Kh√¥ng c√≥ d·ªØ li·ªáu</p>
            </div>
          </div>
        `;
        return;
      }
      
      let html = '';
      let epicIndex = 0;
      
      data.forEach((item) => {
        if (!item.epics || !Array.isArray(item.epics)) return;
        
        item.epics.forEach((epic) => {
          const epicId = `epic-${epicIndex}`;
          const isExpanded = epic.expanded !== false; // M·∫∑c ƒë·ªãnh expanded
          
          // Epic row
          html += `
            <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-blue-50 font-semibold hover:bg-opacity-80 transition-colors border-b border-[#f1f0f4] f3-epic-row" data-epic-id="${epicId}" data-level="epic">
              <div class="col-span-3 flex items-center gap-2">
                <button class="p-1 hover:bg-blue-100 rounded transition-colors f3-epic-expand" data-epic-id="${epicId}">
                  <span class="material-icons text-sm text-gray-600 cursor-pointer ${isExpanded ? '' : 'rotate-[-90deg]'}">expand_more</span>
                </button>
                <span class="text-blue-700 text-sm f3-epic-name cursor-pointer hover:text-blue-800 break-words">${escapeHtml(epic.epic || '-')}</span>
              </div>
              <div class="col-span-1 flex items-center">
                <button type="button" class="f3-add-story-btn px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors" data-epic-name="${escapeHtml(epic.epic || '')}" title="Th√™m Story">Th√™m Story</button>
              </div>
              <div class="col-span-2 flex items-center text-sm text-gray-700">${escapeHtml(epic.assignee || '-')}</div>
              <div class="col-span-1 flex items-center">${getF3StatusBadge(epic.status)}</div>
              <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(epic.startDate === 'Invalid Date' ? null : epic.startDate)}</div>
              <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(epic.dueDate === 'Invalid Date' ? null : epic.dueDate)}</div>
              <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(epic.finishDate === 'Invalid Date' ? null : epic.finishDate)}</div>
              <div class="col-span-1 flex items-center text-sm text-gray-700">
                ${epic.jiraKey ? (epic.jiraLink ? `<a href="${escapeHtml(epic.jiraLink)}" target="_blank" class="text-xs font-medium text-primary-blue hover:underline">${escapeHtml(epic.jiraKey)}</a>` : `<span class="text-xs font-medium text-gray-700">${escapeHtml(epic.jiraKey)}</span>`) : '-'}
              </div>
              <div class="col-span-1 flex items-center text-sm text-gray-600">${escapeHtml((epic.note || '').substring(0, 30))}${(epic.note || '').length > 30 ? '...' : ''}</div>
            </div>
          `;

          // Story rows (ch·ªâ hi·ªÉn th·ªã n·∫øu epic expanded)
          if (isExpanded && epic.stories && Array.isArray(epic.stories)) {
            epic.stories.forEach((story, storyIdx) => {
              const storyId = `${epicId}-story-${story.storyKey || Math.random()}`;
              const storyExpanded = story.expanded !== false;
              
              html += `
                <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-purple-50 hover:bg-opacity-80 transition-colors border-b border-[#f1f0f4] f3-story-row" data-epic-id="${epicId}" data-story-id="${storyId}" data-story-index="${storyIdx}" data-level="story">
                  <div class="col-span-3 flex items-center gap-2" style="padding-left: 24px;">
                    <button class="p-1 hover:bg-purple-100 rounded transition-colors f3-story-expand" data-story-id="${storyId}">
                      <span class="material-icons text-sm text-gray-600 cursor-pointer ${storyExpanded ? '' : 'rotate-[-90deg]'}">expand_more</span>
                    </button>
                    <span class="text-purple-700 text-sm f3-story-name cursor-pointer hover:text-purple-800 break-words">${escapeHtml(story.story || '-')}</span>
                  </div>
                  <div class="col-span-1 flex items-center">
                    <button type="button" class="f3-add-subtask-btn px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" data-epic-name="${escapeHtml(epic.epic || '')}" data-story-name="${escapeHtml(story.story || '')}" title="Th√™m Sub-task">Th√™m Subtask</button>
                  </div>
                  <div class="col-span-2 flex items-center text-sm text-gray-700">${escapeHtml(story.assignee || '-')}</div>
                  <div class="col-span-1 flex items-center">${getF3StatusBadge(story.status)}</div>
                  <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(story.startDate === 'Invalid Date' ? null : story.startDate)}</div>
                  <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(story.dueDate === 'Invalid Date' ? null : story.dueDate)}</div>
                  <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(story.finishDate === 'Invalid Date' ? null : story.finishDate)}</div>
                  <div class="col-span-1 flex items-center text-sm text-gray-700">
                    ${story.jiraKey ? (story.jiraLink ? `<a href="${escapeHtml(story.jiraLink)}" target="_blank" class="text-xs font-medium text-primary-blue hover:underline">${escapeHtml(story.jiraKey)}</a>` : `<span class="text-xs font-medium text-gray-700">${escapeHtml(story.jiraKey)}</span>`) : '-'}
                  </div>
                  <div class="col-span-1 flex items-center text-sm text-gray-600">${escapeHtml((story.note || '').substring(0, 30))}${(story.note || '').length > 30 ? '...' : ''}</div>
                </div>
              `;

              // Subtask rows (ch·ªâ hi·ªÉn th·ªã n·∫øu story expanded)
              if (storyExpanded && story.subtasks && Array.isArray(story.subtasks)) {
                story.subtasks.forEach((subtask) => {
                  html += `
                    <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-white hover:bg-opacity-80 transition-colors border-b border-[#f1f0f4] f3-subtask-row" data-epic-id="${epicId}" data-story-id="${storyId}" data-level="subtask">
                      <div class="col-span-3 flex items-center gap-2" style="padding-left: 48px;">
                        <span class="text-gray-900 text-sm break-words">${escapeHtml(subtask.subtask || subtask.workGroup || subtask.taskCode || '-')}</span>
                      </div>
                      <div class="col-span-1 flex items-center">
                        ${(function() {
                          const statusLower = (subtask.status || '').toLowerCase().trim();
                          const isCompleted = statusLower === 'ho√†n th√†nh' || statusLower.includes('ho√†n th√†nh') || statusLower === 'done' || statusLower.includes('done') || statusLower === 'completed' || statusLower.includes('completed');
                          if (isCompleted) {
                            return `<button type="button" class="f3-declaration-btn px-2 py-1 text-xs bg-gray-300 text-gray-500 cursor-not-allowed opacity-60 pointer-events-none rounded" disabled title="Kh√¥ng th·ªÉ khai b√°o khi ƒë√£ ho√†n th√†nh">ƒê√£ ho√†n th√†nh</button>`;
                          } else {
                            return `<button type="button" class="f3-declaration-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors" data-subtask-id="${subtask.id || subtask.taskCode}" data-epic="${escapeHtml(epic.epic || '')}" data-story="${escapeHtml(story.story || '')}" data-subtask="${escapeHtml(subtask.subtask || subtask.workGroup || subtask.taskCode || '')}" title="Khai b√°o thay ƒë·ªïi">Thay ƒë·ªïi</button>`;
                          }
                        })()}
                      </div>
                      <div class="col-span-2 flex items-center text-sm text-gray-700">${escapeHtml(subtask.assignee || '-')}</div>
                      <div class="col-span-1 flex items-center">${getF3StatusBadge(subtask.status)}</div>
                      <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(subtask.startDate === 'Invalid Date' ? null : subtask.startDate)}</div>
                      <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(subtask.dueDate === 'Invalid Date' ? null : subtask.dueDate)}</div>
                      <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(subtask.finishDate === 'Invalid Date' ? null : subtask.finishDate)}</div>
                        <div class="col-span-1 flex items-center text-sm text-gray-700">
                          ${subtask.jiraKey ? (subtask.jiraLink ? `<a href="${escapeHtml(subtask.jiraLink)}" target="_blank" class="text-xs font-medium text-primary-blue hover:underline">${escapeHtml(subtask.jiraKey)}</a>` : `<span class="text-xs font-medium text-gray-700">${escapeHtml(subtask.jiraKey)}</span>`) : '-'}
                        </div>
                      <div class="col-span-1 flex items-center text-sm text-gray-600">${escapeHtml((subtask.note || '').substring(0, 30))}${(subtask.note || '').length > 30 ? '...' : ''}</div>
                    </div>
                  `;
                });
              }
            });
          }
          
          epicIndex++;
        });
      });
      
      tbody.innerHTML = html;
      
      // G·∫Øn event listeners cho expand/collapse
      setupF3ExpandListeners();
      
      // √Åp d·ª•ng filter c·∫•p hi·ªÉn th·ªã
      applyF3LevelFilter();
    }

    // H√†m √°p d·ª•ng filter c·∫•p hi·ªÉn th·ªã
    function applyF3LevelFilter() {
      const levelFilter = document.getElementById('f3-filter-level');
      if (!levelFilter) return;
      
      const levelValue = levelFilter.value;
      const tbody = document.getElementById('f3-table-body');
      if (!tbody) return;

      // L·∫•y t·∫•t c·∫£ c√°c row
      const epicRows = tbody.querySelectorAll('.f3-epic-row');
      const storyRows = tbody.querySelectorAll('.f3-story-row');
      const subtaskRows = tbody.querySelectorAll('.f3-subtask-row');

      if (levelValue === 'story') {
        // Ch·ªâ hi·ªÉn th·ªã Story v√† Subtask, ·∫©n Epic
        // T·ª± ƒë·ªông expand t·∫•t c·∫£ epic v√† story ƒë·ªÉ hi·ªÉn th·ªã
        epicRows.forEach(epicRow => {
          epicRow.classList.add('hidden'); // ·∫®n epic row
          const epicId = epicRow.getAttribute('data-epic-id');
          const expandBtn = epicRow.querySelector('.f3-epic-expand');
          if (expandBtn) {
            const icon = expandBtn.querySelector('.material-icons');
            if (icon) icon.classList.remove('rotate-[-90deg]'); // Expand epic
          }
          // Hi·ªÉn th·ªã t·∫•t c·∫£ story rows c·ªßa epic n√†y
          tbody.querySelectorAll(`div[data-epic-id="${epicId}"].f3-story-row`).forEach(storyRow => {
            storyRow.classList.remove('hidden');
            const storyId = storyRow.getAttribute('data-story-id');
            const storyExpandBtn = storyRow.querySelector('.f3-story-expand');
            if (storyExpandBtn) {
              const icon = storyExpandBtn.querySelector('.material-icons');
              if (icon) icon.classList.remove('rotate-[-90deg]'); // Expand story
            }
            // Hi·ªÉn th·ªã t·∫•t c·∫£ subtask rows c·ªßa story n√†y
            tbody.querySelectorAll(`div[data-story-id="${storyId}"].f3-subtask-row`).forEach(subtaskRow => {
              subtaskRow.classList.remove('hidden');
            });
          });
        });
      } else if (levelValue === 'subtask') {
        // Ch·ªâ hi·ªÉn th·ªã Subtask, ·∫©n Epic v√† Story
        epicRows.forEach(row => {
          row.classList.add('hidden');
        });
        storyRows.forEach(row => {
          row.classList.add('hidden');
        });
        // Hi·ªÉn th·ªã t·∫•t c·∫£ subtask rows
        subtaskRows.forEach(row => {
          row.classList.remove('hidden');
        });
      } else {
        // Hi·ªÉn th·ªã t·∫•t c·∫£ (all) - ƒë·∫£m b·∫£o t·∫•t c·∫£ rows ƒë·ªÅu hi·ªÉn th·ªã theo tr·∫°ng th√°i expand/collapse
        epicRows.forEach(epicRow => {
          epicRow.classList.remove('hidden'); // Hi·ªÉn th·ªã epic row
          const epicId = epicRow.getAttribute('data-epic-id');
          const expandBtn = epicRow.querySelector('.f3-epic-expand');
          const isEpicExpanded = expandBtn && !expandBtn.querySelector('.material-icons')?.classList.contains('rotate-[-90deg]');
          
          // Hi·ªÉn th·ªã/·∫©n story rows d·ª±a tr√™n tr·∫°ng th√°i expand c·ªßa epic
          tbody.querySelectorAll(`div[data-epic-id="${epicId}"].f3-story-row`).forEach(storyRow => {
            if (isEpicExpanded) {
              storyRow.classList.remove('hidden');
              const storyId = storyRow.getAttribute('data-story-id');
              const storyExpandBtn = storyRow.querySelector('.f3-story-expand');
              const isStoryExpanded = storyExpandBtn && !storyExpandBtn.querySelector('.material-icons')?.classList.contains('rotate-[-90deg]');
              
              // Hi·ªÉn th·ªã/·∫©n subtask rows d·ª±a tr√™n tr·∫°ng th√°i expand c·ªßa story
              tbody.querySelectorAll(`div[data-story-id="${storyId}"].f3-subtask-row`).forEach(subtaskRow => {
                if (isStoryExpanded) {
                  subtaskRow.classList.remove('hidden');
                } else {
                  subtaskRow.classList.add('hidden');
                }
              });
            } else {
              storyRow.classList.add('hidden');
              // ·∫®n t·∫•t c·∫£ subtask c·ªßa story n√†y
              const storyId = storyRow.getAttribute('data-story-id');
              tbody.querySelectorAll(`div[data-story-id="${storyId}"].f3-subtask-row`).forEach(subtaskRow => {
                subtaskRow.classList.add('hidden');
              });
            }
          });
        });
      }
    }

    // H√†m setup event listeners cho expand/collapse
    function setupF3ExpandListeners() {
      // Epic expand/collapse
      document.querySelectorAll('.f3-epic-expand').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const epicId = btn.getAttribute('data-epic-id');
          const epicRow = btn.closest('.f3-epic-row');
          const icon = btn.querySelector('.material-icons');
          const isExpanded = !icon || !icon.classList.contains('rotate-[-90deg]');
          
          // Toggle icon
          if (icon) {
            if (isExpanded) {
              icon.classList.add('rotate-[-90deg]');
            } else {
              icon.classList.remove('rotate-[-90deg]');
            }
          }
          
          // Toggle story rows
          document.querySelectorAll(`div[data-epic-id="${epicId}"].f3-story-row`).forEach(row => {
            if (isExpanded) {
              row.classList.add('hidden');
            } else {
              row.classList.remove('hidden');
            }
          });
          
          // √Åp d·ª•ng l·∫°i filter level sau khi expand/collapse
          applyF3LevelFilter();
        });
      });

      // Story expand/collapse
      document.querySelectorAll('.f3-story-expand').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const storyId = btn.getAttribute('data-story-id');
          const icon = btn.querySelector('.material-icons');
          const isExpanded = !icon || !icon.classList.contains('rotate-[-90deg]');
          
          // Toggle icon
          if (icon) {
            if (isExpanded) {
              icon.classList.add('rotate-[-90deg]');
            } else {
              icon.classList.remove('rotate-[-90deg]');
            }
          }
          
          // Toggle subtask rows
          document.querySelectorAll(`div[data-story-id="${storyId}"].f3-subtask-row`).forEach(row => {
            if (isExpanded) {
              row.classList.add('hidden');
            } else {
              row.classList.remove('hidden');
            }
          });
          
          // √Åp d·ª•ng l·∫°i filter level sau khi expand/collapse
          applyF3LevelFilter();
        });
      });

      // Add Story button
      document.querySelectorAll('.f3-add-story-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const epicName = btn.getAttribute('data-epic-name');
          openF3AddStoryModal(epicName);
        });
      });

      // Add Sub-task button
      document.querySelectorAll('.f3-add-subtask-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const epicName = btn.getAttribute('data-epic-name');
          const storyName = btn.getAttribute('data-story-name');
          openF3AddSubtaskModal(epicName, storyName);
        });
      });
    }

    // H√†m populate assignee filter dropdown
    function populateF3AssigneeFilter(flatData) {
      const assigneeFilter = document.getElementById('f3-filter-assignee');
      if (!assigneeFilter) return;

      const assignees = new Set();
      flatData.forEach(record => {
        if (record.assignee && record.assignee.trim()) {
          assignees.add(record.assignee.trim());
        }
      });

      const sortedAssignees = Array.from(assignees).sort();
      assigneeFilter.innerHTML = '<option value="">T·∫•t c·∫£ ng∆∞·ªùi th·ª±c hi·ªán</option>';
      sortedAssignees.forEach(assignee => {
        const option = document.createElement('option');
        option.value = assignee;
        option.textContent = assignee;
        assigneeFilter.appendChild(option);
      });
    }

    // H√†m l·ªçc d·ªØ li·ªáu (hierarchical)
    // Helper function ƒë·ªÉ ki·ªÉm tra ng√†y c√≥ thu·ªôc th√°ng ƒë∆∞·ª£c ch·ªçn kh√¥ng
    function matchesMonthFilter(dateString, monthFilter) {
      if (!monthFilter || !dateString) return true; // Kh√¥ng filter n·∫øu kh√¥ng c√≥ gi√° tr·ªã
      
      try {
        // Parse dateString - h·ªó tr·ª£ nhi·ªÅu format
        let dateToParse = dateString;
        if (dateString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}(:\d{2})?$/)) {
          dateToParse = dateString.replace(' ', 'T');
        } else if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
          dateToParse = `${dateString}T00:00:00`;
        }
        
        const date = new Date(dateToParse);
        if (isNaN(date.getTime())) return true; // N·∫øu kh√¥ng parse ƒë∆∞·ª£c, kh√¥ng filter
        
        const itemYear = date.getFullYear();
        const itemMonth = String(date.getMonth() + 1).padStart(2, '0');
        const itemMonthStr = `${itemYear}-${itemMonth}`;
        
        return itemMonthStr === monthFilter;
      } catch (e) {
        return true; // N·∫øu c√≥ l·ªói, kh√¥ng filter
      }
    }

    function filterF3Data() {
      const searchInput = document.getElementById('f3-search-input');
      const statusFilter = document.getElementById('f3-filter-status');
      const assigneeFilter = document.getElementById('f3-filter-assignee');
      const monthFilter = document.getElementById('f3-filter-month');
      
      const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
      const statusValue = statusFilter ? statusFilter.value : '';
      const assigneeValue = assigneeFilter ? assigneeFilter.value : '';
      const monthValue = monthFilter ? monthFilter.value : '';

      // Deep filter cho hierarchical data
      F3_FILTERED_DATA = F3_ALL_DATA.map(item => {
        if (!item.epics || !Array.isArray(item.epics)) return item;
        
        const filteredEpics = item.epics.map(epic => {
          // Ki·ªÉm tra epic c√≥ match kh√¥ng
          const epicMatch = (!searchTerm || 
            (epic.epic && epic.epic.toLowerCase().includes(searchTerm)) ||
            (epic.workGroup && epic.workGroup.toLowerCase().includes(searchTerm)) ||
            (epic.assignee && epic.assignee.toLowerCase().includes(searchTerm)) ||
            (epic.note && epic.note.toLowerCase().includes(searchTerm))
          ) && (!statusValue || matchStatus(epic.status, statusValue))
          && (!assigneeValue || (epic.assignee && epic.assignee.trim() === assigneeValue))
          && (!monthValue || matchesMonthFilter(epic.startDate, monthValue));
          
          // Filter stories
          const filteredStories = (epic.stories || []).map(story => {
            const storyMatch = (!searchTerm || 
              (story.story && story.story.toLowerCase().includes(searchTerm))
            ) && (!statusValue || (story.storyTask && matchStatus(story.storyTask.status, statusValue)))
            && (!assigneeValue || (story.assignee && story.assignee.trim() === assigneeValue))
            && (!monthValue || matchesMonthFilter(story.startDate, monthValue));
            
            // Filter subtasks
            const filteredSubtasks = (story.subtasks || []).filter(subtask => {
              const subtaskMatch = (!searchTerm || 
                (subtask.subtask && subtask.subtask.toLowerCase().includes(searchTerm)) ||
                (subtask.workGroup && subtask.workGroup.toLowerCase().includes(searchTerm)) ||
                (subtask.assignee && subtask.assignee.toLowerCase().includes(searchTerm)) ||
                (subtask.note && subtask.note.toLowerCase().includes(searchTerm))
              ) && (!statusValue || matchStatus(subtask.status, statusValue))
              && (!assigneeValue || (subtask.assignee && subtask.assignee.trim() === assigneeValue))
              && (!monthValue || matchesMonthFilter(subtask.startDate, monthValue));
              
              return subtaskMatch;
            });
            
            if (storyMatch || filteredSubtasks.length > 0) {
              return { ...story, subtasks: filteredSubtasks };
            }
            return null;
          }).filter(s => s !== null);
          
          if (epicMatch || filteredStories.length > 0) {
            return { ...epic, stories: filteredStories };
          }
          return null;
        }).filter(e => e !== null);
        
        return { ...item, epics: filteredEpics };
      });

      renderF3Table(F3_FILTERED_DATA);
    }

    // Helper function ƒë·ªÉ match status - kh·ªõp v·ªõi d·ªØ li·ªáu JSON
    function matchStatus(status, filterValue) {
      if (!status) return false;
      const statusStr = String(status).trim();
      const statusLower = statusStr.toLowerCase();
      const filterLower = String(filterValue).toLowerCase().trim();
      
      // Kh·ªõp ch√≠nh x√°c v·ªõi c√°c gi√° tr·ªã trong JSON
      if (filterLower === 'ho√†n th√†nh') {
        // Match v·ªõi "ho√†n th√†nh", "ho√†n th√†nh ƒë√∫ng h·∫°n", "ho√†n th√†nh ch·∫≠m", v.v.
        return statusLower.includes('ho√†n th√†nh');
      } else if (filterLower === 'ho√†n th√†nh ƒë√∫ng h·∫°n') {
        return statusLower === 'ho√†n th√†nh ƒë√∫ng h·∫°n' || statusLower.includes('ho√†n th√†nh ƒë√∫ng h·∫°n');
      } else if (filterLower === 'ƒëang tri·ªÉn khai') {
        return statusLower === 'ƒëang tri·ªÉn khai' || statusLower.includes('ƒëang tri·ªÉn khai');
      } else if (filterLower === 'ch∆∞a tri·ªÉn khai') {
        return statusLower === 'ch∆∞a tri·ªÉn khai' || statusLower.includes('ch∆∞a tri·ªÉn khai');
      } else if (filterLower === 'h·ªßy t√°c v·ª•') {
        return statusLower === 'h·ªßy t√°c v·ª•' || statusLower.includes('h·ªßy t√°c v·ª•');
      } else if (filterLower === 'cancelled' || filterLower === 'ƒë√£ h·ªßy') {
        return statusLower.includes('h·ªßy') || statusLower.includes('cancel') || statusLower.includes('cancelled');
      }
      return true;
    }

    // H√†m normalize key ƒë·ªÉ match ch√≠nh x√°c
    function normalizeKey(text) {
      if (!text) return '';
      return String(text).toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // B·ªè d·∫•u ti·∫øng Vi·ªát
        .replace(/[^\w\s]/g, '') // B·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát (bao g·ªìm d·∫•u ch·∫•m)
        .replace(/\s+/g, ' ') // Chu·∫©n h√≥a kho·∫£ng tr·∫Øng
        .trim()
        .replace(/\s+$/, ''); // B·ªè kho·∫£ng tr·∫Øng cu·ªëi
    }

    // H√†m transform d·ªØ li·ªáu t·ª´ flat array sang hierarchical structure
    // KH√îNG d√πng epic_key v√† story_key, ch·ªâ match b·∫±ng text
    function transformF3FlatToHierarchical(flatData) {
      if (!Array.isArray(flatData) || flatData.length === 0) {
        return [];
      }

      const epicsMap = {}; // Key: normalized epic text
      const storiesMap = {}; // Key: normalized story text
      const subtasksPending = []; // L∆∞u subtasks ch∆∞a ƒë∆∞·ª£c g·∫Øn v√†o story/epic

      // B∆∞·ªõc 1: T·∫°o epics v√† stories tr∆∞·ªõc
      flatData.forEach(record => {
        const level = record.level || '';
        const epic = (record.epic || '').trim();
        const story = (record.story || '').trim();
        
        // Ch·ªâ d√πng text ƒë·ªÉ t·∫°o key, KH√îNG d√πng epic_key hay story_key
        const epicKey = normalizeKey(epic);
        const storyKey = normalizeKey(story) || `story-${record.Id || Math.random()}`;

        if (level === 'epic') {
          if (epicKey && !epicsMap[epicKey]) {
            epicsMap[epicKey] = {
              epic: epic,
              epicKey: epicKey,
              workGroup: record.work_group || '',
              workType: record.work_type || '',
              assignee: record.assignee || '',
              startDate: record.start_date || '',
              dueDate: record.due_date || '',
              finishDate: record.finish_date || '',
              status: record.status || '',
              isCanceled: record.is_canceled === 'true' || record.is_canceled === true,
              note: record.note || '',
              jiraLink: record.jira_link || '',
              jiraKey: record.jira_key || '',
              taskCode: record.task_code || '',
              stories: [],
              expanded: true
            };
          }
        } else if (level === 'story') {
          if (storyKey) {
            // Ki·ªÉm tra xem story ƒë√£ t·ªìn t·∫°i ch∆∞a b·∫±ng c√°ch so s√°nh normalized text
            const existingStory = Object.values(storiesMap).find(s => {
              const sStoryText = normalizeKey(s.story);
              const currentStoryText = normalizeKey(story);
              return sStoryText === currentStoryText && s.epicKey === normalizeKey(epic);
            });
            
            if (!existingStory) {
              // N·∫øu ch∆∞a t·ªìn t·∫°i, t·∫°o story m·ªõi
              // N·∫øu storyKey ƒë√£ t·ªìn t·∫°i nh∆∞ng story text kh√°c, t·∫°o key m·ªõi
              let finalStoryKey = storyKey;
              if (storiesMap[storyKey]) {
                finalStoryKey = `${storyKey}-${record.Id || Date.now()}`;
              }
              
              storiesMap[finalStoryKey] = {
                story: story,
                storyKey: finalStoryKey,
                epic: epic,
                epicKey: normalizeKey(epic), // Match b·∫±ng epic text
                workGroup: record.work_group || '',
                workType: record.work_type || '',
                assignee: record.assignee || '',
                startDate: record.start_date || '',
                dueDate: record.due_date || '',
                finishDate: record.finish_date || '',
                status: record.status || '',
                isCanceled: record.is_canceled === 'true' || record.is_canceled === true,
                note: record.note || '',
                jiraLink: record.jira_link || '',
                jiraKey: record.jira_key || '',
                taskCode: record.task_code || '',
                subtasks: [],
                expanded: true
              };
            }
          }
        }
      });

      // B∆∞·ªõc 2: G·∫Øn stories v√†o epics - match b·∫±ng epic text ƒë√£ normalize
      Object.values(storiesMap).forEach(story => {
        const epicKey = story.epicKey; // ƒê√£ ƒë∆∞·ª£c normalize t·ª´ epic text
        if (epicKey && epicsMap[epicKey]) {
          // Ki·ªÉm tra xem story ƒë√£ t·ªìn t·∫°i ch∆∞a
          const existingStory = epicsMap[epicKey].stories.find(s => {
            const sStoryText = normalizeKey(s.story);
            const storyText = normalizeKey(story.story);
            return sStoryText === storyText || s.storyKey === story.storyKey;
          });
          if (!existingStory) {
            epicsMap[epicKey].stories.push(story);
          }
        }
      });

      // B∆∞·ªõc 3: X·ª≠ l√Ω subtasks
      let subtaskCount = 0;
      let matchedCount = 0;
      flatData.forEach(record => {
        const level = record.level || '';
        if (level !== 'subtask') return;
        
        subtaskCount++;
        
        // Debug: Ki·ªÉm tra ID468
        if (record.Id === 468) {
          console.log(`[Form 3 Transform] Processing ID468:`, {
            epic: record.epic,
            story: record.story,
            epicKey: normalizeKey(record.epic || ''),
            storyKey: normalizeKey(record.story || ''),
            epicExists: !!epicsMap[normalizeKey(record.epic || '')]
          });
        }

        const epic = (record.epic || '').trim();
        const story = (record.story || '').trim();
        // KH√îNG d√πng epic_key v√† story_key, ch·ªâ normalize t·ª´ text
        const epicKey = normalizeKey(epic);
        const storyKey = normalizeKey(story);

        const subtask = {
          subtask: record.subtask || record.work_group || record.task_code || '',
          epic: epic,
          epicKey: epicKey,
          story: story,
          storyKey: storyKey,
          workGroup: record.work_group || '',
          workType: record.work_type || '',
          assignee: record.assignee || '',
          startDate: record.start_date || '',
          dueDate: record.due_date || '',
          finishDate: record.finish_date || '',
          status: record.status || '',
          isCanceled: record.is_canceled === 'true' || record.is_canceled === true,
          note: record.note || '',
          jiraLink: record.jira_link || '',
          jiraKey: record.jira_key || '',
          taskCode: record.task_code || '',
          id: record.Id || record.id || null,
          declarationChanged: false
        };

        // T√¨m story ph√π h·ª£p - match b·∫±ng story text ƒë√£ normalize (KH√îNG d√πng story_key)
        let foundStory = null;
        if (story && story.trim()) {
          const normalizedStoryText = normalizeKey(story);
          // T√¨m story b·∫±ng story text ƒë√£ normalize v√† c√πng epic
          // ∆Øu ti√™n match ch√≠nh x√°c, sau ƒë√≥ match partial n·∫øu c·∫ßn
          foundStory = Object.values(storiesMap).find(s => {
            const sStoryText = normalizeKey(s.story);
            const sEpicKey = s.epicKey || normalizeKey(s.epic);
            // Match ch√≠nh x√°c ho·∫∑c match partial (story trong storiesMap ch·ª©a story t·ª´ subtask ho·∫∑c ng∆∞·ª£c l·∫°i)
            const exactMatch = sStoryText === normalizedStoryText && sEpicKey === epicKey;
            const partialMatch = sEpicKey === epicKey && (
              sStoryText.includes(normalizedStoryText) || 
              normalizedStoryText.includes(sStoryText) ||
              sStoryText === storyKey
            );
            return exactMatch || partialMatch;
          });
          
          // N·∫øu kh√¥ng t√¨m th·∫•y trong storiesMap, ki·ªÉm tra trong epic ƒë√£ t·ªìn t·∫°i
          if (!foundStory && epicKey && epicsMap[epicKey]) {
            const epic = epicsMap[epicKey];
            foundStory = epic.stories.find(s => {
              const sStoryText = normalizeKey(s.story);
              const sEpicKey = s.epicKey || normalizeKey(s.epic);
              const exactMatch = sStoryText === normalizedStoryText && sEpicKey === epicKey;
              const partialMatch = sEpicKey === epicKey && (
                sStoryText.includes(normalizedStoryText) || 
                normalizedStoryText.includes(sStoryText) ||
                sStoryText === storyKey
              );
              return exactMatch || partialMatch;
            });
            // N·∫øu t√¨m th·∫•y trong epic nh∆∞ng ch∆∞a c√≥ trong storiesMap, th√™m v√†o storiesMap
            if (foundStory) {
              // ƒê·∫£m b·∫£o storyKey t·ªìn t·∫°i
              if (!foundStory.storyKey) {
                foundStory.storyKey = storyKey || normalizedStoryText || `story-${record.Id || Date.now()}`;
              }
              // ƒê·∫£m b·∫£o epicKey ƒë∆∞·ª£c set ƒë√∫ng
              if (!foundStory.epicKey) {
                foundStory.epicKey = epicKey;
              }
              if (!foundStory.epic) {
                foundStory.epic = epic.epic;
              }
              if (!storiesMap[foundStory.storyKey]) {
                storiesMap[foundStory.storyKey] = foundStory;
              }
            }
          }
        }

        if (foundStory) {
          matchedCount++;
          // Debug: Ki·ªÉm tra ID468
          if (subtask.id === 468) {
            console.log(`[Form 3 Transform] ID468 matched to story:`, {
              story: foundStory.story,
              storyKey: foundStory.storyKey,
              epicKey: foundStory.epicKey
            });
          }
          // G·∫Øn v√†o story t√¨m ƒë∆∞·ª£c
          foundStory.subtasks.push(subtask);
          // ƒê·∫£m b·∫£o story ƒë∆∞·ª£c g·∫Øn v√†o epic - match b·∫±ng epic text ƒë√£ normalize
          const foundEpicKey = foundStory.epicKey || normalizeKey(foundStory.epic);
          if (foundEpicKey) {
            // T√¨m epic ph√π h·ª£p b·∫±ng epicKey (ƒë√£ normalize t·ª´ text)
            let targetEpic = epicsMap[foundEpicKey];
            if (!targetEpic && epicKey) {
              targetEpic = epicsMap[epicKey];
            }
            if (!targetEpic) {
              // T√¨m b·∫±ng epic text ƒë√£ normalize
              const normalizedEpic = normalizeKey(epic);
              targetEpic = Object.values(epicsMap).find(e => {
                const eEpicText = normalizeKey(e.epic);
                return eEpicText === normalizedEpic || eEpicText === foundEpicKey || e.epicKey === epicKey;
              });
            }
            if (targetEpic) {
              const storyExists = targetEpic.stories.find(s => {
                const sStoryText = normalizeKey(s.story);
                const foundStoryText = normalizeKey(foundStory.story);
                return sStoryText === foundStoryText || s.storyKey === foundStory.storyKey;
              });
              if (!storyExists) {
                targetEpic.stories.push(foundStory);
              }
            }
          }
        } else if (epicKey && epicsMap[epicKey]) {
          // N·∫øu kh√¥ng t√¨m th·∫•y story, t·∫°o story ·∫£o ho·∫∑c th√™m v√†o story ƒë·∫ßu ti√™n
          const epic = epicsMap[epicKey];
          
          // ƒê·∫£m b·∫£o t·∫•t c·∫£ stories trong epic ƒë·ªÅu c√≥ trong storiesMap
          if (epic.stories && Array.isArray(epic.stories)) {
            epic.stories.forEach(s => {
              if (s && s.storyKey && !storiesMap[s.storyKey]) {
                storiesMap[s.storyKey] = s;
              } else if (s && !s.storyKey) {
                const sStoryText = normalizeKey(s.story);
                s.storyKey = sStoryText || `story-${Date.now()}-${Math.random()}`;
                storiesMap[s.storyKey] = s;
              }
            });
          }
          
          if (story && story.trim()) {
            // Ki·ªÉm tra xem story ƒë√£ t·ªìn t·∫°i trong storiesMap ch∆∞a b·∫±ng c√°ch so s√°nh normalized text v√† epicKey
            const normalizedStoryText = normalizeKey(story);
            let newStory = Object.values(storiesMap).find(s => {
              const sStoryText = normalizeKey(s.story);
              const sEpicKey = s.epicKey || normalizeKey(s.epic);
              return sStoryText === normalizedStoryText && sEpicKey === epicKey;
            });
            
            // N·∫øu kh√¥ng t√¨m th·∫•y trong storiesMap, ki·ªÉm tra trong epic
            if (!newStory) {
              newStory = epic.stories.find(s => {
                const sStoryText = normalizeKey(s.story);
                const sEpicKey = s.epicKey || normalizeKey(s.epic);
                return sStoryText === normalizedStoryText && sEpicKey === epicKey;
              });
              // N·∫øu t√¨m th·∫•y trong epic nh∆∞ng ch∆∞a c√≥ trong storiesMap, th√™m v√†o storiesMap
              if (newStory) {
                // ƒê·∫£m b·∫£o storyKey t·ªìn t·∫°i v√† th√™m v√†o storiesMap
                if (!newStory.storyKey) {
                  newStory.storyKey = storyKey || normalizedStoryText || `story-${record.Id || Date.now()}`;
                }
                // ƒê·∫£m b·∫£o epicKey ƒë∆∞·ª£c set ƒë√∫ng
                if (!newStory.epicKey) {
                  newStory.epicKey = epicKey;
                }
                if (!newStory.epic) {
                  newStory.epic = epic.epic;
                }
                if (!storiesMap[newStory.storyKey]) {
                  storiesMap[newStory.storyKey] = newStory;
                }
              }
            }
            
            if (!newStory) {
              // T·∫°o story m·ªõi n·∫øu ch∆∞a t·ªìn t·∫°i
              // ∆Øu ti√™n d√πng storyKey t·ª´ record, n·∫øu kh√¥ng c√≥ th√¨ normalize t·ª´ story text
              const normalizedStoryText = normalizeKey(story);
              const newStoryKey = storyKey || normalizedStoryText || `story-${record.Id || Date.now()}`;
              // ƒê·∫£m b·∫£o storyKey l√† unique - n·∫øu ƒë√£ t·ªìn t·∫°i th√¨ th√™m Id v√†o
              let finalStoryKey = newStoryKey;
              if (storiesMap[finalStoryKey] && normalizeKey(storiesMap[finalStoryKey].story) !== normalizedStoryText) {
                finalStoryKey = `${newStoryKey}-${record.Id || Date.now()}`;
              }
              
              newStory = {
                story: story,
                storyKey: finalStoryKey,
                epic: epic.epic,
                epicKey: epicKey,
                workGroup: record.work_group || '',
                workType: record.work_type || '',
                assignee: record.assignee || '',
                startDate: record.start_date || '',
                dueDate: record.due_date || '',
                finishDate: record.finish_date || '',
                status: record.status || '',
                isCanceled: record.is_canceled === 'true' || record.is_canceled === true,
                note: record.note || '',
                jiraLink: record.jira_link || '',
                jiraKey: record.jira_key || '',
                taskCode: record.task_code || '',
                subtasks: [],
                expanded: true
              };
              storiesMap[finalStoryKey] = newStory;
            } else {
              // N·∫øu story ƒë√£ t·ªìn t·∫°i nh∆∞ng thi·∫øu th√¥ng tin, c·∫≠p nh·∫≠t t·ª´ record n·∫øu c√≥
              if (!newStory.assignee && record.assignee) {
                newStory.assignee = record.assignee;
              }
              if (!newStory.status && record.status) {
                newStory.status = record.status;
              }
              if (!newStory.workGroup && record.work_group) {
                newStory.workGroup = record.work_group;
              }
              if (!newStory.workType && record.work_type) {
                newStory.workType = record.work_type;
              }
            }
            // Th√™m subtask v√†o story (c√≥ th·ªÉ l√† story m·ªõi ho·∫∑c story ƒë√£ t·ªìn t·∫°i)
            // Debug: Ki·ªÉm tra ID468
            if (subtask.id === 468) {
              console.log(`[Form 3 Transform] ID468 added to new/existing story:`, {
                story: newStory.story,
                storyKey: newStory.storyKey,
                epicKey: newStory.epicKey
              });
            }
            newStory.subtasks.push(subtask);
            // ƒê·∫£m b·∫£o story ƒë∆∞·ª£c th√™m v√†o epic
            const storyExistsInEpic = epic.stories.find(s => {
              const sStoryText = normalizeKey(s.story);
              return sStoryText === normalizedStoryText || s.storyKey === newStory.storyKey;
            });
            if (!storyExistsInEpic) {
              epic.stories.push(newStory);
            }
          } else {
            // N·∫øu kh√¥ng c√≥ story, t·∫°o story ·∫£o "Kh√¥ng c√≥ Story"
            if (!epic.stories.length) {
              epic.stories.push({
                story: 'Kh√¥ng c√≥ Story',
                storyKey: 'no-story',
                subtasks: [subtask],
                expanded: true
              });
            } else {
              // Th√™m v√†o story ƒë·∫ßu ti√™n
              epic.stories[0].subtasks.push(subtask);
            }
          }
        } else {
          // N·∫øu kh√¥ng t√¨m th·∫•y epic, l∆∞u v√†o pending ƒë·ªÉ x·ª≠ l√Ω sau
          // Debug: Ki·ªÉm tra ID468
          if (subtask.id === 468) {
            console.log(`[Form 3 Transform] ID468 added to pending:`, {
              epicKey,
              storyKey,
              epic,
              story
            });
          }
          subtasksPending.push({ subtask, epicKey, storyKey, epic, story });
        }
      });

      // B∆∞·ªõc 4: X·ª≠ l√Ω subtasks pending (t·∫°o epic n·∫øu c·∫ßn)
      subtasksPending.forEach(({ subtask, epicKey, epic, story, storyKey }) => {
        // Debug: Ki·ªÉm tra ID468
        if (subtask.id === 468) {
          console.log(`[Form 3 Transform] Processing ID468 in pending:`, {
            epicKey,
            epic,
            story,
            storyKey,
            epicExists: !!epicsMap[epicKey],
            condition: epicKey && !epicsMap[epicKey] && epic
          });
        }
        if (epicKey && !epicsMap[epicKey] && epic) {
          // T·∫°o epic m·ªõi t·ª´ subtask
          const normalizedStoryText = story ? normalizeKey(story) : 'no-story';
          const finalStoryKey = storyKey || normalizedStoryText || `story-${subtask.id || Date.now()}`;
          
          // Ki·ªÉm tra xem story ƒë√£ t·ªìn t·∫°i trong storiesMap ch∆∞a (ph·∫£i c√πng epicKey)
          let pendingStory = Object.values(storiesMap).find(s => {
            const sStoryText = normalizeKey(s.story);
            const sEpicKey = s.epicKey || normalizeKey(s.epic);
            return sStoryText === normalizedStoryText && sEpicKey === epicKey;
          });
          
          if (!pendingStory && story && story.trim()) {
            // ƒê·∫£m b·∫£o storyKey l√† unique - n·∫øu ƒë√£ t·ªìn t·∫°i th√¨ th√™m Id v√†o
            let uniqueStoryKey = finalStoryKey;
            if (storiesMap[uniqueStoryKey] && normalizeKey(storiesMap[uniqueStoryKey].story) !== normalizedStoryText) {
              uniqueStoryKey = `${finalStoryKey}-${subtask.id || Date.now()}`;
            }
            
            pendingStory = {
              story: story,
              storyKey: uniqueStoryKey,
              epic: epic,
              epicKey: epicKey,
              workGroup: subtask.workGroup || '',
              workType: subtask.workType || '',
              assignee: subtask.assignee || '',
              startDate: subtask.startDate || '',
              dueDate: subtask.dueDate || '',
              finishDate: subtask.finishDate || '',
              status: subtask.status || '',
              isCanceled: subtask.isCanceled || false,
              note: subtask.note || '',
              jiraLink: subtask.jiraLink || '',
              jiraKey: subtask.jiraKey || '',
              taskCode: subtask.taskCode || '',
              subtasks: [],
              expanded: true
            };
            storiesMap[uniqueStoryKey] = pendingStory;
          } else if (pendingStory) {
            // N·∫øu story ƒë√£ t·ªìn t·∫°i nh∆∞ng thi·∫øu th√¥ng tin, c·∫≠p nh·∫≠t t·ª´ subtask n·∫øu c√≥
            if (!pendingStory.assignee && subtask.assignee) {
              pendingStory.assignee = subtask.assignee;
            }
            if (!pendingStory.status && subtask.status) {
              pendingStory.status = subtask.status;
            }
            if (!pendingStory.workGroup && subtask.workGroup) {
              pendingStory.workGroup = subtask.workGroup;
            }
            if (!pendingStory.workType && subtask.workType) {
              pendingStory.workType = subtask.workType;
            }
          }
          
          if (pendingStory) {
            // Debug: Ki·ªÉm tra ID468
            if (subtask.id === 468) {
              console.log(`[Form 3 Transform] ID468 added to pendingStory:`, {
                story: pendingStory.story,
                storyKey: pendingStory.storyKey,
                epicKey: pendingStory.epicKey
              });
            }
            pendingStory.subtasks.push(subtask);
            // ƒê·∫£m b·∫£o story ƒë∆∞·ª£c th√™m v√†o storiesMap v·ªõi storyKey ƒë√∫ng
            if (!storiesMap[pendingStory.storyKey]) {
              storiesMap[pendingStory.storyKey] = pendingStory;
            }
          }
          
          epicsMap[epicKey] = {
            epic: epic,
            epicKey: epicKey,
            workGroup: subtask.workGroup || '',
            workType: subtask.workType || '',
            assignee: subtask.assignee || '',
            startDate: '',
            dueDate: '',
            finishDate: '',
            status: '',
            isCanceled: false,
            note: '',
            jiraLink: '',
            jiraKey: '',
            taskCode: '',
            stories: pendingStory ? [pendingStory] : [{
              story: story || 'Kh√¥ng c√≥ Story',
              storyKey: finalStoryKey,
              epic: epic,
              epicKey: epicKey,
              subtasks: [subtask],
              expanded: true
            }],
            expanded: true
          };
          
          // ƒê·∫£m b·∫£o story trong epic ƒë∆∞·ª£c th√™m v√†o storiesMap
          if (epicsMap[epicKey].stories && epicsMap[epicKey].stories.length > 0) {
            epicsMap[epicKey].stories.forEach(s => {
              if (s && s.storyKey && !storiesMap[s.storyKey]) {
                storiesMap[s.storyKey] = s;
              }
            });
          }
        } else if (epicKey && epicsMap[epicKey] && epic) {
          // Epic ƒë√£ t·ªìn t·∫°i, nh∆∞ng subtask v·∫´n ·ªü pending - c·∫ßn th√™m v√†o epic
          const existingEpic = epicsMap[epicKey];
          const normalizedStoryText = story ? normalizeKey(story) : 'no-story';
          const finalStoryKey = storyKey || normalizedStoryText || `story-${subtask.id || Date.now()}`;
          
          // T√¨m story trong epic
          let existingStory = existingEpic.stories.find(s => {
            const sStoryText = normalizeKey(s.story);
            return sStoryText === normalizedStoryText;
          });
          
          // N·∫øu kh√¥ng t√¨m th·∫•y, t·∫°o story m·ªõi
          if (!existingStory && story && story.trim()) {
            // Ki·ªÉm tra trong storiesMap
            existingStory = Object.values(storiesMap).find(s => {
              const sStoryText = normalizeKey(s.story);
              const sEpicKey = s.epicKey || normalizeKey(s.epic);
              return sStoryText === normalizedStoryText && sEpicKey === epicKey;
            });
            
            if (!existingStory) {
              // T·∫°o story m·ªõi
              let uniqueStoryKey = finalStoryKey;
              if (storiesMap[uniqueStoryKey] && normalizeKey(storiesMap[uniqueStoryKey].story) !== normalizedStoryText) {
                uniqueStoryKey = `${finalStoryKey}-${subtask.id || Date.now()}`;
              }
              
              existingStory = {
                story: story,
                storyKey: uniqueStoryKey,
                epic: epic,
                epicKey: epicKey,
                workGroup: subtask.workGroup || '',
                workType: subtask.workType || '',
                assignee: subtask.assignee || '',
                startDate: subtask.startDate || '',
                dueDate: subtask.dueDate || '',
                finishDate: subtask.finishDate || '',
                status: subtask.status || '',
                isCanceled: subtask.isCanceled || false,
                note: subtask.note || '',
                jiraLink: subtask.jiraLink || '',
                jiraKey: subtask.jiraKey || '',
                taskCode: subtask.taskCode || '',
                subtasks: [],
                expanded: true
              };
              storiesMap[uniqueStoryKey] = existingStory;
              existingEpic.stories.push(existingStory);
            } else {
              // Story ƒë√£ t·ªìn t·∫°i trong storiesMap, ƒë·∫£m b·∫£o n√≥ c√≥ trong epic
              const storyInEpic = existingEpic.stories.find(s => {
                const sStoryText = normalizeKey(s.story);
                return sStoryText === normalizedStoryText;
              });
              if (!storyInEpic) {
                existingEpic.stories.push(existingStory);
              }
            }
          } else if (!existingStory) {
            // Kh√¥ng c√≥ story, th√™m v√†o story ƒë·∫ßu ti√™n ho·∫∑c t·∫°o story ·∫£o
            if (existingEpic.stories.length > 0) {
              existingStory = existingEpic.stories[0];
            } else {
              existingStory = {
                story: story || 'Kh√¥ng c√≥ Story',
                storyKey: finalStoryKey,
                epic: epic,
                epicKey: epicKey,
                subtasks: [],
                expanded: true
              };
              storiesMap[finalStoryKey] = existingStory;
              existingEpic.stories.push(existingStory);
            }
          }
          
          // Th√™m subtask v√†o story
          if (existingStory) {
            // Debug: Ki·ªÉm tra ID468
            if (subtask.id === 468) {
              console.log(`[Form 3 Transform] ID468 added to existing epic/story:`, {
                story: existingStory.story,
                storyKey: existingStory.storyKey,
                epicKey: existingStory.epicKey
              });
            }
            existingStory.subtasks.push(subtask);
            // ƒê·∫£m b·∫£o story c√≥ trong storiesMap
            if (existingStory.storyKey && !storiesMap[existingStory.storyKey]) {
              storiesMap[existingStory.storyKey] = existingStory;
            }
          }
        }
      });

      // B∆∞·ªõc 5: G·∫Øn l·∫°i c√°c stories v√†o epics ƒë√£ ƒë∆∞·ª£c t·∫°o sau b∆∞·ªõc 4
      // ƒêi·ªÅu n√†y x·ª≠ l√Ω tr∆∞·ªùng h·ª£p story ƒë∆∞·ª£c t·∫°o tr∆∞·ªõc khi epic ƒë∆∞·ª£c t·∫°o t·ª´ subtask
      Object.values(storiesMap).forEach(story => {
        const epicKey = story.epicKey || normalizeKey(story.epic);
        if (epicKey && epicsMap[epicKey]) {
          const epic = epicsMap[epicKey];
          // Ki·ªÉm tra xem story ƒë√£ t·ªìn t·∫°i trong epic ch∆∞a
          const existingStory = epic.stories.find(s => {
            const sStoryText = normalizeKey(s.story);
            const storyText = normalizeKey(story.story);
            return sStoryText === storyText || s.storyKey === story.storyKey;
          });
          if (!existingStory) {
            epic.stories.push(story);
          }
        }
      });
      
      // B∆∞·ªõc 6: S·∫Øp x·∫øp stories v√† subtasks
      Object.values(epicsMap).forEach(epic => {
        epic.stories.sort((a, b) => (a.storyKey || '').localeCompare(b.storyKey || ''));
        epic.stories.forEach(story => {
          story.subtasks.sort((a, b) => (a.taskCode || '').localeCompare(b.taskCode || ''));
        });
      });

      // Debug log
      const totalSubtasksInStructure = Object.values(epicsMap).reduce((sum, epic) => {
        return sum + epic.stories.reduce((s, story) => s + (story.subtasks?.length || 0), 0);
      }, 0);
      console.log(`[Form 3 Transform] Total subtasks in flat data: ${subtaskCount}, Matched to stories: ${matchedCount}, Total in structure: ${totalSubtasksInStructure}`);
      
      // Debug: Ki·ªÉm tra epic "ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng M25"
      const testEpicKey = normalizeKey("ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng M25");
      const testEpic = epicsMap[testEpicKey];
      if (testEpic) {
        const allSubtaskIds = [];
        testEpic.stories?.forEach(s => {
          s.subtasks?.forEach(st => {
            if (st.id) allSubtaskIds.push(st.id);
          });
        });
        console.log(`[Form 3 Transform] Found epic "ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng M25":`, {
          epicKey: testEpicKey,
          storiesCount: testEpic.stories?.length || 0,
          stories: testEpic.stories?.map(s => ({
            story: s.story,
            storyKey: s.storyKey,
            subtasksCount: s.subtasks?.length || 0,
            subtaskIds: s.subtasks?.map(st => st.id).filter(Boolean)
          })),
          allSubtaskIds: allSubtaskIds,
          hasId468: allSubtaskIds.includes(468)
        });
      } else {
        console.log(`[Form 3 Transform] Epic "ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng M25" NOT FOUND. EpicKey: ${testEpicKey}`);
      }
      
      // Debug: Ki·ªÉm tra ID468 trong flat data
      const id468Record = flatData.find(r => r.Id === 468);
      if (id468Record) {
        console.log(`[Form 3 Transform] ID468 found in flat data:`, {
          epic: id468Record.epic,
          story: id468Record.story,
          subtask: id468Record.subtask,
          epicKey: normalizeKey(id468Record.epic || ''),
          storyKey: normalizeKey(id468Record.story || ''),
          level: id468Record.level
        });
      } else {
        console.log(`[Form 3 Transform] ID468 NOT FOUND in flat data`);
      }
      
      // Debug: Ki·ªÉm tra ID468 trong subtasksPending
      console.log(`[Form 3 Transform] Subtasks pending count: ${subtasksPending.length}`);
      const id468Pending = subtasksPending.find(p => p.subtask?.id === 468);
      if (id468Pending) {
        console.log(`[Form 3 Transform] ID468 found in subtasksPending:`, id468Pending);
      }
      
      // Debug: Ki·ªÉm tra ID 469 v√† 470 (stories)
      [469, 470].forEach(id => {
        const record = flatData.find(r => r.Id === id);
        if (record) {
          const epicKey = normalizeKey(record.epic || '');
          const storyKey = normalizeKey(record.story || '');
          const storyInMap = Object.values(storiesMap).find(s => {
            const sStoryText = normalizeKey(s.story);
            const sEpicKey = s.epicKey || normalizeKey(s.epic);
            return sStoryText === storyKey && sEpicKey === epicKey;
          });
          const epicExists = !!epicsMap[epicKey];
          const storyInEpic = epicExists ? epicsMap[epicKey].stories.find(s => {
            const sStoryText = normalizeKey(s.story);
            return sStoryText === storyKey;
          }) : null;
          
          console.log(`[Form 3 Transform] ID${id} (story) check:`, {
            epic: record.epic,
            story: record.story,
            epicKey,
            storyKey,
            storyInMap: !!storyInMap,
            epicExists,
            storyInEpic: !!storyInEpic
          });
        }
      });

      return [{
        epics: Object.values(epicsMap).sort((a, b) => (a.epicKey || '').localeCompare(b.epicKey || ''))
      }];
    }

    // H√†m t·∫£i d·ªØ li·ªáu t·ª´ webhook
    async function loadF3Data() {
      const loadingDiv = document.getElementById('f3-loading');
      const loadBtn = document.getElementById('f3-load-data-btn');
      const tbody = document.getElementById('f3-table-body');

      const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/form3quanlyduannhomSPM';

      // L∆∞u tr·∫°ng th√°i filter hi·ªán t·∫°i tr∆∞·ªõc khi t·∫£i l·∫°i
      const searchInput = document.getElementById('f3-search-input');
      const statusFilter = document.getElementById('f3-filter-status');
      const assigneeFilter = document.getElementById('f3-filter-assignee');
      const levelFilter = document.getElementById('f3-filter-level');
      const monthFilter = document.getElementById('f3-filter-month');
      
      const savedSearch = searchInput ? searchInput.value : '';
      const savedStatus = statusFilter ? statusFilter.value : '';
      const savedAssignee = assigneeFilter ? assigneeFilter.value : '';
      const savedLevel = levelFilter ? levelFilter.value : '';
      const savedMonth = monthFilter ? monthFilter.value : '';

      try {
        if (loadingDiv) loadingDiv.classList.remove('hidden');
        if (loadBtn) loadBtn.disabled = true;
        // KH√îNG thay ƒë·ªïi tbody ·ªü ƒë√¢y - gi·ªØ nguy√™n b·∫£ng c≈© cho ƒë·∫øn khi nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu m·ªõi
        
        const response = await fetch(webhookUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseText = await response.text();
        let data = JSON.parse(responseText);

        // X·ª≠ l√Ω nhi·ªÅu format response - d·ªØ li·ªáu c√≥ th·ªÉ l√† array tr·ª±c ti·∫øp ho·∫∑c object ch·ª©a array
        let flatData = [];
        if (Array.isArray(data)) {
          flatData = data;
        } else if (data && Array.isArray(data.data)) {
          flatData = data.data;
        } else if (data && Array.isArray(data.results)) {
          flatData = data.results;
        } else if (data && Array.isArray(data.items)) {
          flatData = data.items;
        } else if (data && typeof data === 'object') {
          flatData = [data];
        }

        // Transform t·ª´ flat array sang hierarchical structure
        const hierarchicalData = transformF3FlatToHierarchical(flatData);

        F3_ALL_DATA = hierarchicalData;
        F3_FILTERED_DATA = hierarchicalData;
        
        // Populate assignee filter
        populateF3AssigneeFilter(flatData);
        
        // Kh√¥i ph·ª•c l·∫°i gi√° tr·ªã filter ƒë√£ l∆∞u
        if (searchInput) searchInput.value = savedSearch;
        if (statusFilter) statusFilter.value = savedStatus;
        if (assigneeFilter) assigneeFilter.value = savedAssignee;
        if (levelFilter) levelFilter.value = savedLevel;
        if (monthFilter) monthFilter.value = savedMonth;
        
        // √Åp d·ª•ng l·∫°i filter v·ªõi gi√° tr·ªã ƒë√£ l∆∞u
        filterF3Data();
        
        // CH·ªà render b·∫£ng SAU KHI ƒë√£ nh·∫≠n v√† x·ª≠ l√Ω xong d·ªØ li·ªáu t·ª´ webhook v√† √°p d·ª•ng l·∫°i filter
        // renderF3Table ƒë√£ ƒë∆∞·ª£c g·ªçi trong filterF3Data() n√™n kh√¥ng c·∫ßn g·ªçi l·∫°i

        showToast(`ƒê√£ t·∫£i ${flatData.length} b·∫£n ghi`, 'success');
        
      } catch (error) {
        console.error('[Form 3] Error loading data:', error);
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-8 text-center text-red-500">L·ªói: ${escapeHtml(error.message)}</td></tr>`;
        }
        showToast('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
      } finally {
        if (loadingDiv) loadingDiv.classList.add('hidden');
        if (loadBtn) loadBtn.disabled = false;
      }
    }

    // H√†m upload file
    async function submitF3File() {
      if (!F3_EXCEL_FILE) {
        showToast('Vui l√≤ng ch·ªçn file Excel', 'error');
        return;
      }

      const submitBtn = document.getElementById('f3-submit-btn');
      const formData = new FormData();
      formData.append('file', F3_EXCEL_FILE);

      const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/70bdcfa3-d7bf-4dc5-942c-5c9adcb37b7b';

      try {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="spinner"></span> ƒêang t·∫£i l√™n...';
        }

        const response = await fetch(webhookUrl, {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          showToast('ƒê√£ t·∫£i file l√™n th√†nh c√¥ng', 'success');
          // T·ª± ƒë·ªông t·∫£i l·∫°i d·ªØ li·ªáu sau khi upload
          setTimeout(() => loadF3Data(), 1000);
        } else {
          showToast(`T·∫£i l√™n kh√¥ng th√†nh c√¥ng: HTTP ${response.status}`, 'error');
        }
      } catch (error) {
        console.error('[Form 3] Error uploading:', error);
        showToast('L·ªói khi t·∫£i file l√™n: ' + error.message, 'error');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span class="material-symbols-outlined">upload</span><span>T·∫£i l√™n server</span>';
        }
      }
    }

    // H√†m chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu hierarchical sang flat array ƒë·ªÉ xu·∫•t Excel
    function flattenF3DataForExport(data) {
      const flatData = [];
      
      data.forEach(item => {
        if (!item.epics || !Array.isArray(item.epics)) return;
        
        item.epics.forEach(epic => {
          // Epic row
          flatData.push({
            'Level': 'Epic',
            'Khai b√°o thay ƒë·ªïi': epic.declarationChanged ? 'C√≥' : 'Kh√¥ng',
            'Epic': epic.epic || '',
            'Story': '',
            'Subtask': '',
            'Work Group': epic.workGroup || '',
            'Work Type': epic.workType || '',
            'Ng∆∞·ªùi th·ª±c hi·ªán': epic.assignee || '',
            'Ng√†y b·∫Øt ƒë·∫ßu': formatF3Date(epic.startDate),
            'H·∫°n ho√†n th√†nh': formatF3Date(epic.dueDate === 'Invalid Date' ? null : epic.dueDate),
            'Ng√†y ho√†n th√†nh': formatF3Date(epic.finishDate),
            'Tr·∫°ng th√°i': epic.status || '',
            'Jira Key': epic.jiraKey || '',
            'Note': epic.note || ''
          });
          
          // Story rows
          if (epic.stories && Array.isArray(epic.stories)) {
            epic.stories.forEach(story => {
              flatData.push({
                'Level': 'Story',
                'Khai b√°o thay ƒë·ªïi': story.declarationChanged ? 'C√≥' : 'Kh√¥ng',
                'Epic': epic.epic || '',
                'Story': story.story || '',
                'Subtask': '',
                'Work Group': story.workGroup || '',
                'Work Type': story.workType || '',
                'Ng∆∞·ªùi th·ª±c hi·ªán': story.assignee || '',
                'Ng√†y b·∫Øt ƒë·∫ßu': formatF3Date(story.startDate),
                'H·∫°n ho√†n th√†nh': formatF3Date(story.dueDate === 'Invalid Date' ? null : story.dueDate),
                'Ng√†y ho√†n th√†nh': formatF3Date(story.finishDate),
                'Tr·∫°ng th√°i': story.status || '',
                'Jira Key': story.jiraKey || '',
                'Note': story.note || ''
              });
              
              // Subtask rows
              if (story.subtasks && Array.isArray(story.subtasks)) {
                story.subtasks.forEach(subtask => {
                  flatData.push({
                    'Level': 'Subtask',
                    'Khai b√°o thay ƒë·ªïi': subtask.declarationChanged ? 'C√≥' : 'Kh√¥ng',
                    'Epic': epic.epic || '',
                    'Story': story.story || '',
                    'Subtask': subtask.subtask || subtask.workGroup || subtask.taskCode || '',
                    'Work Group': subtask.workGroup || '',
                    'Work Type': subtask.workType || '',
                    'Ng∆∞·ªùi th·ª±c hi·ªán': subtask.assignee || '',
                    'Ng√†y b·∫Øt ƒë·∫ßu': formatF3Date(subtask.startDate === 'Invalid Date' ? null : subtask.startDate),
                    'H·∫°n ho√†n th√†nh': formatF3Date(subtask.dueDate === 'Invalid Date' ? null : subtask.dueDate),
                    'Ng√†y ho√†n th√†nh': formatF3Date(subtask.finishDate),
                    'Tr·∫°ng th√°i': subtask.status || '',
                    'Jira Key': subtask.jiraKey || '',
                    'Note': subtask.note || ''
                  });
                });
              }
            });
          }
        });
      });
      
      return flatData;
    }

    // H√†m export Excel
    function exportF3ToExcel() {
      // S·ª≠ d·ª•ng d·ªØ li·ªáu ƒë√£ l·ªçc n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng to√†n b·ªô d·ªØ li·ªáu
      const dataToExport = F3_FILTERED_DATA.length > 0 ? F3_FILTERED_DATA : F3_ALL_DATA;
      
      if (!dataToExport || dataToExport.length === 0 || 
          (dataToExport[0] && (!dataToExport[0].epics || dataToExport[0].epics.length === 0))) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      try {
        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu hierarchical sang flat array
        const flatData = flattenF3DataForExport(dataToExport);
        
        if (flatData.length === 0) {
          showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
          return;
        }

        // T·∫°o workbook m·ªõi
        const wb = XLSX.utils.book_new();
        
        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu sang worksheet
        const ws = XLSX.utils.json_to_sheet(flatData);
        
        // ƒê·∫∑t ƒë·ªô r·ªông c·ªôt
        const colWidths = [
          { wch: 10 }, // Level
          { wch: 18 }, // Khai b√°o thay ƒë·ªïi
          { wch: 40 }, // Epic
          { wch: 40 }, // Story
          { wch: 40 }, // Subtask
          { wch: 20 }, // Work Group
          { wch: 25 }, // Work Type
          { wch: 20 }, // Ng∆∞·ªùi th·ª±c hi·ªán
          { wch: 15 }, // Ng√†y b·∫Øt ƒë·∫ßu
          { wch: 15 }, // H·∫°n ho√†n th√†nh
          { wch: 15 }, // Ng√†y ho√†n th√†nh
          { wch: 20 }, // Tr·∫°ng th√°i
          { wch: 15 }, // Jira Key
          { wch: 50 }  // Note
        ];
        ws['!cols'] = colWidths;
        
        // Th√™m worksheet v√†o workbook
        XLSX.utils.book_append_sheet(wb, ws, 'D·ªØ li·ªáu d·ª± √°n');
        
        // T·∫°o t√™n file v·ªõi timestamp
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
        const timeStr = now.toTimeString().slice(0, 5).replace(':', '');
        const fileName = `Form3_DuAn_${dateStr}_${timeStr}.xlsx`;
        
        // Xu·∫•t file
        XLSX.writeFile(wb, fileName);
        
        showToast(`ƒê√£ xu·∫•t ${flatData.length} d√≤ng d·ªØ li·ªáu th√†nh c√¥ng!`, 'success');
        
      } catch (error) {
        console.error('[Form 3] Error exporting to Excel:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi xu·∫•t Excel. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
    }

    // H√†m m·ªü modal khai b√°o Form 3
    function openF3DeclarationModal(subtaskId, epic, story, subtask) {
      // T√¨m subtask trong d·ªØ li·ªáu ƒë·ªÉ l·∫•y th√¥ng tin hi·ªán t·∫°i
      let currentSubtask = null;
      F3_ALL_DATA.forEach(item => {
        if (item.epics) {
          item.epics.forEach(e => {
            if (e.stories) {
              e.stories.forEach(s => {
                if (s.subtasks) {
                  s.subtasks.forEach(st => {
                    if ((st.id && st.id.toString() === subtaskId) || 
                        (st.taskCode && st.taskCode === subtaskId)) {
                      currentSubtask = st;
                    }
                  });
                }
              });
            }
          });
        }
      });
      
      const success = openModal('f3-declaration', (modal, config) => {
        // ƒêi·ªÅn th√¥ng tin t√°c v·ª• v√†o modal
        const epicInput = document.getElementById('modal-f3-declaration-epic');
        const storyInput = document.getElementById('modal-f3-declaration-story');
        const subtaskInput = document.getElementById('modal-f3-declaration-subtask');
        
        if (epicInput) epicInput.value = epic || '';
        if (storyInput) storyInput.value = story || '';
        if (subtaskInput) subtaskInput.value = subtask || '';
        
        // ƒêi·ªÅn th√¥ng tin hi·ªán t·∫°i v√†o c√°c tr∆∞·ªùng c√≥ th·ªÉ ch·ªânh s·ª≠a
        const statusSelect = document.getElementById('modal-f3-declaration-status');
        const jiraKeyInput = document.getElementById('modal-f3-declaration-jira-key');
        const jiraLinkInput = document.getElementById('modal-f3-declaration-jira-link');
        const linkInput = document.getElementById('modal-f3-declaration-link');
        const noteInput = document.getElementById('modal-f3-declaration-note');
        
        if (statusSelect && currentSubtask) {
          statusSelect.value = currentSubtask.status || '';
        }
        if (jiraKeyInput && currentSubtask) {
          jiraKeyInput.value = currentSubtask.jiraKey || '';
        }
        if (jiraLinkInput && currentSubtask) {
          jiraLinkInput.value = currentSubtask.jiraLink || '';
        }
        if (linkInput && currentSubtask) {
          linkInput.value = currentSubtask.link || '';
        }
        if (noteInput && currentSubtask) {
          noteInput.value = currentSubtask.note || '';
        }
        
        // L∆∞u subtaskId v√†o modal ƒë·ªÉ d√πng khi submit
        modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) {
        console.error('[Form 3] Failed to open declaration modal');
        showToast('Kh√¥ng th·ªÉ m·ªü modal khai b√°o', 'error');
      }
    }

    // H√†m x·ª≠ l√Ω submit khai b√°o Form 3
    async function handleF3DeclarationSubmit() {
      const modal = document.getElementById('modal-f3-declaration');
      if (!modal) return;
      
      const subtaskId = modal.getAttribute('data-subtask-id');
      const status = document.getElementById('modal-f3-declaration-status')?.value || '';
      const jiraKey = document.getElementById('modal-f3-declaration-jira-key')?.value || '';
      const jiraLink = document.getElementById('modal-f3-declaration-jira-link')?.value || '';
      const link = document.getElementById('modal-f3-declaration-link')?.value || '';
      const note = document.getElementById('modal-f3-declaration-note')?.value || '';

      // Validate
      if (!status.trim()) {
        showToast('Vui l√≤ng ch·ªçn tr·∫°ng th√°i', 'error');
        return;
      }

      // Disable submit button
      const submitBtn = document.getElementById('modal-f3-declaration-submit');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang l∆∞u...';
      }

      try {
        const WEBHOOK_URL = 'https://iatzhxxuk.tino.page/webhook/form3khaibaoduanspm';
        
        // T·∫°o th·ªùi gian hi·ªán t·∫°i theo GMT+7, ƒë·ªãnh d·∫°ng YYYY-MM-DD HH:mm
        const now = new Date();
        const utcTime = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
        const gmt7Time = new Date(utcTime + (7 * 60 * 60 * 1000));
        const year = gmt7Time.getFullYear();
        const month = String(gmt7Time.getMonth() + 1).padStart(2, '0');
        const day = String(gmt7Time.getDate()).padStart(2, '0');
        const hours = String(gmt7Time.getHours()).padStart(2, '0');
        const minutes = String(gmt7Time.getMinutes()).padStart(2, '0');
        const timestamp = `${year}-${month}-${day} ${hours}:${minutes}`;
        
        // T·∫°o payload ƒë·ªÉ g·ª≠i
        const payload = {
          level: 'declaration', // C·∫•p 3: Khai b√°o thay ƒë·ªïi
          gate: 'gate 3', // C·ªïng khai b√°o c·∫•p 3
          subtaskId: subtaskId || '',
          status: status.trim(),
          jiraKey: jiraKey.trim(),
          jiraLink: jiraLink.trim(),
          link: link.trim(),
          note: note.trim(),
          timestamp: timestamp
        };
        
        console.log('[Form 3] Sending declaration to:', WEBHOOK_URL);
        console.log('[Form 3] Payload:', payload);
        
        // G·ª≠i d·ªØ li·ªáu l√™n webhook
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // X·ª≠ l√Ω response - c√≥ th·ªÉ l√† JSON ho·∫∑c text
        let result = null;
        const contentType = response.headers.get('content-type');
        try {
          if (contentType && contentType.includes('application/json')) {
            const responseText = await response.text();
            if (responseText.trim()) {
              result = JSON.parse(responseText);
            }
          } else {
            const responseText = await response.text();
            result = { message: responseText || 'Success', success: true };
          }
        } catch (parseError) {
          // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, coi nh∆∞ th√†nh c√¥ng n·∫øu status OK
          console.warn('[Form 3] Could not parse response as JSON:', parseError);
          result = { message: 'Success', success: true };
        }
        console.log('[Form 3] Declaration submitted:', result);
        
        // C·∫≠p nh·∫≠t d·ªØ li·ªáu trong F3_ALL_DATA
        F3_ALL_DATA.forEach(item => {
          if (item.epics) {
            item.epics.forEach(epic => {
              if (epic.stories) {
                epic.stories.forEach(story => {
                  if (story.subtasks) {
                    story.subtasks.forEach(subtask => {
                      if ((subtask.id && subtask.id.toString() === subtaskId) || 
                          (subtask.taskCode && subtask.taskCode === subtaskId)) {
                        // C·∫≠p nh·∫≠t c√°c tr∆∞·ªùng
                        subtask.status = status.trim();
                        subtask.jiraKey = jiraKey.trim();
                        subtask.jiraLink = jiraLink.trim();
                        subtask.link = link.trim();
                        subtask.note = note.trim();
                        subtask.declarationChanged = true;
                      }
                    });
                  }
                });
              }
            });
          }
        });
        
        // C·∫≠p nh·∫≠t F3_FILTERED_DATA n·∫øu c√≥
        if (F3_FILTERED_DATA.length > 0) {
          F3_FILTERED_DATA.forEach(item => {
            if (item.epics) {
              item.epics.forEach(epic => {
                if (epic.stories) {
                  epic.stories.forEach(story => {
                    if (story.subtasks) {
                      story.subtasks.forEach(subtask => {
                        if ((subtask.id && subtask.id.toString() === subtaskId) || 
                            (subtask.taskCode && subtask.taskCode === subtaskId)) {
                          subtask.status = status.trim();
                          subtask.jiraKey = jiraKey.trim();
                          subtask.jiraLink = jiraLink.trim();
                          subtask.link = link.trim();
                          subtask.note = note.trim();
                          subtask.declarationChanged = true;
                        }
                      });
                    }
                  });
                }
              });
            }
          });
        }
        
        showToast('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!', 'success');
        
        // ƒê√≥ng modal v√† reset form
        closeModal('f3-declaration');
        resetF3DeclarationForm();
        
        // Re-render b·∫£ng ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
        renderF3Table(F3_FILTERED_DATA.length > 0 ? F3_FILTERED_DATA : F3_ALL_DATA);
        
      } catch (error) {
        console.error('[Form 3] Error submitting declaration:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      } finally {
        // Re-enable submit button
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'L∆∞u thay ƒë·ªïi';
        }
      }
    }

    // H√†m reset form khai b√°o Form 3
    function resetF3DeclarationForm() {
      const statusSelect = document.getElementById('modal-f3-declaration-status');
      const jiraKeyInput = document.getElementById('modal-f3-declaration-jira-key');
      const jiraLinkInput = document.getElementById('modal-f3-declaration-jira-link');
      const linkInput = document.getElementById('modal-f3-declaration-link');
      const noteInput = document.getElementById('modal-f3-declaration-note');
      
      if (statusSelect) statusSelect.value = '';
      if (jiraKeyInput) jiraKeyInput.value = '';
      if (jiraLinkInput) jiraLinkInput.value = '';
      if (linkInput) linkInput.value = '';
      if (noteInput) noteInput.value = '';
    }

    // H√†m m·ªü modal th√™m Story
    function openF3AddStoryModal(epicName) {
      const epicNameEl = document.getElementById('modal-f3-add-story-epic-name');
      const epicIdEl = document.getElementById('modal-f3-add-story-epic-id');
      const storyCodeEl = document.getElementById('modal-f3-add-story-code');
      const statusEl = document.getElementById('modal-f3-add-story-status');
      
      if (epicNameEl) epicNameEl.textContent = epicName || '';
      if (epicIdEl) epicIdEl.value = epicName || ''; // L∆∞u epic name thay v√¨ index
      
      // Reset form
      document.getElementById('modal-f3-add-story-form').reset();
      
      // T·ª± ƒë·ªông sinh Story Code
      if (storyCodeEl) {
        storyCodeEl.value = generateStoryCode();
      }
      
      // Set m·∫∑c ƒë·ªãnh tr·∫°ng th√°i l√† "ƒêang tri·ªÉn khai" (c·ªë ƒë·ªãnh)
      if (statusEl) {
        statusEl.value = 'ƒêang tri·ªÉn khai';
      }
      
      const success = openModal('f3-add-story');
      if (!success) {
        console.error('[Form 3] Failed to open add story modal');
        showToast('Kh√¥ng th·ªÉ m·ªü modal th√™m Story', 'error');
      }
    }

    // H√†m t·ª± ƒë·ªông sinh Task Code
    function generateTaskCode() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const timestamp = Date.now();
      return `TASK-${year}${month}${day}-${hours}${minutes}${seconds}-${timestamp.toString().slice(-4)}`;
    }

    // H√†m t·ª± ƒë·ªông sinh Story Code
    function generateStoryCode() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const timestamp = Date.now();
      return `STORY-${year}${month}${day}-${hours}${minutes}${seconds}-${timestamp.toString().slice(-4)}`;
    }

    // H√†m m·ªü modal th√™m Sub-task
    function openF3AddSubtaskModal(epicName, storyName) {
      const storyNameEl = document.getElementById('modal-f3-add-subtask-story-name');
      const epicNameEl = document.getElementById('modal-f3-add-subtask-epic-name');
      const epicIdEl = document.getElementById('modal-f3-add-subtask-epic-id');
      const storyIdEl = document.getElementById('modal-f3-add-subtask-story-id');
      const taskCodeEl = document.getElementById('modal-f3-add-subtask-task-code');
      const statusEl = document.getElementById('modal-f3-add-subtask-status');
      
      if (storyNameEl) storyNameEl.textContent = storyName || '';
      if (epicNameEl) epicNameEl.textContent = epicName || '';
      if (epicIdEl) epicIdEl.value = epicName || ''; // L∆∞u epic name thay v√¨ index
      if (storyIdEl) storyIdEl.value = storyName || ''; // L∆∞u story name thay v√¨ index
      
      // Reset form
      document.getElementById('modal-f3-add-subtask-form').reset();
      
      // T·ª± ƒë·ªông sinh Task Code
      if (taskCodeEl) {
        taskCodeEl.value = generateTaskCode();
      }
      
      // Set m·∫∑c ƒë·ªãnh tr·∫°ng th√°i l√† "Ch∆∞a tri·ªÉn khai"
      if (statusEl) {
        statusEl.value = 'Ch∆∞a tri·ªÉn khai';
      }
      
      const success = openModal('f3-add-subtask');
      if (!success) {
        console.error('[Form 3] Failed to open add subtask modal');
        showToast('Kh√¥ng th·ªÉ m·ªü modal th√™m Sub-task', 'error');
      }
    }

    // H√†m x·ª≠ l√Ω submit th√™m Story
    async function handleF3AddStorySubmit() {
      const form = document.getElementById('modal-f3-add-story-form');
      if (!form) return;

      const epicNameFromModal = document.getElementById('modal-f3-add-story-epic-id')?.value || '';
      const storyName = document.getElementById('modal-f3-add-story-name')?.value.trim() || '';
      
      // Validation c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (ngo·∫°i tr·ª´ Note)
      const storyCode = document.getElementById('modal-f3-add-story-code')?.value.trim() || '';
      const assignee = document.getElementById('modal-f3-add-story-assignee')?.value.trim() || '';
      const startDate = document.getElementById('modal-f3-add-story-start-date')?.value || '';
      const dueDate = document.getElementById('modal-f3-add-story-due-date')?.value || '';
      const jiraKey = document.getElementById('modal-f3-add-story-jira-key')?.value.trim() || '';
      const jiraLink = document.getElementById('modal-f3-add-story-jira-link')?.value.trim() || '';
      
      if (!storyName) {
        showToast('Vui l√≤ng nh·∫≠p t√™n Story', 'error');
        return;
      }
      if (!storyCode) {
        showToast('Story Code kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
        return;
      }
      if (!assignee) {
        showToast('Vui l√≤ng ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán', 'error');
        return;
      }
      if (!startDate) {
        showToast('Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu', 'error');
        return;
      }
      if (!dueDate) {
        showToast('Vui l√≤ng ch·ªçn h·∫°n ho√†n th√†nh', 'error');
        return;
      }
      if (!jiraKey) {
        showToast('Vui l√≤ng nh·∫≠p M√£ Jira', 'error');
        return;
      }

      // T√¨m Epic b·∫±ng name trong F3_ALL_DATA
      let epicName = epicNameFromModal;
      let epicKey = '';
      if (F3_ALL_DATA && F3_ALL_DATA.length > 0) {
        const dataItem = F3_ALL_DATA[0];
        if (dataItem.epics && Array.isArray(dataItem.epics)) {
          const epic = dataItem.epics.find(e => normalizeKey(e.epic) === normalizeKey(epicNameFromModal));
          if (epic) {
            epicName = epic.epic || epicNameFromModal;
            epicKey = epic.epicKey || epic.epic || '';
          }
        }
      }

      // L·∫•y d·ªØ li·ªáu t·ª´ form
      // Status lu√¥n c·ªë ƒë·ªãnh l√† "ƒêang tri·ªÉn khai"
      const status = 'ƒêang tri·ªÉn khai';
      
      const storyData = {
        level: 'story',
        gate: 'gate 1', // C·ªïng khai b√°o c·∫•p 1
        epic: epicName,
        epicKey: epicKey,
        story: storyName,
        storyKey: storyCode,
        assignee: assignee,
        status: status,
        startDate: startDate,
        dueDate: dueDate,
        jiraKey: jiraKey,
        jiraLink: jiraLink,
        note: document.getElementById('modal-f3-add-story-note')?.value.trim() || ''
      };

      // Disable submit button
      const submitBtn = document.getElementById('modal-f3-add-story-submit');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang g·ª≠i...';
      }

      try {
        // G·ª≠i l√™n server
        await submitF3StoryToServer(storyData);
        
        showToast('ƒê√£ th√™m Story th√†nh c√¥ng!', 'success');
        closeModal('f3-add-story');
        
        // T·ª± ƒë·ªông t·∫£i l·∫°i d·ªØ li·ªáu sau khi th√™m th√†nh c√¥ng
        setTimeout(() => {
          loadF3Data();
        }, 500);
        
      } catch (error) {
        console.error('[Form 3] Error submitting story to server:', error);
        showToast('L·ªói khi th√™m Story: ' + (error.message || 'Vui l√≤ng th·ª≠ l·∫°i'), 'error');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Th√™m Story';
        }
      }
    }

    // H√†m x·ª≠ l√Ω submit th√™m Sub-task
    async function handleF3AddSubtaskSubmit() {
      const form = document.getElementById('modal-f3-add-subtask-form');
      if (!form) return;

      const epicNameFromModal = document.getElementById('modal-f3-add-subtask-epic-id')?.value || '';
      const storyNameFromModal = document.getElementById('modal-f3-add-subtask-story-id')?.value || '';
      const subtaskName = document.getElementById('modal-f3-add-subtask-name')?.value.trim() || '';
      
      if (!subtaskName) {
        showToast('Vui l√≤ng nh·∫≠p t√™n Sub-task', 'error');
        return;
      }

      if (!epicNameFromModal || !storyNameFromModal) {
        showToast('Kh√¥ng t√¨m th·∫•y Epic ho·∫∑c Story', 'error');
        return;
      }

      // T√¨m Epic v√† Story b·∫±ng name trong F3_ALL_DATA
      let epicData = null;
      let storyData = null;
      let epicName = epicNameFromModal;
      let epicKey = '';
      let storyName = storyNameFromModal;
      let storyKey = '';
      
      if (F3_ALL_DATA && F3_ALL_DATA.length > 0) {
        const dataItem = F3_ALL_DATA[0];
        if (dataItem.epics && Array.isArray(dataItem.epics)) {
          // T√¨m Epic b·∫±ng name
          epicData = dataItem.epics.find(e => normalizeKey(e.epic) === normalizeKey(epicNameFromModal));
          if (epicData) {
            epicName = epicData.epic || epicNameFromModal;
            epicKey = epicData.epicKey || epicData.epic || '';
            
            // T√¨m Story b·∫±ng name trong Epic ƒë√£ t√¨m ƒë∆∞·ª£c
            if (epicData.stories && Array.isArray(epicData.stories)) {
              storyData = epicData.stories.find(s => normalizeKey(s.story) === normalizeKey(storyNameFromModal));
              if (storyData) {
                storyName = storyData.story || storyNameFromModal;
                storyKey = storyData.storyKey || storyData.story || '';
              }
            }
          }
        }
      }

      // Validation c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (ngo·∫°i tr·ª´ Note)
      const taskCode = document.getElementById('modal-f3-add-subtask-task-code')?.value.trim() || '';
      const assignee = document.getElementById('modal-f3-add-subtask-assignee')?.value.trim() || '';
      const status = document.getElementById('modal-f3-add-subtask-status')?.value || '';
      const startDateInput = document.getElementById('modal-f3-add-subtask-start-date')?.value || '';
      const dueDateInput = document.getElementById('modal-f3-add-subtask-due-date')?.value || '';
      const jiraKey = document.getElementById('modal-f3-add-subtask-jira-key')?.value.trim() || '';
      const jiraLink = document.getElementById('modal-f3-add-subtask-jira-link')?.value.trim() || '';
      
      if (!taskCode) {
        showToast('Task Code kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
        return;
      }
      if (!assignee) {
        showToast('Vui l√≤ng ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán', 'error');
        return;
      }
      if (!status) {
        showToast('Vui l√≤ng ch·ªçn tr·∫°ng th√°i', 'error');
        return;
      }
      if (!startDateInput) {
        showToast('Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu', 'error');
        return;
      }
      if (!dueDateInput) {
        showToast('Vui l√≤ng ch·ªçn h·∫°n ho√†n th√†nh', 'error');
        return;
      }
      if (!jiraKey) {
        showToast('Vui l√≤ng nh·∫≠p M√£ Jira', 'error');
        return;
      }

      // Validate v√† format date ƒë·ªÉ tr√°nh "Invalid Date"
      // Input type="date" tr·∫£ v·ªÅ format YYYY-MM-DD, ch·ªâ c·∫ßn validate format
      let startDate = startDateInput.trim();
      let dueDate = dueDateInput.trim();
      
      // Validate format YYYY-MM-DD cho startDate
      if (startDate && !/^\d{4}-\d{2}-\d{2}$/.test(startDate)) {
        showToast('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng', 'error');
        return;
      }
      
      // Validate format YYYY-MM-DD cho dueDate
      if (dueDate && !/^\d{4}-\d{2}-\d{2}$/.test(dueDate)) {
        showToast('H·∫°n ho√†n th√†nh kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng', 'error');
        return;
      }
      
      // Validate date h·ª£p l·ªá b·∫±ng c√°ch parse v√† ki·ªÉm tra
      if (startDate) {
        try {
          // Parse date v√† ki·ªÉm tra t√≠nh h·ª£p l·ªá
          const startDateParts = startDate.split('-');
          const startYear = parseInt(startDateParts[0], 10);
          const startMonth = parseInt(startDateParts[1], 10) - 1; // Month is 0-indexed
          const startDay = parseInt(startDateParts[2], 10);
          const startDateObj = new Date(startYear, startMonth, startDay);
          
          // Ki·ªÉm tra date c√≥ h·ª£p l·ªá kh√¥ng (tr√°nh tr∆∞·ªùng h·ª£p 31/02 -> 03/03)
          if (startDateObj.getFullYear() !== startYear || 
              startDateObj.getMonth() !== startMonth || 
              startDateObj.getDate() !== startDay) {
            showToast('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng h·ª£p l·ªá', 'error');
            return;
          }
        } catch (e) {
          console.error('[Form 3] Error validating startDate:', e);
          showToast('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng h·ª£p l·ªá', 'error');
          return;
        }
      }
      
      // Validate date h·ª£p l·ªá cho dueDate
      if (dueDate) {
        try {
          // Parse date v√† ki·ªÉm tra t√≠nh h·ª£p l·ªá
          const dueDateParts = dueDate.split('-');
          const dueYear = parseInt(dueDateParts[0], 10);
          const dueMonth = parseInt(dueDateParts[1], 10) - 1; // Month is 0-indexed
          const dueDay = parseInt(dueDateParts[2], 10);
          const dueDateObj = new Date(dueYear, dueMonth, dueDay);
          
          // Ki·ªÉm tra date c√≥ h·ª£p l·ªá kh√¥ng (tr√°nh tr∆∞·ªùng h·ª£p 31/02 -> 03/03)
          if (dueDateObj.getFullYear() !== dueYear || 
              dueDateObj.getMonth() !== dueMonth || 
              dueDateObj.getDate() !== dueDay) {
            showToast('H·∫°n ho√†n th√†nh kh√¥ng h·ª£p l·ªá', 'error');
            return;
          }
        } catch (e) {
          console.error('[Form 3] Error validating dueDate:', e);
          showToast('H·∫°n ho√†n th√†nh kh√¥ng h·ª£p l·ªá', 'error');
          return;
        }
      }

      // T·∫°o b·∫£n sao s·∫°ch c·ªßa Epic v√† Story ƒë·ªÉ tr√°nh circular reference
      let cleanEpicData = null;
      let cleanStoryData = null;
      
      if (epicData) {
        // Clone Epic v√† lo·∫°i b·ªè property stories ƒë·ªÉ tr√°nh circular reference
        cleanEpicData = { ...epicData };
        delete cleanEpicData.stories; // Lo·∫°i b·ªè stories ƒë·ªÉ tr√°nh circular reference
      }
      
      if (storyData) {
        // Clone Story v√† lo·∫°i b·ªè property epic v√† subtasks ƒë·ªÉ tr√°nh circular reference
        cleanStoryData = { ...storyData };
        delete cleanStoryData.epic; // Lo·∫°i b·ªè epic ƒë·ªÉ tr√°nh circular reference
        delete cleanStoryData.subtasks; // Lo·∫°i b·ªè subtasks n·∫øu c√≥
      }

      // L·∫•y d·ªØ li·ªáu t·ª´ form
      const subtaskData = {
        level: 'subtask',
        gate: 'gate 2', // C·ªïng khai b√°o c·∫•p 2
        // D·ªØ li·ªáu Epic (b·∫£n sao s·∫°ch, kh√¥ng c√≥ circular reference)
        epicData: cleanEpicData || {},
        epic: epicName,
        epicKey: epicKey,
        // D·ªØ li·ªáu Story (b·∫£n sao s·∫°ch, kh√¥ng c√≥ circular reference)
        storyData: cleanStoryData || {},
        story: storyName,
        storyKey: storyKey,
        // D·ªØ li·ªáu Subtask
        subtask: subtaskName,
        taskCode: taskCode,
        assignee: assignee,
        status: status,
        startDate: startDate,
        dueDate: dueDate,
        jiraKey: jiraKey,
        jiraLink: jiraLink,
        note: document.getElementById('modal-f3-add-subtask-note')?.value.trim() || ''
      };

      // Disable submit button
      const submitBtn = document.getElementById('modal-f3-add-subtask-submit');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang g·ª≠i...';
      }

      try {
        // G·ª≠i l√™n server
        await submitF3SubtaskToServer(subtaskData);
        
        showToast('ƒê√£ th√™m Sub-task th√†nh c√¥ng!', 'success');
        closeModal('f3-add-subtask');
        
        // T·ª± ƒë·ªông t·∫£i l·∫°i d·ªØ li·ªáu sau khi th√™m th√†nh c√¥ng
        setTimeout(() => {
          loadF3Data();
        }, 500);
        
      } catch (error) {
        console.error('[Form 3] Error submitting subtask to server:', error);
        showToast('L·ªói khi th√™m Sub-task: ' + (error.message || 'Vui l√≤ng th·ª≠ l·∫°i'), 'error');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Th√™m Sub-task';
        }
      }
    }

    // H√†m g·ª≠i Story l√™n server
    async function submitF3StoryToServer(storyData) {
      // D√πng chung webhook v·ªõi GET d·ªØ li·ªáu
      const WEBHOOK_URL = 'https://iatzhxxuk.tino.page/webhook/form3quanlyduannhomSPM';
      
      console.log('[Form 3] Sending story to:', WEBHOOK_URL);
      console.log('[Form 3] Story data:', storyData);
      
      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(storyData)
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
      }

      const result = await response.json();
      console.log('[Form 3] Story submitted:', result);
      return result;
    }

    // H√†m g·ª≠i Sub-task l√™n server
    async function submitF3SubtaskToServer(subtaskData) {
      // D√πng chung webhook v·ªõi GET d·ªØ li·ªáu
      const WEBHOOK_URL = 'https://iatzhxxuk.tino.page/webhook/form3quanlyduannhomSPM';
      
      console.log('[Form 3] Sending subtask to:', WEBHOOK_URL);
      console.log('[Form 3] Subtask data:', subtaskData);
      
      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(subtaskData)
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
      }

      const result = await response.json();
      console.log('[Form 3] Subtask submitted:', result);
      return result;
    }

    // Kh·ªüi t·∫°o Form 3
    document.addEventListener('DOMContentLoaded', function() {
      const dropZone = document.getElementById('f3-drop-zone');
      const fileInput = document.getElementById('f3-excel-file');
      const fileInfo = document.getElementById('f3-file-info');
      const fileName = document.getElementById('f3-file-name');
      const fileSize = document.getElementById('f3-file-size');
      const fileRemove = document.getElementById('f3-file-remove');
      const submitBtn = document.getElementById('f3-submit-btn');
      const loadBtn = document.getElementById('f3-load-data-btn');
      const exportBtn = document.getElementById('f3-export-btn');
      const searchInput = document.getElementById('f3-search-input');
      const statusFilter = document.getElementById('f3-filter-status');

      // Drag & drop
      if (dropZone && fileInput) {
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('border-blue-500', 'bg-blue-50');
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
          }
        });
      }

      // Ch·ªçn file
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
          }
        });
      }

      function handleFileSelect(file) {
            const validExtensions = ['.xlsx', '.xls'];
        const fileNameLower = file.name.toLowerCase();
        const isValid = validExtensions.some(ext => fileNameLower.endsWith(ext));
            
        if (!isValid) {
              showToast('Vui l√≤ng ch·ªçn file Excel (.xlsx ho·∫∑c .xls)', 'error');
              return;
            }

            F3_EXCEL_FILE = file;
        if (fileInfo) fileInfo.classList.remove('hidden');
        if (fileName) fileName.textContent = file.name;
        if (fileSize) fileSize.textContent = formatFileSize(file.size);
        if (submitBtn) submitBtn.disabled = false;
        document.getElementById('f3-drop-content').classList.add('hidden');
      }

      // X√≥a file
      if (fileRemove) {
        fileRemove.addEventListener('click', (e) => {
          e.stopPropagation();
          F3_EXCEL_FILE = null;
          if (fileInput) fileInput.value = '';
          if (fileInfo) fileInfo.classList.add('hidden');
          if (submitBtn) submitBtn.disabled = true;
          document.getElementById('f3-drop-content').classList.remove('hidden');
        });
      }

      // Submit
      if (submitBtn) {
        submitBtn.addEventListener('click', submitF3File);
      }

      // Load data
      if (loadBtn) {
        loadBtn.addEventListener('click', loadF3Data);
      }

      // Export
      if (exportBtn) {
        exportBtn.addEventListener('click', exportF3ToExcel);
      }

      // Search & filter
      if (searchInput) {
        searchInput.addEventListener('input', filterF3Data);
      }
      if (statusFilter) {
        statusFilter.addEventListener('change', filterF3Data);
      }
      
      const assigneeFilter = document.getElementById('f3-filter-assignee');
      if (assigneeFilter) {
        assigneeFilter.addEventListener('change', filterF3Data);
      }

      const levelFilter = document.getElementById('f3-filter-level');
      if (levelFilter) {
        levelFilter.addEventListener('change', () => {
          applyF3LevelFilter();
        });
      }

      const monthFilter = document.getElementById('f3-filter-month');
      if (monthFilter) {
        // Set m·∫∑c ƒë·ªãnh l√† th√°ng hi·ªán t·∫°i
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        monthFilter.value = `${year}-${month}`;
        
        monthFilter.addEventListener('change', filterF3Data);
      }

      // Event listener cho n√∫t khai b√°o thay ƒë·ªïi (delegation)
      document.addEventListener('click', (e) => {
        if (e.target.closest('.f3-declaration-btn')) {
          const btn = e.target.closest('.f3-declaration-btn');
          // Ki·ªÉm tra n·∫øu button b·ªã disabled th√¨ kh√¥ng l√†m g√¨
          if (btn.disabled || btn.classList.contains('cursor-not-allowed')) {
            return;
          }
          const subtaskId = btn.getAttribute('data-subtask-id');
          const epic = btn.getAttribute('data-epic');
          const story = btn.getAttribute('data-story');
          const subtask = btn.getAttribute('data-subtask');
          
          openF3DeclarationModal(subtaskId, epic, story, subtask);
        }
      });
      
      // Kh·ªüi t·∫°o modal listeners
      initModalListeners('f3-declaration');
      initModalListeners('f3-add-story');
      initModalListeners('f3-add-subtask');
      
      // Event listener cho n√∫t submit
      const f3DeclarationSubmitBtn = document.getElementById('modal-f3-declaration-submit');
      if (f3DeclarationSubmitBtn) {
        f3DeclarationSubmitBtn.addEventListener('click', handleF3DeclarationSubmit);
      }

      // Event listener cho n√∫t submit th√™m Story
      const f3AddStorySubmitBtn = document.getElementById('modal-f3-add-story-submit');
      if (f3AddStorySubmitBtn) {
        f3AddStorySubmitBtn.addEventListener('click', (e) => {
          e.preventDefault();
          handleF3AddStorySubmit();
        });
      }

      // Event listener cho n√∫t submit th√™m Sub-task
      const f3AddSubtaskSubmitBtn = document.getElementById('modal-f3-add-subtask-submit');
      if (f3AddSubtaskSubmitBtn) {
        f3AddSubtaskSubmitBtn.addEventListener('click', (e) => {
          e.preventDefault();
          handleF3AddSubtaskSubmit();
        });
      }
    });

    // ===== FORM 7 - DASHBOARD D·ªÆ LI·ªÜU EXCEL =====
    
    let F7_ALL_DATA = [];

    // H√†m t√≠nh to√°n th·ªëng k√™ t·ª´ d·ªØ li·ªáu flat (nh∆∞ Form 3)
    function calculateF7Stats(flatData) {
      if (!Array.isArray(flatData) || flatData.length === 0) {
        return {
          totalEpics: 0,
          totalStories: 0,
          totalSubtasks: 0,
          completedSubtasks: 0,
          completionRate: 0,
          statusCount: {},
          assigneeCount: {},
          workGroupCount: {},
          assigneeDetails: {},
          assigneeWorkload: {},
          assigneeProgress: {},
          dueTasks: []
        };
      }

      let totalEpics = 0;
      let totalStories = 0;
      let totalSubtasks = 0;
      let completedSubtasks = 0;
      const statusCount = {};
      const assigneeCount = {};
      const workGroupCount = {};
      const assigneeDetails = {}; // Chi ti·∫øt theo assignee
      const assigneeWorkload = {}; // Kh·ªëi l∆∞·ª£ng c√¥ng vi·ªác theo assignee
      const assigneeProgress = {}; // Ti·∫øn ƒë·ªô theo assignee
      const dueTasks = []; // Task ƒë·∫øn h·∫°n

      const epicSet = new Set();
      const storySet = new Set();
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      flatData.forEach(record => {
        const level = (record.level || '').toLowerCase();
        const assignee = (record.assignee || '').trim();
        const status = (record.status || 'Ch∆∞a x√°c ƒë·ªãnh').trim();
        const workGroup = (record.work_group || '').trim();
        const epic = (record.epic || '').trim();
        const story = (record.story || '').trim();
        const dueDate = record.due_date || '';
        const taskCode = record.task_code || '';
        const subtask = record.subtask || '';
        
        // Ki·ªÉm tra task ƒë·∫øn h·∫°n
        if (dueDate && dueDate !== 'Invalid Date' && dueDate.trim()) {
          try {
            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);
            const statusLower = status.toLowerCase();
            // Ch·ªâ t√≠nh task ch∆∞a ho√†n th√†nh v√† ƒë√£ qu√° h·∫°n
            if (due < today && !statusLower.includes('ho√†n th√†nh') && !statusLower.includes('done') && !statusLower.includes('completed') && statusLower !== 'h·ªßy' && statusLower !== 'cancel') {
              dueTasks.push({
                assignee: assignee || 'Ch∆∞a x√°c ƒë·ªãnh',
                taskCode: taskCode,
                subtask: subtask || story || epic || 'N/A',
                dueDate: dueDate,
                status: status,
                level: level,
                workGroup: workGroup,
                daysOverdue: Math.floor((today - due) / (1000 * 60 * 60 * 24))
              });
            }
          } catch (e) {
            // B·ªè qua n·∫øu kh√¥ng parse ƒë∆∞·ª£c date
          }
        }
        
        // ƒê·∫øm theo level
        if (level === 'epic') {
          const epicKey = epic || record.Id || Math.random();
          if (!epicSet.has(epicKey)) {
            epicSet.add(epicKey);
            totalEpics++;
          }
        } else if (level === 'story') {
          const storyKey = story || record.Id || Math.random();
          if (!storySet.has(storyKey)) {
            storySet.add(storyKey);
            totalStories++;
          }
        } else if (level === 'subtask') {
          totalSubtasks++;
        }

        // ƒê·∫øm tr·∫°ng th√°i
        statusCount[status] = (statusCount[status] || 0) + 1;

        // ƒê·∫øm work group
        if (workGroup) {
          workGroupCount[workGroup] = (workGroupCount[workGroup] || 0) + 1;
        }

        // X·ª≠ l√Ω theo assignee (t·∫≠p trung ch√≠nh)
        if (assignee) {
          // ƒê·∫øm t·ªïng s·ªë task theo assignee
          assigneeCount[assignee] = (assigneeCount[assignee] || 0) + 1;

          // Kh·ªüi t·∫°o chi ti·∫øt assignee n·∫øu ch∆∞a c√≥
          if (!assigneeDetails[assignee]) {
            assigneeDetails[assignee] = {
              total: 0,
              epics: 0,
              stories: 0,
              subtasks: 0,
              statusCount: {},
              workGroups: new Set(),
              completed: 0,
              inProgress: 0,
              pending: 0,
              canceled: 0
            };
          }

          const details = assigneeDetails[assignee];
          details.total++;

          // ƒê·∫øm theo level
          if (level === 'epic') {
            details.epics++;
          } else if (level === 'story') {
            details.stories++;
          } else if (level === 'subtask') {
            details.subtasks++;
          }

          // ƒê·∫øm tr·∫°ng th√°i theo assignee
          details.statusCount[status] = (details.statusCount[status] || 0) + 1;

          // ƒê·∫øm work groups
          if (workGroup) {
            details.workGroups.add(workGroup);
          }

          // Ph√¢n lo·∫°i tr·∫°ng th√°i
          const statusLower = status.toLowerCase();
          if (statusLower.includes('ho√†n th√†nh') || statusLower.includes('done') || statusLower.includes('completed')) {
            details.completed++;
            if (level === 'subtask') completedSubtasks++;
          } else if (statusLower.includes('ƒëang') || statusLower.includes('progress') || statusLower.includes('tri·ªÉn khai')) {
            details.inProgress++;
          } else if (statusLower.includes('ch∆∞a') || statusLower.includes('pending') || statusLower.includes('to do')) {
            details.pending++;
          } else if (statusLower.includes('h·ªßy') || statusLower.includes('cancel')) {
            details.canceled++;
          }

          // T√≠nh workload (s·ªë task ƒëang l√†m)
          if (!assigneeWorkload[assignee]) {
            assigneeWorkload[assignee] = {
              total: 0,
              active: 0,
              completed: 0
            };
          }
          assigneeWorkload[assignee].total++;
          if (statusLower.includes('ƒëang') || statusLower.includes('progress') || statusLower.includes('tri·ªÉn khai')) {
            assigneeWorkload[assignee].active++;
          }
          if (statusLower.includes('ho√†n th√†nh') || statusLower.includes('done') || statusLower.includes('completed')) {
            assigneeWorkload[assignee].completed++;
          }

          // T√≠nh ti·∫øn ƒë·ªô
          if (!assigneeProgress[assignee]) {
            assigneeProgress[assignee] = {
              total: 0,
              completed: 0,
              rate: 0
            };
          }
          assigneeProgress[assignee].total++;
          if (statusLower.includes('ho√†n th√†nh') || statusLower.includes('done') || statusLower.includes('completed')) {
            assigneeProgress[assignee].completed++;
          }
        }
      });

      // T√≠nh completion rate cho t·ª´ng assignee
      Object.keys(assigneeProgress).forEach(assignee => {
        const progress = assigneeProgress[assignee];
        progress.rate = progress.total > 0 ? Math.round((progress.completed / progress.total) * 100) : 0;
      });

      // Chuy·ªÉn Set th√†nh s·ªë l∆∞·ª£ng cho workGroups
      Object.keys(assigneeDetails).forEach(assignee => {
        assigneeDetails[assignee].workGroups = assigneeDetails[assignee].workGroups.size;
      });

      const completionRate = totalSubtasks > 0 ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;

      // S·∫Øp x·∫øp task ƒë·∫øn h·∫°n theo s·ªë ng√†y qu√° h·∫°n (nhi·ªÅu nh·∫•t tr∆∞·ªõc)
      dueTasks.sort((a, b) => b.daysOverdue - a.daysOverdue);

      return {
        totalEpics,
        totalStories,
        totalSubtasks,
        completedSubtasks,
        completionRate,
        statusCount,
        assigneeCount,
        workGroupCount,
        assigneeDetails,
        assigneeWorkload,
        assigneeProgress,
        dueTasks
      };
    }

    // H√†m render stats cards
    function renderF7StatsCards(stats) {
      document.getElementById('f7-stat-epics').textContent = stats.totalEpics;
      document.getElementById('f7-stat-stories').textContent = stats.totalStories;
      document.getElementById('f7-stat-subtasks').textContent = stats.totalSubtasks;
      document.getElementById('f7-stat-completion').textContent = stats.completionRate + '%';
    }

    // H√†m render chart tr·∫°ng th√°i (d·∫°ng text chart)
    function renderF7StatusChart(statusCount) {
      const chartDiv = document.getElementById('f7-chart-subtask-status');
      if (!chartDiv) return;

      const entries = Object.entries(statusCount).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        chartDiv.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }

      const maxCount = Math.max(...entries.map(e => e[1]));
      let html = '<div class="space-y-3">';
      
      entries.forEach(([status, count]) => {
        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
        const statusLower = String(status).toLowerCase();
        let colorClass = 'bg-gray-200';
        
        if (statusLower.includes('ho√†n th√†nh') || statusLower.includes('done') || statusLower.includes('completed')) {
          colorClass = 'bg-green-500';
        } else if (statusLower.includes('ƒëang') || statusLower.includes('progress') || statusLower.includes('tri·ªÉn khai')) {
          colorClass = 'bg-blue-500';
        } else if (statusLower.includes('ch∆∞a') || statusLower.includes('pending') || statusLower.includes('to do')) {
          colorClass = 'bg-yellow-500';
        } else if (statusLower.includes('h·ªßy') || statusLower.includes('cancel')) {
          colorClass = 'bg-red-500';
        }
        
        html += `
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm font-medium text-gray-700">${escapeHtml(status)}</span>
              <span class="text-sm text-gray-600">${count}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="${colorClass} h-2.5 rounded-full transition-all" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      chartDiv.innerHTML = html;
    }

    // H√†m render chart ng∆∞·ªùi th·ª±c hi·ªán (c·∫£i thi·ªán)
    // H√†m render bi·ªÉu ƒë·ªì tr√≤n ph√¢n b·ªï task theo assignee
    function renderF7AssigneeChart(assigneeCount) {
      const chartDiv = document.getElementById('f7-chart-assignee');
      if (!chartDiv) return;

      const entries = Object.entries(assigneeCount).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        chartDiv.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }

      const total = entries.reduce((sum, [, count]) => sum + count, 0);
      if (total === 0) {
        chartDiv.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }

      // M√†u s·∫Øc cho bi·ªÉu ƒë·ªì tr√≤n
      const colors = [
        '#3B82F6', '#8B5CF6', '#10B981', '#F59E0B', '#EF4444',
        '#06B6D4', '#EC4899', '#84CC16', '#F97316', '#6366F1',
        '#14B8A6', '#A855F7', '#22C55E', '#EAB308', '#DC2626'
      ];

      // T√≠nh to√°n g√≥c cho t·ª´ng ph·∫ßn
      let currentAngle = 0; // B·∫Øt ƒë·∫ßu t·ª´ 0 ƒë·ªô
      let html = '<div class="flex flex-col items-center gap-6">';
      
      // V·∫Ω bi·ªÉu ƒë·ªì tr√≤n b·∫±ng SVG
      const size = 220;
      const radius = size / 2 - 15;
      const center = size / 2;
      const strokeWidth = 30;
      
      html += `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="transform -rotate-90">`;
      
      entries.forEach(([assignee, count], index) => {
        const percentage = (count / total) * 100;
        const angle = (count / total) * 360;
        const endAngle = currentAngle + angle;
        
        // T√≠nh to√°n cho arc
        const startRad = (currentAngle * Math.PI) / 180;
        const endRad = (endAngle * Math.PI) / 180;
        
        const x1 = center + radius * Math.cos(startRad);
        const y1 = center + radius * Math.sin(startRad);
        const x2 = center + radius * Math.cos(endRad);
        const y2 = center + radius * Math.sin(endRad);
        
        const largeArcFlag = angle > 180 ? 1 : 0;
        
        const color = colors[index % colors.length];
        
        // V·∫Ω arc
        html += `
          <path
            d="M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z"
            fill="${color}"
            stroke="white"
            stroke-width="3"
            class="hover:opacity-80 transition-opacity cursor-pointer"
            title="${escapeHtml(assignee)}: ${count} task (${percentage.toFixed(1)}%)"
          />
        `;
        
        currentAngle = endAngle;
      });
      
      html += '</svg>';
      
      // Th√™m legend - chia th√†nh 2 c·ªôt
      html += '<div class="grid grid-cols-2 gap-2 w-full max-w-2xl">';
      entries.forEach(([assignee, count], index) => {
        const percentage = ((count / total) * 100).toFixed(1);
        const color = colors[index % colors.length];
        html += `
          <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg transition-colors">
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 rounded" style="background-color: ${color}"></div>
              <span class="text-sm font-medium text-gray-900">${escapeHtml(assignee)}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-600">${count}</span>
              <span class="text-xs text-gray-500">(${percentage}%)</span>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      html += '</div>';
      chartDiv.innerHTML = html;
    }

    // H√†m render task ƒë·∫øn h·∫°n
    function renderF7DueTasks(dueTasks) {
      const container = document.getElementById('f7-due-tasks');
      if (!container) return;

      if (!Array.isArray(dueTasks) || dueTasks.length === 0) {
        container.innerHTML = '<div class="flex flex-col items-center justify-center h-full py-8"><p class="text-green-600 text-lg font-semibold">‚úì Kh√¥ng c√≥ task n√†o ƒë·∫øn h·∫°n</p><p class="text-gray-500 text-sm mt-2">T·∫•t c·∫£ task ƒë·ªÅu ƒë√∫ng h·∫°n</p></div>';
        return;
      }

      // Nh√≥m theo assignee
      const byAssignee = {};
      dueTasks.forEach(task => {
        if (!byAssignee[task.assignee]) {
          byAssignee[task.assignee] = [];
        }
        byAssignee[task.assignee].push(task);
      });

      let html = `<div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-red-600">warning</span>
          <span class="text-lg font-bold text-red-700">${dueTasks.length} task ƒë·∫øn h·∫°n</span>
        </div>
      </div>`;

      html += '<div class="space-y-3 max-h-[400px] overflow-y-auto">';

      Object.entries(byAssignee).sort((a, b) => b[1].length - a[1].length).forEach(([assignee, tasks]) => {
        html += `
          <div class="border border-red-200 rounded-lg p-3 bg-red-50/50">
            <div class="flex items-center justify-between mb-2">
              <span class="font-semibold text-gray-900">${escapeHtml(assignee)}</span>
              <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold">${tasks.length} task</span>
            </div>
            <div class="space-y-2">
        `;

        tasks.slice(0, 5).forEach(task => {
          const daysText = task.daysOverdue === 1 ? '1 ng√†y' : `${task.daysOverdue} ng√†y`;
          html += `
            <div class="bg-white rounded p-2 border border-red-100">
              <div class="flex items-start justify-between gap-2">
                <div class="flex-1 min-w-0">
                  <p class="text-xs font-medium text-gray-900 truncate" title="${escapeHtml(task.subtask)}">${escapeHtml(task.subtask)}</p>
                  ${task.taskCode ? `<p class="text-xs text-gray-500 mt-0.5">${escapeHtml(task.taskCode)}</p>` : ''}
                </div>
                <div class="flex flex-col items-end">
                  <span class="text-xs font-bold text-red-600">${daysText}</span>
                  <span class="text-xs text-gray-500">qu√° h·∫°n</span>
                </div>
              </div>
              <div class="mt-1 flex items-center gap-2">
                <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">${escapeHtml(task.status)}</span>
                ${task.workGroup ? `<span class="px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">${escapeHtml(task.workGroup)}</span>` : ''}
              </div>
            </div>
          `;
        });

        if (tasks.length > 5) {
          html += `<p class="text-xs text-gray-500 text-center pt-1">... v√† ${tasks.length - 5} task kh√°c</p>`;
        }

        html += `
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    // H√†m render chi ti·∫øt theo assignee
    // Bi·∫øn l∆∞u tr·ªØ assigneeDetails ƒë·ªÉ d√πng cho dropdown
    let F7_ASSIGNEE_DETAILS_DATA = {};

    function renderF7AssigneeDetails(assigneeDetails) {
      const container = document.getElementById('f7-assignee-details');
      const tagsContainer = document.getElementById('f7-assignee-tags');
      if (!container || !tagsContainer) return;

      // L∆∞u d·ªØ li·ªáu ƒë·ªÉ d√πng cho tags
      F7_ASSIGNEE_DETAILS_DATA = assigneeDetails;

      const entries = Object.entries(assigneeDetails).sort((a, b) => b[1].total - a[1].total);
      if (entries.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        tagsContainer.innerHTML = '';
        return;
      }

      // Render c√°c tag/button
      let tagsHtml = '';
      entries.forEach(([assignee, details]) => {
        tagsHtml += `
          <button 
            class="f7-assignee-tag px-4 py-2 rounded-lg text-sm font-medium transition-all border-2 border-gray-300 bg-white text-gray-700 hover:bg-blue-50 hover:border-blue-400 hover:text-blue-700"
            data-assignee="${escapeHtml(assignee)}"
          >
            ${escapeHtml(assignee)} <span class="text-xs text-gray-500">(${details.total})</span>
          </button>
        `;
      });
      tagsContainer.innerHTML = tagsHtml;

      // Th√™m event listeners cho c√°c tag
      tagsContainer.querySelectorAll('.f7-assignee-tag').forEach(tag => {
        tag.addEventListener('click', function() {
          const assignee = this.getAttribute('data-assignee');
          // X√≥a active state c·ªßa t·∫•t c·∫£ tags
          tagsContainer.querySelectorAll('.f7-assignee-tag').forEach(t => {
            t.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            t.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
          });
          // Th√™m active state cho tag ƒë∆∞·ª£c ch·ªçn
          this.classList.remove('border-gray-300', 'bg-white', 'text-gray-700', 'hover:bg-blue-50', 'hover:border-blue-400', 'hover:text-blue-700');
          this.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
          
          // Hi·ªÉn th·ªã chi ti·∫øt
          renderF7AssigneeDetailsForPerson(assignee, assigneeDetails);
        });
      });

      // N·∫øu ch∆∞a ch·ªçn ai, hi·ªÉn th·ªã th√¥ng b√°o
      container.innerHTML = '<p class="text-gray-500 text-center py-8">Vui l√≤ng ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán ƒë·ªÉ xem chi ti·∫øt</p>';
    }

    function renderF7AssigneeDetailsForPerson(assignee, assigneeDetails) {
      const container = document.getElementById('f7-assignee-details');
      if (!container) return;

      const details = assigneeDetails[assignee];
      if (!details) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</p>';
        return;
      }

      const completionRate = details.total > 0 ? Math.round((details.completed / details.total) * 100) : 0;
      const inProgressRate = details.total > 0 ? Math.round((details.inProgress / details.total) * 100) : 0;
      
      let html = `
        <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-bold text-gray-900">${escapeHtml(assignee)}</h4>
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">${details.total} task</span>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="text-center p-3 bg-purple-50 rounded-lg">
              <p class="text-xs text-purple-600 font-medium mb-1">Epic</p>
              <p class="text-2xl font-bold text-purple-700">${details.epics}</p>
            </div>
            <div class="text-center p-3 bg-blue-50 rounded-lg">
              <p class="text-xs text-blue-600 font-medium mb-1">Story</p>
              <p class="text-2xl font-bold text-blue-700">${details.stories}</p>
            </div>
            <div class="text-center p-3 bg-green-50 rounded-lg">
              <p class="text-xs text-green-600 font-medium mb-1">Subtask</p>
              <p class="text-2xl font-bold text-green-700">${details.subtasks}</p>
            </div>
            <div class="text-center p-3 bg-orange-50 rounded-lg">
              <p class="text-xs text-orange-600 font-medium mb-1">Work Groups</p>
              <p class="text-2xl font-bold text-orange-700">${details.workGroups}</p>
            </div>
          </div>

          <div class="space-y-2 mb-4">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">Ho√†n th√†nh</span>
              <span class="font-semibold text-green-600">${details.completed} (${completionRate}%)</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${completionRate}%"></div>
            </div>
          </div>

          <div class="space-y-2 mb-4">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">ƒêang tri·ªÉn khai</span>
              <span class="font-semibold text-blue-600">${details.inProgress} (${inProgressRate}%)</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${inProgressRate}%"></div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2">
            ${Object.entries(details.statusCount).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([status, count]) => {
              const statusLower = status.toLowerCase();
              let badgeClass = 'bg-gray-100 text-gray-700';
              if (statusLower.includes('ho√†n th√†nh') || statusLower.includes('done')) {
                badgeClass = 'bg-green-100 text-green-700';
              } else if (statusLower.includes('ƒëang') || statusLower.includes('progress')) {
                badgeClass = 'bg-blue-100 text-blue-700';
              } else if (statusLower.includes('ch∆∞a') || statusLower.includes('pending')) {
                badgeClass = 'bg-yellow-100 text-yellow-700';
              } else if (statusLower.includes('h·ªßy') || statusLower.includes('cancel')) {
                badgeClass = 'bg-red-100 text-red-700';
              }
              return `<span class="px-2 py-1 rounded text-xs font-medium ${badgeClass}">${escapeHtml(status)}: ${count}</span>`;
            }).join('')}
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // H√†m render workload theo assignee
    function renderF7AssigneeWorkload(assigneeWorkload) {
      const container = document.getElementById('f7-assignee-workload');
      if (!container) return;

      const entries = Object.entries(assigneeWorkload).sort((a, b) => b[1].active - a[1].active);
      if (entries.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }

      let html = '<div class="space-y-3">';
      
      entries.forEach(([assignee, workload]) => {
        const activeRate = workload.total > 0 ? Math.round((workload.active / workload.total) * 100) : 0;
        const completedRate = workload.total > 0 ? Math.round((workload.completed / workload.total) * 100) : 0;
        
        html += `
          <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-3">
              <span class="font-semibold text-gray-900">${escapeHtml(assignee)}</span>
              <span class="text-sm text-gray-600">T·ªïng: ${workload.total}</span>
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between text-sm">
                <span class="text-blue-600">ƒêang l√†m</span>
                <span class="font-semibold">${workload.active} (${activeRate}%)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-blue-500 h-2.5 rounded-full transition-all" style="width: ${activeRate}%"></div>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="text-green-600">ƒê√£ ho√†n th√†nh</span>
                <span class="font-semibold">${workload.completed} (${completedRate}%)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-green-500 h-2.5 rounded-full transition-all" style="width: ${completedRate}%"></div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // H√†m render ti·∫øn ƒë·ªô theo assignee - Bi·ªÉu ƒë·ªì c·ªôt (l√†m l·∫°i t·ª´ ƒë·∫ßu)
    function renderF7AssigneeProgress(assigneeProgress) {
      const container = document.getElementById('f7-assignee-progress');
      if (!container) return;

      const entries = Object.entries(assigneeProgress).sort((a, b) => b[1].rate - a[1].rate);
      if (entries.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }

      const maxRate = 100; // Lu√¥n d√πng 100% l√†m max ƒë·ªÉ so s√°nh c√¥ng b·∫±ng
      const chartHeight = 150;
      const barWidthPercent = Math.min(8, 100 / entries.length); // T·ªëi ƒëa 8% m·ªói c·ªôt
      
      let html = '<div class="w-full flex flex-col" style="height: ' + (chartHeight + 50) + 'px;">';
      
      // Container ch·ª©a c√°c c·ªôt - d√πng relative ƒë·ªÉ ƒë·∫∑t border ƒë√∫ng v·ªã tr√≠
      html += '<div class="flex-1 relative" style="height: ' + chartHeight + 'px;">';
      // V·∫Ω ƒë∆∞·ªùng m·ªëc 0% - ƒë·∫∑t ·ªü ƒë√∫ng bottom
      html += '<div style="position: absolute; left: 0; right: 0; bottom: 0; height: 2px; background-color: #d1d5db; margin: 0; padding: 0;"></div>';
      // Container flex ch·ª©a c·ªôt - cƒÉn v·ªõi bottom (ch·∫°m v√†o ƒë∆∞·ªùng 0%)
      html += '<div class="flex justify-between gap-1" style="position: absolute; left: 0; right: 0; bottom: 0; height: ' + chartHeight + 'px; align-items: flex-end; margin: 0; padding: 0;">';
      
      entries.forEach(([assignee, progress]) => {
        const rate = progress.rate;
        const barHeight = (rate / maxRate) * chartHeight;
        
        let colorClass = 'bg-gray-400';
        if (rate >= 80) {
          colorClass = 'bg-green-500';
        } else if (rate >= 50) {
          colorClass = 'bg-blue-500';
        } else if (rate >= 30) {
          colorClass = 'bg-yellow-500';
        } else {
          colorClass = 'bg-red-500';
        }
        
        html += `
          <div class="flex flex-col items-center" style="width: ${barWidthPercent}%; max-width: ${barWidthPercent}%; flex: 0 0 ${barWidthPercent}%; align-items: flex-end;">
            <div class="w-full ${colorClass} rounded-t hover:opacity-80 transition-opacity cursor-pointer relative" style="height: ${barHeight}px; min-height: ${barHeight > 0 ? '4px' : '0'}; margin: 0; padding: 0; border: none;" title="${escapeHtml(assignee)}: ${rate}% (${progress.completed}/${progress.total})">
              ${barHeight >= 20 ? `<span class="absolute top-1 left-1/2 transform -translate-x-1/2 text-white text-[10px] font-bold">${rate}%</span>` : ''}
            </div>
          </div>
        `;
      });
      
      html += '</div></div>';
      
      // Container cho labels b√™n d∆∞·ªõi
      html += '<div class="flex justify-between gap-1 mt-2" style="height: 40px;">';
      entries.forEach(([assignee, progress]) => {
        html += `
          <div class="flex flex-col items-center justify-start flex-1 min-w-0 text-center px-1" style="max-width: ${barWidthPercent}%;">
            <p class="text-[10px] font-medium text-gray-900 truncate w-full" title="${escapeHtml(assignee)}">${escapeHtml(assignee)}</p>
            <p class="text-[9px] text-gray-600 mt-0.5">${progress.completed}/${progress.total}</p>
          </div>
        `;
      });
      html += '</div>';
      
      html += '</div>';
      
      container.innerHTML = html;
    }

    // H√†m render chart work group
    function renderF7WorkGroupChart(workGroupCount) {
      const chartDiv = document.getElementById('f7-chart-workgroup');
      if (!chartDiv) return;

      const entries = Object.entries(workGroupCount).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        chartDiv.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }

      const maxCount = Math.max(...entries.map(e => e[1]));
      let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
      
      entries.forEach(([workGroup, count]) => {
        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
        html += `
          <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">${escapeHtml(workGroup)}</span>
              <span class="text-sm font-bold text-gray-900">${count}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-purple-500 h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      chartDiv.innerHTML = html;
    }

    // H√†m render b·∫£ng tr·∫°ng th√°i
    function renderF7StatusTable(statusCount, totalSubtasks) {
      const tbody = document.getElementById('f7-status-table-body');
      if (!tbody) return;

      const entries = Object.entries(statusCount).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="px-2 py-3 text-center text-gray-500 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        return;
      }

      let html = '';
      entries.forEach(([status, count]) => {
        const percentage = totalSubtasks > 0 ? Math.round((count / totalSubtasks) * 100) : 0;
        const statusLower = String(status).toLowerCase();
        let badgeClass = 'bg-gray-100 text-gray-700';
        
        if (statusLower.includes('ho√†n th√†nh') || statusLower.includes('done') || statusLower.includes('completed')) {
          badgeClass = 'bg-green-100 text-green-700';
        } else if (statusLower.includes('ƒëang') || statusLower.includes('progress') || statusLower.includes('tri·ªÉn khai')) {
          badgeClass = 'bg-blue-100 text-blue-700';
        } else if (statusLower.includes('ch∆∞a') || statusLower.includes('pending') || statusLower.includes('to do')) {
          badgeClass = 'bg-yellow-100 text-yellow-700';
        } else if (statusLower.includes('h·ªßy') || statusLower.includes('cancel')) {
          badgeClass = 'bg-red-100 text-red-700';
        }
        
        html += `
          <tr class="hover:bg-gray-50">
            <td class="px-2 py-1.5">
              <span class="px-1.5 py-0.5 rounded text-xs font-medium ${badgeClass}">${escapeHtml(status)}</span>
            </td>
            <td class="px-2 py-1.5 text-xs font-medium text-gray-900">${count}</td>
            <td class="px-2 py-1.5 text-xs text-gray-600 font-semibold">${percentage}%</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // H√†m t·∫£i v√† render dashboard
    async function loadF7Dashboard() {
      const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/form3quanlyduannhomSPM';
      const refreshBtn = document.getElementById('f7-refresh-btn');

      try {
        if (refreshBtn) refreshBtn.disabled = true;

        const response = await fetch(webhookUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const responseText = await response.text();
        let data = JSON.parse(responseText);

        // X·ª≠ l√Ω nhi·ªÅu format response - d·ªØ li·ªáu flat nh∆∞ Form 3
        let flatData = [];
        if (Array.isArray(data)) {
          flatData = data;
        } else if (data && Array.isArray(data.data)) {
          flatData = data.data;
        } else if (data && Array.isArray(data.results)) {
          flatData = data.results;
        } else if (data && Array.isArray(data.items)) {
          flatData = data.items;
        } else if (data && typeof data === 'object') {
          flatData = [data];
        }

        F7_ALL_DATA = flatData;
        const stats = calculateF7Stats(flatData);

        // Render t·∫•t c·∫£ components
        renderF7StatsCards(stats);
        renderF7AssigneeChart(stats.assigneeCount);
        renderF7StatusTable(stats.statusCount, stats.totalSubtasks);
        renderF7AssigneeDetails(stats.assigneeDetails);
        renderF7AssigneeProgress(stats.assigneeProgress);
        renderF7DueTasks(stats.dueTasks);

        showToast(`ƒê√£ t·∫£i ${flatData.length} b·∫£n ghi th√†nh c√¥ng`, 'success');

      } catch (error) {
        console.error('[Form 7] Error loading dashboard:', error);
        showToast('L·ªói khi t·∫£i dashboard: ' + error.message, 'error');
      } finally {
        if (refreshBtn) refreshBtn.disabled = false;
      }
    }

    // Kh·ªüi t·∫°o Form 7
    document.addEventListener('DOMContentLoaded', function() {
      const refreshBtn = document.getElementById('f7-refresh-btn');
      
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadF7Dashboard);
      }

      // Event listeners cho tags ƒë√£ ƒë∆∞·ª£c th√™m trong h√†m renderF7AssigneeDetails

      // T·ª± ƒë·ªông load khi form ƒë∆∞·ª£c hi·ªÉn th·ªã
      const form7Section = document.getElementById('form7');
      if (form7Section) {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              if (!form7Section.classList.contains('hidden')) {
                loadF7Dashboard();
              }
            }
          });
        });
        observer.observe(form7Section, { attributes: true });
      }
    });

    // ===== FORM 8 - CALENDAR VIEW =====
    
    let F8_ALL_DATA = [];
    let F8_CURRENT_DATE = new Date();
    let F8_VIEW_MODE = 'month'; // 'month' or 'week'
    let F8_FILTER_ASSIGNEE = '';
    let F8_FILTER_STATUS = '';
    let F8_SEARCH_TEXT = '';

    // H√†m format date
    function formatDate(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // H√†m parse date t·ª´ string
    function parseDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split('-');
      if (parts.length !== 3) return null;
      return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    }

    // H√†m l·∫•y t√™n th√°ng ti·∫øng Vi·ªát
    function getMonthName(month) {
      const months = ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3', 'Th√°ng 4', 'Th√°ng 5', 'Th√°ng 6', 
                      'Th√°ng 7', 'Th√°ng 8', 'Th√°ng 9', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];
      return months[month];
    }

    // H√†m l·ªçc d·ªØ li·ªáu theo filter
    function filterF8Data(data) {
      return data.filter(record => {
        // CH·ªà hi·ªÉn th·ªã subtask, b·ªè qua epic v√† story
        const level = (record.level || '').toLowerCase();
        if (level !== 'subtask') {
          return false;
        }
        
        // Filter theo assignee
        if (F8_FILTER_ASSIGNEE && record.assignee !== F8_FILTER_ASSIGNEE) {
          return false;
        }
        
        // Filter theo status
        if (F8_FILTER_STATUS && record.status !== F8_FILTER_STATUS) {
          return false;
        }
        
        // Filter theo search text
        if (F8_SEARCH_TEXT) {
          const searchLower = F8_SEARCH_TEXT.toLowerCase();
          const subtask = (record.subtask || '').toLowerCase();
          const taskCode = (record.task_code || '').toLowerCase();
          if (!subtask.includes(searchLower) && !taskCode.includes(searchLower)) {
            return false;
          }
        }
        
        return true;
      });
    }

    // H√†m render calendar week view
    function renderF8WeekView() {
      const calendarBody = document.getElementById('f8-calendar-body');
      const monthTitle = document.getElementById('f8-month-title');
      if (!calendarBody || !monthTitle) return;

      const year = F8_CURRENT_DATE.getFullYear();
      const month = F8_CURRENT_DATE.getMonth();
      const day = F8_CURRENT_DATE.getDate();
      
      // T√≠nh ng√†y ƒë·∫ßu tu·∫ßn (Ch·ªß nh·∫≠t)
      const currentDate = new Date(year, month, day);
      const dayOfWeek = currentDate.getDay(); // 0 = CN, 1 = T2, ...
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(day - dayOfWeek);
      
      // T√≠nh ng√†y cu·ªëi tu·∫ßn (Th·ª© 7)
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      
      // C·∫≠p nh·∫≠t title - chu·∫©n h√≥a format
      const startMonth = getMonthName(startOfWeek.getMonth());
      const endMonth = getMonthName(endOfWeek.getMonth());
      const startYear = startOfWeek.getFullYear();
      const endYear = endOfWeek.getFullYear();
      const startDay = startOfWeek.getDate();
      const endDay = endOfWeek.getDate();
      
      if (startOfWeek.getMonth() === endOfWeek.getMonth() && startYear === endYear) {
        // C√πng th√°ng, c√πng nƒÉm: "Th√°ng X YYYY t·ª´ ng√†y DD ƒë·∫øn ng√†y DD"
        monthTitle.textContent = `${startMonth} ${startYear} t·ª´ ng√†y ${startDay} ƒë·∫øn ng√†y ${endDay}`;
      } else if (startYear === endYear) {
        // Kh√°c th√°ng, c√πng nƒÉm: "Th√°ng X DD - Th√°ng Y DD, YYYY"
        monthTitle.textContent = `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${startYear}`;
      } else {
        // Kh√°c nƒÉm: "Th√°ng X DD, YYYY - Th√°ng Y DD, YYYY"
        monthTitle.textContent = `${startMonth} ${startDay}, ${startYear} - ${endMonth} ${endDay}, ${endYear}`;
      }

      // L·ªçc d·ªØ li·ªáu
      const filteredData = filterF8Data(F8_ALL_DATA);
      
      // Nh√≥m d·ªØ li·ªáu theo ng√†y - x·ª≠ l√Ω c·∫£ start_date v√† due_date
      const tasksByDate = groupTasksByDate(filteredData);

      // Render calendar week
      let html = '';
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Render 7 ng√†y trong tu·∫ßn
      for (let i = 0; i < 7; i++) {
        const currentDate = new Date(startOfWeek);
        currentDate.setDate(startOfWeek.getDate() + i);
        const dateKey = formatDate(currentDate);
        const isToday = currentDate.getTime() === today.getTime();
        const tasks = tasksByDate[dateKey] || [];
        const dayNumber = currentDate.getDate();
        const dayName = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][i];
        
        html += `<div class="border-r border-b border-gray-200 p-2 space-y-1.5 min-h-[200px]">`;
        
        // Header ng√†y
        html += `<div class="text-right mb-2">`;
        if (isToday) {
          html += `<div class="inline-flex items-center justify-center text-sm font-bold text-white bg-primary rounded-full size-6">${dayNumber}</div>`;
        } else {
          html += `<span class="text-sm font-medium text-gray-900">${dayNumber}</span>`;
        }
        html += `<div class="text-xs text-gray-500 mt-1">${dayName}</div>`;
        html += `</div>`;
        
        // Render T·∫§T C·∫¢ tasks trong ng√†y
        if (tasks.length === 0) {
          html += `<div class="text-xs text-gray-400 text-center py-4">Kh√¥ng c√≥ c√¥ng vi·ªác</div>`;
        } else {
          tasks.forEach(task => {
            const status = (task.status || '').toLowerCase();
            let bgColor = 'bg-blue-100';
            let textColor = 'text-blue-800';
            let statusText = task.status || 'Ch∆∞a x√°c ƒë·ªãnh';
            
            if (status.includes('xong') || status.includes('done') || status.includes('ho√†n th√†nh')) {
              bgColor = 'bg-green-100';
              textColor = 'text-green-800';
            } else if (status.includes('ƒëang') || status.includes('progress') || status.includes('l√†m')) {
              bgColor = 'bg-blue-100';
              textColor = 'text-blue-800';
            } else if (status.includes('h·ªßy') || status.includes('cancel')) {
              bgColor = 'bg-red-100';
              textColor = 'text-red-800';
            }
            
            const assignee = task.assignee || '';
            const assigneeInitials = assignee.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const subtask = (task.subtask || '').substring(0, 40);
            
            html += `
              <a class="block p-2 text-left rounded-lg ${bgColor} hover:ring-2 hover:ring-primary transition-all cursor-pointer space-y-1 mb-1" href="#" title="${escapeHtml(task.subtask || '')}">
                <p class="text-xs font-bold ${textColor}">${escapeHtml(subtask)}</p>
                <div class="flex items-center justify-between text-xs">
                  <div class="flex items-center gap-1.5 ${textColor}">
                    <div class="bg-gray-400 rounded-full size-4 flex items-center justify-center text-white text-[10px] font-bold">${escapeHtml(assigneeInitials)}</div>
                    <span class="truncate">${escapeHtml(assignee)}</span>
                  </div>
                  <span class="px-1.5 py-0.5 rounded-full ${bgColor} ${textColor} font-medium text-[10px] whitespace-nowrap">${escapeHtml(statusText)}</span>
                </div>
              </a>
            `;
          });
        }
        
        html += '</div>';
      }

      calendarBody.innerHTML = html;
    }

    // H√†m nh√≥m task theo ng√†y - x·ª≠ l√Ω c·∫£ start_date v√† due_date
    function groupTasksByDate(filteredData) {
      const tasksByDate = {};
      
      filteredData.forEach(record => {
        const startDate = record.start_date || record.begin_date || record.startDate || '';
        const dueDate = record.due_date || record.end_date || record.dueDate || record.endDate || '';
        
        // N·∫øu c√≥ c·∫£ start_date v√† due_date, hi·ªÉn th·ªã ·ªü t·∫•t c·∫£ c√°c ng√†y trong kho·∫£ng
        if (startDate && dueDate) {
          const start = parseDate(startDate);
          const end = parseDate(dueDate);
          
          if (start && end) {
            // ƒê·∫£m b·∫£o start <= end
            const actualStart = start <= end ? start : end;
            const actualEnd = start <= end ? end : start;
            
            // Th√™m task v√†o t·∫•t c·∫£ c√°c ng√†y t·ª´ start ƒë·∫øn end
            const currentDate = new Date(actualStart);
            while (currentDate <= actualEnd) {
              const dateKey = formatDate(currentDate);
              if (!tasksByDate[dateKey]) {
                tasksByDate[dateKey] = [];
              }
              // Ki·ªÉm tra tr√πng l·∫∑p tr∆∞·ªõc khi th√™m
              const exists = tasksByDate[dateKey].some(t => 
                t.subtask === record.subtask && 
                t.task_code === record.task_code &&
                t.assignee === record.assignee
              );
              if (!exists) {
                tasksByDate[dateKey].push(record);
              }
              
              // TƒÉng l√™n ng√†y ti·∫øp theo
              currentDate.setDate(currentDate.getDate() + 1);
            }
          }
        } 
        // N·∫øu ch·ªâ c√≥ due_date, ch·ªâ hi·ªÉn th·ªã ·ªü ng√†y ƒë√≥
        else if (dueDate) {
          const date = parseDate(dueDate);
          if (date) {
            const dateKey = formatDate(date);
            if (!tasksByDate[dateKey]) {
              tasksByDate[dateKey] = [];
            }
            // Ki·ªÉm tra tr√πng l·∫∑p
            const exists = tasksByDate[dateKey].some(t => 
              t.subtask === record.subtask && 
              t.task_code === record.task_code &&
              t.assignee === record.assignee
            );
            if (!exists) {
              tasksByDate[dateKey].push(record);
            }
          }
        }
        // N·∫øu ch·ªâ c√≥ start_date, hi·ªÉn th·ªã t·ª´ start_date ƒë·∫øn start_date + 7 ng√†y
        else if (startDate) {
          const start = parseDate(startDate);
          if (start) {
            const end = new Date(start);
            end.setDate(end.getDate() + 7); // M·∫∑c ƒë·ªãnh 7 ng√†y n·∫øu kh√¥ng c√≥ due_date
            
            const currentDate = new Date(start);
            while (currentDate <= end) {
              const dateKey = formatDate(currentDate);
              if (!tasksByDate[dateKey]) {
                tasksByDate[dateKey] = [];
              }
              // Ki·ªÉm tra tr√πng l·∫∑p
              const exists = tasksByDate[dateKey].some(t => 
                t.subtask === record.subtask && 
                t.task_code === record.task_code &&
                t.assignee === record.assignee
              );
              if (!exists) {
                tasksByDate[dateKey].push(record);
              }
              
              currentDate.setDate(currentDate.getDate() + 1);
            }
          }
        }
        // N·∫øu kh√¥ng c√≥ date n√†o, b·ªè qua task n√†y (kh√¥ng hi·ªÉn th·ªã)
      });
      
      return tasksByDate;
    }

    // H√†m render calendar d·ª±a tr√™n view mode
    function renderF8Calendar() {
      const calendarBody = document.getElementById('f8-calendar-body');
      if (calendarBody) {
        if (F8_VIEW_MODE === 'week') {
          calendarBody.className = 'grid grid-cols-7 flex-1';
          renderF8WeekView();
        } else {
          calendarBody.className = 'grid grid-cols-7 grid-rows-5 flex-1';
          renderF8MonthView();
        }
      }
    }

    // ƒê·ªïi t√™n h√†m render month view
    function renderF8MonthView() {
      const calendarBody = document.getElementById('f8-calendar-body');
      const monthTitle = document.getElementById('f8-month-title');
      if (!calendarBody || !monthTitle) return;

      const year = F8_CURRENT_DATE.getFullYear();
      const month = F8_CURRENT_DATE.getMonth();
      
      // C·∫≠p nh·∫≠t title - chu·∫©n h√≥a format
      monthTitle.textContent = `${getMonthName(month)} ${year}`;

      // L·∫•y ng√†y ƒë·∫ßu ti√™n v√† cu·ªëi c√πng c·ªßa th√°ng
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDay = firstDay.getDay(); // 0 = CN, 1 = T2, ...

      // L·ªçc d·ªØ li·ªáu
      const filteredData = filterF8Data(F8_ALL_DATA);
      
      // Nh√≥m d·ªØ li·ªáu theo ng√†y - x·ª≠ l√Ω c·∫£ start_date v√† due_date
      const tasksByDate = groupTasksByDate(filteredData);

      // Render calendar
      let html = '';
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Th√™m c√°c √¥ tr·ªëng ·ªü ƒë·∫ßu th√°ng
      for (let i = 0; i < startDay; i++) {
        html += '<div class="border-r border-b border-gray-200 p-1 text-right"></div>';
      }

      // Render c√°c ng√†y trong th√°ng
      for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        const dateKey = formatDate(currentDate);
        const isToday = currentDate.getTime() === today.getTime();
        const tasks = tasksByDate[dateKey] || [];
        const maxTasksToShow = 3; // Gi·ªõi h·∫°n hi·ªÉn th·ªã 3 task
        const tasksToShow = tasks.slice(0, maxTasksToShow);
        const remainingTasks = tasks.length - maxTasksToShow;
        
        html += `<div class="border-r border-b border-gray-200 p-1 space-y-0.5 min-h-[80px]">`;
        
        // S·ªë ng√†y
        if (isToday) {
          html += `<div class="text-right mb-1"><span class="inline-flex items-center justify-center text-xs font-bold text-white bg-primary rounded-full size-5">${day}</span></div>`;
        } else {
          html += `<div class="text-right mb-1"><span class="text-xs font-medium text-gray-900">${day}</span></div>`;
        }
        
        // Render tasks (t·ªëi ƒëa 3 task)
        tasksToShow.forEach(task => {
          const status = (task.status || '').toLowerCase();
          let bgColor = 'bg-blue-100';
          let textColor = 'text-blue-800';
          let statusText = task.status || 'Ch∆∞a x√°c ƒë·ªãnh';
          
          if (status.includes('xong') || status.includes('done') || status.includes('ho√†n th√†nh')) {
            bgColor = 'bg-green-100';
            textColor = 'text-green-800';
          } else if (status.includes('ƒëang') || status.includes('progress') || status.includes('l√†m')) {
            bgColor = 'bg-blue-100';
            textColor = 'text-blue-800';
          } else if (status.includes('h·ªßy') || status.includes('cancel')) {
            bgColor = 'bg-red-100';
            textColor = 'text-red-800';
          }
          
          const assignee = task.assignee || '';
          const assigneeInitials = assignee.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
          const subtask = (task.subtask || '').substring(0, 25);
          
          html += `
            <a class="block p-1 text-left rounded ${bgColor} hover:ring-1 hover:ring-primary transition-all cursor-pointer" href="#" title="${escapeHtml(task.subtask || '')}">
              <p class="text-[10px] font-semibold ${textColor} leading-tight truncate">${escapeHtml(subtask)}</p>
              <div class="flex items-center justify-between mt-0.5">
                <div class="bg-gray-400 rounded-full size-3 flex items-center justify-center text-white text-[8px] font-bold" title="${escapeHtml(assignee)}">${escapeHtml(assigneeInitials)}</div>
                <span class="px-1 py-0.5 rounded ${bgColor} ${textColor} font-medium text-[9px] truncate max-w-[60px]">${escapeHtml(statusText)}</span>
              </div>
            </a>
          `;
        });
        
        // Hi·ªÉn th·ªã s·ªë task c√≤n l·∫°i n·∫øu c√≥
        if (remainingTasks > 0) {
          html += `<div class="text-[9px] text-gray-500 text-center py-0.5">+${remainingTasks} c√¥ng vi·ªác</div>`;
        }
        
        html += '</div>';
      }

      // Th√™m c√°c √¥ tr·ªëng ·ªü cu·ªëi th√°ng ƒë·ªÉ ƒë·ªß 35 √¥ (5 h√†ng x 7 c·ªôt)
      const totalCells = startDay + daysInMonth;
      const remainingCells = 35 - totalCells;
      const nextMonth = month + 1;
      const nextYear = nextMonth > 11 ? year + 1 : year;
      const actualNextMonth = nextMonth > 11 ? 0 : nextMonth;
      
      for (let i = 0; i < remainingCells; i++) {
        const nextMonthDay = i + 1;
        html += `<div class="border-r border-gray-200 p-1 text-right"><span class="text-xs font-medium text-gray-400">${nextMonthDay}</span></div>`;
      }

      calendarBody.innerHTML = html;
    }

    // H√†m t·∫£i d·ªØ li·ªáu cho Form 8
    async function loadF8Calendar() {
      // S·ª≠ d·ª•ng l·∫°i d·ªØ li·ªáu t·ª´ Form 7 n·∫øu ƒë√£ c√≥
      if (F7_ALL_DATA && F7_ALL_DATA.length > 0) {
        F8_ALL_DATA = F7_ALL_DATA;
        renderF8Calendar();
        return;
      }

      const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/form3quanlyduannhomSPM';
      const refreshBtn = document.getElementById('f8-refresh-btn');

      try {
        if (refreshBtn) refreshBtn.disabled = true;

        const response = await fetch(webhookUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const responseText = await response.text();
        let data = JSON.parse(responseText);

        // X·ª≠ l√Ω nhi·ªÅu format response
        let flatData = [];
        if (Array.isArray(data)) {
          flatData = data;
        } else if (data && Array.isArray(data.data)) {
          flatData = data.data;
        } else if (data && Array.isArray(data.results)) {
          flatData = data.results;
        } else if (data && Array.isArray(data.items)) {
          flatData = data.items;
        } else if (data && typeof data === 'object') {
          flatData = [data];
        }

        F8_ALL_DATA = flatData;
        renderF8Calendar();

        showToast(`ƒê√£ t·∫£i ${flatData.length} b·∫£n ghi th√†nh c√¥ng`, 'success');

      } catch (error) {
        console.error('[Form 8] Error loading calendar:', error);
        showToast('L·ªói khi t·∫£i calendar: ' + error.message, 'error');
      } finally {
        if (refreshBtn) refreshBtn.disabled = false;
      }
    }

    // H√†m hi·ªÉn th·ªã dropdown filter ng∆∞·ªùi ph·ª• tr√°ch
    function showF8AssigneeFilter(button) {
      closeF8FilterDropdowns();
      
      // L·∫•y danh s√°ch assignees t·ª´ d·ªØ li·ªáu
      const assignees = new Set();
      F8_ALL_DATA.forEach(record => {
        const assignee = (record.assignee || '').trim();
        if (assignee) {
          assignees.add(assignee);
        }
      });
      
      const assigneesList = Array.from(assignees).sort();
      
      // T·∫°o dropdown
      const dropdown = document.createElement('div');
      dropdown.id = 'f8-assignee-dropdown';
      dropdown.className = 'fixed z-50 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 max-h-60 overflow-y-auto';
      const rect = button.getBoundingClientRect();
      dropdown.style.top = (rect.bottom + 5) + 'px';
      dropdown.style.left = rect.left + 'px';
      
      let html = '<div class="p-2">';
      html += '<div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase border-b border-gray-200">Ng∆∞·ªùi ph·ª• tr√°ch</div>';
      
      // N√∫t "T·∫•t c·∫£"
      html += `<div class="px-3 py-2 cursor-pointer hover:bg-gray-100 rounded ${!F8_FILTER_ASSIGNEE ? 'bg-blue-50 text-primary font-semibold' : ''}" data-value="">
        <span class="text-sm">T·∫•t c·∫£</span>
      </div>`;
      
      // Danh s√°ch assignees
      assigneesList.forEach(assignee => {
        html += `<div class="px-3 py-2 cursor-pointer hover:bg-gray-100 rounded ${F8_FILTER_ASSIGNEE === assignee ? 'bg-blue-50 text-primary font-semibold' : ''}" data-value="${escapeHtml(assignee)}">
          <span class="text-sm">${escapeHtml(assignee)}</span>
        </div>`;
      });
      
      html += '</div>';
      dropdown.innerHTML = html;
      
      // Th√™m v√†o body
      document.body.appendChild(dropdown);
      
      // Event listeners cho c√°c option
      dropdown.querySelectorAll('[data-value]').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const value = option.getAttribute('data-value');
          F8_FILTER_ASSIGNEE = value || '';
          updateF8FilterButtonUI('assignee', F8_FILTER_ASSIGNEE);
          closeF8FilterDropdowns();
          renderF8Calendar();
        });
      });
    }

    // H√†m hi·ªÉn th·ªã dropdown filter tr·∫°ng th√°i
    function showF8StatusFilter(button) {
      closeF8FilterDropdowns();
      
      // L·∫•y danh s√°ch statuses t·ª´ d·ªØ li·ªáu
      const statuses = new Set();
      F8_ALL_DATA.forEach(record => {
        const status = (record.status || '').trim();
        if (status) {
          statuses.add(status);
        }
      });
      
      const statusesList = Array.from(statuses).sort();
      
      // T·∫°o dropdown
      const dropdown = document.createElement('div');
      dropdown.id = 'f8-status-dropdown';
      dropdown.className = 'fixed z-50 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 max-h-60 overflow-y-auto';
      const rect = button.getBoundingClientRect();
      dropdown.style.top = (rect.bottom + 5) + 'px';
      dropdown.style.left = rect.left + 'px';
      
      let html = '<div class="p-2">';
      html += '<div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase border-b border-gray-200">Tr·∫°ng th√°i</div>';
      
      // N√∫t "T·∫•t c·∫£"
      html += `<div class="px-3 py-2 cursor-pointer hover:bg-gray-100 rounded ${!F8_FILTER_STATUS ? 'bg-blue-50 text-primary font-semibold' : ''}" data-value="">
        <span class="text-sm">T·∫•t c·∫£</span>
      </div>`;
      
      // Danh s√°ch statuses
      statusesList.forEach(status => {
        html += `<div class="px-3 py-2 cursor-pointer hover:bg-gray-100 rounded ${F8_FILTER_STATUS === status ? 'bg-blue-50 text-primary font-semibold' : ''}" data-value="${escapeHtml(status)}">
          <span class="text-sm">${escapeHtml(status)}</span>
        </div>`;
      });
      
      html += '</div>';
      dropdown.innerHTML = html;
      
      // Th√™m v√†o body
      document.body.appendChild(dropdown);
      
      // Event listeners cho c√°c option
      dropdown.querySelectorAll('[data-value]').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const value = option.getAttribute('data-value');
          F8_FILTER_STATUS = value || '';
          updateF8FilterButtonUI('status', F8_FILTER_STATUS);
          closeF8FilterDropdowns();
          renderF8Calendar();
        });
      });
    }

    // H√†m ƒë√≥ng t·∫•t c·∫£ dropdowns
    function closeF8FilterDropdowns() {
      const assigneeDropdown = document.getElementById('f8-assignee-dropdown');
      const statusDropdown = document.getElementById('f8-status-dropdown');
      if (assigneeDropdown) assigneeDropdown.remove();
      if (statusDropdown) statusDropdown.remove();
    }

    // H√†m c·∫≠p nh·∫≠t UI c·ªßa n√∫t filter
    function updateF8FilterButtonUI(type, value) {
      if (type === 'assignee') {
        const btn = document.getElementById('f8-filter-assignee');
        if (btn) {
          // T√¨m span ch·ª©a text (kh√¥ng ph·∫£i icon)
          const spans = btn.querySelectorAll('span');
          let textSpan = null;
          spans.forEach(span => {
            if (!span.classList.contains('material-symbols-outlined') && span.textContent.trim() === 'Ng∆∞·ªùi ph·ª• tr√°ch') {
              textSpan = span;
            }
          });
          
          if (value) {
            btn.classList.add('bg-blue-50', 'border-blue-300', 'text-primary');
            btn.classList.remove('bg-white', 'text-gray-700');
            if (textSpan) {
              textSpan.textContent = value.length > 15 ? value.substring(0, 15) + '...' : value;
            }
          } else {
            btn.classList.remove('bg-blue-50', 'border-blue-300', 'text-primary');
            btn.classList.add('bg-white', 'text-gray-700');
            if (textSpan) {
              textSpan.textContent = 'Ng∆∞·ªùi ph·ª• tr√°ch';
            }
          }
        }
      } else if (type === 'status') {
        const btn = document.getElementById('f8-filter-status');
        if (btn) {
          // T√¨m span ch·ª©a text (kh√¥ng ph·∫£i icon)
          const spans = btn.querySelectorAll('span');
          let textSpan = null;
          spans.forEach(span => {
            if (!span.classList.contains('material-symbols-outlined') && span.textContent.trim() === 'Tr·∫°ng th√°i') {
              textSpan = span;
            }
          });
          
          if (value) {
            btn.classList.add('bg-blue-50', 'border-blue-300', 'text-primary');
            btn.classList.remove('bg-white', 'text-gray-700');
            if (textSpan) {
              textSpan.textContent = value.length > 15 ? value.substring(0, 15) + '...' : value;
            }
          } else {
            btn.classList.remove('bg-blue-50', 'border-blue-300', 'text-primary');
            btn.classList.add('bg-white', 'text-gray-700');
            if (textSpan) {
              textSpan.textContent = 'Tr·∫°ng th√°i';
            }
          }
        }
      }
    }

    // Kh·ªüi t·∫°o Form 8
    document.addEventListener('DOMContentLoaded', function() {
      const refreshBtn = document.getElementById('f8-refresh-btn');
      const prevBtn = document.getElementById('f8-prev-month');
      const nextBtn = document.getElementById('f8-next-month');
      const todayBtn = document.getElementById('f8-today');
      const viewMonthBtn = document.getElementById('f8-view-month');
      const viewWeekBtn = document.getElementById('f8-view-week');
      const searchInput = document.getElementById('f8-search');

      // Refresh button
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadF8Calendar);
      }

      // Navigation buttons
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (F8_VIEW_MODE === 'week') {
            // Tu·∫ßn tr∆∞·ªõc
            F8_CURRENT_DATE.setDate(F8_CURRENT_DATE.getDate() - 7);
          } else {
            // Th√°ng tr∆∞·ªõc
            F8_CURRENT_DATE.setMonth(F8_CURRENT_DATE.getMonth() - 1);
          }
          renderF8Calendar();
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (F8_VIEW_MODE === 'week') {
            // Tu·∫ßn sau
            F8_CURRENT_DATE.setDate(F8_CURRENT_DATE.getDate() + 7);
          } else {
            // Th√°ng sau
            F8_CURRENT_DATE.setMonth(F8_CURRENT_DATE.getMonth() + 1);
          }
          renderF8Calendar();
        });
      }

      if (todayBtn) {
        todayBtn.addEventListener('click', () => {
          F8_CURRENT_DATE = new Date();
          renderF8Calendar();
        });
      }

      // View mode buttons
      if (viewMonthBtn) {
        viewMonthBtn.addEventListener('click', () => {
          F8_VIEW_MODE = 'month';
          viewMonthBtn.classList.add('bg-white', 'text-primary', 'shadow-sm');
          viewMonthBtn.classList.remove('text-gray-600');
          viewWeekBtn.classList.remove('bg-white', 'text-primary', 'shadow-sm');
          viewWeekBtn.classList.add('text-gray-600');
          // Gi·ªØ nguy√™n ng√†y hi·ªán t·∫°i, ch·ªâ ƒë·ªïi view mode
          renderF8Calendar();
        });
      }

      if (viewWeekBtn) {
        viewWeekBtn.addEventListener('click', () => {
          F8_VIEW_MODE = 'week';
          viewWeekBtn.classList.add('bg-white', 'text-primary', 'shadow-sm');
          viewWeekBtn.classList.remove('text-gray-600');
          viewMonthBtn.classList.remove('bg-white', 'text-primary', 'shadow-sm');
          viewMonthBtn.classList.add('text-gray-600');
          // Gi·ªØ nguy√™n ng√†y hi·ªán t·∫°i, ch·ªâ ƒë·ªïi view mode
          renderF8Calendar();
        });
      }

      // Search input
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          F8_SEARCH_TEXT = e.target.value;
          renderF8Calendar();
        });
      }

      // Filter buttons - Ng∆∞·ªùi ph·ª• tr√°ch
      const filterAssigneeBtn = document.getElementById('f8-filter-assignee');
      if (filterAssigneeBtn) {
        filterAssigneeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showF8AssigneeFilter(filterAssigneeBtn);
        });
      }

      // Filter buttons - Tr·∫°ng th√°i
      const filterStatusBtn = document.getElementById('f8-filter-status');
      if (filterStatusBtn) {
        filterStatusBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showF8StatusFilter(filterStatusBtn);
        });
      }

      // ƒê√≥ng dropdown khi click ra ngo√†i
      document.addEventListener('click', () => {
        closeF8FilterDropdowns();
      });

      // T·ª± ƒë·ªông load khi form ƒë∆∞·ª£c hi·ªÉn th·ªã
      const form8Section = document.getElementById('form8');
      if (form8Section) {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              if (!form8Section.classList.contains('hidden')) {
                if (F8_ALL_DATA.length === 0) {
                  loadF8Calendar();
                } else {
                  renderF8Calendar();
                }
              }
            }
          });
        });
        observer.observe(form8Section, { attributes: true });
      }
    });

    // ===== FORM 4 - PHI·∫æU NH·∫¨P T√ÅC V·ª§ =====
    
    // Endpoints
    const F4_FORM_SUBMIT_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/form4-submit";
    const F4_FILE_UPLOAD_ENDPOINT = F4_FORM_SUBMIT_ENDPOINT;
    
    // NocoDB endpoints (c·∫ßn c·∫≠p nh·∫≠t theo URL th·ª±c t·∫ø)
    const NOCODB_API_BASE = "https://your-nocodb-instance.com/api/v1/db/data/noco"; // TODO: C·∫≠p nh·∫≠t URL th·ª±c t·∫ø
    const NOCODB_PROJECTS_TABLE = "dqa_projects";
    const NOCODB_TASKS_TABLE = "dqa_tasks";
    
    // ============================================
    // HELPER FUNCTIONS - FORMAT DATA THEO SCHEMA NOCODB
    // ============================================
    
    /**
     * Format d·ªØ li·ªáu Form 4 th√†nh format NocoDB dqa_tasks (type="form5_task")
     * @param {Object} formData - D·ªØ li·ªáu t·ª´ Form 4
     * @param {string} projectCode - M√£ d·ª± √°n (c√≥ th·ªÉ null)
     * @returns {Object} - Object theo schema NocoDB
     */
    function formatForm4ToNocoDBTask(formData, projectCode = null) {
      const normalizedRequestDate = (formData.requestDate || '').toString().slice(0,16).replace('T', ' ');
      const normalizedDesiredDate = (formData.desiredCompletionDate || '').toString().slice(0,10);
      const componentStd = Number(formData.componentStandard || 0) || 0;
      const componentStdStr = String(componentStd).replace('.', ',');
      
      // T·∫°o TaskCode t·ª´ requestCode ho·∫∑c generate m·ªõi
      const taskCode = formData.requestCode || `QA.SPM.${new Date().toISOString().slice(5,7)}${new Date().toISOString().slice(8,10)}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
      
      // Backup ƒë·∫ßy ƒë·ªß Form 4 data d∆∞·ªõi d·∫°ng JSON
      const form4DataBackup = {
        requesterName: formData.senderName || '',
        email: formData.senderEmail || '',
        requestDate: normalizedRequestDate,
        requestCode: formData.requestCode || '',
        deptRequest: formData.department || '',
        itemName: formData.productName || '',
        itemCode: formData.productCode || '',
        componentType: formData.componentType || '',
        componentStandard: componentStdStr,
        purpose: formData.requestPurpose || '',
        projectCode: projectCode || '',
        vendor: formData.supplier || '',
        qtySamples: formData.numSamples || '',
        desiredDate: normalizedDesiredDate,
        changeReq: formData.notes || '',
        appliedModel: formData.appliedModel || '',
        evaluator: formData.evaluator || '',
        attachments: formData.attachments || ''
      };
      
      return {
        type: "form5_task",
        project_code: projectCode || null,
        parent_id: null, // Task lu√¥n c√≥ parent_id = null
        
        // Nh√≥m TaskRequest* (Form 4)
        TaskRequestCode: formData.requestCode || taskCode,
        TaskRequesterName: String(formData.senderName || '').trim(),
        TaskRequesterEmail: String(formData.senderEmail || '').trim(),
        TaskRequestDate: normalizedRequestDate,
        TaskDeptRequest: String(formData.department || '').trim(),
        TaskItemName: String(formData.productName || '').trim(),
        TaskItemCode: String(formData.productCode || '').trim(),
        TaskComponentType: String(formData.componentType || '').trim(),
        TaskComponentStandard: componentStd,
        TaskPurpose: String(formData.requestPurpose || '').trim(),
        TaskVendor: String(formData.supplier || '').trim(),
        TaskQtySamples: Number(formData.numSamples || 0) || 0,
        TaskDesiredDate: normalizedDesiredDate,
        TaskPersonReceived: String(formData.personReceived || '').trim(),
        TaskNotes: String(formData.notes || '').trim(),
        TaskChangeFromLastNote: '', // ƒê√£ x√≥a kh·ªèi UI, ƒë·ªÉ r·ªóng
        TaskSampleSubmissionNo: 1, // M·∫∑c ƒë·ªãnh 1
        TaskAltCode: '', // ƒê√£ x√≥a kh·ªèi UI, ƒë·ªÉ r·ªóng
        TaskAppliedModel: String(formData.appliedModel || '').trim(),
        TaskAttachments: String(formData.attachments || '').trim(),
        
        // Nh√≥m Task* (Form 5)
        TaskCode: taskCode,
        TaskName: String(formData.productName || 'T√°c v·ª• m·ªõi').trim(),
        TaskDescription: `Y√™u c·∫ßu ƒë√°nh gi√° ${formData.productName || ''}${formData.productCode ? ` (M√£: ${formData.productCode})` : ''}${formData.supplier ? ` t·ª´ nh√† cung c·∫•p ${formData.supplier}` : ''}. ${formData.notes || ''}`,
        TaskPIC: String(formData.pic || formData.personReceived || '').trim(),
        TaskDepartment: String(formData.department || '').trim(),
        TaskCreatedAt: normalizedRequestDate.split(' ')[0],
        TaskDueDate: normalizedDesiredDate,
        TaskStatus: "pending",
        TaskPriority: "Trung b√¨nh",
        TaskForm4Data: JSON.stringify(form4DataBackup),
        Subtaskno: 0 // Task ch√≠nh c√≥ Subtaskno = 0
      };
    }
    
    /**
     * G·ª≠i Task l√™n NocoDB
     * @param {Object} taskData - D·ªØ li·ªáu task ƒë√£ format theo schema NocoDB
     * @returns {Promise<Object>} - Response t·ª´ NocoDB API
     */
    async function submitTaskToNocoDB(taskData) {
      // TODO: C·∫≠p nh·∫≠t endpoint NocoDB th·ª±c t·∫ø
      const endpoint = `${NOCODB_API_BASE}/${NOCODB_TASKS_TABLE}`;
      
      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // TODO: Th√™m authentication headers n·∫øu c·∫ßn
            // 'xc-token': 'your-nocodb-token'
          },
          body: JSON.stringify(taskData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[NocoDB] Task created:', result);
        return result;
      } catch (error) {
        console.error('[NocoDB] Error creating task:', error);
        throw error;
      }
    }
    
    /**
     * Format d·ªØ li·ªáu Subtask th√†nh format NocoDB dqa_tasks (type="form5_subtask" ho·∫∑c "form5_subtask_<declarationMode>")
     * @param {Object} subtaskData - D·ªØ li·ªáu subtask (c·∫ßn c√≥ declarationMode ƒë·ªÉ gh√©p v√†o Type)
     * @param {number} parentTaskId - ID c·ªßa Task cha trong dqa_tasks
     * @param {string} projectCode - M√£ d·ª± √°n (copy t·ª´ Task cha)
     * @returns {Object} - Object theo schema NocoDB
     */
    /**
     * Format datetime t·ª´ datetime-local input (YYYY-MM-DDTHH:mm) sang YYYY-MM-DD HH:mm
     * @param {string} datetimeLocal - Gi√° tr·ªã t·ª´ input datetime-local (YYYY-MM-DDTHH:mm)
     * @returns {string|null} - ƒê·ªãnh d·∫°ng YYYY-MM-DD HH:mm ho·∫∑c null
     */
    function formatDateTimeForWebhook(datetimeLocal) {
      if (!datetimeLocal) return null;
      // Chuy·ªÉn t·ª´ YYYY-MM-DDTHH:mm sang YYYY-MM-DD HH:mm
      // N·∫øu ƒë√£ l√† YYYY-MM-DD HH:mm th√¨ gi·ªØ nguy√™n
      if (datetimeLocal.includes('T')) {
        return datetimeLocal.replace('T', ' ');
      }
      // N·∫øu ƒë√£ l√† YYYY-MM-DD HH:mm th√¨ tr·∫£ v·ªÅ nguy√™n
      return datetimeLocal;
    }
    
    function formatSubtaskToNocoDB(subtaskData, parentIdentifier, projectCode = null, taskRequestCode = null) {
      // L·∫•y ch·∫ø ƒë·ªô khai b√°o v√† gh√©p v√†o Type
      const declarationMode = String(subtaskData.declarationMode || '').trim();
      const typeValue = declarationMode 
        ? `form5_subtask_${declarationMode}` 
        : (subtaskData.type || "form5_subtask");
      
      // Format th·ªùi gian g·ª≠i v·ªÅ d·∫°ng YYYY-MM-DD HH:mm
      const formattedTimesend = formatDateTimeForWebhook(subtaskData.timesend);
      const formattedFinishTime = formatDateTimeForWebhook(subtaskData.finishTime);
      
      // parentIdentifier c√≥ th·ªÉ l√†:
      // 1. ID c·ªßa Task (n·∫øu ƒë√£ c√≥ t·ª´ database) - d·∫°ng s·ªë ho·∫∑c string s·ªë
      // 2. TaskRequestCode (n·∫øu Task ch∆∞a c√≥ ID - tr∆∞·ªùng h·ª£p t·∫°o t·ª´ Form 4) - d·∫°ng string d√†i
      // Backend s·∫Ω t·ª± ƒë·ªông map TaskRequestCode -> Task Id
      
      return {
        type: typeValue,
        project_code: projectCode || null,
        parent_id: parentIdentifier, // C√≥ th·ªÉ l√† ID (s·ªë) ho·∫∑c TaskRequestCode (string)
        TaskRequestCode: taskRequestCode || null, // Th√™m TaskRequestCode ƒë·ªÉ backend map n·∫øu parent_id l√† code
        
        // Nh√≥m Subtask*
        SubtaskName: String(subtaskData.name || '').trim(),
        SubtaskPIC: String(subtaskData.pic || '').trim(),
        Subtaskmanhour: subtaskData.manhour ? Number(subtaskData.manhour) : null,
        SubtaskStatus: String(subtaskData.status || 'Ch∆∞a tri·ªÉn khai').trim(), // M·∫∑c ƒë·ªãnh Ch∆∞a tri·ªÉn khai
        Subtaskchecklist: String(subtaskData.checklist || '').trim(), // T√™n file checklist
        Subtaskformlink: String(subtaskData.formLink || subtaskData.resultLink || '').trim() || null, // Link file checklist t·ª´ server ho·∫∑c link k·∫øt qu·∫£
        Subtasktimesend: formattedTimesend,
        Subtaskfinishtime: formattedFinishTime,
        Subtasknote: String(subtaskData.note || '').trim(),
        SubtaskPriority: String(subtaskData.priority || 'Trung b√¨nh').trim(),
        SubtaskDeclarationMode: String(subtaskData.declarationMode || '').trim(),
        Subtaskno: subtaskData.subtaskNo ? Number(subtaskData.subtaskNo) : null,
        Subtaskitemcode: String(subtaskData.itemCode || '').trim(), // M√£ linh ki·ªán/s·∫£n ph·∫©m
        TaskCode: String(subtaskData.taskCode || '').trim() || null // M√£ t√°c v·ª• QA.NB.DDMM-xxxxxx (ho·∫∑c QA.NB.DDMM-xxxxxx-NSPM cho subtask A,B,C)
      };
    }
    
    /**
     * Format d·ªØ li·ªáu Declaration th√†nh format NocoDB dqa_tasks (type="form5_declaration")
     * @param {Object} declarationData - D·ªØ li·ªáu declaration
     * @param {number} parentSubtaskId - ID c·ªßa Subtask cha trong dqa_tasks
     * @param {string} declarationMode - Ch·∫ø ƒë·ªô khai b√°o (ph·∫£i tr√πng v·ªõi SubtaskDeclarationMode)
     * @param {string} projectCode - M√£ d·ª± √°n (copy t·ª´ Task cha)
     * @returns {Object} - Object theo schema NocoDB
     */
    function formatDeclarationToNocoDB(declarationData, parentSubtaskId, declarationMode, projectCode = null) {
      return {
        type: "form5_declaration",
        project_code: projectCode || null,
        parent_id: parentSubtaskId, // ID c·ªßa Subtask cha
        
        // Nh√≥m Declaration*
        DeclarationMode: String(declarationMode || '').trim(),
        DeclarationData: typeof declarationData === 'string' ? declarationData : JSON.stringify(declarationData)
      };
    }
    
    /**
     * G·ª≠i Declaration l√™n NocoDB
     * @param {Object} declarationData - D·ªØ li·ªáu declaration ƒë√£ format theo schema NocoDB
     * @returns {Promise<Object>} - Response t·ª´ NocoDB API
     */
    async function submitDeclarationToNocoDB(declarationData) {
      // TODO: C·∫≠p nh·∫≠t endpoint NocoDB th·ª±c t·∫ø
      const endpoint = `${NOCODB_API_BASE}/${NOCODB_TASKS_TABLE}`;
      
      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // TODO: Th√™m authentication headers n·∫øu c·∫ßn
            // 'xc-token': 'your-nocodb-token'
          },
          body: JSON.stringify(declarationData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[NocoDB] Declaration created:', result);
        return result;
      } catch (error) {
        console.error('[NocoDB] Error creating declaration:', error);
        throw error;
      }
    }

    let f4Initialized = false;

    // Component items data (t·ª´ file g·ªëc - Phi·∫øu nh·∫≠p t√°c v·ª•.html)
    const F4_COMPONENT_ITEMS = [
      { name: 'BƒÉng d√≠nh x·ªëp', std: 7.7 },
      { name: 'B√¨nh √°p', std: 12.5 },
      { name: 'B√¨nh n√≥ng', std: 16.7 },
      { name: 'Block', std: 19.7 },
      { name: 'B·ªô c·ªëc Hydrogen', std: 14.5 },
      { name: 'B·ªô d√¢y ƒëi·ªán', std: 15.9 },
      { name: 'B·ªô ƒëi·ªán ph√¢n Alkaline', std: 12.1 },
      { name: 'B·ªô k√≠nh vi·ªÅn nh√¥m', std: 12.5 },
      { name: 'B∆°m √°p', std: 15.7 },
      { name: 'B√¥ng', std: 3.7 },
      { name: 'C√¥ng t·∫Øc', std: 8.9 },
      { name: 'C√∫t', std: 9.1 },
      { name: 'D√†n l·∫°nh', std: 13.7 },
      { name: 'D√†n t·∫£n nhi·ªát', std: 18.0 },
      { name: 'D√¢y ƒëi·ªán', std: 12.4 },
      { name: 'D√¢y RO 1/4', std: 16.2 },
      { name: 'D√¢y RO 3/8', std: 15.2 },
      { name: 'D√¢y silicone', std: 8.1 },
      { name: 'D√¢y TDS', std: 14.6 },
      { name: 'ƒê·ªìng sunfat', std: 0.8 },
      { name: 'Flow', std: 11.0 },
      { name: 'GioƒÉng ch·ªâ', std: 3.9 },
      { name: 'H·∫°t CaCO3', std: 12.4 },
      { name: 'H·∫°t Cation', std: 4.2 },
      { name: 'H·∫°t Corosex', std: 10.4 },
      { name: 'H·∫°t h·ªìng ngo·∫°i', std: 9.1 },
      { name: 'H·∫°t ORP', std: 6.6 },
      { name: 'Kh√≥a v√≤i nh·ª±a', std: 8.5 },
      { name: 'L√µi 6HP', std: 15.7 },
      { name: 'L√µi Alkaline', std: 11.7 },
      { name: 'L√µi h·ªìng ngo·∫°i', std: 13.0 },
      { name: 'L√µi hydrogen EZ270', std: 12.3 },
      { name: 'L√µi kho√°ng', std: 11.8 },
      { name: 'L√µi kho√°ng EZ', std: 13.0 },
      { name: 'L√µi l·ªçc s·ªë 1', std: 7.3 },
      { name: 'L√µi l·ªçc s·ªë 2', std: 7.9 },
      { name: 'L√µi l·ªçc s·ªë 3', std: 8.2 },
      { name: 'L√µi OCB', std: 13.5 },
      { name: 'L√µi Post Carbon', std: 22.3 },
      { name: 'L√µi PP', std: 7.1 },
      { name: 'L√µi T33', std: 12.1 },
      { name: 'L√µi than nano', std: 12.1 },
      { name: 'M√†ng cao su', std: 10.0 },
      { name: 'M√†ng RO', std: 12.0 },
      { name: 'M√†ng RO EZ', std: 14.7 },
      { name: 'M·ª°', std: 6.5 },
      { name: 'M·ª±c In', std: 10.5 },
      { name: 'N·∫Øp c·ªëc', std: 4.8 },
      { name: 'Ngu·ªìn xung', std: 12.3 },
      { name: 'Phao ƒëi·ªán t·ª´', std: 10.5 },
      { name: 'Phin l·ªçc', std: 10.2 },
      { name: 'Ph√¥i l√µi PP', std: 7.3 },
      { name: 'R∆° le nhi·ªát l·∫°nh', std: 19.55 },
      { name: 'Tem', std: 6.2 },
      { name: 'Th√¢n c·ªëc', std: 6.5 },
      { name: 'Than ho·∫°t t√≠nh', std: 17.9 },
      { name: 'Th√¢n v·ªè m√†ng', std: 6.5 },
      { name: 'Th√πng s√≥ng AB', std: 10.1 },
      { name: 'Th√πng s√≥ng BC', std: 10.1 },
      { name: 'Th√πng s√≥ng C', std: 10.1 },
      { name: 'T√¥i k√≠nh', std: 9.6 },
      { name: 'T√∫i PE', std: 3.2 },
      { name: 'Van 1 chi·ªÅu', std: 13.6 },
      { name: 'Van 4 c·ª≠a', std: 15.1 },
      { name: 'Van √°p cao', std: 16 },
      { name: 'Van √°p th·∫•p', std: 15.7 },
      { name: 'Van ƒëi·ªán t·ª´', std: 16.9 },
      { name: 'Van kh√≥a', std: 12.4 },
      { name: 'Van x·∫£ b√¨nh √°p', std: 17.4 },
      { name: 'Vi·ªÅn nh√¥m k√≠nh', std: 9 },
      { name: 'V√≤i g·∫°t', std: 12.5 },
      { name: 'V√≤i HCV', std: 8.7 },
      { name: 'X·ªëp', std: 2.5 },
      { name: 'X·ªëp b·∫£o √¥n', std: 2.0 },
      { name: 'M·∫°ch', std: 24.0 },
      { name: 'M√°y l·ªçc n∆∞·ªõc', std: 32.0 },
      { name: 'M√°y l·ªçc n∆∞·ªõc (Ch·ªâ rung l·∫Øc)', std: 6.0 },
      { name: 'M√°y l·ªçc n∆∞·ªõc (Base/r√† so√°t t√†i li·ªáu)', std: 2.0 },
      { name: 'M√°y l·ªçc n∆∞·ªõc (Base/x√∫c ti·∫øn ho√†n thi·ªán)', std: 10.0 },
      { name: 'C√¥ng chu·∫©n 1 ng√†y', std: 8.0 },
      { name: 'C√¥ng chu·∫©n 2 ng√†y', std: 16.0 },
      { name: 'C√¥ng chu·∫©n 3 ng√†y', std: 24.0 },
      { name: 'C√¥ng chu·∫©n 4 ng√†y', std: 32.0 },
      { name: 'C√¥ng chu·∫©n 5 ng√†y', std: 40.0 }
    ];

    function initForm4() {
      if (f4Initialized) return;
      f4Initialized = true;
      // Set default date
      const now = new Date();
      const tzOffsetMs = now.getTimezoneOffset() * 60000;
      const localISO = new Date(now.getTime() - tzOffsetMs).toISOString().slice(0, 16);
      const dateInput = document.getElementById('f4-testRequestDate');
      if (dateInput) dateInput.value = localISO;

      // Generate request code
      setF4RequestCode();

      // Setup purpose change handler
      setupF4PurposeHandler();

      // Setup sample submission number
      // Setup desired date field
      setupF4DesiredDateField();

      // Setup sender autocomplete
      setupF4SenderAutocomplete();

      // Setup file upload
      setupF4FileUpload();

      // Setup form submit
      setupF4FormSubmit();
    }

    function setF4RequestCode() {
      const el = document.getElementById('f4-requestCode');
      if (!el) return;
      const now = new Date();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const mmdd = `${mm}${dd}`; // MMDD: th√°ng v√† ng√†y
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let rnd = '';
      for (let i=0;i<6;i++) rnd += alphabet[Math.floor(Math.random()*alphabet.length)];
      el.value = `QA.SPM.${mmdd}-${rnd}`;
    }


    function setupF4PurposeHandler() {
      const purposeSelect = document.getElementById('f4-requestPurpose');
      if (!purposeSelect) return;

      const purposeDescriptions = {
        "ƒê√°nh gi√° SP m·ªõi": "S·∫£n ph·∫©m/linh ki·ªán m·ªõi thu·ªôc c√°c d·ª± √°n ph√°t tri·ªÉn KRD, c·∫ßn ki·ªÉm tra tr∆∞·ªõc khi s·∫£n xu·∫•t ƒë·∫°i tr√†.",
        "ƒê√°nh gi√° S·∫£n ph·∫©m SOP": "Li√™n quan ƒë·∫øn s·∫£n ph·∫©m/linh ki·ªán ƒë√£ SOP, c·∫ßn ki·ªÉm tra ch·∫•t l∆∞·ª£ng v√† ƒë·∫£m b·∫£o ph√π h·ª£p v·ªõi ti√™u chu·∫©n k·ªπ thu·∫≠t.",
      };

      purposeSelect.addEventListener('change', (e) => {
        const val = e.target.value || "";
        const desc = purposeDescriptions[val] || "";
        const descEl = document.getElementById('f4-purposeDescription');
        if (descEl) descEl.textContent = desc;

        // Ki·ªÉm tra d·ª±a tr√™n value thay v√¨ text
        const isSanPhamMoi = val === "ƒê√°nh gi√° SP m·ªõi";
        const isSanPhamSOP = val === "ƒê√°nh gi√° S·∫£n ph·∫©m SOP";

        // Project code container - hi·ªÉn th·ªã cho "ƒê√°nh gi√° s·∫£n ph·∫©m m·ªõi"
        const projContainer = document.getElementById('f4-projectCodeContainer');
        const projInput = document.getElementById('f4-projectCode');
        if (projContainer && projInput) {
          projContainer.classList.toggle('hidden', !isSanPhamMoi);
          projInput.disabled = !isSanPhamMoi;
          projInput.required = isSanPhamMoi;
          if (!isSanPhamMoi) projInput.value = '';
        }

        // NCC change fields - kh√¥ng c√≤n logic n√†y n·ªØa
        const nccContainer = document.getElementById('f4-nccChangeFields');
        const appliedModel = document.getElementById('f4-appliedModel');
        if (nccContainer && appliedModel) {
          nccContainer.classList.add('hidden');
          appliedModel.disabled = true;
          appliedModel.required = false;
        }

        // Auto select person received
        const personSel = document.querySelector('#f4-testRequestForm select[name="personReceived"]');
        if (personSel) {
          if (isSanPhamMoi) {
            // ƒê√°nh gi√° s·∫£n ph·∫©m m·ªõi -> auto ch·ªçn Nguy·ªÖn VƒÉn Hi·∫øu
            Array.from(personSel.options).forEach(opt => {
              if ((opt.text || opt.textContent || '').trim() === 'Nguy·ªÖn VƒÉn Hi·∫øu') {
                personSel.value = opt.value || opt.text;
              }
            });
          } else if (isSanPhamSOP) {
            // ƒê√°nh gi√° s·∫£n ph·∫©m SOP -> auto ch·ªçn Nguy·ªÖn VƒÉn Linh
            Array.from(personSel.options).forEach(opt => {
              if ((opt.text || opt.textContent || '').trim() === 'Nguy·ªÖn VƒÉn Linh') {
                personSel.value = opt.value || opt.text;
              }
            });
          }
        }
      });
    }



    function setupF4DesiredDateField() {
      const input = document.getElementById('f4-desiredCompletionDate');
      const hiddenDateTime = document.getElementById('f4-desiredCompletionDateTime');
      if (!input || !hiddenDateTime) return;

      function toYMD(d) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }

      function setRange(el) {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const end = new Date(start);
        end.setDate(end.getDate() + 32);
        el.min = toYMD(start);
        el.max = toYMD(end);
      }

      function ensureDateMode() {
        if (input.type !== 'date') {
          input.type = 'date';
          setRange(input);
          if (!input.value) {
            const now = new Date();
            const def = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            def.setDate(def.getDate() + 7);
            input.value = toYMD(def);
            updateHidden();
          }
          try { if (input.showPicker) input.showPicker(); } catch(_){}
        }
      }

      input.addEventListener('focus', ensureDateMode);
      input.addEventListener('click', ensureDateMode);
      input.addEventListener('blur', () => {
        if (!input.value) {
          input.type = 'text';
          input.removeAttribute('min');
          input.removeAttribute('max');
        }
      });

      function updateHidden() {
        if (!input.value) { hiddenDateTime.value = ''; return; }
        const [y,m,d] = input.value.split('-').map(Number);
        if (!y || !m || !d) { hiddenDateTime.value = ''; return; }
        const now = new Date();
        const dt = new Date(y, m-1, d, now.getHours(), now.getMinutes(), now.getSeconds());
        hiddenDateTime.value = dt.toISOString();
      }

      input.addEventListener('change', updateHidden);
      input.addEventListener('input', updateHidden);
    }

    function setupF4SenderAutocomplete() {
      const nameInput = document.getElementById('f4-senderName');
      const emailInput = document.querySelector('#f4-testRequestForm input[name="senderEmail"]');
      const deptSelect = document.querySelector('#f4-testRequestForm select[name="department"]');
      const list = document.getElementById('f4-senderNameOptions');
      if (!nameInput || !emailInput || !deptSelect || !list) return;

      const F4_SENDER_DB = [
        { name: 'ƒêo√†n Th·ªã Minh Th∆∞', dept: 'KTSP', email: 'thu.doan@karofi.vn' },
        { name: 'ƒê·∫∑ng VƒÉn H·∫£i', dept: 'TKCK', email: 'haidv1@karofi.vn' },
        { name: 'Nguy·ªÖn Quang Tr·ªçng', dept: 'KTCN', email: 'trongnq@karofi.vn' },
        { name: 'Ph·∫°m Quang Doanh', dept: 'TKƒêT', email: 'doanh.pham@karofi.vn' },
        { name: 'Nguy·ªÖn Th·ªã M·ª´ng', dept: 'SC', email: 'mung.nguyen1@karofi.vn' },
        { name: 'V≈© ƒêƒÉng L∆∞∆°ng', dept: 'KTSP', email: 'luong.vu@karofi.vn' },
        { name: 'Ho√†ng L√™ Anh', dept: 'TKCK', email: 'anh.hoang2@karofi.com' },
        { name: 'Phan VƒÉn C·ª≠', dept: 'KTSP', email: 'cupv@karofi.vn' },
        { name: 'Ph·∫°m VƒÉn Thu·∫≠n', dept: 'KTSX', email: 'thuan.pham2@karofi.vn' },
        { name: 'Chu VƒÉn Quang', dept: 'KTSP', email: 'quangcv@karofi.vn' },
        { name: 'Tr·∫ßn Kh·∫Øc L√¢m', dept: 'KTSP', email: 'lamtk@karofi.vn' },
        { name: 'ƒê·∫∑ng Th·∫ø Huy', dept: 'TKƒêT', email: 'huydt@karofi.com' },
        { name: 'Tr·∫ßn H·ªìng Nhung', dept: 'SC', email: 'nhung.tran2@karofi.vn' },
        { name: 'ƒê·ªó Th√†nh C√¥ng', dept: 'KTSP', email: 'congdt@karofi.vn' },
        { name: 'Nguy·ªÖn Kim C∆∞∆°ng', dept: 'NCTN', email: 'cuong.nguyen6@karofi.com' },
        { name: 'Nguy·ªÖn Chung Nam', dept: 'Mua h√†ng', email: 'nam.nguyen5@karofi.vn' },
        { name: 'Nguy·ªÖn Ng·ªçc Quang', dept: 'TKCK', email: 'quang.nguyen1@karofi.vn' },
        { name: 'Ho√†ng Th√πy Linh', dept: 'NCTN', email: 'linh.hoang1@karofi.vn' },
        { name: 'ƒêo√†n VƒÉn Minh', dept: 'TKCK', email: 'minh.doan@karofi.vn' },
        { name: 'Tr·∫ßn VƒÉn C∆∞·ªùng', dept: 'QA/QC nh√† m√°y', email: 'cuong.tran1@karofi.vn' },
        { name: 'ƒê·ªó C√¥ng Nh·∫≠m', dept: 'TKCK', email: 'nham.do@karofi.vn' },
        { name: 'L√™ Minh H·∫£i', dept: 'KTSP', email: 'hai.le3@karofi.vn' },
        { name: 'ƒê·ªó Xu√¢n Th√°i', dept: 'KTSP', email: 'thai.do1@karofi.vn' },
        { name: 'ƒê·∫∑ng Th·∫ø Huy', dept: 'KTSP', email: 'huydt@karofi.com' },
        { name: 'Tr·ªãnh K·∫ø L·ª±c', dept: 'KTSX', email: 'luc.trinh@karofi.vn' },
        { name: 'ƒê·∫∑ng VƒÉn Thu·∫•n', dept: 'KTCN', email: 'thuan.dang@karofi.vn' },
        { name: 'L√™ Th·∫ø Anh', dept: 'KTSP', email: 'anh.le@karofi.vn' },
        { name: 'D∆∞∆°ng Qu·ªëc Hi·∫øu', dept: 'TKCK', email: 'hieudq1@karofi.vn' },
        { name: 'Ph√πng Ch√≠ Ti·∫øn', dept: 'KTSP', email: 'tien.phung@karofi.vn' },
        { name: 'Nguy·ªÖn Th·ªã H∆∞∆°ng Th√∫y', dept: 'Mua h√†ng', email: 'thuy.nguyen@karofi.vn' },
        { name: 'ƒê√†o Ho√†ng D∆∞∆°ng', dept: 'DQA', email: 'duong.dao@karofi.vn' },
        { name: 'Nguy·ªÖn M·∫°nh H√πng', dept: 'KTSX', email: 'hung.nguyen2@karofi.vn' },
        { name: 'Nguy·ªÖn H·ªìng Hi·∫øu', dept: 'KTSX', email: 'hieu.nguyen@karofi.vn' },
        { name: 'ƒê√†m Huy H√πng', dept: 'SC', email: 'hung.dam@karofi.vn' },
        { name: 'Kh∆∞∆°ng ƒê·ª©c T√¨nh', dept: 'NCTN', email: 'tinh.khuong@karofi.vn' },
        { name: 'ƒê·∫∑ng Th·ªã Ch√≠n', dept: 'NCTN', email: 'chindt@karofi.vn' },
        { name: 'Ho√†ng VƒÉn Th√†nh', dept: 'NCTN', email: 'thanhhv@karofi.vn' },
        { name: 'Nguy·ªÖn Th·ªã Th·ªßy', dept: 'NCTN', email: 'thuynt3@karofi.vn' },
      ];

      function normalize(s) {
        return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
      }

      function renderOptions(q) {
        const n = normalize(q);
        if (!n) { list.innerHTML = ''; return; }
        const candidates = F4_SENDER_DB
          .filter(x => normalize(x.name).includes(n))
          .sort((a,b)=> a.name.localeCompare(b.name))
          .slice(0, 30);
        list.innerHTML = candidates.map(c=>`<option value="${c.name}"></option>`).join('');
      }

      function tryAutofill() {
        const val = nameInput.value || '';
        const exact = F4_SENDER_DB.find(x=>x.name === val);
        if (exact) {
          emailInput.value = exact.email;
          const opts = Array.from(deptSelect.options);
          const match = opts.find(o=> (o.value||o.text||'').trim() === exact.dept);
          if (match) deptSelect.value = match.value || match.text;
        }
      }

      nameInput.addEventListener('input', ()=>{ renderOptions(nameInput.value); });
      nameInput.addEventListener('change', tryAutofill);
      nameInput.addEventListener('blur', tryAutofill);
      renderOptions('');
    }

    let f4PendingFiles = [];
    function setupF4FileUpload() {
      const fileInput = document.getElementById('f4-testRequestFiles');
      const uploadArea = document.getElementById('f4-fileUploadArea');
      const uploadList = document.getElementById('f4-testRequestUploadList');
      if (!fileInput || !uploadArea || !uploadList) return;

      const allowedTypes = {
        'application/pdf': 'PDF',
        'application/msword': 'DOC',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'DOCX',
        'application/vnd.ms-excel': 'XLS',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'XLSX',
        'image/jpeg': 'JPG',
        'image/jpg': 'JPG',
        'image/png': 'PNG'
      };
      const maxFileSize = 20 * 1024 * 1024;

      function validateFile(file) {
        const errors = [];
        const type = file.type || '';
        if (type ? !allowedTypes[type] : !(['pdf','doc','docx','xls','xlsx','jpg','jpeg','png'].includes((file.name.split('.').pop()||'').toLowerCase()))) {
          errors.push('Lo·∫°i file kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
        }
        if (file.size > maxFileSize) errors.push('File qu√° l·ªõn (t·ªëi ƒëa 20MB)');
        return errors;
      }

      function createItem(file, idx) {
        const isImage = file.type.startsWith('image/');
        const typeLabel = allowedTypes[file.type] || 'FILE';
        const row = document.createElement('div');
        row.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
        row.id = `f4-file-row-${idx}`;
        row.innerHTML = `
          <div class="flex items-start space-x-4">
            ${isImage ?
              `<div class="flex-shrink-0">
                <img id="f4-preview-${idx}" class="w-16 h-16 object-cover rounded-lg border" src="#" alt="Preview">
              </div>` :
              `<div class="flex-shrink-0 w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">üìé</span>
              </div>`}
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <input id="f4-rename-${idx}" class="text-sm font-medium text-gray-900 truncate border border-blue-200 rounded px-2 py-1 w-full max-w-xs"
                       value="${file.name}" />
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${typeLabel}</span>
              </div>
              <p class="text-sm text-gray-500 mt-1">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
            </div>
            <button type="button" id="f4-remove-${idx}" class="flex-shrink-0 p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-50">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>`;
        uploadList.appendChild(row);

        if (isImage) {
          const r = new FileReader();
          r.onload = e => { const img = document.getElementById(`f4-preview-${idx}`); if (img) img.src = e.target.result; };
          r.readAsDataURL(file);
        }
        row.querySelector(`#f4-rename-${idx}`).addEventListener('input', e=>{
          const pf = f4PendingFiles[idx]; if (pf) pf.name = e.target.value;
        });
        row.querySelector(`#f4-remove-${idx}`).onclick = ()=>{
          const pf = f4PendingFiles[idx];
          if (pf) f4PendingFiles[idx] = null;
          row.remove();
        };
      }

      function addFiles(files) {
        const errs = [];
        Array.from(files).forEach(file=>{
          const e = validateFile(file);
          if (e.length) { errs.push(`${file.name}: ${e.join(', ')}`); return; }
          const idx = f4PendingFiles.length;
          f4PendingFiles.push({ file, name: file.name });
          createItem(file, idx);
        });
        if (errs.length) alert('M·ªôt s·ªë file kh√¥ng h·ª£p l·ªá:\n\n' + errs.join('\n'));
      }

      ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
        uploadArea.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); }, false);
      });
      ['dragenter','dragover'].forEach(ev=>{
        uploadArea.addEventListener(ev, ()=>uploadArea.classList.add('border-blue-500','bg-blue-50'), false);
      });
      ['dragleave','drop'].forEach(ev=>{
        uploadArea.addEventListener(ev, ()=>uploadArea.classList.remove('border-blue-500','bg-blue-50'), false);
      });
      uploadArea.addEventListener('drop', e=>addFiles(e.dataTransfer.files), false);
      fileInput.addEventListener('change', function(){ if (this.files?.length) addFiles(this.files); this.value=''; });
      uploadArea.addEventListener('click', e=>{ if (e.target!==fileInput) fileInput.click(); });
    }

    async function uploadF4PendingFiles() {
      const list = f4PendingFiles.filter(Boolean);
      const total = Math.max(list.length, 1);
      const results = [];
      let done = 0;

      for (const item of list) {
        const base64 = await new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = e=>resolve(e.target.result.split(',')[1]);
          r.onerror = ()=>reject(new Error('Kh√¥ng th·ªÉ ƒë·ªçc file'));
          r.readAsDataURL(item.file);
        });
        const payload = { data: [{ filename: (item.name || item.file.name), mimetype: item.file.type, filedata: base64 }] };
        const resp = await fetch(F4_FILE_UPLOAD_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error(await resp.text());
        let result = {};
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) result = await resp.json();
        else { try { result = JSON.parse(await resp.text()); } catch { result = {}; } }
        const url = result.url || result.fileUrl || result.public_url || (result.data && result.data[0] && (result.data[0].url || result.data[0].link)) || '#';
        results.push({ name: (item.name || item.file.name), url, type: item.file.type, size: item.file.size });
        done++;
      }
      return results;
    }

    function setupF4FormSubmit() {
      const form = document.getElementById('f4-testRequestForm');
      if (!form) return;

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const confirmed = window.confirm('B·∫°n c√≥ ch·∫Øc mu·ªën g·ª≠i l√™n h·ªá th·ªëng kh√¥ng?.');
        if (!confirmed) return;

        const btn = this.querySelector("button[type=submit]");
        const originalLabel = btn ? btn.innerHTML : "";
        if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner'></span><span style='margin-left:8px'>ƒêang g·ª≠i...</span>"; }

        const data = (function toJSON(form){
          const d = {}; new FormData(form).forEach((val,key)=>{ d[key] = d[key] ? [].concat(d[key],val) : val; }); return d;
        })(this);

        // Ph·∫ßn C ƒë√£ b·ªã x√≥a, lu√¥n s·ª≠ d·ª•ng ki·ªÉm tra m·∫∑c ƒë·ªãnh
        const isSpecial = false;
        const normalizedRequestDate = (data.requestDate || '').toString().slice(0,16).replace('T', ' ');
        const normalizedDesiredDate = (data.desiredCompletionDate || '').toString().slice(0,10);
        
        const componentStd = Number(data.componentStandard || 0) || 0;
        const componentStdStr = String(componentStd).replace('.', ',');

        const mapped = {
          requesterName: String(data.senderName || '').trim(),
          email: String(data.senderEmail || '').trim(),
          requestDate: String(normalizedRequestDate || '').trim(),
          requestCode: String(document.getElementById('f4-requestCode')?.value || '').trim(),
          deptRequest: String(data.department || '').trim(),
          itemName: String(data.productName || '').trim(),
          itemCode: String(data.productCode || '').trim(),
          componentType: String(data.componentType || '').trim(),
          componentStandard: String(componentStdStr),
          purpose: String(data.requestPurpose || '').trim(),
          projectCode: String(data.projectCode || '').trim(),
          vendor: String(data.supplier || '').trim(),
          qtySamples: String(data.numSamples || '').trim(),
          desiredDate: String(normalizedDesiredDate || '').trim(),
          changeReq: String(data.notes || '').trim(),
          kiemtraDefault: '1',
          kiemtraDacBiet: '0',
          SpecialReq: '',
          Receiver: String(data.personReceived || '').trim(),
          pic: String(data.pic || '').trim(),
          evaluator: String(data.evaluator || '').trim(),
          tester: String(data.tester || '').trim(),
          appliedModel: String(data.appliedModel || '').trim(),
          Score: String(componentStdStr), Odoojira: '', Assignee: String(data.pic || '').trim()
        };

        const pending = f4PendingFiles.filter(Boolean);
        const attachmentNames = pending.map(p=>p?.name || p?.file?.name).filter(Boolean);

        const fd = new FormData();
        Object.entries(mapped).forEach(([k,v])=>fd.append(k, v));
        fd.append('attachments', attachmentNames.join(';'));
        fd.append('componentStandard', String(componentStdStr));
        for (const item of pending) {
          if (!item) continue;
          const name = item.name || item.file.name;
          fd.append('files[]', item.file, name);
        }

        // Format d·ªØ li·ªáu theo schema NocoDB
        const projectCode = String(data.projectCode || '').trim() || null;
        const attachmentNamesForNocoDB = pending.map(p=>p?.name || p?.file?.name).filter(Boolean);
        const attachmentsStr = attachmentNamesForNocoDB.join(';');
        
        // C·∫≠p nh·∫≠t formData v·ªõi attachments
        const formDataWithAttachments = {
          ...data,
          attachments: attachmentsStr
        };
        
        const nocodbTaskData = formatForm4ToNocoDBTask(formDataWithAttachments, projectCode);
        
        // G·ª≠i l√™n NocoDB (async, kh√¥ng block)
        submitTaskToNocoDB(nocodbTaskData)
          .then((dbResult) => {
            console.log('[Form 4] Task saved to NocoDB:', dbResult);
            // C√≥ th·ªÉ l∆∞u Id t·ª´ database v√†o task object ƒë·ªÉ d√πng sau
            // task.nocodbId = dbResult.Id;
          })
          .catch((error) => {
            console.error('[Form 4] Failed to save task to NocoDB:', error);
            // V·∫´n ti·∫øp t·ª•c v·ªõi endpoint c≈© n·∫øu database fail
          });

        try {
          let resp = await fetch(F4_FORM_SUBMIT_ENDPOINT, { method: 'POST', body: fd });
          if (!resp.ok) {
            const uploaded = await uploadF4PendingFiles();
            const mappedFallback = {
              ...mapped,
              attachments: uploaded.map(u=>u.name || '').join(';'),
              attachmentUrls: uploaded.map(u=>u.url || '').join(';')
            };
            resp = await fetch(F4_FORM_SUBMIT_ENDPOINT, {
              method: "POST",
              headers: { "Content-Type": "application/json", "Accept": "application/json" },
              body: JSON.stringify({ data: [mappedFallback] })
            });
            if (!resp.ok) throw new Error(await resp.text());
          }

          if (btn) {
            btn.innerHTML="ƒê√£ g·ª≠i!";
            setTimeout(()=>{btn.innerHTML=originalLabel;btn.disabled=false;},20000);
          }

          this.reset();
          const dateInput = document.getElementById('f4-testRequestDate');
          if (dateInput) {
            const now = new Date();
            const tzOffsetMs = now.getTimezoneOffset() * 60000;
            const localISO = new Date(now.getTime() - tzOffsetMs).toISOString().slice(0, 16);
            dateInput.value = localISO;
          }
          setF4RequestCode();
          const list = document.getElementById('f4-testRequestUploadList');
          if (list) list.innerHTML = '';
          f4PendingFiles = [];

          // T·∫°o task trong Form 5 t·ª´ d·ªØ li·ªáu Form 4
          const taskData = {
            ...mapped,
            attachments: attachmentNames.join('; ')
          };
          createF5TaskFromForm4(taskData);

          showToast('ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng!', 'success');
        } catch(err) {
          alert("G·ª≠i th·∫•t b·∫°i: "+err);
          if (btn) { btn.innerHTML=originalLabel; btn.disabled=false; }
        }
      });
    }

    // ============================================
    // DATABASE STRUCTURE MOCK - Form 4 & Form 5
    // ============================================
    /*
    DATABASE TABLES STRUCTURE:
    
    1. TABLE: form4_requests (Phi·∫øu nh·∫≠p t√°c v·ª•)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - request_code (VARCHAR, UNIQUE) - M√£ y√™u c·∫ßu (QA.SPM.MMDD-XXXXXX)
       - requester_name (VARCHAR) - H·ªç t√™n ng∆∞·ªùi g·ª≠i
       - requester_email (VARCHAR) - Email ng∆∞·ªùi g·ª≠i
       - request_date (DATETIME) - Ng√†y gi·ªù y√™u c·∫ßu
       - dept_request (VARCHAR) - Ph√≤ng ban y√™u c·∫ßu
       - item_name (VARCHAR) - T√™n s·∫£n ph·∫©m/linh ki·ªán
       - item_code (VARCHAR) - M√£ s·∫£n ph·∫©m/linh ki·ªán
       - component_type (VARCHAR) - Lo·∫°i linh ki·ªán
       - component_standard (DECIMAL) - C√¥ng chu·∫©n (gi·ªù)
       - purpose (VARCHAR) - M·ª•c ƒë√≠ch y√™u c·∫ßu
       - project_code (VARCHAR) - M√£ d·ª± √°n
       - vendor (VARCHAR) - Nh√† cung c·∫•p
       - qty_samples (INT) - S·ªë l∆∞·ª£ng m·∫´u
       - desired_date (DATE) - H·∫°n mong mu·ªën
       - person_received (VARCHAR) - ƒê·∫ßu m·ªëi nh·∫≠n m·∫´u
       - pic (VARCHAR) - PIC (Ng∆∞·ªùi ph·ª• tr√°ch)
       - notes (TEXT) - Ghi ch√∫
       - applied_model (VARCHAR) - Model √°p d·ª•ng
       - attachments (TEXT) - Danh s√°ch file ƒë√≠nh k√®m (JSON ho·∫∑c TEXT)
       - created_at (DATETIME) - Th·ªùi gian t·∫°o
       - updated_at (DATETIME) - Th·ªùi gian c·∫≠p nh·∫≠t
       - status (VARCHAR) - Tr·∫°ng th√°i (pending, submitted, processing, completed)
    
    2. TABLE: form5_projects (D·ª± √°n Form 5)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - project_code (VARCHAR, UNIQUE) - M√£ d·ª± √°n
       - project_name (VARCHAR) - T√™n d·ª± √°n
       - description (TEXT) - M√¥ t·∫£ d·ª± √°n
       - pic (VARCHAR) - Ng∆∞·ªùi ph·ª• tr√°ch
       - created_at (DATE) - Ng√†y t·∫°o
       - due_date (DATE) - Ng√†y h·∫øt h·∫°n
       - status (VARCHAR) - Tr·∫°ng th√°i (pending, in_progress, done)
       - created_at (DATETIME) - Th·ªùi gian t·∫°o
       - updated_at (DATETIME) - Th·ªùi gian c·∫≠p nh·∫≠t
    
    3. TABLE: form5_tasks (T√°c v·ª• Form 5)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - project_id (FOREIGN KEY -> form5_projects.id)
       - task_code (VARCHAR, UNIQUE) - M√£ t√°c v·ª• (QA.SPM.MMDD-XXXXXX)
       - task_name (VARCHAR) - T√™n t√°c v·ª•
       - description (TEXT) - M√¥ t·∫£ t√°c v·ª•
       - pic (VARCHAR) - Ng∆∞·ªùi ph·ª• tr√°ch
       - requester_name (VARCHAR) - Ng∆∞·ªùi y√™u c·∫ßu
       - requester_email (VARCHAR) - Email ng∆∞·ªùi y√™u c·∫ßu
       - department (VARCHAR) - Ph√≤ng ban
       - created_at (DATE) - Ng√†y t·∫°o
       - due_date (DATE) - Ng√†y h·∫øt h·∫°n
       - status (VARCHAR) - Tr·∫°ng th√°i (pending, in_progress, done)
       - priority (VARCHAR) - ∆Øu ti√™n (Cao, Trung b√¨nh, Th·∫•p)
       - form4_request_id (FOREIGN KEY -> form4_requests.id) - Li√™n k·∫øt v·ªõi Form 4
       - form4_data (JSON) - D·ªØ li·ªáu t·ª´ Form 4 (JSON)
       - created_at (DATETIME) - Th·ªùi gian t·∫°o
       - updated_at (DATETIME) - Th·ªùi gian c·∫≠p nh·∫≠t
    
    4. TABLE: form5_subtasks (T√°c v·ª• con Form 5)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - task_id (FOREIGN KEY -> form5_tasks.id)
       - name (VARCHAR) - T√™n t√°c v·ª• con
       - pic (VARCHAR) - Ng∆∞·ªùi th·ª±c hi·ªán
       - due_date (DATE) - Ng√†y h·∫øt h·∫°n
       - status (VARCHAR) - Tr·∫°ng th√°i (pending, in_progress, done)
       - priority (VARCHAR) - ∆Øu ti√™n (Cao, Trung b√¨nh, Th·∫•p)
       - declaration_mode (VARCHAR) - Ch·∫ø ƒë·ªô khai b√°o (review-file-nctn, review-ce-qc, train-qc, send-test-task, review-4m, review-fmea)
       - created_at (DATETIME) - Th·ªùi gian t·∫°o
       - updated_at (DATETIME) - Th·ªùi gian c·∫≠p nh·∫≠t
    
    5. TABLE: form5_declarations (Khai b√°o Form 5)
       Columns:
       - id (PRIMARY KEY, AUTO_INCREMENT)
       - subtask_id (FOREIGN KEY -> form5_subtasks.id)
       - declaration_mode (VARCHAR) - Ch·∫ø ƒë·ªô khai b√°o
       - declaration_data (JSON) - D·ªØ li·ªáu khai b√°o (JSON)
       - created_at (DATETIME) - Th·ªùi gian t·∫°o
       - updated_at (DATETIME) - Th·ªùi gian c·∫≠p nh·∫≠t
    
    RELATIONSHIPS:
    - form4_requests (1) -> (1) form5_tasks (via form4_request_id)
    - form5_projects (1) -> (N) form5_tasks (via project_id)
    - form5_tasks (1) -> (N) form5_subtasks (via task_id)
    - form5_subtasks (1) -> (N) form5_declarations (via subtask_id)
    */
    // ============================================
    // END DATABASE STRUCTURE MOCK
    // ============================================

    // H√†m t·∫°o task trong Form 5 t·ª´ d·ªØ li·ªáu Form 4
    /**
     * T√≠nh to√°n th·ªùi gian b·∫Øt ƒë·∫ßu sau khi th√™m s·ªë gi·ªù l√†m vi·ªác
     * Gi·ªù l√†m vi·ªác: 8:00-12:30 (4.5h) v√† 13:30-17:00 (3.5h)
     * @param {Date|string} startDateTime - Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu
     * @param {number} hours - S·ªë gi·ªù c·∫ßn th√™m
     * @returns {Date} - Th·ªùi ƒëi·ªÉm k·∫øt th√∫c (trong gi·ªù l√†m vi·ªác)
     */
    function addWorkingHours(startDateTime, hours) {
      let current = new Date(startDateTime);
      let remainingHours = hours;
      
      // ƒê·∫£m b·∫£o b·∫Øt ƒë·∫ßu t·ª´ gi·ªù l√†m vi·ªác h·ª£p l·ªá
      const hour = current.getHours();
      const minute = current.getMinutes();
      
      // N·∫øu ngo√†i gi·ªù l√†m vi·ªác, chuy·ªÉn ƒë·∫øn 8:00 ng√†y h√¥m sau
      if (hour < 8 || (hour === 12 && minute >= 30) || (hour > 12 && hour < 13) || (hour === 13 && minute < 30) || hour >= 17) {
        current.setDate(current.getDate() + 1);
        current.setHours(8, 0, 0, 0);
      } else if (hour >= 8 && hour < 12) {
        // ƒêang trong bu·ªïi s√°ng, gi·ªØ nguy√™n
      } else if (hour >= 13 && minute >= 30 && hour < 17) {
        // ƒêang trong bu·ªïi chi·ªÅu, gi·ªØ nguy√™n
      }
      
      while (remainingHours > 0) {
        const currentHour = current.getHours();
        const currentMinute = current.getMinutes();
        
        // T√≠nh th·ªùi gian c√≤n l·∫°i trong ng√†y
        let hoursRemainingToday = 0;
        
        if (currentHour < 12 || (currentHour === 12 && currentMinute < 30)) {
          // Bu·ªïi s√°ng: c√≤n l·∫°i ƒë·∫øn 12:30
          const minutesTo1230 = (12 - currentHour) * 60 + (30 - currentMinute);
          hoursRemainingToday = minutesTo1230 / 60;
        } else if (currentHour >= 13 && currentMinute >= 30 && currentHour < 17) {
          // Bu·ªïi chi·ªÅu: c√≤n l·∫°i ƒë·∫øn 17:00
          const minutesTo1700 = (17 - currentHour) * 60 - currentMinute;
          hoursRemainingToday = minutesTo1700 / 60;
        } else {
          // Ngo√†i gi·ªù l√†m vi·ªác, chuy·ªÉn ƒë·∫øn 8:00 ng√†y h√¥m sau
          current.setDate(current.getDate() + 1);
          current.setHours(8, 0, 0, 0);
          continue;
        }
        
        // N·∫øu s·ªë gi·ªù c√≤n l·∫°i <= th·ªùi gian c√≤n l·∫°i trong ng√†y
        if (remainingHours <= hoursRemainingToday) {
          // Th√™m tr·ª±c ti·∫øp v√†o th·ªùi ƒëi·ªÉm hi·ªán t·∫°i
          current.setTime(current.getTime() + remainingHours * 60 * 60 * 1000);
          remainingHours = 0;
        } else {
          // V∆∞·ª£t qu√° ng√†y h√¥m nay, chuy·ªÉn sang ng√†y h√¥m sau
          remainingHours -= hoursRemainingToday;
          current.setDate(current.getDate() + 1);
          current.setHours(8, 0, 0, 0);
        }
      }
      
      return current;
    }

    /**
     * T·ª± ƒë·ªông t·∫°o 3 subtask A, B, C cho task X
     * A: X + 4h l√†m vi·ªác
     * B: A.completedAt + A.manhour (s·∫Ω t√≠nh khi A done)
     * C: B.completedAt + 4h l√†m vi·ªác (s·∫Ω t√≠nh khi B done)
     * @param {Object} taskX - Task ch√≠nh t·ª´ Form 4
     * @param {Object} project - Project ch·ª©a task
     * @returns {Promise<Array>} - M·∫£ng 3 subtask ƒë√£ t·∫°o
     */
    async function autoCreateSubtasksABC(taskX, project) {
      try {
        console.log('[Form 5] Auto-creating subtasks A, B, C for task:', taskX.taskName);
        
        // T√≠nh th·ªùi gian b·∫Øt ƒë·∫ßu cho subtask A
        // timesend = Th·ªùi gian hi·ªán t·∫°i khi t·∫°o subtask (th·ªùi gian g·ª≠i Form 4)
        const timeA = new Date();
        // finishTime: null - Backend s·∫Ω x·ª≠ l√Ω
        
        // Format datetime cho timesend - d·∫°ng YYYY-MM-DD HH:mm
        const formatDateTime = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return `${year}-${month}-${day} ${hours}:${minutes}`;
        };
        
        // L·∫•y projectCode t·ª´ project (ƒë·∫£m b·∫£o th·ªëng nh·∫•t v·ªõi Task X)
        // ∆Øu ti√™n project.projectCode v√¨ project ƒë√£ ƒë∆∞·ª£c x√°c ƒë·ªãnh ƒë√∫ng khi t·∫°o Task X
        const projectCode = project.projectCode || null;
        // D√πng TaskRequestCode thay v√¨ parentTaskId v√¨ Task X ch∆∞a c√≥ ID t·ª´ database
        const parentTaskRequestCode = taskX.taskCode || taskX.form4Data?.requestCode || '';
        
        if (!parentTaskRequestCode) {
          throw new Error('Kh√¥ng t√¨m th·∫•y TaskRequestCode c·ªßa task cha');
        }
        
        // T√™n subtask (c√≥ th·ªÉ config sau)
        const subtaskNames = {
          A: 'Ki·ªÉm tra v√† chu·∫©n b·ªã t√†i li·ªáu',
          B: 'Th·ª±c hi·ªán ƒë√°nh gi√° v√† test',
          C: 'Ho√†n thi·ªán b√°o c√°o v√† nghi·ªám thu'
        };
        
        // T·∫°o 3 subtask
        const subtasks = [];
        
        // Subtask A - PIC = ng∆∞·ªùi ƒë∆∞·ª£c giao Task, timesend = Th·ªùi gian g·ª≠i Task X, finishTime = null (backend x·ª≠ l√Ω)
        const subtaskA = {
          name: subtaskNames.A,
          pic: taskX.pic || '', // PIC m·∫∑c ƒë·ªãnh l√† ng∆∞·ªùi ƒë∆∞·ª£c giao Task
          manhour: null, // S·∫Ω ƒëi·ªÅn sau
          status: 'Ch∆∞a tri·ªÉn khai',
          timesend: formatDateTime(timeA), // timesend = Th·ªùi gian g·ª≠i Task X (createdAt)
          finishTime: null, // Backend s·∫Ω x·ª≠ l√Ω finishTime
          note: 'T·ª± ƒë·ªông t·∫°o t·ª´ Form 4',
          declarationMode: '', // C√≥ th·ªÉ config sau
          subtaskNo: 1,
          itemCode: taskX.form4Data?.itemCode || '',
          type: 'form5_subtask_auto_a',
          autoCreated: true,
          dependsOn: null,
          waitingFor: null
        };
        
        // Subtask B - PIC = Evaluator (Ng∆∞·ªùi nh·∫≠n ƒë√°nh gi√°), timesend = null (backend x·ª≠ l√Ω)
        const subtaskB = {
          name: subtaskNames.B,
          pic: taskX.form4Data?.evaluator || taskX.pic || '', // PIC = Evaluator t·ª´ Form 4
          manhour: null, // Backend x·ª≠ l√Ω
          status: 'Ch∆∞a tri·ªÉn khai',
          timesend: null, // Backend s·∫Ω t√≠nh timesend
          note: 'T·ª± ƒë·ªông t·∫°o t·ª´ Form 4 - Ch·ªù subtask A ho√†n th√†nh',
          declarationMode: '',
          subtaskNo: 2,
          itemCode: taskX.form4Data?.itemCode || '',
          type: 'form5_subtask_auto_b',
          autoCreated: true,
          dependsOn: null, // S·∫Ω set ID c·ªßa A sau khi t·∫°o
          waitingFor: 'A'
        };
        
        // Subtask C - PIC = ng∆∞·ªùi ƒë∆∞·ª£c giao Task, timesend = null (backend x·ª≠ l√Ω)
        const subtaskC = {
          name: subtaskNames.C,
          pic: taskX.pic || '', // PIC m·∫∑c ƒë·ªãnh l√† ng∆∞·ªùi ƒë∆∞·ª£c giao Task
          manhour: null,
          status: 'Ch∆∞a tri·ªÉn khai',
          timesend: null, // Backend s·∫Ω t√≠nh timesend
          note: 'T·ª± ƒë·ªông t·∫°o t·ª´ Form 4 - Ch·ªù subtask B ho√†n th√†nh',
          declarationMode: '',
          subtaskNo: 3,
          itemCode: taskX.form4Data?.itemCode || '',
          type: 'form5_subtask_auto_c',
          autoCreated: true,
          dependsOn: null, // S·∫Ω set ID c·ªßa B sau khi t·∫°o
          waitingFor: 'B'
        };
        
        // Format d·ªØ li·ªáu task cha ƒë·ªÉ g·ª≠i k√®m
        const taskDataForDB = {
          TaskRequestCode: taskX.taskCode || '',
          TaskRequesterName: taskX.requesterName || '',
          TaskRequesterEmail: taskX.requesterEmail || '',
          TaskRequestDate: taskX.createdAt || '',
          TaskDeptRequest: taskX.department || '',
          TaskItemName: taskX.taskName || '',
          TaskItemCode: taskX.form4Data?.itemCode || '',
          TaskComponentType: taskX.form4Data?.componentType || '',
          TaskComponentStandard: taskX.form4Data?.componentStandard || '',
          TaskPurpose: taskX.form4Data?.purpose || '',
          TaskVendor: taskX.form4Data?.vendor || '',
          TaskQtySamples: taskX.form4Data?.qtySamples || '',
          TaskDesiredDate: taskX.dueDate || '',
          TaskPersonReceived: taskX.pic || '',
          TaskNotes: taskX.form4Data?.changeReq || '',
          TaskAppliedModel: taskX.form4Data?.appliedModel || '',
          TaskAttachments: taskX.form4Data?.attachments || '',
          TaskCode: taskX.taskCode || '',
          TaskName: taskX.taskName || '',
          TaskDescription: taskX.description || '',
          TaskPIC: taskX.pic || '',
          TaskDepartment: taskX.department || '',
          TaskCreatedAt: taskX.createdAt || '',
          TaskDueDate: taskX.dueDate || '',
          TaskStatus: taskX.status || 'pending',
          TaskPriority: taskX.priority || 'Trung b√¨nh',
          project_code: projectCode || null
        };
        
        // G·ª≠i t·ª´ng subtask l√™n backend
        const createdSubtasks = [];
        
        // T·∫°o subtask A
        const qaNbCodeA = generateQANBCodeForForm4();
        const subtaskAData = formatSubtaskToNocoDB({
          name: subtaskA.name,
          pic: subtaskA.pic,
          manhour: subtaskA.manhour,
          status: 'Ch∆∞a tri·ªÉn khai',
          checklist: '',
          timesend: subtaskA.timesend,
          finishTime: null, // Backend s·∫Ω x·ª≠ l√Ω finishTime
          note: subtaskA.note,
          priority: 'Trung b√¨nh',
          declarationMode: subtaskA.declarationMode,
          subtaskNo: subtaskA.subtaskNo,
          itemCode: subtaskA.itemCode,
          taskCode: qaNbCodeA,
          type: subtaskA.type // Th√™m type ƒë·ªÉ formatSubtaskToNocoDB s·ª≠ d·ª•ng
        }, parentTaskRequestCode, projectCode, taskX.taskCode);
        
        const resultA = await submitSubtaskToNocoDB(subtaskAData, taskDataForDB);
        createdSubtasks.push({ ...subtaskA, id: resultA.Id || resultA.id, taskCode: qaNbCodeA });
        console.log('[Form 5] Created subtask A:', resultA);
        
        // T·∫°o subtask B (v·ªõi dependsOn = A.id)
        const qaNbCodeB = generateQANBCodeForForm4();
        const subtaskBData = formatSubtaskToNocoDB({
          name: subtaskB.name,
          pic: subtaskB.pic,
          manhour: subtaskB.manhour,
          status: 'Ch∆∞a tri·ªÉn khai',
          checklist: '',
          timesend: null, // Backend s·∫Ω t√≠nh timesend
          finishTime: null,
          note: subtaskB.note,
          priority: 'Trung b√¨nh',
          declarationMode: subtaskB.declarationMode,
          subtaskNo: subtaskB.subtaskNo,
          itemCode: subtaskB.itemCode,
          taskCode: qaNbCodeB,
          type: subtaskB.type // Th√™m type ƒë·ªÉ formatSubtaskToNocoDB s·ª≠ d·ª•ng
        }, parentTaskRequestCode, projectCode, taskX.taskCode);
        
        // Th√™m th√¥ng tin dependsOn v√†o note ho·∫∑c custom field
        subtaskBData.SubtaskNote = `${subtaskB.note} | dependsOn: ${resultA.Id || resultA.id}`;
        
        const resultB = await submitSubtaskToNocoDB(subtaskBData, taskDataForDB);
        createdSubtasks.push({ ...subtaskB, id: resultB.Id || resultB.id, taskCode: qaNbCodeB, dependsOn: resultA.Id || resultA.id });
        console.log('[Form 5] Created subtask B:', resultB);
        
        // T·∫°o subtask C (v·ªõi dependsOn = B.id)
        const qaNbCodeC = generateQANBCodeForForm4();
        const subtaskCData = formatSubtaskToNocoDB({
          name: subtaskC.name,
          pic: subtaskC.pic,
          manhour: subtaskC.manhour,
          status: 'Ch∆∞a tri·ªÉn khai',
          checklist: '',
          timesend: null, // Backend s·∫Ω t√≠nh timesend
          finishTime: null,
          note: subtaskC.note,
          priority: 'Trung b√¨nh',
          declarationMode: subtaskC.declarationMode,
          subtaskNo: subtaskC.subtaskNo,
          itemCode: subtaskC.itemCode,
          taskCode: qaNbCodeC,
          type: subtaskC.type // Th√™m type ƒë·ªÉ formatSubtaskToNocoDB s·ª≠ d·ª•ng
        }, parentTaskRequestCode, projectCode, taskX.taskCode);
        
        // Th√™m th√¥ng tin dependsOn v√†o note
        subtaskCData.SubtaskNote = `${subtaskC.note} | dependsOn: ${resultB.Id || resultB.id}`;
        
        const resultC = await submitSubtaskToNocoDB(subtaskCData, taskDataForDB);
        createdSubtasks.push({ ...subtaskC, id: resultC.Id || resultC.id, taskCode: qaNbCodeC, dependsOn: resultB.Id || resultB.id });
        console.log('[Form 5] Created subtask C:', resultC);
        
        // Th√™m v√†o taskX.subtasks (local)
        if (!taskX.subtasks) {
          taskX.subtasks = [];
        }
        createdSubtasks.forEach(st => {
          taskX.subtasks.push({
            id: st.id,
            name: st.name,
            pic: st.pic,
            manhour: st.manhour,
            status: 'Ch∆∞a tri·ªÉn khai',
            timesend: st.timesend,
            finishTime: st.finishTime, // finishTime: null cho subtask A (backend x·ª≠ l√Ω), null cho B v√† C
            note: st.note,
            declarationMode: st.declarationMode,
            subtaskNo: st.subtaskNo,
            itemCode: st.itemCode,
            type: st.type,
            autoCreated: true,
            dependsOn: st.dependsOn,
            waitingFor: st.waitingFor,
            subtaskCode: st.taskCode
          });
        });
        
        console.log('[Form 5] Successfully created 3 subtasks A, B, C');
        return createdSubtasks;
        
      } catch (error) {
        console.error('[Form 5] Error auto-creating subtasks:', error);
        showToast('L·ªói khi t·∫°o t·ª± ƒë·ªông subtask A, B, C: ' + error.message, 'error');
        throw error;
      }
    }

    function createF5TaskFromForm4(form4Data) {
      const now = new Date();
      const taskId = `TASK-${Date.now()}`;
      
      // X√°c ƒë·ªãnh project d·ª±a tr√™n purpose ho·∫∑c t·∫°o project m·ªõi
      let targetProject = null;
      const purpose = form4Data.purpose || '';
      const projectCode = form4Data.projectCode || '';
      
      // T√¨m project theo projectCode n·∫øu c√≥
      if (projectCode) {
        targetProject = F5_PROJECTS.find(p => p.projectCode === projectCode);
      }
      
      // N·∫øu kh√¥ng t√¨m th·∫•y, t√¨m project theo purpose
      if (!targetProject) {
        if (purpose.includes('SP m·ªõi') || purpose.includes('ƒê√°nh gi√° SP m·ªõi')) {
          targetProject = F5_PROJECTS.find(p => p.projectName.includes('S·∫£n ph·∫©m M·ªõi'));
        } else if (purpose.includes('SOP') || purpose.includes('S·∫£n ph·∫©m SOP')) {
          targetProject = F5_PROJECTS.find(p => p.projectName.includes('S·∫£n ph·∫©m SOP'));
        }
      }
      
      // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, t·∫°o project m·ªõi
      if (!targetProject) {
        const quarter = Math.floor((now.getMonth() + 3) / 3);
        const year = now.getFullYear();
        const projectId = `PROJ-${Date.now()}`;
        const newProjectCode = projectCode || `PRJ-${String(Date.now()).slice(-6)}`;
        
        targetProject = {
          id: projectId,
          projectCode: newProjectCode,
          projectName: purpose.includes('SP m·ªõi') 
            ? `D·ª± √°n ƒê√°nh gi√° S·∫£n ph·∫©m M·ªõi - Q${quarter}/${year}`
            : `D·ª± √°n ƒê√°nh gi√° S·∫£n ph·∫©m SOP - Q${quarter}/${year}`,
          description: `ƒê√°nh gi√° c√°c s·∫£n ph·∫©m trong qu√Ω ${quarter} nƒÉm ${year}`,
          pic: form4Data.pic || form4Data.Receiver || '',
          createdAt: now.toISOString().split('T')[0],
          dueDate: form4Data.desiredDate || '',
          status: 'in_progress',
          expanded: false,
          tasks: []
        };
        
        F5_PROJECTS.push(targetProject);
        console.log('[Form 5] Created new project:', targetProject.projectName);
      }
      
      // T·∫°o task m·ªõi
      const newTask = {
        id: taskId,
        taskCode: form4Data.requestCode || `QA.SPM.${String(Date.now()).slice(-6)}`,
        taskName: form4Data.itemName || 'T√°c v·ª• m·ªõi',
        description: `Y√™u c·∫ßu ƒë√°nh gi√° ${form4Data.itemName || ''}${form4Data.itemCode ? ` (M√£: ${form4Data.itemCode})` : ''}${form4Data.vendor ? ` t·ª´ nh√† cung c·∫•p ${form4Data.vendor}` : ''}. ${form4Data.changeReq || ''}`,
        pic: form4Data.pic || form4Data.Receiver || '',
        requesterName: form4Data.requesterName || '',
        requesterEmail: form4Data.email || '',
        department: form4Data.deptRequest || '',
        createdAt: form4Data.requestDate ? form4Data.requestDate.split(' ')[0] : now.toISOString().split('T')[0],
        dueDate: form4Data.desiredDate || '',
        status: 'pending',
        priority: 'Trung b√¨nh',
        expanded: false,
        checked: false,
        // Th√¥ng tin chi ti·∫øt t·ª´ Form 4
        form4Data: {
          itemCode: form4Data.itemCode || '',
          componentType: form4Data.componentType || '',
          componentStandard: form4Data.componentStandard || '',
          purpose: form4Data.purpose || '',
          projectCode: targetProject.projectCode || form4Data.projectCode || '', // ƒê·∫£m b·∫£o projectCode t·ª´ project
          vendor: form4Data.vendor || '',
          qtySamples: form4Data.qtySamples || '',
          changeReq: form4Data.changeReq || '',
          evaluator: form4Data.evaluator || '',
          attachments: form4Data.attachments || ''
        },
        subtasks: [] // Kh·ªüi t·∫°o m·∫£ng subtasks r·ªóng
      };
      
      // Th√™m task v√†o project
      if (!targetProject.tasks) {
        targetProject.tasks = [];
      }
      targetProject.tasks.push(newTask);
      
      console.log('[Form 5] Created new task from Form 4:', newTask.taskName, 'in project:', targetProject.projectName);
      
      // T·ª± ƒë·ªông t·∫°o 3 subtask A, B, C
      autoCreateSubtasksABC(newTask, targetProject)
        .then((createdSubtasks) => {
          console.log('[Form 5] Auto-created subtasks:', createdSubtasks);
          showToast(`ƒê√£ t·∫°o t√°c v·ª• "${newTask.taskName}" v√† 3 subtask t·ª± ƒë·ªông (A, B, C)`, 'success');
          
          // Reload d·ªØ li·ªáu t·ª´ server ƒë·ªÉ hi·ªÉn th·ªã subtask m·ªõi
          loadF5Projects(F5_FILTER_PIC).then(() => {
            // T√¨m l·∫°i task sau khi reload v√† expand n√≥
            const resultAfterReload = findF5Task(taskId);
            if (resultAfterReload && resultAfterReload.task) {
              resultAfterReload.task.expanded = true;
              if (resultAfterReload.project) {
                resultAfterReload.project.expanded = true;
              }
            }
            
            // Render l·∫°i b·∫£ng
            renderF5TasksTable();
            
            // Scroll ƒë·∫øn task m·ªõi
            setTimeout(() => {
              const taskRow = document.querySelector(`[data-task-id="${taskId}"]`);
              if (taskRow) {
                taskRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                taskRow.classList.add('bg-blue-100');
                setTimeout(() => taskRow.classList.remove('bg-blue-100'), 3000);
              }
            }, 100);
          }).catch((error) => {
            console.error('[Form 5] Error reloading data after creating subtasks:', error);
            // V·∫´n render v·ªõi d·ªØ li·ªáu local
            renderF5TasksTable();
          });
        })
        .catch((error) => {
          console.error('[Form 5] Error creating auto subtasks:', error);
          // V·∫´n hi·ªÉn th·ªã task X d√π subtask l·ªói
          showToast(`ƒê√£ t·∫°o t√°c v·ª• "${newTask.taskName}" nh∆∞ng c√≥ l·ªói khi t·∫°o subtask t·ª± ƒë·ªông`, 'warning');
        });
      
      // Render l·∫°i Form 5 n·∫øu ƒëang m·ªü
      const form5Section = document.getElementById('form5');
      if (form5Section && !form5Section.classList.contains('hidden')) {
        renderF5TasksTable();
        
        // Chuy·ªÉn sang Form 5 v√† expand project/task
        targetProject.expanded = true;
        newTask.expanded = true;
        switchToForm('form5');
      }
      
      return newTask;
    }

    // ===== FORM 5 - QU·∫¢N L√ù T√ÅC V·ª§ S·∫¢N PH·∫®M M·ªöI =====
    
    // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu projects - s·∫Ω ƒë∆∞·ª£c load t·ª´ API
    let F5_PROJECTS = [];
    let F5_FILTER_PIC = ''; // Filter theo ng∆∞·ªùi nh·∫≠n t√°c v·ª•
    // Filter theo th√°ng d·ª±a tr√™n ng√†y g·ª≠i (timesend) - m·∫∑c ƒë·ªãnh l√† th√°ng hi·ªán t·∫°i
    const now = new Date();
    let F5_FILTER_MONTH = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    
    // Danh s√°ch t√™n "Ng∆∞·ªùi nh·∫≠n t√°c v·ª•" c·ªë ƒë·ªãnh
    const F5_PIC_LIST = [
      "Nguy·ªÖn H·ªØu Th·ªãnh",
      "Nguy·ªÖn VƒÉn Hi·∫øu",
      "V≈© Th·ªã H·∫±ng",
      "Nguy·ªÖn VƒÉn Linh",
      "ƒê√†o Ho√†ng D∆∞∆°ng",
      "B√πi ƒê·∫∑ng Qu·ªëc Huy",
      "ƒê√†o Tu·∫•n K·ª≥",
      "Th√°i Th·ªã Giang",
      "Tr·∫ßn Hi·∫øu Nghƒ©a"
    ];
    
    /**
     * Load d·ªØ li·ªáu projects v√† tasks t·ª´ API
     * Transform t·ª´ format NocoDB (m·∫£ng c√°c task records) sang format UI (projects v·ªõi tasks)
     * @param {string} picFilter - T√™n ng∆∞·ªùi nh·∫≠n t√°c v·ª• ƒë·ªÉ l·ªçc (optional)
     * @returns {Promise<Array>} - M·∫£ng projects v·ªõi c·∫•u tr√∫c: [{ id, projectCode, projectName, tasks: [...] }]
     */
    async function loadF5Projects(picFilter = '') {
      try {
        // Th·ª≠ g·ªçi API v·ªõi tham s·ªë ƒë·ªÉ l·∫•y t·∫•t c·∫£ records
        // N·∫øu API kh√¥ng h·ªó tr·ª£ tham s·ªë, s·∫Ω fallback v·ªÅ URL g·ªëc
        let url = 'https://iatzhxxuk.tino.page/webhook/form5-task-summary?limit=1000&all=true';
        // Th√™m tham s·ªë PIC v√†o URL n·∫øu c√≥
        if (picFilter && picFilter.trim()) {
          url += `&pic=${encodeURIComponent(picFilter.trim())}`;
        }
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseText = await response.text();
        console.log('[Form 5] Raw response text length:', responseText.length);
        console.log('[Form 5] Raw response text (first 500 chars):', responseText.substring(0, 500));
        console.log('[Form 5] Raw response text (last 500 chars):', responseText.substring(Math.max(0, responseText.length - 500)));
        console.log('[Form 5] Response starts with [?:', responseText.trim().startsWith('['));
        console.log('[Form 5] Response starts with {?:', responseText.trim().startsWith('{'));
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          console.error('[Form 5] Failed to parse JSON:', e);
          console.error('[Form 5] Response text:', responseText);
          throw e;
        }
        
        console.log('[Form 5] Parsed data:', data);
        console.log('[Form 5] Data type:', typeof data, 'Is array:', Array.isArray(data));
        if (Array.isArray(data)) {
          console.log('[Form 5] Array length:', data.length);
        } else if (data && typeof data === 'object') {
          console.log('[Form 5] Object keys:', Object.keys(data));
          console.log('[Form 5] Full object:', JSON.stringify(data, null, 2).substring(0, 1000));
        }
        
        // X·ª≠ l√Ω nhi·ªÅu format response c√≥ th·ªÉ c√≥
        let records = null;
        
        // MOCK DATA FALLBACK (ƒë·ªÉ debug khi API tr·∫£ v·ªÅ thi·∫øu)
        // N·∫øu API ch·ªâ tr·∫£ v·ªÅ 1 record (object ƒë∆°n) trong khi c·∫ßn array nhi·ªÅu item
        // c√≥ th·ªÉ do webhook config sai.
        // T·∫°m th·ªùi check n·∫øu array length <= 1 v√† data c√≥ v·∫ª thi·∫øu, th·ª≠ d√πng mock data t·ª´ Untitled-1.txt n·∫øu c·∫ßn thi·∫øt.
        // Tuy nhi√™n, code d∆∞·ªõi ƒë√¢y s·∫Ω ∆∞u ti√™n data t·ª´ API n·∫øu n√≥ l√† Array h·ª£p l·ªá.
        
        if (Array.isArray(data)) {
          // Tr∆∞·ªùng h·ª£p 1: API tr·∫£ v·ªÅ array tr·ª±c ti·∫øp
          records = data;
          console.log('[Form 5] Data is array, using directly. Length:', records.length);
        } else if (data && typeof data === 'object') {
          // ... (c√°c check kh√°c gi·ªØ nguy√™n)
          if (Array.isArray(data.data)) {
            records = data.data;
          } else if (Array.isArray(data.records)) {
            records = data.records;
          } else if (Array.isArray(data.tasks)) {
            records = data.tasks;
          } else if (Array.isArray(data.items)) {
            records = data.items;
          } else if (Array.isArray(data.results)) {
            records = data.results;
          } else {
            // Th·ª≠ t√¨m property n√†o ƒë√≥ l√† array
            const arrayKeys = Object.keys(data).filter(key => Array.isArray(data[key]));
            if (arrayKeys.length > 0) {
              records = data[arrayKeys[0]];
            }
          }
        }
        
        if (!Array.isArray(records)) {
          // Th·ª≠ wrap object ƒë∆°n l·∫ª th√†nh array
          if (data && typeof data === 'object' && !Array.isArray(data)) {
             if (data.Id || data.id || data.project_code || data.TaskRequestCode) {
              records = [data];
              console.log('[Form 5] Wrapped single object into array. WARNING: API might be returning only the latest record!');
              // Show warning toast
              showToast('C·∫£nh b√°o: API ch·ªâ tr·∫£ v·ªÅ 1 b·∫£n ghi. Vui l√≤ng ki·ªÉm tra l·∫°i Webhook.', 'warning');
            }
          }
        }

        // --- DEBUG MOCK DATA START ---
        // B·ªè comment d√≤ng d∆∞·ªõi ƒë·ªÉ d√πng d·ªØ li·ªáu m·∫´u n·∫øu API l·ªói
        /*
        if (!records || records.length <= 1) {
           console.warn('[Form 5] API returned few records, trying mock data for debug...');
           records = getMockF5Data();
        }
        */
        // --- DEBUG MOCK DATA END ---

        if (!records || records.length === 0) {
           console.warn('[Form 5] No records found or empty array.');
           return [];
        }

        
        if (records.length === 0) {
          console.warn('[Form 5] Empty array from API');
          return [];
        }
        
        console.log('[Form 5] Processing', records.length, 'records');
        console.log('[Form 5] Records details:', records.map(r => ({ 
          Id: r.Id, 
          TaskRequestCode: r.TaskRequestCode, 
          Subtaskno: r.Subtaskno || r.SubtaskNo,
          SubtaskName: r.SubtaskName 
        })));
        
        // Ph√¢n lo·∫°i records c·∫£i ti·∫øn
        // - TaskRequestCode: group c√°c records c√πng m·ªôt d·ª± √°n
        // - ∆Øu ti√™n check field 'type' n·∫øu c√≥
        // - Sau ƒë√≥ check Subtaskno
        const tasks = [];      // Task ch√≠nh
        const subtasks = [];   // Subtask
        const declarations = []; // Gi·ªØ l·∫°i cho t∆∞∆°ng lai n·∫øu c·∫ßn
        
        records.forEach(record => {
          // 1. X√°c ƒë·ªãnh d·ª±a tr√™n Subtaskno
          let subtaskNo = record.Subtaskno !== undefined ? record.Subtaskno : record.SubtaskNo;
          if (subtaskNo !== null && subtaskNo !== undefined) {
            subtaskNo = Number(subtaskNo);
          }

          // 2. X√°c ƒë·ªãnh d·ª±a tr√™n type (n·∫øu c√≥)
          const type = record.type || '';
          const isSubtaskByType = type && typeof type === 'string' && type.includes('subtask');

          // Logic ph√¢n lo·∫°i:
          // - N·∫øu type ch·ª©a 'subtask' -> SUBTASK
          // - Ho·∫∑c n·∫øu Subtaskno l√† s·ªë > 0 -> SUBTASK
          // - Ho·∫∑c n·∫øu c√≥ parent_id v√† kh√¥ng c√≥ TaskRequestCode -> SUBTASK
          // - Ng∆∞·ª£c l·∫°i -> TASK
          
          const hasParentId = record.parent_id !== null && record.parent_id !== undefined;
          const hasTaskRequestCode = record.TaskRequestCode && String(record.TaskRequestCode).trim();
          
          const isSubtask = isSubtaskByType || 
                           (typeof subtaskNo === 'number' && !isNaN(subtaskNo) && subtaskNo > 0) ||
                           (hasParentId && !hasTaskRequestCode);

          if (isSubtask) {
            subtasks.push(record);
            console.log(`[Form 5] Classified as SUBTASK: Id=${record.Id}, Subtaskno=${subtaskNo}, Type=${type}, parent_id=${record.parent_id}`);
          } else {
            // Ch·ªâ th√™m task n·∫øu c√≥ TaskRequestCode (task ch√≠nh)
            const taskRequestCode = String(record.TaskRequestCode || '').trim();
            if (taskRequestCode) {
              tasks.push(record);
              console.log(`[Form 5] Classified as TASK: Id=${record.Id}, Subtaskno=${subtaskNo}, Type=${type}, TaskRequestCode=${taskRequestCode}`);
            } else {
              console.warn(`[Form 5] Skipping record Id=${record.Id}: No TaskRequestCode and not a subtask`);
            }
          }
        });
        
        console.log('[Form 5] Classified:', { tasks: tasks.length, subtasks: subtasks.length, declarations: declarations.length });
        console.log('[Form 5] Tasks:', tasks.map(t => ({ Id: t.Id, TaskRequestCode: t.TaskRequestCode, Subtaskno: t.Subtaskno })));
        console.log('[Form 5] Subtasks:', subtasks.map(s => ({ Id: s.Id, TaskRequestCode: s.TaskRequestCode, Subtaskno: s.Subtaskno, SubtaskName: s.SubtaskName })));
        
        // Group subtasks theo parent_id (ID c·ªßa task cha)
        // T·∫°o map: parent_id -> [subtasks]
        const subtasksByParentId = {};
        subtasks.forEach(subtask => {
          const parentId = subtask.parent_id;
          if (parentId !== null && parentId !== undefined) {
            // Chu·∫©n h√≥a parent_id (c√≥ th·ªÉ l√† string ho·∫∑c number)
            const parentIdKey = String(parentId).trim();
            if (parentIdKey) {
              if (!subtasksByParentId[parentIdKey]) {
                subtasksByParentId[parentIdKey] = [];
              }
              subtasksByParentId[parentIdKey].push(subtask);
            }
          }
        });
        console.log('[Form 5] Subtasks grouped by parent_id keys:', Object.keys(subtasksByParentId));
        
        // T·∫°o map TaskRequestCode -> Task Id ƒë·ªÉ map subtask v·ªõi task
        const taskRequestCodeToId = {};
        tasks.forEach(task => {
          const taskRequestCode = String(task.TaskRequestCode || '').trim();
          if (taskRequestCode) {
            taskRequestCodeToId[taskRequestCode.toLowerCase()] = task.Id;
          }
        });
        
        // Group declarations theo parent_id (subtask Id)
        const declarationsBySubtaskId = {};
        declarations.forEach(declaration => {
          const subtaskId = declaration.parent_id;
          if (!declarationsBySubtaskId[subtaskId]) {
            declarationsBySubtaskId[subtaskId] = [];
          }
          declarationsBySubtaskId[subtaskId].push(declaration);
        });
        
        // Group tasks theo project_code
        const projectsMap = {};
        
        tasks.forEach(taskRecord => {
          const projectCode = taskRecord.project_code || 'UNKNOWN';
          
          // T·∫°o project n·∫øu ch∆∞a t·ªìn t·∫°i
          if (!projectsMap[projectCode]) {
            // T·∫°o t√™n project d·ª±a tr√™n TaskPurpose ho·∫∑c project_code
            const purpose = taskRecord.TaskPurpose || '';
            let projectName = `D·ª± √°n ${projectCode}`;
            if (purpose.includes('SP m·ªõi') || purpose.includes('ƒê√°nh gi√° SP m·ªõi')) {
              projectName = `D·ª± √°n ƒê√°nh gi√° S·∫£n ph·∫©m M·ªõi - ${projectCode}`;
            } else if (purpose.includes('SOP') || purpose.includes('S·∫£n ph·∫©m SOP')) {
              projectName = `D·ª± √°n ƒê√°nh gi√° S·∫£n ph·∫©m SOP - ${projectCode}`;
            }
            
            projectsMap[projectCode] = {
              id: `PROJ-${projectCode}`,
              projectCode: projectCode,
              projectName: projectName,
              description: '',
              pic: taskRecord.TaskPIC || taskRecord.TaskPersonReceived || '',
              createdAt: taskRecord.CreatedAt ? taskRecord.CreatedAt.split(' ')[0] : new Date().toISOString().split('T')[0],
              dueDate: taskRecord.TaskDesiredDate || '',
              status: 'in_progress', // M·∫∑c ƒë·ªãnh
              expanded: true, // M·ªü r·ªông m·∫∑c ƒë·ªãnh ƒë·ªÉ hi·ªÉn th·ªã tasks
              tasks: []
            };
          }
          
          // Transform task record th√†nh format UI
          const taskId = taskRecord.Id;
          const taskRequestCode = String(taskRecord.TaskRequestCode || '').trim();
          
          // L·∫•y subtasks theo parent_id (ID c·ªßa task n√†y)
          // Th·ª≠ match v·ªõi parent_id d·∫°ng string v√† number
          const taskIdKey = String(taskId);
          let taskSubtasksRaw = subtasksByParentId[taskIdKey] || 
                               subtasksByParentId[String(taskId)] || 
                               [];
          
          // FALLBACK: N·∫øu kh√¥ng t√¨m th·∫•y subtask b·∫±ng parent_id, th·ª≠ t√¨m b·∫±ng TaskRequestCode
          // (Tr∆∞·ªùng h·ª£p backend ch∆∞a update parent_id t·ª´ TaskRequestCode -> Id)
          if (taskSubtasksRaw.length === 0 && taskRequestCode) {
            taskSubtasksRaw = subtasks.filter(subtask => {
              // Ki·ªÉm tra n·∫øu subtask c√≥ TaskRequestCode kh·ªõp
              const subtaskTaskRequestCode = String(subtask.TaskRequestCode || '').trim();
              if (subtaskTaskRequestCode && subtaskTaskRequestCode.toLowerCase() === taskRequestCode.toLowerCase()) {
                return true;
              }
              // Ho·∫∑c n·∫øu parent_id l√† TaskRequestCode (string d√†i, kh√¥ng ph·∫£i s·ªë)
              const parentId = String(subtask.parent_id || '').trim();
              if (parentId && parentId.length > 10 && parentId.toLowerCase() === taskRequestCode.toLowerCase()) {
                return true;
              }
              return false;
            });
            if (taskSubtasksRaw.length > 0) {
              console.log(`[Form 5] Found ${taskSubtasksRaw.length} subtasks by TaskRequestCode fallback for task ${taskId}`);
            }
          }
          
          console.log(`[Form 5] Task ${taskId} (${taskRequestCode}) has ${taskSubtasksRaw.length} subtasks:`, taskSubtasksRaw.map(s => ({ Id: s.Id, SubtaskName: s.SubtaskName, Subtaskno: s.Subtaskno, parent_id: s.parent_id })));
          
          // S·∫Øp x·∫øp subtasks theo Subtaskno (Subtaskno != 0)
          const sortedSubtasks = [...taskSubtasksRaw].sort((a, b) => {
            const noA = a.Subtaskno || a.SubtaskNo || 0;
            const noB = b.Subtaskno || b.SubtaskNo || 0;
            return noA - noB;
          });
          
          const taskSubtasks = sortedSubtasks.map((subtaskRecord) => {
            const subtaskId = subtaskRecord.Id;
            const subtaskNo = subtaskRecord.Subtaskno || subtaskRecord.SubtaskNo || null;
            // Map c√°c tr∆∞·ªùng t·ª´ API (c√≥ th·ªÉ c√≥ c·∫£ SubtaskStatus v√† Subtaskstatus)
            const subtaskStatus = subtaskRecord.SubtaskStatus || subtaskRecord.Subtaskstatus || 'pending';
            
            // L·∫•y type t·ª´ webhook v√† extract declaration mode n·∫øu c√≥
            const type = subtaskRecord.type || '';
            let declarationMode = subtaskRecord.SubtaskDeclarationMode || '';
            
            // N·∫øu c√≥ type d·∫°ng "form5_subtask_<mode>", extract mode t·ª´ type
            // B·ªè qua c√°c type "auto_a", "auto_b", "auto_c" v√¨ ch√∫ng kh√¥ng ph·∫£i l√† declaration mode h·ª£p l·ªá
            if (type && type.startsWith('form5_subtask_')) {
              const extractedMode = type.replace('form5_subtask_', '');
              // Ch·ªâ extract n·∫øu kh√¥ng ph·∫£i l√† auto_a, auto_b, auto_c
              if (extractedMode && !extractedMode.startsWith('auto_')) {
                declarationMode = extractedMode;
              }
            }
            
            // Ch·ªâ l·∫•y deadline t·ª´ Subtaskdeadline (kh√¥ng l·∫•y t·ª´ tr∆∞·ªùng kh√°c)
            const deadlineValue = subtaskRecord.Subtaskdeadline || subtaskRecord.SubtaskDeadline || '';
            
            return {
              id: `SUB-${subtaskId}`,
              name: subtaskRecord.SubtaskName || '',
              pic: subtaskRecord.SubtaskPIC || '',
              deadline: deadlineValue, // Ch·ªâ t·ª´ Subtaskdeadline
              dueDate: deadlineValue, // Gi·ªØ ƒë·ªÉ backward compatibility
              status: subtaskStatus,
              priority: subtaskRecord.SubtaskPriority || 'Trung b√¨nh',
              checked: subtaskStatus === 'done',
              type: type, // L∆∞u type t·ª´ webhook
              declarationMode: declarationMode, // Declaration mode (t·ª´ SubtaskDeclarationMode ho·∫∑c extract t·ª´ type)
              manhour: subtaskRecord.Subtaskmanhour || null,
              timespend: subtaskRecord.Subtasktimespend || null, // S·ªë gi·ªù th·ª±c hi·ªán
              checklist: subtaskRecord.Subtaskchecklist || '',
              checklistLink: subtaskRecord.Subtaskformlink || null, // Link file checklist t·ª´ webhook
              // L·∫•y timesend tr·ª±c ti·∫øp t·ª´ Subtasktimesend, kh√¥ng convert timezone
              timesend: subtaskRecord.Subtasktimesend || null,
              finishTime: subtaskRecord.Subtaskfinishtime || null,
              note: subtaskRecord.Subtasknote || '',
              subtaskNo: subtaskNo, // S·ªë th·ª© t·ª± subtask t·ª´ database (1, 2, 3...)
              itemCode: subtaskRecord.Subtaskitemcode || '', // M√£ linh ki·ªán/s·∫£n ph·∫©m t·ª´ webhook
              subtaskCode: subtaskRecord.Subtaskcode || subtaskRecord.TaskCode || '', // M√£ t√°c v·ª• c·ªßa subtask
              idBody: subtaskRecord.id_body || null, // L∆∞u id_body t·ª´ webhook
              Subtaskresultlink: (subtaskRecord.Subtaskresultlink && String(subtaskRecord.Subtaskresultlink).trim()) || null, // Link k·∫øt qu·∫£ t·ª´ webhook
              linkBCpdf: (subtaskRecord['link BCpdf'] && String(subtaskRecord['link BCpdf']).trim()) || (subtaskRecord.linkBCpdf && String(subtaskRecord.linkBCpdf).trim()) || null, // Link b√°o c√°o PDF
              linkBCexcel: (subtaskRecord['link BCexcel'] && String(subtaskRecord['link BCexcel']).trim()) || (subtaskRecord.linkBCexcel && String(subtaskRecord.linkBCexcel).trim()) || null // Link b√°o c√°o Excel
            };
          });
          
          // Parse form4Data n·∫øu c√≥
          let form4Data = {};
          if (taskRecord.TaskForm4Data) {
            try {
              form4Data = typeof taskRecord.TaskForm4Data === 'string' 
                ? JSON.parse(taskRecord.TaskForm4Data) 
                : taskRecord.TaskForm4Data;
            } catch (e) {
              console.warn('[Form 5] Failed to parse TaskForm4Data:', e);
            }
          }
          
          // T·∫°o form4Data t·ª´ c√°c tr∆∞·ªùng Task* n·∫øu TaskForm4Data null
          if (!form4Data || Object.keys(form4Data).length === 0) {
            form4Data = {
              requesterName: taskRecord.TaskRequesterName || '',
              email: taskRecord.TaskRequesterEmail || '',
              requestDate: taskRecord.TaskRequestDate || '',
              requestCode: taskRecord.TaskRequestCode || '',
              deptRequest: taskRecord.TaskDeptRequest || '',
              itemName: taskRecord.TaskItemName || '',
              itemCode: taskRecord.TaskItemCode || '',
              componentType: taskRecord.TaskComponentType || '',
              componentStandard: taskRecord.TaskComponentStandard || '',
              purpose: taskRecord.TaskPurpose || '',
              projectCode: taskRecord.project_code || '',
              vendor: taskRecord.TaskVendor || '',
              qtySamples: taskRecord.TaskQtySamples || '',
              desiredDate: taskRecord.TaskDesiredDate || '',
              Receiver: taskRecord.TaskPersonReceived || '',
              pic: taskRecord.TaskPIC || '',
              changeReq: taskRecord.TaskNotes || '',
              appliedModel: taskRecord.TaskAppliedModel || '',
              attachments: taskRecord.TaskAttachments || ''
            };
          }
          
          // L·∫•y status tr·ª±c ti·∫øp t·ª´ tr∆∞·ªùng TaskStatus
          const taskStatus = taskRecord.TaskStatus || 'pending';
          
          const task = {
            id: `TASK-${taskId}`,
            taskCode: taskRecord.TaskRequestCode || taskRecord.TaskCode || '',
            taskName: taskRecord.TaskItemName || taskRecord.TaskName || 'T√°c v·ª• kh√¥ng t√™n',
            description: taskRecord.TaskDescription || `Y√™u c·∫ßu ƒë√°nh gi√° ${taskRecord.TaskItemName || ''}`,
            pic: taskRecord.TaskPIC || taskRecord.TaskPersonReceived || '',
            requesterName: taskRecord.TaskRequesterName || '',
            requesterEmail: taskRecord.TaskRequesterEmail || '',
            department: taskRecord.TaskDeptRequest || taskRecord.TaskDepartment || '',
            createdAt: taskRecord.TaskRequestDate ? taskRecord.TaskRequestDate.split(' ')[0] : (taskRecord.TaskCreatedAt || ''),
            dueDate: taskRecord.TaskDesiredDate || taskRecord.TaskDueDate || '',
            status: taskStatus,
            priority: taskRecord.TaskPriority || 'Trung b√¨nh',
            expanded: taskSubtasks.length > 0, // M·ªü r·ªông n·∫øu c√≥ subtasks
            checked: taskStatus === 'done',
            vendor: taskRecord.TaskVendor || '', // Th√™m TaskVendor t·ª´ webhook
            form4Data: form4Data,
            subtasks: taskSubtasks
          };
          
          projectsMap[projectCode].tasks.push(task);
        });
        
        // Convert projectsMap th√†nh m·∫£ng
        const projects = Object.values(projectsMap);
        
        // T√≠nh to√°n status cho projects d·ª±a tr√™n tasks
        projects.forEach(project => {
          if (project.tasks.length === 0) {
            project.status = 'pending';
          } else {
            const allDone = project.tasks.every(t => t.status === 'done');
            const hasInProgress = project.tasks.some(t => t.status === 'in_progress' || t.status === 'done');
            
            if (allDone) {
              project.status = 'done';
            } else if (hasInProgress) {
              project.status = 'in_progress';
            } else {
              project.status = 'pending';
            }
          }
        });
        
        console.log('[Form 5] Transformed projects:', projects);
        console.log('[Form 5] Total projects:', projects.length);
        console.log('[Form 5] Total tasks:', projects.reduce((sum, p) => sum + (p.tasks?.length || 0), 0));
        
        if (projects.length === 0) {
          console.warn('[Form 5] No projects created after transformation');
        }
        
        return projects;
        
      } catch (error) {
        console.error('[Form 5] Error loading projects:', error);
        showToast('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ server. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
        return [];
      }
    }
    
    // H√†m mock data ƒë·ªÉ test
    function getMockF5Data() {
      return [
  {
    "Id": 3,
    "CreatedAt": "2025-11-22 04:54:06+00:00",
    "UpdatedAt": "2025-11-22 07:35:19+00:00",
    "type": null,
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22 11:33",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "ƒê√°nh gi√° SP m·ªõi",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "TaskNotes": null,
    "TaskChangeFromLastNote": "Kh√¥ng",
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1NPzJaZzwhP3xmXQGKI_Wief1wK0S44o1&export=download",
    "TaskDescription": null,
    "TaskPIC": "V≈© Th·ªã H·∫±ng",
    "TaskDepartment": null,
    "TaskCreatedAt": null,
    "TaskDueDate": null,
    "TaskStatus": null,
    "TaskPriority": null,
    "TaskForm4Data": null,
    "SubtaskName": null,
    "SubtaskPIC": null,
    "Subtaskmanhour": null,
    "Subtaskstatus": null,
    "Subtaskchecklist": null,
    "Subtasktimesend": null,
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": null,
    "Subtaskno": 0,
    "Subtaskformlink": null
  },
  {
    "Id": 7,
    "CreatedAt": "2025-11-22 07:53:04+00:00",
    "UpdatedAt": "2025-11-22 10:13:28+00:00",
    "type": "form5_subtask_send-test-task",
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "ƒê√°nh gi√° SP m·ªõi",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "V≈© Th·ªã H·∫±ng",
    "TaskNotes": null,
    "TaskChangeFromLastNote": null,
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1KI59IqcDd5xCWKbUCuY9A-zSzbjUgSkO&export=download",
    "TaskDescription": "Y√™u c·∫ßu ƒë√°nh gi√° T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng",
    "TaskPIC": "V≈© Th·ªã H·∫±ng",
    "TaskDepartment": "DQA",
    "TaskCreatedAt": "2025-11-22",
    "TaskDueDate": "2025-11-30",
    "TaskStatus": "pending",
    "TaskPriority": "Trung b√¨nh",
    "TaskForm4Data": null,
    "SubtaskName": "√°dasdas",
    "SubtaskPIC": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "Subtaskmanhour": "7",
    "Subtaskstatus": "pending",
    "Subtaskchecklist": "QA.R.25-021521 m·∫´u.xlsx",
    "Subtasktimesend": "2025-11-22 14:52:00+00:00",
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": "dsadasd",
    "Subtaskno": 1,
    "Subtaskformlink": null
  },
  {
    "Id": 8,
    "CreatedAt": "2025-11-22 07:56:17+00:00",
    "UpdatedAt": "2025-11-22 10:14:23+00:00",
    "type": "form5_subtask_send-test-task",
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "ƒê√°nh gi√° SP m·ªõi",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "V≈© Th·ªã H·∫±ng",
    "TaskNotes": null,
    "TaskChangeFromLastNote": null,
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1NPzJaZzwhP3xmXQGKI_Wief1wK0S44o1&export=download",
    "TaskDescription": "Y√™u c·∫ßu ƒë√°nh gi√° T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng",
    "TaskPIC": "V≈© Th·ªã H·∫±ng",
    "TaskDepartment": "DQA",
    "TaskCreatedAt": "2025-11-22",
    "TaskDueDate": "2025-11-30",
    "TaskStatus": "pending",
    "TaskPriority": "Trung b√¨nh",
    "TaskForm4Data": null,
    "SubtaskName": "√°dasdas",
    "SubtaskPIC": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "Subtaskmanhour": "7",
    "Subtaskstatus": "pending",
    "Subtaskchecklist": "QA.R.25-021521 m·∫´u.xlsx",
    "Subtasktimesend": "2025-11-22 14:52:00+00:00",
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": "dsadasd",
    "Subtaskno": 2,
    "Subtaskformlink": "https://drive.google.com/uc?id=1rrDFEdxzGLO_Vr0R5KMhnp1RECuCwJWb&export=download"
  },
  {
    "Id": 9,
    "CreatedAt": "2025-11-22 10:12:08+00:00",
    "UpdatedAt": "2025-11-22 10:14:24+00:00",
    "type": "form5_subtask_send-test-task",
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "ƒê√°nh gi√° SP m·ªõi",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "V≈© Th·ªã H·∫±ng",
    "TaskNotes": null,
    "TaskChangeFromLastNote": null,
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1NPzJaZzwhP3xmXQGKI_Wief1wK0S44o1&export=download",
    "TaskDescription": "Y√™u c·∫ßu ƒë√°nh gi√° T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng",
    "TaskPIC": "V≈© Th·ªã H·∫±ng",
    "TaskDepartment": "DQA",
    "TaskCreatedAt": "2025-11-22",
    "TaskDueDate": "2025-11-30",
    "TaskStatus": "pending",
    "TaskPriority": "Trung b√¨nh",
    "TaskForm4Data": null,
    "SubtaskName": "√°dasdas",
    "SubtaskPIC": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "Subtaskmanhour": "7",
    "Subtaskstatus": "pending",
    "Subtaskchecklist": "QA.R.25-021521 m·∫´u.xlsx",
    "Subtasktimesend": "2025-11-22 14:52:00+00:00",
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": "dsadasd",
    "Subtaskno": 3,
    "Subtaskformlink": "https://drive.google.com/uc?id=19SvQ_bTJ0GVux4qQ8MLdaQPG2xqyVJY_&export=download"
  },
  {
    "Id": 10,
    "CreatedAt": "2025-11-22 10:12:29+00:00",
    "UpdatedAt": "2025-11-22 10:14:24+00:00",
    "type": "form5_subtask_send-test-task",
    "project_code": "DQA001",
    "parent_id": null,
    "TaskRequestCode": "QA.SPM.1122-J8MVRM",
    "TaskRequesterName": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "TaskRequesterEmail": "duong.dao@karofi.vn",
    "TaskRequestDate": "2025-11-22",
    "TaskDeptRequest": "DQA",
    "TaskItemName": "T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng",
    "TaskItemCode": "KTC",
    "TaskComponentType": null,
    "TaskComponentStandard": "0",
    "TaskPurpose": "ƒê√°nh gi√° SP m·ªõi",
    "TaskVendor": "KRF",
    "TaskQtySamples": "1",
    "TaskDesiredDate": "2025-11-30",
    "TaskPersonReceived": "V≈© Th·ªã H·∫±ng",
    "TaskNotes": null,
    "TaskChangeFromLastNote": null,
    "TaskSampleSubmissionNo": null,
    "TaskAltCode": null,
    "TaskAppliedModel": null,
    "TaskAttachments": "https://drive.google.com/uc?id=1NPzJaZzwhP3xmXQGKI_Wief1wK0S44o1&export=download",
    "TaskDescription": "Y√™u c·∫ßu ƒë√°nh gi√° T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng",
    "TaskPIC": "V≈© Th·ªã H·∫±ng",
    "TaskDepartment": "DQA",
    "TaskCreatedAt": "2025-11-22",
    "TaskDueDate": "2025-11-30",
    "TaskStatus": "pending",
    "TaskPriority": "Trung b√¨nh",
    "TaskForm4Data": null,
    "SubtaskName": "tttttttt",
    "SubtaskPIC": "ƒê√†o Ho√†ng D∆∞∆°ng",
    "Subtaskmanhour": "11",
    "Subtaskstatus": "pending",
    "Subtaskchecklist": "QA.R.25-021941.xlsx",
    "Subtasktimesend": "2025-11-22 17:11:00+00:00",
    "Subtaskfinishtime": null,
    "Subtaskreport": null,
    "Subtasknote": "adsada",
    "Subtaskno": 4,
    "Subtaskformlink": "https://drive.google.com/uc?id=1-olIvU5U9Bw99dmE1loGSyfxv0c9OIaz&export=download"
  }
];
    }

    // Helper ƒë·ªÉ convert t·ª´ tasks sang projects (backward compatibility)
    function getF5AllTasks() {
      const allTasks = [];
      F5_PROJECTS.forEach(project => {
        if (project.tasks) {
          project.tasks.forEach(task => {
            allTasks.push({ ...task, projectCode: project.projectCode, projectId: project.id });
          });
        }
      });
      return allTasks;
    }

    // H√†m flatten d·ªØ li·ªáu Form 5 ƒë·ªÉ xu·∫•t Excel
    function flattenF5DataForExport() {
      const flatData = [];
      
      F5_PROJECTS.forEach(project => {
        // Project row
        flatData.push({
          'C·∫•p': 'Project',
          'T√™n t√°c v·ª•': project.projectName || '',
          'M√£ d·ª± √°n': project.projectCode || '',
          'Ng∆∞·ªùi y√™u c·∫ßu': '-',
          'Ng∆∞·ªùi nh·∫≠n t√°c v·ª•': project.pic || '',
          'Ph√≤ng ban': '-',
          'Ng√†y g·ª≠i': formatF5Date(project.createdAt) || '',
          'Ng√†y h·∫øt h·∫°n': formatF5Date(project.dueDate) || '',
          'Ng√†y ho√†n th√†nh': formatF5Date(project.finishDate) || '',
          'Tr·∫°ng th√°i': project.status === 'done' ? 'Ho√†n th√†nh' : (project.status === 'in_progress' ? 'ƒêang x·ª≠ l√Ω' : 'Ch·ªù x·ª≠ l√Ω'),
          'S·ªë gi·ªù th·ª±c hi·ªán': '-',
          'M√£ t√°c v·ª•': '-',
          'Link k·∫øt qu·∫£': '-'
        });

        if (project.tasks && project.expanded) {
          project.tasks.forEach(task => {
            // Task row
            flatData.push({
              'C·∫•p': 'Task',
              'T√™n t√°c v·ª•': task.taskName || '',
              'M√£ d·ª± √°n': project.projectCode || '',
              'Ng∆∞·ªùi y√™u c·∫ßu': task.requester || '-',
              'Ng∆∞·ªùi nh·∫≠n t√°c v·ª•': task.pic || '-',
              'Ph√≤ng ban': task.department || '-',
              'Ng√†y g·ª≠i': formatF5Date(task.createdAt) || '',
              'Ng√†y h·∫øt h·∫°n': formatF5Date(task.dueDate) || '',
              'Ng√†y ho√†n th√†nh': formatF5Date(task.finishDate) || '',
              'Tr·∫°ng th√°i': task.status === 'done' ? 'Ho√†n th√†nh' : (task.status === 'in_progress' ? 'ƒêang x·ª≠ l√Ω' : 'Ch·ªù x·ª≠ l√Ω'),
              'S·ªë gi·ªù th·ª±c hi·ªán': task.manhour || '-',
              'M√£ t√°c v·ª•': task.taskCode || '-',
              'Link k·∫øt qu·∫£': task.resultLink || '-'
            });

            if (task.subtasks && task.expanded) {
              task.subtasks.forEach(subtask => {
                // Subtask row
                flatData.push({
                  'C·∫•p': 'Subtask',
                  'T√™n t√°c v·ª•': subtask.name || '',
                  'M√£ d·ª± √°n': project.projectCode || '',
                  'Ng∆∞·ªùi y√™u c·∫ßu': task.requester || '-',
                  'Ng∆∞·ªùi nh·∫≠n t√°c v·ª•': subtask.pic || '-',
                  'Ph√≤ng ban': task.department || '-',
                  'Ng√†y g·ª≠i': formatF5Date(subtask.timesend) || '',
                  'Ng√†y h·∫øt h·∫°n': formatF5Date(subtask.dueDate) || '',
                  'Ng√†y ho√†n th√†nh': formatF5Date(subtask.finishDate) || '',
                  'Tr·∫°ng th√°i': subtask.status === 'done' || subtask.status === 'ho√†n th√†nh' ? 'Ho√†n th√†nh' : (subtask.status === 'doing' || subtask.status === 'in_progress' ? 'ƒêang tri·ªÉn khai' : (subtask.status === 'cancel' ? 'H·ªßy b·ªè' : 'ƒêang x·ª≠ l√Ω')),
                  'S·ªë gi·ªù th·ª±c hi·ªán': subtask.manhour || '-',
                  'M√£ t√°c v·ª•': subtask.taskCode || '-',
                  'Link k·∫øt qu·∫£': subtask.resultLink || '-'
                });
              });
            }
          });
        }
      });
      
      return flatData;
    }

    // H√†m xu·∫•t Excel Form 5
    function exportF5ToExcel() {
      if (!F5_PROJECTS || F5_PROJECTS.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      try {
        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu hierarchical sang flat array
        const flatData = flattenF5DataForExport();
        
        if (flatData.length === 0) {
          showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
          return;
        }

        // T·∫°o workbook m·ªõi
        const wb = XLSX.utils.book_new();
        
        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu sang worksheet
        const ws = XLSX.utils.json_to_sheet(flatData);
        
        // ƒê·∫∑t ƒë·ªô r·ªông c·ªôt
        const colWidths = [
          { wch: 10 }, // C·∫•p
          { wch: 40 }, // T√™n t√°c v·ª•
          { wch: 15 }, // M√£ d·ª± √°n
          { wch: 20 }, // Ng∆∞·ªùi y√™u c·∫ßu
          { wch: 20 }, // Ng∆∞·ªùi nh·∫≠n t√°c v·ª•
          { wch: 15 }, // Ph√≤ng ban
          { wch: 15 }, // Ng√†y g·ª≠i
          { wch: 15 }, // Ng√†y h·∫øt h·∫°n
          { wch: 15 }, // Ng√†y ho√†n th√†nh
          { wch: 15 }, // Tr·∫°ng th√°i
          { wch: 15 }, // S·ªë gi·ªù th·ª±c hi·ªán
          { wch: 20 }, // M√£ t√°c v·ª•
          { wch: 30 }  // Link k·∫øt qu·∫£
        ];
        ws['!cols'] = colWidths;
        
        // Th√™m worksheet v√†o workbook
        XLSX.utils.book_append_sheet(wb, ws, 'D·ªØ li·ªáu t√°c v·ª•');
        
        // T·∫°o t√™n file v·ªõi timestamp
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
        const timeStr = now.toTimeString().slice(0, 5).replace(':', '');
        const fileName = `Form5_TacVu_${dateStr}_${timeStr}.xlsx`;
        
        // Xu·∫•t file
        XLSX.writeFile(wb, fileName);
        
        showToast(`ƒê√£ xu·∫•t ${flatData.length} d√≤ng d·ªØ li·ªáu th√†nh c√¥ng!`, 'success');
        
      } catch (error) {
        console.error('[Form 5] Error exporting to Excel:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi xu·∫•t Excel. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
    }

    // Helper ƒë·ªÉ t√¨m task trong F5_PROJECTS
    function findF5Task(taskId) {
      for (const project of F5_PROJECTS) {
        if (project.tasks) {
          const task = project.tasks.find(t => t.id === taskId);
          if (task) return { task, project };
        }
      }
      return null;
    }

    // Helper ƒë·ªÉ t√¨m project
    function findF5Project(projectId) {
      return F5_PROJECTS.find(p => p.id === projectId);
    }

    // Kh·ªüi t·∫°o Form 5
    function initForm5() {
      const tasksTableBody = document.getElementById('f5-tasksTableBody');
      if (!tasksTableBody) return;

      // Kh√¥ng t·ª± ƒë·ªông load d·ªØ li·ªáu - ch·ªâ render b·∫£ng r·ªóng
      renderF5TasksTable();

      // Th√™m event listener cho n√∫t Tra c·ª©u
      const searchBtn = document.getElementById('f5-searchBtn');
      if (searchBtn) {
        // L∆∞u HTML ban ƒë·∫ßu c·ªßa n√∫t ƒë·ªÉ restore sau
        const originalHTML = searchBtn.innerHTML;
        
        searchBtn.addEventListener('click', async function() {
          const tasksTableBody = document.getElementById('f5-tasksTableBody');
          if (!tasksTableBody) return;

          // L·∫•y gi√° tr·ªã PIC t·ª´ dropdown
          const picFilter = document.getElementById('f5-filter-pic');
          const selectedPIC = picFilter ? picFilter.value.trim() : '';
          F5_FILTER_PIC = selectedPIC;

          // Disable n√∫t v√† hi·ªÉn th·ªã loading
          searchBtn.disabled = true;
          searchBtn.innerHTML = '<span class="spinner"></span><span style="margin-left:8px">ƒêang t·∫£i...</span>';
          
          // Hi·ªÉn th·ªã loading trong b·∫£ng
          tasksTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-8 text-center text-gray-500 text-base"><span class="spinner"></span><span style="margin-left:8px">ƒêang t·∫£i d·ªØ li·ªáu...</span></td></tr>';

          try {
            // Load d·ªØ li·ªáu t·ª´ API v·ªõi filter PIC
            F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);

            // Render b·∫£ng t√°c v·ª•
            renderF5TasksTable();
          } catch (error) {
            console.error('[Form 5] Error loading data:', error);
            tasksTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-8 text-center text-red-500 text-base">C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</td></tr>';
          } finally {
            // Restore n√∫t v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
            searchBtn.disabled = false;
            searchBtn.innerHTML = originalHTML;
          }
        });
      }

      // Event listener cho n√∫t xu·∫•t Excel
      const exportBtn = document.getElementById('f5-export-btn');
      if (exportBtn) {
        exportBtn.addEventListener('click', exportF5ToExcel);
      }

      // Setup Import Excel functionality
      setupF5ImportExcel();

      // Setup PIC filter
      setupF5PICFilter();
      
      // Setup Month filter
      setupF5MonthFilter();
    }
    
    function setupF5MonthFilter() {
      const monthFilter = document.getElementById('f5-filter-month');
      if (monthFilter) {
        // Set gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† th√°ng hi·ªán t·∫°i
        if (!monthFilter.value) {
          monthFilter.value = F5_FILTER_MONTH;
        }
        
        // Event listener: khi thay ƒë·ªïi th√°ng, ch·ªâ render l·∫°i b·∫£ng (kh√¥ng load l·∫°i t·ª´ API)
        monthFilter.addEventListener('change', (e) => {
          F5_FILTER_MONTH = e.target.value.trim();
          // Ch·ªâ render l·∫°i b·∫£ng v·ªõi filter m·ªõi, kh√¥ng c·∫ßn load l·∫°i t·ª´ API
          renderF5TasksTable();
        });
      }
    }

    function setupF5PICFilter() {
      const picFilter = document.getElementById('f5-filter-pic');
      if (picFilter) {
        // Populate dropdown v·ªõi danh s√°ch t√™n c·ªë ƒë·ªãnh ngay t·ª´ ƒë·∫ßu
        picFilter.innerHTML = '<option value="">T·∫•t c·∫£ ng∆∞·ªùi nh·∫≠n</option>';
        F5_PIC_LIST.forEach(pic => {
          const option = document.createElement('option');
          option.value = pic;
          option.textContent = pic;
          picFilter.appendChild(option);
        });
        
        // Event listener: khi thay ƒë·ªïi dropdown, t·ª± ƒë·ªông load l·∫°i d·ªØ li·ªáu v·ªõi filter PIC
        picFilter.addEventListener('change', async (e) => {
          F5_FILTER_PIC = e.target.value.trim();
          
          // Hi·ªÉn th·ªã loading
          const tasksTableBody = document.getElementById('f5-tasksTableBody');
          if (tasksTableBody) {
            tasksTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-8 text-center text-gray-500 text-base"><span class="spinner"></span><span style="margin-left:8px">ƒêang t·∫£i d·ªØ li·ªáu...</span></td></tr>';
          }
          
          try {
            // Load d·ªØ li·ªáu v·ªõi filter PIC
            F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);
            // Render b·∫£ng t√°c v·ª•
            renderF5TasksTable();
          } catch (error) {
            console.error('[Form 5] Error loading data with PIC filter:', error);
            if (tasksTableBody) {
              tasksTableBody.innerHTML = '<tr><td colspan="12" class="px-6 py-8 text-center text-red-500 text-base">C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</td></tr>';
            }
          }
        });
      }
    }

    function updateF5PICFilter() {
      // H√†m n√†y kh√¥ng c√≤n c·∫ßn thi·∫øt v√¨ dropdown ƒë√£ ƒë∆∞·ª£c populate c·ªë ƒë·ªãnh t·ª´ ƒë·∫ßu
      // Gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch n·∫øu c√≥ code kh√°c g·ªçi h√†m n√†y
      const picFilter = document.getElementById('f5-filter-pic');
      if (!picFilter) return;

      // Gi·ªØ nguy√™n gi√° tr·ªã ƒë√£ ch·ªçn, kh√¥ng thay ƒë·ªïi danh s√°ch dropdown
      // V√¨ danh s√°ch ƒë√£ ƒë∆∞·ª£c populate c·ªë ƒë·ªãnh t·ª´ setupF5PICFilter()
    }

    // ===== FORM 6 - DASHBOARD TH·ªêNG K√ä =====
    
    let F6_RAW_DATA = []; // L∆∞u d·ªØ li·ªáu raw t·ª´ webhook
    
    // Kh·ªüi t·∫°o Form 6
    function initForm6() {
      loadF6Data();
      setupF6Refresh();
      setupF6Search();
    }

    // Load d·ªØ li·ªáu t·ª´ webhook
    async function loadF6Data() {
      try {
        const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/dashboardspm1';
        
        // Hi·ªÉn th·ªã loading state
        const statsProjects = document.getElementById('f6-stat-projects');
        const statsTasks = document.getElementById('f6-stat-tasks');
        const statsSubtasks = document.getElementById('f6-stat-subtasks');
        const statsCompletion = document.getElementById('f6-stat-completion');
        
        if (statsProjects) statsProjects.textContent = '...';
        if (statsTasks) statsTasks.textContent = '...';
        if (statsSubtasks) statsSubtasks.textContent = '...';
        if (statsCompletion) statsCompletion.textContent = '...';
        
        // Fetch d·ªØ li·ªáu t·ª´ webhook
        const response = await fetch(webhookUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('[Form 6] Raw response:', data);
        
        // Ki·ªÉm tra n·∫øu d·ªØ li·ªáu l√† m·∫£ng
        if (Array.isArray(data)) {
          F6_RAW_DATA = data;
        } else if (data.data && Array.isArray(data.data)) {
          F6_RAW_DATA = data.data;
        } else if (data.records && Array.isArray(data.records)) {
          F6_RAW_DATA = data.records;
        } else {
          console.warn('[Form 6] Unexpected data format:', data);
          F6_RAW_DATA = [];
        }
        
        console.log('[Form 6] Loaded data:', F6_RAW_DATA.length, 'records');
        console.log('[Form 6] First record sample:', F6_RAW_DATA[0]);
        console.log('[Form 6] F6_RAW_DATA type:', typeof F6_RAW_DATA, Array.isArray(F6_RAW_DATA));
        console.log('[Form 6] About to call renderF6Dashboard, function exists:', typeof renderF6Dashboard);
        
        // Render dashboard v·ªõi d·ªØ li·ªáu m·ªõi
        if (typeof renderF6Dashboard === 'function') {
          console.log('[Form 6] Calling renderF6Dashboard()...');
          try {
            renderF6Dashboard();
            console.log('[Form 6] renderF6Dashboard() completed');
          } catch (renderError) {
            console.error('[Form 6] Error in renderF6Dashboard:', renderError);
            throw renderError;
          }
        } else {
          console.error('[Form 6] renderF6Dashboard is not a function! Type:', typeof renderF6Dashboard);
        }
        
      } catch (error) {
        console.error('[Form 6] Error loading data:', error);
        showToast('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ server. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        
        // Hi·ªÉn th·ªã l·ªói tr√™n dashboard
        const statsProjects = document.getElementById('f6-stat-projects');
        const statsTasks = document.getElementById('f6-stat-tasks');
        const statsSubtasks = document.getElementById('f6-stat-subtasks');
        const statsCompletion = document.getElementById('f6-stat-completion');
        
        if (statsProjects) statsProjects.textContent = '0';
        if (statsTasks) statsTasks.textContent = '0';
        if (statsSubtasks) statsSubtasks.textContent = '0';
        if (statsCompletion) statsCompletion.textContent = '0%';
        
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói trong c√°c b·∫£ng
        const dueTasksBody = document.getElementById('f6-due-tasks-body');
        const projectsTableBody = document.getElementById('f6-projects-table-body');
        
        if (dueTasksBody) {
          dueTasksBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>';
        }
        if (projectsTableBody) {
          projectsTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>';
        }
      }
    }

    // Render dashboard
    function renderF6Dashboard() {
      try {
        console.log('[Form 6] ===== START RENDER =====');
        console.log('[Form 6] F6_RAW_DATA:', F6_RAW_DATA);
        console.log('[Form 6] F6_RAW_DATA length:', F6_RAW_DATA ? F6_RAW_DATA.length : 'null/undefined');
        console.log('[Form 6] Rendering dashboard with', F6_RAW_DATA ? F6_RAW_DATA.length : 0, 'records');
        
        if (!F6_RAW_DATA || F6_RAW_DATA.length === 0) {
          console.warn('[Form 6] No data to render - F6_RAW_DATA is empty');
          console.warn('[Form 6] No data to render');
          // Hi·ªÉn th·ªã th√¥ng b√°o kh√¥ng c√≥ d·ªØ li·ªáu
          const statsProjects = document.getElementById('f6-stat-projects');
          const statsTasks = document.getElementById('f6-stat-tasks');
          const statsSubtasks = document.getElementById('f6-stat-subtasks');
          const statsCompletion = document.getElementById('f6-stat-completion');
          
          if (statsProjects) statsProjects.textContent = '0';
          if (statsTasks) statsTasks.textContent = '0';
          if (statsSubtasks) statsSubtasks.textContent = '0';
          if (statsCompletion) statsCompletion.textContent = '0%';
          
          const dueTasksBody = document.getElementById('f6-due-tasks-body');
          const projectsTableBody = document.getElementById('f6-projects-table-body');
          
          if (dueTasksBody) {
            dueTasksBody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
          }
          if (projectsTableBody) {
            projectsTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
          }
          
          const chartSubtask = document.getElementById('f6-chart-subtask-status');
          const chartPIC = document.getElementById('f6-chart-pic-distribution');
          if (chartSubtask) chartSubtask.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
          if (chartPIC) chartPIC.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
          
          return;
        }
        
        console.log('[Form 6] Calling processF6Data...');
        const data = processF6Data(F6_RAW_DATA);
        console.log('[Form 6] Processed data:', data);
        console.log('[Form 6] Projects:', data.projects.length);
        console.log('[Form 6] Tasks:', data.tasks.length);
        console.log('[Form 6] Subtasks:', data.subtasks.length);
        
        // Update stats
        console.log('[Form 6] Updating stats...');
        updateF6Stats(data);
        console.log('[Form 6] Stats updated');
        
        // Render charts
        console.log('[Form 6] Rendering charts...');
        renderF6SubtaskStatusChart(data.subtaskStatusCount);
        renderF6PICDistributionChart(data.picDistribution);
        console.log('[Form 6] Charts rendered');
        
        // Render tables
        console.log('[Form 6] Rendering tables...');
        renderF6DueTasksTable(data.dueTasks);
        renderF6ProjectsTable(data.projects);
        console.log('[Form 6] Tables rendered');
        console.log('[Form 6] ===== END RENDER =====');
      } catch (error) {
        console.error('[Form 6] Error rendering dashboard:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi hi·ªÉn th·ªã dashboard', 'error');
      }
    }

    // X·ª≠ l√Ω d·ªØ li·ªáu
    function processF6Data(rawData) {
      const projects = {};
      const tasks = [];
      const subtasks = [];
      const picDistribution = {};
      const subtaskStatusCount = { 'Ho√†n th√†nh': 0, 'ƒêang x·ª≠ l√Ω': 0, 'Ch∆∞a b·∫Øt ƒë·∫ßu': 0 };
      
      if (!rawData || !Array.isArray(rawData)) {
        console.warn('[Form 6] Invalid rawData:', rawData);
        return {
          projects: [],
          tasks: [],
          subtasks: [],
          picDistribution: {},
          subtaskStatusCount,
          dueTasks: []
        };
      }
      
      rawData.forEach((record, index) => {
        try {
          const projectCode = record.project_code || 'UNKNOWN';
          
          // T·∫°o project n·∫øu ch∆∞a c√≥
          if (!projects[projectCode]) {
            projects[projectCode] = {
              code: projectCode,
              name: `D·ª± √°n ${projectCode}`,
              taskCount: 0,
              subtaskCount: 0,
              completedSubtasks: 0,
              pic: record.TaskPIC || ''
            };
          }
          
          // Ki·ªÉm tra n·∫øu l√† task: type = null v√† parent_id = null v√† SubtaskName = null
          const isTask = (!record.type || record.type === null) && 
                        (!record.parent_id || record.parent_id === null) && 
                        (!record.SubtaskName || record.SubtaskName === null);
          
          // Ki·ªÉm tra n·∫øu l√† subtask: c√≥ SubtaskName ho·∫∑c type ch·ª©a "subtask"
          const isSubtask = (record.SubtaskName && record.SubtaskName !== null) || 
                           (record.type && String(record.type).includes('subtask'));
          
          if (isTask) {
            tasks.push({
              name: record.TaskItemName || '',
              projectCode: projectCode,
              pic: record.TaskPIC || '',
              dueDate: record.TaskDesiredDate || record.TaskDueDate || '',
              status: record.TaskStatus || 'pending'
            });
            projects[projectCode].taskCount++;
          }
          
          if (isSubtask) {
            const subtaskStatus = record.Subtaskstatus || record.SubtaskStatus || 'pending';
            subtasks.push({
              name: record.SubtaskName || '',
              projectCode: projectCode,
              taskName: record.TaskItemName || '',
              pic: record.SubtaskPIC || record.TaskPIC || '',
              deadline: record.Subtaskdeadline || record.SubtaskDeadline || '',
              status: subtaskStatus
            });
            projects[projectCode].subtaskCount++;
            
            // ƒê·∫øm tr·∫°ng th√°i subtask
            const status = String(subtaskStatus).toLowerCase();
            if (status.includes('ho√†n th√†nh') || status === 'done' || status === 'completed') {
              subtaskStatusCount['Ho√†n th√†nh']++;
              projects[projectCode].completedSubtasks++;
            } else if (status.includes('ƒëang') || status.includes('in progress') || status.includes('processing')) {
              subtaskStatusCount['ƒêang x·ª≠ l√Ω']++;
            } else {
              subtaskStatusCount['Ch∆∞a b·∫Øt ƒë·∫ßu']++;
            }
            
            // Ph√¢n b·ªï theo PIC
            const pic = record.SubtaskPIC || record.TaskPIC || 'Ch∆∞a g√°n';
            picDistribution[pic] = (picDistribution[pic] || 0) + 1;
          }
        } catch (error) {
          console.error(`[Form 6] Error processing record ${index}:`, error, record);
        }
      });
      
      // T√≠nh tasks s·∫Øp h·∫øt h·∫°n (7 ng√†y t·ªõi)
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dueTasks = tasks.filter(task => {
        if (!task.dueDate) return false;
        try {
          const dueDate = new Date(task.dueDate);
          dueDate.setHours(0, 0, 0, 0);
          const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
          return diffDays >= 0 && diffDays <= 7 && task.status !== 'done' && task.status !== 'completed';
        } catch (e) {
          return false;
        }
      });
      
      console.log('[Form 6] Processed:', {
        projects: Object.keys(projects).length,
        tasks: tasks.length,
        subtasks: subtasks.length,
        dueTasks: dueTasks.length
      });
      
      return {
        projects: Object.values(projects),
        tasks,
        subtasks,
        picDistribution,
        subtaskStatusCount,
        dueTasks
      };
    }

    // C·∫≠p nh·∫≠t stats cards
    function updateF6Stats(data) {
      const totalProjects = new Set(data.projects.map(p => p.code)).size;
      const totalTasks = data.tasks.length;
      const totalSubtasks = data.subtasks.length;
      const totalCompleted = data.subtaskStatusCount['Ho√†n th√†nh'] || 0;
      const completionRate = totalSubtasks > 0 
        ? Math.round((totalCompleted / totalSubtasks) * 100) 
        : 0;
      
      document.getElementById('f6-stat-projects').textContent = totalProjects;
      document.getElementById('f6-stat-tasks').textContent = totalTasks;
      document.getElementById('f6-stat-subtasks').textContent = totalSubtasks;
      document.getElementById('f6-stat-completion').textContent = `${completionRate}%`;
    }

    // Render bi·ªÉu ƒë·ªì tr·∫°ng th√°i subtask
    function renderF6SubtaskStatusChart(statusCount) {
      const container = document.getElementById('f6-chart-subtask-status');
      if (!container) return;
      
      const total = Object.values(statusCount).reduce((sum, val) => sum + val, 0);
      if (total === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }
      
      const colors = {
        'Ho√†n th√†nh': '#10b981',
        'ƒêang x·ª≠ l√Ω': '#f59e0b',
        'Ch∆∞a b·∫Øt ƒë·∫ßu': '#6b7280'
      };
      
      let html = '<div class="space-y-4">';
      Object.entries(statusCount).forEach(([status, count]) => {
        const percentage = Math.round((count / total) * 100);
        const color = colors[status] || '#6b7280';
        
        html += `
          <div class="flex items-center gap-4">
            <div class="flex-1">
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">${status}</span>
                <span class="text-sm font-semibold text-gray-900">${count} (${percentage}%)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="h-2 rounded-full transition-all" style="width: ${percentage}%; background-color: ${color}"></div>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }

    // Render bi·ªÉu ƒë·ªì ph√¢n b·ªï theo PIC
    function renderF6PICDistributionChart(picDistribution) {
      const container = document.getElementById('f6-chart-pic-distribution');
      if (!container) return;
      
      const entries = Object.entries(picDistribution).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }
      
      const maxCount = Math.max(...entries.map(e => e[1]));
      const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6366f1'];
      
      let html = '<div class="space-y-3">';
      entries.forEach(([pic, count], index) => {
        const percentage = Math.round((count / maxCount) * 100);
        const color = colors[index % colors.length];
        
        html += `
          <div class="flex items-center gap-3">
            <div class="w-32 text-sm font-medium text-gray-700 truncate" title="${pic}">${pic}</div>
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <div class="flex-1 bg-gray-200 rounded-full h-3">
                  <div class="h-3 rounded-full transition-all" style="width: ${percentage}%; background-color: ${color}"></div>
                </div>
                <span class="text-sm font-semibold text-gray-900 w-12 text-right">${count}</span>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }

    // Render b·∫£ng tasks s·∫Øp h·∫øt h·∫°n
    function renderF6DueTasksTable(dueTasks) {
      const tbody = document.getElementById('f6-due-tasks-body');
      if (!tbody) return;
      
      if (dueTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Kh√¥ng c√≥ t√°c v·ª• n√†o s·∫Øp h·∫øt h·∫°n</td></tr>';
        return;
      }
      
      const today = new Date();
      tbody.innerHTML = dueTasks.map(task => {
        const dueDate = new Date(task.dueDate);
        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        const urgencyClass = diffDays <= 2 ? 'text-red-600 font-semibold' : diffDays <= 4 ? 'text-orange-600' : 'text-gray-600';
        
        return `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 font-medium text-gray-900">${escapeHtml(task.name || '-')}</td>
            <td class="px-6 py-4 text-gray-600">${escapeHtml(task.projectCode || '-')}</td>
            <td class="px-6 py-4 text-gray-600">${escapeHtml(task.pic || '-')}</td>
            <td class="px-6 py-4 text-gray-600">${formatF5Date(task.dueDate)}</td>
            <td class="px-6 py-4 ${urgencyClass}">${diffDays} ng√†y</td>
          </tr>
        `;
      }).join('');
    }

    // Render b·∫£ng chi ti·∫øt d·ª± √°n
    function renderF6ProjectsTable(projects) {
      const tbody = document.getElementById('f6-projects-table-body');
      if (!tbody) return;
      
      if (projects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        return;
      }
      
      tbody.innerHTML = projects.map(project => {
        const progress = project.subtaskCount > 0 
          ? Math.round((project.completedSubtasks / project.subtaskCount) * 100) 
          : 0;
        const progressColor = progress === 100 ? 'bg-green-500' : progress >= 50 ? 'bg-blue-500' : 'bg-yellow-500';
        
        return `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 font-mono text-sm font-semibold text-gray-900">${escapeHtml(project.code)}</td>
            <td class="px-6 py-4 font-medium text-gray-900">${escapeHtml(project.name)}</td>
            <td class="px-6 py-4 text-center text-gray-600">${project.taskCount}</td>
            <td class="px-6 py-4 text-center text-gray-600">${project.subtaskCount}</td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <div class="flex-1 bg-gray-200 rounded-full h-2">
                  <div class="${progressColor} h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                </div>
                <span class="text-sm font-medium text-gray-700 w-12">${progress}%</span>
              </div>
            </td>
            <td class="px-6 py-4 text-gray-600">${escapeHtml(project.pic || '-')}</td>
          </tr>
        `;
      }).join('');
    }

    // Setup refresh button
    function setupF6Refresh() {
      const refreshBtn = document.getElementById('f6-refresh-btn');
      if (!refreshBtn) return;
      
      refreshBtn.addEventListener('click', () => {
        loadF6Data();
        showToast('ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...', 'info');
      });
    }

    // Setup search
    function setupF6Search() {
      const searchInput = document.getElementById('f6-search-input');
      if (!searchInput) return;
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        const tbody = document.getElementById('f6-projects-table-body');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });
      });
    }


    /**
     * C·∫≠p nh·∫≠t tr·∫°ng th√°i task - Status ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ tr∆∞·ªùng TaskStatus
     * Kh√¥ng t√≠nh to√°n t·ª´ subtasks n·ªØa
     */
    function updateF5TaskStatus(taskId) {
      const result = findF5Task(taskId);
      if (!result || !result.task) return;
      
      // Status c·ªßa task ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ tr∆∞·ªùng TaskStatus, kh√¥ng t√≠nh to√°n t·ª´ subtasks
      // Gi·ªØ nguy√™n status hi·ªán t·∫°i t·ª´ TaskStatus
      return;
      
      // Ki·ªÉm tra v√† c·∫≠p nh·∫≠t subtask B/C khi A/B done
      // NOTE: ƒê√£ t·∫Øt logic t·ª± ƒë·ªông t√≠nh timesend cho B v√† C - Backend s·∫Ω x·ª≠ l√Ω
      /*
      task.subtasks.forEach(subtask => {
        // N·∫øu subtask A v·ª´a done, c·∫≠p nh·∫≠t B
        if (subtask.type === 'form5_subtask_auto_a' && subtask.status === 'done') {
          updateSubtaskBWhenADone(subtask, task);
        }
        
        // N·∫øu subtask B v·ª´a done, c·∫≠p nh·∫≠t C
        if (subtask.type === 'form5_subtask_auto_b' && subtask.status === 'done') {
          updateSubtaskCWhenBDone(subtask, task);
        }
      });
      */
      
      // C·∫≠p nh·∫≠t project status
      updateF5ProjectStatus(result.project);
      
      // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t UI
      renderF5TasksTable();
    }

    function getF5StatusBadge(status) {
      const statusMap = {
        'pending': { text: 'Ch·ªù x·ª≠ l√Ω', class: 'bg-gray-100 text-gray-800' },
        'in_progress': { text: 'ƒêang x·ª≠ l√Ω', class: 'bg-yellow-100 text-yellow-800' },
        'done': { text: 'Ho√†n th√†nh', class: 'bg-green-100 text-green-800' }
      };
      const statusInfo = statusMap[status] || statusMap['pending'];
      return `<span class="px-3 py-1 rounded-full text-xs font-semibold ${statusInfo.class}">${statusInfo.text}</span>`;
    }
    
    /**
     * Hi·ªÉn th·ªã badge tr·∫°ng th√°i cho subtask v·ªõi mapping ri√™ng
     * @param {string} status - Tr·∫°ng th√°i subtask (Pending, Doing, Done, Cancel)
     * @returns {string} - HTML badge
     */
    function getF5SubtaskStatusBadge(status) {
      // Chu·∫©n h√≥a status v·ªÅ lowercase ƒë·ªÉ so s√°nh
      const normalizedStatus = String(status || '').toLowerCase().trim();
      
      const statusMap = {
        'pending': { text: 'ƒêang x·ª≠ l√Ω', class: 'bg-yellow-100 text-yellow-800' },
        'doing': { text: 'ƒêang tri·ªÉn khai', class: 'bg-blue-100 text-blue-800' },
        'in_progress': { text: 'ƒêang tri·ªÉn khai', class: 'bg-blue-100 text-blue-800' },
        'done': { text: 'Ho√†n th√†nh', class: 'bg-green-100 text-green-800' },
        'ho√†n th√†nh': { text: 'Ho√†n th√†nh', class: 'bg-green-100 text-green-800' },
        'c·∫ßn update': { text: 'C·∫ßn update', class: 'bg-yellow-100 text-yellow-800' },
        'can update': { text: 'C·∫ßn update', class: 'bg-yellow-100 text-yellow-800' },
        'cancel': { text: 'H·ªßy b·ªè', class: 'bg-red-100 text-red-800' },
        'cancelled': { text: 'H·ªßy b·ªè', class: 'bg-red-100 text-red-800' },
        'leader review': { text: 'Leader review', class: 'bg-purple-100 text-purple-800' }
      };
      
      // Ki·ªÉm tra c·∫£ gi√° tr·ªã g·ªëc (kh√¥ng lowercase) ƒë·ªÉ x·ª≠ l√Ω c√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát
      const originalStatus = String(status || '').trim();
      if (originalStatus === 'Leader review' || originalStatus === 'leader review') {
        return `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800">Leader review</span>`;
      }
      if (originalStatus === 'Ho√†n th√†nh' || originalStatus === 'ho√†n th√†nh') {
        return `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Ho√†n th√†nh</span>`;
      }
      if (originalStatus === 'C·∫ßn update' || originalStatus === 'C·∫ßn Update' || originalStatus === 'c·∫ßn update' || originalStatus === 'Can update' || originalStatus === 'can update') {
        return `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">C·∫ßn update</span>`;
      }
      if (originalStatus === 'Cancel' || originalStatus === 'cancel') {
        return `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">H·ªßy b·ªè</span>`;
      }
      
      const statusInfo = statusMap[normalizedStatus] || { text: originalStatus || 'ƒêang x·ª≠ l√Ω', class: 'bg-gray-100 text-gray-800' };
      return `<span class="px-3 py-1 rounded-full text-xs font-semibold ${statusInfo.class}">${statusInfo.text}</span>`;
    }

    function formatF5Date(dateStr) {
      if (!dateStr) return '';
      try {
        // N·∫øu dateStr ƒë√£ c√≥ format YYYY-MM-DD HH:mm ho·∫∑c YYYY-MM-DD HH:mm:ss (kh√¥ng c√≥ timezone), gi·ªØ nguy√™n
        if (dateStr.includes(' ') && dateStr.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}(:\d{2})?$/)) {
          // Format: YYYY-MM-DD HH:mm ho·∫∑c YYYY-MM-DD HH:mm:ss
          const parts = dateStr.split(' ');
          if (parts.length >= 2) {
            const datePart = parts[0];
            const timePart = parts[1].split(':');
            if (timePart.length >= 2) {
              const hours = timePart[0].padStart(2, '0');
              const minutes = timePart[1].padStart(2, '0');
              return `${datePart} ${hours}:${minutes}`;
            }
          }
        }
        
        // N·∫øu c√≥ timezone (nh∆∞ +00:00, +07:00, Z), ch·ªâ l·∫•y ph·∫ßn date/time, b·ªè timezone (kh√¥ng convert)
        if (dateStr.includes('+') || dateStr.includes('Z')) {
          // Lo·∫°i b·ªè timezone, ch·ªâ l·∫•y ph·∫ßn YYYY-MM-DD HH:mm:ss (gi·ªØ nguy√™n gi√° tr·ªã, kh√¥ng convert)
          let dateTimePart = dateStr;
          
          // Lo·∫°i b·ªè +XX:XX ho·∫∑c +XXXX
          if (dateStr.includes('+')) {
            const plusIndex = dateStr.indexOf('+');
            dateTimePart = dateStr.substring(0, plusIndex).trim();
          }
          // Lo·∫°i b·ªè Z (UTC)
          else if (dateStr.includes('Z')) {
            dateTimePart = dateStr.replace('Z', '').trim();
          }
          
          // Format th√†nh YYYY-MM-DD HH:mm (b·ªè gi√¢y n·∫øu c√≥, thay T b·∫±ng space)
          dateTimePart = dateTimePart.replace('T', ' ');
          if (dateTimePart.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}(:\d{2})?$/)) {
            // B·ªè gi√¢y n·∫øu c√≥
            const parts = dateTimePart.split(':');
            if (parts.length >= 2) {
              return parts.slice(0, 2).join(':');
            }
            return dateTimePart;
          }
        }
        
        // N·∫øu c√≥ T (ISO format), x·ª≠ l√Ω t∆∞∆°ng t·ª±
        if (dateStr.includes('T')) {
          const parts = dateStr.split('T');
          if (parts.length >= 2) {
            const datePart = parts[0];
            let timePart = parts[1];
            // Lo·∫°i b·ªè timezone n·∫øu c√≥ (kh√¥ng convert)
            if (timePart.includes('+')) {
              timePart = timePart.split('+')[0];
            } else if (timePart.includes('Z')) {
              timePart = timePart.replace('Z', '');
            }
            const timeParts = timePart.split(':');
            if (timeParts.length >= 2) {
              const hours = timeParts[0].padStart(2, '0');
              const minutes = timeParts[1].padStart(2, '0');
              return `${datePart} ${hours}:${minutes}`;
            }
          }
        }
        
        // N·∫øu ch·ªâ c√≥ ng√†y (YYYY-MM-DD), gi·ªØ nguy√™n format YYYY-MM-DD
        if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
          return dateStr;
        }
        
        // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng DD/MM/YYYY HH:mm ho·∫∑c DD/MM/YYYY
        // V√≠ d·ª•: "09/12/2025 18:00" -> "2025-12-09 18:00"
        if (dateStr.includes('/')) {
          const parts = dateStr.trim().split(' ');
          if (parts.length >= 1) {
            const datePart = parts[0];
            // Ki·ªÉm tra ƒë·ªãnh d·∫°ng DD/MM/YYYY
            const dateMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (dateMatch) {
              const day = dateMatch[1].padStart(2, '0');
              const month = dateMatch[2].padStart(2, '0');
              const year = dateMatch[3];
              const convertedDate = `${year}-${month}-${day}`;
              
              // N·∫øu c√≥ ph·∫ßn th·ªùi gian
              if (parts.length >= 2) {
                const timePart = parts[1];
                // X·ª≠ l√Ω th·ªùi gian (c√≥ th·ªÉ l√† HH:mm ho·∫∑c HH:mm:ss)
                const timeMatch = timePart.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
                if (timeMatch) {
                  const hours = timeMatch[1].padStart(2, '0');
                  const minutes = timeMatch[2].padStart(2, '0');
                  return `${convertedDate} ${hours}:${minutes}`;
                }
              } else {
                // Ch·ªâ c√≥ ng√†y, kh√¥ng c√≥ gi·ªù
                return convertedDate;
              }
            }
          }
        }
        
        // Fallback: tr·∫£ v·ªÅ nguy√™n b·∫£n
        return dateStr;
      } catch {
        return dateStr;
      }
    }

    function calculateProjectProgress(project) {
      if (!project.tasks || project.tasks.length === 0) return 0;
      let totalSubtasks = 0;
      let doneSubtasks = 0;
      
      project.tasks.forEach(task => {
        if (task.subtasks && task.subtasks.length > 0) {
          totalSubtasks += task.subtasks.length;
          doneSubtasks += task.subtasks.filter(st => st.status === 'done').length;
        } else {
          // N·∫øu task kh√¥ng c√≥ subtask, t√≠nh task nh∆∞ m·ªôt subtask
          totalSubtasks += 1;
          if (task.status === 'done') doneSubtasks += 1;
        }
      });
      
      return totalSubtasks > 0 ? Math.round((doneSubtasks / totalSubtasks) * 100) : 0;
    }

    function renderF5TasksTable() {
      const tbody = document.getElementById('f5-tasksTableBody');
      if (!tbody) return;

      const allTasks = getF5AllTasks();
      if (F5_PROJECTS.length === 0 || allTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="px-6 py-8 text-center text-gray-500 text-base">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng nh·∫•n n√∫t "Tra c·ª©u" ƒë·ªÉ t·∫£i d·ªØ li·ªáu.</td></tr>';
        // Populate PIC filter dropdown
        updateF5PICFilter();
        return;
      }

      // Populate PIC filter dropdown
      updateF5PICFilter();

      let html = '';
      F5_PROJECTS.forEach(project => {
        // Filter theo PIC: ch·ªâ ki·ªÉm tra task PIC (ng∆∞·ªùi nh·∫≠n t√°c v·ª• c·ªßa task ch√≠nh)
        if (F5_FILTER_PIC) {
          const projectTasks = project.tasks || [];
          const hasMatchingTask = projectTasks.some(task => {
            return task.pic && task.pic.trim() === F5_FILTER_PIC;
          });
          
          if (!hasMatchingTask) {
            return; // Skip project n·∫øu kh√¥ng c√≥ task n√†o c√≥ PIC kh·ªõp
          }
        }
        // Project row (c·∫•p 1)
        const projectStatusClass = 'text-gray-900';
        const projectTasks = project.tasks || [];
        const projectProgress = calculateProjectProgress(project);
        
        html += `
          <tr class="group hover:bg-purple-50/50 transition bg-purple-50/30" data-project-id="${project.id}">
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined cursor-pointer f5-project-expand-btn text-purple-600 ${project.expanded ? '' : 'rotate-[-90deg]'}" data-project-id="${project.id}">expand_more</span>
                <div class="flex-1">
                  <span class="font-bold text-lg ${projectStatusClass} f5-project-name cursor-pointer hover:text-blue-500" data-project-id="${project.id}">${project.projectName}</span>
                  <div class="text-xs text-gray-500 mt-0.5">M√£ d·ª± √°n: ${project.projectCode}</div>
                </div>
              </div>
            </td>
            <td class="px-4 py-4 text-sm text-gray-900">-</td>
            <td class="px-4 py-4 text-sm text-gray-900">
              <div>${project.pic || '-'}</div>
            </td>
            <td class="px-4 py-4 text-sm text-gray-900">-</td>
            <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(project.createdAt)}</td>
            <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(project.dueDate)}</td>
            <td class="px-4 py-4 text-sm text-gray-600">-</td>
            <td class="px-4 py-4 text-sm text-gray-500 text-center">-</td>
            <td class="px-4 py-4 text-sm text-gray-600 text-center">-</td>
            <td class="px-4 py-4 text-sm font-mono text-gray-600">${project.projectCode}</td>
            <td class="px-4 py-4 text-sm text-gray-500">-</td>
            <td class="px-4 py-4">
              <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="text-xs text-gray-500">${projectTasks.length} t√°c v·ª• ‚Ä¢ ${projectProgress}%</span>
              </div>
            </td>
          </tr>
        `;

        // Task rows (c·∫•p 2) - ch·ªâ hi·ªÉn th·ªã n·∫øu project expanded
        if (project.expanded && projectTasks.length > 0) {
          projectTasks.forEach(task => {
            // Filter theo PIC: ch·ªâ ki·ªÉm tra task PIC (ng∆∞·ªùi nh·∫≠n t√°c v·ª• c·ªßa task ch√≠nh)
            if (F5_FILTER_PIC) {
              const taskHasMatchingPIC = task.pic && task.pic.trim() === F5_FILTER_PIC;
              
              if (!taskHasMatchingPIC) {
                return; // Skip task n·∫øu kh√¥ng c√≥ PIC kh·ªõp
              }
            }
            
            // Filter theo th√°ng d·ª±a tr√™n ng√†y t·∫°o (createdAt)
            if (F5_FILTER_MONTH) {
              const createdAt = task.createdAt;
              if (!createdAt) {
                return; // Skip task n·∫øu kh√¥ng c√≥ createdAt
              }
              // Parse createdAt ƒë·ªÉ l·∫•y th√°ng/nƒÉm
              let createdAtDate = null;
              try {
                // Th·ª≠ parse c√°c ƒë·ªãnh d·∫°ng kh√°c nhau
                const createdAtStr = String(createdAt).trim();
                if (createdAtStr.includes('T')) {
                  createdAtDate = new Date(createdAtStr);
                } else if (createdAtStr.includes('-')) {
                  // Format YYYY-MM-DD ho·∫∑c YYYY-MM-DD HH:mm
                  const datePart = createdAtStr.split(' ')[0];
                  createdAtDate = new Date(datePart + 'T00:00:00');
                } else if (createdAtStr.includes('/')) {
                  // Format DD/MM/YYYY ho·∫∑c DD/MM/YYYY HH:mm
                  const parts = createdAtStr.split(' ');
                  const datePart = parts[0];
                  const dateMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                  if (dateMatch) {
                    const day = dateMatch[1].padStart(2, '0');
                    const month = dateMatch[2].padStart(2, '0');
                    const year = dateMatch[3];
                    createdAtDate = new Date(`${year}-${month}-${day}T00:00:00`);
                  }
                }
                
                if (!createdAtDate || isNaN(createdAtDate.getTime())) {
                  return; // Skip n·∫øu kh√¥ng parse ƒë∆∞·ª£c
                }
                
                // Format th√°ng/nƒÉm t·ª´ createdAt: YYYY-MM
                const createdAtMonth = `${createdAtDate.getFullYear()}-${String(createdAtDate.getMonth() + 1).padStart(2, '0')}`;
                
                // So s√°nh v·ªõi filter month
                if (createdAtMonth !== F5_FILTER_MONTH) {
                  return; // Skip task n·∫øu kh√¥ng kh·ªõp th√°ng
                }
              } catch (e) {
                return; // Skip n·∫øu c√≥ l·ªói parse
              }
            }
            
            // Task row (c·∫•p 2)
            const statusClass = 'text-gray-900';
            html += `
              <tr class="group hover:bg-blue-50/50 transition bg-blue-50/20" data-task-id="${task.id}" data-project-id="${project.id}">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3 ml-6">
                    <span class="material-symbols-outlined cursor-pointer f5-expand-btn text-gray-500 ${task.expanded ? '' : 'rotate-[-90deg]'}" data-task-id="${task.id}">expand_more</span>
                    <div class="flex-1">
                      <span class="font-medium ${statusClass} f5-task-name cursor-pointer hover:text-blue-500" data-task-id="${task.id}">${task.taskName}</span>
                      ${task.form4Data?.itemCode ? `<div class="text-xs text-gray-500 mt-0.5">M√£ SP: ${task.form4Data.itemCode}</div>` : ''}
                    </div>
                  </div>
                </td>
                <td class="px-4 py-4 text-sm text-gray-900">
                  <div class="font-medium">${task.requesterName || '-'}</div>
                  ${task.requesterEmail ? `<div class="text-xs text-gray-500 mt-0.5">${task.requesterEmail}</div>` : ''}
                </td>
                <td class="px-4 py-4 text-sm text-gray-900">${task.pic || '-'}</td>
                <td class="px-4 py-4 text-sm text-gray-900">${task.department || '-'}</td>
                <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(task.createdAt)}</td>
                <td class="px-4 py-4 text-sm text-gray-600">${formatF5Date(task.dueDate)}</td>
                <td class="px-4 py-4 text-sm text-gray-600">-</td>
                <td class="px-4 py-4 text-sm text-gray-500 text-center">-</td>
                <td class="px-4 py-4 text-sm text-gray-600 text-center">-</td>
                <td class="px-4 py-4 text-sm font-mono text-gray-600">${task.taskCode}</td>
                <td class="px-4 py-4 text-sm text-gray-500">-</td>
                <td class="px-4 py-4">
                  <div class="flex items-center gap-2">
                    <!-- T·∫°m kh√≥a n√∫t th√™m t√°c v·ª• con - t√≠nh nƒÉng ƒëang ph√°t tri·ªÉn -->
                    <!--
                    <button type="button" class="f5-add-subtask-btn flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white hover:bg-blue-700 shadow-md hover:shadow-lg transition-all transform hover:scale-110" data-task-id="${task.id}" title="Th√™m t√°c v·ª• con">
                      <span class="material-symbols-outlined text-xl">add</span>
                    </button>
                    -->
                    <button type="button" class="f5-view-detail-btn flex items-center justify-center w-9 h-9 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-600 hover:text-blue-700 transition-all shadow-sm hover:shadow-md" data-task-id="${task.id}" title="Xem chi ti·∫øt">
                      <span class="material-symbols-outlined text-xl">more_horiz</span>
                    </button>
                  </div>
                </td>
              </tr>
            `;

            // Subtask rows (c·∫•p 3) - ch·ªâ hi·ªÉn th·ªã n·∫øu task expanded
            if (task.expanded && task.subtasks && task.subtasks.length > 0) {
              task.subtasks.forEach((st) => {
                // Kh√¥ng filter subtask theo PIC - ch·ªâ filter theo task PIC
                // Subtask s·∫Ω hi·ªÉn th·ªã n·∫øu task cha c√≥ PIC kh·ªõp
                // Kh√¥ng filter subtask theo th√°ng - ch·ªâ filter task (c·∫•p 2) theo th√°ng
                
                // Chu·∫©n h√≥a status ƒë·ªÉ ki·ªÉm tra done ho·∫∑c cancelled
                const normalizedSubtaskStatus = String(st.status || '').toLowerCase().trim();
                const subtaskStatusClass = 'text-gray-900';
                
                // Hi·ªÉn th·ªã n√∫t khai b√°o d·ª±a tr√™n declarationMode ho·∫∑c t√™n t√°c v·ª•
                // N·∫øu subtask c√≥ declarationMode th√¨ cho ph√©p khai b√°o
                // Ho·∫∑c n·∫øu t√™n l√† "Ki·ªÉm tra v√† chu·∫©n b·ªã t√†i li·ªáu" ho·∫∑c "Ho√†n thi·ªán b√°o c√°o v√† nghi·ªám thu"
                const subtaskName = String(st.name || '').trim();
                const declarationMode = String(st.declarationMode || '').trim();
                const subtaskType = String(st.type || '').trim();
                
                // Ki·ªÉm tra ƒëi·ªÅu ki·ªán hi·ªÉn th·ªã n√∫t khai b√°o
                let showDeclarationBtn = declarationMode || subtaskName === 'Ki·ªÉm tra v√† chu·∫©n b·ªã t√†i li·ªáu' || subtaskName === 'Ho√†n thi·ªán b√°o c√°o v√† nghi·ªám thu';
                
                // Logic ri√™ng cho form5_subtask_auto_a: kh√≥a khai b√°o khi status l√† "leader review" ho·∫∑c "ƒê√£ ho√†n th√†nh"/"done"
                let isDeclarationLocked = false;
                if (subtaskType === 'form5_subtask_auto_a') {
                  const statusLower = normalizedSubtaskStatus;
                  if (statusLower === 'leader review' || 
                      statusLower === 'done' || 
                      statusLower === 'completed' || 
                      statusLower === 'ho√†n th√†nh' || 
                      statusLower === 'ƒë√£ ho√†n th√†nh') {
                    isDeclarationLocked = true;
                  }
                }
                
                // Ki·ªÉm tra n·∫øu subtask ƒë√£ ho√†n th√†nh (done) ho·∫∑c "C·∫ßn update" th√¨ hi·ªÉn th·ªã n√∫t "C·∫≠p nh·∫≠t b√°o c√°o"
                const isDone = normalizedSubtaskStatus === 'done' || normalizedSubtaskStatus === 'completed' || normalizedSubtaskStatus === 'ho√†n th√†nh' || normalizedSubtaskStatus === 'ƒë√£ ho√†n th√†nh' || normalizedSubtaskStatus === 'c·∫ßn update' || normalizedSubtaskStatus === 'can update';
                
                // Hi·ªÉn th·ªã n√∫t khai b√°o ho·∫∑c c·∫≠p nh·∫≠t b√°o c√°o: n·∫øu b·ªã kh√≥a th√¨ l√†m m·ªù, n·∫øu kh√¥ng hi·ªÉn th·ªã th√¨ d√πng placeholder
                let declarationBtnHtml = '';
                if (showDeclarationBtn) {
                  if (isDeclarationLocked) {
                    // N√∫t b·ªã kh√≥a: hi·ªÉn th·ªã nh∆∞ng l√†m m·ªù v√† disabled
                    declarationBtnHtml = `<button type="button" class="f5-declaration-btn flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-white bg-gray-400 cursor-not-allowed rounded-lg transition-colors shadow-sm opacity-50" data-task-id="${task.id}" data-subtask-id="${st.id}" data-type="subtask" data-subtask-type="${st.type || ''}" data-declaration-mode="${st.declarationMode || ''}" data-locked="true" title="Khai b√°o ƒë√£ b·ªã kh√≥a" disabled>
                        <span class="material-symbols-outlined text-sm">description</span>
                        <span>Khai b√°o</span>
                      </button>`;
                  } else if (isDone) {
                    // T√°c v·ª• ƒë√£ Done: hi·ªÉn th·ªã n√∫t "C·∫≠p nh·∫≠t b√°o c√°o" (m√†u h·ªìng gi·ªëng Form 1)
                    declarationBtnHtml = `<button type="button" class="f5-declaration-btn f5-update-report-btn flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-white bg-pink-600 hover:bg-pink-700 rounded-lg transition-colors shadow-sm" data-task-id="${task.id}" data-subtask-id="${st.id}" data-type="subtask" data-subtask-type="${st.type || ''}" data-declaration-mode="${st.declarationMode || ''}" data-is-done="true" title="C·∫≠p nh·∫≠t b√°o c√°o">
                        <span class="material-symbols-outlined text-sm">edit</span>
                        <span>C·∫≠p nh·∫≠t b√°o c√°o</span>
                      </button>`;
                  } else {
                    // N√∫t b√¨nh th∆∞·ªùng: c√≥ th·ªÉ click
                    declarationBtnHtml = `<button type="button" class="f5-declaration-btn flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors shadow-sm" data-task-id="${task.id}" data-subtask-id="${st.id}" data-type="subtask" data-subtask-type="${st.type || ''}" data-declaration-mode="${st.declarationMode || ''}" title="Khai b√°o">
                        <span class="material-symbols-outlined text-sm">description</span>
                        <span>Khai b√°o</span>
                      </button>`;
                  }
                } else {
                  declarationBtnHtml = '<div class="w-[120px]"></div>'; // Placeholder ƒë·ªÉ gi·ªØ v·ªã tr√≠ khi kh√¥ng c√≥ n√∫t khai b√°o
                }
                
                // S·ªë th·ª© t·ª± subtask v·ªõi ƒë·ªô r·ªông c·ªë ƒë·ªãnh ƒë·ªÉ cƒÉn ch·ªânh ƒë·∫πp
                const subtaskNoDisplay = st.subtaskNo 
                  ? `<span class="inline-block w-8 text-right text-gray-500 font-semibold">#${st.subtaskNo}</span>` 
                  : `<span class="inline-block w-8"></span>`;
                
                html += `
                  <tr class="group hover:bg-green-50/50 transition bg-green-50/10" data-task-id="${task.id}" data-subtask-id="${st.id}">
                    <td class="px-6 py-3">
                      <div class="ml-16 flex items-center gap-3">
                        ${declarationBtnHtml}
                        ${subtaskNoDisplay}
                        <span class="font-normal text-sm ${subtaskStatusClass} f5-subtask-name cursor-pointer hover:text-blue-500" data-task-id="${task.id}" data-subtask-id="${st.id}">${st.name}</span>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 text-center">-</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${st.pic || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 text-center">-</td>
                    <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${formatF5Date(st.timesend) || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${formatF5Date(st.deadline || st.dueDate) || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${formatF5Date(st.finishTime || st.Subtaskfinishtime) || '-'}</td>
                    <td class="px-4 py-3">${getF5SubtaskStatusBadge(st.status)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-center">${(function() {
                      if (st.timespend === null || st.timespend === undefined || st.timespend === '') return '-';
                      const numValue = typeof st.timespend === 'number' ? st.timespend : parseFloat(st.timespend);
                      return !isNaN(numValue) ? numValue.toFixed(1) : st.timespend;
                    })()}</td>
                    <td class="px-4 py-3 text-sm font-mono text-gray-600">${st.subtaskCode || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                      ${(function() {
                        const resultLink = st.Subtaskresultlink || st.subtaskresultlink || st.SubtaskResultLink || st.resultLink || '';
                        if (resultLink && resultLink.trim()) {
                          return `<a href="${resultLink.trim()}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">(Link)</a>`;
                        }
                        return '-';
                      })()}
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex items-center justify-end gap-2">
                        <button type="button" class="f5-view-subtask-detail-btn flex items-center justify-center w-9 h-9 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-600 hover:text-blue-700 transition-all shadow-sm hover:shadow-md" data-task-id="${task.id}" data-subtask-id="${st.id}" title="T·∫£i b√°o c√°o">
                          <span class="material-symbols-outlined text-xl">more_horiz</span>
                        </button>
                      </div>
                    </td>
                  </tr>
                `;
              });

              // Row ƒë·ªÉ th√™m subtask m·ªõi - T·∫°m kh√≥a t√≠nh nƒÉng ƒëang ph√°t tri·ªÉn
              /*
              html += `
                <tr class="group hover:bg-blue-50/50 transition" data-task-id="${task.id}">
                  <td class="py-3 pl-20 pr-6" colspan="9">
                    <button type="button" class="f5-add-subtask-btn flex w-full items-center justify-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg transition-all transform hover:scale-105" data-task-id="${task.id}">
                      <span class="material-symbols-outlined text-xl">add_circle</span>
                      <span>Th√™m t√°c v·ª• con</span>
                    </button>
                  </td>
                </tr>
              `;
              */
            }
          });
        }
      });

      tbody.innerHTML = html;

      // G·∫Øn event listeners
      setupF5EventListeners();
    }

    // Event listener cho tbody - ch·ªâ g·∫Øn m·ªôt l·∫ßn
    let f5TbodyListenerAttached = false;
    
    function setupF5EventListeners() {
      const tbody = document.getElementById('f5-tasksTableBody');
      if (!tbody) return;
      
      // Expand/collapse project buttons
      document.querySelectorAll('.f5-project-expand-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const projectId = e.target.getAttribute('data-project-id');
          const project = F5_PROJECTS.find(p => p.id === projectId);
          if (project) {
            project.expanded = !project.expanded;
            renderF5TasksTable();
          }
        });
      });
      
      // Expand/collapse task buttons
      document.querySelectorAll('.f5-expand-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const taskId = e.target.getAttribute('data-task-id');
          const result = findF5Task(taskId);
        const task = result ? result.task : null;
          if (task) {
            task.expanded = !task.expanded;
            renderF5TasksTable();
          }
        });
      });

      // N√∫t Khai b√°o cho tasks v√† subtasks - s·ª≠ d·ª•ng event delegation
      if (!tbody._f5DeclarationListenerAttached) {
        tbody._f5DeclarationListenerAttached = true;
        tbody.addEventListener('click', (e) => {
          const declarationBtn = e.target.closest('.f5-declaration-btn');
          if (declarationBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            // Ki·ªÉm tra n·∫øu n√∫t b·ªã kh√≥a (disabled ho·∫∑c data-locked)
            if (declarationBtn.disabled || declarationBtn.getAttribute('data-locked') === 'true') {
              showToast('Khai b√°o ƒë√£ b·ªã kh√≥a: Subtask A ƒë√£ ·ªü tr·∫°ng th√°i "leader review" ho·∫∑c "ƒê√£ ho√†n th√†nh"', 'warning');
              return;
            }
            
            const taskId = declarationBtn.getAttribute('data-task-id');
            const subtaskId = declarationBtn.getAttribute('data-subtask-id');
            
            if (!taskId) {
              console.error('[Form 5] No task-id found on declaration button');
              return;
            }
            
            // T√¨m subtask ƒë·ªÉ x√°c ƒë·ªãnh s·ªë th·ª© t·ª±
            const result = findF5Task(taskId);
            if (!result || !result.task) {
              showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
              return;
            }
            
            const task = result.task;
            if (subtaskId && task.subtasks) {
              const subtask = task.subtasks.find(st => st.id === subtaskId);
              if (subtask) {
                // Ki·ªÉm tra logic kh√≥a khai b√°o cho form5_subtask_auto_a
                const subtaskType = String(subtask.type || '').trim();
                if (subtaskType === 'form5_subtask_auto_a') {
                  const statusLower = String(subtask.status || '').toLowerCase().trim();
                  if (statusLower === 'leader review' || 
                      statusLower === 'done' || 
                      statusLower === 'completed' || 
                      statusLower === 'ho√†n th√†nh' || 
                      statusLower === 'ƒë√£ ho√†n th√†nh') {
                    showToast('Kh√¥ng th·ªÉ khai b√°o: Subtask A ƒë√£ ·ªü tr·∫°ng th√°i "leader review" ho·∫∑c "ƒê√£ ho√†n th√†nh"', 'warning');
                    return;
                  }
                }
                
                const subtaskName = String(subtask.name || '').trim();
                const declarationMode = String(subtask.declarationMode || '').trim();
                
                // N·∫øu subtask c√≥ declarationMode, m·ªü modal t∆∞∆°ng ·ª©ng
                if (declarationMode) {
                  handleF5DeclarationModeSelect(declarationMode, taskId, subtaskId);
                  return;
                }
                
                // "Ki·ªÉm tra v√† chu·∫©n b·ªã t√†i li·ªáu" ‚Üí M·ªü tr·ª±c ti·∫øp "G·ª≠i form b√°o c√°o" (send-test-task)
                if (subtaskName === 'Ki·ªÉm tra v√† chu·∫©n b·ªã t√†i li·ªáu') {
                  openF5DeclarationSendTestTaskModal(taskId, subtaskId);
                  return;
                }
                // "Ho√†n thi·ªán b√°o c√°o v√† nghi·ªám thu" ‚Üí M·ªü tr·ª±c ti·∫øp "Khai b√°o ho√†n th√†nh" (complete)
                if (subtaskName === 'Ho√†n thi·ªán b√°o c√°o v√† nghi·ªám thu') {
                  openF5DeclarationCompleteModal(taskId, subtaskId);
                  return;
                }
                
                // N·∫øu subtask ƒë∆∞·ª£c t√¨m th·∫•y nh∆∞ng kh√¥ng kh·ªõp ƒëi·ªÅu ki·ªán khai b√°o
                // ƒê√¢y l√† tr∆∞·ªùng h·ª£p kh√¥ng n√™n x·∫£y ra n·∫øu logic render ƒë√∫ng
                console.warn('[Form 5] Subtask found but no declaration function available:', {
                  subtaskId,
                  subtaskName,
                  declarationMode
                });
                return; // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o cho user v√¨ n√∫t kh√¥ng n√™n ƒë∆∞·ª£c hi·ªÉn th·ªã
              } else {
                // Kh√¥ng t√¨m th·∫•y subtask - c√≥ th·ªÉ do d·ªØ li·ªáu thay ƒë·ªïi
                console.error('[Form 5] Subtask not found:', subtaskId, 'in task:', taskId);
                showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª• con. Vui l√≤ng t·∫£i l·∫°i trang.', 'error');
                return;
              }
            }
            
            // N·∫øu kh√¥ng c√≥ subtaskId, c√≥ th·ªÉ l√† task parent - m·ªü modal ch·ªçn ch·∫ø ƒë·ªô
            if (!subtaskId) {
              openF5SelectDeclarationModal(taskId);
              return;
            }
            
            // Tr∆∞·ªùng h·ª£p kh√¥ng mong mu·ªën - ch·ªâ log, kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o cho user
            console.error('[Form 5] Unexpected state in declaration button click:', {
              taskId,
              subtaskId,
              hasSubtasks: !!task.subtasks
            });
          }
        });
        console.log('[Form 5] Event listener attached to tbody for declaration buttons');
      }
      
      // Click v√†o t√™n project/task/subtask ƒë·ªÉ xem chi ti·∫øt - s·ª≠ d·ª•ng event delegation
      if (!tbody._f5ViewDetailListenerAttached) {
        tbody._f5ViewDetailListenerAttached = true;
        tbody.addEventListener('click', (e) => {
          // Click v√†o project name - toggle expand
          const projectName = e.target.closest('.f5-project-name');
          if (projectName) {
            e.preventDefault();
            e.stopPropagation();
            const projectId = projectName.getAttribute('data-project-id');
            if (projectId) {
              // Toggle expand project
              const project = F5_PROJECTS.find(p => p.id === projectId);
              if (project) {
                project.expanded = !project.expanded;
                renderF5TasksTable();
              }
            }
            return;
          }
          
          // Click v√†o task name
          const taskName = e.target.closest('.f5-task-name');
          if (taskName) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = taskName.getAttribute('data-task-id');
            if (taskId) {
              openF5ViewTaskDetail(taskId);
            }
            return;
          }
          
          // Click v√†o subtask name
          const subtaskName = e.target.closest('.f5-subtask-name');
          if (subtaskName) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = subtaskName.getAttribute('data-task-id');
            const subtaskId = subtaskName.getAttribute('data-subtask-id');
            if (taskId && subtaskId) {
              openF5ViewSubtaskDetail(taskId, subtaskId);
            }
            return;
          }
          
          // Click v√†o n√∫t 3 ch·∫•m c·ªßa subtask (f5-view-subtask-detail-btn)
          const subtaskDetailBtn = e.target.closest('.f5-view-subtask-detail-btn');
          if (subtaskDetailBtn) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = subtaskDetailBtn.getAttribute('data-task-id');
            const subtaskId = subtaskDetailBtn.getAttribute('data-subtask-id');
            console.log('[Form 5] Subtask detail button clicked:', { taskId, subtaskId });
            if (taskId && subtaskId) {
              openF5ViewSubtaskDetail(taskId, subtaskId);
            } else {
              console.error('[Form 5] Missing taskId or subtaskId:', { taskId, subtaskId });
            }
            return;
          }
          
          // Click v√†o icon b√™n trong n√∫t 3 ch·∫•m c·ªßa subtask
          const iconInSubtaskBtn = e.target.closest('.material-symbols-outlined');
          if (iconInSubtaskBtn && iconInSubtaskBtn.parentElement && iconInSubtaskBtn.parentElement.classList.contains('f5-view-subtask-detail-btn')) {
            e.preventDefault();
            e.stopPropagation();
            const parentBtn = iconInSubtaskBtn.parentElement;
            const taskId = parentBtn.getAttribute('data-task-id');
            const subtaskId = parentBtn.getAttribute('data-subtask-id');
            console.log('[Form 5] Subtask detail icon clicked:', { taskId, subtaskId });
            if (taskId && subtaskId) {
              openF5ViewSubtaskDetail(taskId, subtaskId);
            } else {
              console.error('[Form 5] Missing taskId or subtaskId:', { taskId, subtaskId });
            }
            return;
          }
          
          // Click v√†o n√∫t 3 ch·∫•m c·ªßa task (f5-view-detail-btn)
          const taskDetailBtn = e.target.closest('.f5-view-detail-btn');
          if (taskDetailBtn) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = taskDetailBtn.getAttribute('data-task-id');
            if (taskId) {
              openF5ViewTaskDetail(taskId);
            }
            return;
          }
        });
        console.log('[Form 5] Event listener attached to tbody for view detail');
      }

      // N√∫t th√™m subtask - T·∫°m kh√≥a t√≠nh nƒÉng ƒëang ph√°t tri·ªÉn
      /*
      if (!tbody._f5SubtaskListenerAttached) {
        tbody._f5SubtaskListenerAttached = true;
        tbody.addEventListener('click', (e) => {
          // T√¨m button ho·∫∑c icon b√™n trong button
          const addBtn = e.target.closest('.f5-add-subtask-btn');
          const icon = e.target.closest('.material-symbols-outlined');
          
          if (addBtn) {
            e.preventDefault();
            e.stopPropagation();
            const taskId = addBtn.getAttribute('data-task-id');
            console.log('[Form 5] Add subtask button clicked, taskId:', taskId, 'button:', addBtn);
            if (taskId) {
              openF5AddSubtaskModal(taskId);
            } else {
              console.error('[Form 5] No task-id found on button');
            }
          } else if (icon && icon.parentElement && icon.parentElement.classList.contains('f5-add-subtask-btn')) {
            // N·∫øu click v√†o icon b√™n trong button
            e.preventDefault();
            e.stopPropagation();
            const parentBtn = icon.parentElement;
            const taskId = parentBtn.getAttribute('data-task-id');
            console.log('[Form 5] Add subtask icon clicked, taskId:', taskId);
            if (taskId) {
              openF5AddSubtaskModal(taskId);
            } else {
              console.error('[Form 5] No task-id found on parent button');
            }
          }
        });
        console.log('[Form 5] Event listener attached to tbody for add subtask buttons');
      }
      */

    }

    // ===== FORM 5: IMPORT EXCEL FUNCTIONALITY =====
    let F5_IMPORT_EXCEL_FILE = null;

    function setupF5ImportExcel() {
      // N√∫t m·ªü modal import
      const importBtn = document.getElementById('f5-importExcelBtn');
      if (importBtn) {
        importBtn.addEventListener('click', () => {
          openF5ImportExcelModal();
        });
      }

      // Modal close buttons
      const closeBtn = document.getElementById('modal-f5-import-excel-close');
      const cancelBtn = document.getElementById('modal-f5-import-excel-cancel');
      if (closeBtn) closeBtn.addEventListener('click', closeF5ImportExcelModal);
      if (cancelBtn) cancelBtn.addEventListener('click', closeF5ImportExcelModal);

      // File input button
      const fileBtn = document.getElementById('f5-import-excel-file-btn');
      const fileInput = document.getElementById('f5-import-excel-file');
      const fileRemove = document.getElementById('f5-import-excel-file-remove');
      
      if (fileBtn && fileInput) {
        fileBtn.addEventListener('click', () => fileInput.click());
      }

      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const validExtensions = ['.xlsx', '.xls'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExt)) {
              showToast('Vui l√≤ng ch·ªçn file Excel (.xlsx ho·∫∑c .xls)', 'error');
              fileInput.value = '';
              return;
            }

            F5_IMPORT_EXCEL_FILE = file;
            document.getElementById('f5-import-excel-file-name').textContent = file.name;
            document.getElementById('f5-import-excel-file-name').className = 'text-sm text-green-600 flex-1 font-medium';
            if (fileRemove) fileRemove.classList.remove('hidden');
            
            // Preview file
            previewF5ImportExcel(file);
          }
        });
      }

      if (fileRemove) {
        fileRemove.addEventListener('click', () => {
          if (fileInput) fileInput.value = '';
          F5_IMPORT_EXCEL_FILE = null;
          document.getElementById('f5-import-excel-file-name').textContent = 'Ch∆∞a ch·ªçn file';
          document.getElementById('f5-import-excel-file-name').className = 'text-sm text-gray-500 flex-1';
          fileRemove.classList.add('hidden');
          document.getElementById('f5-import-excel-preview').classList.add('hidden');
          document.getElementById('modal-f5-import-excel-submit').disabled = true;
        });
      }

      // Submit button
      const submitBtn = document.getElementById('modal-f5-import-excel-submit');
      if (submitBtn) {
        submitBtn.addEventListener('click', () => {
          if (F5_IMPORT_EXCEL_FILE) {
            importF5ExcelData(F5_IMPORT_EXCEL_FILE);
          }
        });
      }

      // Download template button
      const downloadTemplateBtn = document.getElementById('f5-download-template-btn');
      if (downloadTemplateBtn) {
        downloadTemplateBtn.addEventListener('click', () => {
          downloadF5ExcelTemplate();
        });
      }
    }

    function openF5ImportExcelModal() {
      const success = openModal('f5-import-excel', (modal, config) => {
        // Reset form
        F5_IMPORT_EXCEL_FILE = null;
        const fileInput = document.getElementById('f5-import-excel-file');
        if (fileInput) fileInput.value = '';
        document.getElementById('f5-import-excel-file-name').textContent = 'Ch∆∞a ch·ªçn file';
        document.getElementById('f5-import-excel-file-name').className = 'text-sm text-gray-500 flex-1';
        document.getElementById('f5-import-excel-file-remove').classList.add('hidden');
        document.getElementById('f5-import-excel-preview').classList.add('hidden');
        document.getElementById('f5-import-excel-error').classList.add('hidden');
        document.getElementById('modal-f5-import-excel-submit').disabled = true;
      });
    }

    function closeF5ImportExcelModal() {
      closeModal('f5-import-excel');
    }

    async function previewF5ImportExcel(file) {
      try {
        const data = await readExcelFile(file);
        const preview = parseF5ExcelPreview(data);
        
        const previewEl = document.getElementById('f5-import-excel-preview');
        const previewContent = document.getElementById('f5-import-excel-preview-content');
        
        previewContent.innerHTML = preview.html;
        previewEl.classList.remove('hidden');
        
        // Enable submit button if valid
        const submitBtn = document.getElementById('modal-f5-import-excel-submit');
        if (preview.valid) {
          submitBtn.disabled = false;
        } else {
          submitBtn.disabled = true;
          showF5ImportError(preview.errors);
        }
      } catch (error) {
        console.error('[Form 5] Error previewing Excel:', error);
        showF5ImportError(['L·ªói ƒë·ªçc file Excel: ' + error.message]);
        document.getElementById('modal-f5-import-excel-submit').disabled = true;
      }
    }

    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // L·∫•y sheet ƒë·∫ßu ti√™n
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Convert sang JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });
            resolve(jsonData);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = () => reject(new Error('L·ªói ƒë·ªçc file'));
        reader.readAsArrayBuffer(file);
      });
    }

    function parseF5ExcelPreview(data) {
      const errors = [];
      let projectsCount = 0;
      let tasksCount = 0;
      let subtasksCount = 0;

      if (!Array.isArray(data) || data.length === 0) {
        errors.push('File Excel kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c format kh√¥ng ƒë√∫ng');
        return { html: '', valid: false, errors };
      }

      // Ki·ªÉm tra c√°c c·ªôt b·∫Øt bu·ªôc
      const firstRow = data[0];
      const requiredColumns = ['Project Code', 'Task Request Code', 'Task Name'];
      const missingColumns = requiredColumns.filter(col => !(col in firstRow));
      
      if (missingColumns.length > 0) {
        errors.push(`Thi·∫øu c√°c c·ªôt b·∫Øt bu·ªôc: ${missingColumns.join(', ')}`);
        return { html: '<p class="text-red-600">File Excel kh√¥ng ƒë√∫ng format. Vui l√≤ng ki·ªÉm tra l·∫°i.</p>', valid: false, errors };
      }

      // Group theo Project Code v√† Task Request Code
      const projectsMap = {};
      
      data.forEach((row, index) => {
        const projectCode = String(row['Project Code'] || '').trim();
        const taskRequestCode = String(row['Task Request Code'] || '').trim();
        const taskName = String(row['Task Name'] || '').trim();
        const subtaskNo = row['Subtask No'] !== undefined && row['Subtask No'] !== null 
          ? Number(row['Subtask No']) 
          : null;

        if (!projectCode || !taskRequestCode || !taskName) {
          return; // Skip invalid rows
        }

        if (!projectsMap[projectCode]) {
          projectsMap[projectCode] = {};
          projectsCount++;
        }

        if (!projectsMap[projectCode][taskRequestCode]) {
          projectsMap[projectCode][taskRequestCode] = {
            task: { name: taskName },
            subtasks: []
          };
          tasksCount++;
        }

        if (subtaskNo !== null && !isNaN(subtaskNo) && subtaskNo > 0) {
          const subtaskName = String(row['Subtask Name'] || '').trim();
          if (subtaskName) {
            projectsMap[projectCode][taskRequestCode].subtasks.push({
              no: subtaskNo,
              name: subtaskName
            });
            subtasksCount++;
          }
        }
      });

      let html = '<div class="space-y-2">';
      html += `<p class="font-semibold text-gray-700">T·ªïng h·ª£p:</p>`;
      html += `<ul class="list-disc list-inside text-sm text-gray-600 space-y-1">`;
      html += `<li>D·ª± √°n: <strong>${projectsCount}</strong></li>`;
      html += `<li>Tasks: <strong>${tasksCount}</strong></li>`;
      html += `<li>Subtasks: <strong>${subtasksCount}</strong></li>`;
      html += `<li>T·ªïng s·ªë d√≤ng: <strong>${data.length}</strong></li>`;
      html += `</ul>`;
      
      if (projectsCount > 0) {
        html += `<p class="font-semibold text-gray-700 mt-4">Danh s√°ch d·ª± √°n:</p>`;
        html += `<ul class="list-disc list-inside text-sm text-gray-600 space-y-1 max-h-32 overflow-y-auto">`;
        Object.keys(projectsMap).slice(0, 10).forEach(projectCode => {
          const tasks = Object.keys(projectsMap[projectCode]);
          html += `<li>${projectCode}: ${tasks.length} task(s)</li>`;
        });
        if (projectsCount > 10) {
          html += `<li>... v√† ${projectsCount - 10} d·ª± √°n kh√°c</li>`;
        }
        html += `</ul>`;
      }
      html += '</div>';

      return { html, valid: errors.length === 0, errors };
    }

    function showF5ImportError(errors) {
      const errorEl = document.getElementById('f5-import-excel-error');
      const errorContent = document.getElementById('f5-import-excel-error-content');
      
      if (errors && errors.length > 0) {
        errorContent.innerHTML = '<ul class="list-disc list-inside space-y-1">' + 
          errors.map(e => `<li>${e}</li>`).join('') + 
          '</ul>';
        errorEl.classList.remove('hidden');
      } else {
        errorEl.classList.add('hidden');
      }
    }

    async function importF5ExcelData(file) {
      const submitBtn = document.getElementById('modal-f5-import-excel-submit');
      const originalHTML = submitBtn.innerHTML;
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span><span style="margin-left:8px">ƒêang import...</span>';
        
        // ƒê·ªçc file Excel
        const data = await readExcelFile(file);
        
        // Parse v√† import d·ªØ li·ªáu
        const importedProjects = parseF5ExcelData(data);
        
        if (importedProjects.length === 0) {
          showToast('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ import', 'warning');
          return;
        }

        // Merge v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i (tr√°nh tr√πng l·∫∑p)
        importedProjects.forEach(newProject => {
          const existingProjectIndex = F5_PROJECTS.findIndex(p => p.projectCode === newProject.projectCode);
          
          if (existingProjectIndex >= 0) {
            // Merge tasks v√†o project ƒë√£ t·ªìn t·∫°i
            const existingProject = F5_PROJECTS[existingProjectIndex];
            newProject.tasks.forEach(newTask => {
              const existingTaskIndex = existingProject.tasks.findIndex(t => t.taskCode === newTask.taskCode);
              
              if (existingTaskIndex >= 0) {
                // Merge subtasks v√†o task ƒë√£ t·ªìn t·∫°i
                const existingTask = existingProject.tasks[existingTaskIndex];
                newTask.subtasks.forEach(newSubtask => {
                  const existingSubtaskIndex = existingTask.subtasks.findIndex(
                    st => st.subtaskNo === newSubtask.subtaskNo
                  );
                  
                  if (existingSubtaskIndex >= 0) {
                    // Update subtask ƒë√£ t·ªìn t·∫°i
                    existingTask.subtasks[existingSubtaskIndex] = newSubtask;
                  } else {
                    // Th√™m subtask m·ªõi
                    existingTask.subtasks.push(newSubtask);
                  }
                });
              } else {
                // Th√™m task m·ªõi
                existingProject.tasks.push(newTask);
              }
            });
          } else {
            // Th√™m project m·ªõi
            F5_PROJECTS.push(newProject);
          }
        });

        // Render l·∫°i b·∫£ng
        renderF5TasksTable();
        
        // ƒê√≥ng modal
        closeF5ImportExcelModal();
        
        showToast(`ƒê√£ import th√†nh c√¥ng ${importedProjects.length} d·ª± √°n`, 'success');
      } catch (error) {
        console.error('[Form 5] Error importing Excel:', error);
        showF5ImportError(['L·ªói import: ' + error.message]);
        showToast('L·ªói khi import d·ªØ li·ªáu: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
      }
    }

    function parseF5ExcelData(data) {
      const projectsMap = {};
      
      data.forEach((row, index) => {
        // L·∫•y c√°c gi√° tr·ªã t·ª´ Excel
        const projectCode = String(row['Project Code'] || '').trim();
        const projectName = String(row['Project Name'] || '').trim() || `D·ª± √°n ${projectCode}`;
        const taskRequestCode = String(row['Task Request Code'] || '').trim();
        const taskName = String(row['Task Name'] || '').trim();
        const requesterName = String(row['Requester Name'] || '').trim();
        const requesterEmail = String(row['Requester Email'] || '').trim();
        const pic = String(row['PIC'] || row['Task PIC'] || '').trim();
        const department = String(row['Department'] || row['Task Department'] || '').trim();
        const createdAt = row['Created At'] || row['Task Created At'] || new Date().toISOString().split('T')[0];
        const dueDate = row['Due Date'] || row['Task Due Date'] || '';
        const status = String(row['Status'] || row['Task Status'] || 'pending').trim().toLowerCase();
        
        // Subtask fields
        const subtaskNo = row['Subtask No'] !== undefined && row['Subtask No'] !== null 
          ? Number(row['Subtask No']) 
          : null;
        const subtaskName = String(row['Subtask Name'] || '').trim();
        const subtaskPIC = String(row['Subtask PIC'] || '').trim();
        const subtaskManhour = row['Subtask Manhour'] !== undefined && row['Subtask Manhour'] !== null
          ? Number(row['Subtask Manhour'])
          : null;
        const subtaskStatus = String(row['Subtask Status'] || 'pending').trim().toLowerCase();
        const subtaskTimesend = row['Subtask Timesend'] || null;
        const subtaskNote = String(row['Subtask Note'] || '').trim();
        const declarationMode = String(row['Declaration Mode'] || '').trim();

        // Validate required fields
        if (!projectCode || !taskRequestCode || !taskName) {
          return; // Skip invalid rows
        }

        // T·∫°o ho·∫∑c l·∫•y project
        if (!projectsMap[projectCode]) {
          projectsMap[projectCode] = {
            id: `PROJ-${projectCode}`,
            projectCode: projectCode,
            projectName: projectName,
            description: '',
            pic: pic || '',
            createdAt: formatDateForF5(createdAt),
            dueDate: formatDateForF5(dueDate),
            status: 'in_progress',
            expanded: true,
            tasks: []
          };
        }

        // T√¨m ho·∫∑c t·∫°o task
        let task = projectsMap[projectCode].tasks.find(t => t.taskCode === taskRequestCode);
        
        if (!task) {
          // Generate task ID
          const taskId = `TASK-${taskRequestCode}-${Date.now()}-${index}`;
          
          task = {
            id: taskId,
            taskCode: taskRequestCode,
            taskName: taskName,
            requesterName: requesterName || '',
            requesterEmail: requesterEmail || '',
            pic: pic || '',
            department: department || '',
            createdAt: formatDateForF5(createdAt),
            dueDate: formatDateForF5(dueDate),
            status: status || 'pending',
            expanded: true,
            subtasks: []
          };
          
          projectsMap[projectCode].tasks.push(task);
        }

        // N·∫øu c√≥ subtask
        if (subtaskNo !== null && !isNaN(subtaskNo) && subtaskNo > 0 && subtaskName) {
          const subtaskId = `SUBTASK-${taskRequestCode}-${subtaskNo}-${Date.now()}-${index}`;
          
          const subtask = {
            id: subtaskId,
            subtaskNo: subtaskNo,
            name: subtaskName,
            pic: subtaskPIC || '',
            manhour: subtaskManhour,
            status: subtaskStatus || 'pending',
            timesend: formatDateForF5(subtaskTimesend),
            dueDate: formatDateForF5(dueDate),
            note: subtaskNote || '',
            declarationMode: declarationMode || '',
            type: declarationMode ? `form5_subtask_${declarationMode}` : null,
            subtaskCode: `${taskRequestCode}-ST${subtaskNo}`
          };
          
          task.subtasks.push(subtask);
        }
      });

      return Object.values(projectsMap);
    }

    function formatDateForF5(dateValue) {
      if (!dateValue) return '';
      
      // N·∫øu l√† string, th·ª≠ parse
      if (typeof dateValue === 'string') {
        // N·∫øu c√≥ format YYYY-MM-DD ho·∫∑c YYYY-MM-DD HH:mm:ss
        if (dateValue.match(/^\d{4}-\d{2}-\d{2}/)) {
          return dateValue.split(' ')[0]; // L·∫•y ph·∫ßn date
        }
        // N·∫øu l√† Excel date serial number
        if (!isNaN(dateValue)) {
          const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
          return excelDate.toISOString().split('T')[0];
        }
      }
      
      // N·∫øu l√† Date object
      if (dateValue instanceof Date) {
        return dateValue.toISOString().split('T')[0];
      }
      
      // N·∫øu l√† number (Excel serial date)
      if (typeof dateValue === 'number') {
        const excelDate = new Date((dateValue - 25569) * 86400 * 1000);
        return excelDate.toISOString().split('T')[0];
      }
      
      return '';
    }

    function downloadF5ExcelTemplate() {
      try {
        // T·∫°o workbook m·ªõi
        const wb = XLSX.utils.book_new();

        // Sheet 1: H∆∞·ªõng d·∫´n
        const guideData = [
          ['H∆Ø·ªöNG D·∫™N IMPORT TASKS T·ª™ EXCEL'],
          [],
          ['C√ÅC C·ªòT B·∫ÆT BU·ªòC (ph·∫£i ƒëi·ªÅn):'],
          ['1. Project Code', 'M√£ d·ª± √°n (v√≠ d·ª•: DQA001)'],
          ['2. Task Request Code', 'M√£ y√™u c·∫ßu t√°c v·ª• (v√≠ d·ª•: QA.SPM.1122-J8MVRM)'],
          ['3. Task Name', 'T√™n t√°c v·ª•'],
          [],
          ['C√ÅC C·ªòT T√ôY CH·ªåN:'],
          ['- Project Name', 'T√™n d·ª± √°n (n·∫øu kh√¥ng ƒëi·ªÅn s·∫Ω t·ª± ƒë·ªông t·∫°o)'],
          ['- Requester Name', 'T√™n ng∆∞·ªùi y√™u c·∫ßu'],
          ['- Requester Email', 'Email ng∆∞·ªùi y√™u c·∫ßu'],
          ['- PIC', 'Ng∆∞·ªùi ph·ª• tr√°ch'],
          ['- Department', 'Ph√≤ng ban'],
          ['- Created At', 'Ng√†y t·∫°o (format: YYYY-MM-DD)'],
          ['- Due Date', 'Ng√†y h·∫øt h·∫°n (format: YYYY-MM-DD)'],
          ['- Status', 'Tr·∫°ng th√°i (pending/in_progress/done)'],
          [],
          ['ƒê·ªÇ TH√äM SUBTASK:'],
          ['- Th√™m d√≤ng m·ªõi v·ªõi c√πng Task Request Code'],
          ['- ƒêi·ªÅn Subtask No (s·ªë > 0, v√≠ d·ª•: 1, 2, 3...)'],
          ['- ƒêi·ªÅn Subtask Name v√† c√°c th√¥ng tin kh√°c'],
          [],
          ['C√ÅC C·ªòT SUBTASK T√ôY CH·ªåN:'],
          ['- Subtask Name', 'T√™n t√°c v·ª• con'],
          ['- Subtask PIC', 'Ng∆∞·ªùi th·ª±c hi·ªán subtask'],
          ['- Subtask Manhour', 'S·ªë gi·ªù c√¥ng (s·ªë)'],
          ['- Subtask Status', 'Tr·∫°ng th√°i (pending/in_progress/done)'],
          ['- Subtask Timesend', 'Th·ªùi gian g·ª≠i (YYYY-MM-DD HH:mm:ss)'],
          ['- Subtask Note', 'Ghi ch√∫'],
          ['- Declaration Mode', 'Ch·∫ø ƒë·ªô khai b√°o (review-file-nctn/review-ce-qc/train-qc/send-test-task/review-4m/review-fmea)'],
          [],
          ['L∆ØU √ù:'],
          ['- C√°c c·ªôt b·∫Øt bu·ªôc ƒë∆∞·ª£c ƒë√°nh d·∫•u (*) trong sheet Import Tasks'],
          ['- M·ªói task c√≥ th·ªÉ c√≥ nhi·ªÅu subtask'],
          ['- Subtask ph·∫£i c√≥ c√πng Task Request Code v·ªõi task cha'],
          ['- N·∫øu Project Code ƒë√£ t·ªìn t·∫°i, s·∫Ω merge tasks v√†o project ƒë√≥'],
          ['- N·∫øu Task Request Code ƒë√£ t·ªìn t·∫°i, s·∫Ω merge subtasks v√†o task ƒë√≥']
        ];
        const wsGuide = XLSX.utils.aoa_to_sheet(guideData);
        wsGuide['!cols'] = [{ wch: 25 }, { wch: 60 }];
        XLSX.utils.book_append_sheet(wb, wsGuide, 'H∆∞·ªõng d·∫´n');

        // Sheet 2: Template v·ªõi d·ªØ li·ªáu m·∫´u
        const headers = [
          'Project Code *',           // B·∫Øt bu·ªôc
          'Project Name',             // T√πy ch·ªçn
          'Task Request Code *',      // B·∫Øt bu·ªôc
          'Task Name *',              // B·∫Øt bu·ªôc
          'Requester Name',           // T√πy ch·ªçn
          'Requester Email',          // T√πy ch·ªçn
          'PIC',                      // T√πy ch·ªçn
          'Department',               // T√πy ch·ªçn
          'Created At',               // T√πy ch·ªçn (YYYY-MM-DD)
          'Due Date',                 // T√πy ch·ªçn (YYYY-MM-DD)
          'Status',                   // T√πy ch·ªçn (pending/in_progress/done)
          'Subtask No',               // T√πy ch·ªçn (s·ªë > 0 ƒë·ªÉ t·∫°o subtask)
          'Subtask Name',             // T√πy ch·ªçn
          'Subtask PIC',              // T√πy ch·ªçn
          'Subtask Manhour',          // T√πy ch·ªçn (s·ªë)
          'Subtask Status',           // T√πy ch·ªçn (pending/in_progress/done)
          'Subtask Timesend',         // T√πy ch·ªçn (YYYY-MM-DD HH:mm:ss)
          'Subtask Note',             // T√πy ch·ªçn
          'Declaration Mode'          // T√πy ch·ªçn
        ];

        // D·ªØ li·ªáu m·∫´u
        const sampleData = [
          // D√≤ng 1: Task kh√¥ng c√≥ subtask
          [
            'DQA001',
            'D·ª± √°n ƒê√°nh gi√° S·∫£n ph·∫©m M·ªõi - DQA001',
            'QA.SPM.1122-J8MVRM',
            'T√°c v·ª• th·ª≠ nghi·ªám h·ªá th·ªëng',
            'ƒê√†o Ho√†ng D∆∞∆°ng',
            'duong.dao@karofi.vn',
            'V≈© Th·ªã H·∫±ng',
            'DQA',
            '2025-11-22',
            '2025-11-30',
            'in_progress',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            ''
          ],
          // D√≤ng 2: Subtask 1 c·ªßa task tr√™n
          [
            'DQA001',
            '',
            'QA.SPM.1122-J8MVRM',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            1,
            'Ki·ªÉm tra ƒë·ªô k√≠n',
            'ƒê√†o Ho√†ng D∆∞∆°ng',
            8.5,
            'pending',
            '2025-11-22 14:52:00',
            'Ghi ch√∫ cho subtask',
            'send-test-task'
          ],
          // D√≤ng 3: Subtask 2 c·ªßa task tr√™n
          [
            'DQA001',
            '',
            'QA.SPM.1122-J8MVRM',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            2,
            'Ki·ªÉm tra ƒë·ªô b·ªÅn',
            'V≈© Th·ªã H·∫±ng',
            6.0,
            'in_progress',
            '2025-11-23 09:00:00',
            '',
            'review-ce-qc'
          ],
          // D√≤ng 4: Task m·ªõi kh√°c
          [
            'DQA002',
            'D·ª± √°n ƒê√°nh gi√° S·∫£n ph·∫©m SOP - DQA002',
            'QA.SOP.1122-ABC123',
            'T√°c v·ª• ƒë√°nh gi√° SOP',
            'Nguy·ªÖn VƒÉn A',
            'a.nguyen@karofi.vn',
            'Nguy·ªÖn Th·ªã B',
            'DQA',
            '2025-11-23',
            '2025-12-01',
            'pending',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            ''
          ]
        ];

        // T·∫°o worksheet t·ª´ d·ªØ li·ªáu
        const wsData = [headers, ...sampleData];
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Set column widths
        ws['!cols'] = [
          { wch: 15 },  // Project Code *
          { wch: 40 },  // Project Name
          { wch: 25 },  // Task Request Code *
          { wch: 30 },  // Task Name *
          { wch: 20 },  // Requester Name
          { wch: 25 },  // Requester Email
          { wch: 18 },  // PIC
          { wch: 15 },  // Department
          { wch: 12 },  // Created At
          { wch: 12 },  // Due Date
          { wch: 12 },  // Status
          { wch: 12 },  // Subtask No
          { wch: 25 },  // Subtask Name
          { wch: 18 },  // Subtask PIC
          { wch: 15 },  // Subtask Manhour
          { wch: 15 },  // Subtask Status
          { wch: 20 },  // Subtask Timesend
          { wch: 30 },  // Subtask Note
          { wch: 20 }   // Declaration Mode
        ];

        // Th√™m sheet v√†o workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Import Tasks');

        // T·∫°o t√™n file
        const filename = 'Form5_Import_Template.xlsx';

        // Xu·∫•t file
        XLSX.writeFile(wb, filename);

        showToast('ƒê√£ t·∫£i file m·∫´u th√†nh c√¥ng. Vui l√≤ng xem sheet "H∆∞·ªõng d·∫´n" ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.', 'success');
      } catch (error) {
        console.error('[Form 5] Error generating template:', error);
        showToast('L·ªói khi t·∫°o file m·∫´u: ' + error.message, 'error');
      }
    }
    // ===== END FORM 5: IMPORT EXCEL FUNCTIONALITY =====

    // C·∫≠p nh·∫≠t c√°c h√†m kh√°c ƒë·ªÉ d√πng findF5Task
    /**
     * C·∫≠p nh·∫≠t subtask B khi subtask A ho√†n th√†nh
     * T√≠nh timesend = A.completedAt + A.manhour
     * @param {Object} subtaskA - Subtask A ƒë√£ ho√†n th√†nh
     * @param {Object} task - Task ch·ª©a subtask
     */
    async function updateSubtaskBWhenADone(subtaskA, task) {
      try {
        // T√¨m subtask B c√≥ waitingFor = 'A' v√† dependsOn = A.id
        const subtaskB = task.subtasks?.find(st => 
          st.waitingFor === 'A' && 
          (st.dependsOn === subtaskA.id || st.dependsOn === String(subtaskA.id))
        );
        
        if (!subtaskB) {
          console.log('[Form 5] No subtask B found waiting for A');
          return;
        }
        
        // L·∫•y manhour c·ªßa A (n·∫øu c√≥)
        let aManhour = subtaskA.manhour ? parseFloat(subtaskA.manhour) : 4; // M·∫∑c ƒë·ªãnh 4h n·∫øu kh√¥ng c√≥
        if (isNaN(aManhour) || aManhour <= 0) {
          console.warn('[Form 5] Invalid manhour for subtask A, using default 4h');
          aManhour = 4;
        }
        
        // T√≠nh th·ªùi gian ho√†n th√†nh c·ªßa A (ho·∫∑c d√πng th·ªùi gian hi·ªán t·∫°i)
        const aCompletedAt = subtaskA.finishTime ? new Date(subtaskA.finishTime) : new Date();
        
        // T√≠nh timesend cho B = A.completedAt + A.manhour
        const timeB = addWorkingHours(aCompletedAt, aManhour);
        const formatDateTime = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return `${year}-${month}-${day}T${hours}:${minutes}`;
        };
        
        const timesendB = formatDateTime(timeB);
        
        // C·∫≠p nh·∫≠t subtask B trong local
        subtaskB.timesend = timesendB;
        subtaskB.manhour = aManhour; // Copy manhour t·ª´ A
        subtaskB.status = 'pending'; // Ho·∫∑c 'in_progress' n·∫øu ƒë√£ ƒë·∫øn gi·ªù
        
        // G·ª≠i c·∫≠p nh·∫≠t l√™n backend
        const updateEndpoint = 'https://iatzhxxuk.tino.page/webhook/form5-subtask-update';
        const updateData = {
          Id: subtaskB.id,
          SubtaskTimesend: timesendB,
          SubtaskManhour: aManhour,
          SubtaskStatus: subtaskB.status
        };
        
        const response = await fetch(updateEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
          console.log('[Form 5] Updated subtask B timesend:', timesendB);
          showToast(`Subtask B s·∫Ω b·∫Øt ƒë·∫ßu l√∫c ${timesendB}`, 'success');
        } else {
          console.warn('[Form 5] Failed to update subtask B:', await response.text());
        }
        
      } catch (error) {
        console.error('[Form 5] Error updating subtask B:', error);
      }
    }

    /**
     * C·∫≠p nh·∫≠t subtask C khi subtask B ho√†n th√†nh
     * T√≠nh timesend = B.completedAt + 4 gi·ªù l√†m vi·ªác
     * @param {Object} subtaskB - Subtask B ƒë√£ ho√†n th√†nh
     * @param {Object} task - Task ch·ª©a subtask
     */
    async function updateSubtaskCWhenBDone(subtaskB, task) {
      try {
        // T√¨m subtask C c√≥ waitingFor = 'B' v√† dependsOn = B.id
        const subtaskC = task.subtasks?.find(st => 
          st.waitingFor === 'B' && 
          (st.dependsOn === subtaskB.id || st.dependsOn === String(subtaskB.id))
        );
        
        if (!subtaskC) {
          console.log('[Form 5] No subtask C found waiting for B');
          return;
        }
        
        // T√≠nh th·ªùi gian ho√†n th√†nh c·ªßa B (ho·∫∑c d√πng th·ªùi gian hi·ªán t·∫°i)
        const bCompletedAt = subtaskB.finishTime ? new Date(subtaskB.finishTime) : new Date();
        
        // T√≠nh timesend cho C = B.completedAt + 4 gi·ªù l√†m vi·ªác
        const timeC = addWorkingHours(bCompletedAt, 4);
        const formatDateTime = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return `${year}-${month}-${day}T${hours}:${minutes}`;
        };
        
        const timesendC = formatDateTime(timeC);
        
        // C·∫≠p nh·∫≠t subtask C trong local
        subtaskC.timesend = timesendC;
        subtaskC.status = 'pending'; // Ho·∫∑c 'in_progress' n·∫øu ƒë√£ ƒë·∫øn gi·ªù
        
        // G·ª≠i c·∫≠p nh·∫≠t l√™n backend
        const updateEndpoint = 'https://iatzhxxuk.tino.page/webhook/form5-subtask-update';
        const updateData = {
          Id: subtaskC.id,
          SubtaskTimesend: timesendC,
          SubtaskStatus: subtaskC.status
        };
        
        const response = await fetch(updateEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
          console.log('[Form 5] Updated subtask C timesend:', timesendC);
          showToast(`Subtask C s·∫Ω b·∫Øt ƒë·∫ßu l√∫c ${timesendC}`, 'success');
        } else {
          console.warn('[Form 5] Failed to update subtask C:', await response.text());
        }
        
      } catch (error) {
        console.error('[Form 5] Error updating subtask C:', error);
      }
    }

    function updateF5TaskStatus(taskId) {
      const result = findF5Task(taskId);
      if (!result || !result.task) return;
      
      // Status c·ªßa task ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ tr∆∞·ªùng TaskStatus, kh√¥ng t√≠nh to√°n t·ª´ subtasks
      // Gi·ªØ nguy√™n status hi·ªán t·∫°i t·ª´ TaskStatus
      return;

      // Ki·ªÉm tra v√† c·∫≠p nh·∫≠t subtask B/C khi A/B done
      // NOTE: ƒê√£ t·∫Øt logic t·ª± ƒë·ªông t√≠nh timesend cho B v√† C - Backend s·∫Ω x·ª≠ l√Ω
      /*
      task.subtasks.forEach(subtask => {
        // N·∫øu subtask A v·ª´a done, c·∫≠p nh·∫≠t B
        if (subtask.type === 'form5_subtask_auto_a' && subtask.status === 'done') {
          updateSubtaskBWhenADone(subtask, task);
        }
        
        // N·∫øu subtask B v·ª´a done, c·∫≠p nh·∫≠t C
        if (subtask.type === 'form5_subtask_auto_b' && subtask.status === 'done') {
          updateSubtaskCWhenBDone(subtask, task);
        }
      });
      */

      // C·∫≠p nh·∫≠t project status n·∫øu c·∫ßn
      updateF5ProjectStatus(result.project);
      
      // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t UI
      renderF5TasksTable();
    }

    function updateF5ProjectStatus(project) {
      if (!project || !project.tasks || project.tasks.length === 0) return;
      
      const allDone = project.tasks.every(t => t.status === 'done');
      const hasInProgress = project.tasks.some(t => t.status === 'in_progress' || t.status === 'done');
      
      if (allDone) {
        project.status = 'done';
      } else if (hasInProgress) {
        project.status = 'in_progress';
      } else {
        project.status = 'pending';
      }
    }

    function getF5PriorityBadge(priority) {
      const priorityMap = {
        'Cao': { class: 'bg-red-100 text-red-800', text: 'Cao' },
        'Trung b√¨nh': { class: 'bg-yellow-100 text-yellow-800', text: 'Trung b√¨nh' },
        'Th·∫•p': { class: 'bg-gray-100 text-gray-800', text: 'Th·∫•p' }
      };
      const priorityInfo = priorityMap[priority] || priorityMap['Trung b√¨nh'];
      return `<span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${priorityInfo.class}">${priorityInfo.text}</span>`;
    }

    // H√†m m·ªü modal th√™m subtask - S·ª≠ d·ª•ng h·ªá th·ªëng modal t·∫≠p trung
    function openF5AddSubtaskModal(taskId) {
      console.log('[Form 5] openF5AddSubtaskModal called with taskId:', taskId);
      
      // S·ª≠ d·ª•ng h·ªá th·ªëng modal t·∫≠p trung v·ªõi callback ƒë·ªÉ setup form
      const success = openModal('f5-add-subtask', (modal, config) => {
        const result = findF5Task(taskId);
        console.log('[Form 5] Task lookup result:', result);
        
        let taskName = 'T√°c v·ª•';
        if (result && result.task) {
          taskName = result.task.taskName || 'T√°c v·ª•';
        } else {
          console.warn('[Form 5] Task not found, using default name');
        }
        
        // Hi·ªÉn th·ªã t√™n task cha
        const parentTaskNameEl = document.getElementById('modal-f5-add-subtask-parent-task-name');
        if (parentTaskNameEl) {
          parentTaskNameEl.textContent = taskName;
        }
        
        // L∆∞u task ID v√†o hidden input
        const taskIdInput = document.getElementById('modal-f5-add-subtask-task-id');
        if (taskIdInput) {
          taskIdInput.value = taskId;
        }
        
        // Set th·ªùi gian g·ª≠i m·∫∑c ƒë·ªãnh = gi·ªù hi·ªán t·∫°i
        const timesendInput = document.getElementById('modal-f5-add-subtask-timesend');
        if (timesendInput) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          // Format: YYYY-MM-DDTHH:mm
          timesendInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Reset form v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
        const form = document.getElementById('modal-f5-add-subtask-form');
        if (form) {
          form.reset();
          // Set l·∫°i th·ªùi gian g·ª≠i sau khi reset
          const timesendInputAfterReset = document.getElementById('modal-f5-add-subtask-timesend');
          if (timesendInputAfterReset) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            timesendInputAfterReset.value = `${year}-${month}-${day}T${hours}:${minutes}`;
          }
        }
      });
      
      if (!success) {
        console.error('[Form 5] Failed to open modal');
        alert('Kh√¥ng th·ªÉ m·ªü modal. Vui l√≤ng ki·ªÉm tra l·∫°i.');
      }
    }

    // H√†m ƒë√≥ng modal th√™m subtask - S·ª≠ d·ª•ng h·ªá th·ªëng modal t·∫≠p trung
    function closeF5AddSubtaskModal() {
      closeModal('f5-add-subtask');
    }
    
    // H√†m m·ªü modal ch·ªçn ch·∫ø ƒë·ªô khai b√°o (ch·ªâ d√πng cho task parent)
    function openF5SelectDeclarationModal(taskId, subtaskId = null, type = 'parent', subtaskType = null, declarationMode = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      
      // Ki·ªÉm tra subtask d·ª±a tr√™n declarationMode ho·∫∑c t√™n t√°c v·ª•
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) {
          const subtaskName = String(subtask.name || '').trim();
          const declarationMode = String(subtask.declarationMode || '').trim();
          
          // N·∫øu subtask c√≥ declarationMode, m·ªü modal t∆∞∆°ng ·ª©ng
          if (declarationMode) {
            handleF5DeclarationModeSelect(declarationMode, taskId, subtaskId);
            return;
          }
          
          // "Ki·ªÉm tra v√† chu·∫©n b·ªã t√†i li·ªáu" ‚Üí M·ªü "G·ª≠i form b√°o c√°o"
          if (subtaskName === 'Ki·ªÉm tra v√† chu·∫©n b·ªã t√†i li·ªáu') {
            openF5DeclarationSendTestTaskModal(taskId, subtaskId);
            return;
          }
          
          // "Ho√†n thi·ªán b√°o c√°o v√† nghi·ªám thu" ‚Üí M·ªü "Khai b√°o ho√†n th√†nh"
          if (subtaskName === 'Ho√†n thi·ªán b√°o c√°o v√† nghi·ªám thu') {
            openF5DeclarationCompleteModal(taskId, subtaskId);
            return;
          }
          
          // Subtask ƒë∆∞·ª£c t√¨m th·∫•y nh∆∞ng kh√¥ng kh·ªõp ƒëi·ªÅu ki·ªán khai b√°o
          // ƒê√¢y l√† tr∆∞·ªùng h·ª£p kh√¥ng n√™n x·∫£y ra n·∫øu logic render ƒë√∫ng
          console.warn('[Form 5] Subtask found but no declaration function available:', {
            subtaskId,
            subtaskName,
            declarationMode
          });
          return; // Kh√¥ng hi·ªÉn th·ªã th√¥ng b√°o cho user v√¨ n√∫t kh√¥ng n√™n ƒë∆∞·ª£c hi·ªÉn th·ªã
        } else {
          // Kh√¥ng t√¨m th·∫•y subtask - c√≥ th·ªÉ do d·ªØ li·ªáu thay ƒë·ªïi
          console.error('[Form 5] Subtask not found:', subtaskId, 'in task:', taskId);
          showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª• con. Vui l√≤ng t·∫£i l·∫°i trang.', 'error');
          return;
        }
      }
      
      // Ch·ªâ task parent m·ªõi m·ªü modal ch·ªçn ch·∫ø ƒë·ªô
      const taskName = task.taskName || 'T√°c v·ª•';
      
      // S·ª≠ d·ª•ng h·ªá th·ªëng modal t·∫≠p trung
      const success = openModal('f5-select-declaration', (modal, config) => {
        // Hi·ªÉn th·ªã t√™n task
        const taskNameEl = document.getElementById('modal-f5-select-declaration-task-name');
        if (taskNameEl) {
          taskNameEl.textContent = taskName;
        }
        
        // L∆∞u th√¥ng tin v√†o data attributes c·ªßa modal ƒë·ªÉ d√πng sau
        modal.setAttribute('data-task-id', taskId);
        modal.setAttribute('data-type', 'parent');
      });
      
      if (!success) {
        console.error('[Form 5] Failed to open select declaration modal');
      }
    }
    
    // H√†m ƒë√≥ng modal ch·ªçn ch·∫ø ƒë·ªô khai b√°o
    function closeF5SelectDeclarationModal() {
      closeModal('f5-select-declaration');
    }
    
    // H√†m x·ª≠ l√Ω khi ch·ªçn ch·∫ø ƒë·ªô khai b√°o
    function handleF5DeclarationModeSelect(mode, taskId, subtaskId = null) {
      console.log('[Form 5] Declaration mode selected:', mode, 'taskId:', taskId, 'subtaskId:', subtaskId);
      
      // ƒê√≥ng modal ch·ªçn ch·∫ø ƒë·ªô
      closeF5SelectDeclarationModal();
      
      // M·ªü modal khai b√°o t∆∞∆°ng ·ª©ng
      switch(mode) {
        case 'review-file-nctn':
          openF5DeclarationReviewFileNCTNModal(taskId, subtaskId);
          break;
        case 'review-ce-qc':
          openF5DeclarationReviewCEQCModal(taskId, subtaskId);
          break;
        case 'train-qc':
          openF5DeclarationTrainQCModal(taskId, subtaskId);
          break;
        case 'send-test-task':
          openF5DeclarationSendTestTaskModal(taskId, subtaskId);
          break;
        case 'review-4m':
          openF5DeclarationReview4MModal(taskId, subtaskId);
          break;
        case 'review-fmea':
          openF5DeclarationReviewFMEAModal(taskId, subtaskId);
          break;
        default:
          showToast('Ch·∫ø ƒë·ªô khai b√°o kh√¥ng h·ª£p l·ªá', 'error');
      }
    }
    
    // H√†m m·ªü modal: R√† so√°t file v·ªõi NCTN
    function openF5DeclarationReviewFileNCTNModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'T√°c v·ª•';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-review-file-nctn', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-review-file-nctn-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open review-file-nctn modal');
    }
    
    // H√†m m·ªü modal: G·ª≠i r√† so√°t CE v·ªõi QC
    function openF5DeclarationReviewCEQCModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'T√°c v·ª•';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-review-ce-qc', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-review-ce-qc-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open review-ce-qc modal');
    }
    
    // H√†m m·ªü modal: ƒê√†o t·∫°o QC
    function openF5DeclarationTrainQCModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'T√°c v·ª•';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-train-qc', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-train-qc-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open train-qc modal');
    }
    
    // H√†m m·ªü modal: G·ª≠i t√°c v·ª• th·ª≠ nghi·ªám
    function openF5DeclarationSendTestTaskModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'T√°c v·ª•';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-send-test-task', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-send-test-task-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
        
        // Reset form
        const attachmentInput = document.getElementById('modal-f5-declaration-send-test-task-attachment');
        const attachmentNameSpan = document.getElementById('modal-f5-declaration-send-test-task-attachment-name');
        const attachmentRemoveBtn = document.getElementById('modal-f5-declaration-send-test-task-attachment-remove');
        
        if (attachmentInput) attachmentInput.value = '';
        if (attachmentNameSpan) attachmentNameSpan.textContent = 'Ch∆∞a ch·ªçn file';
        if (attachmentRemoveBtn) attachmentRemoveBtn.classList.add('hidden');
      });
      
      if (!success) console.error('[Form 5] Failed to open send-test-task modal');
    }
    
    // H√†m t·∫°o m√£ QA.NB.DDMM-xxxxxx (cho subtask th·ªß c√¥ng)
    function generateQANBCode() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const ddmm = day + month;
      
      // T·∫°o 6 k√Ω t·ª± ng·∫´u nhi√™n (s·ªë v√† ch·ªØ)
      const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let randomPart = '';
      for (let i = 0; i < 6; i++) {
        randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      return `QA.NB.${ddmm}-${randomPart}`;
    }

    // H√†m t·∫°o m√£ QA.NB.DDMM-xxxxxx-NSPM (cho subtask A, B, C t·ª± ƒë·ªông t·ª´ Form 4)
    function generateQANBCodeForForm4() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const ddmm = day + month;
      
      // T·∫°o 6 k√Ω t·ª± ng·∫´u nhi√™n (s·ªë v√† ch·ªØ)
      const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let randomPart = '';
      for (let i = 0; i < 6; i++) {
        randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      return `QA.NB.${ddmm}-${randomPart}-NSPM`;
    }

    // H√†m helper t·∫°o timestamp d·∫°ng YYYY-MM-DD HH:mm
    function getCurrentTimestamp() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
    
    // H√†m x·ª≠ l√Ω submit cho modal send-test-task
    async function handleF5SendTestTaskSubmit(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const modal = document.getElementById('modal-f5-declaration-send-test-task');
      if (!modal) {
        console.error('[Form 5] Modal not found');
        return;
      }
      
      const taskId = modal.getAttribute('data-task-id');
      const subtaskId = modal.getAttribute('data-subtask-id');
      
      if (!taskId || !subtaskId) {
        showToast('Thi·∫øu th√¥ng tin t√°c v·ª• ho·∫∑c t√°c v·ª• con', 'error');
        return;
      }
      
      // L·∫•y d·ªØ li·ªáu t·ª´ form
      const attachmentInput = document.getElementById('modal-f5-declaration-send-test-task-attachment');
      const attachmentFile = attachmentInput?.files?.[0];
      
      // Validate
      if (!attachmentFile) {
        showToast('Vui l√≤ng ch·ªçn file form b√°o c√°o ƒë·ªÉ ƒë√≠nh k√®m', 'error');
        return;
      }
      
      // T√¨m subtask v√† project ƒë·ªÉ l·∫•y th√¥ng tin
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const projectCode = result.project?.projectCode || null;
      const taskRequestCode = result.task.taskCode || '';
      
      // L·∫•y ID th·ª±c c·ªßa subtask t·ª´ database (subtaskId c√≥ d·∫°ng "SUB-xxx", c·∫ßn l·∫•y ph·∫ßn sau)
      const subtaskDbId = subtaskId.replace('SUB-', '');
      
      // T√¨m task ID th·ª±c t·ª´ database ƒë·ªÉ l√†m parent_id
      const taskDbId = taskId.replace('TASK-', '');
      
      // L·∫•y m√£ t√°c v·ª• t·ª´ subtask ƒë√£ c√≥ (ƒë√£ ƒë∆∞·ª£c t·∫°o khi th√™m t√°c v·ª• con)
      // N·∫øu subtask ch∆∞a c√≥ m√£, th√¨ t·∫°o m·ªõi (tr∆∞·ªùng h·ª£p c≈©)
      let qaNbCode = null;
      if (result.task.subtasks) {
        const subtask = result.task.subtasks.find(st => st.id === subtaskId);
        if (subtask && subtask.taskCode) {
          qaNbCode = subtask.taskCode; // S·ª≠ d·ª•ng m√£ ƒë√£ c√≥ t·ª´ khi th√™m t√°c v·ª• con
        }
      }
      // N·∫øu kh√¥ng c√≥ m√£, t·∫°o m·ªõi (tr∆∞·ªùng h·ª£p c≈© - backward compatibility)
      if (!qaNbCode) {
        qaNbCode = generateQANBCode();
      }
      
      // L·∫•y th√¥ng tin subtask hi·ªán t·∫°i ƒë·ªÉ gi·ªØ l·∫°i c√°c tr∆∞·ªùng kh√°c
      let currentSubtask = null;
      if (result.task.subtasks) {
        currentSubtask = result.task.subtasks.find(st => st.id === subtaskId);
      }
      
      // Chu·∫©n b·ªã d·ªØ li·ªáu subtask ƒë√£ ch·ªânh s·ª≠a
      const subtaskData = {
        name: currentSubtask?.name || '',
        pic: currentSubtask?.pic || '',
        manhour: currentSubtask?.manhour || null,
        dueDate: null,
        status: currentSubtask?.status || 'Ch∆∞a tri·ªÉn khai', // Gi·ªØ nguy√™n tr·∫°ng th√°i hi·ªán t·∫°i
        timesend: currentSubtask?.timesend || null,
        finishTime: null,
        note: currentSubtask?.note || '',
        checklist: currentSubtask?.checklist || '',
        subtaskNo: currentSubtask?.subtaskNo || null,
        declarationMode: 'send-test-task',
        taskCode: qaNbCode,
        itemCode: currentSubtask?.itemCode || ''
      };
      
      // Format theo NocoDB ƒë·ªÉ g·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t subtask
      // parentTaskId ·ªü ƒë√¢y l√† ID c·ªßa task cha trong database
      const formattedData = formatSubtaskToNocoDB(subtaskData, taskDbId, projectCode);
      
      // Th√™m ID c·ªßa subtask ƒë·ªÉ c·∫≠p nh·∫≠t (kh√¥ng ph·∫£i t·∫°o m·ªõi)
      formattedData.Id = subtaskDbId;
      
      // Th√™m TaskRequestCode ƒë·ªÉ webhook bi·∫øt task cha
      formattedData.TaskRequestCode = taskRequestCode;
      
      // Th√™m m√£ QA.NB v√†o d·ªØ li·ªáu g·ª≠i l√™n (c√≥ th·ªÉ l∆∞u v√†o TaskCode ho·∫∑c m·ªôt tr∆∞·ªùng ri√™ng)
      formattedData.TaskCode = qaNbCode;
      
      // Th√™m d·ªØ li·ªáu task ch√≠nh (parent task) v√†o payload
      const taskData = {
        Id: taskDbId,
        TaskRequestCode: taskRequestCode,
        TaskCode: result.task.taskCode || '',
        TaskName: result.task.taskName || '',
        TaskItemName: result.task.taskName || '',
        TaskItemCode: result.task.form4Data?.itemCode || '',
        TaskRequesterName: result.task.requesterName || '',
        TaskRequesterEmail: result.task.requesterEmail || '',
        TaskRequestDate: result.task.createdAt || '',
        TaskDeptRequest: result.task.department || '',
        TaskPurpose: result.task.form4Data?.purpose || '',
        TaskPIC: result.task.pic || '',
        TaskStatus: result.task.status || 'pending',
        TaskPriority: result.task.priority || 'Trung b√¨nh',
        TaskDueDate: result.task.dueDate || null,
        TaskDescription: result.task.description || '',
        TaskAttachments: result.task.form4Data?.attachments || '', // File ƒë√≠nh k√®m t·ª´ task
        project_code: projectCode || null,
        TaskForm4Data: result.task.form4Data ? JSON.stringify(result.task.form4Data) : null
      };
      
      // Th√™m taskData v√†o payload
      formattedData.taskData = taskData;
      
      // Th√™m timestamp d·∫°ng YYYY-MM-DD HH:mm
      formattedData.timestamp = getCurrentTimestamp();
      
      // Hi·ªÉn th·ªã loading
      const submitBtn = document.getElementById('modal-f5-declaration-send-test-task-submit');
      const originalText = submitBtn?.textContent;
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang g·ª≠i y√™u c·∫ßu...';
      }
      
      try {
        // G·ª≠i l√™n webhook ƒë·ªÉ submit declaration
        const endpoint = 'https://iatzhxxuk.tino.page/webhook/form5-declaration-submit';
        
        // T·∫°o FormData ƒë·ªÉ g·ª≠i file ƒë√≠nh k√®m
        const formData = new FormData();
        formData.append('data', JSON.stringify(formattedData));
        if (attachmentFile) {
          formData.append('attachment', attachmentFile);
        }
        
        // G·ª≠i FormData v·ªõi file ƒë√≠nh k√®m
        console.log('[Form 5] Sending declaration with attachment');
        const response = await fetch(endpoint, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseData = await response.json();
        console.log('[Form 5] Subtask updated:', responseData);
        
        // Hi·ªÉn th·ªã m√£ ƒë√£ t·∫°o trong toast
        showToast(`ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng. M√£ t√°c v·ª•: ${qaNbCode}`, 'success', 5000);
        
        // ƒê√≥ng modal
        closeModal('f5-declaration-send-test-task');
        
        // Reload d·ªØ li·ªáu t·ª´ server ƒë·ªÉ hi·ªÉn th·ªã c·∫≠p nh·∫≠t
        try {
          const taskIdToExpand = taskId;
          F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);
          
          const resultAfterReload = findF5Task(taskIdToExpand);
          if (resultAfterReload && resultAfterReload.task) {
            resultAfterReload.task.expanded = true;
            if (resultAfterReload.project) {
              resultAfterReload.project.expanded = true;
            }
          }
          
          renderF5TasksTable();
        } catch (reloadError) {
          console.error('[Form 5] Failed to reload data:', reloadError);
          showToast('ƒê√£ g·ª≠i y√™u c·∫ßu nh∆∞ng kh√¥ng th·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu. Vui l√≤ng l√†m m·ªõi trang.', 'warning');
          renderF5TasksTable();
        }
        
      } catch (error) {
        console.error('[Form 5] Failed to submit subtask update:', error);
        showToast('G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      } finally {
        // Restore button
        if (submitBtn) {
          submitBtn.disabled = false;
          if (originalText) submitBtn.textContent = originalText;
        }
      }
    }
    
    // H√†m m·ªü modal: R√† so√°t 4M
    function openF5DeclarationReview4MModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'T√°c v·ª•';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-review-4m', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-review-4m-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open review-4m modal');
    }
    
    // H√†m m·ªü modal: R√† so√°t FMEA
    function openF5DeclarationReviewFMEAModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'T√°c v·ª•';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-review-fmea', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-review-fmea-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
      });
      
      if (!success) console.error('[Form 5] Failed to open review-fmea modal');
    }
    
    // H√†m m·ªü modal Khai b√°o ho√†n th√†nh
    function openF5DeclarationCompleteModal(taskId, subtaskId = null) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      let taskName = task.taskName || 'T√°c v·ª•';
      if (subtaskId && task.subtasks) {
        const subtask = task.subtasks.find(st => st.id === subtaskId);
        if (subtask) taskName = subtask.name || taskName;
      }
      
      const success = openModal('f5-declaration-complete', (modal, config) => {
        const taskNameEl = document.getElementById('modal-f5-declaration-complete-task-name');
        if (taskNameEl) taskNameEl.textContent = taskName;
        modal.setAttribute('data-task-id', taskId);
        if (subtaskId) modal.setAttribute('data-subtask-id', subtaskId);
        
        // Set th√¥ng tin ng∆∞·ªùi n·ªôp, m√£, t√°c v·ª•
        const uploaderNameEl = document.getElementById('modal-f5-declaration-complete-uploader-name');
        const uploaderCodeEl = document.getElementById('modal-f5-declaration-complete-uploader-code');
        const uploaderTaskEl = document.getElementById('modal-f5-declaration-complete-uploader-task');
        const subtask = task.subtasks?.find(st => st.id === subtaskId);
        if (uploaderNameEl) uploaderNameEl.textContent = subtask?.pic || task.pic || '';
        if (uploaderCodeEl) uploaderCodeEl.textContent = subtask?.taskCode || task.taskCode || '';
        if (uploaderTaskEl) uploaderTaskEl.textContent = subtask?.name || task.taskName || '';
        
        // Ki·ªÉm tra n·∫øu subtask ƒë√£ done ho·∫∑c "C·∫ßn update" th√¨ hi·ªÉn th·ªã Gate 3
        const normalizedSubtaskStatus = String(subtask?.status || '').toLowerCase().trim();
        const isDone = normalizedSubtaskStatus === 'done' || normalizedSubtaskStatus === 'completed' || normalizedSubtaskStatus === 'ho√†n th√†nh' || normalizedSubtaskStatus === 'ƒë√£ ho√†n th√†nh' || normalizedSubtaskStatus === 'c·∫ßn update' || normalizedSubtaskStatus === 'can update';
        
        // Reset form - Gate 1
        const pdfInput = document.getElementById('modal-f5-declaration-complete-file-pdfzip');
        const xlsxInput = document.getElementById('modal-f5-declaration-complete-file-xlsxzip');
        if (pdfInput) pdfInput.value = '';
        if (xlsxInput) xlsxInput.value = '';
        
        // Reset radio buttons
        document.querySelectorAll('input[name="modal-f5-declaration-complete-classification"]').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="modal-f5-declaration-complete-conclusion"]').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="modal-f5-declaration-complete-durability-choice"]').forEach(el => el.checked = false);
        
        // Reset Gate 2
        const archiveG2 = document.getElementById('modal-f5-declaration-complete-file-archive-g2');
        if (archiveG2) archiveG2.value = '';
        document.querySelectorAll('input[name="modal-f5-declaration-complete-classification-g2"]').forEach(el => el.checked = false);
        
        // Reset Gate 3
        const pdfInputG3 = document.getElementById('modal-f5-declaration-complete-file-pdfzip-g3');
        const xlsxInputG3 = document.getElementById('modal-f5-declaration-complete-file-xlsxzip-g3');
        const gate3Content = document.getElementById('modal-f5-declaration-complete-gate3-content');
        if (pdfInputG3) pdfInputG3.value = '';
        if (xlsxInputG3) xlsxInputG3.value = '';
        if (gate3Content) gate3Content.value = '';
        document.querySelectorAll('input[name="modal-f5-declaration-complete-conclusion-g3"]').forEach(el => el.checked = false);
        
        // Reset BPS checkbox
        const bpsCheckbox = document.getElementById('modal-f5-declaration-complete-upload-bps');
        if (bpsCheckbox) bpsCheckbox.checked = true;
        
        // Reset durability date
        const durDateWrap = document.getElementById('modal-f5-declaration-complete-durability-date-wrap');
        const durDate = document.getElementById('modal-f5-declaration-complete-durability-date');
        if (durDateWrap) durDateWrap.style.display = 'none';
        if (durDate) durDate.value = '';
        
        // Hi·ªÉn th·ªã Gate ph√π h·ª£p: n·∫øu done th√¨ hi·ªÉn th·ªã Gate 3, ng∆∞·ª£c l·∫°i hi·ªÉn th·ªã Gate 1
        const gate1Title = document.getElementById('modal-f5-declaration-complete-gate1-title');
        const gate2Div = document.getElementById('modal-f5-declaration-complete-gate2');
        const gate3Div = document.getElementById('modal-f5-declaration-complete-gate3');
        const uploadForm1Split = document.getElementById('modal-f5-declaration-complete-upload-form1-split');
        const classificationGroup = document.getElementById('modal-f5-declaration-complete-classification-group');
        const conclusionGroup = document.getElementById('modal-f5-declaration-complete-conclusion-group');
        const durabilityGroup = document.getElementById('modal-f5-declaration-complete-durability-group');
        const bpsOption = document.getElementById('modal-f5-declaration-complete-bps-option');
        
        // Tab Gate 3
        const tabGate3 = document.getElementById('modal-f5-declaration-complete-tab-gate3');
        
        if (isDone) {
          // T√°c v·ª• ƒë√£ done: hi·ªÉn th·ªã Gate 3
          if (tabGate3) {
            tabGate3.style.display = '';
            tabGate3.classList.add('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate3.classList.remove('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (gate1Title) gate1Title.style.display = 'none';
          if (gate2Div) gate2Div.style.display = 'none';
          if (gate3Div) gate3Div.style.display = '';
          if (uploadForm1Split) uploadForm1Split.style.display = 'none';
          if (classificationGroup) classificationGroup.style.display = 'none';
          if (conclusionGroup) conclusionGroup.style.display = 'none';
          if (durabilityGroup) durabilityGroup.style.display = 'none';
          if (bpsOption) bpsOption.style.display = 'none';
        } else {
          // T√°c v·ª• ch∆∞a done: hi·ªÉn th·ªã Gate 1
          if (tabGate3) tabGate3.style.display = 'none';
          if (gate1Title) gate1Title.style.display = '';
          if (gate2Div) gate2Div.style.display = 'none';
          if (gate3Div) gate3Div.style.display = 'none';
          if (uploadForm1Split) uploadForm1Split.style.display = '';
          if (classificationGroup) classificationGroup.style.display = '';
          if (conclusionGroup) conclusionGroup.style.display = '';
          if (durabilityGroup) durabilityGroup.style.display = '';
          if (bpsOption) bpsOption.style.display = '';
        }
        
        // Enable submit button
        const submitBtn = document.getElementById('modal-f5-declaration-complete-submit');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.style.pointerEvents = 'auto';
          submitBtn.style.opacity = '1';
          submitBtn.textContent = isDone ? 'G·ª≠i c·∫≠p nh·∫≠t' : 'G·ª≠i';
        }
        
        // K√≠ch ho·∫°t tab Gate 1 ho·∫∑c Gate 3
        const tabGate1 = document.getElementById('modal-f5-declaration-complete-tab-gate1');
        const tabGate2 = document.getElementById('modal-f5-declaration-complete-tab-gate2');
        if (isDone) {
          // Gate 3 active
          if (tabGate1) {
            tabGate1.classList.remove('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate1.classList.add('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (tabGate2) {
            tabGate2.classList.remove('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate2.classList.add('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
        } else {
          // Gate 1 active
          if (tabGate1) {
            tabGate1.classList.add('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate1.classList.remove('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (tabGate2) {
            tabGate2.classList.remove('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate2.classList.add('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
        }
        
        // ƒê·∫£m b·∫£o event listener ƒë∆∞·ª£c g·∫Øn
        setTimeout(() => {
          const completeSubmitBtn = document.getElementById('modal-f5-declaration-complete-submit');
          if (completeSubmitBtn) {
            // G·ª° listener c≈© n·∫øu c√≥
            completeSubmitBtn.removeEventListener('click', handleF5CompleteSubmit);
            // G·∫Øn listener m·ªõi
            completeSubmitBtn.addEventListener('click', handleF5CompleteSubmit);
            console.log('[Form 5] Submit button listener attached in modal open');
          }
        }, 100);
      });
      
      if (!success) console.error('[Form 5] Failed to open complete modal');
    }
    
    // H√†m x·ª≠ l√Ω submit cho modal Khai b√°o ho√†n th√†nh
    async function handleF5CompleteSubmit(e) {
      console.log('[Form 5] Submit button clicked', e);
      e.preventDefault();
      e.stopPropagation();
      
      const modal = document.getElementById('modal-f5-declaration-complete');
      if (!modal) {
        console.error('[Form 5] Modal not found');
        return;
      }
      
      const taskId = modal.getAttribute('data-task-id');
      const subtaskId = modal.getAttribute('data-subtask-id');
      
      if (!taskId || !subtaskId) {
        showToast('Thi·∫øu th√¥ng tin t√°c v·ª• ho·∫∑c t√°c v·ª• con', 'error');
        return;
      }
      
      // T√¨m subtask v√† project ƒë·ªÉ l·∫•y th√¥ng tin (c·∫ßn thi·∫øt cho validation t√™n file)
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      // X√°c ƒë·ªãnh Gate ƒëang active
      const gate2Div = document.getElementById('modal-f5-declaration-complete-gate2');
      const gate3Div = document.getElementById('modal-f5-declaration-complete-gate3');
      const isGate2 = gate2Div && gate2Div.style.display !== 'none';
      const isGate3 = gate3Div && gate3Div.style.display !== 'none';
      
      // L·∫•y file upload
      let fPdf = null;
      let fXlsx = null;
      let fArchive = null;
      let fPdfG3 = null;
      let fXlsxG3 = null;
      let gate3Content = '';
      
      if (isGate3) {
        // Gate 3: C·∫≠p nh·∫≠t b√°o c√°o (PDF/Excel t√πy ch·ªçn, n·ªôi dung c·∫≠p nh·∫≠t b·∫Øt bu·ªôc)
        const pdfInputG3 = document.getElementById('modal-f5-declaration-complete-file-pdfzip-g3');
        const xlsxInputG3 = document.getElementById('modal-f5-declaration-complete-file-xlsxzip-g3');
        const contentInput = document.getElementById('modal-f5-declaration-complete-gate3-content');
        
        // Validate n·ªôi dung c·∫≠p nh·∫≠t (b·∫Øt bu·ªôc)
        if (!contentInput || !contentInput.value || !contentInput.value.trim()) {
          showToast('Vui l√≤ng nh·∫≠p n·ªôi dung c·∫≠p nh·∫≠t', 'error');
          return;
        }
        gate3Content = contentInput.value.trim();
        
        // L·∫•y file PDF n·∫øu c√≥ (t√πy ch·ªçn)
        if (pdfInputG3 && pdfInputG3.files && pdfInputG3.files.length > 0) {
          fPdfG3 = pdfInputG3.files[0];
          const extPdf = String(fPdfG3.name || '').toLowerCase().match(/\.([a-z0-9]+)$/)?.[1];
          if (extPdf !== 'pdf') {
            showToast('File PDF kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (.pdf)', 'error');
            return;
          }
        }
        
        // L·∫•y file Excel n·∫øu c√≥ (t√πy ch·ªçn)
        if (xlsxInputG3 && xlsxInputG3.files && xlsxInputG3.files.length > 0) {
          fXlsxG3 = xlsxInputG3.files[0];
          const extX = String(fXlsxG3.name || '').toLowerCase().match(/\.([a-z0-9]+)$/)?.[1];
          if (extX !== 'xlsx') {
            showToast('File Excel kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (.xlsx)', 'error');
            return;
          }
          // Ki·ªÉm tra t√™n file ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng QA.R.xx-xxxxxx cho t√°c v·ª• C
          const subtask = result.task.subtasks?.find(st => st.id === subtaskId);
          const subtaskName = String(subtask?.name || '').trim();
          if (subtaskName === 'Ho√†n thi·ªán b√°o c√°o v√† nghi·ªám thu') {
            const fileNameWithoutExt = fXlsxG3.name.replace(/\.xlsx$/i, '');
            const fileNamePattern = /^QA\.R\.\d{2}-\d{6}$/i;
            if (!fileNamePattern.test(fileNameWithoutExt)){
              showToast('T√™n file Excel ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng: QA.R.xx-xxxxxx (v√≠ d·ª•: QA.R.25-023028)','error');
              return;
            }
          }
        }
      } else if (isGate2) {
        // Gate 2: ch·ªâ file n√©n
        const archiveInput = document.getElementById('modal-f5-declaration-complete-file-archive-g2');
        if (!archiveInput || !archiveInput.files || archiveInput.files.length === 0) {
          showToast('Vui l√≤ng ch·ªçn t·ªáp n√©n (.zip/.rar/.7z)', 'error');
          return;
        }
        fArchive = archiveInput.files[0];
        const ext = String(fArchive.name || '').toLowerCase().match(/\.([a-z0-9]+)$/)?.[1];
        if (!['zip', 'rar', '7z'].includes(ext)) {
          showToast('Ch·ªâ nh·∫≠n t·ªáp n√©n .zip/.rar/.7z cho Gate 2', 'error');
          return;
        }
      } else {
        // Gate 1: PDF v√† Excel
        const pdfInput = document.getElementById('modal-f5-declaration-complete-file-pdfzip');
        const xlsxInput = document.getElementById('modal-f5-declaration-complete-file-xlsxzip');
        
        // Validate file PDF (b·∫Øt bu·ªôc)
        if (!pdfInput || !pdfInput.files || pdfInput.files.length === 0) {
          showToast('Vui l√≤ng ch·ªçn file PDF', 'error');
          return;
        }
        fPdf = pdfInput.files[0];
        const extPdf = String(fPdf.name || '').toLowerCase().match(/\.([a-z0-9]+)$/)?.[1];
        if (extPdf !== 'pdf') {
          showToast('File PDF kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (.pdf)', 'error');
          return;
        }
        
        // Validate file Excel (b·∫Øt bu·ªôc)
        if (!xlsxInput || !xlsxInput.files || xlsxInput.files.length === 0) {
          showToast('Vui l√≤ng ch·ªçn file Excel (.xlsx)', 'error');
          return;
        }
        fXlsx = xlsxInput.files[0];
        const extX = String(fXlsx.name || '').toLowerCase().match(/\.([a-z0-9]+)$/)?.[1];
        if (extX !== 'xlsx') {
          showToast('File Excel kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (.xlsx)', 'error');
          return;
        }
        // Ki·ªÉm tra t√™n file ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng QA.R.xx-xxxxxx cho t√°c v·ª• C
        const subtask = result.task.subtasks?.find(st => st.id === subtaskId);
        const subtaskName = String(subtask?.name || '').trim();
        if (subtaskName === 'Ho√†n thi·ªán b√°o c√°o v√† nghi·ªám thu') {
          const fileNameWithoutExt = fXlsx.name.replace(/\.xlsx$/i, '');
          const fileNamePattern = /^QA\.R\.\d{2}-\d{6}$/i;
          if (!fileNamePattern.test(fileNameWithoutExt)){
            showToast('T√™n file Excel ph·∫£i ƒë√∫ng ƒë·ªãnh d·∫°ng: QA.R.xx-xxxxxx (v√≠ d·ª•: QA.R.25-023028)','error');
            return;
          }
        }
      }
      
      // L·∫•y c√°c gi√° tr·ªã t·ª´ form
      const classification = document.querySelector('input[name="modal-f5-declaration-complete-classification"]:checked')?.value || 
                            document.querySelector('input[name="modal-f5-declaration-complete-classification-g2"]:checked')?.value || '';
      const conclusion = document.querySelector('input[name="modal-f5-declaration-complete-conclusion"]:checked')?.value || '';
      const durabilityChoice = document.querySelector('input[name="modal-f5-declaration-complete-durability-choice"]:checked')?.value || '';
      const durabilityDate = document.getElementById('modal-f5-declaration-complete-durability-date')?.value || '';
      const bpsCheckbox = document.getElementById('modal-f5-declaration-complete-upload-bps');
      const bpsChecked = bpsCheckbox ? bpsCheckbox.checked : false;
      
      // L·∫•y c√°c gi√° tr·ªã kh√°c (n·∫øu c√≥)
      const subtaskNote = ''; // Modal m·ªõi kh√¥ng c√≥ tr∆∞·ªùng note ri√™ng
      const subtaskResultLink = ''; // Modal m·ªõi kh√¥ng c√≥ tr∆∞·ªùng resultLink ri√™ng
      const subtaskStatus = 'done'; // Khai b√°o ho√†n th√†nh = done
      
      // result ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü tr√™n
      
      const projectCode = result.project?.projectCode || null;
      const taskRequestCode = result.task.taskCode || '';
      
      // L·∫•y ID th·ª±c c·ªßa subtask t·ª´ database
      const subtaskDbId = subtaskId.replace('SUB-', '');
      
      // T√¨m task ID th·ª±c t·ª´ database ƒë·ªÉ l√†m parent_id
      const taskDbId = taskId.replace('TASK-', '');
      
      // L·∫•y m√£ t√°c v·ª• t·ª´ subtask ƒë√£ c√≥
      let qaNbCode = null;
      if (result.task.subtasks) {
        const subtask = result.task.subtasks.find(st => st.id === subtaskId);
        if (subtask && subtask.taskCode) {
          qaNbCode = subtask.taskCode;
        }
      }
      // N·∫øu kh√¥ng c√≥ m√£, t·∫°o m·ªõi
      if (!qaNbCode) {
        qaNbCode = generateQANBCode();
      }
      
      // L·∫•y th√¥ng tin subtask hi·ªán t·∫°i ƒë·ªÉ gi·ªØ l·∫°i c√°c tr∆∞·ªùng kh√°c
      let currentSubtask = null;
      if (result.task.subtasks) {
        currentSubtask = result.task.subtasks.find(st => st.id === subtaskId);
      }
      
      // Chu·∫©n b·ªã d·ªØ li·ªáu subtask ƒë√£ ch·ªânh s·ª≠a
      const subtaskData = {
        name: currentSubtask?.name || '',
        pic: currentSubtask?.pic || '',
        manhour: currentSubtask?.manhour || null,
        dueDate: null,
        status: subtaskStatus, // Tr·∫°ng th√°i t·ª´ form
        timesend: currentSubtask?.timesend || null,
        finishTime: null,
        note: subtaskNote || currentSubtask?.note || '', // Ghi ch√∫ t·ª´ form ho·∫∑c gi·ªØ nguy√™n
        checklist: currentSubtask?.checklist || '',
        subtaskNo: currentSubtask?.subtaskNo || null,
        declarationMode: 'complete',
        taskCode: qaNbCode,
        itemCode: currentSubtask?.itemCode || '',
        resultLink: subtaskResultLink || '' // Link k·∫øt qu·∫£
      };
      
      // Format theo NocoDB ƒë·ªÉ g·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t subtask
      const formattedData = formatSubtaskToNocoDB(subtaskData, taskDbId, projectCode);
      
      // Th√™m ID c·ªßa subtask ƒë·ªÉ c·∫≠p nh·∫≠t
      formattedData.Id = subtaskDbId;
      
      // Th√™m TaskRequestCode ƒë·ªÉ webhook bi·∫øt task cha
      formattedData.TaskRequestCode = taskRequestCode;
      
      // Th√™m m√£ QA.NB v√†o d·ªØ li·ªáu g·ª≠i l√™n
      formattedData.TaskCode = qaNbCode;
      
      // Th√™m d·ªØ li·ªáu task ch√≠nh (parent task) v√†o payload
      const taskData = {
        Id: taskDbId,
        TaskRequestCode: taskRequestCode,
        TaskCode: result.task.taskCode || '',
        TaskName: result.task.taskName || '',
        TaskItemName: result.task.taskName || '',
        TaskItemCode: result.task.form4Data?.itemCode || '',
        TaskRequesterName: result.task.requesterName || '',
        TaskRequesterEmail: result.task.requesterEmail || '',
        TaskRequestDate: result.task.createdAt || '',
        TaskDeptRequest: result.task.department || '',
        TaskPurpose: result.task.form4Data?.purpose || '',
        TaskPIC: result.task.pic || '',
        TaskStatus: result.task.status || 'pending',
        TaskPriority: result.task.priority || 'Trung b√¨nh',
        TaskDueDate: result.task.dueDate || null,
        TaskDescription: result.task.description || '',
        TaskAttachments: result.task.form4Data?.attachments || '',
        project_code: projectCode || null,
        TaskForm4Data: result.task.form4Data ? JSON.stringify(result.task.form4Data) : null
      };
      
      // Th√™m taskData v√†o payload
      formattedData.taskData = taskData;
      
      // Th√™m timestamp d·∫°ng YYYY-MM-DD HH:mm
      formattedData.timestamp = getCurrentTimestamp();
      
      // Hi·ªÉn th·ªã loading
      const submitBtn = document.getElementById('modal-f5-declaration-complete-submit');
      const originalText = submitBtn?.textContent;
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang g·ª≠i y√™u c·∫ßu...';
      }
      
      try {
        // X·ª≠ l√Ω Gate 3: C·∫≠p nh·∫≠t b√°o c√°o
        if (isGate3) {
          // T·∫°o FormData ƒë·ªÉ g·ª≠i file
          const fd = new FormData();
          
          // Append files n·∫øu c√≥
          if (fPdfG3) {
            fd.append('file_pdfzip', fPdfG3);
            fd.append('file_name', fPdfG3.name || '');
          }
          if (fXlsxG3) {
            fd.append('file_xlsxzip', fXlsxG3);
            fd.append('file_name_xlsx', fXlsxG3.name || '');
          }
          
          fd.append('noi_dung_cap_nhat', gate3Content);
          fd.append('upload_type', fXlsxG3 ? (fPdfG3 ? 'pdf_xlsx' : 'xlsx_only') : (fPdfG3 ? 'pdf_only' : 'text_only'));
          
          // Timestamp
          const formatDdMmYyyyHHmm = (date) => {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
          };
          fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
          
          // Th√¥ng tin ng∆∞·ªùi n·ªôp v√† t√°c v·ª•
          const subtask = result.task.subtasks?.find(st => st.id === subtaskId);
          fd.append('nguoi_nop', subtask?.pic || result.task.pic || '');
          fd.append('ma_tac_vu', qaNbCode || taskRequestCode);
          fd.append('ten_tac_vu', subtask?.name || result.task.taskName || '');
          fd.append('form', 'Form 5');
          fd.append('system', '0');
          
          // Th√™m ID subtask n·∫øu c√≥
          if (subtaskDbId) {
            fd.append('id', String(subtaskDbId));
          }
          
          // Th√™m id_body t·ª´ subtask (n·∫øu c√≥)
          if (currentSubtask && currentSubtask.idBody) {
            fd.append('id_body', String(currentSubtask.idBody));
          }
          
          // Append Gate 3 conclusion n·∫øu c√≥
          const conclusionG3 = document.querySelector('input[name="modal-f5-declaration-complete-conclusion-g3"]:checked')?.value || '';
          if (conclusionG3) {
            fd.append('ket_luan', conclusionG3);
          }
          
          // Meta JSON
          const meta = {
            action: 'form1_upload',
            gate: 'Gate 3',
            person_name: subtask?.pic || result.task.pic || '',
            taskId: qaNbCode || taskRequestCode,
            code: qaNbCode || taskRequestCode,
            taskName: subtask?.name || result.task.taskName || '',
            noi_dung_cap_nhat: gate3Content,
            ket_luan: conclusionG3 || '',
            upload_type: fXlsxG3 ? (fPdfG3 ? 'pdf_xlsx' : 'xlsx_only') : (fPdfG3 ? 'pdf_only' : 'text_only'),
            is_bps: '0',
            system: '0',
            timestamp_iso: new Date().toISOString()
          };
          fd.append('meta_json', JSON.stringify(meta));
          fd.append('body', JSON.stringify(meta));
          fd.append('action', 'form1_upload');
          fd.append('gate', 'Gate 3');
          
          // G·ª≠i ƒë·∫øn webhook
          const UPLOAD_URL = 'https://iatzhxxuk.tino.page/webhook/f5TrabaocaoSPMDQA';
          
          console.log('[Form 5] Sending Gate 3 update to webhook f5TrabaocaoSPMDQA');
          
          await fetch(UPLOAD_URL, {
            method: 'POST',
            body: fd,
            mode: 'no-cors'
          });
          
          console.log('[Form 5] Gate 3 update sent successfully');
          
          showToast('ƒê√£ g·ª≠i c·∫≠p nh·∫≠t b√°o c√°o Gate 3 th√†nh c√¥ng.', 'success', 5000);
          
          // ƒê√≥ng modal
          closeModal('f5-declaration-complete');
          
          // Reload d·ªØ li·ªáu t·ª´ server ƒë·ªÉ hi·ªÉn th·ªã c·∫≠p nh·∫≠t
          try {
            const taskIdToExpand = taskId;
            F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);
            
            const resultAfterReload = findF5Task(taskIdToExpand);
            if (resultAfterReload && resultAfterReload.task) {
              resultAfterReload.task.expanded = true;
              if (resultAfterReload.project) {
                resultAfterReload.project.expanded = true;
              }
            }
            
            renderF5TasksTable();
          } catch (reloadError) {
            console.error('[Form 5] Failed to reload data:', reloadError);
            showToast('ƒê√£ g·ª≠i c·∫≠p nh·∫≠t nh∆∞ng kh√¥ng th·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu. Vui l√≤ng l√†m m·ªõi trang.', 'warning');
            renderF5TasksTable();
          }
          
          return; // K·∫øt th√∫c h√†m sau khi x·ª≠ l√Ω Gate 3
        }
        
        // T·∫°o FormData ƒë·ªÉ g·ª≠i file (gi·ªëng Form 1)
        const fd = new FormData();
        
        // Append files theo Gate
        if (isGate2) {
          // Gate 2: ch·ªâ file n√©n
          fd.append('file_archive', fArchive);
          fd.append('file_name', fArchive.name || '');
          fd.append('upload_type', 'archive_only');
        } else {
          // Gate 1: PDF v√† Excel
          fd.append('file_pdfzip', fPdf);
          fd.append('file_name', fPdf.name || '');
          fd.append('file_xlsxzip', fXlsx);
          fd.append('file_name_xlsx', fXlsx.name || '');
          fd.append('upload_type', 'pdf_xlsx');
        }
        
        // Timestamp
        const formatDdMmYyyyHHmm = (date) => {
          const d = new Date(date);
          const day = String(d.getDate()).padStart(2, '0');
          const month = String(d.getMonth() + 1).padStart(2, '0');
          const year = d.getFullYear();
          const hours = String(d.getHours()).padStart(2, '0');
          const minutes = String(d.getMinutes()).padStart(2, '0');
          return `${day}/${month}/${year} ${hours}:${minutes}`;
        };
        fd.append('timestamp', formatDdMmYyyyHHmm(new Date()));
        
        // Th√¥ng tin ng∆∞·ªùi n·ªôp v√† t√°c v·ª•
        const subtask = result.task.subtasks?.find(st => st.id === subtaskId);
        fd.append('nguoi_nop', subtask?.pic || result.task.pic || '');
        fd.append('ma_tac_vu', qaNbCode || taskRequestCode);
        fd.append('ten_tac_vu', subtask?.name || result.task.taskName || '');
        fd.append('form', 'Form 5');
        fd.append('system', '0'); // System kh√°c 1
        
        // Th√™m c√°c tr∆∞·ªùng t·ª´ form
        if (classification) {
          fd.append('phan_loai', classification);
        }
        if (conclusion) {
          fd.append('ket_luan', conclusion);
        }
        if (durabilityChoice) {
          fd.append('test_ben', durabilityChoice === 'co' ? 'C√≥ test b·ªÅn' : 'Kh√¥ng test b·ªÅn');
          if (durabilityChoice === 'co' && durabilityDate) {
            fd.append('ngay_du_kien_tra_test_ben', durabilityDate);
          }
        }
        if (bpsCheckbox) {
          fd.append('is_bps', bpsChecked ? '1' : '0');
        }
        
        // Th√™m ID subtask n·∫øu c√≥
        if (subtaskDbId) {
          fd.append('id', String(subtaskDbId));
        }
        
        // Th√™m id_body t·ª´ subtask (n·∫øu c√≥)
        if (currentSubtask && currentSubtask.idBody) {
          fd.append('id_body', String(currentSubtask.idBody));
        }
        
        // Meta JSON (gi·ªëng Form 1)
        const activeGate = isGate2 ? 'Gate 2' : 'Gate 1';
        const uploadType = isGate2 ? 'archive_only' : 'pdf_xlsx';
        const meta = {
          action: 'form1_upload',
          gate: activeGate,
          person_name: subtask?.pic || result.task.pic || '',
          taskId: qaNbCode || taskRequestCode,
          code: qaNbCode || taskRequestCode,
          taskName: subtask?.name || result.task.taskName || '',
          ket_luan: isGate2 ? 'B√°o c√°o m√°y Base, r√† so√°t tem nh√£n' : (conclusion || ''),
          phan_loai: classification || '',
          test_ben: durabilityChoice === 'co' ? 'C√≥ test b·ªÅn' : (durabilityChoice === 'khong' ? 'Kh√¥ng test b·ªÅn' : ''),
          ngay_du_kien_tra_test_ben: durabilityDate || '',
          is_bps: bpsChecked ? '1' : '0',
          system: '0',
          upload_type: uploadType,
          timestamp_iso: new Date().toISOString(),
          id_body: currentSubtask?.idBody || null // Th√™m id_body v√†o metadata
        };
        fd.append('meta_json', JSON.stringify(meta));
        fd.append('body', JSON.stringify(meta));
        fd.append('action', 'form1_upload');
        fd.append('gate', activeGate);
        
        // G·ª≠i ƒë·∫øn webhook upload file b√°o c√°o (ch·ªâ 1 webhook duy nh·∫•t cho t√°c v·ª• C)
        const UPLOAD_URL = 'https://iatzhxxuk.tino.page/webhook/f5TrabaocaoSPMDQA';
        
        console.log('[Form 5] Sending complete declaration to webhook f5TrabaocaoSPMDQA');
        
        // G·ª≠i file b√°o c√°o ƒë·∫øn webhook
        const uploadResponse = await fetch(UPLOAD_URL, {
          method: 'POST',
          body: fd,
          mode: 'no-cors'
        });
        
        // V√¨ mode: 'no-cors', kh√¥ng th·ªÉ ki·ªÉm tra uploadResponse.ok
        console.log('[Form 5] File upload sent to webhook f5TrabaocaoSPMDQA');
        
        // Hi·ªÉn th·ªã m√£ ƒë√£ t·∫°o trong toast
        showToast(`ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng. M√£ t√°c v·ª•: ${qaNbCode}`, 'success', 5000);
        
        // ƒê√≥ng modal
        closeModal('f5-declaration-complete');
        
        // Reload d·ªØ li·ªáu t·ª´ server ƒë·ªÉ hi·ªÉn th·ªã c·∫≠p nh·∫≠t
        try {
          const taskIdToExpand = taskId;
          F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);
          
          const resultAfterReload = findF5Task(taskIdToExpand);
          if (resultAfterReload && resultAfterReload.task) {
            resultAfterReload.task.expanded = true;
            if (resultAfterReload.project) {
              resultAfterReload.project.expanded = true;
            }
          }
          
          renderF5TasksTable();
        } catch (reloadError) {
          console.error('[Form 5] Failed to reload data:', reloadError);
          showToast('ƒê√£ g·ª≠i y√™u c·∫ßu nh∆∞ng kh√¥ng th·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu. Vui l√≤ng l√†m m·ªõi trang.', 'warning');
          renderF5TasksTable();
        }
        
      } catch (error) {
        console.error('[Form 5] Failed to submit subtask update:', error);
        showToast('G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      } finally {
        // Restore button
        if (submitBtn) {
          submitBtn.disabled = false;
          if (originalText) submitBtn.textContent = originalText;
        }
      }
    }
    
    // ============================================
    // H√ÄM HI·ªÇN TH·ªä CHI TI·∫æT PROJECT/TASK/SUBTASK
    // ============================================
    
    // H√†m m·ªü modal chi ti·∫øt project
    function openF5ViewProjectDetail(projectId) {
      const project = F5_PROJECTS.find(p => p.id === projectId);
      if (!project) {
        showToast('Kh√¥ng t√¨m th·∫•y d·ª± √°n', 'error');
        return;
      }
      
      const success = openModal('f5-view-detail', (modal, config) => {
        const titleEl = document.getElementById('modal-f5-view-detail-title');
        const subtitleEl = document.getElementById('modal-f5-view-detail-subtitle');
        const bodyEl = document.getElementById('modal-f5-view-detail-body');
        
        if (titleEl) titleEl.textContent = 'Chi ti·∫øt D·ª± √°n';
        if (subtitleEl) subtitleEl.textContent = project.projectCode;
        
        if (bodyEl) {
          const tasks = project.tasks || [];
          const progress = calculateProjectProgress(project);
          
          bodyEl.innerHTML = `
            <div class="space-y-6">
              <!-- Th√¥ng tin c∆° b·∫£n -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">T√™n d·ª± √°n</label>
                  <p class="text-base font-semibold text-gray-900 mt-1">${project.projectName || '-'}</p>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">M√£ d·ª± √°n</label>
                  <p class="text-base font-mono text-gray-900 mt-1">${project.projectCode || '-'}</p>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Ng∆∞·ªùi ph·ª• tr√°ch</label>
                  <p class="text-base text-gray-900 mt-1">${project.pic || '-'}</p>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Tr·∫°ng th√°i</label>
                  <div class="mt-1">${getF5StatusBadge(project.status)}</div>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Ng√†y t·∫°o</label>
                  <p class="text-base text-gray-900 mt-1">${formatF5Date(project.createdAt) || '-'}</p>
                </div>
                <div>
                  <label class="text-xs font-semibold text-gray-500 uppercase">Ng√†y h·∫øt h·∫°n</label>
                  <p class="text-base text-gray-900 mt-1">${formatF5Date(project.dueDate) || '-'}</p>
                </div>
                <div class="md:col-span-2">
                  <label class="text-xs font-semibold text-gray-500 uppercase">M√¥ t·∫£</label>
                  <p class="text-base text-gray-900 mt-1">${project.description || '-'}</p>
                </div>
              </div>
              
              <!-- Th·ªëng k√™ -->
              <div class="border-t border-gray-200 pt-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Th·ªëng k√™</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-xs text-gray-600">T·ªïng s·ªë task</p>
                    <p class="text-2xl font-bold text-blue-600 mt-1">${tasks.length}</p>
                  </div>
                  <div class="bg-green-50 rounded-lg p-4">
                    <p class="text-xs text-gray-600">Ti·∫øn ƒë·ªô</p>
                    <p class="text-2xl font-bold text-green-600 mt-1">${progress}%</p>
                  </div>
                  <div class="bg-yellow-50 rounded-lg p-4">
                    <p class="text-xs text-gray-600">ƒêang x·ª≠ l√Ω</p>
                    <p class="text-2xl font-bold text-yellow-600 mt-1">${tasks.filter(t => t.status === 'in_progress').length}</p>
                  </div>
                  <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-xs text-gray-600">Ho√†n th√†nh</p>
                    <p class="text-2xl font-bold text-gray-600 mt-1">${tasks.filter(t => t.status === 'done').length}</p>
                  </div>
                </div>
              </div>
              
              <!-- Danh s√°ch tasks -->
              ${tasks.length > 0 ? `
                <div class="border-t border-gray-200 pt-4">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">Danh s√°ch Task (${tasks.length})</h3>
                  <div class="space-y-2">
                    ${tasks.map(task => `
                      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex-1">
                          <p class="font-medium text-gray-900">${task.taskName || '-'}</p>
                          <p class="text-xs text-gray-500 mt-0.5">${task.taskCode || '-'}</p>
                        </div>
                        <div class="flex items-center gap-3">
                          ${getF5StatusBadge(task.status)}
                          <button type="button" class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="openF5ViewTaskDetail('${task.id}'); closeModal('f5-view-detail');">Xem chi ti·∫øt</button>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }
      });
      
      if (!success) console.error('[Form 5] Failed to open project detail modal');
    }
    
    // H√†m m·ªü modal chi ti·∫øt task
    function openF5ViewTaskDetail(taskId) {
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      const project = result.project;
      const form4Data = task.form4Data || {};
      
      const success = openModal('f5-view-detail', (modal, config) => {
        const titleEl = document.getElementById('modal-f5-view-detail-title');
        const subtitleEl = document.getElementById('modal-f5-view-detail-subtitle');
        const bodyEl = document.getElementById('modal-f5-view-detail-body');
        
        if (titleEl) titleEl.textContent = 'Chi ti·∫øt Task';
        if (subtitleEl) subtitleEl.textContent = task.taskCode || '';
        
        if (bodyEl) {
          const subtasks = task.subtasks || [];
          
          bodyEl.innerHTML = `
            <div class="space-y-6">
              <!-- Th√¥ng tin c∆° b·∫£n Task -->
              <div class="border-b border-gray-200 pb-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Th√¥ng tin Task</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">T√™n task</label>
                    <p class="text-base font-semibold text-gray-900 mt-1">${task.taskName || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">M√£ task</label>
                    <p class="text-base font-mono text-gray-900 mt-1">${task.taskCode || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Ng∆∞·ªùi ph·ª• tr√°ch</label>
                    <p class="text-base text-gray-900 mt-1">${task.pic || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Tr·∫°ng th√°i</label>
                    <div class="mt-1">${getF5StatusBadge(task.status)}</div>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">∆Øu ti√™n</label>
                    <div class="mt-1">${getF5PriorityBadge(task.priority)}</div>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Ng√†y h·∫øt h·∫°n</label>
                    <p class="text-base text-gray-900 mt-1">${formatF5Date(task.dueDate) || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Ng∆∞·ªùi y√™u c·∫ßu</label>
                    <p class="text-base text-gray-900 mt-1">${task.requesterName || '-'}</p>
                    ${task.requesterEmail ? `<p class="text-xs text-gray-500 mt-0.5">${task.requesterEmail}</p>` : ''}
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Ph√≤ng ban</label>
                    <p class="text-base text-gray-900 mt-1">${task.department || '-'}</p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold text-gray-500 uppercase">Nh√† cung c·∫•p</label>
                    <p class="text-base text-gray-900 mt-1">${task.vendor || task.form4Data?.vendor || '-'}</p>
                  </div>
                  <div class="md:col-span-2">
                    <label class="text-xs font-semibold text-gray-500 uppercase">M√¥ t·∫£</label>
                    <p class="text-base text-gray-900 mt-1">${task.description || '-'}</p>
                  </div>
                </div>
              </div>
              
              <!-- Th√¥ng tin t·ª´ Form 4 -->
              ${Object.keys(form4Data).length > 0 ? `
                <div class="border-b border-gray-200 pb-4">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">Th√¥ng tin t·ª´ Form 4</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${form4Data.itemName ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">T√™n s·∫£n ph·∫©m/linh ki·ªán</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.itemName}</p>
                      </div>
                    ` : ''}
                    ${form4Data.itemCode ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">M√£ s·∫£n ph·∫©m/linh ki·ªán</label>
                        <p class="text-base font-mono text-gray-900 mt-1">${form4Data.itemCode}</p>
                      </div>
                    ` : ''}
                    ${form4Data.componentType ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Lo·∫°i linh ki·ªán</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.componentType}</p>
                      </div>
                    ` : ''}
                    ${form4Data.componentStandard ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">C√¥ng chu·∫©n</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.componentStandard} gi·ªù</p>
                      </div>
                    ` : ''}
                    ${form4Data.purpose ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">M·ª•c ƒë√≠ch</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.purpose}</p>
                      </div>
                    ` : ''}
                    ${form4Data.vendor ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Nh√† cung c·∫•p</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.vendor}</p>
                      </div>
                    ` : ''}
                    ${form4Data.qtySamples ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">S·ªë l∆∞·ª£ng m·∫´u</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.qtySamples}</p>
                      </div>
                    ` : ''}
                    ${form4Data.requestDate ? `
                      <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase">Ng√†y y√™u c·∫ßu</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.requestDate}</p>
                      </div>
                    ` : ''}
                    ${form4Data.attachments ? `
                      <div class="md:col-span-2">
                        <label class="text-xs font-semibold text-gray-500 uppercase">File ƒë√≠nh k√®m</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.attachments}</p>
                      </div>
                    ` : ''}
                    ${form4Data.changeReq ? `
                      <div class="md:col-span-2">
                        <label class="text-xs font-semibold text-gray-500 uppercase">Ghi ch√∫</label>
                        <p class="text-base text-gray-900 mt-1">${form4Data.changeReq}</p>
                      </div>
                    ` : ''}
                  </div>
                </div>
              ` : ''}
              
              <!-- Danh s√°ch Subtasks -->
              ${subtasks.length > 0 ? `
                <div class="border-t border-gray-200 pt-4">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">Danh s√°ch Subtask (${subtasks.length})</h3>
                  <div class="space-y-2">
                    ${subtasks.map(subtask => {
                      const modeNames = {
                        'review-file-nctn': 'R√† so√°t file v·ªõi NCTN',
                        'review-ce-qc': 'G·ª≠i r√† so√°t CE v·ªõi QC',
                        'train-qc': 'ƒê√†o t·∫°o QC',
                        'send-test-task': 'G·ª≠i t√°c v·ª• th·ª≠ nghi·ªám',
                        'review-4m': 'R√† so√°t 4M',
                        'review-fmea': 'R√† so√°t FMEA'
                      };
                      return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                          <div class="flex-1">
                            <p class="font-medium text-gray-900">${subtask.name || '-'}</p>
                            <div class="flex items-center gap-3 mt-1">
                              <span class="text-xs text-gray-500">PIC: ${subtask.pic || '-'}</span>
                              ${subtask.declarationMode ? `<span class="text-xs text-blue-600">${modeNames[subtask.declarationMode] || subtask.declarationMode}</span>` : ''}
                            </div>
                          </div>
                          <div class="flex items-center gap-3">
                            ${getF5SubtaskStatusBadge(subtask.status)}
                            <button type="button" class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="openF5ViewSubtaskDetail('${taskId}', '${subtask.id}'); closeModal('f5-view-detail');">Xem chi ti·∫øt</button>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              ` : '<div class="border-t border-gray-200 pt-4"><p class="text-gray-500">Ch∆∞a c√≥ subtask n√†o</p></div>'}
            </div>
          `;
        }
      });
      
      if (!success) console.error('[Form 5] Failed to open task detail modal');
    }
    
    // H√†m m·ªü modal t·∫£i b√°o c√°o subtask
    function openF5ViewSubtaskDetail(taskId, subtaskId) {
      console.log('[Form 5] openF5ViewSubtaskDetail called:', { taskId, subtaskId });
      const result = findF5Task(taskId);
      if (!result || !result.task) {
        console.error('[Form 5] Task not found:', taskId);
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      console.log('[Form 5] Task found, subtasks:', task.subtasks?.map(st => ({ id: st.id, name: st.name })));
      const subtask = task.subtasks ? task.subtasks.find(st => st.id === subtaskId) : null;
      
      if (!subtask) {
        console.error('[Form 5] Subtask not found:', subtaskId, 'Available subtask IDs:', task.subtasks?.map(st => st.id));
        showToast('Kh√¥ng t√¨m th·∫•y subtask', 'error');
        return;
      }
      
      console.log('[Form 5] Subtask found:', { id: subtask.id, name: subtask.name, linkBCpdf: subtask.linkBCpdf, linkBCexcel: subtask.linkBCexcel });
      
      // L·∫•y link t·ª´ subtask
      const linkBCpdf = subtask.linkBCpdf || null;
      const linkBCexcel = subtask.linkBCexcel || null;
      
      const success = openModal('f5-subtask-download', (modal, config) => {
        const subtaskNameEl = document.getElementById('modal-f5-subtask-download-subtask-name');
        const pdfBtn = document.getElementById('modal-f5-subtask-download-pdf-btn');
        const excelBtn = document.getElementById('modal-f5-subtask-download-excel-btn');
        
        if (subtaskNameEl) {
          subtaskNameEl.textContent = subtask.name || 'N/A';
        }
        
        // C·∫≠p nh·∫≠t n√∫t PDF
        if (pdfBtn) {
          if (linkBCpdf && linkBCpdf.trim()) {
            pdfBtn.disabled = false;
            pdfBtn.onclick = () => {
              window.open(linkBCpdf.trim(), '_blank');
            };
          } else {
            pdfBtn.disabled = true;
            pdfBtn.onclick = null;
          }
        }
        
        // C·∫≠p nh·∫≠t n√∫t Excel
        if (excelBtn) {
          if (linkBCexcel && linkBCexcel.trim()) {
            excelBtn.disabled = false;
            excelBtn.onclick = () => {
              window.open(linkBCexcel.trim(), '_blank');
            };
          } else {
            excelBtn.disabled = true;
            excelBtn.onclick = null;
          }
        }
      });
      
      if (!success) console.error('[Form 5] Failed to open subtask download modal');
    }

    // X·ª≠ l√Ω submit form th√™m subtask
    /**
     * G·ª≠i subtask l√™n NocoDB
     * @param {Object} subtaskData - D·ªØ li·ªáu subtask ƒë√£ format theo schema NocoDB
     * @returns {Promise<Object>} - Response t·ª´ NocoDB API
     */
    /**
     * G·ª≠i Subtask l√™n server
     * @param {Object} subtaskData - D·ªØ li·ªáu subtask ƒë√£ format
     * @returns {Promise<Object>} - Response t·ª´ server
     */
    /**
     * G·ª≠i Subtask l√™n server (kh√¥ng c√≥ file)
     * @param {Object} subtaskData - D·ªØ li·ªáu subtask ƒë√£ format
     * @param {Object} taskData - D·ªØ li·ªáu task cha
     * @returns {Promise<Object>} - Response t·ª´ server
     */
    async function submitSubtaskToNocoDB(subtaskData, taskData) {
      const endpoint = 'https://iatzhxxuk.tino.page/webhook/form5-subtask-create';
      
      try {
        // K·∫øt h·ª£p d·ªØ li·ªáu subtask v√† task cha
        const payload = {
          ...subtaskData,
          taskData: taskData // Th√™m d·ªØ li·ªáu task cha
        };
        
        console.log('[Form 5] Sending subtask data with task data to server:', payload);
        console.log('[Form 5] Endpoint:', endpoint);
        console.log('[Form 5] Payload size:', JSON.stringify(payload).length, 'bytes');
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        console.log('[Form 5] Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        
        const result = await response.json();
        console.log('[Form 5] Subtask created successfully:', result);
        return result;
      } catch (error) {
        console.error('[Form 5] Error creating subtask:', error);
        throw error;
      }
    }
    
    /**
     * G·ª≠i Subtask v·ªõi file ƒë√≠nh k√®m l√™n server
     * @param {FormData} formData - FormData ch·ª©a d·ªØ li·ªáu subtask, task v√† file
     * @returns {Promise<Object>} - Response t·ª´ server
     */
    async function submitSubtaskToNocoDBWithFile(formData) {
      const endpoint = 'https://iatzhxxuk.tino.page/webhook/form5-subtask-create';
      
      try {
        // Log th√¥ng tin file trong FormData
        const fileEntry = formData.get('checklistFile');
        console.log('[Form 5] Sending subtask data with file and task data to server');
        console.log('[Form 5] File info:', {
          fileName: fileEntry?.name || 'N/A',
          fileSize: fileEntry?.size || 'N/A',
          fileType: fileEntry?.type || 'N/A',
          isFile: fileEntry instanceof File
        });
        
        // Log t·∫•t c·∫£ keys trong FormData ƒë·ªÉ debug
        const formDataEntries = [];
        for (const [key, value] of formData.entries()) {
          if (value instanceof File) {
            formDataEntries.push({ key, type: 'File', name: value.name, size: value.size });
          } else {
            formDataEntries.push({ key, type: typeof value, value: String(value).substring(0, 100) });
          }
        }
        console.log('[Form 5] FormData entries:', formDataEntries);
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Accept': 'application/json'
            // Kh√¥ng set Content-Type, browser s·∫Ω t·ª± ƒë·ªông set v·ªõi boundary cho FormData
          },
          body: formData
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        
        const result = await response.json();
        console.log('[Form 5] Subtask with file created successfully:', result);
        return result;
      } catch (error) {
        console.error('[Form 5] Error creating subtask with file:', error);
        throw error;
      }
    }
    
    function handleF5AddSubtaskSubmit(e) {
      e.preventDefault();
      
      const taskId = document.getElementById('modal-f5-add-subtask-task-id').value;
      const result = findF5Task(taskId);
      
      if (!result || !result.task) {
        showToast('Kh√¥ng t√¨m th·∫•y t√°c v·ª•', 'error');
        return;
      }
      
      const task = result.task;
      
      // L·∫•y gi√° tr·ªã t·ª´ c√°c input v·ªõi ki·ªÉm tra null
      const getNameEl = () => document.getElementById('modal-f5-add-subtask-name');
      const getItemCodeEl = () => document.getElementById('modal-f5-add-subtask-item-code');
      const getPicEl = () => document.getElementById('modal-f5-add-subtask-pic');
      const getManhourEl = () => document.getElementById('modal-f5-add-subtask-manhour');
      const getTimesendEl = () => document.getElementById('modal-f5-add-subtask-timesend');
      const getChecklistEl = () => document.getElementById('modal-f5-add-subtask-checklist');
      const getNoteEl = () => document.getElementById('modal-f5-add-subtask-note');
      const getDeclarationModeEl = () => document.getElementById('modal-f5-add-subtask-declaration-mode');
      
      const subtaskName = (getNameEl()?.value || '').trim();
      const subtaskItemCode = (getItemCodeEl()?.value || '').trim();
      const subtaskPic = getPicEl()?.value || '';
      const subtaskManhour = getManhourEl()?.value || '';
      const subtaskNote = (getNoteEl()?.value || '').trim();
      const subtaskDeclarationMode = getDeclarationModeEl()?.value || '';
      
      // L·∫•y th·ªùi gian g·ª≠i (m·∫∑c ƒë·ªãnh l√† gi·ªù hi·ªán t·∫°i n·∫øu kh√¥ng c√≥ gi√° tr·ªã)
      let subtaskTimesend = getTimesendEl()?.value || '';
      if (!subtaskTimesend) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        subtaskTimesend = `${year}-${month}-${day}T${hours}:${minutes}`;
      }
      
      // L·∫•y file checklist
      const checklistFileInput = getChecklistEl();
      const checklistFile = checklistFileInput?.files?.[0] || null;
      const checklistFileName = checklistFile ? checklistFile.name : '';
      
      if (!subtaskName) {
        showToast('Vui l√≤ng nh·∫≠p t√™n t√°c v·ª• con', 'error');
        return;
      }
      
      if (!subtaskDeclarationMode) {
        showToast('Vui l√≤ng ch·ªçn ch·∫ø ƒë·ªô khai b√°o', 'error');
        return;
      }
      
      // L·∫•y project_code t·ª´ task (c√≥ th·ªÉ t·ª´ form4Data ho·∫∑c project)
      const projectCode = task.form4Data?.projectCode || result.project?.projectCode || null;
      
      // L·∫•y parent_id th·ª±c t·∫ø t·ª´ database (Id c·ªßa task trong dqa_tasks)
      // taskId c√≥ d·∫°ng "TASK-xxx", c·∫ßn l·∫•y ph·∫ßn sau ƒë·ªÉ c√≥ ID th·ª±c trong database
      const parentTaskId = taskId.replace('TASK-', '');
      
      if (!parentTaskId) {
        console.error('[Form 5] Cannot get parentTaskId from taskId:', taskId);
        showToast('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh ID t√°c v·ª• cha. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        return;
      }
      
      console.log('[Form 5] Creating subtask with parentTaskId:', parentTaskId, 'taskId:', taskId);
      
      // T√≠nh s·ªë th·ª© t·ª± subtask (Subtaskno) - s·ªë th·ª© t·ª± c·ªßa subtask trong task
      // Subtaskno = 0 l√† task ch√≠nh, 1, 2, 3... l√† c√°c subtask
      const existingSubtasks = task.subtasks || [];
      // T√¨m s·ªë Subtaskno l·ªõn nh·∫•t hi·ªán c√≥ (ch·ªâ t√≠nh subtask c√≥ Subtaskno > 0)
      const maxSubtaskNo = existingSubtasks.reduce((max, st) => {
        const no = st.subtaskNo || 0;
        return no > max ? no : max;
      }, 0);
      const subtaskNo = maxSubtaskNo + 1; // Subtask s·ªë ti·∫øp theo (b·∫Øt ƒë·∫ßu t·ª´ 1)
      
      // T·∫°o m√£ QA.NB.DDMM-xxxxxx khi th√™m t√°c v·ª• con (subtask th·ªß c√¥ng)
      const qaNbCode = generateQANBCode();
      
      // Format d·ªØ li·ªáu theo schema NocoDB
      const subtaskDataForDB = formatSubtaskToNocoDB({
        name: subtaskName,
        pic: subtaskPic,
        manhour: subtaskManhour || null,
        status: 'Leader review', // M·∫∑c ƒë·ªãnh Leader review khi t·∫°o m·ªõi
        checklist: checklistFileName || '', // T√™n file checklist
        timesend: subtaskTimesend || null,
        finishTime: null, // Kh√¥ng c·∫ßn khi t·∫°o m·ªõi
        note: subtaskNote || '',
        priority: 'Trung b√¨nh', // M·∫∑c ƒë·ªãnh
        declarationMode: subtaskDeclarationMode,
        subtaskNo: subtaskNo, // S·ªë th·ª© t·ª± subtask
        itemCode: subtaskItemCode || '', // M√£ linh ki·ªán/s·∫£n ph·∫©m
        taskCode: qaNbCode // Th√™m m√£ QA.NB.DDMM-xxxxxx
      }, parentTaskId, projectCode);
      
      // Format d·ªØ li·ªáu task cha ƒë·ªÉ g·ª≠i k√®m
      const taskDataForDB = {
        TaskRequestCode: task.taskCode || '',
        TaskRequesterName: task.requesterName || '',
        TaskRequesterEmail: task.requesterEmail || '',
        TaskRequestDate: task.createdAt || '',
        TaskDeptRequest: task.department || '',
        TaskItemName: task.taskName || '',
        TaskItemCode: task.form4Data?.itemCode || '',
        TaskComponentType: task.form4Data?.componentType || '',
        TaskComponentStandard: task.form4Data?.componentStandard || '',
        TaskPurpose: task.form4Data?.purpose || '',
        TaskVendor: task.form4Data?.vendor || '',
        TaskQtySamples: task.form4Data?.qtySamples || '',
        TaskDesiredDate: task.dueDate || '',
        TaskPersonReceived: task.pic || '',
        TaskNotes: task.form4Data?.changeReq || '',
        TaskAppliedModel: task.form4Data?.appliedModel || '',
        TaskAttachments: task.form4Data?.attachments || '',
        TaskCode: task.taskCode || '',
        TaskName: task.taskName || '',
        TaskDescription: task.description || '',
        TaskPIC: task.pic || '',
        TaskDepartment: task.department || '',
        TaskCreatedAt: task.createdAt || '',
        TaskDueDate: task.dueDate || '',
        TaskStatus: task.status || 'pending',
        TaskPriority: task.priority || 'Trung b√¨nh',
        project_code: projectCode || null
      };
      
      // Log d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i ƒë·ªÉ debug
      console.log('[Form 5] Submitting subtask data:', {
        subtaskDataForDB,
        taskDataForDB,
        parentTaskId,
        projectCode,
        hasFile: !!checklistFile
      });
      
      // G·ª≠i l√™n server - n·∫øu c√≥ file th√¨ d√πng FormData, kh√¥ng th√¨ d√πng JSON
      let submitPromise;
      if (checklistFile) {
        // T·∫°o FormData ƒë·ªÉ g·ª≠i file
        const formData = new FormData();
        // Th√™m d·ªØ li·ªáu subtask
        Object.keys(subtaskDataForDB).forEach(key => {
          const value = subtaskDataForDB[key];
          if (value !== null && value !== undefined) {
            // Chuy·ªÉn ƒë·ªïi object/array th√†nh JSON string n·∫øu c·∫ßn
            const valueToAppend = typeof value === 'object' ? JSON.stringify(value) : value;
            formData.append(key, valueToAppend);
          }
        });
        // Th√™m d·ªØ li·ªáu task cha
        Object.keys(taskDataForDB).forEach(key => {
          const value = taskDataForDB[key];
          if (value !== null && value !== undefined) {
            const valueToAppend = typeof value === 'object' ? JSON.stringify(value) : value;
            formData.append(`taskData.${key}`, valueToAppend);
          }
        });
        // Th√™m file checklist v·ªõi t√™n field ƒë√∫ng
        formData.append('checklistFile', checklistFile, checklistFile.name);
        console.log('[Form 5] Sending with FormData (has file):', {
          fileName: checklistFile.name,
          fileSize: checklistFile.size,
          fileType: checklistFile.type,
          formDataKeys: Array.from(formData.keys())
        });
        submitPromise = submitSubtaskToNocoDBWithFile(formData);
      } else {
        // G·ª≠i JSON v·ªõi d·ªØ li·ªáu subtask v√† task cha
        console.log('[Form 5] Sending with JSON (no file)');
        submitPromise = submitSubtaskToNocoDB(subtaskDataForDB, taskDataForDB);
      }
      
      // ƒê√≥ng modal tr∆∞·ªõc khi g·ª≠i
      closeF5AddSubtaskModal();
      
      // Hi·ªÉn th·ªã loading indicator
      const tbody = document.getElementById('f5-tasksTableBody');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="12" class="px-6 py-8 text-center text-gray-500 text-base"><span class="spinner"></span><span style="margin-left:8px">ƒêang l∆∞u t√°c v·ª• con...</span></td></tr>';
      }
      
      // G·ª≠i l√™n server v√† reload d·ªØ li·ªáu t·ª´ server (KH√îNG render local)
      submitPromise
        .then(async (dbResult) => {
          console.log('[Form 5] Subtask saved to server:', dbResult);
          
          // N·∫øu server tr·∫£ v·ªÅ Subtaskformlink t·ª´ vi·ªác upload file, c·∫≠p nh·∫≠t l·∫°i subtask v·ªõi link ƒë√≥
          if (dbResult && dbResult.Subtaskformlink && checklistFile) {
            try {
              const subtaskId = dbResult.Id || dbResult.id;
              if (subtaskId) {
                // C·∫≠p nh·∫≠t subtask v·ªõi link file
                const updateData = {
                  Id: subtaskId,
                  Subtaskformlink: dbResult.Subtaskformlink
                };
                const updateEndpoint = 'https://iatzhxxuk.tino.page/webhook/form5-subtask-update';
                const updateResponse = await fetch(updateEndpoint, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(updateData)
                });
                if (updateResponse.ok) {
                  console.log('[Form 5] Subtaskformlink updated successfully:', dbResult.Subtaskformlink);
                } else {
                  console.warn('[Form 5] Failed to update Subtaskformlink:', await updateResponse.text());
                }
              }
            } catch (updateError) {
              console.error('[Form 5] Error updating Subtaskformlink:', updateError);
              // Kh√¥ng throw error, ch·ªâ log ƒë·ªÉ kh√¥ng l√†m gi√°n ƒëo·∫°n flow ch√≠nh
            }
          }
          
          // Reload d·ªØ li·ªáu t·ª´ server ƒë·ªÉ hi·ªÉn th·ªã subtask m·ªõi
          try {
            // L∆∞u taskId ƒë·ªÉ expand sau khi reload
            const taskIdToExpand = taskId;
            
            // Reload d·ªØ li·ªáu t·ª´ server
            F5_PROJECTS = await loadF5Projects(F5_FILTER_PIC);
            
            // T√¨m l·∫°i task sau khi reload v√† expand n√≥ ƒë·ªÉ hi·ªÉn th·ªã subtask m·ªõi
            const resultAfterReload = findF5Task(taskIdToExpand);
            if (resultAfterReload && resultAfterReload.task) {
              resultAfterReload.task.expanded = true;
              // ƒê·∫£m b·∫£o project c≈©ng ƒë∆∞·ª£c expand
              if (resultAfterReload.project) {
                resultAfterReload.project.expanded = true;
              }
            }
            
            // Render l·∫°i b·∫£ng v·ªõi d·ªØ li·ªáu t·ª´ server
            renderF5TasksTable();
      showToast(`ƒê√£ th√™m t√°c v·ª• con th√†nh c√¥ng. M√£ t√°c v·ª•: ${qaNbCode}`, 'success');
          } catch (reloadError) {
            console.error('[Form 5] Failed to reload data:', reloadError);
            showToast('ƒê√£ l∆∞u t√°c v·ª• con nh∆∞ng kh√¥ng th·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu. Vui l√≤ng l√†m m·ªõi trang.', 'warning');
            // Render l·∫°i v·ªõi d·ªØ li·ªáu c≈©
            renderF5TasksTable();
          }
        })
        .catch((error) => {
          console.error('[Form 5] Failed to save subtask to server:', error);
          console.error('[Form 5] Error details:', {
            message: error.message,
            stack: error.stack,
            subtaskData: subtaskDataForDB,
            taskData: taskDataForDB
          });
          showToast(`L∆∞u t√°c v·ª• con th·∫•t b·∫°i: ${error.message || 'Vui l√≤ng th·ª≠ l·∫°i.'}`, 'error');
          // Render l·∫°i v·ªõi d·ªØ li·ªáu c≈© (t·ª´ server, kh√¥ng ph·∫£i local)
          renderF5TasksTable();
        });
    }

    // Kh·ªüi t·∫°o event listeners cho modal Form 5 - S·ª≠ d·ª•ng h·ªá th·ªëng modal t·∫≠p trung
    document.addEventListener('DOMContentLoaded', function() {
      // Kh·ªüi t·∫°o modal listeners cho Form 5 Add Subtask
      initModalListeners('f5-add-subtask');
      
      // Kh·ªüi t·∫°o modal listeners cho Form 5 Select Declaration
      initModalListeners('f5-select-declaration');
      
      // Kh·ªüi t·∫°o modal listeners cho c√°c modal khai b√°o Form 5
      initModalListeners('f5-declaration-review-file-nctn');
      initModalListeners('f5-declaration-review-ce-qc');
      initModalListeners('f5-declaration-train-qc');
      initModalListeners('f5-declaration-send-test-task');
      initModalListeners('f5-declaration-review-4m');
      initModalListeners('f5-declaration-review-fmea');
      initModalListeners('f5-declaration-complete');
      
      // Setup tabs v√† event listeners cho modal f5-declaration-complete
      (function setupF5CompleteModalTabs() {
        const tabGate1 = document.getElementById('modal-f5-declaration-complete-tab-gate1');
        const tabGate2 = document.getElementById('modal-f5-declaration-complete-tab-gate2');
        const tabGate3 = document.getElementById('modal-f5-declaration-complete-tab-gate3');
        const gate1Title = document.getElementById('modal-f5-declaration-complete-gate1-title');
        const gate2Div = document.getElementById('modal-f5-declaration-complete-gate2');
        const gate3Div = document.getElementById('modal-f5-declaration-complete-gate3');
        const uploadForm1Split = document.getElementById('modal-f5-declaration-complete-upload-form1-split');
        const classificationGroup = document.getElementById('modal-f5-declaration-complete-classification-group');
        const conclusionGroup = document.getElementById('modal-f5-declaration-complete-conclusion-group');
        const durabilityGroup = document.getElementById('modal-f5-declaration-complete-durability-group');
        const bpsOption = document.getElementById('modal-f5-declaration-complete-bps-option');
        
        function activateGate1() {
          if (tabGate1) {
            tabGate1.classList.add('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate1.classList.remove('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (tabGate2) {
            tabGate2.classList.remove('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate2.classList.add('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (tabGate3) {
            tabGate3.classList.remove('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate3.classList.add('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (gate1Title) gate1Title.style.display = '';
          if (gate2Div) gate2Div.style.display = 'none';
          if (gate3Div) gate3Div.style.display = 'none';
          if (uploadForm1Split) uploadForm1Split.style.display = '';
          if (classificationGroup) classificationGroup.style.display = '';
          if (conclusionGroup) conclusionGroup.style.display = '';
          if (durabilityGroup) durabilityGroup.style.display = '';
          if (bpsOption) bpsOption.style.display = '';
        }
        
        function activateGate2() {
          if (tabGate1) {
            tabGate1.classList.remove('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate1.classList.add('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (tabGate2) {
            tabGate2.classList.add('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate2.classList.remove('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (tabGate3) {
            tabGate3.classList.remove('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate3.classList.add('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (gate1Title) gate1Title.style.display = 'none';
          if (gate2Div) gate2Div.style.display = '';
          if (gate3Div) gate3Div.style.display = 'none';
          if (uploadForm1Split) uploadForm1Split.style.display = 'none';
          if (classificationGroup) classificationGroup.style.display = 'none';
          if (conclusionGroup) conclusionGroup.style.display = 'none';
          if (durabilityGroup) durabilityGroup.style.display = 'none';
          if (bpsOption) bpsOption.style.display = '';
        }
        
        function activateGate3() {
          if (tabGate1) {
            tabGate1.classList.remove('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate1.classList.add('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (tabGate2) {
            tabGate2.classList.remove('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate2.classList.add('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (tabGate3) {
            tabGate3.classList.add('bg-cyan-700', 'text-white', 'border-cyan-800', 'shadow');
            tabGate3.classList.remove('bg-cyan-200', 'text-cyan-900', 'border-cyan-400');
          }
          if (gate1Title) gate1Title.style.display = 'none';
          if (gate2Div) gate2Div.style.display = 'none';
          if (gate3Div) gate3Div.style.display = '';
          if (uploadForm1Split) uploadForm1Split.style.display = 'none';
          if (classificationGroup) classificationGroup.style.display = 'none';
          if (conclusionGroup) conclusionGroup.style.display = 'none';
          if (durabilityGroup) durabilityGroup.style.display = 'none';
          if (bpsOption) bpsOption.style.display = 'none';
        }
        
        if (tabGate1) {
          tabGate1.addEventListener('click', activateGate1);
        }
        if (tabGate2) {
          tabGate2.addEventListener('click', activateGate2);
        }
        if (tabGate3) {
          tabGate3.addEventListener('click', activateGate3);
        }
        
        // X·ª≠ l√Ω radio button "C√≥ test b·ªÅn" ƒë·ªÉ hi·ªÉn th·ªã date picker
        const durabilityRadios = document.querySelectorAll('input[name="modal-f5-declaration-complete-durability-choice"]');
        const durDateWrap = document.getElementById('modal-f5-declaration-complete-durability-date-wrap');
        durabilityRadios.forEach(radio => {
          radio.addEventListener('change', function() {
            if (durDateWrap) {
              durDateWrap.style.display = (this.value === 'co') ? '' : 'none';
            }
          });
        });
      })();
      
      // Kh·ªüi t·∫°o modal listeners cho modal xem chi ti·∫øt
      initModalListeners('f5-view-detail');
      initModalListeners('f5-subtask-download');
      
      // X·ª≠ l√Ω submit form
      const addSubtaskForm = document.getElementById('modal-f5-add-subtask-form');
      if (addSubtaskForm && !addSubtaskForm._submitListenerAttached) {
        addSubtaskForm._submitListenerAttached = true;
        addSubtaskForm.addEventListener('submit', handleF5AddSubtaskSubmit);
        console.log('[Form 5] Form submit listener attached');
      }
      
      // X·ª≠ l√Ω ch·ªçn ch·∫ø ƒë·ªô khai b√°o
      document.addEventListener('click', function(e) {
        const modeBtn = e.target.closest('.f5-declaration-mode-btn');
        if (modeBtn) {
          e.preventDefault();
          e.stopPropagation();
          
          const mode = modeBtn.getAttribute('data-mode');
          const modal = document.getElementById('modal-f5-select-declaration');
          if (modal) {
            const taskId = modal.getAttribute('data-task-id');
            const subtaskId = modal.getAttribute('data-subtask-id');
            
            if (taskId && mode) {
              handleF5DeclarationModeSelect(mode, taskId, subtaskId || null);
            } else {
              console.error('[Form 5] Missing taskId or mode');
            }
          }
        }
      });
      
      // X·ª≠ l√Ω file upload cho modal send-test-task
      const attachmentInput = document.getElementById('modal-f5-declaration-send-test-task-attachment');
      const attachmentBtn = document.getElementById('modal-f5-declaration-send-test-task-attachment-btn');
      const attachmentNameSpan = document.getElementById('modal-f5-declaration-send-test-task-attachment-name');
      const attachmentRemoveBtn = document.getElementById('modal-f5-declaration-send-test-task-attachment-remove');
      
      if (attachmentBtn && attachmentInput) {
        attachmentBtn.addEventListener('click', () => {
          attachmentInput.click();
        });
      }
      
      if (attachmentInput && attachmentNameSpan && attachmentRemoveBtn) {
        attachmentInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            attachmentNameSpan.textContent = file.name;
            attachmentRemoveBtn.classList.remove('hidden');
          } else {
            attachmentNameSpan.textContent = 'Ch∆∞a ch·ªçn file';
            attachmentRemoveBtn.classList.add('hidden');
          }
        });
      }
      
      if (attachmentRemoveBtn && attachmentInput && attachmentNameSpan) {
        attachmentRemoveBtn.addEventListener('click', () => {
          attachmentInput.value = '';
          attachmentNameSpan.textContent = 'Ch∆∞a ch·ªçn file';
          attachmentRemoveBtn.classList.add('hidden');
        });
      }
      
      // X·ª≠ l√Ω submit cho modal send-test-task
      const sendTestTaskSubmitBtn = document.getElementById('modal-f5-declaration-send-test-task-submit');
      if (sendTestTaskSubmitBtn && !sendTestTaskSubmitBtn._submitListenerAttached) {
        sendTestTaskSubmitBtn._submitListenerAttached = true;
        sendTestTaskSubmitBtn.addEventListener('click', handleF5SendTestTaskSubmit);
        console.log('[Form 5] Send test task submit listener attached');
      }
      
      // X·ª≠ l√Ω submit cho modal complete
      const completeSubmitBtn = document.getElementById('modal-f5-declaration-complete-submit');
      if (completeSubmitBtn && !completeSubmitBtn._submitListenerAttached) {
        completeSubmitBtn._submitListenerAttached = true;
        completeSubmitBtn.addEventListener('click', handleF5CompleteSubmit);
        console.log('[Form 5] Complete submit listener attached');
      }
      
      // Test: Th√™m h√†m global ƒë·ªÉ test modal
      window.testF5Modal = function() {
        console.log('[Form 5] Test function called');
        const firstTask = F5_PROJECTS[0]?.tasks?.[0];
        if (firstTask) {
          openF5AddSubtaskModal(firstTask.id);
        } else {
          openF5AddSubtaskModal('TASK-001');
        }
      };
      console.log('[Form 5] Test function available: window.testF5Modal()');
    });

    // C√°c h√†m c≈© ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·∫±ng h√†m m·ªõi ·ªü tr√™n

    // ===== FORM 9 - NG√ÇN H√ÄNG L·ªñI =====
    
    // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu
    let F9_ALL_DATA = [];
    let F9_FILTERED_DATA = [];
    let F9_CURRENT_PAGE = 1;
    let F9_PAGE_SIZE = 20;
    
    // Kh·ªüi t·∫°o Form 9
    function initForm9() {
      console.log('[Form 9] Initializing...');
      
      // Event listeners
      const loadBtn = document.getElementById('f9-load-btn');
      const exportBtn = document.getElementById('f9-export-btn');
      const searchInput = document.getElementById('f9-search');
      const resetFiltersBtn = document.getElementById('f9-reset-filters');
      const prevPageBtn = document.getElementById('f9-prev-page');
      const nextPageBtn = document.getElementById('f9-next-page');
      
      if (loadBtn) {
        loadBtn.addEventListener('click', loadF9Data);
      }
      
      if (exportBtn) {
        exportBtn.addEventListener('click', exportF9ToExcel);
      }
      
      if (searchInput) {
        searchInput.addEventListener('input', debounce(filterF9Data, 300));
      }
      
      // Pagination
      if (prevPageBtn) {
        prevPageBtn.addEventListener('click', () => {
          if (F9_CURRENT_PAGE > 1) {
            F9_CURRENT_PAGE--;
            renderF9Table();
          }
        });
      }
      
      if (nextPageBtn) {
        nextPageBtn.addEventListener('click', () => {
          const totalPages = Math.ceil(F9_FILTERED_DATA.length / F9_PAGE_SIZE);
          if (F9_CURRENT_PAGE < totalPages) {
            F9_CURRENT_PAGE++;
            renderF9Table();
          }
        });
      }
      
      // Modal listeners
      initModalListeners('f9-view-detail');
      initModalListeners('f9-hang-muc-ng');
      
      console.log('[Form 9] Initialized');
    }
    
    // Load d·ªØ li·ªáu t·ª´ webhook ho·∫∑c file upload
    async function loadF9Data() {
      const loadingDiv = document.getElementById('f9-loading');
      const loadBtn = document.getElementById('f9-load-btn');
      const tbody = document.getElementById('f9-table-body');
      
      if (loadingDiv) loadingDiv.classList.remove('hidden');
      if (loadBtn) loadBtn.disabled = true;
      
      try {
        // Load t·ª´ webhook
        const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/ee460151-fda2-4a12-bfc9-d073f895ff5b';
        
        const response = await fetch(webhookUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        // X·ª≠ l√Ω nhi·ªÅu format response
        if (Array.isArray(data)) {
          F9_ALL_DATA = data;
        } else if (data && Array.isArray(data.data)) {
          F9_ALL_DATA = data.data;
        } else if (data && Array.isArray(data.records)) {
          F9_ALL_DATA = data.records;
        } else {
          F9_ALL_DATA = [];
        }
        
        // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu, hi·ªÉn th·ªã th√¥ng b√°o
        if (!F9_ALL_DATA || F9_ALL_DATA.length === 0) {
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="11" class="px-3 py-8 text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          }
          showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã', 'warning');
          return;
        }
        
        // Apply filters
        filterF9Data();
        
        showToast(`ƒê√£ t·∫£i ${F9_ALL_DATA.length} b·∫£n ghi l·ªói`, 'success');
        
      } catch (error) {
        console.error('[Form 9] Error loading data:', error);
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="11" class="px-3 py-8 text-center text-red-500">L·ªói: ${escapeHtml(error.message)}</td></tr>`;
        }
        showToast('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
      } finally {
        if (loadingDiv) loadingDiv.classList.add('hidden');
        if (loadBtn) loadBtn.disabled = false;
      }
    }
    
    // Filter d·ªØ li·ªáu - ch·ªâ t√¨m ki·∫øm ƒë∆°n gi·∫£n
    function filterF9Data() {
      const search = document.getElementById('f9-search')?.value.toLowerCase() || '';
      
      if (!search) {
        F9_FILTERED_DATA = F9_ALL_DATA;
      } else {
        F9_FILTERED_DATA = F9_ALL_DATA.filter(item => {
          // T√¨m ki·∫øm trong t·∫•t c·∫£ c√°c tr∆∞·ªùng quan tr·ªçng
          const searchText = [
            item['Linh ki·ªán'] || '',
            item['M√£ linh ki·ªán'] || '',
            item['H·∫°ng m·ª•c NG'] || '',
            item['M√£ b√°o c√°o'] || '',
            item['Nh√† cung c·∫•p'] || '',
            item['Ng∆∞·ªùi l·∫≠p'] || '',
            item['Ng∆∞·ªùi ki·ªÉm tra'] || ''
          ].join(' ').toLowerCase();
          
          return searchText.includes(search);
        });
      }
      
      // S·∫Øp x·∫øp theo "Ng√†y ghi nh·∫≠n" t·ª´ m·ªõi nh·∫•t ƒë·∫øn c≈© nh·∫•t
      F9_FILTERED_DATA.sort((a, b) => {
        const dateA = a['Ng√†y ghi nh·∫≠n'] || '';
        const dateB = b['Ng√†y ghi nh·∫≠n'] || '';
        
        // N·∫øu c·∫£ hai ƒë·ªÅu kh√¥ng c√≥ ng√†y, gi·ªØ nguy√™n th·ª© t·ª±
        if (!dateA && !dateB) return 0;
        if (!dateA) return 1; // Kh√¥ng c√≥ ng√†y ƒë·∫∑t xu·ªëng cu·ªëi
        if (!dateB) return -1; // Kh√¥ng c√≥ ng√†y ƒë·∫∑t xu·ªëng cu·ªëi
        
        // Parse date - h·ªó tr·ª£ nhi·ªÅu format
        let dateAObj = null;
        let dateBObj = null;
        
        try {
          // Th·ª≠ parse c√°c format kh√°c nhau
          const dateAStr = String(dateA).trim();
          const dateBStr = String(dateB).trim();
          
          // Format: YYYY-MM-DD HH:mm ho·∫∑c YYYY-MM-DD HH:mm:ss
          if (dateAStr.includes('-')) {
            // C√≥ th·ªÉ c√≥ gi·ªù: "2025-12-25 11:01" ho·∫∑c ch·ªâ ng√†y: "2025-12-25"
            if (dateAStr.includes(' ')) {
              // C√≥ gi·ªù: parse ƒë·∫ßy ƒë·ªß
              const [datePart, timePart] = dateAStr.split(' ');
              const [hours, minutes] = (timePart || '00:00').split(':');
              dateAObj = new Date(`${datePart}T${hours || '00'}:${minutes || '00'}:00`);
            } else {
              // Ch·ªâ c√≥ ng√†y
              dateAObj = new Date(dateAStr + 'T00:00:00');
            }
          } else if (dateAStr.includes('/')) {
            // Format: DD/MM/YYYY HH:mm ho·∫∑c DD/MM/YYYY
            const parts = dateAStr.split(' ');
            const datePart = parts[0];
            const timePart = parts[1] || '00:00';
            const dateMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (dateMatch) {
              const day = dateMatch[1].padStart(2, '0');
              const month = dateMatch[2].padStart(2, '0');
              const year = dateMatch[3];
              const [hours, minutes] = timePart.split(':');
              dateAObj = new Date(`${year}-${month}-${day}T${hours || '00'}:${minutes || '00'}:00`);
            }
          }
          
          if (dateBStr.includes('-')) {
            // C√≥ th·ªÉ c√≥ gi·ªù: "2025-12-25 11:01" ho·∫∑c ch·ªâ ng√†y: "2025-12-25"
            if (dateBStr.includes(' ')) {
              // C√≥ gi·ªù: parse ƒë·∫ßy ƒë·ªß
              const [datePart, timePart] = dateBStr.split(' ');
              const [hours, minutes] = (timePart || '00:00').split(':');
              dateBObj = new Date(`${datePart}T${hours || '00'}:${minutes || '00'}:00`);
            } else {
              // Ch·ªâ c√≥ ng√†y
              dateBObj = new Date(dateBStr + 'T00:00:00');
            }
          } else if (dateBStr.includes('/')) {
            // Format: DD/MM/YYYY HH:mm ho·∫∑c DD/MM/YYYY
            const parts = dateBStr.split(' ');
            const datePart = parts[0];
            const timePart = parts[1] || '00:00';
            const dateMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (dateMatch) {
              const day = dateMatch[1].padStart(2, '0');
              const month = dateMatch[2].padStart(2, '0');
              const year = dateMatch[3];
              const [hours, minutes] = timePart.split(':');
              dateBObj = new Date(`${year}-${month}-${day}T${hours || '00'}:${minutes || '00'}:00`);
            }
          }
          
          // N·∫øu parse th√†nh c√¥ng, so s√°nh
          if (dateAObj && dateBObj && !isNaN(dateAObj.getTime()) && !isNaN(dateBObj.getTime())) {
            return dateBObj.getTime() - dateAObj.getTime(); // M·ªõi nh·∫•t tr∆∞·ªõc (gi·∫£m d·∫ßn)
          }
        } catch (e) {
          // N·∫øu parse l·ªói, so s√°nh string
        }
        
        // Fallback: so s√°nh string (m·ªõi nh·∫•t tr∆∞·ªõc)
        return String(dateB).localeCompare(String(dateA));
      });
      
      F9_CURRENT_PAGE = 1; // Reset v·ªÅ trang ƒë·∫ßu
      renderF9Table();
    }
    
    // Render b·∫£ng d·ªØ li·ªáu
    function renderF9Table() {
      const tbody = document.getElementById('f9-table-body');
      if (!tbody) return;
      
      if (F9_FILTERED_DATA.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="px-3 py-8 text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p</td></tr>';
        updateF9Pagination();
        return;
      }
      
      // Pagination
      const start = (F9_CURRENT_PAGE - 1) * F9_PAGE_SIZE;
      const end = start + F9_PAGE_SIZE;
      const pageData = F9_FILTERED_DATA.slice(start, end);
      
      tbody.innerHTML = pageData.map((item, index) => {
        const stt = start + index + 1;
        const ngayGhiNhan = item['Ng√†y ghi nh·∫≠n'] || '';
        // Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß ng√†y gi·ªù n·∫øu c√≥
        const formattedDate = ngayGhiNhan ? ngayGhiNhan.trim() : '';
        const hasChiTietHangMuc = item['Chi ti·∫øt h·∫°ng m·ª•c NG'] && item['Chi ti·∫øt h·∫°ng m·ª•c NG'].trim();
        
        return `
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 border border-gray-300">${stt}</td>
            <td class="px-3 py-3 border border-gray-300">${escapeHtml(item['Linh ki·ªán'] || '')}</td>
            <td class="px-3 py-3 border border-gray-300 font-medium">${escapeHtml(item['M√£ linh ki·ªán'] || '')}</td>
            <td class="px-3 py-3 border border-gray-300">${escapeHtml(item['Ph·∫°m vi'] || '')}</td>
            <td class="px-3 py-3 border border-gray-300">
              ${hasChiTietHangMuc ? `
                <button onclick="openF9HangMucNGModal(${item.Id})" class="text-blue-600 hover:text-blue-800 hover:underline font-medium cursor-pointer text-left">
                  ${escapeHtml(item['H·∫°ng m·ª•c NG'] || '')}
                </button>
              ` : escapeHtml(item['H·∫°ng m·ª•c NG'] || '')}
            </td>
            <td class="px-3 py-3 border border-gray-300">${escapeHtml(item['M√£ b√°o c√°o'] || '')}</td>
            <td class="px-3 py-3 border border-gray-300">${escapeHtml(item['Nh√† cung c·∫•p'] || '')}</td>
            <td class="px-3 py-3 border border-gray-300">${escapeHtml(item['Ng∆∞·ªùi l·∫≠p'] || '')}</td>
            <td class="px-3 py-3 border border-gray-300">${escapeHtml(item['Ng∆∞·ªùi ki·ªÉm tra'] || '')}</td>
            <td class="px-3 py-3 border border-gray-300">${escapeHtml(formattedDate)}</td>
            <td class="px-3 py-3 border border-gray-300 text-center">
              <button onclick="openF9DetailModal(${item.Id})" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm">
                Xem chi ti·∫øt
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      updateF9Pagination();
    }
    
    // Update pagination
    function updateF9Pagination() {
      const totalItems = F9_FILTERED_DATA.length;
      const totalPages = Math.ceil(totalItems / F9_PAGE_SIZE);
      const start = totalItems === 0 ? 0 : (F9_CURRENT_PAGE - 1) * F9_PAGE_SIZE + 1;
      const end = Math.min(F9_CURRENT_PAGE * F9_PAGE_SIZE, totalItems);
      
      document.getElementById('f9-page-info').textContent = `${start}-${end}`;
      document.getElementById('f9-total-items').textContent = totalItems;
      document.getElementById('f9-current-page').textContent = F9_CURRENT_PAGE;
      document.getElementById('f9-total-pages').textContent = totalPages;
      
      const prevBtn = document.getElementById('f9-prev-page');
      const nextBtn = document.getElementById('f9-next-page');
      
      if (prevBtn) {
        prevBtn.disabled = F9_CURRENT_PAGE === 1;
      }
      if (nextBtn) {
        nextBtn.disabled = F9_CURRENT_PAGE >= totalPages;
      }
    }
    
    // Open detail modal (global function ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ HTML)
    // Ch·ªâ hi·ªÉn th·ªã 3 ph·∫ßn: Th√¥ng tin b√°o c√°o, K·∫øt lu·∫≠n b√°o c√°o, Ph√™ duy·ªát
    window.openF9DetailModal = function(id) {
      const item = F9_ALL_DATA.find(d => d.Id === id);
      if (!item) {
        showToast('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu', 'error');
        return;
      }
      
      const success = openModal('f9-view-detail', (modal, config) => {
        const body = document.getElementById('modal-f9-view-detail-body');
        
        if (body) {
          // Parse JSON fields - ch·ªâ parse 3 ph·∫ßn c·∫ßn thi·∫øt
          let thongTinBaoCao = {};
          let ketLuanBaoCao = {};
          let pheDuyet = {};
          
          try {
            if (item['Th√¥ng tin b√°o c√°o']) {
              thongTinBaoCao = JSON.parse(item['Th√¥ng tin b√°o c√°o']);
            }
          } catch (e) {
            console.warn('[Form 9] Failed to parse Th√¥ng tin b√°o c√°o:', e);
          }
          
          try {
            if (item['K·∫øt lu·∫≠n b√°o c√°o']) {
              ketLuanBaoCao = JSON.parse(item['K·∫øt lu·∫≠n b√°o c√°o']);
            }
          } catch (e) {
            console.warn('[Form 9] Failed to parse K·∫øt lu·∫≠n b√°o c√°o:', e);
          }
          
          try {
            if (item['Ph√™ duy·ªát']) {
              pheDuyet = JSON.parse(item['Ph√™ duy·ªát']);
            }
          } catch (e) {
            console.warn('[Form 9] Failed to parse Ph√™ duy·ªát:', e);
          }
          
          body.innerHTML = `
            <div class="grid grid-cols-3 gap-4">
              <!-- Th√¥ng tin b√°o c√°o -->
              <div class="col-span-1 border border-blue-200 rounded-lg p-4 bg-blue-50">
                <h3 class="text-sm font-bold text-blue-800 mb-3 flex items-center gap-1">
                  <span class="material-symbols-outlined text-base">description</span>
                  Th√¥ng tin b√°o c√°o
                </h3>
                <div class="space-y-2 text-sm">
                  ${thongTinBaoCao && Object.keys(thongTinBaoCao).length > 0 ? 
                    Object.entries(thongTinBaoCao).map(([key, value]) => `
                      <div class="pb-2 border-b border-blue-100 last:border-0">
                        <div class="text-xs font-semibold text-gray-600 mb-1">${escapeHtml(key)}</div>
                        <div class="text-gray-900 break-words">${escapeHtml(String(value || ''))}</div>
                      </div>
                    `).join('') : 
                    '<p class="text-gray-500 text-xs">Kh√¥ng c√≥ d·ªØ li·ªáu</p>'
                  }
                </div>
              </div>
              
              <!-- K·∫øt lu·∫≠n b√°o c√°o -->
              <div class="col-span-1 border border-green-200 rounded-lg p-4 bg-green-50">
                <h3 class="text-sm font-bold text-green-800 mb-3 flex items-center gap-1">
                  <span class="material-symbols-outlined text-base">check_circle</span>
                  K·∫øt lu·∫≠n b√°o c√°o
                </h3>
                <div class="space-y-2 text-sm">
                  ${ketLuanBaoCao && Object.keys(ketLuanBaoCao).length > 0 ? 
                    Object.entries(ketLuanBaoCao).map(([key, value]) => {
                      let displayValue = value;
                      if (Array.isArray(value)) {
                        displayValue = value.join(', ');
                      } else if (typeof value === 'object' && value !== null) {
                        displayValue = JSON.stringify(value, null, 2);
                      }
                      return `
                        <div class="pb-2 border-b border-green-100 last:border-0">
                          <div class="text-xs font-semibold text-gray-600 mb-1">${escapeHtml(key)}</div>
                          <div class="text-gray-900 whitespace-pre-wrap break-words text-xs">${escapeHtml(String(displayValue || ''))}</div>
                        </div>
                      `;
                    }).join('') : 
                    '<p class="text-gray-500 text-xs">Kh√¥ng c√≥ d·ªØ li·ªáu</p>'
                  }
                </div>
              </div>
              
              <!-- Ph√™ duy·ªát -->
              <div class="col-span-1 border border-purple-200 rounded-lg p-4 bg-purple-50">
                <h3 class="text-sm font-bold text-purple-800 mb-3 flex items-center gap-1">
                  <span class="material-symbols-outlined text-base">verified</span>
                  Ph√™ duy·ªát
                </h3>
                <div class="space-y-2 text-sm">
                  ${pheDuyet && Object.keys(pheDuyet).length > 0 ? 
                    (pheDuyet.Chu_ky ? 
                      Object.entries(pheDuyet.Chu_ky).map(([key, value]) => `
                        <div class="pb-2 border-b border-purple-100 last:border-0">
                          <div class="text-xs font-semibold text-gray-600 mb-1">${escapeHtml(key)}</div>
                          <div class="text-gray-900 break-words">${escapeHtml(String(value || ''))}</div>
                        </div>
                      `).join('') :
                      `<pre class="text-xs whitespace-pre-wrap bg-white p-2 rounded border border-purple-100">${escapeHtml(JSON.stringify(pheDuyet, null, 2))}</pre>`
                    ) : 
                    '<p class="text-gray-500 text-xs">Kh√¥ng c√≥ d·ªØ li·ªáu</p>'
                  }
                </div>
              </div>
            </div>
          `;
        }
      });
      
      if (!success) {
        console.error('[Form 9] Failed to open detail modal');
        showToast('Kh√¥ng th·ªÉ m·ªü modal chi ti·∫øt', 'error');
      }
    }
    
    // Open Chi ti·∫øt h·∫°ng m·ª•c NG modal (global function)
    window.openF9HangMucNGModal = function(id) {
      const item = F9_ALL_DATA.find(d => d.Id === id);
      if (!item) {
        showToast('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu', 'error');
        return;
      }
      
      let chiTietHangMuc = null;
      try {
        if (item['Chi ti·∫øt h·∫°ng m·ª•c NG']) {
          chiTietHangMuc = JSON.parse(item['Chi ti·∫øt h·∫°ng m·ª•c NG']);
        }
      } catch (e) {
        console.error('[Form 9] Failed to parse Chi ti·∫øt h·∫°ng m·ª•c NG:', e);
        showToast('L·ªói khi parse d·ªØ li·ªáu Chi ti·∫øt h·∫°ng m·ª•c NG', 'error');
        return;
      }
      
      if (!chiTietHangMuc || Object.keys(chiTietHangMuc).length === 0) {
        showToast('Kh√¥ng c√≥ chi ti·∫øt h·∫°ng m·ª•c NG', 'warning');
        return;
      }
      
      const success = openModal('f9-hang-muc-ng', (modal, config) => {
        const subtitle = document.getElementById('modal-f9-hang-muc-ng-subtitle');
        const body = document.getElementById('modal-f9-hang-muc-ng-body');
        
        if (subtitle) {
          subtitle.textContent = `${item['Linh ki·ªán'] || ''} - ${item['H·∫°ng m·ª•c NG'] || ''}`;
        }
        
        if (body) {
          // Render chi ti·∫øt h·∫°ng m·ª•c NG m·ªôt c√°ch g·ªçn g√†ng
          body.innerHTML = `
            <div class="grid grid-cols-3 gap-4">
              <!-- C·ªôt 1: Th√¥ng tin h·∫°ng m·ª•c -->
              <div class="col-span-2 border border-red-200 rounded-lg p-4 bg-red-50">
                <h3 class="text-sm font-bold text-red-800 mb-3 flex items-center gap-1">
                  <span class="material-symbols-outlined text-base">info</span>
                  Th√¥ng tin h·∫°ng m·ª•c
                </h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                  ${chiTietHangMuc.hang_muc ? `
                    <div class="col-span-2 pb-4 mb-3 border-b-2 border-red-300 bg-white rounded-lg p-4 shadow-sm">
                      <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">H·∫°ng m·ª•c</div>
                      <div class="text-xl font-extrabold text-red-700 leading-tight">${escapeHtml(chiTietHangMuc.hang_muc)}</div>
                    </div>
                  ` : ''}
                  ${chiTietHangMuc.stt !== undefined ? `
                    <div class="pb-2 border-b border-red-100">
                      <div class="text-xs font-semibold text-gray-600 mb-1">STT</div>
                      <div class="text-gray-900">${escapeHtml(String(chiTietHangMuc.stt))}</div>
                    </div>
                  ` : ''}
                  ${chiTietHangMuc.cong_chuan !== undefined ? `
                    <div class="pb-2 border-b border-red-100">
                      <div class="text-xs font-semibold text-gray-600 mb-1">C√¥ng chu·∫©n</div>
                      <div class="text-gray-900">${escapeHtml(String(chiTietHangMuc.cong_chuan))}</div>
                    </div>
                  ` : ''}
                  ${chiTietHangMuc.cong_cu ? `
                    <div class="pb-2 border-b border-red-100">
                      <div class="text-xs font-semibold text-gray-600 mb-1">C√¥ng c·ª•</div>
                      <div class="text-gray-900">${escapeHtml(chiTietHangMuc.cong_cu)}</div>
                    </div>
                  ` : ''}
                  ${chiTietHangMuc.test_type ? `
                    <div class="pb-2 border-b border-red-100">
                      <div class="text-xs font-semibold text-gray-600 mb-1">Lo·∫°i test</div>
                      <div class="text-gray-900">${escapeHtml(chiTietHangMuc.test_type)}</div>
                    </div>
                  ` : ''}
                  ${chiTietHangMuc.available ? `
                    <div class="pb-2 border-b border-red-100">
                      <div class="text-xs font-semibold text-gray-600 mb-1">Available</div>
                      <div class="text-gray-900">${escapeHtml(chiTietHangMuc.available)}</div>
                    </div>
                  ` : ''}
                  ${chiTietHangMuc.danh_gia ? `
                    <div class="pb-2 border-b border-red-100">
                      <div class="text-xs font-semibold text-gray-600 mb-1">ƒê√°nh gi√°</div>
                      <div class="text-red-600 font-bold">${escapeHtml(chiTietHangMuc.danh_gia)}</div>
                    </div>
                  ` : ''}
                  ${chiTietHangMuc.ghi_chu_hang_muc ? `
                    <div class="col-span-2 pt-2">
                      <div class="text-xs font-semibold text-gray-600 mb-1">Ghi ch√∫</div>
                      <div class="text-gray-900 text-xs whitespace-pre-wrap">${escapeHtml(chiTietHangMuc.ghi_chu_hang_muc)}</div>
                    </div>
                  ` : ''}
                </div>
              </div>
              
              <!-- C·ªôt 2: Ti√™u chu·∫©n v√† K·∫øt qu·∫£ m·∫´u -->
              <div class="col-span-1 border border-blue-200 rounded-lg p-4 bg-blue-50">
                ${chiTietHangMuc.tieu_chuan ? `
                  <div class="mb-4 pb-3 border-b border-blue-200">
                    <h3 class="text-sm font-bold text-blue-800 mb-2 flex items-center gap-1">
                      <span class="material-symbols-outlined text-base">rule</span>
                      Ti√™u chu·∫©n
                    </h3>
                    <div class="bg-white rounded border border-blue-200 p-2 text-center">
                      <div class="text-lg font-bold text-blue-700">${escapeHtml(chiTietHangMuc.tieu_chuan)}</div>
                    </div>
                  </div>
                ` : ''}
                <div>
                  <h3 class="text-sm font-bold text-blue-800 mb-3 flex items-center gap-1">
                    <span class="material-symbols-outlined text-base">science</span>
                    K·∫øt qu·∫£ m·∫´u
                  </h3>
                  <div class="grid grid-cols-1 gap-2">
                    ${chiTietHangMuc.m1 !== undefined ? `
                      <div class="text-center p-2 border rounded ${chiTietHangMuc.m1 === 'R√≤ r·ªâ' || chiTietHangMuc.m1 === 'NG' ? 'bg-red-100 border-red-300' : 'bg-green-100 border-green-300'}">
                        <div class="text-xs font-semibold text-gray-600">M1</div>
                        <div class="text-sm font-medium mt-1 ${chiTietHangMuc.m1 === 'R√≤ r·ªâ' || chiTietHangMuc.m1 === 'NG' ? 'text-red-700' : 'text-green-700'}">${escapeHtml(String(chiTietHangMuc.m1))}</div>
                      </div>
                    ` : ''}
                    ${chiTietHangMuc.m2 !== undefined ? `
                      <div class="text-center p-2 border rounded ${chiTietHangMuc.m2 === 'R√≤ r·ªâ' || chiTietHangMuc.m2 === 'NG' ? 'bg-red-100 border-red-300' : 'bg-green-100 border-green-300'}">
                        <div class="text-xs font-semibold text-gray-600">M2</div>
                        <div class="text-sm font-medium mt-1 ${chiTietHangMuc.m2 === 'R√≤ r·ªâ' || chiTietHangMuc.m2 === 'NG' ? 'text-red-700' : 'text-green-700'}">${escapeHtml(String(chiTietHangMuc.m2))}</div>
                      </div>
                    ` : ''}
                    ${chiTietHangMuc.m3 !== undefined ? `
                      <div class="text-center p-2 border rounded ${chiTietHangMuc.m3 === 'R√≤ r·ªâ' || chiTietHangMuc.m3 === 'NG' ? 'bg-red-100 border-red-300' : 'bg-green-100 border-green-300'}">
                        <div class="text-xs font-semibold text-gray-600">M3</div>
                        <div class="text-sm font-medium mt-1 ${chiTietHangMuc.m3 === 'R√≤ r·ªâ' || chiTietHangMuc.m3 === 'NG' ? 'text-red-700' : 'text-green-700'}">${escapeHtml(String(chiTietHangMuc.m3))}</div>
                      </div>
                    ` : ''}
                    ${chiTietHangMuc.m4 !== undefined ? `
                      <div class="text-center p-2 border rounded ${chiTietHangMuc.m4 === 'R√≤ r·ªâ' || chiTietHangMuc.m4 === 'NG' ? 'bg-red-100 border-red-300' : 'bg-green-100 border-green-300'}">
                        <div class="text-xs font-semibold text-gray-600">M4</div>
                        <div class="text-sm font-medium mt-1 ${chiTietHangMuc.m4 === 'R√≤ r·ªâ' || chiTietHangMuc.m4 === 'NG' ? 'text-red-700' : 'text-green-700'}">${escapeHtml(String(chiTietHangMuc.m4))}</div>
                      </div>
                    ` : ''}
                    ${chiTietHangMuc.m5 !== undefined ? `
                      <div class="text-center p-2 border rounded ${chiTietHangMuc.m5 === 'R√≤ r·ªâ' || chiTietHangMuc.m5 === 'NG' ? 'bg-red-100 border-red-300' : 'bg-green-100 border-green-300'}">
                        <div class="text-xs font-semibold text-gray-600">M5</div>
                        <div class="text-sm font-medium mt-1 ${chiTietHangMuc.m5 === 'R√≤ r·ªâ' || chiTietHangMuc.m5 === 'NG' ? 'text-red-700' : 'text-green-700'}">${escapeHtml(String(chiTietHangMuc.m5))}</div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        }
      });
      
      if (!success) {
        console.error('[Form 9] Failed to open Chi ti·∫øt h·∫°ng m·ª•c NG modal');
        showToast('Kh√¥ng th·ªÉ m·ªü modal chi ti·∫øt h·∫°ng m·ª•c NG', 'error');
      }
    }
    
    // Export to Excel
    function exportF9ToExcel() {
      if (!F9_FILTERED_DATA || F9_FILTERED_DATA.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
        return;
      }
      
      try {
        const dataToExport = F9_FILTERED_DATA.map(item => ({
          'STT': '',
          'Linh ki·ªán': item['Linh ki·ªán'] || '',
          'M√£ linh ki·ªán': item['M√£ linh ki·ªán'] || '',
          'Ph·∫°m vi': item['Ph·∫°m vi'] || '',
          'H·∫°ng m·ª•c NG': item['H·∫°ng m·ª•c NG'] || '',
          'Chi ti·∫øt h·∫°ng m·ª•c NG': item['Chi ti·∫øt h·∫°ng m·ª•c NG'] || '',
          'M√£ b√°o c√°o': item['M√£ b√°o c√°o'] || '',
          'Nh√† cung c·∫•p': item['Nh√† cung c·∫•p'] || '',
          'Ng∆∞·ªùi l·∫≠p': item['Ng∆∞·ªùi l·∫≠p'] || '',
          'Ng∆∞·ªùi ki·ªÉm tra': item['Ng∆∞·ªùi ki·ªÉm tra'] || '',
          'Ng√†y ghi nh·∫≠n': item['Ng√†y ghi nh·∫≠n'] || '',
          'Ghi ch√∫': item['Ghi ch√∫'] || ''
        }));
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        
        // Set column widths
        const colWidths = [
          { wch: 5 }, { wch: 30 }, { wch: 15 }, { wch: 10 },
          { wch: 40 }, { wch: 50 }, { wch: 20 }, { wch: 20 },
          { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 30 }
        ];
        ws['!cols'] = colWidths;
        
        XLSX.utils.book_append_sheet(wb, ws, 'Ng√¢n h√†ng l·ªói');
        
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
        const timeStr = now.toTimeString().slice(0, 5).replace(':', '');
        const fileName = `Form9_NganHangLoi_${dateStr}_${timeStr}.xlsx`;
        
        XLSX.writeFile(wb, fileName);
        
        showToast(`ƒê√£ xu·∫•t ${F9_FILTERED_DATA.length} b·∫£n ghi th√†nh c√¥ng!`, 'success');
        
      } catch (error) {
        console.error('[Form 9] Error exporting to Excel:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi xu·∫•t Excel. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
    }
    
    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Kh·ªüi t·∫°o Form 9 khi DOM ready v√† khi chuy·ªÉn sang form
    document.addEventListener('DOMContentLoaded', function() {
      // Kh·ªüi t·∫°o khi chuy·ªÉn sang form 9
      const navButtons = document.querySelectorAll('.nav-btn[data-target="form9"]');
      navButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          setTimeout(() => {
            if (typeof initForm9 === 'function') {
              initForm9();
            }
          }, 100);
        });
      });
    });

    // ===== FORM 6 - DASHBOARD T·ªîNG QUAN =====
    
    let F6_ALL_DATA = [];
    let F6_SEARCH_TEXT = '';

    // H√†m t√≠nh to√°n th·ªëng k√™ t·ª´ d·ªØ li·ªáu Form 5
    function calculateF6Stats(projects) {
      if (!projects || !Array.isArray(projects) || projects.length === 0) {
        return {
          totalProjects: 0,
          totalTasks: 0,
          totalSubtasks: 0,
          completionRate: 0,
          statusCount: {},
          picCount: {},
          picDetails: {},
          dueTasks: [],
          projectDetails: []
        };
      }

      let totalProjects = 0;
      let totalTasks = 0;
      let totalSubtasks = 0;
      let completedSubtasks = 0;
      const statusCount = {};
      const picCount = {};
      const picDetails = {};
      const dueTasks = [];
      const projectDetails = [];
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const sevenDaysLater = new Date(today);
      sevenDaysLater.setDate(today.getDate() + 7);

      projects.forEach(project => {
        if (!project.tasks || !Array.isArray(project.tasks)) return;
        
        totalProjects++;
        let projectTaskCount = 0;
        let projectSubtaskCount = 0;
        let projectCompletedSubtasks = 0;

        project.tasks.forEach(task => {
          totalTasks++;
          projectTaskCount++;

          if (task.subtasks && Array.isArray(task.subtasks)) {
            task.subtasks.forEach(subtask => {
              totalSubtasks++;
              projectSubtaskCount++;

              const status = (subtask.status || '').trim();
              const pic = (subtask.pic || '').trim();
              const deadline = subtask.deadline || subtask.dueDate || '';

              // ƒê·∫øm tr·∫°ng th√°i
              if (status) {
                statusCount[status] = (statusCount[status] || 0) + 1;
              }

              // ƒê·∫øm PIC
              if (pic) {
                picCount[pic] = (picCount[pic] || 0) + 1;
                
                if (!picDetails[pic]) {
                  picDetails[pic] = {
                    total: 0,
                    completed: 0,
                    inProgress: 0,
                    pending: 0
                  };
                }
                picDetails[pic].total++;
                
                const statusLower = status.toLowerCase();
                if (statusLower.includes('done') || statusLower.includes('completed') || statusLower.includes('ho√†n th√†nh') || statusLower.includes('xong')) {
                  picDetails[pic].completed++;
                  projectCompletedSubtasks++;
                  completedSubtasks++;
                } else if (statusLower.includes('progress') || statusLower.includes('ƒëang') || statusLower.includes('tri·ªÉn khai') || statusLower.includes('l√†m')) {
                  picDetails[pic].inProgress++;
                } else {
                  picDetails[pic].pending++;
                }
              }

              // Ki·ªÉm tra task s·∫Øp h·∫øt h·∫°n (7 ng√†y t·ªõi)
              if (deadline) {
                try {
                  const deadlineDate = new Date(deadline);
                  deadlineDate.setHours(0, 0, 0, 0);
                  if (deadlineDate >= today && deadlineDate <= sevenDaysLater) {
                    const statusLower = status.toLowerCase();
                    if (!statusLower.includes('done') && !statusLower.includes('completed') && !statusLower.includes('ho√†n th√†nh')) {
                      dueTasks.push({
                        taskName: task.taskName || '',
                        project: project.projectName || project.name || '',
                        pic: pic || 'Ch∆∞a x√°c ƒë·ªãnh',
                        deadline: deadline,
                        daysLeft: Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24))
                      });
                    }
                  }
                } catch (e) {
                  // B·ªè qua n·∫øu kh√¥ng parse ƒë∆∞·ª£c date
                }
              }
            });
          }
        });

        // T√≠nh ti·∫øn ƒë·ªô project
        const projectProgress = projectSubtaskCount > 0 
          ? Math.round((projectCompletedSubtasks / projectSubtaskCount) * 100) 
          : 0;

        projectDetails.push({
          projectCode: project.projectCode || '',
          projectName: project.projectName || project.name || '',
          taskCount: projectTaskCount,
          subtaskCount: projectSubtaskCount,
          progress: projectProgress,
          pic: project.pic || ''
        });
      });

      const completionRate = totalSubtasks > 0 ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;

      // S·∫Øp x·∫øp dueTasks theo s·ªë ng√†y c√≤n l·∫°i
      dueTasks.sort((a, b) => a.daysLeft - b.daysLeft);

      return {
        totalProjects,
        totalTasks,
        totalSubtasks,
        completionRate,
        statusCount,
        picCount,
        picDetails,
        dueTasks,
        projectDetails
      };
    }

    // H√†m render stats cards
    function renderF6StatsCards(stats) {
      document.getElementById('f6-stat-projects').textContent = stats.totalProjects;
      document.getElementById('f6-stat-tasks').textContent = stats.totalTasks;
      document.getElementById('f6-stat-subtasks').textContent = stats.totalSubtasks;
      document.getElementById('f6-stat-completion').textContent = stats.completionRate + '%';
    }

    // H√†m render chart tr·∫°ng th√°i subtask - Pie chart (bi·ªÉu ƒë·ªì tr√≤n)
    function renderF6SubtaskStatusChart(statusCount) {
      const container = document.getElementById('f6-chart-subtask-status');
      if (!container) return;

      const entries = Object.entries(statusCount).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }

      const total = Object.values(statusCount).reduce((sum, count) => sum + count, 0);
      
      // M√†u s·∫Øc cho t·ª´ng tr·∫°ng th√°i
      const getStatusColor = (statusLower) => {
        if (statusLower.includes('done') || statusLower.includes('completed') || statusLower.includes('ho√†n th√†nh') || statusLower.includes('xong')) {
          return { color: '#10B981', bgColor: 'bg-green-50', textColor: 'text-green-800', borderColor: 'border-green-300' };
        } else if (statusLower.includes('progress') || statusLower.includes('ƒëang') || statusLower.includes('tri·ªÉn khai')) {
          return { color: '#3B82F6', bgColor: 'bg-blue-50', textColor: 'text-blue-800', borderColor: 'border-blue-300' };
        } else if (statusLower.includes('pending') || statusLower.includes('ch∆∞a') || statusLower.includes('ch·ªù')) {
          return { color: '#F59E0B', bgColor: 'bg-yellow-50', textColor: 'text-yellow-800', borderColor: 'border-yellow-300' };
        } else if (statusLower.includes('cancel') || statusLower.includes('h·ªßy')) {
          return { color: '#EF4444', bgColor: 'bg-red-50', textColor: 'text-red-800', borderColor: 'border-red-300' };
        } else if (statusLower.includes('review') || statusLower.includes('ph√™ duy·ªát')) {
          return { color: '#8B5CF6', bgColor: 'bg-purple-50', textColor: 'text-purple-800', borderColor: 'border-purple-300' };
        }
        return { color: '#6B7280', bgColor: 'bg-gray-50', textColor: 'text-gray-800', borderColor: 'border-gray-300' };
      };

      // T√≠nh to√°n g√≥c cho pie chart
      const size = 200;
      const radius = size / 2 - 10;
      const center = size / 2;
      const strokeWidth = 40;
      
      let currentAngle = -90; // B·∫Øt ƒë·∫ßu t·ª´ tr√™n c√πng (-90 ƒë·ªô)
      let html = '<div class="flex flex-col items-center gap-4">';
      
      // V·∫Ω pie chart b·∫±ng SVG
      html += `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" class="transform -rotate-90">`;
      
      entries.forEach(([status, count]) => {
        const percentage = total > 0 ? (count / total) * 100 : 0;
        const angle = (count / total) * 360;
        const endAngle = currentAngle + angle;
        
        const statusLower = status.toLowerCase();
        const colors = getStatusColor(statusLower);
        
        // T√≠nh to√°n cho arc
        const startRad = (currentAngle * Math.PI) / 180;
        const endRad = (endAngle * Math.PI) / 180;
        
        const x1 = center + radius * Math.cos(startRad);
        const y1 = center + radius * Math.sin(startRad);
        const x2 = center + radius * Math.cos(endRad);
        const y2 = center + radius * Math.sin(endRad);
        
        const largeArcFlag = angle > 180 ? 1 : 0;
        
        // V·∫Ω arc
        html += `
          <path
            d="M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z"
            fill="${colors.color}"
            stroke="white"
            stroke-width="3"
            class="hover:opacity-80 transition-opacity cursor-pointer"
            title="${escapeHtml(status)}: ${count} (${percentage.toFixed(1)}%)"
          />
        `;
        
        currentAngle = endAngle;
      });
      
      html += '</svg>';
      
      // Th√™m legend (ch√∫ th√≠ch)
      html += '<div class="w-full space-y-2">';
      entries.forEach(([status, count]) => {
        const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
        const statusLower = status.toLowerCase();
        const colors = getStatusColor(statusLower);
        
        html += `
          <div class="flex items-center justify-between p-2 ${colors.bgColor} rounded-lg border ${colors.borderColor}">
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 rounded" style="background-color: ${colors.color}"></div>
              <span class="text-sm font-medium ${colors.textColor}">${escapeHtml(status)}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm font-bold text-gray-900">${count}</span>
              <span class="text-xs text-gray-600">${percentage}%</span>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      html += '</div>';
      container.innerHTML = html;
    }

    // H√†m render chart ph√¢n b·ªï theo PIC - Thanh % ƒë·∫°i di·ªán cho t·ª∑ l·ªá ho√†n th√†nh
    function renderF6PICDistributionChart(picCount, picDetails) {
      const container = document.getElementById('f6-chart-pic-distribution');
      if (!container) return;

      const entries = Object.entries(picCount).sort((a, b) => b[1] - a[1]).slice(0, 10); // Top 10
      if (entries.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        return;
      }

      let html = '<div class="space-y-3">';
      
      entries.forEach(([pic, count]) => {
        const details = picDetails[pic] || {};
        const totalTasks = details.total || count;
        const completedTasks = details.completed || 0;
        const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        // M√†u s·∫Øc theo t·ª∑ l·ªá ho√†n th√†nh
        let barColor = 'bg-gray-400';
        let textColor = 'text-gray-700';
        if (completionRate >= 80) {
          barColor = 'bg-green-500';
          textColor = 'text-green-700';
        } else if (completionRate >= 50) {
          barColor = 'bg-yellow-500';
          textColor = 'text-yellow-700';
        } else if (completionRate > 0) {
          barColor = 'bg-orange-500';
          textColor = 'text-orange-700';
        }

        html += `
          <div class="group cursor-pointer" onclick="openF6PersonDetailModal('${escapeHtml(pic)}')">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-900 hover:text-blue-600 transition">${escapeHtml(pic)}</span>
              <div class="flex items-center gap-2">
                <span class="text-xs text-gray-600">${count} task</span>
                <span class="text-sm font-bold ${textColor} min-w-[45px] text-right">${completionRate}%</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <div class="flex-1 bg-gray-200 rounded-full h-3 overflow-hidden">
                <div class="${barColor} h-3 rounded-full transition-all duration-500 flex items-center justify-end pr-2" style="width: ${completionRate}%">
                  ${completionRate >= 15 ? `<span class="text-xs font-bold text-white">${completionRate}%</span>` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // H√†m render b·∫£ng t√°c v·ª• s·∫Øp h·∫øt h·∫°n
    function renderF6DueTasks(dueTasks) {
      const tbody = document.getElementById('f6-due-tasks-body');
      if (!tbody) return;

      if (dueTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500 text-sm">Kh√¥ng c√≥ t√°c v·ª• s·∫Øp h·∫øt h·∫°n</td></tr>';
        return;
      }

      let html = '';
      dueTasks.forEach(task => {
        const daysLeft = task.daysLeft;
        let daysLeftClass = 'text-gray-600';
        let daysLeftText = `${daysLeft} ng√†y`;
        
        if (daysLeft === 0) {
          daysLeftClass = 'text-red-600 font-bold';
          daysLeftText = 'H√¥m nay';
        } else if (daysLeft === 1) {
          daysLeftClass = 'text-orange-600 font-semibold';
          daysLeftText = 'Ng√†y mai';
        } else if (daysLeft <= 3) {
          daysLeftClass = 'text-yellow-600 font-semibold';
        }

        html += `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-3 text-sm text-gray-900">${escapeHtml(task.taskName)}</td>
            <td class="px-6 py-3 text-sm text-gray-700">${escapeHtml(task.project)}</td>
            <td class="px-6 py-3 text-sm text-gray-700 cursor-pointer hover:text-blue-600" onclick="openF6PersonDetailModal('${escapeHtml(task.pic)}')">${escapeHtml(task.pic)}</td>
            <td class="px-6 py-3 text-sm text-gray-600">${escapeHtml(task.deadline)}</td>
            <td class="px-6 py-3 text-sm ${daysLeftClass}">${daysLeftText}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // H√†m render b·∫£ng chi ti·∫øt d·ª± √°n
    function renderF6ProjectsTable(projectDetails) {
      const tbody = document.getElementById('f6-projects-table-body');
      if (!tbody) return;

      // Filter theo search text
      let filteredProjects = projectDetails;
      if (F6_SEARCH_TEXT) {
        const searchLower = F6_SEARCH_TEXT.toLowerCase();
        filteredProjects = projectDetails.filter(p => 
          (p.projectCode || '').toLowerCase().includes(searchLower) ||
          (p.projectName || '').toLowerCase().includes(searchLower) ||
          (p.pic || '').toLowerCase().includes(searchLower)
        );
      }

      if (filteredProjects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p</td></tr>';
        return;
      }

      let html = '';
      filteredProjects.forEach(project => {
        let progressColor = 'bg-gray-200';
        if (project.progress >= 80) {
          progressColor = 'bg-green-500';
        } else if (project.progress >= 50) {
          progressColor = 'bg-yellow-500';
        } else if (project.progress > 0) {
          progressColor = 'bg-blue-500';
        }

        html += `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-3 text-sm font-mono text-gray-900">${escapeHtml(project.projectCode)}</td>
            <td class="px-6 py-3 text-sm text-gray-900">${escapeHtml(project.projectName)}</td>
            <td class="px-6 py-3 text-sm text-gray-700 text-center">${project.taskCount}</td>
            <td class="px-6 py-3 text-sm text-gray-700 text-center">${project.subtaskCount}</td>
            <td class="px-6 py-3">
              <div class="flex items-center gap-2">
                <div class="flex-1 bg-gray-200 rounded-full h-2">
                  <div class="${progressColor} h-2 rounded-full" style="width: ${project.progress}%"></div>
                </div>
                <span class="text-sm font-semibold text-gray-700 w-12 text-right">${project.progress}%</span>
              </div>
            </td>
            <td class="px-6 py-3 text-sm text-gray-700 cursor-pointer hover:text-blue-600" onclick="openF6PersonDetailModal('${escapeHtml(project.pic)}')">${escapeHtml(project.pic || '-')}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
    }

    // H√†m t·∫£i v√† render dashboard Form 6 - T·ª± ƒë·ªông l·∫•y t·ª´ webhook Form 5
    async function loadF6Dashboard() {
      const refreshBtn = document.getElementById('f6-refresh-btn');
      
      try {
        if (refreshBtn) refreshBtn.disabled = true;

        // Webhook URL c·ªßa Form 5 (c√πng webhook v·ªõi Form 5)
        const webhookUrl = 'https://iatzhxxuk.tino.page/webhook/dashboardspm1';
        
        // Hi·ªÉn th·ªã loading
        const statsProjects = document.getElementById('f6-stat-projects');
        const statsTasks = document.getElementById('f6-stat-tasks');
        const statsSubtasks = document.getElementById('f6-stat-subtasks');
        const statsCompletion = document.getElementById('f6-stat-completion');
        
        if (statsProjects) statsProjects.textContent = '...';
        if (statsTasks) statsTasks.textContent = '...';
        if (statsSubtasks) statsSubtasks.textContent = '...';
        if (statsCompletion) statsCompletion.textContent = '...';

        // Fetch d·ªØ li·ªáu t·ª´ webhook Form 5
        const response = await fetch(webhookUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const responseText = await response.text();
        let rawData = [];
        
        try {
          rawData = JSON.parse(responseText);
        } catch (e) {
          throw new Error('Invalid JSON response from server');
        }

        // X·ª≠ l√Ω nhi·ªÅu format response
        let flatData = [];
        if (Array.isArray(rawData)) {
          flatData = rawData;
        } else if (rawData && Array.isArray(rawData.data)) {
          flatData = rawData.data;
        } else if (rawData && Array.isArray(rawData.results)) {
          flatData = rawData.results;
        } else if (rawData && Array.isArray(rawData.items)) {
          flatData = rawData.items;
        } else if (rawData && Array.isArray(rawData.records)) {
          flatData = rawData.records;
        } else if (rawData && typeof rawData === 'object') {
          flatData = [rawData];
        }

        // Convert flat data sang format projects/tasks/subtasks gi·ªëng Form 5
        const projectsMap = {};
        
        flatData.forEach(record => {
          const projectCode = record.project_code || 'UNKNOWN';
          
          // T·∫°o project n·∫øu ch∆∞a c√≥
          if (!projectsMap[projectCode]) {
            projectsMap[projectCode] = {
              id: projectCode,
              projectCode: projectCode,
              projectName: record.ProjectName || `D·ª± √°n ${projectCode}`,
              name: record.ProjectName || `D·ª± √°n ${projectCode}`,
              pic: record.TaskPIC || '',
              createdAt: record.TaskCreatedAt || '',
              dueDate: record.TaskDesiredDate || record.TaskDueDate || '',
              status: 'pending',
              tasks: []
            };
          }
          
          const project = projectsMap[projectCode];
          
          // Ki·ªÉm tra n·∫øu l√† task (type = null v√† parent_id = null v√† SubtaskName = null)
          const isTask = (!record.type || record.type === null) && 
                        (!record.parent_id || record.parent_id === null) && 
                        (!record.SubtaskName || record.SubtaskName === null);
          
          // Ki·ªÉm tra n·∫øu l√† subtask (c√≥ SubtaskName ho·∫∑c type ch·ª©a "subtask")
          const isSubtask = (record.SubtaskName && record.SubtaskName !== null) || 
                           (record.type && String(record.type).includes('subtask'));
          
          if (isTask) {
            // T√¨m task trong project ho·∫∑c t·∫°o m·ªõi
            const taskCode = record.TaskRequestCode || record.TaskCode || '';
            let task = project.tasks.find(t => t.taskCode === taskCode);
            
            if (!task) {
              task = {
                id: record.Id || taskCode,
                taskCode: taskCode,
                taskName: record.TaskItemName || record.TaskName || '',
                pic: record.TaskPIC || '',
                department: record.TaskDepartment || '',
                createdAt: record.TaskCreatedAt || '',
                dueDate: record.TaskDesiredDate || record.TaskDueDate || '',
                status: record.TaskStatus || 'pending',
                subtasks: []
              };
              project.tasks.push(task);
            }
          } else if (isSubtask) {
            // T√¨m task cha
            const taskCode = record.TaskRequestCode || record.TaskCode || '';
            let task = project.tasks.find(t => t.taskCode === taskCode);
            
            if (!task) {
              // T·∫°o task cha n·∫øu ch∆∞a c√≥
              task = {
                id: record.Id || taskCode,
                taskCode: taskCode,
                taskName: record.TaskItemName || record.TaskName || '',
                pic: record.TaskPIC || '',
                department: record.TaskDepartment || '',
                createdAt: record.TaskCreatedAt || '',
                dueDate: record.TaskDesiredDate || record.TaskDueDate || '',
                status: record.TaskStatus || 'pending',
                subtasks: []
              };
              project.tasks.push(task);
            }
            
            // Th√™m subtask v√†o task
            task.subtasks.push({
              id: record.Id || '',
              name: record.SubtaskName || '',
              pic: record.SubtaskPIC || record.TaskPIC || '',
              status: record.Subtaskstatus || record.SubtaskStatus || 'pending',
              timesend: record.Subtasktimesend || record.SubtaskTimesend || '',
              deadline: record.Subtaskdeadline || record.SubtaskDeadline || record.TaskDesiredDate || '',
              finishTime: record.Subtaskfinishtime || record.SubtaskFinishTime || '',
              timespend: record.Subtaskmanhour || record.SubtaskManhour || '',
              subtaskCode: record.TaskCode || '',
              subtaskNo: record.Subtaskno || record.SubtaskNo || 0
            });
          }
        });

        // Convert map sang array
        F6_ALL_DATA = Object.values(projectsMap);
        
        // T√≠nh to√°n stats
        const stats = calculateF6Stats(F6_ALL_DATA);

        // Render t·∫•t c·∫£ components
        renderF6StatsCards(stats);
        renderF6SubtaskStatusChart(stats.statusCount);
        renderF6PICDistributionChart(stats.picCount, stats.picDetails);
        renderF6DueTasks(stats.dueTasks);
        renderF6ProjectsTable(stats.projectDetails);

        showToast(`ƒê√£ t·∫£i ${F6_ALL_DATA.length} d·ª± √°n th√†nh c√¥ng`, 'success');

      } catch (error) {
        console.error('[Form 6] Error loading dashboard:', error);
        showToast('L·ªói khi t·∫£i dashboard: ' + error.message, 'error');
        
        // Hi·ªÉn th·ªã l·ªói tr√™n dashboard
        if (statsProjects) statsProjects.textContent = '0';
        if (statsTasks) statsTasks.textContent = '0';
        if (statsSubtasks) statsSubtasks.textContent = '0';
        if (statsCompletion) statsCompletion.textContent = '0%';
      } finally {
        if (refreshBtn) refreshBtn.disabled = false;
      }
    }

    // Kh·ªüi t·∫°o Form 6
    function initForm6() {
      const refreshBtn = document.getElementById('f6-refresh-btn');
      const searchInput = document.getElementById('f6-search-input');
      
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadF6Dashboard);
      }

      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          F6_SEARCH_TEXT = e.target.value.trim();
          if (F6_ALL_DATA.length > 0) {
            const stats = calculateF6Stats(F6_ALL_DATA);
            renderF6ProjectsTable(stats.projectDetails);
          }
        });
      }

      // T·ª± ƒë·ªông load khi form ƒë∆∞·ª£c hi·ªÉn th·ªã
      const form6Section = document.getElementById('form6');
      if (form6Section) {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              if (!form6Section.classList.contains('hidden')) {
                loadF6Dashboard();
              }
            }
          });
        });
        observer.observe(form6Section, { attributes: true });
      }
    }

    // Kh·ªüi t·∫°o Form 6 khi DOM ready
    document.addEventListener('DOMContentLoaded', function() {
      const navButtons = document.querySelectorAll('.nav-btn[data-target="form6"]');
      navButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          setTimeout(() => {
            initForm6();
          }, 100);
        });
      });
    });

    // ===== FORM 6 - MODAL CHI TI·∫æT C√Å NH√ÇN =====
    
    /**
     * M·ªü modal hi·ªÉn th·ªã chi ti·∫øt c√¥ng vi·ªác c·ªßa m·ªôt c√° nh√¢n
     * @param {string} personName - T√™n ng∆∞·ªùi c·∫ßn xem chi ti·∫øt
     * @param {Array} allData - D·ªØ li·ªáu t·ª´ Form 6 (F6_ALL_DATA) ho·∫∑c Form 5
     */
    function openF6PersonDetailModal(personName, allData = null) {
      if (!personName) {
        showToast('Kh√¥ng c√≥ th√¥ng tin ng∆∞·ªùi d√πng', 'error');
        return;
      }

      // L·∫•y d·ªØ li·ªáu t·ª´ Form 6 (F6_ALL_DATA) ho·∫∑c Form 5 n·∫øu kh√¥ng ƒë∆∞·ª£c truy·ªÅn v√†o
      const dataSource = allData || (typeof F6_ALL_DATA !== 'undefined' && F6_ALL_DATA.length > 0 ? F6_ALL_DATA : (typeof F5_PROJECTS !== 'undefined' ? F5_PROJECTS : []));
      
      if (!dataSource || !Array.isArray(dataSource) || dataSource.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã. Vui l√≤ng t·∫£i l·∫°i d·ªØ li·ªáu t·ª´ Form 6.', 'error');
        return;
      }

      // Thu th·∫≠p t·∫•t c·∫£ tasks v√† subtasks c·ªßa ng∆∞·ªùi n√†y
      const personTasks = [];
      const personSubtasks = [];
      
      dataSource.forEach(project => {
        if (project.tasks && Array.isArray(project.tasks)) {
          project.tasks.forEach(task => {
            // Ki·ªÉm tra task PIC
            if (task.pic && task.pic.trim() === personName.trim()) {
              personTasks.push({
                type: 'task',
                project: project.projectName || project.name || '',
                projectCode: project.projectCode || '',
                taskName: task.taskName || '',
                taskCode: task.taskCode || '',
                status: task.status || 'pending',
                createdAt: task.createdAt || '',
                dueDate: task.dueDate || '',
                department: task.department || ''
              });
            }
            
            // Ki·ªÉm tra subtasks
            if (task.subtasks && Array.isArray(task.subtasks)) {
              task.subtasks.forEach(subtask => {
                if (subtask.pic && subtask.pic.trim() === personName.trim()) {
                  personSubtasks.push({
                    type: 'subtask',
                    project: project.projectName || project.name || '',
                    projectCode: project.projectCode || '',
                    taskName: task.taskName || '',
                    taskCode: task.taskCode || '',
                    subtaskName: subtask.name || '',
                    subtaskCode: subtask.subtaskCode || '',
                    status: subtask.status || 'pending',
                    timesend: subtask.timesend || '',
                    deadline: subtask.deadline || subtask.dueDate || '',
                    finishTime: subtask.finishTime || subtask.Subtaskfinishtime || '',
                    timespend: subtask.timespend || ''
                  });
                }
              });
            }
          });
        }
      });

      // Ph√¢n lo·∫°i theo tr·∫°ng th√°i
      const completedTasks = personSubtasks.filter(t => {
        const status = (t.status || '').toLowerCase();
        return status.includes('done') || status.includes('completed') || status.includes('ho√†n th√†nh') || status.includes('xong');
      });
      
      const inProgressTasks = personSubtasks.filter(t => {
        const status = (t.status || '').toLowerCase();
        return status.includes('progress') || status.includes('ƒëang') || status.includes('tri·ªÉn khai') || status.includes('l√†m');
      });
      
      const pendingTasks = personSubtasks.filter(t => {
        const status = (t.status || '').toLowerCase();
        return !completedTasks.includes(t) && !inProgressTasks.includes(t);
      });

      // T√≠nh to√°n th·ªëng k√™
      const totalTasks = personTasks.length;
      const totalSubtasks = personSubtasks.length;
      const completedCount = completedTasks.length;
      const inProgressCount = inProgressTasks.length;
      const pendingCount = pendingTasks.length;
      const completionRate = totalSubtasks > 0 ? Math.round((completedCount / totalSubtasks) * 100) : 0;

      // M·ªü modal
      const success = openModal('f6-person-detail', (modal, config) => {
        const title = document.getElementById('modal-f6-person-detail-title');
        const subtitle = document.getElementById('modal-f6-person-detail-subtitle');
        const body = document.getElementById('modal-f6-person-detail-body');
        
        if (title) {
          title.textContent = `C√¥ng vi·ªác c·ªßa ${personName}`;
        }
        
        if (subtitle) {
          subtitle.textContent = `${totalSubtasks} subtask ‚Ä¢ ${completionRate}% ho√†n th√†nh`;
        }
        
        if (body) {
          body.innerHTML = `
            <!-- Th·ªëng k√™ t·ªïng quan -->
            <div class="grid grid-cols-4 gap-4 mb-6">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="text-xs font-semibold text-blue-600 mb-1">T·ªïng Task</div>
                <div class="text-2xl font-bold text-blue-900">${totalTasks}</div>
              </div>
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="text-xs font-semibold text-green-600 mb-1">ƒê√£ ho√†n th√†nh</div>
                <div class="text-2xl font-bold text-green-900">${completedCount}</div>
              </div>
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="text-xs font-semibold text-yellow-600 mb-1">ƒêang l√†m</div>
                <div class="text-2xl font-bold text-yellow-900">${inProgressCount}</div>
              </div>
              <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <div class="text-xs font-semibold text-gray-600 mb-1">Ch·ªù x·ª≠ l√Ω</div>
                <div class="text-2xl font-bold text-gray-900">${pendingCount}</div>
              </div>
            </div>

            <!-- ƒêang l√†m -->
            ${inProgressTasks.length > 0 ? `
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                  <span class="material-symbols-outlined">work</span>
                  ƒêang l√†m (${inProgressTasks.length})
                </h3>
                <div class="bg-white border border-yellow-200 rounded-lg overflow-hidden">
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead class="bg-yellow-50">
                        <tr>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">D·ª± √°n</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Task</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Subtask</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">H·∫°n ch√≥t</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Tr·∫°ng th√°i</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        ${inProgressTasks.map(t => `
                          <tr class="hover:bg-yellow-50/50">
                            <td class="px-4 py-2 text-gray-900">${escapeHtml(t.project)}</td>
                            <td class="px-4 py-2 text-gray-700">${escapeHtml(t.taskName)}</td>
                            <td class="px-4 py-2 text-gray-900 font-medium">${escapeHtml(t.subtaskName)}</td>
                            <td class="px-4 py-2 text-gray-600">${escapeHtml(t.deadline || '-')}</td>
                            <td class="px-4 py-2">
                              <span class="px-2 py-1 text-xs font-medium rounded bg-yellow-100 text-yellow-800">${escapeHtml(t.status)}</span>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- ƒê√£ ho√†n th√†nh -->
            ${completedTasks.length > 0 ? `
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-green-800 mb-3 flex items-center gap-2">
                  <span class="material-symbols-outlined">check_circle</span>
                  ƒê√£ ho√†n th√†nh (${completedTasks.length})
                </h3>
                <div class="bg-white border border-green-200 rounded-lg overflow-hidden">
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead class="bg-green-50">
                        <tr>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">D·ª± √°n</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Task</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Subtask</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Ho√†n th√†nh</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Th·ªùi gian</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        ${completedTasks.map(t => `
                          <tr class="hover:bg-green-50/50">
                            <td class="px-4 py-2 text-gray-900">${escapeHtml(t.project)}</td>
                            <td class="px-4 py-2 text-gray-700">${escapeHtml(t.taskName)}</td>
                            <td class="px-4 py-2 text-gray-900 font-medium">${escapeHtml(t.subtaskName)}</td>
                            <td class="px-4 py-2 text-gray-600">${escapeHtml(t.finishTime || '-')}</td>
                            <td class="px-4 py-2 text-gray-600">${escapeHtml(t.timespend ? t.timespend + 'h' : '-')}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- Ch·ªù x·ª≠ l√Ω -->
            ${pendingTasks.length > 0 ? `
              <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                  <span class="material-symbols-outlined">schedule</span>
                  Ch·ªù x·ª≠ l√Ω (${pendingTasks.length})
                </h3>
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">D·ª± √°n</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Task</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Subtask</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">B·∫Øt ƒë·∫ßu</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">H·∫°n ch√≥t</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        ${pendingTasks.map(t => `
                          <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-gray-900">${escapeHtml(t.project)}</td>
                            <td class="px-4 py-2 text-gray-700">${escapeHtml(t.taskName)}</td>
                            <td class="px-4 py-2 text-gray-900 font-medium">${escapeHtml(t.subtaskName)}</td>
                            <td class="px-4 py-2 text-gray-600">${escapeHtml(t.timesend || '-')}</td>
                            <td class="px-4 py-2 text-gray-600">${escapeHtml(t.deadline || '-')}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            ` : ''}

            ${totalSubtasks === 0 ? `
              <div class="text-center py-12 text-gray-500">
                <span class="material-symbols-outlined text-6xl mb-4">person_off</span>
                <p class="text-lg">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o ƒë∆∞·ª£c g√°n cho ng∆∞·ªùi n√†y</p>
              </div>
            ` : ''}
          `;
        }
      });
      
      if (!success) {
        console.error('[Form 6] Failed to open person detail modal');
        showToast('Kh√¥ng th·ªÉ m·ªü modal chi ti·∫øt', 'error');
      }
    }


    // ===== SIDEBAR NAVIGATION - GROUP TOGGLE =====
    
    // Kh·ªüi t·∫°o sidebar navigation v√† group toggle
    function initSidebarNavigation() {
      // X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi form
      const navButtons = document.querySelectorAll('.nav-btn[data-target]');
      navButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const targetForm = this.getAttribute('data-target');
          
          // ·∫®n t·∫•t c·∫£ form
          document.querySelectorAll('section[id^="form"]').forEach(form => {
            form.classList.add('hidden');
          });
          
          // Hi·ªÉn th·ªã form ƒë∆∞·ª£c ch·ªçn
          const targetElement = document.getElementById(targetForm);
          if (targetElement) {
            targetElement.classList.remove('hidden');
          }
          
          // C·∫≠p nh·∫≠t active state cho nav buttons
          navButtons.forEach(navBtn => {
            navBtn.classList.remove('active');
          });
          this.classList.add('active');
        });
      });
      
      // X·ª≠ l√Ω toggle group
      const groupButtons = document.querySelectorAll('.group-btn[data-group]');
      groupButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const groupName = this.getAttribute('data-group');
          const groupItems = document.querySelector(`.group-items[data-group="${groupName}"]`);
          
          if (groupItems) {
            // Toggle collapse class
            groupItems.classList.toggle('collapsed');
            this.classList.toggle('collapsed');
            
            // Toggle expand icon rotation
            const expandIcon = this.querySelector('.group-expand-icon');
            if (expandIcon) {
              expandIcon.style.transform = groupItems.classList.contains('collapsed') 
                ? 'rotate(-90deg)' 
                : 'rotate(0deg)';
            }
          }
        });
      });
    }
    
    // Kh·ªüi t·∫°o khi DOM ready
    document.addEventListener('DOMContentLoaded', function() {
      initSidebarNavigation();
    });

  </script>

</body>
</html>


